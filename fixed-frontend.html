<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantonment Board Ambala - Administration System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .login-container {
            background: #2C2C2C;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            margin: 50px auto;
        }

        /* Mobile responsive login */
        @media (max-width: 480px) {
            .login-container {
                width: 95%;
                padding: 30px 20px;
                margin: 20px auto;
            }
        }

        /* Ensure login submit buttons maintain proper size */
        .login-container .btn {
            padding: 14px 20px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            width: 100% !important;
            min-height: 50px !important;
        }


        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: #2C2C2C;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .pagination-info {
            color: #ccc;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #333;
            border-color: #666;
            color: #fff;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .page-size-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
        }

        .page-size-selector select {
            padding: 6px 8px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .pagination-summary {
            color: #888;
            font-size: 13px;
            margin-top: 5px;
        }

        /* Lazy Loading Styles */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lazy-image.loaded {
            opacity: 1;
        }

        .lazy-image.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading-shimmer 2s infinite;
        }

        @keyframes loading-shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Lazy content containers */
        .lazy-container {
            min-height: 200px;
            position: relative;
        }

        .lazy-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
        }


        
        .logo {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            margin: 0 auto -50px auto;
            position: relative;
            z-index: 2;
            border: 4px solid #1976d2;
            object-fit: cover;
        }
        
        .tabs {
            display: flex;
            margin-top: 60px;
            margin-bottom: 30px;
            border-bottom: 1px solid #444;
        }
        
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            color: #888;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            position: relative;
        }
        
        .tab.active {
            color: #FFF;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: #FFF;
        }
        
        .tab-content {
            margin-top: 20px;
        }
        
        .demo-info {
            background: #444 !important;
            color: #ccc !important;
            border-radius: 8px;
        }
        
        /* Login form specific dark theme overrides */
        .login-container .form-group label {
            color: #888;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: left;
            display: block;
        }
        
        /* Admin tab input styling */
        #adminTab .form-group input {
            background: #4A4A4A !important;
            border: none;
            color: #FFF !important;
            padding: 16px 14px;
        }
        
        #adminTab .form-group input::placeholder {
            color: #888 !important;
        }
        
        /* User tab input styling - comprehensive coverage */
        #userTab .form-group input,
        #userTab .form-group input:active,
        #userTab .form-group input:valid,
        #userTab .form-group input:invalid {
            background: #4A4A4A !important;
            border: none;
            color: #FFF !important;
            padding: 16px 14px;
        }
        
        #userTab .form-group input::placeholder {
            color: #888 !important;
        }
        
        /* Focus styles for admin tab */
        #adminTab .form-group input:focus {
            background: #555 !important;
            border-color: transparent;
        }
        
        /* Focus styles for user tab */
        #userTab .form-group input:focus {
            background: #555 !important;
            border-color: transparent;
        }
        
        /* Remove browser autofill yellow background - only for admin tab */
        #adminTab .form-group input:-webkit-autofill,
        #adminTab .form-group input:-webkit-autofill:hover,
        #adminTab .form-group input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 30px #4A4A4A inset !important;
            -webkit-text-fill-color: #FFF !important;
        }
        
        /* Keep consistent autofill styling for user tab */
        #userTab .form-group input:-webkit-autofill,
        #userTab .form-group input:-webkit-autofill:hover,
        #userTab .form-group input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0 30px #4A4A4A inset !important;
            -webkit-text-fill-color: #FFF !important;
        }
        
        /* Error and Success Message Styles */
        .error-message, .success-message {
            font-size: 14px;
            margin-top: 5px;
            padding: 8px 12px;
            border-radius: 4px;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .error-message {
            color: #ff5252;
            background-color: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }
        
        .success-message {
            color: #4caf50;
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: translateY(-20px) scale(0.95); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }
        
        /* Online/Offline Status Indicators */
        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 10px rgba(76, 175, 80, 0.8); }
            100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); }
        }
        
        .user-name-with-status {
            display: flex;
            align-items: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            text-transform: none;
        }
        
        .form-group input::placeholder {
            color: #999;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #1976d2 30%, #42a5f5 90%);
            color: white;
            text-transform: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(45deg, #1565c0 30%, #1e88e5 90%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
        }
        
        .btn-success:active {
            transform: translateY(0);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
            background: linear-gradient(135deg, #c53030 0%, #9c1c1c 100%);
        }
        
        .btn-danger:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn:hover:not(.btn-success):not(.btn-danger) {
            transform: translateY(-2px);
        }
        
        .demo-info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
        }
        
        .role-selection {
            text-align: center;
        }
        
        .role-card {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 30px 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .role-card:hover {
            border-color: #1976d2;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .role-card .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .role-card h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .role-card p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .admin-panel {
            max-width: 800px;
        }
        
        /* User Portal Style Table */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px 0;
        }

        .user-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .user-table th {
            background: #e9ecef;
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .user-table td {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .user-table tbody tr:hover {
            background: #f9fafb;
        }

        /* User Info Column - Table specific */
        .table-container .user-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
        }

        .staff-photo-placeholder {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        /* Avatar Colors - Removed, using inline gradients like dashboard */

        .staff-name {
            font-weight: 600;
            color: #111827;
            font-size: 14px;
            display: inline-block;
            vertical-align: middle;
        }

        /* Online Status - Simplified */
        .online-status {
            font-size: 14px;
            color: #6B7280;
        }

        /* Account Status - Improved badges */
        .account-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #166534;
            border: 1px solid #86efac;
        }

        .status-inactive {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Action Buttons - User Portal Style */
        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nominee-btn, .deduction-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #3B82F6;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }

        .nominee-btn:hover, .deduction-btn:hover {
            background: #2563EB;
        }

        .edit-btn {
            background: #10B981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .edit-btn:hover {
            background: #059669;
        }

        .delete-btn {
            background: #EF4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .delete-btn:hover {
            background: #DC2626;
        }

        .details-btn {
            background: #3B82F6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .details-btn:hover {
            background: #2563EB;
        }
        
        .back-arrow {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .date-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .date-input-wrapper input[type="text"] {
            padding-right: 40px;
        }
        
        .calendar-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 14px;
            z-index: 10;
            line-height: 1;
        }
        
        .calendar-btn:hover {
            background: #1565c0;
        }
        
        .calendar-btn:active {
            background: #0d47a1;
        }
        
        .hidden-calendar {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
            opacity: 0;
        }
        
        .error {
            color: #f44336;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .success {
            color: #4caf50;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        
        .dashboard {
            display: none;
            width: 98%;
            max-width: none;
            margin: 0 auto;
            padding: 20px;
        }

        .portal-header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 15px;
            margin-bottom: 20px;
            height: 70px;
            width: 98%;
            margin: 0 auto 20px auto;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #333;
            padding: 5px 10px;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .portal-header {
                padding: 10px 20px;
                flex-wrap: wrap;
                gap: 10px;
            }
        }

        /* Dashboard Body Container */
        .dashboard-body {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            min-height: calc(100vh - 140px);
            width: 98%;
            margin: 0 auto;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #eee;
            overflow-y: auto;
            position: relative;
            transition: all 0.3s ease;
            display: block !important; /* Force sidebar to always be visible */
            visibility: visible !important; /* Ensure sidebar is never hidden */
        }

        /* Mobile Sidebar - DISABLED to prevent sidebar from disappearing */
        @media (max-width: 768px) {
            .sidebar {
                /* Keep sidebar visible - don't hide it off-screen */
                position: relative;
                width: 250px;
                top: auto;
                left: auto;
                height: auto;
                z-index: auto;
                box-shadow: none;
            }

            .sidebar.mobile-open {
                /* No special mobile-open behavior needed */
                position: relative;
            }

            /* Sidebar Overlay */
            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }
        }
        
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.05), rgba(0,0,0,0.1));
            box-shadow: 1px 0 3px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .nav-menu {
            padding: 10px 0;
        }
        
        .nav-menu .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            font-weight: 500;
        }
        
        .nav-menu .nav-item:hover {
            background: #f8f9fa;
            color: #667eea;
        }
        
        .nav-menu .nav-item.active {
            background: #667eea;
            color: white;
            box-shadow: 2px 0 8px rgba(102, 126, 234, 0.3);
        }
        
        .nav-menu .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #4c5fd8;
        }
        
        .nav-menu .nav-item.active::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(to right, rgba(102, 126, 234, 0.2), rgba(102, 126, 234, 0.1), transparent);
            pointer-events: none;
        }
        
        .nav-icon {
            font-size: 16px;
            margin-right: 15px;
            width: 20px;
            text-align: center;
            color: #666;
            font-weight: normal;
        }
        
        .nav-menu .nav-item.active .nav-icon {
            color: white;
        }
        
        .nav-menu .nav-item:hover .nav-icon {
            color: #667eea;
        }
        
        .nav-menu .nav-item.active:hover .nav-icon {
            color: white;
        }
        
        .nav-text {
            font-size: 14px;
            font-weight: 500;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            padding: 30px;
            background: white;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }
        }
        
        /* Hide old navigation */
        .dashboard-body > .nav {
            display: none;
        }
        
        /* Content styling */
        .content {
            min-height: 400px;
            background: transparent;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
        }
        
        /* Staff Photo Styles */
        .staff-photo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #1976d2;
            cursor: pointer;
            transition: transform 0.3s ease;
            margin-right: 10px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .staff-photo:hover {
            transform: scale(1.1);
            border-color: #4c5fd8;
        }
        
        .staff-photo-placeholder {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: #e0e0e0;
            border: 2px solid #ddd;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
            color: #999;
            vertical-align: middle;
        }
        
        .staff-name-with-photo {
            display: flex;
            align-items: center;
        }
        
        /* Photo Modal Styles */
        .photo-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .photo-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            max-height: 90%;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: zoomIn 0.3s ease;
        }
        
        .photo-modal-content img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        
        .photo-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }
        
        .photo-modal-close:hover {
            color: #333;
        }
        
        @keyframes zoomIn {
            from {
                transform: translate(-50%, -50%) scale(0.8);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Pension Modal Styles */
        .pension-modal-content {
            max-width: 600px;
            animation: pensionModalSlideIn 0.3s ease-out;
        }

        /* Deductions Modal - Optimized width for two fields side by side */
        #deductionsModal .pension-modal-content {
            max-width: 620px;
        }
        
        @keyframes pensionModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .pension-modal-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .pension-modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }
        
        .pension-modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 1;
        }
        
        .pension-close-btn {
            position: absolute;
            top: 20px;
            right: 25px;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 2;
        }
        
        .pension-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .pension-modal-body {
            padding: 30px;
        }
        
        .pension-form-section {
            margin-bottom: 30px;
        }
        
        .pension-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pension-section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            border-radius: 2px;
        }
        
        .pension-modal-content .form-group {
            margin-bottom: 20px;
        }
        
        .pension-modal-content .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .pension-modal-content .form-group input,
        .pension-modal-content .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .pension-modal-content .form-group input:focus,
        .pension-modal-content .form-group select:focus {
            outline: none;
            border-color: #1976d2;
            background: white;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        
        .pension-percentage-container {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }
        
        .pension-percentage-container input {
            width: 120px;
            text-align: center;
            font-weight: 600;
        }
        
        .pension-percentage-symbol {
            font-size: 20px;
            color: #1976d2;
            font-weight: 600;
            background: #e3f2fd;
            padding: 12px 16px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        .pension-nominees-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .pension-nominees-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .pension-nominees-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        
        .pension-total-percentage {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .pension-total-percentage.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        }
        
        .pension-total-percentage.danger {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
        }
        
        .pension-nominee-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .pension-nominee-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
        }
        
        .pension-nominee-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .pension-nominee-info {
            flex: 1;
        }
        
        .pension-nominee-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .pension-nominee-details {
            color: #666;
            font-size: 14px;
        }
        
        .pension-nominee-percentage {
            background: #e3f2fd;
            color: #1976d2;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .pension-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-style: italic;
            font-size: 16px;
        }
        
        .pension-modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: #fafafa;
            border-radius: 0 0 15px 15px;
        }
        
        .pension-modal-content .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .pension-modal-content .btn-primary {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
        }
        
        .pension-modal-content .btn-primary:hover {
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .pension-modal-content .btn-secondary {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        
        .pension-modal-content .btn-secondary:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .pension-modal-content .btn-danger {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            font-size: 12px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(229, 62, 62, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .pension-modal-content .btn-danger:hover {
            background: linear-gradient(135deg, #c53030 0%, #9c1c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }
        
        @media (max-width: 650px) {
            #deductionsModal .pension-modal-content {
                max-width: 580px;
            }
        }
        
        @media (max-width: 768px) {
            .pension-modal-content {
                margin: 20px auto 0 auto;
                max-width: none;
                border-radius: 15px;
            }
            
            #deductionsModal .pension-modal-content {
                max-width: none;
                margin: 10px;
            }
            
            #deductionsModal .calculation-row {
                flex-direction: column;
                gap: 15px;
            }
            
            #deductionsModal .calculation-field {
                min-width: 100%;
                max-width: none;
            }
            
            #deductionsModal .calculation-operator {
                transform: rotate(90deg);
                margin: 10px 0;
                font-size: 20px;
                min-width: auto;
            }
            
            .pension-modal-header {
                padding: 20px;
                border-radius: 15px 15px 0 0;
            }
            
            .pension-modal-body {
                padding: 20px;
            }
            
            .pension-percentage-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .pension-percentage-container input {
                width: 100%;
            }
        }

        /* Professional Popups Styles */
        .notifications-popup {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 380px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 600px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .notifications-popup.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
        }
        
        .notifications-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 16px 16px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        .notifications-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }
        
        .notifications-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notifications-title::before {
            content: 'üîî';
            font-size: 20px;
        }
        
        .notifications-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: auto;
        }
        
        .notifications-body {
            max-height: 400px;
            overflow-y: auto;
            padding: 0;
        }
        
        .notification-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        .notification-item:hover {
            background: #f8f9fa;
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.unread {
            background: linear-gradient(90deg, rgba(25, 118, 210, 0.02) 0%, rgba(25, 118, 210, 0.05) 100%);
            border-left: 3px solid #1976d2;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            position: relative;
        }
        
        .notification-icon.success {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }
        
        .notification-icon.warning {
            background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
            color: white;
        }
        
        .notification-icon.info {
            background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%);
            color: white;
        }
        
        .notification-icon.error {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
        }
        
        .notification-content {
            flex: 1;
            min-width: 0;
        }
        
        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        
        .notification-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
            margin-bottom: 6px;
        }
        
        .notification-time {
            font-size: 12px;
            color: #999;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .notification-time::before {
            content: 'üïê';
            font-size: 11px;
        }
        
        .notifications-footer {
            padding: 12px 20px;
            border-top: 1px solid #f0f0f0;
            text-align: center;
            background: #fafafa;
        }
        
        .notifications-footer a {
            color: #1976d2;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .notifications-footer a:hover {
            color: #1565c0;
        }
        
        .notifications-empty {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .notifications-empty::before {
            content: 'üîï';
            font-size: 48px;
            display: block;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        /* Professional E-Messages Popup */
        .messages-popup {
            position: absolute;
            top: 60px;
            right: 180px;
            width: 420px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transform: translateY(-20px) scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: none;
            z-index: 1000;
        }
        
        .messages-popup.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
        }
        
        .messages-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .messages-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }
        
        .messages-header-content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .messages-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .messages-title-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .messages-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .messages-tabs {
            display: flex;
            background: #f8f9fa;
            padding: 4px;
            margin: 0;
        }
        
        .message-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .message-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .messages-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .message-item {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .message-item:hover {
            background: #f8f9fa;
        }
        
        .message-item.unread {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, transparent 100%);
            border-left: 3px solid #667eea;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        
        .message-sender {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-name {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
        }
        
        .message-time {
            font-size: 12px;
            color: #999;
        }
        
        .message-content {
            color: #666;
            font-size: 13px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .messages-footer {
            padding: 16px 20px;
            background: #f8f9fa;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }
        
        .messages-footer-link {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s ease;
        }
        
        .messages-footer-link:hover {
            color: #764ba2;
        }
        
        /* User Details Popup */
        .user-details-popup {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
        }
        
        .user-details-popup.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            display: block;
        }
        
        .user-details-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 24px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .user-details-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(45deg);
        }
        
        .user-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 600;
            margin: 0 auto 16px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .user-name-large {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }
        
        .user-role-large {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .user-details-body {
            padding: 24px;
        }
        
        .user-detail-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .user-detail-item:last-child {
            border-bottom: none;
        }
        
        .user-detail-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            background: #f8f9fa;
            color: #666;
            flex-shrink: 0;
        }
        
        .user-detail-content {
            flex: 1;
            min-width: 0;
        }
        
        .user-detail-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }
        
        .user-detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .user-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .user-status.active {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }
        
        .user-status.inactive {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
        }
        
        .user-status::before {
            content: '‚óè';
            font-size: 8px;
        }
        
        .user-details-footer {
            padding: 16px 24px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 8px;
        }
        
        .user-action-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .user-action-btn.primary {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
            color: white;
        }
        
        .user-action-btn.secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
        }
        
        .user-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }
        
        @keyframes modalShake {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-1deg); }
            75% { transform: translate(-50%, -50%) rotate(1deg); }
        }
        
        .notification-item {
            animation: slideInRight 0.3s ease;
        }
        
        .notification-item:nth-child(1) { animation-delay: 0.1s; }
        .notification-item:nth-child(2) { animation-delay: 0.2s; }
        .notification-item:nth-child(3) { animation-delay: 0.3s; }
        
        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.show {
            display: block;
            opacity: 1;
        }
        
        /* Professional Delete Confirmation Modal */
        .delete-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 440px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10001;
            display: none;
        }
        
        .delete-modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            display: block;
        }
        
        .delete-modal-header {
            padding: 32px 32px 24px;
            text-align: center;
        }
        
        .delete-icon-wrapper {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .delete-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }
        
        .delete-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }
        
        .delete-modal-subtitle {
            font-size: 15px;
            color: #666;
            line-height: 1.5;
        }
        
        .delete-item-info {
            background: #f8f9fa;
            padding: 16px 20px;
            margin: 0 32px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .delete-item-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .delete-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .delete-modal-footer {
            padding: 24px 32px 32px;
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-align: center;
            border: none;
        }
        
        .modal-btn-cancel {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .modal-btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .modal-btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        
        .modal-btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }
        
        /* Professional Save Changes Modal */
        .save-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 520px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10001;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }
        
        .save-modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            display: flex;
        }
        
        .save-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 24px 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .save-modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease-in-out infinite;
        }

        .save-modal-header-content {
            position: relative;
            z-index: 1;
        }
        
        .save-icon-wrapper {
            width: 50px;
            height: 50px;
            margin: 0 auto 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .save-icon {
            font-size: 24px;
            color: white;
        }
        
        .save-modal-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .save-modal-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 400;
            line-height: 1.5;
        }
        
        .save-changes-list {
            margin: 20px 24px 24px;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            max-height: 180px;
            overflow-y: auto;
        }
        
        .save-changes-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .save-changes-list::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 3px;
        }
        
        .save-changes-list::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }
        
        .save-changes-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .save-changes-title {
            font-size: 14px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .change-item {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 12px;
            padding: 8px;
            background: #f8fafc;
            border-left: 3px solid #10b981;
            border-radius: 4px;
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
        }
        
        .change-item:last-child {
            margin-bottom: 0;
        }
        
        .change-icon {
            color: #10b981;
            font-size: 14px;
            margin-top: 1px;
            min-width: 14px;
        }
        
        .save-modal-footer {
            padding: 16px 24px 20px;
            background: #f8f9fa;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
            align-items: center;
        }
        
        .modal-btn-secondary {
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        
        .modal-btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }
        
        .modal-shake {
            animation: modalShake 0.3s ease-in-out;
        }
        
        /* Success state for save modal */
        .save-modal.success .save-icon-wrapper {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        
        .save-modal.success .save-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Professional Changes Applied Modal */
        .changes-applied-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1002;
            display: none;
            overflow: hidden;
        }

        .changes-applied-modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            display: block;
        }

        .changes-applied-header {
            padding: 40px 32px 30px;
            text-align: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            position: relative;
        }

        .changes-applied-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.1; }
        }

        .changes-applied-icon-wrapper {
            width: 90px;
            height: 90px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            animation: success-bounce 0.6s ease-out;
        }

        @keyframes success-bounce {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .changes-applied-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 30px;
            font-weight: bold;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .changes-applied-title {
            font-size: 28px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .changes-applied-subtitle {
            font-size: 16px;
            color: #10b981;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .changes-applied-body {
            padding: 20px 32px 40px;
            text-align: center;
        }

        .changes-applied-description {
            font-size: 15px;
            color: #666;
            line-height: 1.6;
            margin-bottom: 0;
        }
        
        /* Professional Form Modals */
        .professional-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 580px;
            max-height: 75vh;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10001;
            display: none;
            overflow: hidden;
            flex-direction: column;
        }

        .professional-modal:not(#leaveApplicationModal) {
            flex-direction: column;
        }

        /* Ensure login forms are not affected by modal CSS */
        .role-selection form,
        .login-container form {
            display: block !important;
            height: auto !important;
            flex-direction: initial !important;
        }

        /* Ensure overlays don't block login page */
        #roleSelection .modal-overlay,
        #roleSelection .modal-backdrop,
        .modal-overlay:not(.show),
        .modal-backdrop:not(.show) {
            display: none !important;
            visibility: hidden !important;
            pointer-events: none !important;
        }

        /* Ensure login page elements are clickable */
        #roleSelection,
        #roleSelection * {
            pointer-events: auto !important;
        }
        
        .professional-modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            display: flex;
        }
        
        .professional-modal-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%);
            box-shadow: 0 8px 32px rgba(79, 70, 229, 0.3), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            padding: 16px 20px 12px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
        }

        .professional-modal-close {
            position: absolute;
            top: 12px;
            right: 16px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            backdrop-filter: blur(10px);
        }

        .professional-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            transform: scale(1.1);
        }
        
        .professional-modal-header::before {
            content: '';
            position: absolute;
            top: -100%;
            right: -100%;
            width: 300%;
            height: 300%;
            background: radial-gradient(
                circle at 30% 80%, 
                rgba(255, 255, 255, 0.15) 0%, 
                rgba(255, 255, 255, 0.08) 40%,
                transparent 70%
            );
            animation: shimmer 4s ease-in-out infinite;
            opacity: 0.8;
        }
        
        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg) scale(1); opacity: 0.6; }
            50% { transform: rotate(5deg) scale(1.05); opacity: 0.9; }
        }
        
        .professional-modal-header-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
        }
        
        .professional-modal-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 8px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            font-size: 22px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: iconFloat 3s ease-in-out infinite;
        }
        
        @keyframes iconFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-4px); }
        }
        
        .professional-modal-icon:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2),
                        inset 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        .professional-modal-icon-inner {
            font-size: 24px;
            color: white;
        }
        
        .professional-modal-title {
            color: white;
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            text-shadow: 0 3px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.3px;
            line-height: 1.2;
            text-align: center;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .professional-modal-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 15px;
            font-weight: 400;
            text-shadow: 0 1px 3px rgba(0,0,0,0.2);
            letter-spacing: 0.1px;
            line-height: 1.4;
            margin-bottom: 0;
            text-align: center;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .professional-modal-body {
            padding: 16px 24px 8px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }
        
        .professional-form-group {
            margin-bottom: 24px;
        }
        
        .professional-form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .professional-form-input, .professional-form-select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9fafb;
            font-family: inherit;
        }
        
        .professional-form-input:focus, .professional-form-select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .professional-form-input::placeholder {
            color: #9ca3af;
        }
        
        .professional-form-select {
            cursor: pointer;
        }
        
        .professional-form-select option {
            padding: 12px;
        }
        
        .professional-modal-footer {
            padding: 16px 32px 20px;
            background: #f8f9fa;
            display: flex;
            gap: 16px;
            justify-content: flex-end;
            border-top: 1px solid #e5e7eb;
            flex-shrink: 0;
            align-items: center;
        }
        
        .professional-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            min-width: 120px;
            text-align: center;
        }
        
        .professional-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }
        
        .professional-btn-secondary:hover {
            background: #e5e7eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .professional-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .professional-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* Nominee Percentage Error Modal Styles */
        .error-details-container {
            max-width: 100%;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }

        .error-message h4 {
            color: #dc2626;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .error-message p {
            color: #991b1b;
            font-size: 14px;
            margin: 0;
        }

        .percentage-breakdown {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .percentage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .percentage-item:last-child {
            border-bottom: none;
        }

        .percentage-item.total {
            background: #fef2f2;
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid #fecaca;
            margin-top: 8px;
        }

        .percentage-label {
            font-weight: 500;
            color: #374151;
        }

        .percentage-value {
            font-weight: 600;
            font-size: 16px;
        }

        .current-total {
            color: #059669;
        }

        .attempted-percentage {
            color: #d97706;
        }

        .error-total {
            color: #dc2626;
        }

        .percentage-divider {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: #6b7280;
            padding: 8px 0;
        }

        .recommendation {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .recommendation h5 {
            color: #0369a1;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .recommendation p {
            color: #075985;
            font-size: 14px;
            margin: 4px 0;
        }

        /* Leave Management Calendar Styles */
        .leave-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .leave-header-left h2 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }
        
        .leave-header-left p {
            color: #666;
            margin: 5px 0 0 0;
        }
        
        .leave-header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .view-toggle {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .view-toggle-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .view-toggle-btn.active {
            background: #667eea;
            color: white;
        }
        
        /* Calendar Container */
        .calendar-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        /* Calendar Header */
        .calendar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .calendar-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .calendar-month-year {
            font-size: 24px;
            font-weight: 600;
            min-width: 200px;
            text-align: center;
        }
        
        .calendar-actions {
            display: flex;
            gap: 10px;
        }
        
        .calendar-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .calendar-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Calendar Grid */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        
        .calendar-day-header {
            background: #f8f9fa;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .calendar-day {
            min-height: 120px;
            border-right: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .calendar-day:hover {
            background: #f8f9ff;
        }
        
        .calendar-day.other-month {
            background: #fafafa;
            color: #ccc;
        }
        
        .calendar-day.today {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border: 2px solid #667eea;
        }
        
        .calendar-day-number {
            position: absolute;
            top: 8px;
            left: 12px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .calendar-day.today .calendar-day-number {
            color: #667eea;
            font-weight: 700;
        }
        
        .calendar-day.other-month .calendar-day-number {
            color: #ccc;
        }
        
        /* Leave Events */
        .leave-events {
            margin-top: 25px;
            padding: 0 8px 8px;
        }
        
        .leave-event {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            margin: 2px 0;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .leave-event:hover {
            background: #5a67d8;
            transform: scale(1.02);
        }
        
        .leave-event.sick {
            background: #f56565;
        }
        
        .leave-event.casual {
            background: #48bb78;
        }
        
        .leave-event.annual {
            background: #ed8936;
        }
        
        .leave-event.emergency {
            background: #e53e3e;
        }
        
        .leave-event.maternity {
            background: #d69e2e;
        }
        
        /* Calendar Legend */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .legend-color.sick { background: #f56565; }
        .legend-color.casual { background: #48bb78; }
        .legend-color.annual { background: #ed8936; }
        .legend-color.emergency { background: #e53e3e; }
        .legend-color.maternity { background: #d69e2e; }
        
        /* Leave Statistics */
        .leave-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .leave-stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .leave-stat-card h3 {
            font-size: 32px;
            margin: 0 0 5px 0;
            font-weight: 700;
        }
        
        .leave-stat-card p {
            margin: 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .leave-stat-card.pending {
            background: linear-gradient(135deg, #ffa726 0%, #ff8f00 100%);
        }
        
        .leave-stat-card.approved {
            background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
        }
        
        .leave-stat-card.rejected {
            background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%);
        }

        /* List View Styles */
        .list-view-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 20px;
        }
        
        .list-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-view-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .list-view-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-dropdown {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-dropdown option {
            background: #333;
            color: white;
        }
        
        .leave-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leave-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .leave-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .leave-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .leave-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .staff-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .staff-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .staff-details-small {
            display: flex;
            flex-direction: column;
        }
        
        .staff-name-small {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .staff-id-small {
            font-size: 12px;
            color: #666;
        }
        
        .leave-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .leave-type-badge.casual {
            background: #f59e0b;
        }
        
        .leave-type-badge.earned {
            background: #10b981;
        }
        
        .leave-type-badge.halfpay {
            background: #3b82f6;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .status-badge.approved {
            background: #d1edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .date-range {
            font-size: 14px;
            color: #333;
        }
        
        .date-range .date {
            font-weight: 600;
        }
        
        .duration {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }
        
        .leave-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn.view {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .action-btn.approve {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .action-btn.reject {
            background: #ffebee;
            color: #c62828;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .pagination-btn {
            background: white;
            border: 1px solid #e0e0e0;
            color: #666;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        
        .professional-btn-primary:active {
            transform: translateY(0);
        }
        
        /* Input validation styles */
        .professional-form-input.invalid, .professional-form-select.invalid {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .professional-form-input.valid, .professional-form-select.valid {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* Required field indicator */
        .professional-form-label.required::after {
            content: ' *';
            color: #ef4444;
            font-weight: bold;
        }
        
        /* Loading state */
        .professional-btn.loading {
            position: relative;
            color: transparent;
        }
        
        .professional-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            color: inherit;
        }
        
        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        /* Form animations */
        .professional-form-group {
            animation: fadeInUp 0.3s ease;
        }
        
        .professional-form-group:nth-child(1) { animation-delay: 0.1s; }
        .professional-form-group:nth-child(2) { animation-delay: 0.2s; }
        .professional-form-group:nth-child(3) { animation-delay: 0.3s; }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* User Logs Styles */
        .logs-container {
            margin-top: 20px;
        }
        
        .logs-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logs-search {
            flex: 1;
            min-width: 200px;
        }
        
        .logs-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .logs-action-filter {
            min-width: 150px;
        }
        
        .logs-action-filter select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .logs-table th,
        .logs-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .logs-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .logs-table td {
            font-size: 14px;
            color: #555;
        }
        
        .logs-table tr:hover {
            background: #f8f9fa;
        }
        
        .log-action {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .log-action.login {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .log-action.logout {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .log-action.staff_create {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .log-action.staff_update {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        
        .log-action.designation_create {
            background: #e0f2f1;
            color: #00695c;
        }
        
        .log-timestamp {
            font-size: 12px;
            color: #666;
            white-space: nowrap;
        }
        
        .log-details {
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .log-ip {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        
        /* Mobile Responsive */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        @media (max-width: 768px) {
            .dashboard-body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #eee;
            }
            
            .menu-toggle {
                display: block;
            }
        }

        .portal-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .portal-logo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .portal-title h1 {
            color: #1976d2;
            font-size: 28px;
            font-weight: 600;
        }

        .portal-title h1 .highlight {
            color: #ff6b6b;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .notification-icons {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f5f5;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: not-allowed;
            transition: background-color 0.3s;
            position: relative;
            font-size: 16px;
            color: #ccc;
            opacity: 0.5;
        }

        .icon-btn:hover {
            background: #f5f5f5;
        }
        
        .icon-btn:not([disabled]) {
            cursor: pointer;
            color: #333;
            opacity: 1;
        }
        
        .icon-btn:not([disabled]):hover {
            background: #e3f2fd;
            color: #1976d2;
        }

        .icon-btn.notification[data-count]::after {
            content: attr(data-count);
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 16px;
            height: 16px;
            background: #ff4444;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 15px;
            border-radius: 25px;
            background: #f8f9fa;
            cursor: pointer;
            transition: background-color 0.3s;
            pointer-events: auto;
            position: relative;
            z-index: 1;
        }

        .user-profile:hover {
            background: #e9ecef;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            display: flex;
            align-items: center;
            cursor: pointer;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 16px;
            pointer-events: none;
        }

        .old-user-info {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            pointer-events: none;
        }

        .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            pointer-events: none;
        }

        .user-role {
            font-size: 12px;
            color: #666;
            cursor: pointer;
            pointer-events: none;
        }

        
        .nav {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
        }
        
        .nav-item {
            padding: 10px 20px;
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #1565c0;
        }
        
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            padding: 20px;
            background: linear-gradient(45deg, #1976d2 30%, #42a5f5 90%);
            color: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        
        .status-pending { background: #ff9800; }
        .status-approved { background: #4caf50; }
        .status-rejected { background: #f44336; }
        
        .dept-badge {
            padding: 4px 8px;
            background: #1976d2;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }
        
        

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 20px auto 0 auto;
            padding: 30px;
            border-radius: 15px;
            width: 95%;
            max-width: 1000px;
            max-height: 95vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: black;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        
        .modal-buttons .btn {
            margin-left: 10px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        .field-with-button {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .field-with-button .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .add-btn {
            padding: 8px 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
            height: fit-content;
        }

        .add-btn:hover {
            background: #218838;
        }

        /* Custom Modal Styles */
        .custom-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .custom-modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .custom-modal-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .custom-modal-header h3 {
            color: #1976d2;
            font-size: 18px;
            margin: 0;
        }

        .custom-modal-body {
            margin-bottom: 25px;
        }

        .custom-modal-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }

        .custom-modal-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .custom-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .custom-modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .custom-modal-btn-primary {
            background: #1976d2;
            color: white;
        }

        .custom-modal-btn-primary:hover {
            background: #1565c0;
        }

        .custom-modal-btn-secondary {
            background: #f5f5f5;
            color: #666;
        }

        .custom-modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        .input-error {
            border-color: #f44336 !important;
        }

        .error-message {
            color: #f44336;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Search functionality */
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-input-compact {
            flex: 0.6;
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            max-width: 300px;
        }

        .search-input-expanded {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            min-width: 350px;
        }

        .search-input:focus,
        .search-input-compact:focus,
        .search-input-expanded:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .designation-filter {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
            min-width: 180px;
        }

        .designation-filter-compact {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 160px;
            flex-shrink: 0;
        }

        .designation-filter:focus,
        .designation-filter-compact:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .designation-filter:hover,
        .designation-filter-compact:hover {
            border-color: #ccc;
        }

        /* Unified search container */
        .unified-search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .dashboard-header {
            margin-bottom: 20px;
        }

        .dashboard-header h3 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: #333;
        }

        /* Action buttons */
        .action-btn {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px; /* Further increased to 16px for better visibility */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
            height: 48px; /* Explicit height to match designation filter */
            display: flex;
            align-items: center;
            justify-content: center;
            letter-spacing: 0.3px; /* Added slight letter spacing for better readability */
        }

        .action-btn-clear {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e1e5e9;
            min-width: 80px;
        }

        .action-btn-clear:hover {
            background: #e0e0e0;
            border-color: #ccc;
        }

        .action-btn-primary {
            background: #1976d2;
            color: white;
            border: 2px solid #1976d2;
            min-width: 140px;
        }

        .action-btn-primary:hover {
            background: #1565c0;
            border-color: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(25, 118, 210, 0.2);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .unified-search-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input-expanded {
                min-width: unset;
                width: 100%;
            }
            
            .designation-filter-compact {
                min-width: unset;
                width: 100%;
            }
            
            .action-btn {
                width: 100%;
                justify-content: center;
            }
        }

        .search-clear-btn {
            padding: 10px 15px;
            background: #f5f5f5;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .search-clear-btn:hover {
            background: #e0e0e0;
        }

        /* Confirmation modal styles */
        .confirm-modal {
            display: none;
            position: fixed;
            z-index: 2500;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .confirm-modal-content {
            background-color: white;
            margin: 20% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            text-align: center;
        }

        .confirm-modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .confirm-modal-title {
            color: #333;
            font-size: 20px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .confirm-modal-message {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .confirm-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .confirm-btn-danger {
            background: #f44336;
            color: white;
        }

        .confirm-btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .confirm-btn-success {
            background: #4caf50;
            color: white;
        }

        .confirm-btn-success:hover {
            background: #388e3c;
            transform: translateY(-1px);
        }

        .confirm-btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .confirm-btn-cancel:hover {
            background: #e0e0e0;
        }

        /* Better form organization */
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
        }

        .form-section-title {
            color: #1976d2;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Two-Step Modal Styles - Scoped to admission modal only */
        #admissionModal .admission-progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            margin: 10px -30px 20px -30px;
            gap: 0;
        }

        #admissionModal .admission-progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        #admissionModal .admission-step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            z-index: 2;
            position: relative;
        }

        #admissionModal .admission-step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        #admissionModal .admission-step-circle.completed {
            background: #4caf50;
            color: white;
        }

        #admissionModal .admission-step-label {
            margin-top: 12px;
            font-size: 13px;
            color: #666;
            white-space: nowrap;
            font-weight: 500;
            text-align: center;
        }

        #admissionModal .admission-step-connector {
            width: 200px;
            height: 2px;
            background: #e0e0e0;
            margin: 0 20px;
            align-self: flex-start;
            margin-top: 19px; /* Center with 40px circles (20px - 1px for line height) */
            z-index: 1;
        }

        #admissionModal .admission-step-connector.active {
            background: linear-gradient(90deg, #4caf50 0%, #e0e0e0 100%);
        }

        /* Step Content */
        #admissionModal .admission-step-content {
            display: none;
        }

        #admissionModal .admission-step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Salary Structure Card */
        #admissionModal .salary-structure-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        #admissionModal .salary-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        #admissionModal .salary-card-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            margin-right: 15px;
        }

        #admissionModal .salary-card-title h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 4px;
        }

        #admissionModal .salary-card-title p {
            font-size: 13px;
            color: #666;
        }

        /* Gross Salary Field Styling */
        #admissionModal .gross-salary-group {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
        }

        #admissionModal .gross-salary-group label {
            font-weight: 600;
            color: #007bff;
            font-size: 15px;
        }

        #admissionModal .gross-salary-group input {
            font-weight: 600;
            font-size: 15px;
            color: #007bff !important;
            border: 1px solid #ced4da;
            background-color: #f8f9fa !important;
        }


        #admissionModal .salary-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        #admissionModal .salary-group {
            position: relative;
        }

        #admissionModal .salary-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 13px;
        }

        #admissionModal .salary-group input,
        #admissionModal .salary-group select {
            width: 100%;
            padding: 10px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        #admissionModal .salary-group input[type="number"] {
            padding-left: 40px;
        }

        #admissionModal .salary-group input#da,
        #admissionModal .salary-group input#hra {
            padding-right: 40px;
        }

        /* Remove spinner arrows from specific number inputs */
        #admissionModal input#basicPayCalculated::-webkit-outer-spin-button,
        #admissionModal input#basicPayCalculated::-webkit-inner-spin-button,
        #admissionModal input#da::-webkit-outer-spin-button,
        #admissionModal input#da::-webkit-inner-spin-button,
        #admissionModal input#hra::-webkit-outer-spin-button,
        #admissionModal input#hra::-webkit-inner-spin-button,
        #admissionModal input#specialPay::-webkit-outer-spin-button,
        #admissionModal input#specialPay::-webkit-inner-spin-button,
        #admissionModal input#specialAllowance::-webkit-outer-spin-button,
        #admissionModal input#specialAllowance::-webkit-inner-spin-button,
        #admissionModal input#otherAllowance::-webkit-outer-spin-button,
        #admissionModal input#otherAllowance::-webkit-inner-spin-button,
        #admissionModal input#grossSalary::-webkit-outer-spin-button,
        #admissionModal input#grossSalary::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #admissionModal input#basicPayCalculated[type=number],
        #admissionModal input#grossSalary[type=number],
        #admissionModal input#da[type=number],
        #admissionModal input#hra[type=number],
        #admissionModal input#specialPay[type=number],
        #admissionModal input#specialAllowance[type=number],
        #admissionModal input#otherAllowance[type=number] {
            -moz-appearance: textfield;
        }

        /* Remove spinner arrows from deductions modal inputs */
        #deductionsModal input[type=number]::-webkit-outer-spin-button,
        #deductionsModal input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #deductionsModal input[type=number] {
            -moz-appearance: textfield;
        }

        /* New calculation group styles for deductions modal */
        #deductionsModal .calculation-group {
            background: #f8f9ff;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            position: relative;
        }
        
        #deductionsModal .calculation-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #3954cc;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #deductionsModal .calculation-row {
            display: flex;
            align-items: center;
            gap: 22px;
            flex-wrap: nowrap;
        }
        
        #deductionsModal .calculation-field {
            display: flex;
            flex-direction: column;
            min-width: 180px;
            flex: 1;
            max-width: 220px;
        }
        
        #deductionsModal .calculation-field label {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #deductionsModal .calculation-field input {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-align: center;
            width: 100%;
        }
        
        #deductionsModal .calculation-field input:focus {
            outline: none;
            border-color: #3954cc;
            box-shadow: 0 0 0 3px rgba(57, 84, 204, 0.1);
        }
        
        #deductionsModal .calculation-field input[readonly] {
            background: #f0f4ff;
            color: #3954cc;
            font-weight: 600;
            border-color: #3954cc;
            cursor: not-allowed;
        }
        
        #deductionsModal .calculation-field input:disabled {
            background: #f5f5f5;
            color: #999;
            border-color: #ddd;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #deductionsModal .calculation-field input:not(:disabled) {
            background: white;
            color: #333;
            opacity: 1;
        }
        
        #deductionsModal .calculation-operator {
            font-size: 22px;
            font-weight: 600;
            color: #3954cc;
            margin-top: 20px;
            min-width: 30px;
            text-align: center;
        }
        
        #deductionsModal .calculation-equals {
            font-size: 24px;
            font-weight: 600;
            color: #28a745;
            margin-top: 20px;
        }

        /* Enhanced form grid for deductions modal */
        #deductionsModal .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        /* Real-time Total Deductions Summary Styles */
        .deductions-total-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .total-summary-header h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.95;
        }

        .total-summary-content {
            text-align: center;
        }

        .total-amount {
            font-size: 36px;
            font-weight: 800;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 1px;
        }

        .total-label {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Responsive adjustments for total summary */
        @media (max-width: 768px) {
            .deductions-total-summary {
                margin: 20px 0;
                padding: 20px;
            }
            
            .total-amount {
                font-size: 28px;
            }
            
            .total-summary-header h3 {
                font-size: 16px;
            }
        }

        #deductionsModal .form-group {
            margin-bottom: 20px;
        }

        #deductionsModal .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }

        #deductionsModal .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        #deductionsModal .form-group input:focus {
            outline: none;
            border-color: #3954cc;
            box-shadow: 0 0 0 3px rgba(57, 84, 204, 0.1);
        }


        #admissionModal .salary-group .currency-symbol {
            position: absolute;
            left: 15px;
            top: 32px;
            color: #666;
            font-weight: 600;
        }

        #admissionModal .salary-group .percentage-symbol {
            position: absolute;
            right: 15px;
            top: 32px;
            color: #666;
            font-weight: 600;
        }

        #admissionModal .salary-group input:focus,
        #admissionModal .salary-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        #admissionModal .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        #admissionModal .info-box {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #admissionModal .info-box-icon {
            color: #1976d2;
            font-size: 20px;
        }

        #admissionModal .info-box-text {
            font-size: 13px;
            color: #0d47a1;
            line-height: 1.4;
        }

        /* Footer adjustments for two-step */
        #admissionModal .modal-buttons {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
            padding: 20px 30px;
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
            margin-top: auto;
        }

        #admissionModal .footer-info {
            font-size: 13px;
            color: #666;
        }

        #admissionModal .footer-buttons {
            display: flex;
            gap: 12px;
        }

        /* Specific styling for admission modal to handle fixed header */
        #admissionModal .modal-content {
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Professional Modal Header for Admission Modal */
        #admissionModal .admission-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 25px 30px;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
            overflow: hidden;
            border-radius: 15px 15px 0 0;
            flex-shrink: 0;
        }

        /* Scrollable content area */
        #admissionModal .modal-scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        #admissionModal .admission-modal-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: admissionPulse 3s ease-in-out infinite;
        }

        @keyframes admissionPulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.3; }
        }

        #admissionModal .admission-modal-header-content {
            position: relative;
            z-index: 1;
        }

        #admissionModal .admission-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: white;
        }

        #admissionModal .admission-modal-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        #admissionModal .admission-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 2;
        }

        #admissionModal .admission-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Hide original header elements when using professional header */
        #admissionModal.professional-header .close {
            display: none;
        }

        #admissionModal.professional-header #admissionModalTitle {
            display: none;
        }

        /* Validation Error Styles */
        #admissionModal input.validation-error,
        #admissionModal select.validation-error,
        #admissionModal textarea.validation-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
            animation: admissionFieldError 0.5s ease-in-out;
        }

        @keyframes admissionFieldError {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
            20%, 40%, 60%, 80% { transform: translateX(2px); }
        }

        @media (max-width: 768px) {
            #admissionModal .admission-progress-indicator {
                padding: 25px 15px;
                margin: 10px -20px 20px -20px;
            }

            #admissionModal .admission-step-connector {
                width: 120px;
                margin: 0 15px;
                margin-top: 19px; /* Same centering logic */
            }

            #admissionModal .admission-step-label {
                font-size: 12px;
                margin-top: 10px;
            }

            #admissionModal .salary-inputs {
                grid-template-columns: 1fr;
            }

            #admissionModal .admission-modal-header {
                padding: 20px;
                margin: -20px -20px 0 -20px;
            }
        }

        .pending-requests-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .pending-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .pending-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pending-card-title {
            font-weight: 600;
            color: #333;
        }

        .pending-card-id {
            color: #666;
            font-size: 12px;
        }

        .pending-card-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn-approve {
            background: #4caf50;
            color: white;
        }

        .action-btn-approve:hover {
            background: #388e3c;
        }

        .action-btn-decline {
            background: #f44336;
            color: white;
        }

        .action-btn-decline:hover {
            background: #d32f2f;
        }

        .action-btn-view {
            background: #2196f3;
            color: white;
        }

        .action-btn-view:hover {
            background: #1976d2;
        }

        /* Details Modal Styles */
        .details-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s ease;
        }

        .details-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }

        .details-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 15px;
        }

        .details-modal-title {
            color: #1976d2;
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }

        .details-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            margin: 0;
        }

        .details-close:hover {
            color: #333;
        }

        .details-section {
            margin-bottom: 25px;
        }

        .details-section-title {
            color: #1976d2;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-left: 4px solid #1976d2;
            padding-left: 10px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .details-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .details-label {
            color: #666;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .details-value {
            color: #333;
            font-size: 14px;
            font-weight: 500;
        }

        .details-value.empty {
            color: #999;
            font-style: italic;
        }

        /* Staff Details Modal Specific Styles */
        .staff-details-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .staff-photo-section {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .staff-photo-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid #1976d2;
            object-fit: cover;
        }

        .staff-initials-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            border: 4px solid #1976d2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: 600;
            color: white;
        }

        .details-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #e1e5e9;
        }

        /* Photo Upload Section */
        .photo-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #1976d2;
            text-align: center;
        }

        .photo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .photo-preview {
            width: 150px;
            height: 180px;
            border: 2px dashed #1976d2;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .photo-placeholder {
            color: #666;
            font-size: 14px;
            text-align: center;
            padding: 20px;
        }

        .photo-placeholder i {
            font-size: 48px;
            color: #1976d2;
            margin-bottom: 10px;
            display: block;
        }

        .photo-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .photo-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .photo-btn-upload {
            background: #1976d2;
            color: white;
        }

        .photo-btn-upload:hover {
            background: #1565c0;
        }

        .photo-btn-camera {
            background: #4caf50;
            color: white;
        }

        .photo-btn-camera:hover {
            background: #388e3c;
        }

        .photo-btn-remove {
            background: #f44336;
            color: white;
        }

        .photo-btn-remove:hover {
            background: #d32f2f;
        }

        .photo-input {
            display: none;
        }
        
        /* Rights/Permissions Checkboxes */
        .rights-container {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #f8f9fa;
        }
        
        .rights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .right-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            transition: all 0.3s ease;
        }
        
        .right-item:hover {
            border-color: #1976d2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .right-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
        }
        
        .right-details {
            flex: 1;
        }
        
        .right-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .right-description {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
        }

        /* New Permissions Dropdown Styles */
        .permissions-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Tab Item Styling */
        .tab-permission-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .tab-permission-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
        }

        .tab-permission-item.active {
            border-color: #3b82f6;
            background: #f8fafc;
        }

        .tab-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
            user-select: none;
        }

        .tab-permission-item.active .tab-header {
            background: #f8fafc;
        }

        .tab-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tab-icon {
            font-size: 20px;
            opacity: 0.8;
        }

        .tab-details {
            flex: 1;
        }

        .tab-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 15px;
        }

        .tab-description {
            font-size: 13px;
            color: #6b7280;
            margin-top: 2px;
        }

        .tab-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .permissions-count {
            background: #3b82f6;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .permissions-count.empty {
            background: #e5e7eb;
            color: #6b7280;
        }

        .dropdown-arrow {
            font-size: 14px;
            color: #6b7280;
            transition: transform 0.2s ease;
        }

        .tab-permission-item.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        /* Dropdown Content */
        .permissions-dropdown {
            display: none;
            padding: 0 20px 20px 20px;
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }

        .tab-permission-item.active .permissions-dropdown {
            display: block;
        }

        .dropdown-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            padding-top: 4px;
        }

        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .permission-option {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            padding: 12px 14px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
            min-height: 80px;
            text-align: left;
        }

        .permission-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .permission-option.selected {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }

        .permission-checkbox {
            width: 16px;
            height: 16px;
            accent-color: #10b981;
        }

        .permission-header {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .permission-label {
            font-weight: 600;
            font-size: 14px;
            color: #1f2937;
        }

        .permission-description {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.3;
            margin-top: 2px;
            text-align: left;
            width: 100%;
        }

        /* Permission Type Indicators */
        .permission-read {
            border-left: 3px solid #3b82f6;
        }

        .permission-write {
            border-left: 3px solid #f59e0b;
        }

        .permission-edit {
            border-left: 3px solid #10b981;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .quick-btn {
            padding: 6px 12px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-btn:hover {
            background: #e5e7eb;
        }

        .quick-btn.select-all {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        .quick-btn.clear-all {
            background: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Navigation permission styles */
        .nav-item.disabled-by-permissions {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
            color: #999;
            position: relative;
        }

        .nav-item.disabled-by-permissions:hover {
            background: #f5f5f5;
            color: #999;
        }

        .nav-item.disabled-by-permissions .nav-icon {
            opacity: 0.3;
        }

        .nav-item.disabled-by-permissions:hover::after {
            content: "Access restricted - Contact administrator";
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-left: 10px;
        }

        .nav-item.disabled-by-permissions:hover::before {
            content: "";
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-right-color: #333;
            margin-left: 4px;
            z-index: 1001;
        }

        /* Camera Modal */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .camera-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            text-align: center;
        }

        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 8px;
            margin: 15px auto;
            position: relative;
            overflow: hidden;
        }

        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-canvas {
            display: none;
        }

        .camera-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .camera-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .camera-btn-capture {
            background: #4caf50;
            color: white;
        }

        .camera-btn-capture:hover {
            background: #388e3c;
        }

        .camera-btn-cancel {
            background: #f5f5f5;
            color: #666;
        }

        .camera-btn-cancel:hover {
            background: #e0e0e0;
        }

        /* Document Upload Section */
        .documents-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #ff9800;
        }

        .documents-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .document-upload-area {
            border: 2px dashed #ff9800;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .document-upload-area:hover {
            border-color: #f57c00;
            background: #fff8e1;
        }

        .document-upload-area.drag-over {
            border-color: #f57c00;
            background: #fff8e1;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #ff9800;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #f57c00;
        }

        .document-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .document-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            transition: all 0.3s;
        }

        .document-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .document-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .document-icon {
            font-size: 20px;
            min-width: 20px;
        }

        .document-details {
            flex: 1;
        }

        .document-name {
            font-weight: 500;
            color: #333;
            font-size: 14px;
            word-break: break-word;
        }

        .document-size {
            color: #666;
            font-size: 12px;
        }

        .document-actions {
            display: flex;
            gap: 5px;
        }

        .doc-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .doc-btn-download {
            background: #4caf50;
            color: white;
        }

        .doc-btn-download:hover {
            background: #388e3c;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
        }

        .doc-btn-remove {
            background: #f44336;
            color: white;
        }

        .doc-btn-remove:hover {
            background: #d32f2f;
        }

        .document-input {
            display: none;
        }

        .document-count {
            color: #ff9800;
            font-size: 12px;
            font-weight: 500;
            margin-top: 10px;
        }

        /* Attendance Management Styles */
        .attendance-overview {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .attendance-tabs {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .attendance-tabs-left {
            display: flex;
            gap: 10px;
        }

        .attendance-tabs-right {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .attendance-tabs-right .btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            height: auto;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .attendance-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #666;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .attendance-tab:hover {
            color: #1976d2;
            background: rgba(25, 118, 210, 0.05);
        }

        .attendance-tab.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
        }

        .attendance-content {
            min-height: 400px;
        }

        .attendance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        /* New Attendance Redesign Styles */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .section-header-left {
            display: flex;
            align-items: center;
        }

        .section-header-left h3 {
            font-size: 32px !important;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .section-header-right {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: flex-end;
        }

        .attendance-action-buttons {
            display: flex;
            gap: 12px;
        }

        .attendance-quick-stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .quick-stat-item {
            text-align: center;
        }

        .quick-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2563eb;
            line-height: 1;
        }

        .quick-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-weight: 500;
        }

        .attendance-header-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .attendance-header-stats h3 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .attendance-summary-stats {
            display: flex;
            gap: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #2563eb;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 4px;
        }

        /* Search and Filter Controls */
        .attendance-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }

        .search-box {
            flex: 1;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        .filter-dropdown {
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .filter-dropdown:focus {
            outline: none;
            border-color: #2563eb;
        }

        /* Staff Tiles Grid */
        .staff-tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* Individual Staff Tile */
        .staff-tile {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .staff-tile:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .staff-tile.expanded {
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.12);
        }

        /* Staff Info Section */
        .staff-tile-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .staff-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .staff-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .staff-tile-details {
            flex: 1;
        }

        .staff-tile-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .staff-tile-designation {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .staff-tile-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-present {
            background: #d1fae5;
            color: #065f46;
        }

        .status-leave {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-partial {
            background: #fef3c7;
            color: #92400e;
        }

        .staff-tile-status:not(.status-present):not(.status-leave):not(.status-partial) {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .status-dot.status-online {
            background: #4caf50 !important;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5) !important;
        }
        
        .status-dot.status-offline {
            background: #ff5252 !important;
            box-shadow: 0 0 5px rgba(255, 82, 82, 0.3) !important;
        }

        /* Total Leaves Section */
        .staff-total-leaves {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaves-label {
            font-size: 14px;
            color: #6b7280;
        }

        .leaves-count {
            font-size: 20px;
            font-weight: 600;
            color: #2563eb;
        }

        .leaves-total {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }

        /* Expand Arrow */
        .expand-arrow {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .staff-tile.expanded .expand-arrow {
            transform: rotate(180deg);
        }

        /* Dropdown Content */
        .leave-details-dropdown {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            margin-top: 0;
        }

        .staff-tile.expanded .leave-details-dropdown {
            max-height: 500px;
            margin-top: 20px;
        }

        .leave-category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .leave-category-item:last-child {
            margin-bottom: 0;
        }

        .category-name {
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .category-count {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-used {
            font-size: 16px;
            font-weight: 600;
            color: #2563eb;
        }

        .count-separator {
            color: #9ca3af;
        }

        .count-total {
            font-size: 14px;
            color: #6b7280;
        }

        /* Progress Bar */
        .leave-progress {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin-top: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* Professional Cannot Delete Modal Styles */
        .cannot-delete-usage {
            margin: 20px 0;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #ef4444;
        }

        .usage-title, .instructions-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .usage-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .usage-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e5e7eb;
        }

        .usage-item:last-child {
            margin-bottom: 0;
        }

        .usage-item-name {
            font-weight: 500;
            color: #1f2937;
        }

        .usage-item-id {
            color: #6b7280;
            font-size: 13px;
        }

        .usage-item-type {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-left: auto;
        }

        .cannot-delete-instructions {
            margin: 20px 0 0 0;
            padding: 16px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .instructions-list {
            font-size: 14px;
            color: #374151;
            line-height: 1.5;
        }

        .instruction-step {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
        }

        .instruction-step:last-child {
            margin-bottom: 0;
        }

        .step-number {
            background: #3b82f6;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .step-text {
            flex: 1;
        }

        /* Keep old styles for backward compatibility */
        .staff-attendance-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .staff-attendance-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .staff-info h4 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 18px;
        }

        .staff-info p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 14px;
        }

        .leave-balance {
            margin-bottom: 15px;
        }

        .leave-type-balance {
            margin-bottom: 12px;
        }

        .leave-type-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
            color: #555;
        }

        .leave-progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .leave-progress-fill {
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .leave-applications-container h4 {
            color: #333;
            margin: 20px 0 15px 0;
            font-size: 18px;
        }

        .applications-list {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .leave-application-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .leave-application-card.pending {
            border-left: 4px solid #f59e0b;
        }

        .leave-application-card.approved {
            border-left: 4px solid #10b981;
            opacity: 0.8;
        }

        .leave-application-card.rejected {
            border-left: 4px solid #ef4444;
            opacity: 0.7;
        }

        .leave-application-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .application-header h5 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }

        .leave-type-badge {
            padding: 4px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: 500;
        }

        .application-details {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
        }

        .application-details p {
            margin: 5px 0;
        }

        .salary-deduction-warning {
            color: #ef4444;
            font-weight: 500;
            margin-top: 10px;
        }

        .application-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .application-status {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }

        .attendance-calendar {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .attendance-reports {
            background: white;
            padding: 20px;
            border-radius: 10px;
        }

        .report-options {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn-small {
            padding: 6px 16px;
            font-size: 13px;
        }

        /* Leave Balance Info Styles */
        .leave-balance-info {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .balance-text {
            color: #333;
            font-size: 14px;
            margin: 0 0 10px 0;
            font-weight: 500;
        }

        .warning-text {
            color: #ef4444;
            font-size: 13px;
            margin: 0;
            font-weight: 500;
        }

        .leave-types-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Leave Application Modal Specific Styles */
        #leaveApplicationModal {
            height: 80vh;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        
        #leaveApplicationModal > form {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #leaveApplicationModal .professional-modal-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            padding: 20px 30px;
            overflow-y: auto;
            flex: 1;
            height: calc(80vh - 180px);
        }
        
        #leaveApplicationModal .professional-modal-footer {
            position: sticky;
            bottom: 0;
            z-index: 10;
            margin-top: 0;
        }

        #leaveApplicationModal .form-group {
            margin-bottom: 15px;
        }

        #leaveApplicationModal .form-group:nth-child(1),
        #leaveApplicationModal .form-group:nth-child(2),
        #leaveApplicationModal .form-group:nth-child(3) {
            grid-column: span 2;
        }

        #leaveApplicationModal .form-group:nth-child(7),
        #leaveApplicationModal .form-group:nth-child(8) {
            grid-column: span 2;
        }

        #leaveApplicationModal #leaveBalanceInfo {
            grid-column: span 2;
            margin-top: 10px;
        }

        /* File Upload Styling */
        .file-upload-wrapper {
            position: relative;
        }

        .file-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            background: #f9fafb;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .file-upload-label:hover {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .file-upload-icon {
            font-size: 18px;
        }

        .file-upload-label.has-file {
            border-color: #10b981;
            background: #ecfdf5;
            color: #059669;
        }

        .file-info {
            margin-top: 8px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
        }

        /* Fake Time System Styles */
        .fake-time-controls {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .fake-time-controls h4 {
            margin: 0 0 15px 0;
            color: #856404;
        }

        .fake-time-controls h5 {
            margin: 15px 0 10px 0;
            color: #6c757d;
            font-size: 16px;
        }

        .current-date-display {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }

        .date-selection-controls {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .date-selectors {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .date-selectors .form-group {
            margin-bottom: 0;
        }

        .date-selectors label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: #495057;
        }

        .date-selectors select {
            min-width: 80px;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background-color: white;
        }

        .date-selectors button {
            margin-left: 10px;
            padding: 8px 16px;
            font-size: 14px;
        }

        .time-controls {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .time-controls .form-group {
            margin-bottom: 0;
        }

        .system-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .system-info span {
            background: #fff;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .reset-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ffeaa7;
        }

        .reset-controls .btn-warning {
            background: linear-gradient(135deg, #ff7675 0%, #e84393 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 118, 117, 0.3);
        }

        .reset-controls .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 118, 117, 0.4);
        }

        .reset-info {
            font-size: 12px;
            color: #856404;
            font-style: italic;
        }

        /* Professional Changes Applied Modal */
        .changes-applied-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 400px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1002;
            display: none;
            overflow: hidden;
        }

        .changes-applied-modal.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            display: block;
        }

        .changes-applied-header {
            padding: 40px 32px 30px;
            text-align: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            position: relative;
        }

        .changes-applied-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%);
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.1; }
        }

        .changes-applied-icon-wrapper {
            width: 90px;
            height: 90px;
            margin: 0 auto 25px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            animation: success-bounce 0.6s ease-out;
        }

        @keyframes success-bounce {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .changes-applied-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .changes-applied-title {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin: 0 0 8px 0;
            position: relative;
            z-index: 1;
        }

        .changes-applied-subtitle {
            font-size: 14px;
            color: #059669;
            margin: 0 0 20px 0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .changes-applied-body {
            padding: 0 32px 40px;
            text-align: center;
        }

        .changes-applied-description {
            font-size: 16px;
            color: #64748b;
            line-height: 1.6;
            margin: 0;
        }

        .female-restriction {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
        }

        .leave-details {
            margin-top: 5px;
        }

        .leave-details small {
            color: #666;
            font-size: 12px;
        }

        /* Enhanced leave type balance display */
        .leave-type-balance {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .leave-type-balance:last-child {
            margin-bottom: 0;
        }

        /* Leave Balance Information Styles */
        .balance-details h5 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .balance-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-bottom: 8px;
        }

        .balance-item strong {
            font-size: 13px;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }

        .balance-breakdown {
            margin-top: 5px;
        }

        .balance-breakdown p {
            margin: 3px 0;
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        /* Custom dropdown styles for leave types with visual bars */
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
        }

        .custom-dropdown-button {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .custom-dropdown-button:hover {
            border-color: #007bff;
        }

        .dropdown-arrow {
            font-size: 12px;
            color: #666;
        }

        .custom-dropdown-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .custom-dropdown-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .custom-dropdown-option:hover {
            background-color: #f8f9fa;
        }

        .custom-dropdown-option:last-child {
            border-bottom: none;
        }

        .leave-option-content {
            width: 100%;
        }

        .leave-option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .leave-option-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .leave-option-description {
            font-size: 11px;
            color: #666;
            margin-bottom: 8px;
        }

        .leave-balance-bar {
            margin-top: 8px;
        }

        .leave-bar-background {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }

        .leave-bar-used {
            height: 100%;
            transition: width 0.3s ease;
        }

        .leave-bar-available {
            height: 100%;
            transition: width 0.3s ease;
        }

        .leave-bar-text {
            font-size: 10px;
            color: #495057;
            margin-top: 2px;
            text-align: right;
        }

        .validation-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-weight: 500;
        }

        .validation-message p {
            margin: 0;
        }

        /* Input field color feedback */
        #leaveStaffName[readonly] {
            background-color: #f8f9fa;
            border-color: #e9ecef;
        }

        #leaveStaffName[style*="color: #28a745"] {
            border-color: #28a745;
            background-color: #f8fff9;
        }

        #leaveStaffName[style*="color: #dc3545"] {
            border-color: #dc3545;
            background-color: #fff8f8;
        }

        /* Submit button disabled state */
        #submitLeaveBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Pikaday Calendar Styles */
        .pika-single {
            z-index: 9999;
            background: #fff;
            border: 1px solid #ccc;
            border-bottom-color: #bbb;
            border-radius: 4px;
            box-shadow: 0 5px 15px -5px rgba(0,0,0,.5);
        }

        .pika-single:after,
        .pika-single:before {
            content: '';
            display: table;
        }

        .pika-single:after {
            clear: both;
        }

        .pika-single.is-hidden {
            display: none;
        }

        .pika-single.is-bound {
            position: absolute;
            box-shadow: 0 5px 15px -5px rgba(0,0,0,.5);
        }

        .pika-lendar {
            float: left;
            width: 240px;
            margin: 8px;
        }

        .pika-title {
            position: relative;
            text-align: center;
        }

        .pika-label {
            display: inline-block;
            position: relative;
            z-index: 9999;
            overflow: hidden;
            margin: 0;
            padding: 5px 3px;
            font-size: 14px;
            line-height: 20px;
            font-weight: bold;
            background-color: #fff;
        }

        .pika-title select {
            cursor: pointer;
            position: absolute;
            z-index: 9998;
            margin: 0;
            left: 0;
            top: 5px;
            filter: alpha(opacity=0);
            opacity: 0;
        }

        .pika-prev,
        .pika-next {
            display: block;
            cursor: pointer;
            position: relative;
            outline: none;
            border: 0;
            padding: 0;
            width: 20px;
            height: 30px;
            text-indent: 20px;
            white-space: nowrap;
            overflow: hidden;
            background-color: transparent;
            background-position: center center;
            background-repeat: no-repeat;
            background-size: 75% 75%;
            opacity: .5;
        }

        .pika-prev:hover,
        .pika-next:hover {
            opacity: 1;
        }

        .pika-prev,
        .is-rtl .pika-next {
            float: left;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAAUklEQVR42u3VMQoAIBADQf8Pgj+OD9hG2CtONJB2ymQkKe0HbwAP0xucDiQWARITIDEBEnMgMQ8S8+AqBIl6kKgHiXqQqAeJepBo/z38J/U0uAHlaBkBl9I4GwAAAABJRU5ErkJggg==');
        }

        .pika-next,
        .is-rtl .pika-prev {
            float: right;
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAeCAYAAAAsEj5rAAAAU0lEQVR42u3VOwoAMAgE0dwfAnNjU26bYkBCFGwfiL9VVWoO+BJ4Gf3gtsEKKoFBNTCoCAYVwaAiGNQGg2q/+Y3XLmEXaAeOSfoAaQMOQLvNTzzHGPLHqFgAAYgdAhGUTAAAAABJRU5ErkJggg==');
        }

        .pika-select {
            display: inline-block;
        }

        .pika-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pika-table th,
        .pika-table td {
            width: 14.285714285714286%;
            padding: 0;
        }

        .pika-table th {
            color: #999;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            padding-bottom: 5px;
            border-bottom: 1px solid #eee;
        }

        .pika-button {
            cursor: pointer;
            display: block;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            outline: none;
            border: 0;
            margin: 0;
            width: 100%;
            padding: 5px;
            color: #666;
            font-size: 12px;
            line-height: 15px;
            text-align: center;
            background: #f5f5f5;
        }

        .pika-week {
            font-size: 11px;
            color: #999;
        }

        .is-today .pika-button {
            color: #33aaff;
            font-weight: bold;
        }

        .is-selected .pika-button {
            color: #fff;
            font-weight: bold;
            background: #33aaff;
            box-shadow: inset 0 1px 3px #178fe5;
            border-radius: 3px;
        }

        .is-inrange .pika-button {
            background: #D5E9F7;
        }

        .is-startrange .pika-button {
            color: #fff;
            background: #6CB31D;
            box-shadow: none;
            border-radius: 3px;
        }

        .is-endrange .pika-button {
            color: #fff;
            background: #33aaff;
            box-shadow: none;
            border-radius: 3px;
        }

        .is-disabled .pika-button,
        .is-outside-current-month .pika-button {
            pointer-events: none;
            cursor: default;
            color: #999;
            opacity: .3;
        }

        .pika-button:hover {
            color: #fff;
            background: #ff8000;
            box-shadow: none;
            border-radius: 3px;
        }

        /* Custom styles for simple appearance */
        .pika-single {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #ddd;
        }

        .pika-table th {
            color: #666;
            font-size: 11px;
        }

        .pika-button {
            font-family: inherit;
            background: transparent;
            border-radius: 2px;
        }

        .pika-button:hover {
            background: #e6f3ff;
            color: #333;
        }

        .is-selected .pika-button {
            background: #007cba;
            color: white;
        }

        .is-today .pika-button {
            color: #007cba;
            font-weight: normal;
        }
        
        /* Year and Month dropdown styling with scrollbar */
        .pika-select {
            max-height: 200px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        .pika-select-year {
            max-height: 200px !important;
            overflow-y: scroll !important;
            overflow-x: hidden !important;
        }
        
        /* Style the select dropdowns */
        .pika-select {
            cursor: pointer;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            background-color: #fff;
        }
        
        /* Custom scrollbar for year/month dropdowns */
        .pika-select::-webkit-scrollbar,
        .pika-select-year::-webkit-scrollbar {
            width: 8px;
        }
        
        .pika-select::-webkit-scrollbar-track,
        .pika-select-year::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .pika-select::-webkit-scrollbar-thumb,
        .pika-select-year::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .pika-select::-webkit-scrollbar-thumb:hover,
        .pika-select-year::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Firefox scrollbar styling */
        .pika-select,
        .pika-select-year {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }
        
        /* Ensure Pikaday calendar stays on top and repositions correctly */
        .pika-single {
            z-index: 99999 !important;
        }
        
        /* Fix for modals */
        .modal .pika-single,
        .professional-modal .pika-single {
            z-index: 999999 !important;
        }
        
        /* Style for read-only retirement date field */
        #retirementDate {
            background-color: #f5f5f5;
            cursor: not-allowed;
            color: #666;
        }
        
        #retirementDate:hover {
            background-color: #f5f5f5;
        }
        
        /* Flatpickr (Most Popular & Feature-Rich) styles from calendar-samples.html */
        .flatpickr-calendar {
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        /* Simple date input styling */
        .google-calendar-input {
            position: relative;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
        }
        
        .google-calendar-input:hover {
            border-color: #999 !important;
            background: #fafafa !important;
        }
        
        .google-calendar-input:focus {
            outline: none;
            border-color: #666 !important;
            box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05) !important;
        }
        
        /* Calendar icon for date inputs */
        .date-input-wrapper {
            position: relative;
        }
        
        .date-input-wrapper .calendar-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
            width: 20px;
            height: 20px;
        }
        
        /* Edit Profile Modal Styles */
        .edit-profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .edit-profile-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }
        
        .edit-profile-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
        }
        
        .edit-profile-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 30px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }
        
        .edit-profile-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .edit-profile-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .edit-profile-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .edit-profile-subtitle {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .edit-profile-body {
            padding: 30px;
        }
        
        .profile-form-group {
            margin-bottom: 20px;
        }
        
        .profile-form-group label {
            display: block;
            color: #333;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .profile-form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .profile-form-group input:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        
        .profile-form-group input:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }
        
        .password-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 25px;
            margin-bottom: 20px;
        }
        
        .password-section-title {
            color: #333;
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .password-toggle-container {
            position: relative;
        }
        
        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }
        
        .password-toggle:hover {
            color: #1976d2;
        }
        
        .profile-form-actions {
            display: flex;
            gap: 12px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .btn-save-profile {
            flex: 1;
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-save-profile:hover {
            background: #1565c0;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }
        
        .btn-cancel-profile {
            flex: 1;
            background: #f5f5f5;
            color: #666;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-cancel-profile:hover {
            background: #e0e0e0;
        }
        
        .validation-message {
            font-size: 12px;
            color: #f44336;
            margin-top: 5px;
            display: none;
        }
        
        .validation-message.show {
            display: block;
        }
        
        .success-indicator {
            color: #4caf50;
            display: none;
            font-size: 14px;
            margin-top: 10px;
            padding: 10px;
            background: rgba(76, 175, 80, 0.1);
            border-radius: 6px;
            text-align: center;
        }
        
        /* Responsive Design for Edit Profile Modal */
        @media (max-width: 600px) {
            .edit-profile-content {
                width: 95%;
                margin: 20px;
            }
            
            .edit-profile-header {
                padding: 20px;
            }
            
            .edit-profile-body {
                padding: 20px;
            }
            
            .profile-form-actions {
                flex-direction: column;
            }
            
            .btn-save-profile,
            .btn-cancel-profile {
                width: 100%;
            }
        }
        
        /* Professional List View Styles */
        .list-view-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .list-view-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-view-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .list-view-filters {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-dropdown {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .filter-dropdown option {
            background: #333;
            color: white;
        }
        
        .leave-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leave-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .leave-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .leave-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .leave-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .staff-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .staff-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }
        
        .staff-details-small {
            display: flex;
            flex-direction: column;
        }
        
        .staff-name-small {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .staff-id-small {
            font-size: 12px;
            color: #666;
        }
        
        .leave-type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .leave-type-badge.casual {
            background: #48bb78;
        }
        
        .leave-type-badge.earned {
            background: #ed8936;
        }
        
        .leave-type-badge.halfpay {
            background: #f56565;
        }
        
        .date-range {
            font-size: 14px;
            color: #333;
        }
        
        .date {
            font-weight: 500;
        }
        
        .duration {
            font-weight: 600;
            color: #667eea;
        }
        
        .status-badge.pending {
            background: #ffa726;
            color: white;
        }
        
        .status-badge.approved {
            background: #66bb6a;
            color: white;
        }
        
        .status-badge.rejected {
            background: #ef5350;
            color: white;
        }
        
        .leave-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn.view {
            background: #6c757d;
            color: white;
        }
        
        .action-btn.approve {
            background: #28a745;
            color: white;
        }
        
        .action-btn.reject {
            background: #dc3545;
            color: white;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }
        
        .pagination-controls {
            display: flex;
            gap: 5px;
        }
        
        .pagination-info {
            color: #666;
            font-size: 14px;
        }
        
        .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: white;
            color: #333;
            font-size: 14px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .pagination-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Professional Reports Styles */
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .reports-header-left h2 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }
        
        .reports-header-left p {
            color: #666;
            margin: 5px 0 0 0;
        }
        
        .reports-header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* Report Cards */
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .report-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }
        
        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        
        .report-card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .report-card-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .report-card-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .report-card-body {
            padding: 20px;
        }
        
        .report-card-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .report-card-features {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 0;
        }
        
        .report-card-features li {
            padding: 5px 0;
            font-size: 13px;
            color: #555;
        }
        
        .report-card-features li::before {
            content: '‚úì';
            color: #28a745;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .report-generate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .report-generate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Report Filters Section */
        .reports-filters {
            background: #f8f9ff;
            border: 2px solid #e3f2fd;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }
        
        .filters-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
        }
        
        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .filters-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }
        
        .btn-filter {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-filter.primary {
            background: #667eea;
            color: white;
        }
        
        .btn-filter.secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-filter:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .quick-stat-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
            text-align: center;
            border: 1px solid #f0f0f0;
        }
        
        .quick-stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .quick-stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .quick-stat-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quick-stat-card.present .quick-stat-icon { color: #28a745; }
        .quick-stat-card.absent .quick-stat-icon { color: #dc3545; }
        .quick-stat-card.leave .quick-stat-icon { color: #ffc107; }
        .quick-stat-card.late .quick-stat-icon { color: #fd7e14; }

        /* Report Results */
        .report-results {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .report-results-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .report-results-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
        }
        
        .report-action-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .report-action-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .report-table thead {
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .report-table th {
            padding: 16px 20px;
            text-align: left;
            font-weight: 600;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .report-table td {
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        
        .report-table tbody tr:hover {
            background: #f8f9ff;
        }
        
        .attendance-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .attendance-status.present {
            background: #d4edda;
            color: #155724;
        }
        
        .attendance-status.absent {
            background: #f8d7da;
            color: #721c24;
        }
        
        .attendance-status.leave {
            background: #fff3cd;
            color: #856404;
        }
        
        .attendance-status.late {
            background: #ffeaa7;
            color: #6c4a00;
        }
        
        /* Chart Container */
        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-placeholder {
            width: 100%;
            height: 300px;
            background: #f8f9fa;
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 16px;
        }

        /* Modern User Modal Styles */
        .modern-modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modern-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 32px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .modern-modal-title {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 0;
        }

        .modern-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modern-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .modern-modal-body {
            padding: 32px;
            overflow-y: auto;
            flex: 1;
        }

        .modern-progress-bar {
            background: #f0f2f5;
            height: 6px;
            border-radius: 3px;
            margin-bottom: 32px;
            overflow: hidden;
        }

        .modern-progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 45%;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .modern-form-sections {
            display: grid;
            gap: 24px;
        }

        .modern-form-section {
            background: #fafbfc;
            border: 1px solid #e4e6ea;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
            animation: slideUp 0.3s ease;
        }

        .modern-form-section:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .modern-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e4e6ea;
        }

        .modern-section-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }

        .modern-section-icon.personal { background: linear-gradient(135deg, #667eea, #764ba2); }
        .modern-section-icon.contact { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .modern-section-icon.professional { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .modern-section-icon.documents { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .modern-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .modern-section-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-top: 2px;
        }

        .modern-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .modern-form-group {
            display: flex;
            flex-direction: column;
        }

        .modern-form-group.modern-full-width {
            grid-column: 1 / -1;
        }

        .modern-form-label {
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modern-required {
            color: #ef4444;
        }

        .modern-form-input {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .modern-form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modern-form-input:disabled {
            background: #f9fafb;
            color: #9ca3af;
            border-color: #d1d5db;
            cursor: not-allowed;
        }

        .modern-form-select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            cursor: pointer;
        }

        .modern-form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modern-form-textarea {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
            resize: vertical;
            min-height: 80px;
        }

        .modern-form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modern-password-field {
            position: relative;
        }

        .modern-password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #6b7280;
            padding: 4px;
        }

        .modern-help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .modern-field-connected {
            position: relative;
        }

        .modern-field-connected::after {
            content: 'üîó';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #10b981;
            color: white;
            font-size: 12px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modern-modal-footer {
            padding: 24px 32px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            border-radius: 0 0 16px 16px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            flex-shrink: 0;
        }

        .modern-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .modern-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .modern-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .modern-btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .modern-btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Responsive Design for Modern Modal */
        @media (max-width: 768px) {
            .modern-modal {
                margin: 10px;
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 20px);
            }
            
            .modern-modal-header, .modern-modal-body, .modern-modal-footer {
                padding: 20px;
            }
            
            .modern-form-grid {
                grid-template-columns: 1fr;
            }
            
            .modern-modal-footer {
                flex-direction: column;
                gap: 12px;
                position: sticky;
                bottom: 0;
            }
        }

        /* Animation */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           COMPREHENSIVE RESPONSIVE DESIGN SYSTEM
           ============================================ */

        /* Responsive Typography - DISABLED to prevent button size changes */
        html {
            font-size: 16px; /* Keep consistent base font size across all devices */
        }

        /* Responsive Container System */
        .responsive-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        @media (min-width: 1400px) {
            .responsive-container {
                max-width: 1320px;
            }
        }

        /* Responsive Grid System */
        .responsive-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 576px) {
            .responsive-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
        }

        @media (min-width: 768px) {
            .responsive-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
            .responsive-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
        }

        @media (min-width: 992px) {
            .responsive-grid.cols-5 { grid-template-columns: repeat(5, 1fr); }
            .responsive-grid.cols-6 { grid-template-columns: repeat(6, 1fr); }
        }

        /* Responsive Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .table-responsive table {
                min-width: 600px;
            }
            
            .table-responsive th,
            .table-responsive td {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
        }

        /* Mobile-First Table Cards */
        @media (max-width: 576px) {
            .mobile-card-table {
                display: none;
            }
            
            .mobile-card-view {
                display: block;
            }
            
            .mobile-card {
                background: white;
                border-radius: 8px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }

        @media (min-width: 577px) {
            .mobile-card-view {
                display: none;
            }
        }

        /* Responsive Forms */
        .form-responsive {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .form-responsive.form-cols-2 {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-responsive.form-cols-3 {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
            }
            
            .form-full-width {
                grid-column: 1 / -1;
            }
        }

        /* Responsive Input Sizing - DISABLED to prevent layout issues */
        /* No automatic input resizing - inputs keep their original styles */

        /* Responsive Buttons - DISABLE all automatic responsive button styling */
        .btn {
            touch-action: manipulation;
        }

        /* NO responsive button styling by default - buttons keep their original sizes */
        @media (max-width: 768px) {
            .btn-group {
                display: flex;
                gap: 0.5rem;
            }
        }

        /* Responsive Modal System */
        .modal {
            padding: 1rem;
        }

        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        @media (min-width: 576px) {
            .modal-content {
                max-width: 540px;
            }
        }

        @media (min-width: 768px) {
            .modal-content {
                max-width: 720px;
            }
        }

        @media (min-width: 992px) {
            .modal-content {
                max-width: 900px;
            }
        }

        /* Responsive Navigation */
        .nav-responsive {
            display: flex;
            flex-direction: column;
        }

        @media (min-width: 768px) {
            .nav-responsive {
                flex-direction: row;
            }
        }

        /* Touch-Friendly Interactions */
        @media (hover: none) and (pointer: coarse) {
            .btn, .nav-item, .table-row:hover {
                background-color: initial;
            }
            
            .btn:active, .nav-item:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }

        /* Hide/Show Elements by Screen Size */
        .hide-mobile {
            display: block;
        }

        .show-mobile {
            display: none;
        }

        @media (max-width: 768px) {
            .hide-mobile {
                display: none;
            }
            
            .show-mobile {
                display: block;
            }
        }

        .hide-tablet {
            display: block;
        }

        .show-tablet {
            display: none;
        }

        @media (max-width: 992px) and (min-width: 769px) {
            .hide-tablet {
                display: none;
            }
            
            .show-tablet {
                display: block;
            }
        }

        .hide-desktop {
            display: block;
        }

        .show-desktop {
            display: none;
        }

        @media (min-width: 993px) {
            .hide-desktop {
                display: none;
            }
            
            .show-desktop {
                display: block;
            }
        }

        /* Responsive Spacing */
        .spacing-responsive {
            padding: 0.5rem;
            margin: 0.5rem;
        }

        @media (min-width: 576px) {
            .spacing-responsive {
                padding: 1rem;
                margin: 1rem;
            }
        }

        @media (min-width: 768px) {
            .spacing-responsive {
                padding: 1.5rem;
                margin: 1.5rem;
            }
        }

        @media (min-width: 992px) {
            .spacing-responsive {
                padding: 2rem;
                margin: 2rem;
            }
        }

        /* Responsive Dashboard Cards */
        .dashboard-cards {
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 576px) {
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 992px) {
            .dashboard-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .dashboard-cards {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Responsive Header/Footer */
        .header-responsive {
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        @media (min-width: 768px) {
            .header-responsive {
                flex-direction: row;
                justify-content: space-between;
                text-align: left;
            }
        }

        /* Landscape Mobile Adjustments */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            .modal-content {
                max-height: 80vh;
            }
            
            /* DISABLED: Don't hide sidebar in landscape mode */
            /* .sidebar {
                transform: translateX(-100%);
            } */
            
            .main-content {
                /* Keep sidebar visible */
                margin-left: 250px;
            }
        }

        /* High DPI Displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 2dppx) {
            .logo, .icon {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            .auto-theme {
                background-color: #1a1a1a;
                color: #ffffff;
            }
            
            .auto-theme input,
            .auto-theme select,
            .auto-theme textarea {
                background-color: #2d2d2d;
                color: #ffffff;
                border-color: #404040;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            body {
                font-size: 12pt !important;
                line-height: 1.4 !important;
            }
            
            .container {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
        }
        
        /* =================================================================
           REAL-TIME ADMIN FEATURES STYLES
           ================================================================= */
        
        /* Admin Notification Styles */
        .admin-notifications-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
        }
        
        .admin-notification {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            overflow: hidden;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid #2196f3;
        }
        
        .admin-notification.info {
            border-left-color: #2196f3;
        }
        
        .admin-notification.success {
            border-left-color: #4caf50;
        }
        
        .admin-notification.warning {
            border-left-color: #ff9800;
        }
        
        .admin-notification.error {
            border-left-color: #f44336;
        }
        
        .notification-header {
            padding: 12px 15px 8px 15px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            font-weight: 600;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover {
            color: #333;
        }
        
        .notification-message {
            padding: 8px 15px;
            font-size: 13px;
            line-height: 1.4;
            color: #333;
        }
        
        .notification-time {
            padding: 8px 15px 12px 15px;
            font-size: 11px;
            color: #666;
            font-style: italic;
        }
        
        /* Real-time Status Indicators */
        .system-health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .system-health-indicator.healthy {
            background-color: #4caf50;
            animation: pulse-green 2s infinite;
        }
        
        .system-health-indicator.error {
            background-color: #f44336;
            animation: pulse-red 2s infinite;
        }
        
        .updated-highlight {
            background-color: rgba(76, 175, 80, 0.1);
            transition: background-color 0.3s ease;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .pulse-animation {
            animation: pulse 1s infinite;
        }
        
        .error-count-badge {
            background: #f44336;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
            margin-left: 5px;
        }
        
        .notification-badge {
            background: #ff9800;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: none;
            margin-left: 5px;
        }
        
        .online-status {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            display: inline-block;
            margin-left: 5px;
        }
        
        .online-status.online {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
        }
        
        .online-status.offline {
            background: rgba(158, 158, 158, 0.1);
            color: #616161;
        }
        
        /* Animation Keyframes */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }
        
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }
            70% {
                box-shadow: 0 0 0 8px rgba(244, 67, 54, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }
        
        /* Real-time Stats Display */
        .real-time-stats {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .stat-item {
            text-align: center;
            flex: 1;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2196f3;
            display: block;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        
        .last-update-time {
            font-size: 11px;
            color: #999;
            font-style: italic;
        }
    </style>
    
    <!-- Pikaday CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css">
    
    <!-- Flatpickr CSS for Google Calendar style date picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    
    <!-- API Service for database integration -->
    <script src="api-service.js"></script>
</head>
<body>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileMenu()"></div>

    <!-- Role Selection Page -->
    <div class="login-container role-selection" id="roleSelection">
        <img src="logo.jpeg" alt="CBA Logo" class="logo">
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab(0)">Administrator</button>
            <button class="tab" onclick="switchTab(1)">User</button>
        </div>
        
        <div class="tab-content" id="adminTab">
            <form onsubmit="loginAdmin(event)">
                <div class="form-group">
                    <label for="adminUsername">Username</label>
                    <input type="text" id="adminUsername" name="adminUsername" required placeholder="Enter Username">
                </div>
                
                <div class="form-group">
                    <label for="adminPassword">Password</label>
                    <input type="password" id="adminPassword" name="adminPassword" required placeholder="Enter Password">
                    <div class="error-message" id="adminError"></div>
                    <div class="success-message" id="adminSuccess"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
            </form>
            
            <div class="demo-info" style="margin-top: 20px; padding: 15px; background: #444; border-radius: 8px; color: #ccc; font-size: 14px;">
                <strong>Admin Credentials:</strong><br>
                Username: superadmin<br>
                Password: admin123
            </div>
        </div>
        
        <div class="tab-content" id="userTab" style="display: none;">
            <form onsubmit="loginUser(event)">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required placeholder="Enter Username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter Password">
                    <div class="error-message" id="error"></div>
                    <div class="success-message" id="success"></div>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Submit</button>
            </form>
            
            <div class="demo-info" style="margin-top: 20px; padding: 15px; background: #444; border-radius: 8px; color: #ccc; font-size: 14px;">
                <strong>Note:</strong><br>
                No users exist yet. Please contact the administrator to create your account.
            </div>
        </div>
    </div>

    
    <!-- User Dashboard -->
    <div class="dashboard" id="dashboard" style="display: none;">
        <!-- Portal Header -->
        <div class="portal-header">
            <div class="header-left" style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
                <img src="logo.jpeg" alt="CBA Logo" class="portal-logo">
                <h1 style="color: #1976d2; font-size: 24px; font-weight: 600;">Cantonment Board <span style="color: #ff6b6b;">Ambala</span></h1>
            </div>
            <div class="user-section">
                <div class="notification-icons">
                    <button class="icon-btn" title="Messages (Disabled)" disabled>
                        üìß
                    </button>
                    <button class="icon-btn notification" title="Notifications" onclick="showNotifications()">
                        üîî
                    </button>
                </div>
                <div class="user-profile" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="userAvatar">
                        U
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">User</div>
                        <div class="user-role" id="userRole">Staff Member</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Body -->
        <div class="dashboard-body">
            <!-- Sidebar Navigation -->
            <nav class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Control Panel</h3>
                </div>
                <div class="nav-menu">
                    <button class="nav-item active" onclick="showSection('dashboard')">
                        <span class="nav-icon">‚óâ</span>
                        <span class="nav-text">Dashboard</span>
                    </button>
                    <button class="nav-item" onclick="showSection('designations')">
                        <span class="nav-icon">‚óà</span>
                        <span class="nav-text">Designations</span>
                    </button>
                    <button class="nav-item" onclick="showSection('codes')">
                        <span class="nav-icon">‚óé</span>
                        <span class="nav-text">Codes</span>
                    </button>
                    <button class="nav-item" onclick="showSection('leave')">
                        <span class="nav-icon">üìÖ</span>
                        <span class="nav-text">Leave Management</span>
                    </button>
                    <button class="nav-item" onclick="showSection('attendance')">
                        <span class="nav-icon">‚úîÔ∏è</span>
                        <span class="nav-text">Attendance</span>
                    </button>
                    <button class="nav-item" onclick="showSection('ps-verification')">
                        <span class="nav-icon">üìã</span>
                        <span class="nav-text">PS Verification</span>
                    </button>
                    <button class="nav-item" onclick="showSection('deduction-balance')">
                        <span class="nav-icon">üìä</span>
                        <span class="nav-text">Deduction Balance Overview</span>
                    </button>
                    <button class="nav-item" onclick="showSection('payslip')">
                        <span class="nav-icon">üí∞</span>
                        <span class="nav-text">Pay Slip</span>
                    </button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                
                <div class="content" id="content">
                    <!-- Content will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- Administrator Dashboard -->
    <div class="dashboard admin-panel" id="adminDashboard" style="display: none;">
        <!-- Portal Header -->
        <div class="portal-header">
            <div class="header-left" style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
                <img src="logo.jpeg" alt="CBA Logo" class="portal-logo">
                <h1 style="color: #1976d2; font-size: 24px; font-weight: 600;">Cantonment Board <span style="color: #ff6b6b;">Ambala</span> Admin</h1>
            </div>
            <div class="user-section">
                <div class="notification-icons">
                    <button class="icon-btn" title="Messages (Disabled)" disabled>
                        üìß
                    </button>
                    <button class="icon-btn notification disabled" title="Notifications (Disabled)" disabled style="opacity: 0.5; cursor: not-allowed;">
                        üîî
                    </button>
                </div>
                <div class="user-profile" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="adminAvatar">
                        SA
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="adminName">Super Admin</div>
                        <div class="user-role" id="adminRole">Administrator</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Body -->
        <div class="dashboard-body">
            <!-- Sidebar Navigation -->
            <nav class="sidebar" id="adminSidebar">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Admin Navigation</h3>
                </div>
                <div class="nav-menu">
                    <button class="nav-item active" onclick="showAdminSection('users')">
                        <span class="nav-icon">‚óì</span>
                        <span class="nav-text">User Management</span>
                    </button>
                    <button class="nav-item" onclick="showAdminSection('logs')">
                        <span class="nav-icon">‚óê</span>
                        <span class="nav-text">User Logs</span>
                    </button>
                    <button class="nav-item" onclick="showAdminSection('designations')" style="display: none;">
                        <span class="nav-icon">‚óà</span>
                        <span class="nav-text">Designations</span>
                    </button>
                    <button class="nav-item" onclick="showAdminSection('system')">
                        <span class="nav-icon">‚óé</span>
                        <span class="nav-text">System Settings</span>
                    </button>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="main-content">
                <div class="content" id="adminContent">
                    <!-- Admin content will be loaded here -->
                </div>
            </main>
        </div>
    </div>

    <!-- New Admission Modal with 23 fields -->
    <div id="admissionModal" class="modal professional-header">
        <div class="modal-content">
            <span class="close" onclick="closeModal('admissionModal')">&times;</span>
            <h2 id="admissionModalTitle">New Staff Details</h2>
            
            <!-- Professional Modal Header -->
            <div class="admission-modal-header">
                <div class="admission-modal-header-content">
                    <h2 class="admission-modal-title" id="admissionProfessionalTitle">New Staff Details</h2>
                    <p class="admission-modal-subtitle" id="admissionProfessionalSubtitle">Enter the complete information for the new staff member</p>
                </div>
                <button class="admission-close-btn" onclick="closeModal('admissionModal')">&times;</button>
            </div>
            
            <!-- Scrollable Content Area -->
            <div class="modal-scrollable-content">
            
            <!-- Progress Indicator -->
            <div class="admission-progress-indicator" id="admissionProgressIndicator" style="display: none;">
                <div class="admission-progress-step">
                    <div class="admission-step-circle active" id="admissionStep1">1</div>
                    <span class="admission-step-label">Staff Information</span>
                </div>
                <div class="admission-step-connector" id="admissionConnector1"></div>
                <div class="admission-progress-step">
                    <div class="admission-step-circle" id="admissionStep2">2</div>
                    <span class="admission-step-label">Salary Structure</span>
                </div>
            </div>
            
            <form id="admissionForm" onsubmit="saveAdmission(event)">
                <input type="hidden" id="admissionId">
                
                <!-- Step 1: Staff Information (All existing fields) -->
                <div id="admissionStepContent1" class="admission-step-content active">
                
                <!-- Basic Information Section -->
                <div class="form-section">
                    <div class="form-section-title">Basic Information</div>
                    <div style="display: grid; grid-template-columns: 1fr 200px; gap: 30px; align-items: start;">
                        <div style="display: flex; flex-direction: column; gap: 20px; height: 100%;">
                            <div class="form-group">
                                <label for="staffId">Staff ID No. *</label>
                                <input type="text" id="staffId" required placeholder="Enter staff ID" oninput="validateStaffIdInput(this)">
                            </div>
                            <div class="form-group">
                                <label for="designation">Designation *</label>
                                <div class="field-with-button" style="display: flex; gap: 10px; align-items: flex-end;">
                                    <select id="designation" required style="flex: 1;">
                                        <option value="">Select Designation</option>
                                        <option value="Safai Karamchari">Safai Karamchari</option>
                                        <option value="Accounts Officer">Accounts Officer</option>
                                        <option value="Store Keeper">Store Keeper</option>
                                        <option value="Clerk">Clerk</option>
                                    </select>
                                    <button type="button" class="add-btn" onclick="addNewDesignation()">Add New</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="staffName">Staff Name *</label>
                                <input type="text" id="staffName" required placeholder="Enter full name">
                            </div>
                        </div>
                        <div class="photo-section">
                            <div class="form-section-title" style="margin-bottom: 15px; font-size: 14px;">Staff Photo</div>
                            <div class="photo-container">
                                <div class="photo-preview" id="photoPreview">
                                    <div class="photo-placeholder" id="photoPlaceholder">
                                        <span style="font-size: 48px;">üì∑</span>
                                        <div>Upload Photo</div>
                                    </div>
                                </div>
                                <div class="photo-actions">
                                    <button type="button" class="photo-btn photo-btn-upload" onclick="openFileUpload()">
                                        üìÅ Upload
                                    </button>
                                    <button type="button" class="photo-btn photo-btn-camera" onclick="openCamera()">
                                        üì∏ Camera
                                    </button>
                                    <button type="button" class="photo-btn photo-btn-remove" onclick="removePhoto()" style="display: none;" id="removePhotoBtn">
                                        üóëÔ∏è Remove
                                    </button>
                                </div>
                                <input type="file" id="photoInput" class="photo-input" accept="image/*" onchange="handleFileUpload(event)">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">Personal Details</div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="dateOfBirth">Date of Birth *</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="dateOfBirth" class="google-calendar-input" required placeholder="Select date" 
                                       readonly
                                       title="Click to select date">
                                <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="age">Age</label>
                            <input type="text" id="age" readonly placeholder="Auto-calculated" style="background: #f8f9fa; color: #000 !important; font-weight: bold; padding: 12px; border: 1px solid #ddd; border-radius: 8px; height: 45px;">
                        </div>
                        <div class="form-group">
                            <label for="sex">Sex *</label>
                            <select id="sex" required>
                                <option value="">Select Sex</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Kinner">Kinner</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="field-with-button">
                            <div class="form-group">
                                <label for="nationality">Nationality *</label>
                                <select id="nationality" required>
                                    <option value="">Select Nationality</option>
                                    <option value="Indian">Indian</option>
                                    <option value="Nepali">Nepali</option>
                                </select>
                            </div>
                            <button type="button" class="add-btn" onclick="addNewNationality()">Add New</button>
                        </div>
                    </div>
                </div>

                <!-- Family Information Section -->
                <div class="form-section">
                    <div class="form-section-title">Family Information</div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="fatherName">Father Name *</label>
                            <input type="text" id="fatherName" required placeholder="Enter father's name">
                        </div>
                        <div class="form-group">
                            <label for="motherName">Mother Name *</label>
                            <input type="text" id="motherName" required placeholder="Enter mother's name">
                        </div>
                        <div class="form-group">
                            <label for="grandFatherName">Grand Father Name *</label>
                            <input type="text" id="grandFatherName" required placeholder="Enter grandfather's name">
                        </div>
                        <div class="form-group">
                            <label for="maritalStatus">Marital Status *</label>
                            <select id="maritalStatus" required>
                                <option value="">Select Status</option>
                                <option value="Un-Married">Un-Married</option>
                                <option value="Married">Married</option>
                                <option value="Divorced">Divorced</option>
                                <option value="Widow">Widow</option>
                                <option value="Widower">Widower</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="spouseName">Spouse Name</label>
                        <input type="text" id="spouseName" placeholder="Enter spouse name">
                    </div>
                    <div class="form-group">
                        <label>Children</label>
                        <div id="childrenList" style="margin-bottom: 10px;">
                            <div class="empty-children-message" style="color: #666; font-style: italic; margin-bottom: 10px;">No children added yet</div>
                        </div>
                        <button type="button" id="addChildButton" class="btn btn-secondary" onclick="openAddChildModal()" disabled style="opacity: 0.5; cursor: not-allowed;">Add Child</button>
                    </div>
                </div>

                <!-- Employment Information Section -->
                <div class="form-section">
                    <div class="form-section-title">Employment Information</div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="dateOfAppointment">Date of Appointment *</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="dateOfAppointment" class="google-calendar-input" required placeholder="Select date" 
                                       readonly disabled
                                       title="Fill Date of Birth first" style="opacity: 0.5; cursor: not-allowed; background-color: #f8f9fa;">
                                <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div id="dateOfAppointmentError" class="field-error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 4px;">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="retirementDate">Retirement Date *</label>
                            <input type="text" id="retirementDate" readonly placeholder="Auto-calculated" 
                                   title="Auto-calculated from date of birth"
                                   style="background: #f8f9fa; color: #000 !important; font-weight: bold; padding: 12px; border: 1px solid #ddd; border-radius: 8px; height: 45px;">
                        </div>
                        <div class="form-group">
                            <label for="functionCode">Function Code *</label>
                            <div class="field-with-button" style="display: flex; gap: 10px; align-items: flex-end;">
                                <select id="functionCode" required style="flex: 1;">
                                    <option value="">Select Function Code</option>
                                </select>
                                <button type="button" class="add-btn" onclick="addNewFunctionCode()">Add New</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="objectCode">Object Code *</label>
                            <div class="field-with-button" style="display: flex; gap: 10px; align-items: flex-end;">
                                <select id="objectCode" required style="flex: 1;">
                                    <option value="">Select Object Code</option>
                                </select>
                                <button type="button" class="add-btn" onclick="addNewObjectCode()">Add New</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="dateOfNextIncrement">Date of Next Increment *</label>
                            <div class="date-input-wrapper">
                                <input type="text" id="dateOfNextIncrement" class="google-calendar-input" required placeholder="Select date" 
                                       readonly disabled
                                       title="Fill Date of Appointment first" style="opacity: 0.5; cursor: not-allowed; background-color: #f8f9fa;">
                                <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div id="dateOfNextIncrementError" class="field-error-message" style="display: none; color: #dc3545; font-size: 12px; margin-top: 4px;">Invalid date</div>
                        </div>
                        <div class="form-group">
                            <label for="pensionScheme">Pension Scheme *</label>
                            <select id="pensionScheme" required>
                                <option value="">Select Scheme</option>
                                <option value="NPS">NPS</option>
                                <option value="DPS">DPS</option>
                                <option value="UPS">UPS</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Contact & Documents Section -->
                <div class="form-section">
                    <div class="form-section-title">Contact & Documents</div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="mobileNumber">Mobile Number *</label>
                            <input type="tel" id="mobileNumber" required placeholder="Enter 10-digit mobile number" maxlength="10">
                            <div id="mobileNumberError" style="color: #dc3545; font-size: 12px; margin-top: 4px; display: none;"></div>
                        </div>
                        <div class="form-group">
                            <label for="aadharNumber">Aadhar Number</label>
                            <input type="text" id="aadharNumber" placeholder="1234 5678 9012" maxlength="14">
                        </div>
                        <div class="form-group">
                            <label for="panNumber">P.A.N Number</label>
                            <input type="text" id="panNumber" placeholder="ABCDE1234F" maxlength="10">
                        </div>
                    </div>
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="permanentAddress">Permanent Address *</label>
                            <textarea id="permanentAddress" rows="3" required placeholder="Enter permanent address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="communicationAddress">Communication Address *</label>
                            <textarea id="communicationAddress" rows="3" required placeholder="Enter communication address"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="remarks">Remarks</label>
                        <textarea id="remarks" rows="2" placeholder="Enter any remarks"></textarea>
                    </div>
                </div>

                <!-- Bank Details Section -->
                <div class="form-section">
                    <div class="form-section-title">Bank Details</div>
                    <div class="form-grid-3">
                        <div class="form-group">
                            <label for="bankName">Bank Name</label>
                            <select id="bankName">
                                <option value="">Select Bank</option>
                                <option value="State Bank of India">State Bank of India</option>
                                <option value="HDFC Bank">HDFC Bank</option>
                                <option value="ICICI Bank">ICICI Bank</option>
                                <option value="Axis Bank">Axis Bank</option>
                                <option value="Kotak Mahindra Bank">Kotak Mahindra Bank</option>
                                <option value="IndusInd Bank">IndusInd Bank</option>
                                <option value="Yes Bank">Yes Bank</option>
                                <option value="IDFC First Bank">IDFC First Bank</option>
                                <option value="Federal Bank">Federal Bank</option>
                                <option value="RBL Bank">RBL Bank</option>
                                <option value="South Indian Bank">South Indian Bank</option>
                                <option value="Karnataka Bank">Karnataka Bank</option>
                                <option value="Punjab National Bank">Punjab National Bank</option>
                                <option value="Bank of Baroda">Bank of Baroda</option>
                                <option value="Canara Bank">Canara Bank</option>
                                <option value="Union Bank of India">Union Bank of India</option>
                                <option value="Bank of India">Bank of India</option>
                                <option value="Central Bank of India">Central Bank of India</option>
                                <option value="Indian Bank">Indian Bank</option>
                                <option value="Indian Overseas Bank">Indian Overseas Bank</option>
                                <option value="Punjab & Sind Bank">Punjab & Sind Bank</option>
                                <option value="UCO Bank">UCO Bank</option>
                                <option value="Bank of Maharashtra">Bank of Maharashtra</option>
                                <option value="IDBI Bank">IDBI Bank</option>
                                <option value="Bandhan Bank">Bandhan Bank</option>
                                <option value="City Union Bank">City Union Bank</option>
                                <option value="DCB Bank">DCB Bank</option>
                                <option value="Dhanlaxmi Bank">Dhanlaxmi Bank</option>
                                <option value="ESAF Small Finance Bank">ESAF Small Finance Bank</option>
                                <option value="Equitas Small Finance Bank">Equitas Small Finance Bank</option>
                                <option value="Jammu & Kashmir Bank">Jammu & Kashmir Bank</option>
                                <option value="Karur Vysya Bank">Karur Vysya Bank</option>
                                <option value="Lakshmi Vilas Bank">Lakshmi Vilas Bank</option>
                                <option value="Nainital Bank">Nainital Bank</option>
                                <option value="Tamilnad Mercantile Bank">Tamilnad Mercantile Bank</option>
                                <option value="AU Small Finance Bank">AU Small Finance Bank</option>
                                <option value="Capital Small Finance Bank">Capital Small Finance Bank</option>
                                <option value="Fincare Small Finance Bank">Fincare Small Finance Bank</option>
                                <option value="Jana Small Finance Bank">Jana Small Finance Bank</option>
                                <option value="North East Small Finance Bank">North East Small Finance Bank</option>
                                <option value="Suryoday Small Finance Bank">Suryoday Small Finance Bank</option>
                                <option value="Ujjivan Small Finance Bank">Ujjivan Small Finance Bank</option>
                                <option value="Utkarsh Small Finance Bank">Utkarsh Small Finance Bank</option>
                                <option value="Paytm Payments Bank">Paytm Payments Bank</option>
                                <option value="Fino Payments Bank">Fino Payments Bank</option>
                                <option value="Airtel Payments Bank">Airtel Payments Bank</option>
                                <option value="India Post Payments Bank">India Post Payments Bank</option>
                                <option value="Jio Payments Bank">Jio Payments Bank</option>
                                <option value="NSDL Payments Bank">NSDL Payments Bank</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="accountNumber">Account Number</label>
                            <input type="text" id="accountNumber" placeholder="Enter account number" minlength="9" maxlength="17">
                        </div>
                        <div class="form-group">
                            <label for="ifscCode">IFSC Code</label>
                            <input type="text" id="ifscCode" placeholder="Enter IFSC code" minlength="10" maxlength="15">
                        </div>
                        <div class="form-group">
                            <label for="micrCode">MICR Code</label>
                            <input type="text" id="micrCode" placeholder="Enter MICR code" maxlength="9" oninput="validateNumericInput(this)">
                        </div>
                    </div>
                </div>

                <!-- Salary Structure Section (for editing existing staff) -->
                <div class="form-section" id="editSalarySection" style="display: none;">
                    <div class="form-section-title">üí∞ Salary Structure</div>
                    <div class="salary-inputs">
                        <div class="salary-group">
                            <label for="daEdit">DA (Dearness Allowance)</label>
                            <input type="number" id="daEdit" placeholder="0" min="0" max="100" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                            <span class="percentage-symbol">%</span>
                            <p class="help-text">Percentage of Basic Pay</p>
                        </div>

                        <div class="salary-group">
                            <label for="hraEdit">HRA (House Rent Allowance)</label>
                            <input type="number" id="hraEdit" placeholder="0" min="0" max="100" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                            <span class="percentage-symbol">%</span>
                            <p class="help-text">Percentage of Basic Pay</p>
                        </div>

                        <div class="salary-group">
                            <label for="specialPayEdit">Special Pay</label>
                            <input type="number" id="specialPayEdit" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                            <span class="currency-symbol">‚Çπ</span>
                        </div>

                        <div class="salary-group">
                            <label for="specialAllowanceEdit">Special Allowance</label>
                            <input type="number" id="specialAllowanceEdit" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                            <span class="currency-symbol">‚Çπ</span>
                        </div>

                        <div class="salary-group">
                            <label for="otherAllowanceEdit">Other Allowance</label>
                            <input type="number" id="otherAllowanceEdit" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');">
                            <span class="currency-symbol">‚Çπ</span>
                        </div>
                    </div>
                </div>

                <!-- Contact & Documents Section (continued) -->
                <div class="form-section">
                    <!-- Document Upload Section -->
                    <div class="documents-section">
                        <div class="form-section-title" style="margin-bottom: 15px; font-size: 14px; color: #ff9800;">Supporting Documents</div>
                        <div class="documents-container">
                            <div class="document-upload-area" id="documentUploadArea" onclick="openDocumentUpload()" ondrop="handleDocumentDrop(event)" ondragover="handleDocumentDragOver(event)" ondragleave="handleDocumentDragLeave(event)">
                                <div class="upload-icon">üìÑ</div>
                                <div class="upload-text">
                                    <strong>Upload Documents</strong><br>
                                    Drag & drop files here or click to browse<br>
                                    <small>Supports: PDF, DOC, DOCX, JPG, PNG (Max 10MB each)</small>
                                </div>
                                <button type="button" class="upload-btn">
                                    üìÅ Select Files
                                </button>
                                <input type="file" id="documentInput" class="document-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" onchange="handleDocumentUpload(event)">
                            </div>
                            <div class="document-list" id="documentList" style="display: none;">
                                <!-- Uploaded documents will appear here -->
                            </div>
                            <div class="document-count" id="documentCount"></div>
                        </div>
                    </div>
                </div>
                
                </div> <!-- End Step 1 -->
                
                <!-- Step 2: Salary Structure -->
                <div id="admissionStepContent2" class="admission-step-content">
                    <div class="info-box">
                        <span class="info-box-icon">‚ÑπÔ∏è</span>
                        <span class="info-box-text">Configure the salary structure for this employee. DA and HRA are calculated as percentages of Pay Band.</span>
                    </div>

                    <div class="salary-structure-card">
                        <div class="salary-card-header">
                            <div class="salary-card-icon">üí∞</div>
                            <div class="salary-card-title">
                                <h3>Salary Structure</h3>
                                <p>Define the compensation components for this employee</p>
                            </div>
                        </div>

                        <div class="salary-inputs">
                            <div class="salary-group">
                                <label for="basicPay">Pay Band *</label>
                                <select id="basicPay" required onchange="handlePayBandChange(window.isPopulatingEditForm)">
                                    <option value="">Select Pay Band</option>
                                    <option value="5200-20200">Pay Band-1(5200-20200)</option>
                                    <option value="9300-34800">Pay Band-2(9300-34800)</option>
                                    <option value="15600-39100">Pay Band-3(15600-39100)</option>
                                    <option value="37400-67000">Pay Band-4(37400-67000)</option>
                                </select>
                            </div>

                            <div class="salary-group">
                                <label for="gradePay">Grade Pay *</label>
                                <select id="gradePay" required>
                                    <option value="">Select Grade Pay</option>
                                    <option value="1800">1800</option>
                                    <option value="2400">2400</option>
                                    <option value="3200">3200</option>
                                    <option value="3600">3600</option>
                                    <option value="4000">4000</option>
                                    <option value="4200">4200</option>
                                    <option value="4600">4600</option>
                                    <option value="4800">4800</option>
                                    <option value="5400">5400</option>
                                    <option value="6000">6000</option>
                                    <option value="6400">6400</option>
                                    <option value="7600">7600</option>
                                    <option value="8000">8000</option>
                                    <option value="8700">8700</option>
                                    <option value="8800">8800</option>
                                    <option value="9500">9500</option>
                                    <option value="9800">9800</option>
                                    <option value="10000">10000</option>
                                    <option value="12000">12000</option>
                                </select>
                            </div>

                            <div class="salary-group">
                                <label for="payLevel">Pay Level *</label>
                                <select id="payLevel" required onchange="handlePayLevelChange()" disabled>
                                    <option value="">Select Pay Level</option>
                                    <option value="1">Level 1</option>
                                    <option value="2">Level 2</option>
                                    <option value="3">Level 3</option>
                                    <option value="4">Level 4</option>
                                    <option value="5">Level 5</option>
                                    <option value="6">Level 6</option>
                                    <option value="7">Level 7</option>
                                    <option value="8">Level 8</option>
                                    <option value="9">Level 9</option>
                                    <option value="10">Level 10</option>
                                    <option value="11">Level 11</option>
                                    <option value="12">Level 12</option>
                                    <option value="13">Level 13</option>
                                    <option value="14">Level 14</option>
                                    <option value="15">Level 15</option>
                                    <option value="16">Level 16</option>
                                    <option value="17">Level 17</option>
                                    <option value="18">Level 18</option>
                                    <option value="19">Level 19</option>
                                    <option value="20">Level 20</option>
                                    <option value="21">Level 21</option>
                                    <option value="22">Level 22</option>
                                    <option value="23">Level 23</option>
                                    <option value="24">Level 24</option>
                                    <option value="25">Level 25</option>
                                    <option value="26">Level 26</option>
                                    <option value="27">Level 27</option>
                                    <option value="28">Level 28</option>
                                    <option value="29">Level 29</option>
                                    <option value="30">Level 30</option>
                                    <option value="31">Level 31</option>
                                    <option value="32">Level 32</option>
                                    <option value="33">Level 33</option>
                                    <option value="34">Level 34</option>
                                    <option value="35">Level 35</option>
                                    <option value="36">Level 36</option>
                                    <option value="37">Level 37</option>
                                    <option value="38">Level 38</option>
                                    <option value="39">Level 39</option>
                                    <option value="40">Level 40</option>
                                </select>
                            </div>

                            <div class="salary-group">
                                <label for="payCell">Pay Cell *</label>
                                <select id="payCell" required onchange="calculateBasicPay()" disabled>
                                    <option value="">Select Pay Cell</option>
                                </select>
                            </div>

                            <div class="salary-group">
                                <label for="basicPay">Basic Pay *</label>
                                <input type="number" id="basicPayCalculated" readonly 
                                       style="background: #f8f9fa; color: #495057; cursor: not-allowed;" 
                                       placeholder="Select Pay Band, Pay Level and Pay Cell first">
                                <p class="help-text">Auto-calculated based on Pay Level and Pay Cell selection</p>
                            </div>

                            <div class="salary-group">
                                <label for="da">DA (Dearness Allowance)</label>
                                <input type="number" id="da" placeholder="0" min="0" max="100" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); calculateSalaryComponent('da'); calculateGrossSalary();">
                                <span class="percentage-symbol">%</span>
                                <p class="help-text">Percentage of Basic Pay</p>
                                <p class="calculated-value" id="daCalculatedValue" style="color: #1976d2; font-weight: 600; margin-top: 5px; display: none;"></p>
                            </div>

                            <div class="salary-group">
                                <label for="hra">HRA (House Rent Allowance)</label>
                                <input type="number" id="hra" placeholder="0" min="0" max="100" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); calculateSalaryComponent('hra'); calculateGrossSalary();">
                                <span class="percentage-symbol">%</span>
                                <p class="help-text">Percentage of Basic Pay</p>
                                <p class="calculated-value" id="hraCalculatedValue" style="color: #1976d2; font-weight: 600; margin-top: 5px; display: none;"></p>
                            </div>

                            <div class="salary-group">
                                <label for="specialPay">Special Pay</label>
                                <input type="number" id="specialPay" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); calculateGrossSalary();">
                                <span class="currency-symbol">‚Çπ</span>
                            </div>

                            <div class="salary-group">
                                <label for="specialAllowance">Special Allowance</label>
                                <input type="number" id="specialAllowance" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); calculateGrossSalary();">
                                <span class="currency-symbol">‚Çπ</span>
                            </div>

                            <div class="salary-group">
                                <label for="otherAllowance">Other Allowance</label>
                                <input type="number" id="otherAllowance" placeholder="0" min="0" step="0.01" pattern="[0-9]*" inputmode="numeric" onkeypress="return (event.charCode !=8 && event.charCode ==0 || (event.charCode >= 48 && event.charCode <= 57))" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1'); calculateGrossSalary();">
                                <span class="currency-symbol">‚Çπ</span>
                            </div>

                            <div class="salary-group gross-salary-group">
                                <label for="grossSalary">Gross Salary</label>
                                <input type="number" id="grossSalary" placeholder="0" readonly style="background-color: #f8f9fa; color: #6c757d; cursor: not-allowed;">
                                <span class="currency-symbol">‚Çπ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <!-- End Scrollable Content Area -->
                
                <div class="modal-buttons">
                    <div class="footer-info" id="admissionFooterInfo" style="margin-right: auto;">Step 1 of 2</div>
                    <button type="button" class="btn btn-secondary" id="admissionBackBtn" style="display: none;" onclick="admissionPreviousStep()">Back</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('admissionModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" id="admissionNextBtn" onclick="admissionNextStep()">Next</button>
                    <button type="submit" class="btn btn-primary" id="admissionSaveBtn" style="display: none;">Save Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Professional Designation Modal -->
    <div id="designationModal" class="professional-modal">
        <div class="professional-modal-header">
            <div class="professional-modal-header-content">
                <div class="professional-modal-icon">üè∑Ô∏è</div>
                <h2 class="professional-modal-title" id="designationModalTitle">Add New Designation</h2>
                <p class="professional-modal-subtitle">Create and manage job designations for your organization</p>
            </div>
        </div>
        
        <form id="designationForm" onsubmit="saveDesignation(event)">
            <input type="hidden" id="designationId">
            
            <div class="professional-modal-body">
                <div class="professional-form-group">
                    <label for="designationNameInput" class="professional-form-label required">Designation Name</label>
                    <input type="text" id="designationNameInput" class="professional-form-input" required placeholder="Enter designation name (e.g., Senior Manager, Assistant Director)" style="text-transform: capitalize;"
                           pattern="[A-Za-z\s]+"
                           onkeypress="return /[a-zA-Z\s]/.test(event.key)"
                           oninput="this.value = this.value.replace(/[^a-zA-Z\s]/g, '')"
                           title="Please enter letters and spaces only">
                </div>
            </div>
            
            <div class="professional-modal-footer">
                <button type="button" class="professional-btn professional-btn-secondary" onclick="closeProfessionalModal('designationModal')">Cancel</button>
                <button type="submit" class="professional-btn professional-btn-primary">Save Designation</button>
            </div>
        </form>
    </div>

    <!-- Professional Code Modal -->
    <div id="codeModal" class="professional-modal">
        <div class="professional-modal-header">
            <button type="button" class="professional-modal-close" onclick="closeProfessionalModal('codeModal')">&times;</button>
            <div class="professional-modal-header-content">
                <div class="professional-modal-icon">üî¢</div>
                <h2 class="professional-modal-title" id="codeModalTitle">Create New Code</h2>
                <p class="professional-modal-subtitle">Define function and object codes for administrative purposes</p>
            </div>
        </div>
        
        <form id="codeForm" onsubmit="saveCode(event)">
            <input type="hidden" id="codeId">
            
            <div class="professional-modal-body">
                <div class="professional-form-group">
                    <label for="codeInput" class="professional-form-label required">Code</label>
                    <input type="text" id="codeInput" class="professional-form-input" required placeholder="Enter numeric code (e.g., 1001, 2005)" style="text-transform: none;"
                           pattern="[0-9]+" 
                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57)"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                           title="Please enter numbers only">
                </div>
                
                <div class="professional-form-group">
                    <label for="codeTypeInput" class="professional-form-label required">Type</label>
                    <select id="codeTypeInput" class="professional-form-select" required>
                        <option value="">Select code type</option>
                        <option value="Function code">Function code</option>
                        <option value="Object code">Object code</option>
                    </select>
                </div>
                
                <div class="professional-form-group">
                    <label for="codeDescriptionInput" class="professional-form-label required">Description</label>
                    <input type="text" id="codeDescriptionInput" class="professional-form-input" required placeholder="Enter detailed description of the code's purpose" style="text-transform: none;"
                           maxlength="200"
                           title="Please enter a description (letters, numbers, spaces, and basic punctuation allowed)">
                </div>
            </div>
            
            <div class="professional-modal-footer">
                <button type="button" class="professional-btn professional-btn-secondary" onclick="closeProfessionalModal('codeModal')">Cancel</button>
                <button type="submit" class="professional-btn professional-btn-primary">Save Code</button>
            </div>
        </form>
    </div>

    <!-- User Creation Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content modern-modal">
            <!-- Header -->
            <div class="modern-modal-header">
                <h2 id="userModalTitle" class="modern-modal-title">
                    <span>üë§</span>
                    Create New User
                </h2>
                <button class="modern-close-btn" onclick="closeModal('userModal')">&times;</button>
            </div>

            <!-- Body -->
            <div class="modern-modal-body">
                <!-- Progress Bar -->
                <div class="modern-progress-bar">
                    <div class="modern-progress-fill" id="userFormProgress"></div>
                </div>

                <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="userId">
                
                <div class="modern-form-sections">
                    
                    <!-- Basic Information Section -->
                    <div class="modern-form-section">
                        <div class="modern-section-header">
                            <div class="modern-section-icon personal">üë§</div>
                            <div>
                                <div class="modern-section-title">Account Information</div>
                                <div class="modern-section-subtitle">Basic login credentials and user details</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group">
                                <label class="modern-form-label">Full Name <span class="modern-required">*</span></label>
                                <input type="text" id="userFullName" class="modern-form-input" placeholder="Enter full name" required 
                                       style="text-transform: capitalize;" 
                                       pattern="[a-zA-Z\s]+" 
                                       title="Only letters and spaces are allowed"
                                       oninput="validateFullName(this)">
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Username <span class="modern-required">*</span></label>
                                <input type="text" id="userUsername" class="modern-form-input" placeholder="Enter username" required>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Password <span class="modern-required">*</span></label>
                                <input type="password" id="userPassword" class="modern-form-input" placeholder="Enter password" required>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Confirm Password <span class="modern-required">*</span></label>
                                <input type="password" id="userConfirmPassword" class="modern-form-input" placeholder="Confirm password" required>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Email</label>
                                <input type="email" id="userEmail" class="modern-form-input" placeholder="user@example.com">
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Status <span class="modern-required">*</span></label>
                                <select id="userStatus" class="modern-form-select" required>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Personal Details Section -->
                    <div class="modern-form-section" style="display: none;">
                        <div class="modern-section-header">
                            <div class="modern-section-icon personal">üéÇ</div>
                            <div>
                                <div class="modern-section-title">Personal Details</div>
                                <div class="modern-section-subtitle">Personal information and family details</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group">
                                <label class="modern-form-label">Date of Birth</label>
                                <input type="date" id="userDOB" class="modern-form-input" placeholder="DD-MM-YYYY" readonly style="cursor: pointer;">
                                <div class="modern-help-text">Click to select date (must be 18+ years old)</div>
                            </div>
                            
                            <div class="modern-form-group modern-field-connected">
                                <label class="modern-form-label">Age</label>
                                <input type="number" id="userAge" class="modern-form-input" placeholder="Auto-calculated" min="18" max="120" readonly>
                                <div class="modern-help-text">Automatically calculated from date of birth</div>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Sex</label>
                                <select id="userGender" class="modern-form-select">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Father's Name</label>
                                <input type="text" id="userFatherName" class="modern-form-input" placeholder="Enter father's name" style="text-transform: capitalize;">
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Mother's Name</label>
                                <input type="text" id="userMotherName" class="modern-form-input" placeholder="Enter mother's name" style="text-transform: capitalize;">
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Grand Father's Name</label>
                                <input type="text" id="userGrandFatherName" class="modern-form-input" placeholder="Enter grand father's name" style="text-transform: capitalize;">
                            </div>
                        </div>
                    </div>

                    <!-- Family Information Section -->
                    <div class="modern-form-section" style="display: none;">
                        <div class="modern-section-header">
                            <div class="modern-section-icon family">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                            <div>
                                <div class="modern-section-title">Family Information</div>
                                <div class="modern-section-subtitle">Marital status and family details</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group">
                                <label class="modern-form-label">Marital Status</label>
                                <select id="userMaritalStatus" class="modern-form-select" onchange="toggleSpouseField()">
                                    <option value="">Select Status</option>
                                    <option value="Un-Married">Un-Married</option>
                                    <option value="Married">Married</option>
                                    <option value="Divorced">Divorced</option>
                                    <option value="Widow">Widow</option>
                                    <option value="Widower">Widower</option>
                                </select>
                            </div>
                            
                            <div class="modern-form-group" id="spouseNameGroup" style="display: none;">
                                <label class="modern-form-label">Spouse Name</label>
                                <input type="text" id="userSpouseName" class="modern-form-input" placeholder="Enter spouse name" style="text-transform: capitalize;">
                            </div>
                        </div>
                        
                        <div class="modern-form-group modern-full-width">
                            <label class="modern-form-label">Children</label>
                            <div id="userChildrenList" class="children-list" style="margin-bottom: 10px;">
                                <div class="empty-children-message" style="color: #666; font-style: italic; margin-bottom: 10px;">No children added yet</div>
                            </div>
                            <button type="button" id="addChildButton" class="btn btn-secondary" onclick="openAddChildModal()" style="opacity: 0.5; cursor: not-allowed;" disabled title="Please select marital status first">Add Child</button>
                        </div>
                    </div>

                    <!-- Contact Details Section -->
                    <div class="modern-form-section" style="display: none;">
                        <div class="modern-section-header">
                            <div class="modern-section-icon contact">üìû</div>
                            <div>
                                <div class="modern-section-title">Contact Details</div>
                                <div class="modern-section-subtitle">Address and contact information</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group modern-full-width">
                                <label class="modern-form-label">Address</label>
                                <textarea id="userAddress" class="modern-form-textarea" placeholder="Enter full address" rows="3" style="resize: vertical;"></textarea>
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">Mobile Number</label>
                                <input type="tel" id="userMobile" class="modern-form-input" placeholder="10 digit mobile number" pattern="[0-9]{10}" maxlength="10">
                            </div>
                        </div>
                    </div>

                    <!-- Professional Details Section -->
                    <div class="modern-form-section" style="display: none;">
                        <div class="modern-section-header">
                            <div class="modern-section-icon professional">üíº</div>
                            <div>
                                <div class="modern-section-title">Professional Details</div>
                                <div class="modern-section-subtitle">Employment and designation information</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group">
                                <label class="modern-form-label">Designation</label>
                                <select id="userDesignation" class="modern-form-select">
                                    <option value="">Select Designation</option>
                                </select>
                            </div>
                            
                            <div class="modern-form-group modern-field-connected">
                                <label class="modern-form-label">Appointment Date</label>
                                <input type="date" id="userAppointmentDate" class="modern-form-input" placeholder="DD-MM-YYYY" disabled title="Please select Date of Birth first" style="cursor: not-allowed;">
                                <div class="modern-help-text">Available after selecting date of birth</div>
                            </div>
                        </div>
                    </div>

                    <!-- Documents Section -->
                    <div class="modern-form-section" style="display: none;">
                        <div class="modern-section-header">
                            <div class="modern-section-icon documents">üìÑ</div>
                            <div>
                                <div class="modern-section-title">Document Information</div>
                                <div class="modern-section-subtitle">Identity and verification documents</div>
                            </div>
                        </div>
                        
                        <div class="modern-form-grid">
                            <div class="modern-form-group">
                                <label class="modern-form-label">Aadhar Number</label>
                                <input type="text" id="userAadhar" class="modern-form-input" placeholder="12 digit Aadhar number" pattern="[0-9]{12}" maxlength="12">
                            </div>
                            
                            <div class="modern-form-group">
                                <label class="modern-form-label">PAN Number</label>
                                <input type="text" id="userPAN" class="modern-form-input" placeholder="e.g. ABCDE1234F" maxlength="10" style="text-transform: uppercase;">
                            </div>
                        </div>
                    </div>

                    <!-- Permissions Section -->
                    <div class="modern-form-section">
                        <div class="modern-section-header">
                            <div class="modern-section-icon professional">üîê</div>
                            <div>
                                <div class="modern-section-title">User Rights & Permissions</div>
                                <div class="modern-section-subtitle">System access and permission settings</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="section-title">
                                üîê User Rights/Permissions <span class="required">*</span>
                            </label>
                    
                    <div class="permissions-container">
                        <!-- Dashboard Tab -->
                        <div class="tab-permission-item" data-tab="dashboard">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">‚óâ</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Dashboard</div>
                                        <div class="tab-description">Staff Management & Records</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Dashboard:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('dashboard')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('dashboard')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="dashboard" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="dashboard" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="dashboard" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Designations Tab -->
                        <div class="tab-permission-item" data-tab="designations">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">‚óà</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Designations</div>
                                        <div class="tab-description">Job Titles & Positions</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Designations:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('designations')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('designations')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="designations" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="designations" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="designations" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Codes Tab -->
                        <div class="tab-permission-item" data-tab="codes">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">‚óé</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Codes</div>
                                        <div class="tab-description">Function & Object Codes</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Codes:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('codes')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('codes')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="codes" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="codes" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="codes" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Leave Management Tab -->
                        <div class="tab-permission-item" data-tab="leave">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">üìÖ</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Leave Management</div>
                                        <div class="tab-description">Applications & Calendar</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Leave Management:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('leave')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('leave')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="leave" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="leave" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="leave" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Attendance Tab -->
                        <div class="tab-permission-item" data-tab="attendance">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">‚úîÔ∏è</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Attendance</div>
                                        <div class="tab-description">Tracking & Records</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Attendance:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('attendance')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('attendance')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="attendance" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="attendance" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="attendance" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PS Verification Tab -->
                        <div class="tab-permission-item" data-tab="ps-verification">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">üìã</div>
                                    <div class="tab-details">
                                        <div class="tab-name">PS Verification</div>
                                        <div class="tab-description">Payroll Approval & Verification</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <button type="button" class="toggle-icon" onclick="toggleTabDropdown('ps-verification', this)">‚ñº</button>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for PS Verification:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('ps-verification')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('ps-verification')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="ps-verification" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to view PS verification records and payroll details.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="ps-verification" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to approve or reject PS verification entries.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="ps-verification" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to modify verification status and manage PS records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Deduction Balance Tab -->
                        <div class="tab-permission-item" data-tab="deduction-balance">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">üìä</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Deduction Balance</div>
                                        <div class="tab-description">Balance Overview & Management</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <button type="button" class="toggle-icon" onclick="toggleTabDropdown('deduction-balance', this)">‚ñº</button>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Deduction Balance:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('deduction-balance')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('deduction-balance')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="deduction-balance" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to view deduction balances and history.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="deduction-balance" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to add new advances and deductions.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="deduction-balance" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows user to modify existing balances and process deductions.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pay Slip Tab -->
                        <div class="tab-permission-item" data-tab="payslip">
                            <div class="tab-header">
                                <div class="tab-info">
                                    <div class="tab-icon">üí∞</div>
                                    <div class="tab-details">
                                        <div class="tab-name">Pay Slip</div>
                                        <div class="tab-description">Generation & Management</div>
                                    </div>
                                </div>
                                <div class="tab-status">
                                    <span class="permissions-count empty">0</span>
                                    <span class="dropdown-arrow">‚ñº</span>
                                </div>
                            </div>
                            <div class="permissions-dropdown">
                                <div class="dropdown-title">Select permissions for Pay Slip:</div>
                                <div class="quick-actions">
                                    <button type="button" class="quick-btn select-all" onclick="selectAllPermissions('payslip')">Select All</button>
                                    <button type="button" class="quick-btn clear-all" onclick="clearAllPermissions('payslip')">Clear All</button>
                                </div>
                                <div class="permissions-grid">
                                    <div class="permission-option permission-read" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="payslip" data-permission="read">
                                            <span class="permission-label">Read Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to view or access the content. The user cannot change or delete anything.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-write" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="payslip" data-permission="write">
                                            <span class="permission-label">Write Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to add new content or save changes. The user can create new files or records but might not always be able to modify existing ones unless edit is also allowed.
                                        </div>
                                    </div>
                                    <div class="permission-option permission-edit" onclick="togglePermission(this, event)">
                                        <div class="permission-header">
                                            <input type="checkbox" class="permission-checkbox" data-tab="payslip" data-permission="edit">
                                            <span class="permission-label">Edit Permission</span>
                                        </div>
                                        <div class="permission-description">
                                            Allows a user to modify or update existing content. Includes the ability to change data, rename, or update records.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                    </div>
                
                </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="modern-modal-footer">
                <div style="color: #6b7280; font-size: 14px;">
                    <span>Required fields marked with </span><span class="modern-required">*</span>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button type="button" class="modern-btn modern-btn-secondary" onclick="closeModal('userModal')">
                        <span>‚ùå</span>
                        Cancel
                    </button>
                    <button type="submit" class="modern-btn modern-btn-primary" form="userForm">
                        <span>‚úÖ</span>
                        Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Input Modal -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 id="customModalTitle">Add New Item</h3>
            </div>
            <div class="custom-modal-body">
                <input type="text" id="customModalInput" class="custom-modal-input" placeholder="Enter value">
                <div id="customModalError" class="error-message">Invalid input</div>
            </div>
            <div class="custom-modal-buttons">
                <button type="button" class="custom-modal-btn custom-modal-btn-secondary" onclick="closeCustomModal()">Cancel</button>
                <button type="button" class="custom-modal-btn custom-modal-btn-primary" onclick="confirmCustomModal()">Add</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <div id="confirmModalIcon" class="confirm-modal-icon">‚ö†Ô∏è</div>
            <h3 id="confirmModalTitle" class="confirm-modal-title">Confirm Action</h3>
            <p id="confirmModalMessage" class="confirm-modal-message">Are you sure you want to proceed?</p>
            <div class="confirm-modal-buttons">
                <button type="button" class="confirm-btn confirm-btn-cancel" onclick="closeConfirmModal()">Cancel</button>
                <button type="button" id="confirmModalAction" class="confirm-btn confirm-btn-danger" onclick="executeConfirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Remarks Modal for Decline -->
    <div id="remarksModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3>Decline Request</h3>
            </div>
            <div class="custom-modal-body">
                <label for="declineRemarks" style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">Reason for decline (optional):</label>
                <textarea id="declineRemarks" class="custom-modal-input" placeholder="Enter reason for declining this request..." rows="4"></textarea>
            </div>
            <div class="custom-modal-buttons">
                <button type="button" class="custom-modal-btn custom-modal-btn-secondary" onclick="closeRemarksModal()">Cancel</button>
                <button type="button" class="custom-modal-btn custom-modal-btn-primary" onclick="confirmDecline()">Decline Request</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="details-modal">
        <div class="details-modal-content">
            <div class="details-modal-header">
                <h2 id="detailsModalTitle" class="details-modal-title">Admission Details</h2>
                <button class="details-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div id="detailsModalBody">
                <!-- Details content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Staff Details Modal -->
    <div id="staffDetailsModal" class="details-modal" onclick="closeStaffDetailsModal()">
        <div class="details-modal-content" style="max-width: 900px;" onclick="event.stopPropagation()">
            <div class="details-modal-header">
                <h2 id="staffDetailsModalTitle" class="details-modal-title">Staff Details</h2>
                <button class="details-close" onclick="closeStaffDetailsModal()">&times;</button>
            </div>
            <div id="staffDetailsModalBody" class="staff-details-body">
                <!-- Staff details content will be populated here -->
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-modal-content">
            <h3 style="color: #1976d2; margin-bottom: 20px;">Capture Photo</h3>
            <div class="camera-preview">
                <video id="cameraVideo" class="camera-video" autoplay muted></video>
                <canvas id="cameraCanvas" class="camera-canvas"></canvas>
            </div>
            <div class="camera-actions">
                <button type="button" class="camera-btn camera-btn-capture" onclick="capturePhoto()">
                    üì∏ Capture Photo
                </button>
                <button type="button" class="camera-btn camera-btn-cancel" onclick="closeCameraModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Pikaday JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
    
    <!-- Flatpickr JavaScript for Google Calendar style date picker -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <script>
        // Clear all overlays and modals on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, clearing overlays...');
            
            // Hide all modal overlays
            const overlays = document.querySelectorAll('.modal-overlay, .modal-backdrop');
            overlays.forEach(overlay => {
                overlay.classList.remove('show');
                overlay.style.display = 'none';
            });
            
            // Hide all modals
            const modals = document.querySelectorAll('.professional-modal, .changes-applied-modal, .save-modal, .delete-modal');
            modals.forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
            });
            
            console.log('Overlays cleared, login page should be clickable');
        });

        // Function to manually clear overlays (can be called from console)
        function clearAllOverlays() {
            console.log('Manually clearing all overlays...');
            
            // Hide all modal overlays
            const overlays = document.querySelectorAll('.modal-overlay, .modal-backdrop');
            overlays.forEach(overlay => {
                overlay.classList.remove('show');
                overlay.style.display = 'none';
                overlay.style.visibility = 'hidden';
                overlay.style.pointerEvents = 'none';
            });
            
            // Hide all modals
            const modals = document.querySelectorAll('.professional-modal, .changes-applied-modal, .save-modal, .delete-modal');
            modals.forEach(modal => {
                modal.classList.remove('show');
                modal.style.display = 'none';
            });
            
            console.log('All overlays manually cleared');
        }

        // Pikaday Calendar Initialization
        let pikadayInstances = [];

        function initializePikadayCalendars() {
            console.log('Initializing Pikaday calendars...');
            
            // Check if Pikaday is available
            if (typeof Pikaday === 'undefined') {
                console.error('Pikaday library not loaded yet, retrying in 500ms');
                setTimeout(initializePikadayCalendars, 500);
                return;
            }
            
            // Get current year and calculate year range (1910 to current year + 60)
            const currentYear = new Date().getFullYear();
            const minYear = 1910;
            const maxYear = currentYear + 60;
            
            // List of all date input IDs
            const dateFieldIds = [
                // Removed main date fields to allow keyboard input
                // 'dateOfBirth',
                // 'dateOfAppointment', 
                // 'retirementDate',
                // 'dateOfNextIncrement',
                // Removed leave date fields as they now use Flatpickr
                // 'leaveStartDate',
                // 'leaveEndDate',
                // 'childDOB' - now uses Flatpickr
                'fakeDate'
            ];

            // Destroy existing instances
            pikadayInstances.forEach(instance => {
                if (instance && typeof instance.destroy === 'function') {
                    try {
                        // Clean up scroll event listeners
                        if (instance._scrollHandlers) {
                            const { containers, handler } = instance._scrollHandlers;
                            containers.forEach(container => {
                                if (container) {
                                    container.removeEventListener('scroll', handler);
                                }
                            });
                        }
                        instance.destroy();
                    } catch (e) {
                        console.log('Error destroying Pikaday instance:', e);
                    }
                }
            });
            pikadayInstances = [];

            // Initialize Pikaday for each date field
            dateFieldIds.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    // Check if field already has a Pikaday instance
                    if (field._pikaday) {
                        console.log('Pikaday already initialized for:', fieldId, 'Value:', field.value);
                        // Just store the instance reference if it exists
                        pikadayInstances.push(field._pikaday);
                        return;
                    }
                    
                    console.log('Initializing Pikaday for:', fieldId);
                    
                    // Store existing value before initialization
                    const existingValue = field.value;
                    
                    try {
                        const pikaday = new Pikaday({
                            field: field,
                            format: 'DD/MM/YYYY',
                            minYear: minYear,
                            maxYear: maxYear,
                            minDate: fieldId === 'dateOfBirth' || fieldId === 'childDOB' 
                                ? new Date(minYear, 0, 1) 
                                : fieldId === 'dateOfAppointment' ? null
                                : fieldId === 'dateOfNextIncrement' ? new Date(minYear, 0, 1) // Allow past dates, will be restricted dynamically
                                : null,
                            maxDate: fieldId === 'dateOfBirth' || fieldId === 'childDOB' 
                                ? new Date() 
                                : fieldId === 'dateOfAppointment' ? new Date()
                                : new Date(maxYear, 11, 31),
                            firstDay: 1, // Start week on Monday
                            showWeekNumber: false,
                            showDaysInNextAndPreviousMonths: true,
                            enableSelectionDaysInNextAndPreviousMonths: false,
                            bound: true,
                            reposition: true, // Enable automatic repositioning
                            showYearDropdown: true,
                            showMonthDropdown: true,
                            yearRange: [minYear, maxYear],
                            maintainFocus: true, // Keep calendar open after selection
                            keyboardInput: true, // Allow keyboard input
                            onSelect: function(date) {
                                // Format date as DD/MM/YYYY
                                const formattedDate = String(date.getDate()).padStart(2, '0') + '/' + 
                                    String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                                    date.getFullYear();
                                
                                console.log('Date selected for', fieldId, ':', formattedDate);
                                field.value = formattedDate;
                                
                                // Trigger any existing change events
                                if (field.onchange) {
                                    field.onchange();
                                }
                                
                                // Dispatch change event for any listeners
                                const changeEvent = new Event('change', { bubbles: true });
                                field.dispatchEvent(changeEvent);
                            },
                            onOpen: function() {
                                const self = this;
                                
                                // Get the current date from field or use today
                                let currentDate = parseDDMMYYYY(field.value);
                                if (!currentDate) {
                                    currentDate = new Date();
                                }
                                
                                // Set the initial date in picker
                                this.setDate(currentDate, true);
                                
                                // Add event listeners for year/month dropdowns
                                setTimeout(() => {
                                    const yearSelect = this.el.querySelector('.pika-select-year');
                                    const monthSelect = this.el.querySelector('.pika-select-month');
                                    
                                    if (yearSelect) {
                                        yearSelect.addEventListener('change', function(e) {
                                            e.stopPropagation();
                                            const newYear = parseInt(this.value);
                                            const currentMonth = self.getDate() ? self.getDate().getMonth() : currentDate.getMonth();
                                            const currentDay = self.getDate() ? self.getDate().getDate() : currentDate.getDate();
                                            
                                            // Update the date with new year
                                            const newDate = new Date(newYear, currentMonth, currentDay);
                                            self.setDate(newDate);
                                            
                                            // Update field immediately
                                            const formattedDate = String(newDate.getDate()).padStart(2, '0') + '/' + 
                                                String(newDate.getMonth() + 1).padStart(2, '0') + '/' + 
                                                newDate.getFullYear();
                                            field.value = formattedDate;
                                            field.dispatchEvent(new Event('change', { bubbles: true }));
                                        });
                                    }
                                    
                                    if (monthSelect) {
                                        monthSelect.addEventListener('change', function(e) {
                                            e.stopPropagation();
                                            const newMonth = parseInt(this.value);
                                            const currentYear = self.getDate() ? self.getDate().getFullYear() : currentDate.getFullYear();
                                            const currentDay = self.getDate() ? self.getDate().getDate() : currentDate.getDate();
                                            
                                            // Adjust day if it doesn't exist in new month
                                            const daysInNewMonth = new Date(currentYear, newMonth + 1, 0).getDate();
                                            const adjustedDay = Math.min(currentDay, daysInNewMonth);
                                            
                                            // Update the date with new month
                                            const newDate = new Date(currentYear, newMonth, adjustedDay);
                                            self.setDate(newDate);
                                            
                                            // Update field immediately
                                            const formattedDate = String(newDate.getDate()).padStart(2, '0') + '/' + 
                                                String(newDate.getMonth() + 1).padStart(2, '0') + '/' + 
                                                newDate.getFullYear();
                                            field.value = formattedDate;
                                            field.dispatchEvent(new Event('change', { bubbles: true }));
                                        });
                                    }
                                }, 100);
                            }
                        });
                        
                        pikadayInstances.push(pikaday);
                        
                        // Store pikaday instance reference on the field element for enhanced modal handling
                        field._pikaday = pikaday;
                        
                        console.log('Successfully initialized Pikaday for:', fieldId);
                        
                        // Add scroll event listener to reposition calendar
                        const scrollContainers = [window, document.body, document.documentElement];
                        const modalContainers = document.querySelectorAll('.modal-content, .professional-modal, .modal-body, .professional-modal-body');
                        
                        // Add specific scrollable containers for leave application modal
                        const leaveModalBody = document.querySelector('#leaveApplicationModal .professional-modal-body');
                        const leaveModal = document.getElementById('leaveApplicationModal');
                        
                        modalContainers.forEach(container => {
                            scrollContainers.push(container);
                        });
                        
                        // Ensure leave modal containers are included
                        if (leaveModalBody) scrollContainers.push(leaveModalBody);
                        if (leaveModal) scrollContainers.push(leaveModal);
                        
                        const repositionHandler = () => {
                            if (pikaday.isVisible()) {
                                // Use a more robust repositioning approach
                                requestAnimationFrame(() => {
                                    try {
                                        // Hide temporarily to avoid flicker
                                        const calendar = pikaday.el;
                                        if (calendar) {
                                            calendar.style.opacity = '0';
                                        }
                                        
                                        // Reposition
                                        pikaday.adjustPosition();
                                        
                                        // Restore visibility after repositioning
                                        setTimeout(() => {
                                            if (calendar) {
                                                calendar.style.opacity = '1';
                                            }
                                        }, 10);
                                    } catch (error) {
                                        console.log('Error repositioning calendar:', error);
                                    }
                                });
                            }
                        };
                        
                        scrollContainers.forEach(container => {
                            if (container) {
                                container.addEventListener('scroll', repositionHandler, { passive: true });
                            }
                        });
                        
                        // Store handlers for cleanup
                        pikaday._scrollHandlers = { containers: scrollContainers, handler: repositionHandler };
                        
                        // Restore existing value after initialization
                        if (existingValue && existingValue.trim() !== '') {
                            console.log('Restoring existing value for', fieldId, ':', existingValue);
                            field.value = existingValue;
                            
                            // Parse and set the date in Pikaday
                            const existingDate = parseDDMMYYYY(existingValue);
                            if (existingDate) {
                                pikaday.setDate(existingDate, true);
                            }
                        }
                    } catch (error) {
                        console.error('Error initializing Pikaday for', fieldId, ':', error);
                    }
                } else {
                    console.log('Field not found:', fieldId);
                }
            });
            
            console.log('Pikaday calendars initialized:', pikadayInstances.length);
            
            // Update date picker restrictions after initialization
            setTimeout(updateDatePickerRestrictions, 100);
        }

        // Initialize calendars when DOM is ready and also immediately
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing calendars...');
            setTimeout(initializePikadayCalendars, 100);
        });

        // Also try to initialize after page fully loads
        window.addEventListener('load', function() {
            console.log('Page fully loaded, initializing calendars...');
            setTimeout(initializePikadayCalendars, 200);
        });

        // Re-initialize calendars when modals are opened (for dynamic content)
        function reinitializePikadayCalendars() {
            console.log('Reinitializing calendars for modal...');
            setTimeout(initializePikadayCalendars, 300);
        }

        // Also initialize immediately when script runs
        setTimeout(function() {
            console.log('Script-level initialization...');
            initializePikadayCalendars();
        }, 500);

        // Application state
        let isLoggedIn = false;
        let isAdminLoggedIn = false;
        let currentSection = 'dashboard';
        let currentUserRole = '';
        let currentUserData = null;
        let isOnline = false;
        
        // User management data with persistence
        let users = (JSON.parse(localStorage.getItem('cantonment_users') || '[]'))
            .filter(user => user && user.id && !isNaN(user.id));
        
        // Online users tracking
        let onlineUsers = JSON.parse(localStorage.getItem('cantonment_online_users') || '[]');
        
        // Permission check functions (updated for new system)
        function hasPermission(tab, permission) {
            if (!currentUserData || !currentUserData.permissions) {
                return false;
            }
            return currentUserData.permissions[tab] && currentUserData.permissions[tab].includes(permission);
        }
        
        // Updated permission helpers for new system
        function checkPermission(tab, permission, actionDescription) {
            if (!hasPermission(tab, permission)) {
                alert(`You don't have ${permission} permission to ${actionDescription}.`);
                return false;
            }
            return true;
        }

        // Backward compatibility functions - check if user has permission in any tab
        function canRead() {
            if (!currentUserData || !currentUserData.permissions) return false;
            return Object.values(currentUserData.permissions).some(perms => 
                Array.isArray(perms) && perms.includes('read')
            );
        }
        
        function canWrite() {
            if (!currentUserData || !currentUserData.permissions) return false;
            return Object.values(currentUserData.permissions).some(perms => 
                Array.isArray(perms) && perms.includes('write')
            );
        }
        
        function canEdit() {
            if (!currentUserData || !currentUserData.permissions) return false;
            return Object.values(currentUserData.permissions).some(perms => 
                Array.isArray(perms) && perms.includes('edit')
            );
        }

        // Section-specific permission functions
        function canReadSection(section) {
            if (!currentUserData || !currentUserData.permissions) return false;
            return currentUserData.permissions[section] && currentUserData.permissions[section].includes('read');
        }
        
        function canWriteSection(section) {
            if (!currentUserData || !currentUserData.permissions) {
                console.log('canWriteSection: No user data or permissions', currentUserData);
                return false;
            }
            const hasPermission = currentUserData.permissions[section] && currentUserData.permissions[section].includes('write');
            console.log(`canWriteSection(${section}):`, hasPermission, 'permissions:', currentUserData.permissions);
            return hasPermission;
        }
        
        function canEditSection(section) {
            if (!currentUserData || !currentUserData.permissions) {
                console.log('canEditSection: No user data or permissions', currentUserData);
                return false;
            }
            const hasPermission = currentUserData.permissions[section] && currentUserData.permissions[section].includes('edit');
            console.log(`canEditSection(${section}):`, hasPermission, 'permissions:', currentUserData.permissions);
            return hasPermission;
        }

        // Function to style buttons based on permissions
        function styleButtonsByPermissions() {
            // Find all buttons with permission-based conditions
            document.querySelectorAll('button[disabled]').forEach(button => {
                if (button.disabled && button.textContent.includes('disabled by permissions')) {
                    button.style.opacity = '0.5';
                    button.style.cursor = 'not-allowed';
                    button.style.background = '#f5f5f5';
                    button.style.color = '#999';
                }
            });
        }
        
        // Function to check if user is online
        function getUserOnlineStatus(userId) {
            return onlineUsers.includes(userId);
        }
        
        // Function to update user online status
        function updateUserOnlineStatus(userId, isOnline) {
            if (isOnline) {
                if (!onlineUsers.includes(userId)) {
                    onlineUsers.push(userId);
                }
            } else {
                onlineUsers = onlineUsers.filter(id => id !== userId);
            }
            localStorage.setItem('cantonment_online_users', JSON.stringify(onlineUsers));
        }
        
        // Save users to localStorage
        async function saveUsersToStorage() {
            // Validate users array before saving
            users = users.filter(user => user && user.id && !isNaN(user.id));
            
            // Check if current logged-in user's permissions were updated
            if (currentUserData && currentUserData.id) {
                const updatedUser = users.find(u => u.id === currentUserData.id);
                if (updatedUser && JSON.stringify(updatedUser.permissions) !== JSON.stringify(currentUserData.permissions)) {
                    // Update current user data with new permissions
                    currentUserData.permissions = updatedUser.permissions;
                    // Update navigation immediately
                    updateNavigationBasedOnPermissions();
                    // Update header display
                    updateUserRightsDisplay();
                }
            }
            
            // Try to save to API first, fallback to localStorage
            try {
                if (window.apiService && window.apiService.isOnline) {
                    console.log('Saving users to database via API');
                    // Individual records are saved via createUser/updateUser
                } else {
                    localStorage.setItem('cantonment_users', JSON.stringify(users));
                    // Update real-time user count if visible
                    updateUserCount();
                }
            } catch (error) {
                console.error('Failed to save users to API, using localStorage:', error);
                localStorage.setItem('cantonment_users', JSON.stringify(users));
                // Update real-time user count if visible
                updateUserCount();
            }
        }
        
        // Role selection and navigation functions
        function selectRole(role) {
            console.log('selectRole called with:', role);
            
            const roleSelectionDiv = document.getElementById('roleSelection');
            const adminLoginDiv = document.getElementById('adminLoginForm');
            const userLoginDiv = document.getElementById('userLoginForm');
            
            console.log('Elements found:', {
                roleSelection: !!roleSelectionDiv,
                adminLogin: !!adminLoginDiv,
                userLogin: !!userLoginDiv
            });
            
            if (role === 'administrator') {
                if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
                if (adminLoginDiv) adminLoginDiv.style.display = 'block';
            } else if (role === 'user') {
                if (roleSelectionDiv) roleSelectionDiv.style.display = 'none';
                if (userLoginDiv) userLoginDiv.style.display = 'block';
            }
        }
        
        // Make selectRole globally accessible
        window.selectRole = selectRole;
        
        function backToRoleSelection() {
            console.log('backToRoleSelection called');
            
            // Close any open popups
            closeAllPopups();
            
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'none';
            // Clear form values
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            // Reset to admin tab
            switchTab(0);
        }
        
        // Make backToRoleSelection globally accessible
        window.backToRoleSelection = backToRoleSelection;



        // Pagination Management
        class PaginationManager {
            constructor(containerId, data, renderFunction, itemsPerPage = 25) {
                this.containerId = containerId;
                this.data = data;
                this.renderFunction = renderFunction;
                this.itemsPerPage = itemsPerPage;
                this.currentPage = 1;
                this.filteredData = data;
            }

            updateData(newData) {
                this.data = newData;
                this.filteredData = newData;
                this.currentPage = 1;
                this.render();
            }

            setFilter(filterFunction) {
                this.filteredData = this.data.filter(filterFunction);
                this.currentPage = 1;
                this.render();
            }

            getTotalPages() {
                return Math.ceil(this.filteredData.length / this.itemsPerPage);
            }

            getCurrentPageData() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                return this.filteredData.slice(startIndex, endIndex);
            }

            goToPage(page) {
                const totalPages = this.getTotalPages();
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.render();
                }
            }

            nextPage() {
                this.goToPage(this.currentPage + 1);
            }

            prevPage() {
                this.goToPage(this.currentPage - 1);
            }

            setPageSize(newSize) {
                this.itemsPerPage = newSize;
                this.currentPage = 1;
                this.render();
            }

            render() {
                const currentData = this.getCurrentPageData();
                this.renderFunction(currentData);
                this.renderPaginationControls();
            }

            renderPaginationControls() {
                const container = document.getElementById(this.containerId);
                if (!container) return;

                const totalPages = this.getTotalPages();
                const totalItems = this.filteredData.length;
                const startItem = ((this.currentPage - 1) * this.itemsPerPage) + 1;
                const endItem = Math.min(this.currentPage * this.itemsPerPage, totalItems);

                let existingPagination = container.querySelector('.pagination-container');
                if (existingPagination) {
                    existingPagination.remove();
                }

                if (totalPages <= 1) return; // Don't show pagination for single page

                const paginationHTML = `
                    <div class="pagination-container">
                        <div class="pagination-info">
                            <div>Showing ${startItem}-${endItem} of ${totalItems} records</div>
                            <div class="pagination-summary">Page ${this.currentPage} of ${totalPages}</div>
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" onclick="window.paginationManagers['${this.containerId}']?.goToPage(1)" ${this.currentPage === 1 ? 'disabled' : ''}>
                                First
                            </button>
                            <button class="pagination-btn" onclick="window.paginationManagers['${this.containerId}']?.prevPage()" ${this.currentPage === 1 ? 'disabled' : ''}>
                                Previous
                            </button>
                            ${this.generatePageNumbers()}
                            <button class="pagination-btn" onclick="window.paginationManagers['${this.containerId}']?.nextPage()" ${this.currentPage === totalPages ? 'disabled' : ''}>
                                Next
                            </button>
                            <button class="pagination-btn" onclick="window.paginationManagers['${this.containerId}']?.goToPage(${totalPages})" ${this.currentPage === totalPages ? 'disabled' : ''}>
                                Last
                            </button>
                            <div class="page-size-selector">
                                <span>Show:</span>
                                <select onchange="window.paginationManagers['${this.containerId}']?.setPageSize(parseInt(this.value))">
                                    <option value="10" ${this.itemsPerPage === 10 ? 'selected' : ''}>10</option>
                                    <option value="25" ${this.itemsPerPage === 25 ? 'selected' : ''}>25</option>
                                    <option value="50" ${this.itemsPerPage === 50 ? 'selected' : ''}>50</option>
                                    <option value="100" ${this.itemsPerPage === 100 ? 'selected' : ''}>100</option>
                                </select>
                            </div>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', paginationHTML);
            }

            generatePageNumbers() {
                const totalPages = this.getTotalPages();
                const currentPage = this.currentPage;
                let pages = [];

                // Show up to 5 page numbers
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);

                // Adjust start if we're near the end
                if (endPage - startPage < 4) {
                    startPage = Math.max(1, endPage - 4);
                }

                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage;
                    pages.push(`
                        <button class="pagination-btn ${isActive ? 'active' : ''}" 
                                onclick="window.paginationManagers['${this.containerId}']?.goToPage(${i})"
                                ${isActive ? 'disabled' : ''}>
                            ${i}
                        </button>
                    `);
                }

                return pages.join('');
            }
        }

        // Initialize pagination managers globally
        window.paginationManagers = {};

        // Initialize staff table with pagination
        function initializeStaffTablePagination(data) {
            const renderFunction = (paginatedData) => {
                renderAdmissionsTable(paginatedData);
            };

            // Create pagination manager for staff table
            const paginationManager = new PaginationManager('staffTableContainer', data, renderFunction, 25);
            window.paginationManagers['staffTableContainer'] = paginationManager;

            // Render the first page
            paginationManager.render();
        }

        // Update staff table with new data (for search/filter)
        function updateStaffTableData(newData) {
            if (window.paginationManagers['staffTableContainer']) {
                window.paginationManagers['staffTableContainer'].updateData(newData);
            } else {
                // Fallback to original function
                renderAdmissionsTable(newData);
            }
        }

        // Apply filter to staff table
        function applyStaffTableFilter(filterFunction) {
            if (window.paginationManagers['staffTableContainer']) {
                window.paginationManagers['staffTableContainer'].setFilter(filterFunction);
            }
        }

        // Lazy Loading Implementation
        class LazyLoader {
            constructor() {
                this.imageObserver = null;
                this.contentObserver = null;
                this.init();
            }

            init() {
                // Initialize Intersection Observer for images
                if ('IntersectionObserver' in window) {
                    this.imageObserver = new IntersectionObserver(this.handleImageIntersection.bind(this), {
                        rootMargin: '50px 0px',
                        threshold: 0.1
                    });

                    this.contentObserver = new IntersectionObserver(this.handleContentIntersection.bind(this), {
                        rootMargin: '100px 0px',
                        threshold: 0.1
                    });
                } else {
                    // Fallback for older browsers
                    this.loadAllImages();
                }
            }

            handleImageIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        this.loadImage(img);
                        this.imageObserver.unobserve(img);
                    }
                });
            }

            handleContentIntersection(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const container = entry.target;
                        this.loadLazyContent(container);
                        this.contentObserver.unobserve(container);
                    }
                });
            }

            loadImage(img) {
                const src = img.dataset.src;
                if (!src) return;

                img.classList.add('loading');
                
                const imageLoader = new Image();
                imageLoader.onload = () => {
                    img.src = src;
                    img.classList.remove('loading');
                    img.classList.add('loaded');
                };
                imageLoader.onerror = () => {
                    img.classList.remove('loading');
                    // Keep placeholder or add error state
                };
                imageLoader.src = src;
            }

            loadLazyContent(container) {
                const loadFunction = container.dataset.lazyLoad;
                if (loadFunction && window[loadFunction]) {
                    // Remove placeholder
                    const placeholder = container.querySelector('.lazy-placeholder');
                    if (placeholder) {
                        placeholder.remove();
                    }
                    
                    // Execute the lazy load function
                    window[loadFunction](container);
                }
            }

            observeImage(img) {
                if (this.imageObserver) {
                    img.classList.add('lazy-image');
                    this.imageObserver.observe(img);
                } else {
                    this.loadImage(img);
                }
            }

            observeContent(container) {
                if (this.contentObserver) {
                    this.contentObserver.observe(container);
                } else {
                    this.loadLazyContent(container);
                }
            }

            loadAllImages() {
                // Fallback for browsers without IntersectionObserver
                document.querySelectorAll('[data-src]').forEach(img => {
                    this.loadImage(img);
                });
            }
            
            observe() {
                // Observe all images with data-src attribute
                document.querySelectorAll('[data-src]').forEach(img => {
                    this.observeImage(img);
                });
                
                // Observe all lazy content containers
                document.querySelectorAll('[data-lazy-load]').forEach(container => {
                    this.observeContent(container);
                });
            }
        }

        // Initialize lazy loader
        window.lazyLoader = new LazyLoader();

        // Helper function to create lazy image
        function createLazyImage(src, alt, className = '') {
            return `<img data-src="${src}" alt="${alt}" class="lazy-image ${className}">`;
        }

        // Lazy load staff photos in table
        function initializeLazyImages() {
            document.querySelectorAll('.staff-photo[data-src]').forEach(img => {
                window.lazyLoader.observeImage(img);
            });
        }
        

        // Tab switching function
        function switchTab(tabIndex) {
            const tabs = document.querySelectorAll('.tab');
            const adminTab = document.getElementById('adminTab');
            const userTab = document.getElementById('userTab');
            
            tabs.forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            if (tabIndex === 0) {
                adminTab.style.display = 'block';
                userTab.style.display = 'none';
            } else {
                adminTab.style.display = 'none';
                userTab.style.display = 'block';
            }
        }

        // Make switchTab globally accessible
        window.switchTab = switchTab;

        // Function to close all popups
        function closeAllPopups() {
            const userDetailsPopup = document.getElementById('userDetailsPopup');
            const notificationsPopup = document.getElementById('notificationsPopup');
            const messagesPopup = document.getElementById('messagesPopup');
            const editProfileModal = document.getElementById('editProfileModal');
            
            if (userDetailsPopup) {
                userDetailsPopup.classList.remove('show');
                userDetailsPopup.style.display = 'none';
            }
            if (notificationsPopup) {
                notificationsPopup.classList.remove('show');
                notificationsPopup.style.display = 'none';
            }
            if (messagesPopup) {
                messagesPopup.classList.remove('show');
                messagesPopup.style.display = 'none';
            }
            if (editProfileModal) {
                editProfileModal.classList.remove('show');
            }
        }

        // Initialize page state
        function initializePage() {
            closeAllPopups();
            updateNotificationBadge();
            
            // Load users from API on page load if admin is logged in or user is logged in
            if (isAdminLoggedIn || (currentUserData && currentUserData.id)) {
                loadUsersFromAPI().catch(error => {
                    console.error('Failed to load users from API on page load:', error);
                });
            }
        }
        
        function updateNotificationBadge() {
            // Generate dynamic notifications to get unread count
            const notifications = generateDynamicNotifications();
            const unreadCount = notifications.filter(n => n.unread).length;
            const notificationButtons = document.querySelectorAll('.icon-btn.notification');
            
            notificationButtons.forEach(button => {
                if (unreadCount > 0) {
                    button.setAttribute('data-count', unreadCount);
                } else {
                    button.removeAttribute('data-count');
                }
            });
        }

        // Notification system functions
        // checkDeductionBalanceNotifications function removed - Balance field no longer exists
        
        function checkNomineePercentageNotifications() {
            const notifications = [];
            const today = new Date().toDateString();
            
            // Get today's notification tracking
            const todaysNotifications = JSON.parse(localStorage.getItem('daily_notifications_' + today) || '{}');
            
            console.log('Today is:', today);
            console.log('Today\'s notifications tracking:', todaysNotifications);
            
            // Check all staff for incomplete nominee percentages
            admissions.forEach(staff => {
                const staffNominees = pensionNominees[staff.staffId] || [];
                const totalPercentage = staffNominees.reduce((sum, nominee) => {
                    return sum + (parseFloat(nominee.percentage) || 0);
                }, 0);
                
                // Debug logging for nominee check
                console.log(`Checking nominees for ${staff.staffName} (${staff.staffId}):`, {
                    nominees: staffNominees,
                    totalPercentage: totalPercentage,
                    hasNominees: staffNominees.length > 0
                });
                
                const notificationKey = `nominee_${staff.staffId}`;
                
                // Debug the notification decision
                console.log(`Notification decision for ${staff.staffName}:`, {
                    totalPercentage: totalPercentage,
                    isNot100: totalPercentage !== 100,
                    notificationKey: notificationKey,
                    alreadyNotifiedToday: todaysNotifications[notificationKey],
                    todaysNotifications: todaysNotifications
                });
                
                // If percentage is not 100%, always show notification (only track for badge count)
                if (totalPercentage !== 100) {
                    console.log(`Creating notification for ${staff.staffName}`);
                    
                    // Check if this notification is unread (not seen today)
                    const isUnread = !todaysNotifications[notificationKey];
                    
                    notifications.push({
                        id: `nominee_${staff.staffId}_${Date.now()}`,
                        type: 'info',
                        title: 'Nominee Addition Pending',
                        message: `Nominee addition is pending for Staff ID: ${staff.staffId}, Name: ${staff.staffName}. Please complete the process.`,
                        time: 'Today',
                        unread: isUnread,
                        staffId: staff.staffId,
                        staffName: staff.staffName,
                        category: 'nominee_pending'
                    });
                } else {
                    console.log(`Skipping notification for ${staff.staffName} - condition not met`);
                }
            });
            
            // Save today's notifications tracking
            localStorage.setItem('daily_notifications_' + today, JSON.stringify(todaysNotifications));
            return notifications;
        }
        
        function getDeductionFieldDisplayName(field) {
            const fieldNames = {
                'wheatAdvance': 'Wheat Advance',
                'gic': 'GIC (General Insurance Corporation)',
                'lic': 'LIC (Life Insurance Corporation)',
                'electricityBill': 'Electricity Bill',
                'waterCharges': 'Water Charges',
                'recovery': 'General Recovery',
                'leaveDeductions': 'Leave Deductions',
                'gppcSubscription': 'GPPC Subscription',
                'gpfExtraSubscription': 'GPF Extra Subscription',
                'gpfGovernmentContribution': 'GPF Government Contribution',
                'gpfAdvanceRecovery': 'GPF Advance Recovery',
                'npsGovernmentContribution': 'NPS Government Contribution',
                'npsSelfContribution': 'NPS Self Contribution',
                'gpfWithdrawl': 'GPF Withdrawal',
                'gpfInterest': 'GPF Interest',
                'bankRecovery': 'Bank Recovery',
                'incomeTax': 'Income Tax',
                'surCharges': 'Sur-charges',
                'otherDeduction1': 'Other Deduction-1',
                'otherDeduction2': 'Other Deduction-2',
                'otherDeduction3': 'Other Deduction-3',
                'gpfLedBalance': 'GPF Ledger Balance',
                'gpfAdvanceBalance': 'GPF Advance Balance'
            };
            return fieldNames[field] || field;
        }
        
        function generateDynamicNotifications() {
            const notifications = [];
            
            // Check if admin is logged in
            if (isAdminLoggedIn || currentUserRole === 'administrator') {
                // Generate admin-specific notifications
                
                // 1. New user registrations
                const newUsers = users.filter(user => {
                    const createdDate = new Date(user.createdAt || Date.now());
                    const daysSinceCreation = (Date.now() - createdDate) / (1000 * 60 * 60 * 24);
                    return daysSinceCreation <= 7; // Users created in last 7 days
                });
                
                if (newUsers.length > 0) {
                    notifications.push({
                        type: 'info',
                        title: 'New User Registrations',
                        message: `${newUsers.length} new user(s) registered in the last 7 days`,
                        time: 'Recent',
                        unread: true
                    });
                }
                
                // 2. Pending leave applications
                const pendingLeaves = leaveApplications.filter(app => app.status === 'pending');
                if (pendingLeaves.length > 0) {
                    notifications.push({
                        type: 'warning',
                        title: 'Pending Leave Applications',
                        message: `${pendingLeaves.length} leave application(s) waiting for approval`,
                        time: 'Action Required',
                        unread: true
                    });
                }
                
                // 3. Low attendance alerts
                const lowAttendanceStaff = admissions.filter(staff => {
                    // Mock calculation - in real implementation, calculate from attendance records
                    const attendancePercent = Math.random() * 100;
                    return attendancePercent < 80;
                });
                
                if (lowAttendanceStaff.length > 0) {
                    notifications.push({
                        type: 'error',
                        title: 'Low Attendance Alert',
                        message: `${lowAttendanceStaff.length} staff member(s) have attendance below 80%`,
                        time: 'This Month',
                        unread: true
                    });
                }
                
                // 4. System maintenance reminders
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (!lastBackup || (Date.now() - new Date(lastBackup)) > 7 * 24 * 60 * 60 * 1000) {
                    notifications.push({
                        type: 'warning',
                        title: 'System Maintenance',
                        message: 'Database backup recommended - last backup was over 7 days ago',
                        time: 'System',
                        unread: true
                    });
                }
                
                // 5. Payroll processing reminders
                const currentDate = new Date();
                if (currentDate.getDate() >= 25) {
                    notifications.push({
                        type: 'info',
                        title: 'Payroll Reminder',
                        message: 'End of month approaching - prepare payroll processing',
                        time: 'Monthly Task',
                        unread: true
                    });
                }
                
                // 6. User access issues
                const recentFailedLogins = JSON.parse(localStorage.getItem('failedLoginAttempts') || '[]');
                if (recentFailedLogins.length > 5) {
                    notifications.push({
                        type: 'error',
                        title: 'Security Alert',
                        message: `${recentFailedLogins.length} failed login attempts detected`,
                        time: 'Security',
                        unread: true
                    });
                }
                
            } else {
                // Generate user-specific notifications (existing code)
                
                // Debug logging
                console.log('Generating notifications - staffDeductions:', Object.keys(staffDeductions).length, 'records');
                console.log('Generating notifications - admissions:', admissions.length, 'staff members');
                
                // Balance field removed - no deduction balance notifications needed
                
                // Get nominee percentage notifications
                const nomineeNotifications = checkNomineePercentageNotifications();
                notifications.push(...nomineeNotifications);
            }
            
            console.log('Total notifications generated:', notifications.length);
            return notifications;
        }
        
        // clearNotificationWhenBalanceRestored function removed - Balance field no longer exists
        
        // Function to reset today's notifications for testing (can be called from console)
        function resetTodaysNotifications() {
            const today = new Date().toDateString();
            localStorage.removeItem('daily_notifications_' + today);
            console.log('Cleared today\'s notification tracking');
            updateNotificationBadge();
        }

        // Call initialization when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            
            // Initial notification badge update
            setTimeout(() => {
                updateNotificationBadge();
            }, 1000);
            
            // Set up periodic notification checking (every 5 minutes)
            setInterval(() => {
                updateNotificationBadge();
            }, 300000); // 5 minutes
            
            // Set up periodic refresh for online status in admin panel
            setInterval(() => {
                if (isAdminLoggedIn && document.getElementById('adminContent').innerHTML.includes('User Management')) {
                    // Refresh the user management view to update online statuses
                    const currentSection = document.querySelector('#adminSidebar .nav-item.active');
                    if (currentSection && currentSection.textContent.includes('User Management')) {
                        showUserManagement();
                    }
                }
            }, 30000); // Refresh every 30 seconds
        });

        // Administrator login function
        function loginAdmin(event) {
            event.preventDefault();
            console.log('Admin login function called');
            
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            console.log('Admin credentials:', username, password);
            const errorDiv = document.getElementById('adminError');
            const successDiv = document.getElementById('adminSuccess');
            
            // Hide any existing messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';
            errorDiv.textContent = '';
            successDiv.textContent = '';
            
            // Simple admin validation (demo credentials)
            if (username === 'superadmin' && password === 'admin123') {
                successDiv.textContent = 'Login successful!';
                successDiv.style.display = 'block';
                
                // Clear any previous user session data
                isLoggedIn = false;
                
                // Set admin session data
                isAdminLoggedIn = true;
                currentUserRole = 'administrator';
                
                // Generate a simple auth token for API requests
                authToken = 'demo-admin-token-' + Date.now();
                localStorage.setItem('authToken', authToken);
                
                // Load admin data from localStorage if exists, otherwise use default
                const adminUsers = JSON.parse(localStorage.getItem('cantonment_admin_users')) || [];
                if (adminUsers.length > 0) {
                    currentUserData = {
                        id: adminUsers[0].id || 0,
                        fullName: adminUsers[0].fullName || 'Super Admin',
                        username: adminUsers[0].username || 'superadmin',
                        email: adminUsers[0].email || 'admin@cba.gov.in',
                        role: 'Administrator',
                        status: 'Active'
                    };
                } else {
                    currentUserData = {
                        id: 0,
                        fullName: 'Super Admin',
                        username: 'superadmin',
                        email: 'admin@cba.gov.in',
                        role: 'Administrator',
                        status: 'Active'
                    };
                }
                
                console.log('Admin login successful, currentUserData set to:', currentUserData);
                
                // Log the admin login
                addUserLog(
                    0, // Admin user ID
                    'Super Admin',
                    'admin@cba.gov.in',
                    'login',
                    'Administrator logged in successfully'
                );
                
                // Hide loading and show success message
                successDiv.textContent = 'Login successful!';
                successDiv.style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('roleSelection').style.display = 'none';
                    document.getElementById('adminDashboard').style.display = 'block';
                    
                    // Update admin UI immediately with correct data
                    updateAdminUI();
                    
                    loadAdminDashboard();
                }, 1000);
            } else {
                // Hide loading and show error
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.style.display = 'block';
                
                // Auto-hide error message after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        // Admin logout function
        function adminLogout() {
            // Close any open popups
            closeAllPopups();
            
            // Log the admin logout
            if (currentUserData) {
                addUserLog(
                    0, // Admin user ID
                    currentUserData.fullName || 'Super Admin',
                    currentUserData.email || 'admin@cba.gov.in',
                    'logout',
                    'Administrator logged out'
                );
            }
            
            // Stop all real-time admin features
            stopAdminRealTimeFeatures();
            
            isAdminLoggedIn = false;
            currentUserRole = '';
            currentUserData = null;
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            
            // Clear any lingering messages
            const adminError = document.getElementById('adminError');
            const adminSuccess = document.getElementById('adminSuccess');
            if (adminError) {
                adminError.style.display = 'none';
                adminError.textContent = '';
            }
            if (adminSuccess) {
                adminSuccess.style.display = 'none';
                adminSuccess.textContent = '';
            }
        }
        
        // Load admin dashboard
        function loadAdminDashboard() {
            // Initialize admin designations dropdown for user creation
            updateAdminUserDesignationDropdown();
            showAdminSection('users');
            
            // Start real-time admin monitoring systems
            initializeRealTimeAdminFeatures();
        }
        
        // Real-time admin features initialization
        function initializeRealTimeAdminFeatures() {
            console.log('üöÄ Starting real-time admin monitoring systems...');
            
            // Clear any existing intervals first
            if (window.adminRealTimeIntervals) {
                window.adminRealTimeIntervals.forEach(interval => clearInterval(interval));
            }
            window.adminRealTimeIntervals = [];
            
            // 1. Dashboard Statistics Auto-Refresh (every 30 seconds)
            const dashboardRefresh = setInterval(() => {
                if (isAdminDashboardVisible() && currentAdminSection) {
                    refreshAdminDashboardStats();
                }
            }, 30000);
            window.adminRealTimeIntervals.push(dashboardRefresh);
            
            // 2. Error Monitoring (DISABLED - not needed for user alerts)
            // const errorMonitoring = setInterval(() => {
            //     if (isAdminDashboardVisible()) {
            //         checkForNewSystemErrors();
            //     }
            // }, 15000);
            // window.adminRealTimeIntervals.push(errorMonitoring);
            
            // 3. System Health Monitoring (every 60 seconds)
            const systemHealth = setInterval(() => {
                if (isAdminDashboardVisible()) {
                    updateSystemHealthStatus();
                }
            }, 60000);
            window.adminRealTimeIntervals.push(systemHealth);
            
            // 4. User Activity Monitoring (every 20 seconds)
            const activityMonitoring = setInterval(() => {
                if (isAdminDashboardVisible() && currentAdminSection === 'logs') {
                    refreshUserActivityLogs();
                }
            }, 20000);
            window.adminRealTimeIntervals.push(activityMonitoring);
            
            // 5. Session Tracking (every 45 seconds)
            const sessionTracking = setInterval(() => {
                if (isAdminDashboardVisible()) {
                    updateActiveSessionCount();
                }
            }, 45000);
            window.adminRealTimeIntervals.push(sessionTracking);
            
            // 6. Real-time Notifications (DISABLED - not needed)
            // const notificationCheck = setInterval(() => {
            //     if (isAdminDashboardVisible()) {
            //         checkForAdminNotifications();
            //     }
            // }, 10000);
            // window.adminRealTimeIntervals.push(notificationCheck);
            
            console.log('‚úÖ Real-time admin monitoring active:', window.adminRealTimeIntervals.length, 'systems running');
        }
        
        // Helper function to check if admin dashboard is visible
        function isAdminDashboardVisible() {
            const adminDashboard = document.getElementById('adminDashboard');
            return adminDashboard && adminDashboard.style.display !== 'none' && isAdminLoggedIn;
        }
        
        // Show admin sections
        function showAdminSection(section) {
            // Track current section for state persistence
            currentAdminSection = section;
            
            // Update nav active state for admin sidebar
            document.querySelectorAll('#adminSidebar .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const clickedItem = event && event.target ? event.target.closest('.nav-item') : null;
            if (clickedItem) {
                clickedItem.classList.add('active');
            } else {
                // If no event, find by section name
                document.querySelectorAll('#adminSidebar .nav-item').forEach((item, index) => {
                    if ((section === 'users' && index === 0) || 
                        (section === 'logs' && index === 1) || 
                        (section === 'designations' && index === 2) || 
                        (section === 'system' && index === 3)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('adminSidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
            }
            
            const content = document.getElementById('adminContent');
            
            switch(section) {
                case 'users':
                    showUserManagement();
                    break;
                case 'logs':
                    showUserLogs();
                    break;
                case 'designations':
                    showAdminDesignations();
                    break;
                case 'system':
                    showSystemSettings();
                    break;
            }
        }
        
        // User Logs Functions
        function showUserLogs() {
            const content = document.getElementById('adminContent');
            
            content.innerHTML = `
                <div class="content-header">
                    <h3>User Activity Logs</h3>
                    <p>Monitor all user login/logout activities and system changes</p>
                </div>
                
                <div class="logs-container">
                    <div class="logs-filters">
                        <div class="logs-search">
                            <input type="text" id="logsSearch" placeholder="Search by user name, email, or action..." 
                                   onkeypress="return /[a-zA-Z0-9\s@.]/.test(event.key)"
                                   oninput="handleSearchInput(this); filterLogs()">
                        </div>
                        <div class="logs-action-filter">
                            <select id="actionFilter" onchange="filterLogs()">
                                <option value="">All Actions</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="staff_create">Create Staff</option>
                                <option value="staff_update">Update Staff</option>
                                <option value="designation_create">Create Designation</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="exportLogsToPDF()">üìÑ Export</button>
                        <button class="btn btn-secondary" onclick="clearLogsFilters()">Clear Filters</button>
                    </div>
                    
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <!-- Logs will be populated here -->
                        </tbody>
                    </table>
                </div>
            `;
            
            // Filter out admin logs (userId 0) for user logs section
            const filteredUserLogs = userLogs.filter(log => log.userId !== 0);
            renderLogsTable(filteredUserLogs);
        }
        
        function renderLogsTable(logsToShow) {
            const tbody = document.getElementById('logsTableBody');
            
            if (logsToShow.length > 0) {
                // Sort logs by timestamp (newest first)
                const sortedLogs = [...logsToShow].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                tbody.innerHTML = sortedLogs.map(log => `
                    <tr>
                        <td class="log-timestamp">${formatLogTimestamp(log.timestamp)}</td>
                        <td>
                            <strong>${log.userName}</strong><br>
                            <small style="color: #666;">${log.userEmail}</small>
                        </td>
                        <td>
                            <span class="log-action ${log.action}">${formatActionName(log.action)}</span>
                        </td>
                        <td class="log-details">${log.details}</td>
                        <td class="log-ip">${log.ipAddress || 'N/A'}</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No logs found matching your criteria.</td></tr>';
            }
        }
        
        function formatLogTimestamp(timestamp) {
            const date = new Date(timestamp);
            const options = {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            return date.toLocaleDateString('en-US', options);
        }
        
        function formatActionName(action) {
            const actionNames = {
                'login': 'Login',
                'logout': 'Logout',
                'staff_create': 'Create Staff',
                'staff_update': 'Update Staff',
                'designation_create': 'Create Designation'
            };
            return actionNames[action] || action;
        }
        
        function filterLogs() {
            const searchTerm = document.getElementById('logsSearch').value.toLowerCase();
            const actionFilter = document.getElementById('actionFilter').value;
            
            // Start with user logs only (exclude admin logs)
            let filteredLogs = userLogs.filter(log => log.userId !== 0);
            
            // Filter by search term
            if (searchTerm) {
                filteredLogs = filteredLogs.filter(log => 
                    log.userName.toLowerCase().includes(searchTerm) ||
                    log.userEmail.toLowerCase().includes(searchTerm) ||
                    log.details.toLowerCase().includes(searchTerm) ||
                    formatActionName(log.action).toLowerCase().includes(searchTerm)
                );
            }
            
            // Filter by action
            if (actionFilter) {
                filteredLogs = filteredLogs.filter(log => log.action === actionFilter);
            }
            
            renderLogsTable(filteredLogs);
        }
        
        function clearLogsFilters() {
            document.getElementById('logsSearch').value = '';
            document.getElementById('actionFilter').value = '';
            // Show user logs only (exclude admin logs)
            const filteredUserLogs = userLogs.filter(log => log.userId !== 0);
            renderLogsTable(filteredUserLogs);
        }
        
        // Function to add new log entry
        function addUserLog(userId, userName, userEmail, action, details, targetId = null, targetType = null) {
            const newLog = {
                id: userLogs.length > 0 ? Math.max(...userLogs.map(l => l.id)) + 1 : 1,
                userId: userId,
                userName: userName,
                userEmail: userEmail,
                action: action,
                timestamp: new Date(),
                ipAddress: '192.168.1.100', // In real app, get actual IP
                userAgent: navigator.userAgent,
                details: details,
                targetId: targetId,
                targetType: targetType
            };
            
            userLogs.unshift(newLog); // Add to beginning of array
            saveUserLogsToStorage();
        }

        // User management functions
        // Load users from the normalized API
        async function loadUsersFromAPI() {
            // Check if running on a web server (not file://)
            if (window.location.protocol !== 'http:' && window.location.protocol !== 'https:') {
                console.log('Running from file:// protocol - skipping API call');
                // Load from localStorage only
                users = JSON.parse(localStorage.getItem('cantonment_users') || '[]');
                return;
            }
            
            try {
                const response = await fetch('/api/users-normalized', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const apiUsers = await response.json();
                    
                    // Get existing users from localStorage to preserve permissions if API doesn't return them
                    const existingUsers = JSON.parse(localStorage.getItem('cantonment_users') || '[]');
                    
                    // Convert API users to the format expected by the frontend
                    users = apiUsers.map(user => {
                        // Find existing user to preserve permissions if needed
                        const existingUser = existingUsers.find(u => u.id === user.id);
                        
                        return {
                            id: user.id,
                            fullName: user.full_name,
                            username: user.username,
                            password: user.password || (existingUser ? existingUser.password : ''),
                            email: user.email,
                            role: user.role,
                            status: user.status,
                            dateOfBirth: user.date_of_birth,
                            age: user.age,
                            gender: user.gender,
                            fatherName: user.father_name,
                            motherName: user.mother_name,
                            grandFatherName: user.grand_father_name,
                            address: user.address,
                            mobile: user.mobile_number || user.phone,
                            designation: user.designation,
                            appointmentDate: user.appointment_date,
                            aadharNumber: user.aadhar_number,
                            panNumber: user.pan_number,
                            createdAt: user.created_at,
                            // Include permissions from API, or preserve existing ones if API doesn't provide them
                            permissions: user.permissions || (existingUser ? existingUser.permissions : {})
                        };
                    });
                    
                    // Update localStorage with the fetched data
                    localStorage.setItem('cantonment_users', JSON.stringify(users));
                    console.log('Users loaded from API successfully');
                    
                } else {
                    console.error('Failed to load users from API, using localStorage');
                    // Fallback to localStorage
                    users = JSON.parse(localStorage.getItem('cantonment_users') || '[]');
                }
            } catch (error) {
                console.error('Error loading users from API:', error);
                // Fallback to localStorage
                users = JSON.parse(localStorage.getItem('cantonment_users') || '[]');
            }
        }

        // =================================================================
        // REAL-TIME ADMIN FEATURES IMPLEMENTATION
        // =================================================================
        
        // 1. Dashboard Statistics Auto-Refresh
        async function refreshAdminDashboardStats() {
            try {
                console.log('üîÑ Refreshing admin dashboard statistics...');
                
                // Update user counts
                const userCountElements = document.querySelectorAll('#userCount, .user-count-display');
                userCountElements.forEach(el => {
                    if (el) el.textContent = users.length;
                });
                
                // Update staff counts  
                const staffCountElements = document.querySelectorAll('.staff-count-display');
                staffCountElements.forEach(el => {
                    if (el) el.textContent = admissions.length;
                });
                
                // Update active user count (online users)
                const activeUserElements = document.querySelectorAll('.active-user-count');
                activeUserElements.forEach(el => {
                    if (el) el.textContent = onlineUsers.length;
                });
                
                // Update system status indicators
                const lastUpdateElements = document.querySelectorAll('.last-update-time');
                lastUpdateElements.forEach(el => {
                    if (el) el.textContent = new Date().toLocaleTimeString();
                });
                
                console.log('‚úÖ Dashboard stats refreshed - Users:', users.length, 'Staff:', admissions.length, 'Online:', onlineUsers.length);
                
            } catch (error) {
                console.error('‚ùå Error refreshing dashboard stats:', error);
            }
        }
        
        // 2. Real-time Error Monitoring
        async function checkForNewSystemErrors() {
            try {
                // Simulate checking for new system errors
                const errorCount = Math.floor(Math.random() * 3); // Simulate 0-2 new errors
                
                if (errorCount > 0) {
                    console.log('‚ö†Ô∏è New system errors detected:', errorCount);
                    
                    // Update error indicators
                    const errorBadges = document.querySelectorAll('.error-count-badge');
                    errorBadges.forEach(badge => {
                        if (badge) {
                            const currentCount = parseInt(badge.textContent) || 0;
                            badge.textContent = currentCount + errorCount;
                            badge.style.display = 'inline-block';
                            badge.classList.add('pulse-animation');
                        }
                    });
                    
                    // Show error notification
                    if (errorCount > 1) {
                        showAdminNotification('System Alert', `${errorCount} new system errors detected`, 'warning');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error checking system errors:', error);
            }
        }
        
        // 3. System Health Monitoring
        async function updateSystemHealthStatus() {
            try {
                console.log('üè• Updating system health status...');
                
                // Simulate system health metrics
                const healthMetrics = {
                    serverStatus: 'online',
                    databaseStatus: 'healthy',
                    responseTime: Math.floor(Math.random() * 200) + 50, // 50-250ms
                    memoryUsage: Math.floor(Math.random() * 30) + 40, // 40-70%
                    cpuUsage: Math.floor(Math.random() * 40) + 20 // 20-60%
                };
                
                // Update health indicators
                const healthElements = document.querySelectorAll('.system-health-indicator');
                healthElements.forEach(indicator => {
                    if (indicator) {
                        const statusClass = healthMetrics.serverStatus === 'online' ? 'healthy' : 'error';
                        indicator.className = `system-health-indicator ${statusClass}`;
                        indicator.title = `Server: ${healthMetrics.serverStatus} | Response: ${healthMetrics.responseTime}ms | Memory: ${healthMetrics.memoryUsage}%`;
                    }
                });
                
                // Update performance metrics displays
                const responseTimeElements = document.querySelectorAll('.response-time-display');
                responseTimeElements.forEach(el => {
                    if (el) el.textContent = `${healthMetrics.responseTime}ms`;
                });
                
                const memoryElements = document.querySelectorAll('.memory-usage-display');
                memoryElements.forEach(el => {
                    if (el) el.textContent = `${healthMetrics.memoryUsage}%`;
                });
                
                console.log('‚úÖ System health updated:', healthMetrics);
                
            } catch (error) {
                console.error('‚ùå Error updating system health:', error);
            }
        }
        
        // 4. User Activity Monitoring
        async function refreshUserActivityLogs() {
            try {
                if (currentAdminSection !== 'logs') return;
                
                console.log('üìä Refreshing user activity logs...');
                
                // Get current logs table
                const logsTableBody = document.getElementById('logsTableBody');
                if (!logsTableBody) return;
                
                // Check for new activity (simulate new log entries)
                const hasNewActivity = Math.random() < 0.3; // 30% chance of new activity
                
                if (hasNewActivity) {
                    // Add new simulated log entry
                    const newLogEntry = {
                        timestamp: new Date(),
                        userId: Math.floor(Math.random() * users.length) + 1,
                        userName: users[Math.floor(Math.random() * users.length)]?.fullName || 'Unknown User',
                        action: 'page_view',
                        details: 'Viewed dashboard',
                        ipAddress: `192.168.1.${Math.floor(Math.random() * 254) + 1}`
                    };
                    
                    // Add to userLogs array
                    userLogs.unshift(newLogEntry);
                    
                    // Re-render logs table with highlight for new entry
                    renderLogsTable(userLogs.filter(log => log.userId !== 0));
                    
                    console.log('üìà New activity logged:', newLogEntry.action);
                }
                
            } catch (error) {
                console.error('‚ùå Error refreshing activity logs:', error);
            }
        }
        
        // 5. Session Tracking
        async function updateActiveSessionCount() {
            try {
                console.log('üîó Updating active session count...');
                
                // Simulate session changes
                const sessionChange = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                
                if (sessionChange !== 0) {
                    // Update online users count
                    if (sessionChange > 0) {
                        // Simulate user coming online
                        const offlineUser = users.find(u => !onlineUsers.includes(u.id));
                        if (offlineUser && Math.random() < 0.5) {
                            onlineUsers.push(offlineUser.id);
                            console.log('üü¢ User came online:', offlineUser.fullName);
                        }
                    } else {
                        // Simulate user going offline
                        if (onlineUsers.length > 0 && Math.random() < 0.3) {
                            const randomIndex = Math.floor(Math.random() * onlineUsers.length);
                            const userId = onlineUsers.splice(randomIndex, 1)[0];
                            const user = users.find(u => u.id === userId);
                            console.log('üî¥ User went offline:', user?.fullName || 'Unknown');
                        }
                    }
                    
                    // Update all session count displays
                    const sessionElements = document.querySelectorAll('.active-sessions-count');
                    sessionElements.forEach(el => {
                        if (el) {
                            el.textContent = onlineUsers.length;
                            el.classList.add('updated-highlight');
                            setTimeout(() => el.classList.remove('updated-highlight'), 2000);
                        }
                    });
                    
                    // Update user management online indicators
                    if (currentAdminSection === 'users') {
                        updateUserOnlineStatus();
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Error updating session count:', error);
            }
        }
        
        // 6. Real-time Notifications
        async function checkForAdminNotifications() {
            try {
                // Simulate checking for admin notifications
                const hasNewNotification = Math.random() < 0.05; // 5% chance per check (every 10 seconds)
                
                if (hasNewNotification) {
                    const notificationTypes = ['info', 'warning', 'success'];
                    const messages = [
                        'New user registration pending approval',
                        'System backup completed successfully', 
                        'Database optimization recommended',
                        'Security scan completed - no issues found',
                        'New staff member added to the system'
                    ];
                    
                    const randomType = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
                    const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                    
                    showAdminNotification('System Update', randomMessage, randomType);
                    
                    // Update notification badge
                    const notificationBadges = document.querySelectorAll('.notification-badge');
                    notificationBadges.forEach(badge => {
                        if (badge) {
                            const currentCount = parseInt(badge.textContent) || 0;
                            badge.textContent = currentCount + 1;
                            badge.style.display = 'inline-block';
                        }
                    });
                    
                    console.log('üîî New admin notification:', randomMessage);
                }
                
            } catch (error) {
                console.error('‚ùå Error checking notifications:', error);
            }
        }
        
        // Helper function to show admin notifications
        function showAdminNotification(title, message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `admin-notification ${type}`;
            notification.innerHTML = `
                <div class="notification-header">
                    <strong>${title}</strong>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                </div>
                <div class="notification-message">${message}</div>
                <div class="notification-time">${new Date().toLocaleTimeString()}</div>
            `;
            
            // Add to page
            let notificationContainer = document.querySelector('.admin-notifications-container');
            if (!notificationContainer) {
                notificationContainer = document.createElement('div');
                notificationContainer.className = 'admin-notifications-container';
                document.body.appendChild(notificationContainer);
            }
            
            notificationContainer.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // Helper function to update user online status indicators
        function updateUserOnlineStatus() {
            const userRows = document.querySelectorAll('.user-row');
            userRows.forEach(row => {
                const userId = parseInt(row.dataset.userId);
                const statusIndicator = row.querySelector('.online-status');
                if (statusIndicator) {
                    if (onlineUsers.includes(userId)) {
                        statusIndicator.className = 'online-status online';
                        statusIndicator.textContent = 'üü¢ Online';
                    } else {
                        statusIndicator.className = 'online-status offline';
                        statusIndicator.textContent = '‚ö´ Offline';
                    }
                }
            });
        }
        
        // Show Admin Notification Center
        function showAdminNotificationCenter() {
            showAdminNotification('Notification Center', 'Here you can view all system notifications and alerts. Real-time monitoring is now active!', 'info');
            
            // Reset notification badge
            const notificationBadges = document.querySelectorAll('.notification-badge');
            notificationBadges.forEach(badge => {
                badge.textContent = '0';
                badge.style.display = 'none';
            });
        }
        
        // Clean up intervals when admin logs out
        function stopAdminRealTimeFeatures() {
            if (window.adminRealTimeIntervals) {
                console.log('üõë Stopping', window.adminRealTimeIntervals.length, 'real-time admin monitoring systems...');
                window.adminRealTimeIntervals.forEach(interval => clearInterval(interval));
                window.adminRealTimeIntervals = [];
                console.log('‚úÖ All admin real-time features stopped');
            }
        }

        function showUserManagement() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="section-header">
                    <h3>User Management (<span id="userCount">${users.length}</span> users)</h3>
                    <button class="btn btn-primary" onclick="openUserModal()">+ Create New User</button>
                </div>
                
                
                <div class="table-container">
                    <table class="user-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map((user, index) => {
                                // Use the same gradients as the dashboard
                                const gradients = [
                                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                                    'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                                    'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)',
                                    'linear-gradient(135deg, #c471ed 0%, #f64f59 100%)'
                                ];
                                const gradient = gradients[index % gradients.length];
                                const userInitials = user.fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                                
                                return `
                                <tr class="user-row" data-user-id="${user.id}">
                                    <td>
                                        <div class="user-info">
                                            <div class="staff-photo-placeholder" style="background: ${gradient}; color: white; font-weight: 600;">${userInitials}</div>
                                            <span class="staff-name">${user.fullName}</span>
                                        </div>
                                    </td>
                                    <td>${user.username}</td>
                                    <td>${user.email || 'Not provided'}</td>
                                    <td>
                                        <span class="account-status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">${user.status === 'active' ? 'Active' : 'Inactive'}</span>
                                        <span class="online-status ${onlineUsers.includes(user.id) ? 'online' : 'offline'}">${onlineUsers.includes(user.id) ? 'üü¢ Online' : '‚ö´ Offline'}</span>
                                    </td>
                                    <td>${user.createdAt}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="details-btn" data-user-id="${user.id}" data-action="view-details">Details</button>
                                            <button class="edit-btn" data-user-id="${user.id}" data-action="edit-user">Edit</button>
                                            <button class="delete-btn" data-user-id="${user.id}" data-action="delete-user">Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Add event listener for user management actions
            const tableContainer = document.querySelector('.table-container');
            if (tableContainer) {
                tableContainer.removeEventListener('click', handleUserClick);
                tableContainer.addEventListener('click', handleUserClick);
            }
        }
        
        function handleUserClick(event) {
            const detailsButton = event.target.closest('button[data-action="view-details"]');
            if (detailsButton) {
                const userId = parseInt(detailsButton.getAttribute('data-user-id'));
                viewUserDetails(userId);
                return;
            }
            
            const button = event.target.closest('button[data-action="edit-user"]');
            if (button) {
                const userId = parseInt(button.getAttribute('data-user-id'));
                editUser(userId);
                return;
            }
            
            const toggleButton = event.target.closest('button[data-action="toggle-status"]');
            if (toggleButton) {
                const userId = parseInt(toggleButton.getAttribute('data-user-id'));
                toggleUserStatus(userId);
                return;
            }
            
            const photo = event.target.closest('img[data-action="user-photo"]');
            if (photo) {
                const userId = parseInt(photo.getAttribute('data-user-id'));
                openUserPhotoModal(userId);
                return;
            }
            
            const deleteButton = event.target.closest('button[data-action="delete-user"]');
            if (deleteButton) {
                const userId = parseInt(deleteButton.getAttribute('data-user-id'));
                deleteUser(userId);
                return;
            }
        }
        
        // Admin Portal Designations Storage Functions
        function saveAdminDesignationsToStorage() {
            localStorage.setItem('cantonment_admin_designations', JSON.stringify(adminDesignations));
            // Update real-time record count if visible
            updateAdminDesignationCount();
        }
        
        // Real-time count update functions
        function updateAdminDesignationCount() {
            const countElement = document.getElementById('adminDesignationCount');
            if (countElement) {
                countElement.textContent = adminDesignations.length;
            }
        }
        
        function updateUserCount() {
            const countElement = document.getElementById('userCount');
            if (countElement) {
                countElement.textContent = users.length;
            }
        }
        
        // Track current active admin section for tab state persistence
        let currentAdminSection = 'users';
        
        // Enhanced section switching with state preservation
        function preserveCurrentAdminSection() {
            const activeNavItem = document.querySelector('#adminSidebar .nav-item.active');
            if (activeNavItem) {
                const sectionText = activeNavItem.querySelector('.nav-text').textContent.toLowerCase();
                if (sectionText.includes('user')) {
                    currentAdminSection = 'users';
                } else if (sectionText.includes('designation')) {
                    currentAdminSection = 'designations';
                } else if (sectionText.includes('log')) {
                    currentAdminSection = 'logs';
                } else if (sectionText.includes('system')) {
                    currentAdminSection = 'system';
                }
            }
        }
        
        // Helper functions for form reset
        function clearChildrenSection() {
            const childrenContainer = document.getElementById('childrenContainer');
            if (childrenContainer) {
                childrenContainer.innerHTML = '';
            }
            
            // Reset children counter
            if (window.childrenCounter) {
                window.childrenCounter = 0;
            }
            
            // Reset add child button state
            const addChildButton = document.getElementById('addChildButton');
            if (addChildButton) {
                addChildButton.disabled = true;
                addChildButton.style.opacity = '0.5';
                addChildButton.style.cursor = 'not-allowed';
                addChildButton.title = 'Select "Married" status first';
            }
        }
        
        function clearAndReinitializeFlatpickr() {
            // Clear and reinitialize DOB Flatpickr
            const dobField = document.getElementById('userDOB');
            if (dobField && dobField._flatpickr) {
                dobField._flatpickr.destroy();
            }
            
            // Clear and reinitialize Appointment Date Flatpickr
            const appointmentField = document.getElementById('userAppointmentDate');
            if (appointmentField && appointmentField._flatpickr) {
                appointmentField._flatpickr.destroy();
            }
            
            // Reinitialize DOB Flatpickr after clearing
            setTimeout(() => {
                initializeUserDOBFlatpickr();
            }, 100);
        }

        // Enhanced refresh functions with scroll position preservation
        function refreshCurrentAdminSection() {
            const scrollPosition = document.getElementById('adminContent')?.scrollTop || 0;
            
            // Call the appropriate section refresh function
            switch(currentAdminSection) {
                case 'users':
                    showUserManagement();
                    break;
                case 'designations':
                    showAdminDesignations();
                    break;
                case 'logs':
                    showUserLogs();
                    break;
                case 'system':
                    showSystemSettings();
                    break;
                default:
                    showUserManagement();
            }
            
            // Restore scroll position
            setTimeout(() => {
                const adminContent = document.getElementById('adminContent');
                if (adminContent) {
                    adminContent.scrollTop = scrollPosition;
                }
            }, 100);
        }
        
        function updateAdminUserDesignationDropdown() {
            const designationSelect = document.getElementById('userDesignation');
            if (designationSelect) {
                // Only show admin designations in admin portal
                const activeAdminDesignations = adminDesignations.filter(d => d.is_active !== false);
                designationSelect.innerHTML = `
                    <option value="">Select Designation</option>
                    ${activeAdminDesignations.map(designation => 
                        `<option value="${designation.name}">${designation.name}</option>`
                    ).join('')}
                `;
            }
        }

        // Admin Designations Management
        function showAdminDesignations() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="content-header">
                    <h3>Admin Designations Management</h3>
                    <p>Manage job designations for admin portal user creation (separate from user portal)</p>
                </div>
                
                <div class="section-header">
                    <div class="section-header-left">
                        <h4>Admin Portal Designations (<span id="adminDesignationCount">${adminDesignations.length}</span> records)</h4>
                    </div>
                    <div class="section-header-right">
                        <button class="btn btn-primary" onclick="openAdminDesignationModal()">
                            <span class="btn-icon">+</span>
                            Add Admin Designation
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Designation Name</th>
                                <th>Department</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminDesignationsTableBody">
                            ${adminDesignations.length === 0 ? '<tr><td colspan="4" class="loading">No admin designations found. Click "Add Admin Designation" to create your first designation.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #1976d2; border-radius: 8px;">
                    <p style="margin: 0; color: #666; font-size: 14px;">
                        <strong>Note:</strong> These designations are only used in the Admin Portal for "Create New User" functionality. 
                        They are completely separate from User Portal designations and do not affect each other.
                    </p>
                </div>
            `;
            
            const tbody = document.getElementById('adminDesignationsTableBody');
            if (adminDesignations.length > 0) {
                tbody.innerHTML = adminDesignations.map(designation => `
                    <tr>
                        <td><strong>${designation.name}</strong></td>
                        <td>${designation.department || 'Not specified'}</td>
                        <td>${designation.description || 'No description'}</td>
                        <td>
                            <button class="btn btn-success btn-small" onclick="editAdminDesignation(${designation.id})" title="Edit Designation">
                                Edit
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteAdminDesignation(${designation.id})" title="Delete Designation">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
        }
        
        function openAdminDesignationModal(designation = null) {
            const isEdit = designation !== null;
            const modalTitle = isEdit ? 'Edit Admin Designation' : 'Add New Admin Designation';
            const modalSubtitle = isEdit ? 'Update designation details for admin portal users' : 'Create and manage job designations for admin portal users';
            
            // Create or get admin designation modal element
            let adminDesignationModal = document.getElementById('adminDesignationModal');
            if (!adminDesignationModal) {
                adminDesignationModal = document.createElement('div');
                adminDesignationModal.id = 'adminDesignationModal';
                adminDesignationModal.className = 'professional-modal';
                document.body.appendChild(adminDesignationModal);
            }
            
            adminDesignationModal.innerHTML = `
                <div class="professional-modal-header">
                    <div class="professional-modal-header-content">
                        <div class="professional-modal-icon">üè∑Ô∏è</div>
                        <h2 class="professional-modal-title">${modalTitle}</h2>
                        <p class="professional-modal-subtitle">${modalSubtitle}</p>
                    </div>
                </div>
                
                <form id="adminDesignationForm" onsubmit="saveAdminDesignationFromForm(event)">
                    <input type="hidden" id="adminDesignationId" value="${isEdit ? designation.id : ''}">
                    
                    <div class="professional-modal-body">
                        <div class="professional-form-group">
                            <label for="adminDesignationNameInput" class="professional-form-label required">Designation Name</label>
                            <input type="text" id="adminDesignationNameInput" class="professional-form-input" required 
                                   placeholder="Enter designation name (e.g., System Administrator, Data Entry Operator)" 
                                   style="text-transform: capitalize;"
                                   value="${isEdit ? designation.name : ''}"
                                   pattern="[A-Za-z\s]+"
                                   onkeypress="return /[a-zA-Z\s]/.test(event.key)"
                                   oninput="this.value = this.value.replace(/[^a-zA-Z\s]/g, '')"
                                   title="Please enter letters and spaces only">
                        </div>
                        
                        <div class="professional-form-group">
                            <label for="adminDesignationDepartmentInput" class="professional-form-label">Department</label>
                            <select id="adminDesignationDepartmentInput" class="professional-form-input">
                                <option value="">Select Department</option>
                                <option value="Administration" ${isEdit && designation.department === 'Administration' ? 'selected' : ''}>Administration</option>
                                <option value="Engineering" ${isEdit && designation.department === 'Engineering' ? 'selected' : ''}>Engineering</option>
                                <option value="Finance" ${isEdit && designation.department === 'Finance' ? 'selected' : ''}>Finance</option>
                                <option value="IT" ${isEdit && designation.department === 'IT' ? 'selected' : ''}>Information Technology</option>
                                <option value="HR" ${isEdit && designation.department === 'HR' ? 'selected' : ''}>Human Resources</option>
                                <option value="Security" ${isEdit && designation.department === 'Security' ? 'selected' : ''}>Security</option>
                                <option value="Other" ${isEdit && designation.department === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        
                        <div class="professional-form-group">
                            <label for="adminDesignationDescriptionInput" class="professional-form-label">Description</label>
                            <textarea id="adminDesignationDescriptionInput" class="professional-form-input" 
                                      placeholder="Brief description of the role and responsibilities (optional)"
                                      rows="3">${isEdit ? (designation.description || '') : ''}</textarea>
                        </div>
                    </div>
                    
                    <div class="professional-modal-footer">
                        <button type="button" class="professional-btn professional-btn-secondary" onclick="closeAdminDesignationModal()">Cancel</button>
                        <button type="submit" class="professional-btn professional-btn-primary">
                            ${isEdit ? 'Update' : 'Save'} Admin Designation
                        </button>
                    </div>
                </form>
            `;
            
            // Show the modal using the professional modal system
            openProfessionalModal('adminDesignationModal');
        }
        
        function closeAdminDesignationModal() {
            closeProfessionalModal('adminDesignationModal');
        }
        
        function saveAdminDesignationFromForm(event) {
            event.preventDefault();
            
            const designationId = document.getElementById('adminDesignationId').value || null;
            const name = document.getElementById('adminDesignationNameInput').value.trim();
            const department = document.getElementById('adminDesignationDepartmentInput').value;
            const description = document.getElementById('adminDesignationDescriptionInput').value.trim();
            
            if (!name) {
                alert('Please enter a designation name.');
                document.getElementById('adminDesignationNameInput').focus();
                return;
            }
            
            // Check for duplicate names in admin designations only (excluding current record if editing)
            const isDuplicate = adminDesignations.some(d => 
                d.name.toLowerCase() === name.toLowerCase() && d.id != designationId
            );
            
            if (isDuplicate) {
                alert('An admin designation with this name already exists. Please use a different name.');
                document.getElementById('adminDesignationNameInput').focus();
                return;
            }
            
            const designationData = {
                name: name,
                department: department || null,
                description: description || null,
                is_active: true,
                updated_at: new Date().toISOString()
            };
            
            if (designationId) {
                // Update existing admin designation
                const index = adminDesignations.findIndex(d => d.id == designationId);
                if (index !== -1) {
                    adminDesignations[index] = { ...adminDesignations[index], ...designationData };
                }
            } else {
                // Add new admin designation
                const newDesignation = {
                    id: Math.max(...adminDesignations.map(d => d.id), 0) + 1,
                    ...designationData,
                    created_at: new Date().toISOString()
                };
                adminDesignations.push(newDesignation);
            }
            
            // Save admin designations to localStorage
            saveAdminDesignationsToStorage();
            
            // Update dropdown in admin user creation form
            updateAdminUserDesignationDropdown();
            
            // Close modal
            closeAdminDesignationModal();
            
            // Refresh the admin designations view
            showAdminDesignations();
            
            // Show success message
            const action = designationId ? 'updated' : 'created';
            showSuccessModal("Admin Designation Saved", `Admin designation <strong>"${name}"</strong> has been ${action} successfully!`);
        }
        
        
        function editAdminDesignation(id) {
            const designation = adminDesignations.find(d => d.id === id);
            if (designation) {
                openAdminDesignationModal(designation);
            }
        }
        
        function deleteAdminDesignation(id) {
            const designation = adminDesignations.find(d => d.id === id);
            if (!designation) return;
            
            // Check if designation is being used by any admin portal users only
            const usedInAdminUsers = users.filter(user => user.designation === designation.name);
            if (usedInAdminUsers.length > 0) {
                const userList = usedInAdminUsers.map(user => 
                    `‚Ä¢ ${user.fullName} (${user.username})`
                ).join('<br>');
                
                showErrorModal(
                    "Cannot Delete Admin Designation", 
                    `This designation is currently assigned to <strong>${usedInAdminUsers.length}</strong> admin user(s):<br><br><div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #dc3545; margin: 10px 0; font-family: 'Courier New', monospace; font-size: 14px;">${userList}</div><br>Please reassign these admin users to a different designation before deleting.`
                );
                return;
            }
            
            // Show delete confirmation modal
            showDeleteConfirmationModal(
                designation.name,
                `Are you sure you want to delete the admin designation <strong>"${designation.name}"</strong>?<br><br>This action cannot be undone and will only affect Admin Portal users.`,
                async () => {
                    try {
                        // Make API call to delete from backend database
                        const response = await fetch(`/api/admin-designations/${id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            // Only update frontend after successful backend deletion
                            adminDesignations = adminDesignations.filter(d => d.id !== id);
                            localStorage.setItem('cantonment_admin_designations', JSON.stringify(adminDesignations));
                            
                            // Update dropdown in admin user creation form
                            updateAdminUserDesignationDropdown();
                            
                            // Refresh the admin designations view
                            showAdminDesignations();
                            
                            // Show success message
                            showSuccessModal("Admin Designation Deleted", `Admin designation <strong>"${designation.name}"</strong> has been deleted successfully from database!`);
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete admin designation');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        alert('Failed to delete admin designation: ' + error.message);
                    }
                }
            );
        }
        
        // Enhanced modal functions for better UI
        function showDeleteConfirmationModal(itemName, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            `;
            modal.innerHTML = `
                <div class="confirm-modal-content" style="
                    max-width: 450px;
                    width: 90%;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    animation: modalSlideIn 0.3s ease-out;
                    margin: 20px;
                ">
                    <div style="text-align: center; padding: 30px;">
                        <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px auto; box-shadow: 0 8px 25px rgba(238, 90, 90, 0.3);">
                            <span style="font-size: 32px; color: white;">üóëÔ∏è</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 24px; font-weight: 600;">Delete Confirmation</h3>
                        <div style="color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px;">
                            ${message}
                        </div>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button onclick="this.closest('.modal').remove()" 
                                    style="padding: 12px 30px; border: 2px solid #e0e6ed; background: white; color: #666; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 14px;"
                                    onmouseover="this.style.background='#f8f9fa'; this.style.borderColor='#dee2e6';"
                                    onmouseout="this.style.background='white'; this.style.borderColor='#e0e6ed';">
                                Cancel
                            </button>
                            <button onclick="(${onConfirm.toString()})(); this.closest('.modal').remove()"
                                    style="padding: 12px 30px; background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 4px 15px rgba(238, 90, 90, 0.4);"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(238, 90, 90, 0.5)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(238, 90, 90, 0.4)';">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Close modal on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function showErrorModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            `;
            modal.innerHTML = `
                <div class="confirm-modal-content" style="
                    max-width: 500px;
                    width: 90%;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    animation: modalSlideIn 0.3s ease-out;
                    margin: 20px;
                ">
                    <div style="text-align: center; padding: 30px;">
                        <div style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px auto; box-shadow: 0 8px 25px rgba(238, 90, 90, 0.3);">
                            <span style="font-size: 32px; color: white;">‚ùå</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 24px; font-weight: 600;">${title}</h3>
                        <div style="color: #666; line-height: 1.6; margin-bottom: 30px; text-align: left; font-size: 15px;">
                            ${message}
                        </div>
                        <button onclick="this.closest('.modal').remove()" 
                                style="padding: 12px 40px; background: linear-gradient(135deg, #1976d2, #42a5f5); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(25, 118, 210, 0.5)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(25, 118, 210, 0.4)';">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            // Close modal on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function showSuccessModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
            `;
            modal.innerHTML = `
                <div class="confirm-modal-content" style="
                    max-width: 450px;
                    width: 90%;
                    background: white;
                    border-radius: 15px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    animation: modalSlideIn 0.3s ease-out;
                    margin: 20px;
                ">
                    <div style="text-align: center; padding: 30px;">
                        <div style="background: linear-gradient(135deg, #4caf50, #45a049); width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px auto; box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);">
                            <span style="font-size: 32px; color: white;">‚úÖ</span>
                        </div>
                        <h3 style="color: #2c3e50; margin-bottom: 20px; font-size: 24px; font-weight: 600;">${title}</h3>
                        <div style="color: #666; line-height: 1.6; margin-bottom: 30px; font-size: 16px;">
                            ${message}
                        </div>
                        <button onclick="this.closest('.modal').remove()" 
                                style="padding: 12px 40px; background: linear-gradient(135deg, #4caf50, #45a049); color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s ease; font-size: 14px; box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(76, 175, 80, 0.5)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(76, 175, 80, 0.4)';">
                            OK
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-close after 3 seconds
            setTimeout(() => {
                if (document.body.contains(modal)) {
                    modal.remove();
                }
            }, 3000);
            
            // Close modal on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            document.body.appendChild(modal);
        }
        
        function showSystemSettings() {
            const content = document.getElementById('adminContent');
            
            // Calculate storage usage
            let storageUsage = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    storageUsage += localStorage[key].length;
                }
            }
            const storageUsageKB = Math.round(storageUsage / 1024);
            const storageUsageMB = (storageUsageKB / 1024).toFixed(2);
            const storagePercentage = Math.min((storageUsageKB / 10240) * 100, 100); // Assuming 10MB limit
            
            // Count records in different categories
            const attendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]').length;
            const leaveApplications = JSON.parse(localStorage.getItem('leaveApplications') || '[]').length;
            const payslipRecords = Object.keys(JSON.parse(localStorage.getItem('payslipData') || '{}')).length;
            
            // Check for orphaned records
            const currentStaffIds = admissions.map(staff => staff.staffId).filter(id => id);
            const orphanedAttendance = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]')
                .filter(record => !currentStaffIds.includes(record.staffId)).length;
            const orphanedLeave = JSON.parse(localStorage.getItem('leaveApplications') || '[]')
                .filter(leave => !admissions.some(staff => staff.id === leave.staffId)).length;
            const totalOrphaned = orphanedAttendance + orphanedLeave;
            
            // System health status
            const systemHealth = totalOrphaned === 0 ? 'Excellent' : totalOrphaned < 5 ? 'Good' : 'Needs Attention';
            const healthClass = totalOrphaned === 0 ? 'success' : totalOrphaned < 5 ? 'info' : 'warning';
            
            // Admin users count
            const adminUsers = users.filter(user => user.permissions && Object.keys(user.permissions).length > 0).length;
            
            content.innerHTML = `
                <style>
                    .modern-system-settings * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }

                    .modern-system-settings {
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                        background: #f8fafc;
                        color: #1e293b;
                        line-height: 1.6;
                        padding: 1rem;
                        border-radius: 16px;
                    }

                    .settings-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 2rem;
                        border-radius: 16px;
                        margin-bottom: 2rem;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                    }

                    .settings-header h1 {
                        font-size: 2.5rem;
                        font-weight: 700;
                        margin-bottom: 0.5rem;
                    }

                    .settings-header p {
                        font-size: 1.1rem;
                        opacity: 0.9;
                    }

                    .settings-dashboard-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                        gap: 2rem;
                        margin-bottom: 2rem;
                    }

                    .settings-card {
                        background: white;
                        border-radius: 16px;
                        padding: 2rem;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                        border: 1px solid #e2e8f0;
                        transition: all 0.3s ease;
                    }

                    .settings-card:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                    }

                    .settings-card-header {
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin-bottom: 1.5rem;
                    }

                    .settings-card-icon {
                        width: 48px;
                        height: 48px;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 1.5rem;
                        color: white;
                    }

                    .settings-card-icon.blue { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
                    .settings-card-icon.green { background: linear-gradient(135deg, #10b981, #059669); }
                    .settings-card-icon.amber { background: linear-gradient(135deg, #f59e0b, #d97706); }
                    .settings-card-icon.red { background: linear-gradient(135deg, #ef4444, #dc2626); }
                    .settings-card-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
                    .settings-card-icon.indigo { background: linear-gradient(135deg, #6366f1, #4f46e5); }

                    .settings-card-title {
                        font-size: 1.25rem;
                        font-weight: 600;
                        color: #1e293b;
                    }

                    .settings-stat-grid {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 1rem;
                    }

                    .settings-stat-item {
                        padding: 1rem;
                        background: #f8fafc;
                        border-radius: 8px;
                        border: 1px solid #e2e8f0;
                    }

                    .settings-stat-label {
                        font-size: 0.875rem;
                        color: #64748b;
                        margin-bottom: 0.25rem;
                    }

                    .settings-stat-value {
                        font-size: 1.5rem;
                        font-weight: 700;
                        color: #1e293b;
                    }

                    .settings-button-group {
                        display: flex;
                        flex-direction: column;
                        gap: 0.75rem;
                    }

                    .settings-btn {
                        padding: 0.75rem 1.5rem;
                        border: none;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        justify-content: center;
                        text-decoration: none;
                        font-size: 0.9rem;
                    }

                    .settings-btn-primary {
                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                        color: white;
                    }

                    .settings-btn-primary:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                    }

                    .settings-btn-secondary {
                        background: #f1f5f9;
                        color: #475569;
                        border: 1px solid #e2e8f0;
                    }

                    .settings-btn-secondary:hover {
                        background: #e2e8f0;
                    }

                    .settings-btn-warning {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                    }

                    .settings-btn-warning:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                    }

                    .settings-btn-danger {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                    }

                    .settings-btn-danger:hover {
                        transform: translateY(-1px);
                        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
                    }

                    .settings-alert {
                        padding: 1rem;
                        border-radius: 8px;
                        margin-bottom: 1rem;
                        border-left: 4px solid;
                    }

                    .settings-alert-warning {
                        background: #fef3c7;
                        border-color: #f59e0b;
                        color: #92400e;
                    }

                    .settings-alert-danger {
                        background: #fee2e2;
                        border-color: #ef4444;
                        color: #991b1b;
                    }

                    .settings-alert-info {
                        background: #dbeafe;
                        border-color: #3b82f6;
                        color: #1e40af;
                    }

                    .settings-progress-bar {
                        width: 100%;
                        height: 8px;
                        background: #e2e8f0;
                        border-radius: 4px;
                        overflow: hidden;
                        margin-top: 0.5rem;
                    }

                    .settings-progress-fill {
                        height: 100%;
                        background: linear-gradient(90deg, #10b981, #059669);
                        border-radius: 4px;
                        transition: width 0.3s ease;
                    }

                    .settings-badge {
                        display: inline-block;
                        padding: 0.25rem 0.75rem;
                        border-radius: 6px;
                        font-size: 0.75rem;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                    }

                    .settings-badge-success {
                        background: #dcfce7;
                        color: #166534;
                    }

                    .settings-badge-info {
                        background: #dbeafe;
                        color: #1e40af;
                    }

                    .settings-badge-warning {
                        background: #fef3c7;
                        color: #92400e;
                    }

                    .version-info {
                        text-align: center;
                        margin-top: 1rem;
                        background: white;
                        padding: 1.5rem;
                        border-radius: 16px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
                        border: 1px solid #e2e8f0;
                    }

                    @media (max-width: 768px) {
                        .settings-dashboard-grid {
                            grid-template-columns: 1fr;
                        }
                        
                        .settings-stat-grid {
                            grid-template-columns: 1fr;
                        }
                        
                        .settings-header h1 {
                            font-size: 2rem;
                        }
                    }
                </style>

                <div class="modern-system-settings">
                    <!-- Header -->
                    <div class="settings-header">
                        <h1>‚öôÔ∏è System Settings</h1>
                        <p>Manage your system configuration, monitor performance, and maintain data integrity</p>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="settings-dashboard-grid">
                        <!-- System Overview -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon blue">üìä</div>
                                <div class="settings-card-title">System Overview</div>
                            </div>
                            <div class="settings-stat-grid">
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Total Users</div>
                                    <div class="settings-stat-value">${users.length}</div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Active Staff</div>
                                    <div class="settings-stat-value">${admissions.length}</div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Storage Used</div>
                                    <div class="settings-stat-value">${storageUsageMB} MB</div>
                                    <div class="settings-progress-bar">
                                        <div class="settings-progress-fill" style="width: ${storagePercentage}%"></div>
                                    </div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">System Health</div>
                                    <div class="settings-stat-value">
                                        <span class="settings-badge settings-badge-${healthClass}">${systemHealth}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Analytics -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon green">üìà</div>
                                <div class="settings-card-title">Data Analytics</div>
                            </div>
                            <div class="settings-stat-grid">
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Attendance Records</div>
                                    <div class="settings-stat-value">${attendanceRecords}</div>
                                    <div style="font-size: 10px; color: #666; margin-top: 5px;">
                                        <button onclick="debugAttendanceRecords()" style="font-size: 10px; padding: 2px 5px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">Debug Records</button>
                                    </div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Leave Applications</div>
                                    <div class="settings-stat-value">${leaveApplications}</div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Payslip Records</div>
                                    <div class="settings-stat-value">${payslipRecords}</div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Orphaned Records</div>
                                    <div class="settings-stat-value">
                                        <span class="settings-badge ${totalOrphaned > 0 ? 'settings-badge-warning' : 'settings-badge-success'}">${totalOrphaned}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Data Maintenance -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon amber">üßπ</div>
                                <div class="settings-card-title">Data Maintenance</div>
                            </div>
                            ${totalOrphaned > 0 ? `
                                <div class="settings-alert settings-alert-warning">
                                    <strong>Maintenance Recommended:</strong> ${totalOrphaned} orphaned records detected
                                </div>
                            ` : `
                                <div class="settings-alert settings-alert-info">
                                    <strong>System Clean:</strong> No orphaned records found
                                </div>
                            `}
                            <div class="settings-button-group">
                                <button class="settings-btn settings-btn-warning" onclick="cleanupOrphanedRecords()">
                                    üóëÔ∏è Clean Orphaned Data
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('Data Integrity Analysis')">
                                    üîç Analyze Data Integrity
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('System Health Report')">
                                    üìä Generate Health Report
                                </button>
                            </div>
                        </div>

                        <!-- Backup & Export -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon purple">üíæ</div>
                                <div class="settings-card-title">Backup & Export</div>
                            </div>
                            <div class="settings-button-group">
                                <button class="settings-btn settings-btn-primary" onclick="exportAllData()">
                                    üì§ Export Complete Database
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="exportStaffData()">
                                    üë• Export Staff Data Only
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="exportAttendanceData()">
                                    üìã Export Attendance Records
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('Payslip Data Export')">
                                    üìÑ Export Payslip Data
                                </button>
                            </div>
                        </div>

                        <!-- Security & Access -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon indigo">üîê</div>
                                <div class="settings-card-title">Security & Access</div>
                            </div>
                            <div class="settings-stat-grid">
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Admin Users</div>
                                    <div class="settings-stat-value">${adminUsers}</div>
                                </div>
                                <div class="settings-stat-item">
                                    <div class="settings-stat-label">Last Login</div>
                                    <div class="settings-stat-value">Now</div>
                                </div>
                            </div>
                            <div class="settings-button-group" style="margin-top: 1rem;">
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('Access Logs Viewer')">
                                    üëÅÔ∏è View Access Logs
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('Permission Management')">
                                    üîë Manage Permissions
                                </button>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <div class="settings-card">
                            <div class="settings-card-header">
                                <div class="settings-card-icon red">‚ö†Ô∏è</div>
                                <div class="settings-card-title">Danger Zone</div>
                            </div>
                            <div class="settings-alert settings-alert-danger">
                                <strong>Warning:</strong> These actions cannot be undone and will permanently delete data
                            </div>
                            <div class="settings-button-group">
                                <button class="settings-btn settings-btn-danger" onclick="resetAllData()">
                                    üóëÔ∏è Reset All Data
                                </button>
                                <button class="settings-btn settings-btn-danger" onclick="clearAllStorage()">
                                    üí• Clear All Storage
                                </button>
                                <button class="settings-btn settings-btn-secondary" onclick="showComingSoonModal('Factory Reset')">
                                    üîß Factory Reset
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Version Info -->
                    <div class="version-info">
                        <p style="color: #64748b;">
                            <strong>Cantonment Board Ambala Portal</strong> v2.2.0 
                            <span class="settings-badge settings-badge-info">Latest</span>
                        </p>
                        <p style="color: #94a3b8; font-size: 0.875rem; margin-top: 0.5rem;">
                            Last updated: September 12, 2025 ‚Ä¢ Built with ‚ù§Ô∏è for efficient administration
                        </p>
                    </div>
                </div>
            `;
        }
        
        // Export functions for system settings
        function exportAllData() {
            const allData = {
                users: users,
                admissions: admissions,
                attendanceRecords: JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]'),
                leaveApplications: JSON.parse(localStorage.getItem('leaveApplications') || '[]'),
                payslipData: JSON.parse(localStorage.getItem('payslipData') || '{}'),
                leaveBalances: JSON.parse(localStorage.getItem('leaveBalances') || '{}'),
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(allData, `CBA_Complete_Data_${new Date().toISOString().split('T')[0]}.json`);
            alert('‚úÖ All data exported successfully!');
        }
        
        function exportAttendanceData() {
            const attendanceData = {
                attendanceRecords: JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(attendanceData, `CBA_Attendance_Data_${new Date().toISOString().split('T')[0]}.json`);
            alert('‚úÖ Attendance data exported successfully!');
        }
        
        function exportStaffData() {
            const staffData = {
                admissions: admissions,
                exportDate: new Date().toISOString()
            };
            
            downloadJSON(staffData, `CBA_Staff_Data_${new Date().toISOString().split('T')[0]}.json`);
            alert('‚úÖ Staff data exported successfully!');
        }
        
        function downloadJSON(data, filename) {
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = filename;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function resetAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL data including staff records, attendance, leave applications, and payslips.\n\nThis action CANNOT be undone!\n\nType "RESET" to confirm:') === true) {
                const confirmation = prompt('Please type "RESET" to confirm complete data deletion:');
                if (confirmation === 'RESET') {
                    // Clear all localStorage data
                    const keys = ['cantonment_admissions', 'cantonment_users', 'savedAttendanceRecords', 
                                  'leaveApplications', 'payslipData', 'leaveBalances', 'staffDeductions', 
                                  'staffAllowances', 'staffAttendanceRecords', 'staffLeaveHistory', 'staffDocuments'];
                    
                    keys.forEach(key => localStorage.removeItem(key));
                    
                    // Reset global variables
                    admissions = [];
                    users = [];
                    
                    alert('üóëÔ∏è All data has been permanently deleted. The system will now reload.');
                    location.reload();
                }
            }
        }
        
        function clearAllStorage() {
            if (confirm('‚ö†Ô∏è WARNING: This will clear ALL browser storage including login sessions.\n\nYou will be logged out and all data will be lost!\n\nAre you sure?')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('üóëÔ∏è All storage cleared. The page will now reload.');
                location.reload();
            }
        }
        
        // Professional "Coming Soon" modal
        function showComingSoonModal(featureName) {
            // Remove any existing modal
            const existingModal = document.getElementById('comingSoonModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHTML = `
                <div id="comingSoonModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    backdrop-filter: blur(4px);
                ">
                    <div style="
                        background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 500px;
                        margin: 20px;
                        text-align: center;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                        transform: scale(0.95);
                        animation: modalSlideIn 0.3s ease-out forwards;
                        position: relative;
                    ">
                        <!-- Close Button -->
                        <button onclick="closeComingSoonModal()" style="
                            position: absolute;
                            top: 15px;
                            right: 15px;
                            background: #f1f5f9;
                            border: none;
                            border-radius: 50%;
                            width: 35px;
                            height: 35px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #64748b;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                            ‚úï
                        </button>
                        
                        <!-- Icon -->
                        <div style="
                            width: 80px;
                            height: 80px;
                            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                            border-radius: 50%;
                            margin: 0 auto 1.5rem auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 2rem;
                            color: white;
                        ">
                            üöÄ
                        </div>
                        
                        <!-- Content -->
                        <h2 style="
                            font-size: 1.75rem;
                            font-weight: 700;
                            color: #1e293b;
                            margin-bottom: 1rem;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                        ">Coming Soon!</h2>
                        
                        <p style="
                            color: #64748b;
                            font-size: 1.1rem;
                            margin-bottom: 0.5rem;
                            line-height: 1.6;
                        ">
                            <strong style="color: #1e293b;">${featureName}</strong> is currently under development.
                        </p>
                        
                        <p style="
                            color: #94a3b8;
                            font-size: 0.9rem;
                            margin-bottom: 2rem;
                            line-height: 1.5;
                        ">
                            We're working hard to bring you this feature. It will be available in a future update.
                        </p>
                        
                        <!-- Features List -->
                        <div style="
                            background: #f8fafc;
                            border-radius: 12px;
                            padding: 1.5rem;
                            margin-bottom: 2rem;
                            text-align: left;
                        ">
                            <h4 style="
                                color: #1e293b;
                                font-size: 0.9rem;
                                font-weight: 600;
                                margin-bottom: 1rem;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                                text-align: center;
                            ">What's Coming</h4>
                            
                            <ul style="
                                list-style: none;
                                padding: 0;
                                margin: 0;
                                color: #64748b;
                                font-size: 0.9rem;
                            ">
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center;">
                                    <span style="color: #10b981; margin-right: 0.75rem;">‚úì</span>
                                    Enhanced user experience
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center;">
                                    <span style="color: #10b981; margin-right: 0.75rem;">‚úì</span>
                                    Advanced reporting capabilities
                                </li>
                                <li style="margin-bottom: 0.75rem; display: flex; align-items: center;">
                                    <span style="color: #10b981; margin-right: 0.75rem;">‚úì</span>
                                    Real-time data processing
                                </li>
                                <li style="display: flex; align-items: center;">
                                    <span style="color: #10b981; margin-right: 0.75rem;">‚úì</span>
                                    Improved system performance
                                </li>
                            </ul>
                        </div>
                        
                        <!-- Action Button -->
                        <button onclick="closeComingSoonModal()" style="
                            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                            color: white;
                            border: none;
                            border-radius: 12px;
                            padding: 0.75rem 2rem;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s;
                            font-size: 0.95rem;
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            Got it, thanks!
                        </button>
                    </div>
                </div>
                
                <style>
                    @keyframes modalSlideIn {
                        from {
                            transform: scale(0.95);
                            opacity: 0;
                        }
                        to {
                            transform: scale(1);
                            opacity: 1;
                        }
                    }
                </style>
            `;
            
            // Add modal to DOM
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
            
            // Close on overlay click
            document.getElementById('comingSoonModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeComingSoonModal();
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeComingSoonModal();
                }
            });
        }
        
        function closeComingSoonModal() {
            const modal = document.getElementById('comingSoonModal');
            if (modal) {
                modal.style.animation = 'modalSlideOut 0.2s ease-in forwards';
                setTimeout(() => {
                    modal.remove();
                    document.body.style.overflow = '';
                }, 200);
            }
        }
        
        // Close all modals function
        function closeAllModals() {
            // Close regular modals
            const modalIds = ['userModal', 'deleteModal', 'customModal', 'confirmModal'];
            modalIds.forEach(id => {
                const modal = document.getElementById(id);
                if (modal) {
                    modal.style.display = 'none';
                }
            });
            
            // Also close professional modals
            closeAllProfessionalModals();
        }
        
        // User modal functions
        function openUserModal(user = null) {
            console.log('openUserModal called with user:', user);
            
            const modal = document.getElementById('userModal');
            const title = document.getElementById('userModalTitle');
            const form = document.getElementById('userForm');
            
            console.log('Modal element:', modal);
            
            if (!modal) {
                console.error('userModal element not found!');
                alert('Error: User modal not found. Please refresh the page.');
                return;
            }
            
            // Reset form scroll position first
            if (form) {
                form.scrollTop = 0;
            }
            
            if (user) {
                title.textContent = 'Edit User';
                document.getElementById('userId').value = user.id;
                document.getElementById('userFullName').value = user.fullName;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = user.password;
                document.getElementById('userConfirmPassword').value = user.password;
                document.getElementById('userEmail').value = user.email || '';
                
                // Set new fields
                // DOB will be set via Flatpickr to ensure proper format consistency
                document.getElementById('userDOB').value = '';
                document.getElementById('userAge').value = user.age || '';
                document.getElementById('userGender').value = user.gender || '';
                document.getElementById('userFatherName').value = user.fatherName || '';
                document.getElementById('userMotherName').value = user.motherName || '';
                document.getElementById('userGrandFatherName').value = user.grandFatherName || '';
                document.getElementById('userAddress').value = user.address || '';
                document.getElementById('userMobile').value = user.mobile || '';
                document.getElementById('userDesignation').value = user.designation || '';
                // Appointment date will be set via Flatpickr in setTimeout to ensure proper format
                document.getElementById('userAppointmentDate').value = '';
                document.getElementById('userAadhar').value = user.aadharNumber || '';
                document.getElementById('userPAN').value = user.panNumber || '';
                
                // Set marital status and spouse name
                document.getElementById('userMaritalStatus').value = user.maritalStatus || '';
                document.getElementById('userSpouseName').value = user.spouseName || '';
                
                // Show/hide spouse name field based on marital status
                if (user.maritalStatus && user.maritalStatus !== 'Un-Married') {
                    document.getElementById('spouseNameGroup').style.display = 'block';
                    document.getElementById('addChildButton').disabled = false;
                    document.getElementById('addChildButton').style.opacity = '1';
                    document.getElementById('addChildButton').style.cursor = 'pointer';
                    document.getElementById('addChildButton').title = '';
                } else {
                    document.getElementById('spouseNameGroup').style.display = 'none';
                    document.getElementById('addChildButton').disabled = true;
                    document.getElementById('addChildButton').style.opacity = '0.5';
                    document.getElementById('addChildButton').style.cursor = 'not-allowed';
                    document.getElementById('addChildButton').title = 'Please select marital status first';
                }
                
                // Load children if they exist
                if (user.children && user.children.length > 0) {
                    const childrenList = document.getElementById('userChildrenList');
                    childrenList.innerHTML = '';
                    user.children.forEach((child, index) => {
                        const childDiv = document.createElement('div');
                        childDiv.className = 'child-item';
                        childDiv.style.cssText = 'padding: 10px; margin-bottom: 10px; background: #f5f5f5; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;';
                        childDiv.innerHTML = `
                            <span>${child.name} (${child.gender}, ${child.age} years)</span>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeChild(${index})">Remove</button>
                        `;
                        childrenList.appendChild(childDiv);
                    });
                } else {
                    document.getElementById('userChildrenList').innerHTML = '<div class="empty-children-message" style="color: #666; font-style: italic; margin-bottom: 10px;">No children added yet</div>';
                }
                
                document.getElementById('userStatus').value = user.status;
                
                // Load existing permissions using new system
                loadUserPermissions(user);
                
                // Calculate age if DOB is present
                calculateAge();
                
                // Populate admin designations dropdown
                updateAdminUserDesignationDropdown();
                
                // Set date fields using Flatpickr to ensure proper format consistency
                setTimeout(() => {
                    // Set DOB using Flatpickr
                    if (user.dateOfBirth) {
                        const dobField = document.getElementById('userDOB');
                        if (dobField && dobField._flatpickr) {
                            dobField._flatpickr.setDate(user.dateOfBirth, true);
                        }
                    }
                    
                    // Enable and set appointment date if DOB is set
                    setTimeout(() => {
                        if (user.dateOfBirth) {
                            enableAppointmentDateField();
                            updateAppointmentDateMinimum();
                            
                            // Set appointment date using Flatpickr to ensure proper format
                            if (user.appointmentDate) {
                                const appointmentField = document.getElementById('userAppointmentDate');
                                if (appointmentField && appointmentField._flatpickr) {
                                    appointmentField._flatpickr.setDate(user.appointmentDate, true);
                                }
                            }
                        }
                    }, 50);
                }, 150);
            } else {
                title.textContent = 'Create New User';
                
                // Comprehensive form reset for new user creation
                form.reset();
                
                // Explicitly clear all form fields to ensure no residual data
                document.getElementById('userId').value = '';
                document.getElementById('userFullName').value = '';
                document.getElementById('userUsername').value = '';
                document.getElementById('userPassword').value = '';
                document.getElementById('userConfirmPassword').value = '';
                document.getElementById('userEmail').value = '';
                document.getElementById('userStatus').value = 'active';
                
                // Clear all new fields explicitly
                document.getElementById('userDOB').value = '';
                document.getElementById('userAge').value = '';
                document.getElementById('userGender').value = '';
                document.getElementById('userFatherName').value = '';
                document.getElementById('userMotherName').value = '';
                document.getElementById('userGrandFatherName').value = '';
                document.getElementById('userAddress').value = '';
                document.getElementById('userMobile').value = '';
                document.getElementById('userDesignation').value = '';
                document.getElementById('userAppointmentDate').value = '';
                document.getElementById('userAadhar').value = '';
                document.getElementById('userPAN').value = '';
                
                // Reset marital status fields
                const maritalStatus = document.getElementById('userMaritalStatus');
                const spouseName = document.getElementById('userSpouseName');
                if (maritalStatus) maritalStatus.value = '';
                if (spouseName) {
                    spouseName.value = '';
                    spouseName.style.display = 'none';
                }
                
                // Clear children section
                document.getElementById('userChildrenList').innerHTML = '<div class="empty-children-message" style="color: #666; font-style: italic; margin-bottom: 10px;">No children added yet</div>';
                
                // Reset permissions using new system
                loadUserPermissions({});
                
                // Disable appointment date field until DOB is selected
                const appointmentDateField = document.getElementById('userAppointmentDate');
                if (appointmentDateField) {
                    appointmentDateField.disabled = true;
                    appointmentDateField.style.cursor = 'not-allowed';
                    appointmentDateField.style.opacity = '0.5';
                    appointmentDateField.title = 'Please select Date of Birth first';
                }
                
                // Reset age field display
                const ageField = document.getElementById('userAge');
                if (ageField) {
                    ageField.style.opacity = '0.5';
                    ageField.style.cursor = 'not-allowed';
                    ageField.disabled = true;
                    ageField.title = 'Auto-calculated from Date of Birth';
                }
                
                // Clear any Flatpickr instances and reinitialize them
                clearAndReinitializeFlatpickr();
                
                // Populate admin designations dropdown for new users
                updateAdminUserDesignationDropdown();
            }
            
            // Load admin designations into dropdown (not user portal designations)
            updateAdminUserDesignationDropdown();
            
            // Initialize Flatpickr for DOB field
            initializeUserDOBFlatpickr();
            
            // Initialize Flatpickr for Appointment Date field only if DOB exists
            const dobField = document.getElementById('userDOB');
            if (dobField && dobField.value) {
                initializeUserAppointmentDateFlatpickr();
            }
            
            // Ensure modal is visible
            modal.style.display = 'block';
            modal.style.visibility = 'visible';
            modal.style.opacity = '1';
            
            // Make sure modal is on top
            modal.style.zIndex = '9999';
            
            // Scroll the modal content to the top
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.scrollTop = 0;
                console.log('Scrolled modal to top');
            }
            
            // Also scroll the window to top to ensure modal is visible
            window.scrollTo(0, 0);
            
            // Focus on the first input field
            setTimeout(() => {
                const firstInput = modal.querySelector('input[type="text"]:not([type="hidden"]), input[type="email"]');
                if (firstInput) {
                    firstInput.focus();
                    console.log('Focused on first input field');
                }
            }, 50);
            
            // Reinitialize Pikaday calendars for modal date fields
            setTimeout(() => {
                reinitializePikadayCalendars();
                // Reset the initialization flag to ensure fresh event handlers
                permissionsDropdownInitialized = false;
                initializePermissionsDropdown();
            }, 100);
        }
        
        // Toggle password visibility
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.parentElement.querySelector('button');
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }
        
        function saveUser(event) {
            event.preventDefault();
            
            const id = document.getElementById('userId').value;
            const fullName = document.getElementById('userFullName').value;
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const email = document.getElementById('userEmail').value;
            const role = 'user'; // Default role since field was removed
            const status = document.getElementById('userStatus').value;
            
            // Collect new fields
            const dateOfBirth = document.getElementById('userDOB').value;
            const age = document.getElementById('userAge').value;
            const gender = document.getElementById('userGender').value;
            const fatherName = document.getElementById('userFatherName').value;
            const motherName = document.getElementById('userMotherName').value;
            const grandFatherName = document.getElementById('userGrandFatherName').value;
            const address = document.getElementById('userAddress').value;
            const mobile = document.getElementById('userMobile').value;
            const designation = document.getElementById('userDesignation').value;
            const appointmentDate = document.getElementById('userAppointmentDate').value;
            const aadharNumber = document.getElementById('userAadhar').value;
            const panNumber = document.getElementById('userPAN').value;
            
            // Collect marital status and children data
            const maritalStatus = document.getElementById('userMaritalStatus').value;
            const spouseName = document.getElementById('userSpouseName').value;
            
            // Initialize userChildren array and collect children data
            let userChildren = [];
            if (window.staffChildren && window.staffChildren.length > 0) {
                userChildren = [...window.staffChildren];
            }
            
            // Collect selected permissions using new system
            const permissions = getUserPermissions();
            
            // Validation 0: Check if at least one permission is selected
            const totalPermissions = Object.values(permissions).reduce((sum, perms) => sum + perms.length, 0);
            if (totalPermissions === 0) {
                alert('Please select at least one user permission!');
                return;
            }
            
            // Validation 1: Check if passwords match
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }
            
            // Validation 2: Username and password should not be the same
            if (username.toLowerCase() === password.toLowerCase()) {
                alert('Username and password cannot be the same!');
                return;
            }
            
            // Validation 3: Check if username already exists (exclude current user if editing)
            const existingUser = users.find(u => u.username === username && u.id != id);
            if (existingUser) {
                showUserAlreadyExistsModal();
                return;
            }
            
            // Validation 4: Check for duplicate users (same full name and email if provided)
            if (email) {
                const duplicateByEmail = users.find(u => u.email === email && u.id != id);
                if (duplicateByEmail) {
                    alert('A user with this email already exists!');
                    return;
                }
            }
            
            // Additional validation: Password strength
            if (password.length < 6) {
                alert('Password must be at least 6 characters long!');
                return;
            }
            
            // For existing users, show professional save modal
            if (id) {
                // Get the original user data
                const originalUser = users.find(u => u.id == id);
                const changes = [];
                
                // Compare fields and build changes list
                if (originalUser.fullName !== fullName) changes.push('Full Name');
                if (originalUser.username !== username) changes.push('Username');
                if (originalUser.password !== password) changes.push('Password');
                if (originalUser.email !== email) changes.push('Email');
                if (originalUser.status !== status) changes.push('Status');
                
                // Check if permissions changed
                const originalPermissions = originalUser.permissions || {};
                const permissionsChanged = JSON.stringify(originalPermissions) !== JSON.stringify(permissions);
                if (permissionsChanged) changes.push('User Rights/Permissions');
                
                // Store the save action to be executed later
                window.pendingAdminSaveAction = function() {
                    performUserSave(id, fullName, username, password, email, role, status, permissions, 
                        dateOfBirth, age, gender, fatherName, motherName, grandFatherName, 
                        address, mobile, designation, appointmentDate, aadharNumber, panNumber,
                        maritalStatus, spouseName, userChildren);
                };
                showSaveModal(changes);
            } else {
                // For new users, save directly
                performUserSave(id, fullName, username, password, email, role, status, permissions,
                    dateOfBirth, age, gender, fatherName, motherName, grandFatherName, 
                    address, mobile, designation, appointmentDate, aadharNumber, panNumber,
                    maritalStatus, spouseName, userChildren);
                showUserCreatedSuccessModal();
            }
        }
        
        async function performUserSave(id, fullName, username, password, email, role, status, permissions,
            dateOfBirth, age, gender, fatherName, motherName, grandFatherName, 
            address, mobile, designation, appointmentDate, aadharNumber, panNumber,
            maritalStatus, spouseName, children) {
            if (id) {
                // Update existing user - try API first, fallback to local storage
                try {
                    // Prepare user data for the normalized API
                    const userData = {
                        full_name: fullName,
                        username: username,
                        password: password,
                        email: email,
                        role: role,
                        status: status,
                        date_of_birth: dateOfBirth,
                        age: parseInt(age) || null,
                        gender: gender,
                        father_name: fatherName,
                        mother_name: motherName,
                        grand_father_name: grandFatherName,
                        address: address,
                        mobile_number: mobile,
                        designation: designation,
                        appointment_date: appointmentDate,
                        aadhar_number: aadharNumber,
                        pan_number: panNumber,
                        marital_status: maritalStatus,
                        spouse_name: spouseName,
                        children: children || []
                    };

                    // Make API call to update user
                    const response = await fetch(`/api/users-normalized/${id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(userData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Update permissions separately if they exist
                        if (permissions && Object.keys(permissions).length > 0) {
                            const permissionsArray = [];
                            
                            // Convert permissions object to array format
                            Object.keys(permissions).forEach(tab => {
                                permissions[tab].forEach(perm => {
                                    permissionsArray.push({
                                        tab: tab,
                                        permission: perm
                                    });
                                });
                            });

                            // Update user permissions
                            await fetch(`/api/users-normalized/${id}/permissions`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify({ permissions: permissionsArray })
                            });
                        }

                        console.log('User updated successfully via API');
                        
                        // Reload users from server
                        await loadUsersFromAPI();
                        
                    } else {
                        throw new Error(result.message || 'Failed to update user via API');
                    }
                    
                } catch (error) {
                    console.error('API call failed, falling back to local storage:', error);
                    
                    // Fallback: Update user locally
                    const userIndex = users.findIndex(u => u.id == id);
                    users[userIndex] = {
                        ...users[userIndex],
                        fullName,
                        username,
                        password,
                        email,
                        role,
                        status,
                        permissions,
                        dateOfBirth,
                        age,
                        gender,
                        fatherName,
                        motherName,
                        grandFatherName,
                        address,
                        mobile,
                        designation,
                        appointmentDate,
                        aadharNumber,
                        panNumber,
                        maritalStatus,
                        spouseName,
                        children: children || []
                    };
                    
                    // Save to localStorage to persist changes
                    saveUsersToStorage();
                }
                
                // Close modal and refresh user management view immediately
                document.getElementById('userModal').style.display = 'none';
                if (document.getElementById('adminContent')) {
                    showUserManagement();
                }
                
                // User photo field removed
            } else {
                // Try API first, fallback to local storage
                try {
                    // Prepare user data for the normalized API
                    const userData = {
                        full_name: fullName,
                        username: username,
                        password: password,
                        email: email,
                        role: role,
                        status: status,
                        date_of_birth: dateOfBirth,
                        age: parseInt(age) || null,
                        gender: gender,
                        father_name: fatherName,
                        mother_name: motherName,
                        grand_father_name: grandFatherName,
                        address: address,
                        mobile_number: mobile,
                        designation: designation,
                        appointment_date: appointmentDate,
                        aadhar_number: aadharNumber,
                        pan_number: panNumber,
                        marital_status: maritalStatus,
                        spouse_name: spouseName,
                        children: children || []
                    };

                    // Make API call to normalized endpoint
                    const response = await fetch('/api/users-normalized', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(userData)
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Update permissions separately
                        if (permissions && Object.keys(permissions).length > 0) {
                            const permissionsArray = [];
                            
                            // Convert permissions object to array format
                            Object.keys(permissions).forEach(tab => {
                                permissions[tab].forEach(perm => {
                                    permissionsArray.push({
                                        tab: tab,
                                        permission: perm
                                    });
                                });
                            });

                            // Update user permissions
                            await fetch(`/api/users-normalized/${result.user.id}/permissions`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                },
                                body: JSON.stringify({ permissions: permissionsArray })
                            });
                        }

                        console.log('User created successfully via API');
                        
                        // Reload users from server
                        await loadUsersFromAPI();
                        
                    } else {
                        throw new Error(result.message || 'Failed to create user via API');
                    }
                    
                } catch (error) {
                    console.error('API call failed, falling back to local storage:', error);
                    
                    // Fallback: Create new user locally
                    const newUser = {
                        id: users.length > 0 ? Math.max(...users.map(u => u.id)) + 1 : 1,
                        fullName,
                        username,
                        password,
                        email,
                        role,
                        status,
                        permissions,
                        createdAt: new Date().toISOString().split('T')[0],
                        dateOfBirth,
                        age,
                        gender,
                        fatherName,
                        motherName,
                        grandFatherName,
                        address,
                        mobile,
                        designation,
                        appointmentDate,
                        aadharNumber,
                        panNumber
                    };
                    
                    users.push(newUser);
                    saveUsersToStorage();
                }
                
                // Close modal and refresh user management view immediately for new users too
                document.getElementById('userModal').style.display = 'none';
                if (document.getElementById('adminContent')) {
                    showUserManagement();
                }
            }
            
            // Refresh details modal if it's currently open
            refreshStaffDetailsIfOpen(id);
        }
        
        function editUser(id) {
            console.log('editUser function called with id:', id);
            
            // Validate the ID
            if (!id || id === 0) {
                alert('Invalid user ID. Please refresh the page and try again.');
                return;
            }
            
            const user = users.find(u => u.id === id);
            console.log('Found user:', user);
            
            if (user) {
                openUserModal(user);
            } else {
                alert('User record not found. Please refresh the page and try again.');
            }
        }
        
        
        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                const isActivating = user.status === 'inactive';
                window.pendingUserStatusChange = function() {
                    user.status = user.status === 'active' ? 'inactive' : 'active';
                    // Save to localStorage
                    saveUsersToStorage();
                    showUserManagement();
                    // Pass the actual new status (isActivating tells us what we did)
                    showUserStatusChangedModal(isActivating);
                };
                showUserStatusConfirmModal(user, isActivating);
            }
        }
        
        async function deleteUser(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                showDeleteModal('User Record', user.fullName, id, async function(userId) {
                    try {
                        // Check if running on a web server (not file://)
                        if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                            // Make API call to delete from backend database using normalized API
                            const response = await fetch(`/api/users-normalized/${userId}`, {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (response.ok) {
                                // Only update frontend after successful backend deletion
                                users = users.filter(u => u.id !== userId);
                                localStorage.setItem('cantonment_users', JSON.stringify(users));
                                showUserManagement();
                                alert('User deleted successfully from database!');
                            } else {
                                const errorData = await response.json();
                                throw new Error(errorData.message || 'Failed to delete user');
                            }
                        } else {
                            // Running from file:// - only update localStorage
                            console.log('Running from file:// protocol - updating localStorage only');
                            users = users.filter(u => u.id !== userId);
                            localStorage.setItem('cantonment_users', JSON.stringify(users));
                            showUserManagement();
                            alert('User deleted successfully from local storage!\n\nNote: Running in offline mode - database not updated.');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        
                        // If it's a network error and we're on file://, handle it gracefully
                        if (error.name === 'TypeError' && error.message.includes('NetworkError')) {
                            users = users.filter(u => u.id !== userId);
                            localStorage.setItem('cantonment_users', JSON.stringify(users));
                            showUserManagement();
                            alert('User deleted successfully from local storage!\n\nNote: Running in offline mode - database not updated.');
                        } else {
                            alert('Failed to delete user: ' + error.message);
                        }
                    }
                });
            }
        }
        
        // User photo functions removed - photo field no longer exists
        
        // Full name validation function
        function validateFullName(input) {
            // Remove any characters that aren't letters or spaces
            let value = input.value.replace(/[^a-zA-Z\s]/g, '');
            
            // Auto-capitalize first letter of each word
            value = value.replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
            
            // Set the cleaned and capitalized value back to the input
            input.value = value;
        }
        
        // Toggle spouse field based on marital status
        function toggleSpouseField() {
            const maritalStatus = document.getElementById('userMaritalStatus').value;
            const spouseNameGroup = document.getElementById('spouseNameGroup');
            const addChildButton = document.getElementById('addChildButton');
            
            if (maritalStatus && maritalStatus !== 'Un-Married') {
                spouseNameGroup.style.display = 'block';
                addChildButton.disabled = false;
                addChildButton.style.opacity = '1';
                addChildButton.style.cursor = 'pointer';
                addChildButton.title = '';
            } else {
                spouseNameGroup.style.display = 'none';
                document.getElementById('userSpouseName').value = '';
                addChildButton.disabled = true;
                addChildButton.style.opacity = '0.5';
                addChildButton.style.cursor = 'not-allowed';
                addChildButton.title = 'Please select marital status first';
            }
        }
        
        // Calculate age from date of birth
        function calculateAge() {
            const dobInput = document.getElementById('userDOB');
            const ageInput = document.getElementById('userAge');
            
            if (dobInput && dobInput.value) {
                let dob;
                const dobValue = dobInput.value;
                
                // Handle different date formats
                if (dobValue.includes('-') && dobValue.split('-')[0].length === 2) {
                    // DD-MM-YYYY format from Flatpickr
                    const parts = dobValue.split('-');
                    dob = new Date(parts[2], parts[1] - 1, parts[0]); // Year, Month (0-based), Day
                } else {
                    // YYYY-MM-DD format (standard date input)
                    dob = new Date(dobValue);
                }
                
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                
                if (ageInput && age >= 0 && age <= 150) { // Sanity check for valid age
                    ageInput.value = age;
                }
            } else if (ageInput) {
                ageInput.value = '';
            }
        }
        
        // Load designations into user form dropdown
        function loadUserDesignations() {
            const designationSelect = document.getElementById('userDesignation');
            if (designationSelect) {
                // Clear existing options except the first one
                designationSelect.innerHTML = '<option value="">Select Designation</option>';
                
                // Add designations from the global array
                designations.forEach(designation => {
                    const option = document.createElement('option');
                    option.value = designation.name;
                    option.textContent = designation.name;
                    designationSelect.appendChild(option);
                });
            }
        }
        
        // Initialize Flatpickr for User DOB field
        function initializeUserDOBFlatpickr() {
            const dobField = document.getElementById('userDOB');
            if (!dobField) {
                console.error('User DOB field not found');
                return;
            }
            
            // Destroy existing Flatpickr instance if any
            if (dobField._flatpickr) {
                try {
                    dobField._flatpickr.destroy();
                } catch (e) {
                    console.log('Error destroying existing Flatpickr instance:', e);
                }
            }
            
            // Clear any existing event listeners
            const newDobField = dobField.cloneNode(true);
            dobField.parentNode.replaceChild(newDobField, dobField);
            
            try {
                // Initialize Flatpickr with Google Calendar styling
                const flatpickrInstance = flatpickr(newDobField, {
                    dateFormat: "d-m-Y",
                    altInput: true,
                    altFormat: "d-m-Y",
                    minDate: new Date(new Date().getFullYear() - 100, 0, 1), // 100 years ago
                    maxDate: new Date(new Date().getFullYear() - 18, new Date().getMonth(), new Date().getDate()), // 18 years ago
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    disableMobile: true,
                    monthSelectorType: 'dropdown',
                    yearSelectorType: 'dropdown',
                    showMonths: 1,
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            calculateAge();
                            // Enable and update appointment date field when DOB is selected
                            enableAppointmentDateField();
                            updateAppointmentDateMinimum();
                        } else {
                            // Disable appointment date field if DOB is cleared
                            disableAppointmentDateField();
                        }
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        // Add custom styles to match Google Calendar
                        const calendarContainer = instance.calendarContainer;
                        calendarContainer.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                        calendarContainer.style.border = '1px solid #e0e0e0';
                        calendarContainer.style.borderRadius = '8px';
                        
                        // Style the year dropdown
                        const yearDropdown = calendarContainer.querySelector('.flatpickr-current-month select.flatpickr-monthDropdown-year');
                        if (yearDropdown) {
                            yearDropdown.style.fontSize = '14px';
                            yearDropdown.style.fontWeight = '500';
                            yearDropdown.style.cursor = 'pointer';
                        }
                        
                        // Style the month dropdown
                        const monthDropdown = calendarContainer.querySelector('.flatpickr-current-month select.flatpickr-monthDropdown-months');
                        if (monthDropdown) {
                            monthDropdown.style.fontSize = '14px';
                            monthDropdown.style.fontWeight = '500';
                            monthDropdown.style.cursor = 'pointer';
                        }
                    }
                });
                
                console.log('Flatpickr initialized for User DOB field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for User DOB:', error);
            }
        }
        
        // Initialize Flatpickr for User Appointment Date field
        function initializeUserAppointmentDateFlatpickr() {
            const appointmentField = document.getElementById('userAppointmentDate');
            if (!appointmentField) {
                console.error('User Appointment Date field not found');
                return;
            }
            
            // Destroy existing Flatpickr instance if any
            if (appointmentField._flatpickr) {
                try {
                    appointmentField._flatpickr.destroy();
                } catch (e) {
                    console.log('Error destroying existing Flatpickr instance:', e);
                }
            }
            
            // Clear any existing event listeners
            const newAppointmentField = appointmentField.cloneNode(true);
            appointmentField.parentNode.replaceChild(newAppointmentField, appointmentField);
            
            try {
                // Initialize Flatpickr with Google Calendar styling
                const flatpickrInstance = flatpickr(newAppointmentField, {
                    dateFormat: "d-m-Y",
                    altInput: true,
                    altFormat: "d-m-Y",
                    maxDate: new Date(), // Can't be future date
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    disableMobile: true,
                    monthSelectorType: 'dropdown',
                    yearSelectorType: 'dropdown',
                    showMonths: 1,
                    onReady: function(selectedDates, dateStr, instance) {
                        // Add custom styles to match Google Calendar
                        const calendarContainer = instance.calendarContainer;
                        calendarContainer.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
                        calendarContainer.style.border = '1px solid #e0e0e0';
                        calendarContainer.style.borderRadius = '8px';
                        
                        // Style the year dropdown
                        const yearDropdown = calendarContainer.querySelector('.flatpickr-current-month select.flatpickr-monthDropdown-year');
                        if (yearDropdown) {
                            yearDropdown.style.fontSize = '14px';
                            yearDropdown.style.fontWeight = '500';
                            yearDropdown.style.cursor = 'pointer';
                        }
                        
                        // Style the month dropdown
                        const monthDropdown = calendarContainer.querySelector('.flatpickr-current-month select.flatpickr-monthDropdown-months');
                        if (monthDropdown) {
                            monthDropdown.style.fontSize = '14px';
                            monthDropdown.style.fontWeight = '500';
                            monthDropdown.style.cursor = 'pointer';
                        }
                    }
                });
                
                console.log('Flatpickr initialized for User Appointment Date field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for User Appointment Date:', error);
            }
        }
        
        // Update appointment date minimum based on DOB (when person turns 18)
        function updateAppointmentDateMinimum() {
            const dobField = document.getElementById('userDOB');
            const appointmentField = document.getElementById('userAppointmentDate');
            
            if (dobField && appointmentField && dobField.value) {
                // Parse the DOB (DD-MM-YYYY format)
                const dobParts = dobField.value.split('-');
                if (dobParts.length === 3) {
                    const day = parseInt(dobParts[0]);
                    const month = parseInt(dobParts[1]) - 1; // Month is 0-indexed in JavaScript
                    const year = parseInt(dobParts[2]);
                    const dobDate = new Date(year, month, day);
                    
                    // Calculate when person turns 18
                    const eighteenthBirthday = new Date(
                        dobDate.getFullYear() + 18,
                        dobDate.getMonth(),
                        dobDate.getDate()
                    );
                    
                    // Update the appointment date field's minimum date
                    if (appointmentField._flatpickr) {
                        appointmentField._flatpickr.set('minDate', eighteenthBirthday);
                        console.log('Updated appointment date minimum to:', eighteenthBirthday.toDateString());
                    }
                }
            }
        }
        
        // Enable appointment date field when DOB is selected
        function enableAppointmentDateField() {
            const appointmentField = document.getElementById('userAppointmentDate');
            if (appointmentField) {
                appointmentField.disabled = false;
                appointmentField.title = '';
                // Re-initialize Flatpickr if it was disabled
                if (!appointmentField._flatpickr) {
                    initializeUserAppointmentDateFlatpickr();
                }
            }
        }
        
        // Disable appointment date field when DOB is not selected
        function disableAppointmentDateField() {
            const appointmentField = document.getElementById('userAppointmentDate');
            if (appointmentField) {
                appointmentField.disabled = true;
                appointmentField.title = 'Please select Date of Birth first';
                appointmentField.value = '';
                // Destroy Flatpickr instance to prevent interaction
                if (appointmentField._flatpickr) {
                    appointmentField._flatpickr.destroy();
                }
            }
        }
        
        // Date formatting and validation functions
        function formatDateToDisplay(dateString) {
            if (!dateString) return '';
            
            let date;
            // Check if the date is in DD-MM-YYYY format (our standard format)
            if (dateString.includes('-') && dateString.split('-').length === 3) {
                const parts = dateString.split('-');
                if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                    // DD-MM-YYYY format - convert to proper Date object
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed in Date
                    const year = parseInt(parts[2]);
                    date = new Date(year, month, day);
                } else {
                    // Fallback to default parsing
                    date = new Date(dateString);
                }
            } else {
                // For other formats, use default parsing
                date = new Date(dateString);
            }
            
            // Check if date is valid
            if (isNaN(date.getTime())) {
                return dateString; // Return original string if parsing failed
            }
            
            const day = date.getDate().toString().padStart(2, '0');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = months[date.getMonth()];
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        function formatDateFromDisplay(displayString) {
            if (!displayString) return '';
            // Convert "12.Jun.2025" back to "2025-06-12" format
            const parts = displayString.split('.');
            if (parts.length !== 3) return displayString;
            
            const day = parts[0];
            const monthName = parts[1];
            const year = parts[2];
            
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthIndex = months.indexOf(monthName);
            if (monthIndex === -1) return displayString;
            
            const month = (monthIndex + 1).toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Function to format date input as user types
        function formatDateInput(input) {
            let value = input.value.replace(/\D/g, ''); // Remove all non-digits
            let formattedValue = '';
            
            if (value.length >= 2) {
                formattedValue = value.substring(0, 2) + '/';
                if (value.length >= 4) {
                    formattedValue += value.substring(2, 4) + '/';
                    if (value.length >= 8) {
                        formattedValue += value.substring(4, 8);
                    } else {
                        formattedValue += value.substring(4);
                    }
                } else {
                    formattedValue += value.substring(2);
                }
            } else {
                formattedValue = value;
            }
            
            input.value = formattedValue;
            
            // Trigger change event when date is complete
            if (formattedValue.length === 10) {
                input.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
        
        // Helper function to parse DD/MM/YYYY or DD-MM-YYYY format
        function parseDDMMYYYY(dateString) {
            if (!dateString) return null;
            
            // Trim any whitespace
            dateString = dateString.trim();
            
            // Check for either slash or hyphen separator
            let parts;
            if (dateString.includes('/')) {
                parts = dateString.split('/');
            } else if (dateString.includes('-')) {
                parts = dateString.split('-');
            } else {
                return null;
            }
            
            if (parts.length !== 3) return null;
            
            // Parse and ensure leading zeros are handled
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const year = parseInt(parts[2], 10);
            
            const currentYear = new Date().getFullYear();
            const minYear = 1910;
            const maxYear = currentYear + 60;
            
            if (isNaN(day) || isNaN(month) || isNaN(year) || 
                day < 1 || day > 31 || month < 1 || month > 12 || year < minYear || year > maxYear) {
                return null;
            }
            
            const date = new Date(year, month - 1, day);
            if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
                return null;
            }
            
            return date;
        }

        // Helper function to format date to DD-MM-YYYY
        function formatDateToDDMMYYYY(date) {
            if (!date) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        // Helper function to format date to DD/MM/YYYY (with slashes)
        function formatDateToDD_MM_YYYY(date) {
            if (!date) return '';
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function validateDateOfBirth(dateString) {
            if (!dateString || dateString.trim() === '') return { valid: true, message: '' };
            
            // Parse DD-MM-YYYY date format (from Flatpickr)
            let inputDate;
            if (dateString.includes('-')) {
                const parts = dateString.split('-');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                    const year = parseInt(parts[2]);
                    inputDate = new Date(year, month, day);
                }
            }
            
            if (!inputDate || isNaN(inputDate.getTime())) {
                return { valid: true, message: '' };
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day
            
            if (inputDate > today) {
                return { valid: false, message: 'Date of birth cannot be in the future!' };
            }
            
            // Check if person is not older than 120 years
            const maxDate = new Date();
            maxDate.setFullYear(maxDate.getFullYear() - 120);
            if (inputDate < maxDate) {
                return { valid: false, message: 'Date of birth cannot be more than 120 years ago!' };
            }
            
            return { valid: true, message: '' };
        }
        
        function validateDateOfAppointment(dateString, birthDateString) {
            if (!dateString) return { valid: true, message: '' };
            
            const appointmentDate = parseDDMMYYYY(dateString);
            if (!appointmentDate) {
                // Don't show error for format issues - Pikaday should handle formatting
                return { valid: true, message: '' };
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Cannot be in the future
            if (appointmentDate > today) {
                return { valid: false, message: 'Date of appointment cannot be in the future!' };
            }
            
            // Should be at least 18 years after birth date
            if (birthDateString) {
                const birthDate = parseDDMMYYYY(birthDateString);
                if (birthDate && !isNaN(birthDate.getTime())) {
                    const minAppointmentDate = new Date(birthDate.getTime());
                    minAppointmentDate.setFullYear(minAppointmentDate.getFullYear() + 18);
                    if (appointmentDate < minAppointmentDate) {
                        const formattedMinDate = formatDateToDD_MM_YYYY(minAppointmentDate);
                        return { valid: false, message: `Date of appointment cannot be before ${formattedMinDate}. Person must be at least 18 years old when appointed!` };
                    }
                }
            }
            
            return { valid: true, message: '' };
        }
        
        function validateNextIncrementDate(dateString) {
            if (!dateString) return { valid: true, message: '' };
            
            const incrementDate = parseDDMMYYYY(dateString);
            if (!incrementDate) {
                // Don't show error for format issues - Pikaday should handle formatting
                return { valid: true, message: '' };
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Remove the check for past dates - we should allow past dates in edit mode
            // The only restriction should be that it's at least 1 year after appointment
            
            // Check if appointment date is filled and validate against it
            const appointmentDateElement = document.getElementById('dateOfAppointment');
            if (appointmentDateElement && appointmentDateElement.value) {
                const appointmentDate = parseDDMMYYYY(appointmentDateElement.value);
                if (appointmentDate) {
                    const oneYearAfterAppointment = new Date(appointmentDate);
                    oneYearAfterAppointment.setFullYear(oneYearAfterAppointment.getFullYear() + 1);
                    
                    if (incrementDate < oneYearAfterAppointment) {
                        const formattedMinDate = formatDateToDD_MM_YYYY(oneYearAfterAppointment);
                        return { valid: false, message: `Date of next increment cannot be before ${formattedMinDate}. It must be at least 1 year after date of appointment!` };
                    }
                }
            }
            
            return { valid: true, message: '' };
        }
        
        // Convert date input to display format after selection
        function convertDateInputToDisplay(inputElement) {
            // Only process if the field has a valid date value
            if (inputElement.value && inputElement.value.trim() !== '' && inputElement.value !== 'Click to select date üìÖ') {
                const displayDate = formatDateToDisplay(inputElement.value);
                
                // Store the original value in a data attribute
                inputElement.setAttribute('data-iso-date', inputElement.value);
                
                // Set to display format with visual indicator for editing
                inputElement.type = 'text';
                inputElement.value = displayDate + ' üìÖ';
                inputElement.style.cssText = 'cursor: pointer; background: #f0f8ff; border: 2px solid #1976d2;';
                inputElement.readOnly = true;
                inputElement.title = 'Click to change date';
                
                // Remove existing event listeners to prevent conflicts
                inputElement.onclick = null;
                inputElement.onblur = null;
                
                // Add click handler to switch back to date picker
                inputElement.onclick = function() {
                    this.type = 'date';
                    this.value = this.getAttribute('data-iso-date') || '';
                    this.style.cssText = '';
                    this.readOnly = false;
                    this.title = '';
                    this.focus();
                };
                
                // Add blur handler to convert back to display format
                inputElement.onblur = function() {
                    setTimeout(() => {
                        if (this.value && this.value.trim() !== '') {
                            // Update the stored ISO date
                            this.setAttribute('data-iso-date', this.value);
                            convertDateInputToDisplay(this);
                        } else {
                            // Only set placeholder if there was no previous value
                            if (!this.getAttribute('data-iso-date')) {
                                this.type = 'text';
                                this.value = 'Click to select date üìÖ';
                                this.style.cssText = 'cursor: pointer; background: #f9f9f9; border: 2px dashed #ccc; color: #666;';
                                this.readOnly = true;
                                this.title = 'Click to select date';
                            } else {
                                // Restore previous value if user didn't enter anything
                                this.type = 'date';
                                this.value = this.getAttribute('data-iso-date');
                                convertDateInputToDisplay(this);
                            }
                        }
                    }, 100);
                };
            }
        }
        
        // No hardcoded staff data - will load from database
        let localAdmissions = [];
        
        let localDesignations = [];

        let localCodes = [];

        // Debug: Check what's in localStorage
        console.log('=== LocalStorage Debug ===');
        console.log('cantonment_admissions:', localStorage.getItem('cantonment_admissions'));
        console.log('admissions:', localStorage.getItem('admissions'));
        console.log('All localStorage keys:', Object.keys(localStorage));
        
        // Load existing admissions data first, fallback to sample data only if none exist
        let storedAdmissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || 
                              JSON.parse(localStorage.getItem('admissions')) || [];
        console.log('Initial load - stored admissions:', storedAdmissions);

        if (storedAdmissions.length > 0) {
            // Use existing staff records and migrate them to new structure if needed
            admissions = storedAdmissions.filter(admission => admission && admission.id && !isNaN(admission.id));
            console.log('Using existing staff records, filtered:', admissions);
            
            // Migrate existing records to include new fields if missing
            migrateStaffRecords();
        } else {
            // Only use sample data if no real records exist
            admissions = [];
            console.log('No existing staff found, starting with empty data');
        }
        let designations = JSON.parse(localStorage.getItem('cantonment_designations')) || [];
        
        // Separate Admin Portal Designations (completely independent from User Portal)
        // No hardcoded admin designations - will load from database
        let adminDesignations = JSON.parse(localStorage.getItem('cantonment_admin_designations')) || [];
        let codes = JSON.parse(localStorage.getItem('cantonment_codes')) || [];
        let authToken = localStorage.getItem('authToken') || '';
        let pensionNominees = {};  // Store nominees per staff ID
        let originalFormData = {};  // Store original form values for change tracking
        let realTimeChanges = [];  // Store real-time changes for display
        let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
        let staffDeductions = JSON.parse(localStorage.getItem('cantonment_staff_deductions')) || {};
        
        // No hardcoded deductions - will load from database
        function initializeStaffDeductions() {
            // Function removed - no hardcoded deductions
        }
        
        // Function to refresh data from localStorage
        function refreshGlobalData() {
            attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
            staffDeductions = JSON.parse(localStorage.getItem('cantonment_staff_deductions')) || {};
        }

        // Migration function to update existing staff records with new fields - DISABLED
        function migrateStaffRecords() {
            console.log('Staff record migration disabled - no hardcoded data will be added');
            // DISABLED: This function was adding hardcoded sample data to existing records
            // All staff records will retain only their original data without artificial additions
        }

        // Clean up any existing migrated/hardcoded data from staff records
        function cleanupHardcodedData() {
            console.log('Cleaning up any existing hardcoded migration data...');
            
            // Load current admissions
            const currentAdmissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || [];
            let cleanupCount = 0;
            
            const cleanedAdmissions = currentAdmissions.map(staff => {
                let needsCleaning = false;
                const cleanedStaff = { ...staff };
                
                // Remove hardcoded migration values if they exist
                const hardcodedValues = {
                    'dateOfBirth': '01-01-1980',
                    'age': '44',
                    'sex': 'Male',
                    'motherName': 'N/A',
                    'grandFatherName': 'N/A',
                    'maritalStatus': 'Single',
                    'dateOfAppointment': '01-04-2010',
                    'retirementDate': '31-03-2040',
                    'functionCode': '2059',
                    'objectCode': '01',
                    'dateOfNextIncrement': '01-07-2024',
                    'pensionScheme': 'New Pension Scheme',
                    'aadharNumber': 'XXXX-XXXX-XXXX',
                    'panNumber': 'XXXXX0000X',
                    'bankName': 'Not provided',
                    'accountNumber': 'Not provided',
                    'ifscCode': 'Not provided',
                    'micrCode': 'Not provided',
                    'basicPay': '5200-20200',
                    'gradePay': '2400',
                    'payLevel': '4',
                    'payCell': '1',
                    'basicPayCalculated': '25000',
                    'da': '50',
                    'hra': '24',
                    'grossSalary': '40000'
                };
                
                // Check and remove hardcoded values
                for (const [field, hardcodedValue] of Object.entries(hardcodedValues)) {
                    if (cleanedStaff[field] === hardcodedValue) {
                        delete cleanedStaff[field];
                        needsCleaning = true;
                    }
                }
                
                if (needsCleaning) {
                    cleanupCount++;
                }
                
                return cleanedStaff;
            });
            
            if (cleanupCount > 0) {
                console.log(`Cleaned up hardcoded data from ${cleanupCount} staff records`);
                localStorage.setItem('cantonment_admissions', JSON.stringify(cleanedAdmissions));
                // Update the global admissions array
                admissions = cleanedAdmissions;
                return true;
            } else {
                console.log('No hardcoded data found to clean up');
                return false;
            }
        }

        // ========================================
        // ID STANDARDIZATION SYSTEM
        // ========================================
        // This system uses two types of IDs:
        // - staff.id: Primary key for database operations (auto-increment integer)
        // - staff.staffId: User-defined identifier for display and user input (string like "CB001")
        
        // Helper functions for consistent ID usage
        function getStaffByUserStaffId(userStaffId) {
            return admissions.find(staff => staff.staffId === userStaffId);
        }
        
        function getStaffByDatabaseId(databaseId) {
            return admissions.find(staff => staff.id === parseInt(databaseId));
        }
        
        // Validation function to ensure staff ID uniqueness
        function isStaffIdUnique(staffId, excludeId = null) {
            return !admissions.some(staff => 
                staff.staffId === staffId && staff.id !== excludeId
            );
        }

        // ========================================
        // LEAVE BALANCE TRACKING SYSTEM
        // ========================================
        
        // Initialize leave balance storage
        let staffLeaveBalances = JSON.parse(localStorage.getItem('cantonment_staff_leave_balances')) || {};
        
        // Function to calculate casual leave entitlement based on service years
        function getCasualLeaveEntitlement(serviceYears) {
            if (serviceYears <= 10) {
                return 10;  // 0-10 years: 10 days
            } else if (serviceYears <= 20) {
                return 20;  // 10-20 years: 20 days  
            } else {
                return 20;  // >20 years: 20 days
            }
        }
        
        // Function to calculate service years from joining date
        function calculateServiceYears(joiningDate, currentDate = fakeSystemTime.currentDate) {
            if (!joiningDate) return 0;
            
            const joining = new Date(joiningDate);
            const current = new Date(currentDate);
            const diffTime = current - joining;
            const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25); // Account for leap years
            
            return Math.floor(diffYears);
        }
        
        // Function to get current Half Pay Leave cycle information
        function getHalfPayLeaveCycle(currentDate = fakeSystemTime.currentDate) {
            const date = new Date(currentDate);
            const month = date.getMonth(); // 0-11
            const year = date.getFullYear();
            
            if (month < 6) { // Jan-Jun (0-5)
                return {
                    period: 'First Half',
                    periodName: 'Jan 1st - Jun 30th',
                    startDate: new Date(year, 0, 1), // Jan 1st
                    endDate: new Date(year, 5, 30), // June 30th
                    nextCycleStart: new Date(year, 6, 1), // July 1st
                    entitlement: 10,
                    isFirstHalf: true
                };
            } else { // Jul-Dec (6-11)
                return {
                    period: 'Second Half', 
                    periodName: 'Jul 1st - Dec 31st',
                    startDate: new Date(year, 6, 1), // July 1st
                    endDate: new Date(year, 11, 31), // Dec 31st
                    nextCycleStart: new Date(year + 1, 0, 1), // Jan 1st next year
                    entitlement: 10,
                    isFirstHalf: false
                };
            }
        }
        
        // Function to get current Earned Leave cycle information
        function getEarnedLeaveCycle(currentDate = fakeSystemTime.currentDate) {
            const date = new Date(currentDate);
            const month = date.getMonth(); // 0-11
            const year = date.getFullYear();
            
            if (month < 6) { // Jan-Jun (0-5)
                return {
                    period: 'First Half',
                    periodName: 'Jan 1st - Jun 30th',
                    startDate: new Date(year, 0, 1), // Jan 1st
                    endDate: new Date(year, 5, 30), // June 30th
                    nextCycleStart: new Date(year, 6, 1), // July 1st
                    entitlement: 15,
                    isFirstHalf: true
                };
            } else { // Jul-Dec (6-11)
                return {
                    period: 'Second Half', 
                    periodName: 'Jul 1st - Dec 31st',
                    startDate: new Date(year, 6, 1), // July 1st
                    endDate: new Date(year, 11, 31), // Dec 31st
                    nextCycleStart: new Date(year + 1, 0, 1), // Jan 1st next year
                    entitlement: 15,
                    isFirstHalf: false
                };
            }
        }
        
        // Default leave entitlements per year
        const LEAVE_ENTITLEMENTS = {
            earned: 15,        // 15 days per 6-month cycle (Jan & July allocation)
            earnedMaxAccumulation: 300,  // Maximum 300 days can be accumulated
            halfpay: 10        // 10 days per 6-month cycle (Jan-Jun, Jul-Dec)
        };
        
        // Function to initialize staff leave balance for a year
        function initializeStaffLeaveBalance(databaseId, year) {
            const key = `${databaseId}_${year}`;
            if (!staffLeaveBalances[key]) {
                // Get staff details to calculate service-based entitlement
                const staff = getStaffByDatabaseId(databaseId);
                const serviceYears = staff ? calculateServiceYears(staff.dateOfAppointment || staff.dateOfJoining || staff.appointmentDate) : 0;
                const casualEntitlement = getCasualLeaveEntitlement(serviceYears);
                
                staffLeaveBalances[key] = {
                    staffId: databaseId,
                    year: year,
                    serviceYears: serviceYears, // Store for reference
                    casual: {
                        entitled: casualEntitlement,
                        used: 0,
                        available: casualEntitlement
                    },
                    earned: {
                        entitled: LEAVE_ENTITLEMENTS.earned, // 15 days per cycle
                        used: 0,
                        available: 30, // Jan + July = 30 for new year
                        janAllocation: 15,      // Jan 1st allocation (fixed)
                        julyAllocation: 15,     // July 1st allocation (fixed)
                        carryoverFromPrevYear: 0, // Carried from previous year-end
                        totalAccumulated: 30,   // Total for current year (carryover + 30)
                        maxAccumulation: LEAVE_ENTITLEMENTS.earnedMaxAccumulation
                    },
                    halfpay: {
                        entitled: LEAVE_ENTITLEMENTS.halfpay, // 10 days per cycle
                        used: 0,
                        available: LEAVE_ENTITLEMENTS.halfpay,
                        firstHalfUsed: 0,   // Jan 1st - Jun 30th cycle usage
                        secondHalfUsed: 0,  // Jul 1st - Dec 31st cycle usage
                        firstHalfEntitled: 10,  // Always 10 for Jan-Jun cycle
                        secondHalfEntitled: 10  // Always 10 for Jul-Dec cycle
                    },
                    lastUpdated: new Date().toISOString()
                };
                saveLeaveBalancesToStorage();
            }
            return staffLeaveBalances[key];
        }
        
        // Function to calculate earned leave balance with year-end carryover logic
        function calculateEarnedLeaveBalance(balance, currentDate = fakeSystemTime.currentDate) {
            const cycleInfo = getEarnedLeaveCycle(currentDate);
            
            // Calculate total allocated for current year
            let totalYearAllocated = balance.earned.janAllocation + balance.earned.julyAllocation;
            
            // Add carryover from previous year (capped at 300 total)
            if (balance.earned.carryoverFromPrevYear + totalYearAllocated > balance.earned.maxAccumulation) {
                // If carryover + allocations exceed 300, cap the total at 300
                balance.earned.totalAccumulated = balance.earned.maxAccumulation;
            } else {
                balance.earned.totalAccumulated = balance.earned.carryoverFromPrevYear + totalYearAllocated;
            }
            
            // Calculate available based on what's been used
            balance.earned.available = balance.earned.totalAccumulated - balance.earned.used;
            
            return balance.earned;
        }
        
        // Function to get current leave balance for a staff member (comprehensive)
        function getStaffLeaveBalanceComprehensive(databaseId) {
            const staff = getStaffByDatabaseId(databaseId);
            if (!staff) return null;
            
            // Only calculate for male staff (as per current system requirements)
            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
            if (!isMale) return null;
            
            const currentYear = fakeSystemTime.currentYear;
            const balance = initializeStaffLeaveBalance(databaseId, currentYear);
            
            // Recalculate service years and update casual leave entitlement if needed
            const currentServiceYears = calculateServiceYears(staff.dateOfAppointment || staff.dateOfJoining || staff.appointmentDate);
            const currentCasualEntitlement = getCasualLeaveEntitlement(currentServiceYears);
            
            // Update if service years or entitlement has changed
            if (balance.serviceYears !== currentServiceYears || balance.casual.entitled !== currentCasualEntitlement) {
                balance.serviceYears = currentServiceYears;
                balance.casual.entitled = currentCasualEntitlement;
                // Recalculate available balance (don't exceed what was originally available)
                balance.casual.available = Math.max(0, currentCasualEntitlement - balance.casual.used);
            }
            
            // Recalculate used leaves from approved applications
            const approvedLeaves = leaveApplications.filter(app => 
                app.staffId === databaseId && 
                app.status === 'approved' && 
                new Date(app.startDate).getFullYear() === currentYear
            );
            
            // Reset used counts
            balance.casual.used = 0;
            balance.earned.used = 0;
            balance.halfpay.used = 0;
            balance.halfpay.firstHalfUsed = 0;
            balance.halfpay.secondHalfUsed = 0;
            
            // Calculate used leaves by type
            approvedLeaves.forEach(leave => {
                const leaveDate = new Date(leave.startDate);
                const leaveMonth = leaveDate.getMonth(); // 0-11
                const isFirstHalf = leaveMonth < 6; // Jan-Jun = 0-5
                
                switch(leave.leaveTypeId) {
                    case 1: // Casual Leave
                        balance.casual.used += leave.days;
                        break;
                    case 2: // Earned Leave
                        // Earned leave can be used from total pool (carryover + current year allocations)
                        balance.earned.used += leave.days;
                        break;
                    case 3: // Half Pay Leave
                        balance.halfpay.used += leave.days;
                        // Assign to correct 6-month cycle based on leave start date
                        if (isFirstHalf) {
                            balance.halfpay.firstHalfUsed += leave.days;
                        } else {
                            balance.halfpay.secondHalfUsed += leave.days;
                        }
                        break;
                }
            });
            
            // Update available balances
            balance.casual.available = balance.casual.entitled - balance.casual.used;
            
            // Calculate earned leave with carryover logic
            calculateEarnedLeaveBalance(balance);
            
            balance.halfpay.available = balance.halfpay.entitled - balance.halfpay.used;
            
            balance.lastUpdated = new Date().toISOString();
            saveLeaveBalancesToStorage();
            
            return balance;
        }
        
        // Function to save leave balances to storage
        function saveLeaveBalancesToStorage() {
            localStorage.setItem('cantonment_staff_leave_balances', JSON.stringify(staffLeaveBalances));
        }
        
        // Function to apply leave and update balance
        function applyLeaveToBalance(databaseId, leaveTypeId, days) {
            const balance = getStaffLeaveBalanceComprehensive(databaseId);
            if (!balance) return false;
            
            switch(leaveTypeId) {
                case 1: // Casual Leave
                    if (balance.casual.available >= days) {
                        balance.casual.used += days;
                        balance.casual.available -= days;
                        saveLeaveBalancesToStorage();
                        return true;
                    }
                    break;
                case 2: // Earned Leave
                    // Recalculate current balance
                    calculateEarnedLeaveBalance(balance);
                    
                    if (balance.earned.available >= days) {
                        // Deduct from total pool (no need to track specific period usage)
                        balance.earned.used += days;
                        
                        // Recalculate balance after deduction
                        calculateEarnedLeaveBalance(balance);
                        
                        saveLeaveBalancesToStorage();
                        return true;
                    }
                    break;
                case 3: // Half Pay Leave
                    const cycleInfo = getHalfPayLeaveCycle();
                    const firstHalfUsed = balance.halfpay.firstHalfUsed || 0;
                    const secondHalfUsed = balance.halfpay.secondHalfUsed || 0;
                    
                    // Check current cycle availability
                    const currentCycleUsed = cycleInfo.isFirstHalf ? firstHalfUsed : secondHalfUsed;
                    const currentCycleAvailable = cycleInfo.entitlement - currentCycleUsed;
                    
                    if (currentCycleAvailable >= days) {
                        // Update the appropriate cycle counter
                        if (cycleInfo.isFirstHalf) {
                            balance.halfpay.firstHalfUsed = firstHalfUsed + days;
                        } else {
                            balance.halfpay.secondHalfUsed = secondHalfUsed + days;
                        }
                        
                        // Update total counters (for year summary)
                        balance.halfpay.used += days;
                        
                        saveLeaveBalancesToStorage();
                        return true;
                    }
                    break;
            }
            return false;
        }

        // User Logs System
        let userLogs = [];
        
        // Save data to localStorage/API
        async function saveAdmissionsToStorage() {
            // Validate admissions array before saving
            admissions = admissions.filter(admission => admission && admission.id && !isNaN(admission.id));
            
            // Try to save to API first, fallback to localStorage
            try {
                if (window.apiService && window.apiService.isOnline) {
                    // API is available, save to database
                    console.log('Saving admissions to database via API');
                    // Note: Individual records are saved via createAdmission/updateAdmission
                    // This function is kept for batch operations and fallback
                } else {
                    // Fallback to localStorage
                    localStorage.setItem('cantonment_admissions', JSON.stringify(admissions));
                }
            } catch (error) {
                console.error('Failed to save to API, using localStorage:', error);
                localStorage.setItem('cantonment_admissions', JSON.stringify(admissions));
            }
        }
        
        function saveDesignationsToStorage() {
            localStorage.setItem('cantonment_designations', JSON.stringify(designations));
        }
        
        function saveCodesToStorage() {
            localStorage.setItem('cantonment_codes', JSON.stringify(codes));
        }
        
        function saveUserLogsToStorage() {
            localStorage.setItem('cantonment_user_logs', JSON.stringify(userLogs));
        }
        
        // PDF Export Function
        function exportLogsToPDF() {
            // Get the currently displayed logs from the table
            const tableBody = document.getElementById('logsTableBody');
            const rows = tableBody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                alert('No logs to export');
                return;
            }
            
            // Create HTML content for PDF
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            font-size: 12px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .header h1 {
                            color: #333;
                            margin: 0;
                        }
                        .header p {
                            color: #666;
                            margin: 5px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        th, td {
                            border: 1px solid #ddd;
                            padding: 8px;
                            text-align: left;
                            font-size: 11px;
                        }
                        th {
                            background-color: #f2f2f2;
                            font-weight: bold;
                        }
                        .action-login { color: #28a745; }
                        .action-logout { color: #dc3545; }
                        .action-staff_create { color: #007bff; }
                        .action-staff_update { color: #ffc107; }
                        .action-designation_create { color: #6f42c1; }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10px;
                            color: #666;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Cantonment Board Ambala - User Activity Logs</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        <p>Total Records: ${rows.length}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Date & Time</th>
                                <th>User</th>
                                <th>Action</th>
                                <th>Details</th>
                                <th>IP Address</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Process each row
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 5) {
                    const timestamp = cells[0].textContent.trim();
                    const user = cells[1].textContent.trim().replace(/\n/g, ' ');
                    const action = cells[2].textContent.trim();
                    const details = cells[3].textContent.trim();
                    const ipAddress = cells[4].textContent.trim();
                    
                    htmlContent += `
                        <tr>
                            <td>${timestamp}</td>
                            <td>${user}</td>
                            <td class="action-${action.toLowerCase()}">${action}</td>
                            <td>${details}</td>
                            <td>${ipAddress}</td>
                        </tr>
                    `;
                }
            });
            
            htmlContent += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>This document was generated by Cantonment Board Ambala Administration System</p>
                        <p>Cantonment Board Ambala - ${new Date().getFullYear()}</p>
                    </div>
                </body>
                </html>
            `;
            
            // Create and download the file
            const element = document.createElement('a');
            const file = new Blob([htmlContent], { type: 'text/html' });
            element.href = URL.createObjectURL(file);
            element.download = `CBA_User_Logs_${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            
            // Show success message with instructions
            alert('User logs exported successfully!\n\nTo convert to PDF:\n1. Open the downloaded HTML file in your browser\n2. Press Ctrl+P (or Cmd+P on Mac)\n3. Select "Save as PDF" as destination\n4. Click Save');
        }
        
        // Initialize storage if first time loading
        if (!localStorage.getItem('cantonment_admissions')) {
            saveAdmissionsToStorage();
        }
        if (!localStorage.getItem('cantonment_designations')) {
            saveDesignationsToStorage();
        }
        if (!localStorage.getItem('cantonment_codes')) {
            saveCodesToStorage();
        }
        // Clear any existing user logs and start fresh
        localStorage.removeItem('cantonment_user_logs');
        saveUserLogsToStorage();
        
        // Load pension nominees from storage
        loadPensionNomineesFromStorage();
        // Load deductions from storage
        loadDeductionsFromStorage();
        if (!localStorage.getItem('cantonment_users')) {
            saveUsersToStorage();
        }
        
        // Add global event listener for table clicks
        document.addEventListener('click', function(event) {
            // Handle staff table buttons
            if (event.target.closest('.table-container')) {
                handleTableClick(event);
            }
        });

        // Login function
        function loginUser(event) {
            event.preventDefault();
            console.log('User login function called');
            
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            console.log('User credentials:', username, password);
            const errorDiv = document.getElementById('error');
            const successDiv = document.getElementById('success');
            
            console.log('Login attempt:', username);
            
            // Check against created users first
            const user = users.find(u => u.username === username && u.password === password && u.status === 'active');
            
            if (user) {
                isLoggedIn = true;
                currentUserRole = 'user';
                currentUserData = user;
                isOnline = false; // Use offline mode for now
                
                // Update user online status
                updateUserOnlineStatus(user.id, true);
                
                // Log the user login
                addUserLog(
                    user.id,
                    user.fullName,
                    user.email,
                    'login',
                    'User logged in successfully'
                );
                
                // Hide loading and show success
                successDiv.textContent = 'Login successful!';
                successDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                
                setTimeout(() => {
                    document.getElementById('roleSelection').style.display = 'none';
                    document.getElementById('dashboard').style.display = 'block';
                    // initializeSampleData(); // Disabled - no fake data
                    updateUserInterface();
                    updateUserRightsDisplay(); // Show user rights in header
                    loadDashboardData();
                }, 1000);
            } else {
                // Hide loading and show error
                errorDiv.textContent = 'Invalid credentials or account inactive.';
                errorDiv.style.display = 'block';
                successDiv.style.display = 'none';
                
                // Auto-hide error message after 3 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 3000);
            }
        }

        function handleLogout() {
            // Determine which logout function to call based on current state
            if (isAdminLoggedIn) {
                adminLogout();
            } else {
                logout();
            }
        }

        function logout() {
            // Close any open popups
            closeAllPopups();
            
            // Log the user logout and update online status
            if (currentUserData) {
                // Update user offline status
                updateUserOnlineStatus(currentUserData.id, false);
                
                addUserLog(
                    currentUserData.id,
                    currentUserData.fullName,
                    currentUserData.email,
                    'logout',
                    'User logged out'
                );
            }
            
            isLoggedIn = false;
            currentUserRole = '';
            currentUserData = null;
            authToken = '';
            document.getElementById('roleSelection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Clear any lingering messages
            const error = document.getElementById('error');
            const success = document.getElementById('success');
            if (error) {
                error.style.display = 'none';
                error.textContent = '';
            }
            if (success) {
                success.style.display = 'none';
                success.textContent = '';
            }
        }

        function markAllNotificationsRead() {
            // Mark all current notifications as read in daily tracking
            const today = new Date().toDateString();
            const todaysNotifications = JSON.parse(localStorage.getItem('daily_notifications_' + today) || '{}');
            
            // Mark all current notification types as read
            Object.keys(staffDeductions).forEach(staffId => {
                const deductionFields = [
                    'wheatAdvance', 'gic', 'lic', 'electricityBill', 'waterCharges', 'recovery',
                    'leaveDeductions', 'gppcSubscription', 'gpfExtraSubscription', 'gpfGovernmentContribution',
                    'gpfAdvanceRecovery', 'npsGovernmentContribution', 'npsSelfContribution', 
                    'gpfWithdrawl', 'gpfInterest', 'bankRecovery', 'incomeTax', 'surCharges',
                    'otherDeduction1', 'otherDeduction2', 'otherDeduction3', 'gpfLedBalance', 'gpfAdvanceBalance'
                ];
                
                deductionFields.forEach(field => {
                    const balance = parseFloat(staffDeductions[staffId][field]) || 0;
                    if (balance === 0) {
                        todaysNotifications[`deduction_${staffId}_${field}`] = true;
                    }
                });
                
                // Mark nominee notifications as read
                todaysNotifications[`nominee_${staffId}`] = true;
            });
            
            // Save updated tracking
            localStorage.setItem('daily_notifications_' + today, JSON.stringify(todaysNotifications));
            
            // Update badge to show 0 unread
            updateNotificationBadge();
            
            console.log('Marked all notifications as read');
        }

        function editUserProfile() {
            console.log('editUserProfile called');
            openEditProfile();
        }
        
        // Update admin UI with correct admin data
        function updateAdminUI() {
            if (currentUserRole === 'administrator' && currentUserData) {
                console.log('Updating admin UI with data:', currentUserData);
                
                // Update admin name in header
                const adminNameElement = document.getElementById('adminName');
                if (adminNameElement) {
                    adminNameElement.textContent = currentUserData.fullName;
                }
                
                // Update admin avatar with correct initials
                const adminAvatarElement = document.getElementById('adminAvatar');
                if (adminAvatarElement) {
                    const initials = currentUserData.fullName.split(' ')
                        .map(n => n[0])
                        .join('')
                        .toUpperCase()
                        .substring(0, 2);
                    adminAvatarElement.textContent = initials;
                }
                
                // Update admin role display
                const adminRoleElement = document.getElementById('adminRole');
                if (adminRoleElement) {
                    adminRoleElement.textContent = currentUserData.role || 'Administrator';
                }
                
                console.log('Admin UI updated successfully');
            }
        }
        
        // Make editUserProfile globally accessible
        window.editUserProfile = editUserProfile;
        
        // Edit Profile Modal Functions
        function openEditProfile() {
            console.log('openEditProfile called');
            const modal = document.getElementById('editProfileModal');
            console.log('Modal element found:', !!modal);
            console.log('Modal element:', modal);
            
            if (!modal) {
                alert('ERROR: Modal element not found!');
                return;
            }
            
            console.log('Modal current classes:', modal.className);
            console.log('Modal current style display:', modal.style.display);
            
            // Close other popups but NOT the edit profile modal
            const userDetailsPopup = document.getElementById('userDetailsPopup');
            const notificationsPopup = document.getElementById('notificationsPopup');
            const messagesPopup = document.getElementById('messagesPopup');
            
            if (userDetailsPopup) {
                userDetailsPopup.classList.remove('show');
                userDetailsPopup.style.display = 'none';
            }
            if (notificationsPopup) {
                notificationsPopup.classList.remove('show');
                notificationsPopup.style.display = 'none';
            }
            if (messagesPopup) {
                messagesPopup.classList.remove('show');
                messagesPopup.style.display = 'none';
            }
            
            modal.style.display = 'flex'; // Show the modal first
            
            // Use requestAnimationFrame to ensure display is set before adding show class
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
            
            console.log('Modal after adding show class:', modal.className);
            console.log('Modal after setting display:', modal.style.display);
            
            // Reset form when opening
            try {
                document.getElementById('editProfileForm').reset();
                document.getElementById('profileSuccessMessage').style.display = 'none';
                hideAllProfileErrors();
                
                // Load current user data into form
                loadCurrentUserData();
                
                // Add event listeners to prevent form clicks from closing modal
                addFormEventListeners();
                
                console.log('Form reset and data loaded successfully');
            } catch (error) {
                console.error('Error during form setup:', error);
                alert('Error setting up form: ' + error.message);
            }
        }
        
        function closeEditProfile() {
            console.log('closeEditProfile called');
            const modal = document.getElementById('editProfileModal');
            if (modal) {
                console.log('Closing modal - removing show class');
                modal.classList.remove('show');
                
                // Wait for opacity transition to complete before hiding
                setTimeout(() => {
                    modal.style.display = 'none';
                    console.log('Modal display set to none');
                }, 300); // Match the opacity transition duration
            }
        }
        
        
        function loadCurrentUserData() {
            let userData;
            
            if (currentUserRole === 'administrator') {
                // Try to get admin data from localStorage first
                const adminUsers = JSON.parse(localStorage.getItem('cantonment_admin_users')) || [];
                if (adminUsers.length > 0) {
                    userData = {
                        fullName: adminUsers[0].fullName || 'Super Admin',
                        username: adminUsers[0].username || 'superadmin',
                        email: adminUsers[0].email || 'admin@cba.gov.in'
                    };
                } else {
                    // Default admin data
                    userData = {
                        fullName: 'Super Admin',
                        username: 'superadmin',
                        email: 'admin@cba.gov.in'
                    };
                }
            } else if (currentUserData) {
                userData = {
                    fullName: currentUserData.fullName || currentUserData.name || 'User',
                    username: currentUserData.username || currentUserData.email?.split('@')[0] || 'user',
                    email: currentUserData.email || 'user@cba.gov.in'
                };
            } else {
                // Fallback data
                userData = {
                    fullName: 'User',
                    username: 'user',
                    email: 'user@cba.gov.in'
                };
            }
            
            // Populate form fields
            document.getElementById('editFullName').value = userData.fullName;
            document.getElementById('editUsername').value = userData.username;
            document.getElementById('editEmail').value = userData.email;
        }
        
        // Enable/disable new password fields based on current password
        document.addEventListener('DOMContentLoaded', function() {
            const currentPasswordField = document.getElementById('currentPassword');
            if (currentPasswordField) {
                currentPasswordField.addEventListener('input', function(e) {
                    const hasValue = e.target.value.length > 0;
                    const newPasswordField = document.getElementById('newPassword');
                    const confirmPasswordField = document.getElementById('confirmNewPassword');
                    
                    if (newPasswordField) newPasswordField.disabled = !hasValue;
                    if (confirmPasswordField) confirmPasswordField.disabled = !hasValue;
                    
                    if (!hasValue) {
                        if (newPasswordField) newPasswordField.value = '';
                        if (confirmPasswordField) confirmPasswordField.value = '';
                    }
                });
            }
        });
        
        function hideAllProfileErrors() {
            document.querySelectorAll('.validation-message').forEach(msg => {
                msg.classList.remove('show');
            });
        }
        
        function showProfileError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }
        
        function validateProfileForm() {
            hideAllProfileErrors();
            let isValid = true;
            
            // Validate name
            const fullName = document.getElementById('editFullName').value.trim();
            if (fullName.length < 2) {
                showProfileError('nameError', 'Name must be at least 2 characters');
                isValid = false;
            }
            
            // Validate username
            const username = document.getElementById('editUsername').value.trim();
            if (username.length < 3) {
                showProfileError('usernameError', 'Username must be at least 3 characters');
                isValid = false;
            }
            
            // Validate email
            const email = document.getElementById('editEmail').value.trim();
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showProfileError('emailError', 'Please enter a valid email address');
                isValid = false;
            }
            
            // Validate password if changing
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;
            
            if (currentPassword) {
                if (newPassword.length < 8) {
                    showProfileError('newPasswordError', 'New password must be at least 8 characters');
                    isValid = false;
                }
                
                if (newPassword !== confirmPassword) {
                    showProfileError('confirmPasswordError', 'Passwords do not match');
                    isValid = false;
                }
                
                // In a real implementation, you would verify the current password with the server
                // For now, we'll just check if it's not empty
                if (currentPassword.length < 1) {
                    showProfileError('currentPasswordError', 'Please enter your current password');
                    isValid = false;
                }
            }
            
            return isValid;
        }
        
        async function saveProfile(event) {
            event.preventDefault();
            
            if (validateProfileForm()) {
                    const saveButton = document.querySelector('.btn-save-profile');
                const originalText = saveButton.textContent;
                saveButton.textContent = 'Saving...';
                saveButton.disabled = true;
                
                try {
                    // Get form data
                    const formData = {
                        fullName: document.getElementById('editFullName').value.trim(),
                        username: document.getElementById('editUsername').value.trim(),
                        email: document.getElementById('editEmail').value.trim(),
                        currentPassword: document.getElementById('currentPassword').value,
                        newPassword: document.getElementById('newPassword').value
                    };
                    
                    // Validate credentials before updating
                    const validationResult = await validateUserCredentials(formData);
                    if (!validationResult.valid) {
                        showProfileError(validationResult.field, validationResult.message);
                        throw new Error(validationResult.message);
                    }
                    
                    let updateResult;
                    
                    if (currentUserRole === 'administrator') {
                        // Update admin profile
                        updateResult = await updateAdminProfile(formData);
                    } else if (currentUserData) {
                        // Update regular user profile
                        updateResult = await updateUserProfile(currentUserData.id, formData);
                    }
                    
                    if (updateResult.success) {
                        // Update UI elements with new data
                        updateUIWithNewUserData(formData);
                        
                        // Update current session data
                        if (currentUserData) {
                            currentUserData.fullName = formData.fullName;
                            currentUserData.username = formData.username;
                            currentUserData.email = formData.email;
                        }
                        
                        // Refresh admin user management table if it's currently displayed
                        refreshAdminUserTable();
                        
                        // Log the profile update
                        addUserLog(
                            currentUserData?.id || 0,
                            formData.fullName,
                            formData.email,
                            'profile_update',
                            'User profile updated successfully'
                        );
                        
                        // Show success message
                        document.getElementById('profileSuccessMessage').style.display = 'block';
                        
                        // Close modal after delay
                        setTimeout(() => {
                            closeEditProfile();
                        }, 1500);
                    } else {
                        throw new Error(updateResult.message || 'Failed to update profile');
                    }
                    
                } catch (error) {
                    console.error('Profile update failed:', error);
                    showProfileError('profileSuccessMessage', 'Failed to update profile: ' + error.message);
                } finally {
                    // Reset button state
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                }
            }
        }
        
        // Add event listeners to form elements to prevent modal closing
        function addFormEventListeners() {
            const formElements = document.querySelectorAll('#editProfileForm input, #editProfileForm label, #editProfileForm button, #editProfileForm .password-toggle');
            formElements.forEach(element => {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                element.addEventListener('focus', function(e) {
                    e.stopPropagation();
                });
            });
        }
        
        // Make profile functions globally accessible
        window.openEditProfile = openEditProfile;
        window.closeEditProfile = closeEditProfile;
        window.saveProfile = saveProfile;
        
        // Validate user credentials to prevent conflicts
        async function validateUserCredentials(formData) {
            // Check if username already exists for another user
            const existingUsers = JSON.parse(localStorage.getItem('cantonment_users')) || [];
            const usernameConflict = existingUsers.find(user => 
                user.username === formData.username && 
                user.id !== (currentUserData?.id || 0)
            );
            
            if (usernameConflict) {
                return {
                    valid: false,
                    field: 'usernameError',
                    message: 'Username already exists. Please choose a different username.'
                };
            }
            
            // Check if email already exists for another user
            const emailConflict = existingUsers.find(user => 
                user.email === formData.email && 
                user.id !== (currentUserData?.id || 0)
            );
            
            if (emailConflict) {
                return {
                    valid: false,
                    field: 'emailError',
                    message: 'Email already exists. Please use a different email address.'
                };
            }
            
            // In a real implementation, you would verify the current password with the server
            // For now, we'll simulate password verification
            if (formData.currentPassword && formData.newPassword) {
                // Simulate current password validation
                // In production, this should be a secure server-side verification
                console.log('Password change requested - verifying current password');
            }
            
            return { valid: true };
        }
        
        // Update admin profile
        async function updateAdminProfile(formData) {
            try {
                // Update admin data structure (if you have one)
                const adminData = {
                    fullName: formData.fullName,
                    username: formData.username,
                    email: formData.email,
                    role: 'administrator',
                    updatedAt: new Date().toISOString()
                };
                
                // If using API service, call backend
                if (window.apiService && window.apiService.isOnline) {
                    // In a real system, you'd have an admin-specific endpoint
                    console.log('Updating admin profile via API:', adminData);
                    // await window.apiService.updateAdminProfile(adminData);
                }
                
                // Update localStorage admin data
                const adminUsers = JSON.parse(localStorage.getItem('cantonment_admin_users')) || [];
                if (adminUsers.length > 0) {
                    adminUsers[0] = { ...adminUsers[0], ...adminData };
                } else {
                    // Create admin user entry if it doesn't exist
                    adminUsers.push({ id: 0, ...adminData, createdAt: new Date().toISOString() });
                }
                localStorage.setItem('cantonment_admin_users', JSON.stringify(adminUsers));
                
                // Update current admin display in header
                const adminNameElement = document.getElementById('adminName');
                if (adminNameElement) {
                    adminNameElement.textContent = formData.fullName;
                }
                
                // Update admin avatar with new initials
                const adminAvatarElement = document.getElementById('adminAvatar');
                if (adminAvatarElement) {
                    const initials = formData.fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    adminAvatarElement.textContent = initials;
                }
                
                return { success: true, message: 'Admin profile updated successfully' };
            } catch (error) {
                console.error('Admin profile update failed:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Update regular user profile with full synchronization
        async function updateUserProfile(userId, formData) {
            try {
                // Prepare user data for update
                const userData = {
                    id: userId,
                    fullName: formData.fullName,
                    username: formData.username,
                    email: formData.email,
                    updatedAt: new Date().toISOString()
                };
                
                // If password is being changed, hash it (in production, this should be done server-side)
                if (formData.newPassword) {
                    userData.password = formData.newPassword; // In production, hash this
                    userData.passwordUpdatedAt = new Date().toISOString();
                }
                
                // Use comprehensive synchronization across all systems
                const syncResult = await syncProfileDataAcrossSystem(userId, userData);
                
                if (syncResult.success) {
                    // Update global arrays used by various components
                    if (window.users) {
                        const globalUserIndex = window.users.findIndex(u => u.id === userId);
                        if (globalUserIndex !== -1) {
                            window.users[globalUserIndex] = { ...window.users[globalUserIndex], ...userData };
                        }
                    }
                    
                    if (window.admissions) {
                        const globalStaffIndex = window.admissions.findIndex(s => 
                            s.email === userData.email || s.staffName === userData.fullName
                        );
                        if (globalStaffIndex !== -1) {
                            window.admissions[globalStaffIndex] = {
                                ...window.admissions[globalStaffIndex],
                                staffName: userData.fullName,
                                email: userData.email,
                                lastModified: new Date().toISOString()
                            };
                        }
                    }
                    
                    return { success: true, message: 'Profile updated successfully across all systems' };
                } else {
                    throw new Error(syncResult.error || 'Synchronization failed');
                }
                
            } catch (error) {
                console.error('User profile update failed:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Refresh admin user management table if currently displayed
        function refreshAdminUserTable() {
            try {
                // Check if we're currently on the user management page
                const adminContent = document.getElementById('adminContent');
                if (adminContent && adminContent.innerHTML.includes('User Management')) {
                    console.log('Refreshing admin user management table');
                    showUserManagement(); // Refresh the user management view
                }
                
                // Also refresh the global users array
                if (window.users) {
                    window.users = JSON.parse(localStorage.getItem('cantonment_users')) || [];
                }
                
            } catch (error) {
                console.error('Failed to refresh admin user table:', error);
            }
        }
        
        // Comprehensive data synchronization function
        async function syncProfileDataAcrossSystem(userId, userData) {
            const syncTasks = [];
            
            try {
                // 1. Sync with backend API if available
                if (window.apiService && window.apiService.isOnline) {
                    syncTasks.push(
                        window.apiService.updateUser(userId, userData)
                            .then(() => console.log('Backend sync completed'))
                            .catch(error => console.error('Backend sync failed:', error))
                    );
                }
                
                // 2. Update all localStorage references
                syncTasks.push(updateLocalStorageReferences(userId, userData));
                
                // 3. Update UI elements across all portal sections
                syncTasks.push(updateAllUIReferences(userData));
                
                // 4. Notify all open windows/tabs (if using same domain)
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('cba_profile_updates');
                    channel.postMessage({
                        type: 'profile_updated',
                        userId: userId,
                        userData: userData,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Wait for all sync tasks to complete
                await Promise.allSettled(syncTasks);
                
                console.log('Profile synchronization completed across all systems');
                return { success: true };
                
            } catch (error) {
                console.error('Profile synchronization failed:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Update all localStorage references to maintain consistency
        async function updateLocalStorageReferences(userId, userData) {
            // Update main users array
            const users = JSON.parse(localStorage.getItem('cantonment_users')) || [];
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex] = { ...users[userIndex], ...userData };
                localStorage.setItem('cantonment_users', JSON.stringify(users));
            }
            
            // Update staff/admissions records if user is also staff
            const admissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || [];
            const staffIndex = admissions.findIndex(staff => 
                (staff.email && staff.email === userData.email) ||
                (staff.userId && staff.userId === userId)
            );
            if (staffIndex !== -1) {
                admissions[staffIndex] = {
                    ...admissions[staffIndex],
                    staffName: userData.fullName,
                    email: userData.email,
                    lastModified: new Date().toISOString()
                };
                localStorage.setItem('cantonment_admissions', JSON.stringify(admissions));
            }
            
            // Update any session data
            if (currentUserData && currentUserData.id === userId) {
                Object.assign(currentUserData, userData);
            }
            
            // Update login credentials cache (if exists)
            const loginCache = JSON.parse(localStorage.getItem('cantonment_login_cache')) || {};
            if (loginCache[userData.username] || loginCache[userData.email]) {
                // Update cached credentials
                const oldUsername = Object.keys(loginCache).find(key => 
                    loginCache[key].userId === userId
                );
                if (oldUsername && oldUsername !== userData.username) {
                    delete loginCache[oldUsername];
                }
                loginCache[userData.username] = {
                    userId: userId,
                    fullName: userData.fullName,
                    email: userData.email,
                    lastLogin: new Date().toISOString()
                };
                localStorage.setItem('cantonment_login_cache', JSON.stringify(loginCache));
            }
        }
        
        // Update all UI references across the application
        async function updateAllUIReferences(userData) {
            // Update header user information
            const userNameElements = document.querySelectorAll('#userName, #adminName, .user-name');
            userNameElements.forEach(element => {
                if (element) element.textContent = userData.fullName;
            });
            
            // Update user avatars with new initials
            const initials = userData.fullName.split(' ')
                .map(n => n[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
                
            const avatarElements = document.querySelectorAll('#userAvatar, #adminAvatar, .user-avatar');
            avatarElements.forEach(element => {
                if (element) element.textContent = initials;
            });
            
            // Update user details popup
            const userDetailsPopup = document.getElementById('userDetailsPopup');
            if (userDetailsPopup) {
                const avatarLarge = document.getElementById('userAvatarLarge');
                const nameLarge = document.getElementById('userNameLarge');
                const emailElements = userDetailsPopup.querySelectorAll('.user-detail-value');
                
                if (avatarLarge) avatarLarge.textContent = initials;
                if (nameLarge) nameLarge.textContent = userData.fullName;
                
                // Update email display in user details
                emailElements.forEach(element => {
                    if (element.parentElement.querySelector('.user-detail-label')?.textContent === 'Email') {
                        element.textContent = userData.email;
                    }
                });
            }
            
            // Update any staff tables or lists currently displayed
            const staffTables = document.querySelectorAll('.staff-table, .user-list, .admissions-table');
            staffTables.forEach(table => {
                const rows = table.querySelectorAll('tr, .staff-item, .user-item');
                rows.forEach(row => {
                    const emailCell = row.querySelector(`[data-email="${userData.email}"]`);
                    const nameCell = row.querySelector('.staff-name, .user-name');
                    if (emailCell || (nameCell && nameCell.textContent.includes(userData.fullName))) {
                        // Update the row with new information
                        if (nameCell) nameCell.textContent = userData.fullName;
                        if (emailCell) emailCell.textContent = userData.email;
                    }
                });
            });
        }
        
        function updateUIWithNewUserData(userData) {
            // Update user name displays
            const userNameElements = document.querySelectorAll('#userName, #adminName');
            userNameElements.forEach(element => {
                if (element) element.textContent = userData.fullName;
            });
            
            // Update user avatars with new initials
            const initials = userData.fullName.split(' ').map(n => n[0]).join('').toUpperCase();
            const avatarElements = document.querySelectorAll('#userAvatar, #adminAvatar');
            avatarElements.forEach(element => {
                if (element) element.textContent = initials;
            });
            
            // Update any other UI elements that display user info
            const userDetailsPopup = document.getElementById('userDetailsPopup');
            if (userDetailsPopup) {
                const avatarLarge = document.getElementById('userAvatarLarge');
                const nameLarge = document.getElementById('userNameLarge');
                
                if (avatarLarge) avatarLarge.textContent = initials;
                if (nameLarge) nameLarge.textContent = userData.fullName;
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', function() {
            const editModal = document.getElementById('editProfileModal');
            if (editModal) {
                editModal.addEventListener('click', function(e) {
                    // Only close if clicking on the modal overlay (not the content)
                    if (e.target === this) {
                        closeEditProfile();
                    }
                });
                
                // Prevent form content clicks from bubbling up to the modal
                const modalContent = editModal.querySelector('.edit-profile-content');
                if (modalContent) {
                    modalContent.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }
            }
            
            // Listen for profile updates from other tabs/windows
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('cba_profile_updates');
                channel.onmessage = function(event) {
                    if (event.data.type === 'profile_updated') {
                        console.log('Received profile update from another tab:', event.data);
                        
                        // Update current session if it's the same user
                        if (currentUserData && currentUserData.id === event.data.userId) {
                            Object.assign(currentUserData, event.data.userData);
                            updateAllUIReferences(event.data.userData);
                        }
                        
                        // Refresh admin table if currently displayed
                        refreshAdminUserTable();
                    }
                };
            }
        });

        // Header functionality
        function showMessages() {
            const popup = document.getElementById('messagesPopup');
            const body = document.getElementById('messagesBody');
            const isCurrentlyOpen = popup && popup.classList.contains('show');
            
            // Close all popups
            closeAllPopups();
            
            // If the messages popup wasn't open, open it
            if (!isCurrentlyOpen) {
            
            // Sample messages data
            const messages = [
                {
                    id: 1,
                    sender: 'Admin Department',
                    initials: 'AD',
                    subject: 'New policy update regarding staff attendance',
                    message: 'New policy update regarding staff attendance has been implemented. Please review the attached document for detailed information.',
                    time: '5 minutes ago',
                    unread: true
                },
                {
                    id: 2,
                    sender: 'HR Department',
                    initials: 'HR',
                    subject: 'Annual performance reviews reminder',
                    message: 'Reminder: Annual performance reviews are due by the end of this month. Please ensure all evaluations are completed.',
                    time: '2 hours ago',
                    unread: true
                },
                {
                    id: 3,
                    sender: 'System',
                    initials: 'SY',
                    subject: 'System maintenance completed',
                    message: 'System maintenance completed successfully. All services are now operational.',
                    time: 'Yesterday',
                    unread: false
                }
            ];
            
            // Update message count
            const unreadCount = messages.filter(m => m.unread).length;
            const countElement = document.getElementById('messagesCount');
            if (countElement) {
                countElement.textContent = unreadCount + ' new';
            }
            
            // Generate messages HTML
            if (messages.length > 0) {
                body.innerHTML = messages.map(message => `
                    <div class="message-item ${message.unread ? 'unread' : ''}">
                        <div class="message-header">
                            <div class="message-sender">
                                <div class="message-avatar">${message.initials}</div>
                                <div class="message-info">
                                    <div class="message-name">${message.sender}</div>
                                    <div class="message-time">${message.time}</div>
                                </div>
                            </div>
                        </div>
                        <div class="message-content">${message.message}</div>
                    </div>
                `).join('');
            } else {
                body.innerHTML = '<div class="messages-empty">No messages</div>';
            }
            
            // Show popup
                popup.style.display = 'block';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }
        
        function switchMessageTab(tab, type) {
            // Remove active class from all tabs
            document.querySelectorAll('.message-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            // Here you would filter messages based on type
            console.log('Switching to message tab:', type);
        }

        function showNotifications() {
            const popup = document.getElementById('notificationsPopup');
            const body = document.getElementById('notificationsBody');
            const isCurrentlyOpen = popup && popup.classList.contains('show');
            
            console.log('showNotifications called - popup element:', popup);
            console.log('showNotifications called - body element:', body);
            
            // Close all popups
            closeAllPopups();
            
            // If the notifications popup wasn't open, open it
            if (!isCurrentlyOpen) {
            
            // Generate dynamic notifications
            const notifications = generateDynamicNotifications();
            console.log('Generated notifications:', notifications);
            
            // Update notification count
            const unreadCount = notifications.filter(n => n.unread).length;
            const badge = document.getElementById('notificationsBadge');
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'block' : 'none';
            
            // Generate notification HTML
            if (notifications.length > 0) {
                const getIconSymbol = (type) => {
                    switch(type) {
                        case 'success': return '‚úì';
                        case 'warning': return '‚ö†';
                        case 'info': return '‚Ñπ';
                        case 'error': return '‚úï';
                        default: return 'üì¢';
                    }
                };
                
                body.innerHTML = notifications.map(notification => `
                    <div class="notification-item ${notification.unread ? 'unread' : ''}">
                        <div class="notification-icon ${notification.type}">
                            ${getIconSymbol(notification.type)}
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${notification.time}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                body.innerHTML = '<div class="notifications-empty">No new notifications</div>';
            }
            
            // Show popup
                popup.style.display = 'block';
                setTimeout(() => {
                    popup.classList.add('show');
                }, 10);
            }
        }

        function updateUserRightsDisplay() {
            // Display current user permissions in the header
            const headerName = document.querySelector('.header-name');
            if (headerName && currentUserData && currentUserData.permissions) {
                // Get all permissions across all tabs
                const allPermissions = [];
                Object.keys(currentUserData.permissions).forEach(tab => {
                    const tabPermissions = currentUserData.permissions[tab];
                    if (Array.isArray(tabPermissions)) {
                        tabPermissions.forEach(perm => {
                            if (!allPermissions.includes(perm)) {
                                allPermissions.push(perm);
                            }
                        });
                    }
                });
                
                const permissionsText = allPermissions.map(p => p.charAt(0).toUpperCase() + p.slice(1)).join(', ');
                headerName.innerHTML = `
                    <div style="text-align: right;">
                        <div>Welcome, ${currentUserData.fullName}</div>
                        <div style="font-size: 12px; color: #666; margin-top: 2px;">
                            Permissions: ${permissionsText || 'None'}
                        </div>
                    </div>
                `;
            }
        }

        function updateNavigationBasedOnPermissions() {
            if (!currentUserData) return;
            
            // Handle backward compatibility: convert old rights to permissions
            if (!currentUserData.permissions && currentUserData.rights && Array.isArray(currentUserData.rights)) {
                currentUserData.permissions = {
                    'dashboard': currentUserData.rights
                };
            }
            
            if (!currentUserData.permissions) return;
            
            // Get all navigation items
            const navItems = document.querySelectorAll('#sidebar .nav-item');
            let enabledTabs = [];
            let firstEnabledTab = null;
            
            navItems.forEach(navItem => {
                const navText = navItem.querySelector('.nav-text');
                if (!navText) return;
                
                const itemText = navText.textContent.toLowerCase();
                let tabKey = null;
                
                // Map navigation text to permission tab key
                if (itemText === 'dashboard') tabKey = 'dashboard';
                else if (itemText === 'designations') tabKey = 'designations';
                else if (itemText === 'codes') tabKey = 'codes';
                else if (itemText === 'leave management') tabKey = 'leave';
                else if (itemText === 'attendance') tabKey = 'attendance';
                else if (itemText === 'pay slip') tabKey = 'payslip';
                else if (itemText === 'ps verification') tabKey = 'ps-verification';
                else if (itemText === 'deduction balance overview') tabKey = 'deduction-balance';
                
                // Always show the tab, but enable/disable based on permissions
                navItem.style.display = 'flex';
                
                if (tabKey && currentUserData.permissions[tabKey] && currentUserData.permissions[tabKey].length > 0) {
                    // User has permissions for this tab - enable it
                    navItem.classList.remove('disabled-by-permissions');
                    navItem.style.pointerEvents = 'auto';
                    enabledTabs.push(tabKey);
                    if (!firstEnabledTab) firstEnabledTab = tabKey;
                } else {
                    // User doesn't have permissions for this tab - disable it
                    navItem.classList.add('disabled-by-permissions');
                    navItem.style.pointerEvents = 'none';
                }
            });
            
            // If current section is not accessible, switch to first enabled tab
            if (currentSection && !enabledTabs.includes(currentSection) && firstEnabledTab) {
                showSection(firstEnabledTab);
            }
        }
        
        function updateUserInterface() {
            if (currentUserData && currentUserRole === 'user') {
                // Update user name in header
                const userNameElement = document.getElementById('userName');
                const userAvatarElement = document.getElementById('userAvatar');
                
                if (userNameElement && currentUserData.fullName) {
                    userNameElement.textContent = currentUserData.fullName;
                }
                
                // Update avatar with initials
                if (userAvatarElement && currentUserData.fullName) {
                    const initials = currentUserData.fullName.split(' ')
                        .map(name => name.charAt(0))
                        .join('')
                        .substring(0, 2)
                        .toUpperCase();
                    userAvatarElement.textContent = initials;
                }

                // Update navigation based on permissions
                updateNavigationBasedOnPermissions();
            }
        }

        function toggleUserMenu(event) {
            console.log('toggleUserMenu called');
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const popup = document.getElementById('userDetailsPopup');
            const isCurrentlyOpen = popup && popup.classList.contains('show');
            
            // Close all popups first
            closeAllPopups();
            
            // If the user popup wasn't open, open it
            if (!isCurrentlyOpen) {
            const avatarLarge = document.getElementById('userAvatarLarge');
            const nameLarge = document.getElementById('userNameLarge');
            const roleLarge = document.getElementById('userRoleLarge');
            const detailsBody = document.getElementById('userDetailsBody');
            
            console.log('Elements found:', {
                popup: !!popup,
                avatarLarge: !!avatarLarge,
                nameLarge: !!nameLarge,
                roleLarge: !!roleLarge,
                detailsBody: !!detailsBody
            });
            
            let userData, userRole;
            
            if (currentUserRole === 'administrator') {
                console.log('Loading admin user data for popup');
                console.log('currentUserData:', currentUserData);
                console.log('currentUserRole:', currentUserRole);
                
                // Priority 1: Use currentUserData if it's admin data
                if (currentUserData && currentUserData.role === 'Administrator') {
                    userData = {
                        fullName: currentUserData.fullName,
                        username: currentUserData.username,
                        email: currentUserData.email,
                        role: 'Administrator',
                        status: currentUserData.status || 'Active',
                        department: 'Administration',
                        lastLogin: 'Today, ' + new Date().toLocaleTimeString()
                    };
                    console.log('Using currentUserData for admin popup');
                } else {
                    // Priority 2: Try to get admin data from localStorage
                    const adminUsers = JSON.parse(localStorage.getItem('cantonment_admin_users')) || [];
                    console.log('adminUsers from localStorage:', adminUsers);
                    
                    if (adminUsers.length > 0) {
                        userData = {
                            fullName: adminUsers[0].fullName || 'Super Admin',
                            username: adminUsers[0].username || 'superadmin',
                            email: adminUsers[0].email || 'admin@cba.gov.in',
                            role: 'Administrator',
                            status: 'Active',
                            department: 'Administration',
                            lastLogin: 'Today, ' + new Date().toLocaleTimeString()
                        };
                        console.log('Using localStorage admin data for popup');
                    } else {
                        // Priority 3: Use header display as fallback
                        const currentName = document.getElementById('adminName')?.textContent || 'Super Admin';
                        userData = {
                            fullName: currentName,
                            username: 'superadmin',
                            email: 'admin@cba.gov.in',
                            role: 'Administrator',
                            status: 'Active',
                            department: 'Administration',
                            lastLogin: 'Today, ' + new Date().toLocaleTimeString()
                        };
                        console.log('Using header display name for popup');
                    }
                }
                userRole = 'Administrator';
            } else if (currentUserData) {
                userData = {
                    fullName: currentUserData.fullName || 'N/A',
                    username: currentUserData.username || 'N/A',
                    email: currentUserData.email || 'Not provided',
                    role: currentUserData.role || 'User',
                    status: currentUserData.status || 'Active',
                    department: currentUserData.department || 'General',
                    lastLogin: 'Today, ' + new Date().toLocaleTimeString()
                };
                userRole = currentUserData.role || 'User';
            } else {
                userData = {
                    fullName: 'Guest User',
                    username: 'guest',
                    email: 'Not provided',
                    role: 'Guest',
                    status: 'Active',
                    department: 'General',
                    lastLogin: 'Now'
                };
                userRole = 'Guest';
            }
            
            // Update header
            avatarLarge.textContent = userData.fullName.substring(0, 2).toUpperCase();
            nameLarge.textContent = userData.fullName;
            roleLarge.textContent = userRole;
            
            // Update details body
            detailsBody.innerHTML = `
                <div class="user-detail-item">
                    <div class="user-detail-icon">üë§</div>
                    <div class="user-detail-content">
                        <div class="user-detail-label">Username</div>
                        <div class="user-detail-value">${userData.username}</div>
                    </div>
                </div>
                
                <div class="user-detail-item">
                    <div class="user-detail-icon">üìß</div>
                    <div class="user-detail-content">
                        <div class="user-detail-label">Email</div>
                        <div class="user-detail-value">${userData.email}</div>
                    </div>
                </div>
                
                <div class="user-detail-item">
                    <div class="user-detail-icon">üè¢</div>
                    <div class="user-detail-content">
                        <div class="user-detail-label">Department</div>
                        <div class="user-detail-value">${userData.department}</div>
                    </div>
                </div>
                
                <div class="user-detail-item">
                    <div class="user-detail-icon">‚ö°</div>
                    <div class="user-detail-content">
                        <div class="user-detail-label">Status</div>
                        <div class="user-detail-value">
                            <span class="user-status ${userData.status.toLowerCase()}">${userData.status}</span>
                        </div>
                    </div>
                </div>
                
                <div class="user-detail-item">
                    <div class="user-detail-icon">üïê</div>
                    <div class="user-detail-content">
                        <div class="user-detail-label">Last Login</div>
                        <div class="user-detail-value">${userData.lastLogin}</div>
                    </div>
                </div>
                
                <div class="user-detail-item" style="padding-top: 20px; border-top: 1px solid #f0f0f0; margin-top: 20px;">
                    <div style="display: flex; gap: 12px; width: 100%;">
                        <button class="user-action-btn secondary" onclick="editUserProfile()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #f5f5f5; color: #666; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f5f5f5'">
                            ‚úèÔ∏è Edit Profile
                        </button>
                        <button class="user-action-btn primary" onclick="handleLogout()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #1976d2; color: white; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='#1565c0'" onmouseout="this.style.background='#1976d2'">
                            üö™ Logout
                        </button>
                    </div>
                </div>
            `;
            
            // Show the popup (since it wasn't open before)
                popup.classList.add('show');
                popup.style.display = 'block';
                console.log('User popup opened');
            }
        }

        // Make toggleUserMenu globally accessible
        window.toggleUserMenu = toggleUserMenu;

        function loadDashboardData() {
            // Refresh data from localStorage to ensure we have the latest data
            admissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || [];
            designations = JSON.parse(localStorage.getItem('cantonment_designations')) || [];
            codes = JSON.parse(localStorage.getItem('cantonment_codes')) || [];
            
            // Initialize staff deductions with sample data if none exist
            initializeStaffDeductions();
            
            updateConnectionStatus();
            updateDesignationDropdown(); // Ensure dropdown is populated
            updateCodeDropdowns(); // Ensure code dropdowns are populated
            updateDashboardDesignationFilter(); // Ensure dashboard filter is populated
            showSection('dashboard');
        }

        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connectionStatus');
            if (statusDiv) {
                if (isOnline) {
                    statusDiv.className = 'connection-status status-online';
                    statusDiv.innerHTML = '‚úÖ Connected to backend API - Live data';
                } else {
                    statusDiv.className = 'connection-status status-offline';
                    statusDiv.innerHTML = '‚ö†Ô∏è Offline mode - Using local demo data';
                }
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar') || document.getElementById('adminSidebar');
            if (sidebar) {
                sidebar.classList.toggle('open');
            }
        }

        function showSection(section) {
            // Check if user has permission to access this section
            if (currentUserData && currentUserData.permissions) {
                const hasAccess = currentUserData.permissions[section] && currentUserData.permissions[section].length > 0;
                if (!hasAccess) {
                    // Show a more user-friendly message and don't prevent the action
                    const sectionName = section.charAt(0).toUpperCase() + section.slice(1);
                    alert(`Access restricted: You need permissions to view the ${sectionName} section. Please contact your administrator.`);
                    return;
                }
            }
            
            // Close any open popups when switching sections
            closeAllProfessionalModals();
            closeAllPopups();
            
            currentSection = section;
            const content = document.getElementById('content');
            
            // Update nav active state - now for sidebar navigation
            document.querySelectorAll('#sidebar .nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const clickedItem = event && event.target ? event.target.closest('.nav-item') : null;
            if (clickedItem) {
                clickedItem.classList.add('active');
            } else {
                // If no event, find by section name
                document.querySelectorAll('#sidebar .nav-item').forEach(item => {
                    const navText = item.querySelector('.nav-text');
                    if (navText) {
                        const itemText = navText.textContent.toLowerCase();
                        if (itemText === section || (section === 'dashboard' && itemText === 'dashboard')) {
                            item.classList.add('active');
                        }
                    }
                });
            }
            
            // Close sidebar on mobile after navigation
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
            }
            
            switch(section) {
                case 'dashboard':
                    const designationCounts = {};
                    admissions.forEach(admission => {
                        const designation = admission.designation || 'Unassigned';
                        designationCounts[designation] = (designationCounts[designation] || 0) + 1;
                    });
                    
                    content.innerHTML = `
                        <div class="dashboard-header">
                            <h3>Staff Management (<span id="filteredCount">${admissions.length}</span> records)</h3>
                        </div>
                        
                        <div class="unified-search-container">
                            <input type="text" id="admissionSearch" class="search-input-expanded" placeholder="Search by Staff ID or Name..." 
                                   onkeypress="return /[a-zA-Z0-9\s]/.test(event.key)"
                                   oninput="handleSearchInput(this); filterAdmissions()">
                            <select id="designationFilter" class="designation-filter-compact" onchange="filterByDesignation(this.value)">
                                <option value="all">All Designations</option>
                                ${designations.sort((a, b) => a.name.localeCompare(b.name)).map(designation => 
                                    `<option value="${designation.name}">${designation.name}</option>`
                                ).join('')}
                            </select>
                            <button class="action-btn action-btn-clear" onclick="clearAdmissionSearch()">Clear</button>
                            ${canWriteSection('dashboard') ? '<button class="action-btn action-btn-primary" onclick="openAdmissionModal()">+ Add New Staff</button>' : ''}
                        </div>
                        
                        <div class="table-container" id="staffTableContainer">
                            <table id="admissionsTable">
                                <thead>
                                    <tr>
                                        <th>Staff ID</th>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Mobile</th>
                                        <th>Nationality</th>
                                        <th>Nominee</th>
                                        <th>Deductions</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="admissionsTableBody">
                                    ${admissions.length === 0 ? '<tr><td colspan="8" class="loading">No staff records found. Click "Add New Staff" to create one.</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    console.log('About to initialize paginated admissions table, admissions array:', admissions);
                    initializeStaffTablePagination(admissions);
                    break;
                    
                case 'pending':
                    showPendingRequestsContent();
                    break;
                    
                    
                case 'designations':
                    showDesignations();
                    break;
                    
                case 'codes':
                    showCodes();
                    break;
                case 'leave':
                    showLeaveManagement();
                    break;
                case 'attendance':
                    showAttendanceNew();
                    break;
                case 'payslip':
                    showPaySlip();
                    break;
                case 'ps-verification':
                    showPSVerification();
                    break;
                case 'deduction-balance':
                    showDeductionBalance();
                    break;
            }
        }


        function renderAdmissionsTable(dataToShow) {
            console.log('renderAdmissionsTable called with data:', dataToShow);
            const tbody = document.getElementById('admissionsTableBody');
            console.log('tbody element:', tbody);
            
            if (dataToShow.length > 0) {
                    tbody.innerHTML = dataToShow.map((admission, index) => {
                    // Generate colorful gradient for initials
                    const gradients = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)',
                        'linear-gradient(135deg, #c471ed 0%, #f64f59 100%)'
                    ];
                    const gradient = gradients[index % gradients.length];
                    const initials = (admission.staffName || 'N/A').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    
                    return `
                    <tr>
                        <td><strong>${admission.staffId || 'N/A'}</strong></td>
                        <td>
                            <div class="staff-name-with-photo">
                                ${admission.photo ? 
                                    `<img data-src="${admission.photo}" alt="Staff Photo" class="staff-photo lazy-image" data-admission-id="${admission.id}" data-action="photo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect width='40' height='40' fill='%23f0f0f0'/%3E%3C/svg%3E">` : 
                                    `<div class="staff-photo-placeholder" style="background: ${gradient}; color: white; font-weight: 600;">${initials}</div>`
                                }
                                <span>${admission.staffName || 'N/A'}</span>
                            </div>
                        </td>
                        <td>${admission.designation || 'N/A'}</td>
                        <td>${admission.mobileNumber || 'N/A'}</td>
                        <td>${admission.nationality || 'N/A'}</td>
                        <td style="text-align: center;">
                            ${canWrite() ? `<button class="btn btn-primary btn-small" onclick="openPensionNomineeModal(${admission.id})" title="Add Nominee">+</button>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td style="text-align: center;">
                            ${canWrite() ? `<button class="btn btn-primary btn-small" onclick="openDeductionsModal(${admission.id})" title="Manage Deductions">+</button>` : '<span style="color: #999;">-</span>'}
                        </td>
                        <td>
                            <button class="btn btn-info btn-small" onclick="viewStaffDetails(${admission.id})">Details</button>
                            ${canEditSection('dashboard') ? `<button class="btn btn-success btn-small" onclick="editAdmission(${admission.id})">Edit</button>` : ''}
                            ${canEditSection('dashboard') ? `<button class="btn btn-danger btn-small" onclick="deleteAdmission(${admission.id})">Delete</button>` : ''}
                            ${!canEditSection('dashboard') ? '<span style="color: #999;">View Only</span>' : ''}
                        </td>
                    </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No Records found.</td></tr>';
            }
            
            // Initialize lazy loading for newly added images
            window.lazyLoader.observe();
            
            // Event listener is added at document level in initialization
        }
        
        function handleTableClick(event) {
            console.log('handleTableClick called', event.target);
            
            // Check if clicked element is a button
            if (event.target.tagName === 'BUTTON') {
                const action = event.target.getAttribute('data-action');
                
                // Handle user management actions directly here
                if (action === 'edit-user') {
                    const userId = parseInt(event.target.getAttribute('data-user-id'));
                    console.log('Edit user button clicked, userId:', userId);
                    editUser(userId);
                    return;
                } else if (action === 'delete-user') {
                    const userId = parseInt(event.target.getAttribute('data-user-id'));
                    deleteUser(userId);
                    return;
                }
                
                // Handle admission actions only
                const admissionId = parseInt(event.target.getAttribute('data-admission-id'));
                console.log('Button clicked:', action, admissionId);
                
                if (action === 'edit') {
                    editAdmission(admissionId);
                } else if (action === 'delete') {
                    deleteAdmission(admissionId);
                } else if (action === 'pension') {
                    openPensionNomineeModal(admissionId);
                }
                return;
            }
            
            // Check for photo click
            if (event.target.tagName === 'IMG' && event.target.getAttribute('data-action') === 'photo') {
                const admissionId = parseInt(event.target.getAttribute('data-admission-id'));
                openPhotoModalById(admissionId);
                return;
            }
        }

        function filterAdmissions() {
            const searchTerm = document.getElementById('admissionSearch').value.toLowerCase();
            const designationFilter = document.getElementById('designationFilter');
            const selectedDesignation = designationFilter ? designationFilter.value : 'all';
            const filteredCountSpan = document.getElementById('filteredCount');
            
            let filtered = admissions;
            
            // Apply designation filter
            if (selectedDesignation !== 'all') {
                filtered = filtered.filter(admission => 
                    (admission.designation || 'Unassigned') === selectedDesignation
                );
            }
            
            // Apply search filter
            if (searchTerm.trim()) {
                filtered = filtered.filter(admission => 
                    (admission.staffId && admission.staffId.toLowerCase().includes(searchTerm)) ||
                    (admission.staffName && admission.staffName.toLowerCase().includes(searchTerm))
                );
            }
            
            // Update filtered count
            if (filteredCountSpan) {
                filteredCountSpan.textContent = filtered.length;
            }
            
            // Use pagination for filtered results
            if (window.paginationManagers['staffTableContainer']) {
                window.paginationManagers['staffTableContainer'].updateData(filtered);
            } else {
                renderAdmissionsTable(filtered);
            }
        }

        function clearAdmissionSearch() {
            const searchInput = document.getElementById('admissionSearch');
            const designationFilter = document.getElementById('designationFilter');
            
            if (searchInput) {
                searchInput.value = '';
            }
            
            if (designationFilter) {
                designationFilter.value = 'all';
            }
            
            // Show all records
            renderAdmissionsTable(admissions);
            
            // Reset filtered count
            const filteredCountSpan = document.getElementById('filteredCount');
            if (filteredCountSpan) {
                filteredCountSpan.textContent = admissions.length;
            }
            const allCards = document.querySelectorAll('.stat-card');
            allCards.forEach(card => {
                card.style.backgroundColor = '';
                card.style.color = '';
            });
        }
        
        // Filter by designation functionality
        function filterByDesignation(designation) {
            const searchInput = document.getElementById('admissionSearch');
            const filteredCountSpan = document.getElementById('filteredCount');
            
            // Clear search input
            if (searchInput) {
                searchInput.value = '';
            }
            
            let filteredData;
            if (designation === 'all') {
                filteredData = admissions;
            } else {
                filteredData = admissions.filter(admission => 
                    (admission.designation || 'Unassigned') === designation
                );
            }
            
            // Update filtered count
            if (filteredCountSpan) {
                filteredCountSpan.textContent = filteredData.length;
            }
            
            renderAdmissionsTable(filteredData);
            
            // Visual feedback - highlight selected card
            const allCards = document.querySelectorAll('.stat-card');
            allCards.forEach(card => {
                card.style.backgroundColor = '';
                card.style.color = '';
            });
            
            // Highlight the clicked card
            const cardText = designation === 'all' ? 'Total Staff' : designation;
            allCards.forEach(card => {
                const cardParagraph = card.querySelector('p');
                if (cardParagraph && cardParagraph.textContent === cardText) {
                    card.style.backgroundColor = '#1976d2';
                    card.style.color = 'white';
                }
            });
        }

        function showDesignations() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="section-header">
                    <h3>Designations Management (${designations.length} records)</h3>
                    ${canWriteSection('designations') ? '<button class="btn btn-primary" onclick="openDesignationModal()">+ Add Designation</button>' : ''}
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Designation Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="designationsTableBody">
                            ${designations.length === 0 ? '<tr><td colspan="2" class="loading">No designations found.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('designationsTableBody');
            if (designations.length > 0) {
                tbody.innerHTML = designations.map(designation => `
                    <tr>
                        <td><strong>${designation.name}</strong></td>
                        <td>
                            ${canEditSection('designations') ? `<button class="btn btn-success btn-small" onclick="editDesignation(${designation.id})">Edit</button>` : ''}
                            ${canEditSection('designations') ? `<button class="btn btn-danger btn-small" onclick="deleteDesignation(${designation.id})">Delete</button>` : ''}
                            ${!canEditSection('designations') ? '<span style="color: #999;">View Only</span>' : ''}
                        </td>
                    </tr>
                `).join('');
            }
        }

        function showCodes() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="section-header">
                    <h3>Codes Management (${codes.length} records)</h3>
                    ${canWriteSection('codes') ? '<button class="btn btn-primary" onclick="openCodeModal()">+ Create New Code</button>' : ''}
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="codesTableBody">
                            ${codes.length === 0 ? '<tr><td colspan="4" class="loading">No codes found.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            `;
            
            const tbody = document.getElementById('codesTableBody');
            if (codes.length > 0) {
                tbody.innerHTML = codes.map(code => `
                    <tr>
                        <td><strong>${code.code}</strong></td>
                        <td>${code.type}</td>
                        <td>${code.description}</td>
                        <td>
                            ${canEditSection('codes') ? `<button class="btn btn-success btn-small" onclick="editCode(${code.id})">Edit</button>` : ''}
                            ${canEditSection('codes') ? `<button class="btn btn-danger btn-small" onclick="deleteCode(${code.id})">Delete</button>` : ''}
                            ${!canEditSection('codes') ? '<span style="color: #999;">View Only</span>' : ''}
                        </td>
                    </tr>
                `).join('');
            }
        }

        // Modal functions
        function openAdmissionModal(admission = null) {
            // Check permissions
            if (!admission && !canWriteSection('dashboard')) {
                alert("You don't have permission to add new staff.");
                return;
            }
            if (admission && !canEditSection('dashboard')) {
                alert("You don't have permission to edit staff information.");
                return;
            }
            const modal = document.getElementById('admissionModal');
            const title = document.getElementById('admissionModalTitle');
            const professionalTitle = document.getElementById('admissionProfessionalTitle');
            const professionalSubtitle = document.getElementById('admissionProfessionalSubtitle');
            const saveBtn = document.getElementById('admissionSaveBtn');
            
            // Reset Pay Cell dropdown to prevent stale values from previous edits
            const payCellElement = document.getElementById('payCell');
            payCellElement.innerHTML = '<option value="">Select Pay Cell</option>';
            payCellElement.disabled = true;
            
            if (admission) {
                title.textContent = 'Edit Admission Record';
                professionalTitle.textContent = 'Edit Staff Record';
                professionalSubtitle.textContent = 'Update the information for this staff member';
                saveBtn.textContent = 'Save Changes';
                
                // Set the admission ID first - ensure it's a valid number
                if (admission.id && !isNaN(admission.id)) {
                    document.getElementById('admissionId').value = admission.id;
                } else {
                    alert('Invalid admission record. Please refresh the page and try again.');
                    return;
                }
                
                // Store original form data for change tracking
                originalFormData = {};
                
                // Populate form fields for editing (excluding id, photo, documents, children)
                // Special handling for salary structure fields to ensure proper dropdown population
                const salaryFields = ['basicPay', 'payLevel', 'payCell'];
                const excludedFields = ['id', 'photo', 'documents', 'children', 'created_at', ...salaryFields];
                
                // Temporarily disable age recalculation during population
                window.isPopulatingEditForm = true;
                
                Object.keys(admission).forEach(key => {
                    if (!excludedFields.includes(key)) {
                        const element = document.getElementById(key);
                        if (element) {
                            // Set the value directly without any conversion
                            element.value = admission[key] || '';
                            // Store original value for change tracking
                            originalFormData[key] = admission[key] || '';
                            
                            // For date fields, store the original value in data attribute
                            if ((key === 'dateOfBirth' || key === 'dateOfAppointment' || key === 'dateOfNextIncrement' || key === 'retirementDate') && admission[key]) {
                                element.setAttribute('data-original-date', admission[key]);
                            }
                        }
                    }
                });
                
                // Validate mobile number field after population
                const mobileNumberElement = document.getElementById('mobileNumber');
                if (mobileNumberElement && mobileNumberElement.value) {
                    const mobileNumber = mobileNumberElement.value.replace(/\D/g, '');
                    if (mobileNumber.length !== 10) {
                        // Invalid mobile number, clean it and show warning
                        console.warn('Invalid mobile number found during edit:', mobileNumberElement.value, 'Length:', mobileNumber.length);
                        mobileNumberElement.value = mobileNumber.slice(0, 10); // Truncate to 10 digits
                        mobileNumberElement.style.borderColor = '#ffc107'; // Yellow warning
                        setTimeout(() => {
                            mobileNumberElement.style.borderColor = '';
                        }, 3000);
                    } else {
                        // Clean the mobile number to exactly 10 digits
                        mobileNumberElement.value = mobileNumber;
                        // Clear any error messages for valid mobile numbers
                        hideMobileNumberError();
                    }
                }
                
                // Re-enable age recalculation after population is complete
                setTimeout(() => {
                    window.isPopulatingEditForm = false;
                    
                    // Ensure age is calculated from the populated date of birth
                    const dobElement = document.getElementById('dateOfBirth');
                    const ageElement = document.getElementById('age');
                    if (dobElement && dobElement.value && ageElement) {
                        const dob = parseDDMMYYYY(dobElement.value);
                        if (dob) {
                            const today = new Date();
                            let age = today.getFullYear() - dob.getFullYear();
                            const monthDiff = today.getMonth() - dob.getMonth();
                            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                                age--;
                            }
                            ageElement.value = age >= 0 ? age : '';
                        }
                    }
                }, 200);
                
                // Handle salary structure fields separately to ensure proper order and dropdown population
                // Also populate simple salary fields if they exist (both Step 2 and Edit fields)
                if (admission.da) {
                    document.getElementById('da').value = admission.da;
                    document.getElementById('daEdit').value = admission.da;
                }
                if (admission.hra) {
                    document.getElementById('hra').value = admission.hra;
                    document.getElementById('hraEdit').value = admission.hra;
                }
                if (admission.specialPay) {
                    document.getElementById('specialPay').value = admission.specialPay;
                    document.getElementById('specialPayEdit').value = admission.specialPay;
                }
                if (admission.specialAllowance) {
                    document.getElementById('specialAllowance').value = admission.specialAllowance;
                    document.getElementById('specialAllowanceEdit').value = admission.specialAllowance;
                }
                if (admission.otherAllowance) {
                    document.getElementById('otherAllowance').value = admission.otherAllowance;
                    document.getElementById('otherAllowanceEdit').value = admission.otherAllowance;
                }
                
                // Hide salary section since we're using two-step process for editing
                document.getElementById('editSalarySection').style.display = 'none';
                
                console.log('=== ABOUT TO HANDLE SALARY FIELDS ===');
                // Handle salary structure fields properly
                // First set all the values before triggering any changes
                console.log('=== LOADING SALARY FIELDS FOR EDIT ===');
                console.log('Admission data salary fields:', {
                    payBand: admission.payBand,
                    basicPay: admission.basicPay,
                    gradePay: admission.gradePay,
                    payLevel: admission.payLevel,
                    payCell: admission.payCell
                });
                
                // Force set Pay Band (remove if condition for testing)
                const payBandValue = admission.payBand || admission.basicPay;
                const payBandElement = document.getElementById('basicPay');
                console.log('FORCE Setting Pay Band. Value from data:', payBandValue);
                console.log('Pay Band element found:', !!payBandElement);
                if (payBandElement) {
                    payBandElement.value = payBandValue;
                    originalFormData.basicPay = payBandValue;
                    console.log('Set Pay Band:', payBandValue, 'Current value:', payBandElement.value);
                }
                
                // Force set Grade Pay
                const gradePayElement = document.getElementById('gradePay');
                console.log('FORCE Setting Grade Pay. Value from data:', admission.gradePay);
                console.log('Grade Pay element found:', !!gradePayElement);
                if (gradePayElement) {
                    gradePayElement.value = admission.gradePay;
                    originalFormData.gradePay = admission.gradePay;
                    console.log('Set Grade Pay:', admission.gradePay, 'Current value:', gradePayElement.value);
                }
                
                // Force set Pay Level
                const payLevelElement = document.getElementById('payLevel');
                console.log('FORCE Setting Pay Level. Value from data:', admission.payLevel);
                console.log('Pay Level element found:', !!payLevelElement);
                if (payLevelElement) {
                    payLevelElement.value = admission.payLevel;
                    originalFormData.payLevel = admission.payLevel;
                    console.log('Set Pay Level:', admission.payLevel, 'Current value:', payLevelElement.value);
                }
                
                // Now trigger Pay Band change with preserve flag to enable dropdowns without clearing values
                console.log('=== TRIGGERING PAY BAND CHANGE ===');
                if (admission.payBand || admission.basicPay) {
                    handlePayBandChange(true); // true = preserve values
                    
                    // Check values after Pay Band change
                    setTimeout(() => {
                        console.log('Values AFTER Pay Band change:', {
                            payBand: document.getElementById('basicPay').value,
                            gradePay: document.getElementById('gradePay').value,
                            payLevel: document.getElementById('payLevel').value,
                            payCell: document.getElementById('payCell').value
                        });
                    }, 100);
                }
                
                // Set Pay Cell after Pay Band change has populated the options
                if (admission.payCell) {
                    // Small delay to ensure dropdown is populated
                    setTimeout(() => {
                        const payCellElement = document.getElementById('payCell');
                        payCellElement.value = admission.payCell;
                        originalFormData.payCell = admission.payCell;
                        console.log('Set Pay Cell:', admission.payCell, 'Current value:', payCellElement.value);
                        // Recalculate basic pay to show the calculated amount
                        calculateBasicPay();
                        
                        // After basic pay is calculated, recalculate DA and HRA
                        setTimeout(() => {
                            calculateSalaryComponent('da');
                            calculateSalaryComponent('hra');
                            calculateGrossSalary();
                        }, 50);
                    }, 100);
                } else {
                    // If no pay cell, ensure DA and HRA calculations are hidden
                    setTimeout(() => {
                        document.getElementById('daCalculatedValue').style.display = 'none';
                        document.getElementById('hraCalculatedValue').style.display = 'none';
                    }, 50);
                }
                
                // Set the calculated basic pay if available (fallback)
                if (admission.basicSalary) {
                    setTimeout(() => {
                        const basicPayCalculatedElement = document.getElementById('basicPayCalculated');
                        if (!basicPayCalculatedElement.value) {
                            basicPayCalculatedElement.value = admission.basicSalary;
                        }
                    }, 150);
                }

                // Load children data if available
                if (admission.children && Array.isArray(admission.children)) {
                    currentChildren = [...admission.children];
                    updateChildrenDisplay();
                    originalFormData.children = [...admission.children];
                } else {
                    currentChildren = [];
                    originalFormData.children = [];
                }
                
                // Load existing photo if available
                if (admission.photo) {
                    displayPhoto(admission.photo);
                    originalFormData.photo = admission.photo;
                } else {
                    removePhoto();
                    originalFormData.photo = '';
                }
                
                // Load existing documents if available
                if (admission.documents && admission.documents.length > 0) {
                    uploadedDocuments = [...admission.documents];
                    updateDocumentDisplay();
                    originalFormData.documents = [...admission.documents];
                } else {
                    clearAllDocuments();
                    originalFormData.documents = [];
                }
                
                // Set up real-time change tracking for edit mode
                setTimeout(setupRealTimeTracking, 100);
            } else {
                title.textContent = 'New Staff Details';
                professionalTitle.textContent = 'New Staff Details';
                
                // Hide salary section for new staff (they use the two-step process)
                document.getElementById('editSalarySection').style.display = 'none';
                professionalSubtitle.textContent = 'Enter the complete information for the new staff member';
                saveBtn.textContent = 'Save Admission';
                
                document.getElementById('admissionForm').reset();
                document.getElementById('admissionId').value = '';
                removePhoto(); // Reset photo section
                clearAllDocuments(); // Reset documents section
                
                // Clear children data
                currentChildren = [];
                updateChildrenDisplay();
                
                // Initialize salary structure for new staff
                initializeSalaryStructure();
                
                // Initialize two-step modal for new staff
                currentAdmissionStep = 1;
                initializeTwoStepModal();
            }
            
            // Initially disable Add Child button and Date of Appointment field
            setTimeout(() => {
                enableFieldsAfterDateOfBirth();
            }, 100);
            
            modal.style.display = 'block';
            
            // Reinitialize Pikaday calendars for modal date fields
            setTimeout(() => {
                console.log('Reinitializing Pikaday calendars for admission modal...');
                reinitializePikadayCalendars();
                
                // Setup parent date change listener for child validation
                setupParentDateChangeListener();
                
                // Ensure date fields are clickable
                const dateFields = ['dateOfBirth', 'dateOfAppointment', 'dateOfNextIncrement', 'retirementDate'];
                dateFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field && field._pikaday) {
                        console.log(`Date field ${fieldId} has Pikaday instance:`, !!field._pikaday, 'Value:', field.value);
                        // Ensure field is clickable
                        field.style.cursor = 'pointer';
                        field.title = 'Click to select date';
                    }
                });
                
                // Initialize Flatpickr for all date fields with Google Calendar style
                initializeDateOfBirthFlatpickr();
                initializeDateOfAppointmentFlatpickr();
                initializeDateOfNextIncrementFlatpickr();
            }, 500);
            
            // Scroll modal to top
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
            }, 100);
            
            setupFormValidation();
            
            // Initialize two-step functionality
            initializeTwoStepModal();
            
            // Set up error clearing for form fields
            setupValidationErrorClearing();
        }
        
        // Two-step modal functionality
        let currentAdmissionStep = 1;
        
        function initializeTwoStepModal() {
            // Show progress indicator only for new records
            const admissionId = document.getElementById('admissionId').value;
            const progressIndicator = document.getElementById('admissionProgressIndicator');
            
            if (!admissionId) {
                // New record - enable two-step
                progressIndicator.style.display = 'flex';
                currentAdmissionStep = 1;
                updateAdmissionStepState();
            } else {
                // Edit mode - use two-step process like new staff
                progressIndicator.style.display = 'flex';
                currentAdmissionStep = 1;
                updateAdmissionStepState();
                
                // Update buttons for edit mode two-step process
                document.getElementById('admissionNextBtn').style.display = 'inline-block';
                document.getElementById('admissionBackBtn').style.display = 'none';
                document.getElementById('admissionSaveBtn').style.display = 'none';
                document.getElementById('admissionFooterInfo').style.display = 'block';
                document.getElementById('admissionFooterInfo').textContent = 'Step 1 of 2';
                
                // Initialize salary structure state for edit mode
                // The calculated fields are now updated in the pay cell restoration logic above
            }
        }
        
        function admissionNextStep() {
            if (currentAdmissionStep === 1) {
                // Validate required fields in step 1
                const requiredFields = [
                    'staffId', 'designation', 'staffName', 'fatherName', 'motherName', 
                    'grandFatherName', 'maritalStatus', 'dateOfBirth', 'sex', 'nationality',
                    'dateOfAppointment', 'retirementDate', 'functionCode', 'objectCode',
                    'dateOfNextIncrement', 'pensionScheme', 'mobileNumber', 'permanentAddress', 
                    'communicationAddress'
                ];
                
                let isValid = true;
                let firstInvalidField = null;
                
                // First pass: clear all previous error styles
                for (const fieldId of requiredFields) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.style.borderColor = '#e0e0e0';
                        element.style.boxShadow = 'none';
                    }
                }
                
                // Second pass: find and highlight missing fields
                for (const fieldId of requiredFields) {
                    const element = document.getElementById(fieldId);
                    if (element && !element.value.trim()) {
                        // Highlight the field with red outline
                        element.style.borderColor = '#ef4444';
                        element.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                        
                        // Remember the first invalid field
                        if (!firstInvalidField) {
                            firstInvalidField = element;
                        }
                        
                        isValid = false;
                    }
                }
                
                if (!isValid && firstInvalidField) {
                    // Scroll to the first invalid field smoothly
                    firstInvalidField.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    // Focus on the field after a short delay to ensure scrolling completes
                    setTimeout(() => {
                        firstInvalidField.focus();
                    }, 500);
                    
                    return;
                }
                
                // Validate appointment age in step 1 - only check if DOB is filled
                const dobElement = document.getElementById('dateOfBirth');
                const appointmentElement = document.getElementById('dateOfAppointment');
                
                // Only validate age if BOTH date of birth AND appointment date are filled
                if (dobElement && appointmentElement && dobElement.value && appointmentElement.value) {
                    const birthDate = parseDDMMYYYY(dobElement.value);
                    const appointmentDate = parseDDMMYYYY(appointmentElement.value);
                    
                    if (birthDate && appointmentDate) {
                        const ageAtAppointment = (appointmentDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000);
                        
                        // Only show error if age is less than 18
                        if (ageAtAppointment < 18) {
                            // Highlight the date of birth field as it's the problematic one
                            dobElement.style.borderColor = '#ef4444';
                            dobElement.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                            
                            dobElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                            
                            setTimeout(() => {
                                dobElement.focus();
                                
                                // Show red error message
                                const errorElement = document.getElementById('dateOfAppointmentError');
                                if (errorElement) {
                                    errorElement.style.display = 'block';
                                    errorElement.textContent = 'Invalid date';
                                    
                                    setTimeout(function() {
                                        errorElement.style.display = 'none';
                                    }, 3000);
                                }
                            }, 500);
                            
                            return;
                        }
                    }
                }
                
                // Validate mobile number - must be exactly 10 digits
                const mobileElement = document.getElementById('mobileNumber');
                if (mobileElement && mobileElement.value.trim()) {
                    const mobileNumber = mobileElement.value.replace(/\D/g, ''); // Remove non-digits
                    if (mobileNumber.length !== 10) {
                        // Highlight the mobile number field
                        mobileElement.style.borderColor = '#ef4444';
                        mobileElement.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                        
                        mobileElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        
                        setTimeout(() => {
                            mobileElement.focus();
                            showMobileNumberError('Mobile number must be exactly 10 digits.');
                        }, 500);
                        
                        return;
                    }
                } else if (mobileElement) {
                    // Mobile number is required but empty
                    mobileElement.style.borderColor = '#ef4444';
                    mobileElement.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                    
                    mobileElement.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    setTimeout(() => {
                        mobileElement.focus();
                        showMobileNumberError('Mobile number is required.');
                    }, 500);
                    
                    return;
                }
                
                // Store current Grade Pay and Pay Cell values before moving to step 2
                const gradePayElement = document.getElementById('gradePay');
                const payCellElement = document.getElementById('payCell');
                if (!originalFormData) originalFormData = {};
                
                if (gradePayElement && gradePayElement.value) {
                    originalFormData.gradePay = gradePayElement.value;
                    console.log('Stored Grade Pay for step 2:', gradePayElement.value);
                }
                
                if (payCellElement && payCellElement.value) {
                    originalFormData.payCell = payCellElement.value;
                    console.log('Stored Pay Cell for step 2:', payCellElement.value);
                }
                
                currentAdmissionStep = 2;
                updateAdmissionStepState();
            } else if (currentAdmissionStep === 2) {
                // Validate salary structure fields before submission
                const salaryRequiredFields = ['basicPay', 'gradePay', 'payLevel', 'payCell'];
                let salaryIsValid = true;
                let firstInvalidSalaryField = null;
                
                // Clear previous error styles for salary fields
                for (const fieldId of salaryRequiredFields) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        element.style.borderColor = '#e0e0e0';
                        element.style.boxShadow = 'none';
                    }
                }
                
                // Validate salary fields
                for (const fieldId of salaryRequiredFields) {
                    const element = document.getElementById(fieldId);
                    if (element && !element.value.trim()) {
                        element.style.borderColor = '#ef4444';
                        element.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                        
                        if (!firstInvalidSalaryField) {
                            firstInvalidSalaryField = element;
                        }
                        
                        salaryIsValid = false;
                    }
                }
                
                // Also check if Basic Pay has been calculated
                const basicPayCalculatedElement = document.getElementById('basicPayCalculated');
                if (!basicPayCalculatedElement.value.trim()) {
                    // Basic Pay not calculated - this means Pay Band, Pay Level, or Pay Cell is missing/invalid
                    salaryIsValid = false;
                    if (!firstInvalidSalaryField) {
                        // Focus on the first incomplete salary field
                        const payBandElement = document.getElementById('basicPay');
                        if (!payBandElement.value.trim()) {
                            firstInvalidSalaryField = payBandElement;
                        } else {
                            const payLevelElement = document.getElementById('payLevel');
                            if (!payLevelElement.value.trim()) {
                                firstInvalidSalaryField = payLevelElement;
                            } else {
                                const payCellElement = document.getElementById('payCell');
                                firstInvalidSalaryField = payCellElement;
                            }
                        }
                    }
                }
                
                if (!salaryIsValid && firstInvalidSalaryField) {
                    firstInvalidSalaryField.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    setTimeout(() => {
                        firstInvalidSalaryField.focus();
                    }, 500);
                    
                    return;
                }
                
                // Submit the form programmatically to avoid double validation
                try {
                    const event = new Event('submit', { bubbles: true, cancelable: true });
                    event.bypassTwoStepValidation = true; // Flag to bypass age validation
                    
                    // Add success callback to handle modal closure
                    window.admissionSubmissionSuccess = () => {
                        // Close modal on successful submission
                        closeModal('admissionModal');
                        // Reset step state
                        currentAdmissionStep = 1;
                    };
                    
                    document.getElementById('admissionForm').dispatchEvent(event);
                } catch (error) {
                    console.error('Form submission error:', error);
                    alert('An error occurred while saving. Please try again.');
                }
            }
        }
        
        function admissionPreviousStep() {
            if (currentAdmissionStep === 2) {
                currentAdmissionStep = 1;
                updateAdmissionStepState();
            }
        }

        // Pay Matrix based on Schedule I - Government of India Pay Structure
        function getSalaryStructureData() {
            // Complete salary data extracted from Salary Structure.ods file with correct column mappings
            // Each Pay Band corresponds to a sheet with Pay Level (rows) and Pay Cell (columns)
            const salaryData = {
                '5200-20200': {
                    // Pay_Band-1: Pay Levels 1-40, Pay Cells 1-5
                    1: [null, 18000, 19900, 21700, 25500, 29200],
                    2: [null, 18500, 20500, 22400, 26300, 30100],
                    3: [null, 19100, 21100, 23100, 27100, 31000],
                    4: [null, 19700, 21700, 23800, 27900, 31900],
                    5: [null, 20300, 22400, 24500, 28700, 32900],
                    6: [null, 20900, 23100, 25200, 29600, 33900],
                    7: [null, 21500, 23800, 26000, 30500, 34900],
                    8: [null, 22100, 24500, 26800, 31400, 35900],
                    9: [null, 22800, 25200, 27600, 32300, 37000],
                    10: [null, 23500, 26000, 28400, 33300, 38100],
                    11: [null, 24200, 26800, 29300, 34300, 39200],
                    12: [null, 24900, 27600, 30200, 35300, 40400],
                    13: [null, 25600, 28400, 31100, 36400, 41600],
                    14: [null, 26400, 29300, 32000, 37500, 42800],
                    15: [null, 27200, 30200, 33000, 38600, 44100],
                    16: [null, 28000, 31100, 34000, 39800, 45400],
                    17: [null, 28800, 32000, 35000, 41000, 46800],
                    18: [null, 29700, 33000, 36100, 42200, 48200],
                    19: [null, 30600, 34000, 37200, 43500, 49600],
                    20: [null, 31500, 35000, 38300, 44800, 51100],
                    21: [null, 32400, 36100, 39400, 46100, 52600],
                    22: [null, 33400, 37200, 40600, 47500, 54200],
                    23: [null, 34400, 38300, 41800, 48900, 55800],
                    24: [null, 35400, 39400, 43100, 50400, 57500],
                    25: [null, 36500, 40600, 44400, 51900, 59200],
                    26: [null, 37600, 41800, 45700, 53500, 61000],
                    27: [null, 38700, 43100, 47100, 55100, 62800],
                    28: [null, 39900, 44400, 48500, 56800, 64700],
                    29: [null, 41100, 45700, 50000, 58500, 66600],
                    30: [null, 42300, 47100, 51500, 60300, 68600],
                    31: [null, 43600, 48500, 53000, 62100, 70700],
                    32: [null, 44900, 50000, 54600, 64000, 72800],
                    33: [null, 46200, 51500, 56200, 65900, 75000],
                    34: [null, 47600, 53000, 57900, 67900, 77300],
                    35: [null, 49000, 54600, 59600, 69900, 79600],
                    36: [null, 50500, 56200, 61400, 72000, 82000],
                    37: [null, 52000, 57900, 63200, 74200, 84500],
                    38: [null, 53600, 59600, 65100, 76400, 87000],
                    39: [null, 55200, 61400, 67100, 78700, 89600],
                    40: [null, 56900, 63200, 69100, 81100, 92300]
                },
                '9300-34800': {
                    // Pay_Band-2: Pay Levels 1-40, Pay Cells 6-9
                    1: [null, null, null, null, null, null, 35400, 44900, 47600, 53100],
                    2: [null, null, null, null, null, null, 36500, 46200, 49000, 54700],
                    3: [null, null, null, null, null, null, 37600, 47600, 50500, 56300],
                    4: [null, null, null, null, null, null, 38700, 49000, 52000, 58000],
                    5: [null, null, null, null, null, null, 39900, 50500, 53600, 59700],
                    6: [null, null, null, null, null, null, 41100, 52000, 55200, 61500],
                    7: [null, null, null, null, null, null, 42300, 53600, 56900, 63300],
                    8: [null, null, null, null, null, null, 43600, 55200, 58600, 65200],
                    9: [null, null, null, null, null, null, 44900, 56900, 60400, 67200],
                    10: [null, null, null, null, null, null, 46200, 58600, 62200, 69200],
                    11: [null, null, null, null, null, null, 47600, 60400, 64100, 71300],
                    12: [null, null, null, null, null, null, 49000, 62200, 66000, 73400],
                    13: [null, null, null, null, null, null, 50500, 64100, 68000, 75600],
                    14: [null, null, null, null, null, null, 52000, 66000, 70000, 77900],
                    15: [null, null, null, null, null, null, 53600, 68000, 72100, 80200],
                    16: [null, null, null, null, null, null, 55200, 70000, 74300, 82600],
                    17: [null, null, null, null, null, null, 56900, 72100, 76500, 85100],
                    18: [null, null, null, null, null, null, 58600, 74300, 78800, 87700],
                    19: [null, null, null, null, null, null, 60400, 76500, 81200, 90300],
                    20: [null, null, null, null, null, null, 62200, 78800, 83600, 93000],
                    21: [null, null, null, null, null, null, 64100, 81200, 86100, 95800],
                    22: [null, null, null, null, null, null, 66000, 83600, 88700, 98700],
                    23: [null, null, null, null, null, null, 68000, 86100, 91400, 101700],
                    24: [null, null, null, null, null, null, 70000, 88700, 94100, 104800],
                    25: [null, null, null, null, null, null, 72100, 91400, 96900, 107900],
                    26: [null, null, null, null, null, null, 74300, 94100, 99800, 111100],
                    27: [null, null, null, null, null, null, 76500, 96900, 102800, 114400],
                    28: [null, null, null, null, null, null, 78800, 99800, 105900, 117800],
                    29: [null, null, null, null, null, null, 81200, 102800, 109100, 121300],
                    30: [null, null, null, null, null, null, 83600, 105900, 112400, 124900],
                    31: [null, null, null, null, null, null, 86100, 109100, 115800, 128600],
                    32: [null, null, null, null, null, null, 88700, 112400, 119300, 132500],
                    33: [null, null, null, null, null, null, 91400, 115800, 122900, 136500],
                    34: [null, null, null, null, null, null, 94100, 119300, 126600, 140600],
                    35: [null, null, null, null, null, null, 96900, 122900, 130400, 144800],
                    36: [null, null, null, null, null, null, 99800, 126600, 134300, 149100],
                    37: [null, null, null, null, null, null, 102800, 130400, 138300, 153600],
                    38: [null, null, null, null, null, null, 105900, 134300, 142400, 158200],
                    39: [null, null, null, null, null, null, 109100, 138300, 146700, 162900],
                    40: [null, null, null, null, null, null, 112400, 142400, 151100, 167800]
                },
                '15600-39100': {
                    // Pay_Band-3: Pay Levels 1-40, Pay Cells 10-13
                    1: [null, null, null, null, null, null, null, null, null, null, 56100, 67700, 78800, 88400],
                    2: [null, null, null, null, null, null, null, null, null, null, 57800, 69700, 81200, 91100],
                    3: [null, null, null, null, null, null, null, null, null, null, 59500, 71800, 83600, 93800],
                    4: [null, null, null, null, null, null, null, null, null, null, 61300, 74000, 86100, 96600],
                    5: [null, null, null, null, null, null, null, null, null, null, 63100, 76200, 88700, 99500],
                    6: [null, null, null, null, null, null, null, null, null, null, 65000, 78500, 91400, 102500],
                    7: [null, null, null, null, null, null, null, null, null, null, 67000, 80900, 94100, 105600],
                    8: [null, null, null, null, null, null, null, null, null, null, 69000, 83300, 96900, 108800],
                    9: [null, null, null, null, null, null, null, null, null, null, 71100, 85800, 99800, 112100],
                    10: [null, null, null, null, null, null, null, null, null, null, 73200, 88400, 102800, 115500],
                    11: [null, null, null, null, null, null, null, null, null, null, 75400, 91100, 105900, 119000],
                    12: [null, null, null, null, null, null, null, null, null, null, 77700, 93800, 109100, 122600],
                    13: [null, null, null, null, null, null, null, null, null, null, 80000, 96600, 112400, 126300],
                    14: [null, null, null, null, null, null, null, null, null, null, 82400, 99500, 115800, 130100],
                    15: [null, null, null, null, null, null, null, null, null, null, 84900, 102500, 119300, 134000],
                    16: [null, null, null, null, null, null, null, null, null, null, 87400, 105600, 122900, 138000],
                    17: [null, null, null, null, null, null, null, null, null, null, 90000, 108800, 126600, 142100],
                    18: [null, null, null, null, null, null, null, null, null, null, 92700, 112100, 130400, 146400],
                    19: [null, null, null, null, null, null, null, null, null, null, 95500, 115500, 134300, 150800],
                    20: [null, null, null, null, null, null, null, null, null, null, 98400, 119000, 138300, 155300],
                    21: [null, null, null, null, null, null, null, null, null, null, 101400, 122600, 142400, 160000],
                    22: [null, null, null, null, null, null, null, null, null, null, 104400, 126300, 146700, 164800],
                    23: [null, null, null, null, null, null, null, null, null, null, 107500, 130100, 151100, 169700],
                    24: [null, null, null, null, null, null, null, null, null, null, 110700, 134000, 155600, 174800],
                    25: [null, null, null, null, null, null, null, null, null, null, 114000, 138000, 160300, 180000],
                    26: [null, null, null, null, null, null, null, null, null, null, 117400, 142100, 165100, 185400],
                    27: [null, null, null, null, null, null, null, null, null, null, 120900, 146400, 170100, 191000],
                    28: [null, null, null, null, null, null, null, null, null, null, 124500, 150800, 175200, 196700],
                    29: [null, null, null, null, null, null, null, null, null, null, 128200, 155300, 180500, 202600],
                    30: [null, null, null, null, null, null, null, null, null, null, 132000, 160000, 185900, null],
                    31: [null, null, null, null, null, null, null, null, null, null, 136000, 164800, 191500, null],
                    32: [null, null, null, null, null, null, null, null, null, null, 140100, 169700, 197200, null],
                    33: [null, null, null, null, null, null, null, null, null, null, 144300, 174800, null, null],
                    34: [null, null, null, null, null, null, null, null, null, null, 148600, 180000, null, null],
                    35: [null, null, null, null, null, null, null, null, null, null, 153100, 185400, null, null],
                    36: [null, null, null, null, null, null, null, null, null, null, 157700, 191000, null, null],
                    37: [null, null, null, null, null, null, null, null, null, null, 162400, null, null, null],
                    38: [null, null, null, null, null, null, null, null, null, null, 167300, null, null, null],
                    39: [null, null, null, null, null, null, null, null, null, null, 172300, null, null, null],
                    40: [null, null, null, null, null, null, null, null, null, null, 177500, null, null, null]
                },
                '37400-67000': {
                    // Pay_Band-4: Pay Levels 1-40, Pay Cells 14-19
                    1: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 118500, 118700, 123600, 125200, 126000, 128900],
                    2: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 122100, 122300, 127300, 129000, 129800, 132800],
                    3: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 125800, 126000, 131100, 132900, 133700, 136800],
                    4: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 129600, 129800, 135000, 136900, 137700, 140900],
                    5: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 133500, 133700, 139100, 141000, 141800, 145100],
                    6: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 137500, 137700, 143300, 145200, 146100, 149500],
                    7: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 141600, 141800, 147600, 149600, 150500, 154000],
                    8: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 145800, 146100, 152000, 154100, 155000, 158600],
                    9: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 150200, 150500, 156600, 158700, 159700, 163400],
                    10: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 154700, 155000, 161300, 163500, 164500, 168300],
                    11: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 159300, 159700, 166100, 168400, 169400, 173300],
                    12: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 164100, 164500, 171100, 173500, 174500, 178500],
                    13: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 169000, 169400, 176200, 178700, 179700, 183900],
                    14: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 174100, 174500, 181500, 184100, 185100, 189400],
                    15: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 179300, 179700, 186900, 189600, 190700, 195100],
                    16: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 184700, 185100, 192500, 195300, 196400, 201000],
                    17: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 190200, 190700, 198300, 201200, 202300, 207000],
                    18: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 195900, 196400, 204200, 207200, 208400, 213200],
                    19: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 201800, 202300, 210300, 213400, 214700, 219600],
                    20: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, 207900, 208400, null, null, null, null],
                    21: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    22: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    23: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    24: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    25: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    26: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    27: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    28: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    29: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    30: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    31: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    32: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    33: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    34: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    35: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    36: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    37: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    38: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    39: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null],
                    40: [null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null]
                }
            };
            return salaryData;
        }

        function calculateBasicPay() {
            const payBandElement = document.getElementById('basicPay');
            const payLevelElement = document.getElementById('payLevel');
            const payCellElement = document.getElementById('payCell');
            const basicPayElement = document.getElementById('basicPayCalculated');

            const payBand = payBandElement.value;
            const payLevelValue = payLevelElement.value;
            const payCellValue = payCellElement.value;
            
            // Clear basic pay first
            basicPayElement.value = '';

            if (!payBand) {
                basicPayElement.placeholder = 'Select Pay Band first';
                return;
            }
            
            if (!payLevelValue || payLevelValue === '') {
                basicPayElement.placeholder = 'Select Pay Level';
                return;
            }
            
            if (!payCellValue || payCellValue === '') {
                basicPayElement.placeholder = 'Select Pay Cell';
                return;
            }
            
            // Parse values only after validation
            const payLevel = parseInt(payLevelValue);
            const payCell = parseInt(payCellValue);
            
            if (isNaN(payLevel) || isNaN(payCell)) {
                basicPayElement.placeholder = 'Invalid Pay Level or Pay Cell';
                return;
            }

            const salaryData = getSalaryStructureData();
            
            // Get the pay band data
            const payBandData = salaryData[payBand];
            
            if (payBandData && payBandData[payLevel] && payBandData[payLevel][payCell] !== null && payBandData[payLevel][payCell] !== undefined) {
                const basicPay = payBandData[payLevel][payCell];
                basicPayElement.value = basicPay;
                basicPayElement.placeholder = '';
                
                // Add visual feedback
                basicPayElement.style.background = '#e8f5e8';
                basicPayElement.style.borderColor = '#28a745';
                
                // Reset style after 2 seconds
                setTimeout(() => {
                    basicPayElement.style.background = '#f8f9fa';
                    basicPayElement.style.borderColor = '';
                }, 2000);
                
                // Recalculate DA and HRA when Basic Pay changes
                calculateSalaryComponent('da');
                calculateSalaryComponent('hra');
                
                // Recalculate gross salary after basic pay changes
                calculateGrossSalary();
            } else {
                basicPayElement.value = '';
                basicPayElement.placeholder = 'Data not available for this combination';
                basicPayElement.style.background = '#ffe6e6';
                basicPayElement.style.borderColor = '#dc3545';
                
                setTimeout(() => {
                    basicPayElement.style.background = '#f8f9fa';
                    basicPayElement.style.borderColor = '';
                }, 2000);
                
                // Clear DA and HRA calculations when Basic Pay is not available
                document.getElementById('daCalculatedValue').style.display = 'none';
                document.getElementById('hraCalculatedValue').style.display = 'none';
                
                // Clear gross salary when basic pay is not available
                calculateGrossSalary();
            }
        }

        function handlePayLevelChange() {
            // Only clear Pay Cell and Basic Pay when Pay Level changes if not during edit form population
            if (window.isPopulatingEditForm) {
                return; // Don't clear values during edit form population
            }
            
            const payCellElement = document.getElementById('payCell');
            const basicPayElement = document.getElementById('basicPayCalculated');
            
            payCellElement.value = '';
            basicPayElement.value = '';
            basicPayElement.placeholder = 'Select Pay Cell';
            
            // Clear DA and HRA calculations
            document.getElementById('daCalculatedValue').style.display = 'none';
            document.getElementById('hraCalculatedValue').style.display = 'none';
        }

        function calculateSalaryComponent(component) {
            const basicPayElement = document.getElementById('basicPayCalculated');
            const basicPay = parseFloat(basicPayElement.value) || 0;
            
            if (basicPay <= 0) {
                // Hide calculation display if no basic pay
                document.getElementById(component + 'CalculatedValue').style.display = 'none';
                return;
            }
            
            const percentageElement = document.getElementById(component);
            const percentage = parseFloat(percentageElement.value) || 0;
            
            if (percentage > 0) {
                const calculatedAmount = (basicPay * percentage / 100).toFixed(2);
                const displayElement = document.getElementById(component + 'CalculatedValue');
                displayElement.innerHTML = `${percentage}% of Basic Pay is <strong>‚Çπ${calculatedAmount}</strong>`;
                displayElement.style.display = 'block';
            } else {
                document.getElementById(component + 'CalculatedValue').style.display = 'none';
            }
            
            // Recalculate gross salary whenever any component changes
            calculateGrossSalary();
        }

        function calculateGrossSalary() {
            try {
                // Get all salary component values
                const basicPay = parseFloat(document.getElementById('basicPayCalculated').value) || 0;
                
                // Calculate DA amount (DA is a percentage of basic pay)
                const daPercentage = parseFloat(document.getElementById('da').value) || 0;
                const daAmount = (basicPay * daPercentage / 100);
                
                // Calculate HRA amount (HRA is a percentage of basic pay)
                const hraPercentage = parseFloat(document.getElementById('hra').value) || 0;
                const hraAmount = (basicPay * hraPercentage / 100);
                
                // Get fixed amounts
                const specialPay = parseFloat(document.getElementById('specialPay').value) || 0;
                const specialAllowance = parseFloat(document.getElementById('specialAllowance').value) || 0;
                const otherAllowance = parseFloat(document.getElementById('otherAllowance').value) || 0;
                
                // Calculate gross salary
                const grossSalary = basicPay + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
                
                // Update the gross salary field
                const grossSalaryField = document.getElementById('grossSalary');
                if (grossSalaryField) {
                    grossSalaryField.value = grossSalary.toFixed(2);
                    
                    // Add visual feedback when gross salary updates
                    if (grossSalary > 0) {
                        grossSalaryField.style.background = '#e8f5e8';
                        grossSalaryField.style.borderColor = '#28a745';
                        grossSalaryField.style.color = '#28a745';
                        grossSalaryField.style.fontWeight = '600';
                        
                        // Reset style after 1 second
                        setTimeout(() => {
                            grossSalaryField.style.background = '#f8f9fa';
                            grossSalaryField.style.borderColor = '';
                            grossSalaryField.style.color = '#6c757d';
                            grossSalaryField.style.fontWeight = '';
                        }, 1000);
                    }
                }
                
                console.log('Gross Salary Calculated:', {
                    basicPay,
                    daAmount: daAmount.toFixed(2),
                    hraAmount: hraAmount.toFixed(2),
                    specialPay,
                    specialAllowance,
                    otherAllowance,
                    grossSalary: grossSalary.toFixed(2)
                });
                
            } catch (error) {
                console.error('Error calculating gross salary:', error);
            }
        }

        function initializeSalaryStructure(isEditMode = false) {
            // Initialize salary structure fields to proper state
            const payBandElement = document.getElementById('basicPay');
            const payLevelElement = document.getElementById('payLevel');
            const payCellElement = document.getElementById('payCell');
            const basicPayElement = document.getElementById('basicPayCalculated');
            
            if (!isEditMode) {
                // Reset all fields to initial state for new records
                payBandElement.value = '';
                payLevelElement.value = '';
                payLevelElement.disabled = true;
                payCellElement.value = '';
                payCellElement.disabled = true;
                payCellElement.innerHTML = '<option value="">Select Pay Cell</option>';
                basicPayElement.value = '';
                basicPayElement.placeholder = 'Select Pay Band first';
            } else {
                // For edit mode, just ensure proper dropdown states based on current selections
                const currentPayBand = payBandElement.value;
                if (currentPayBand) {
                    // Enable dependent fields and populate Pay Cell options
                    payLevelElement.disabled = false;
                    payCellElement.disabled = false;
                    
                    // Manually populate Pay Cell options (avoid recursion)
                    let cellOptions = '<option value="">Select Pay Cell</option>';
                    if (currentPayBand === '5200-20200') {
                        for (let i = 1; i <= 5; i++) {
                            cellOptions += `<option value="${i}">Cell ${i}</option>`;
                        }
                    } else if (currentPayBand === '9300-34800') {
                        for (let i = 6; i <= 9; i++) {
                            cellOptions += `<option value="${i}">Cell ${i}</option>`;
                        }
                    } else if (currentPayBand === '15600-39100') {
                        for (let i = 10; i <= 13; i++) {
                            cellOptions += `<option value="${i}">Cell ${i}</option>`;
                        }
                    } else if (currentPayBand === '37400-67000') {
                        for (let i = 14; i <= 19; i++) {
                            cellOptions += `<option value="${i}">Cell ${i}</option>`;
                        }
                    }
                    payCellElement.innerHTML = cellOptions;
                } else {
                    // No Pay Band selected, keep fields disabled
                    payLevelElement.disabled = true;
                    payCellElement.disabled = true;
                    payCellElement.innerHTML = '<option value="">Select Pay Cell</option>';
                    basicPayElement.placeholder = 'Select Pay Band first';
                }
            }
        }

        function handlePayBandChange(preserveValues = false) {
            const payBandElement = document.getElementById('basicPay');
            const payLevelElement = document.getElementById('payLevel');
            const payCellElement = document.getElementById('payCell');
            const basicPayElement = document.getElementById('basicPayCalculated');
            
            const selectedPayBand = payBandElement.value;
            
            // Store current values if we need to preserve them
            const currentPayLevel = payLevelElement.value;
            const currentPayCell = payCellElement.value;
            
            // Only clear selections if not preserving values
            if (!preserveValues) {
                payLevelElement.value = '';
                payCellElement.value = '';
                basicPayElement.value = '';
            }
            
            basicPayElement.placeholder = 'Select Pay Band, Pay Level and Pay Cell first';
            
            if (!selectedPayBand) {
                // Disable Pay Level and Pay Cell if no Pay Band selected
                payLevelElement.disabled = true;
                payCellElement.disabled = true;
                payCellElement.innerHTML = '<option value="">Select Pay Cell</option>';
                basicPayElement.placeholder = 'Select Pay Band first';
                return;
            }
            
            // Enable Pay Level
            payLevelElement.disabled = false;
            
            // Enable Pay Cell and populate options based on Pay Band
            payCellElement.disabled = false;
            
            // Restore values if preserving
            if (preserveValues) {
                if (currentPayLevel) payLevelElement.value = currentPayLevel;
                if (currentPayCell) {
                    // Will be restored after Pay Cell options are populated
                    setTimeout(() => {
                        payCellElement.value = currentPayCell;
                    }, 50);
                }
            }
            
            // Update placeholder to reflect enabled state
            basicPayElement.placeholder = 'Select Pay Level and Pay Cell';
            
            let cellOptions = '<option value="">Select Pay Cell</option>';
            
            // Determine Pay Cell options based on Pay Band selection
            if (selectedPayBand === '5200-20200') {
                // Pay Band-1: Cell 1-5
                for (let i = 1; i <= 5; i++) {
                    cellOptions += `<option value="${i}">Cell ${i}</option>`;
                }
            } else if (selectedPayBand === '9300-34800') {
                // Pay Band-2: Cell 6-9
                for (let i = 6; i <= 9; i++) {
                    cellOptions += `<option value="${i}">Cell ${i}</option>`;
                }
            } else if (selectedPayBand === '15600-39100') {
                // Pay Band-3: Cell 10-13
                for (let i = 10; i <= 13; i++) {
                    cellOptions += `<option value="${i}">Cell ${i}</option>`;
                }
            } else if (selectedPayBand === '37400-67000') {
                // Pay Band-4: Cell 14-19
                for (let i = 14; i <= 19; i++) {
                    cellOptions += `<option value="${i}">Cell ${i}</option>`;
                }
            }
            
            payCellElement.innerHTML = cellOptions;
        }
        
        function updateAdmissionStepState() {
            // Update step content visibility
            document.getElementById('admissionStepContent1').classList.toggle('active', currentAdmissionStep === 1);
            document.getElementById('admissionStepContent2').classList.toggle('active', currentAdmissionStep === 2);
            
            // Initialize salary structure when step 2 is shown
            if (currentAdmissionStep === 2) {
                // Check if we're in edit mode (has admission ID)
                const isEditMode = !!document.getElementById('admissionId').value;
                initializeSalaryStructure(isEditMode);
                
                // If in edit mode, ensure the saved values are properly restored and dropdowns are enabled
                if (isEditMode) {
                    // Small delay to ensure DOM is ready
                    setTimeout(() => {
                        // Restore Grade Pay value first
                        const gradePayElement = document.getElementById('gradePay');
                        if (gradePayElement && originalFormData.gradePay) {
                            gradePayElement.value = originalFormData.gradePay;
                            console.log('Restored Grade Pay:', originalFormData.gradePay);
                        }
                        
                        const payBandElement = document.getElementById('basicPay');
                        if (payBandElement && payBandElement.value) {
                            // Trigger Pay Band change with preserve flag to enable dropdowns and restore Pay Cell options
                            handlePayBandChange(true);
                            
                            // Ensure Pay Cell value is restored after dropdown is populated
                            setTimeout(() => {
                                const payCellElement = document.getElementById('payCell');
                                if (payCellElement && originalFormData.payCell) {
                                    payCellElement.value = originalFormData.payCell;
                                    console.log('Restored Pay Cell:', originalFormData.payCell);
                                    // Recalculate basic pay
                                    calculateBasicPay();
                                }
                            }, 50);
                        }
                    }, 100);
                }
            }
            
            // Update progress indicator
            document.getElementById('admissionStep1').classList.toggle('completed', currentAdmissionStep > 1);
            document.getElementById('admissionStep1').classList.toggle('active', currentAdmissionStep === 1);
            document.getElementById('admissionStep2').classList.toggle('active', currentAdmissionStep === 2);
            document.getElementById('admissionConnector1').classList.toggle('active', currentAdmissionStep > 1);
            
            // Update modal title based on step
            const modalTitle = document.getElementById('admissionModalTitle');
            const professionalTitle = document.getElementById('admissionProfessionalTitle');
            const professionalSubtitle = document.getElementById('admissionProfessionalSubtitle');
            
            if (currentAdmissionStep === 1) {
                modalTitle.textContent = 'New Staff Details';
                professionalTitle.textContent = 'New Staff Details';
                professionalSubtitle.textContent = 'Enter the complete information for the new staff member';
            } else {
                modalTitle.textContent = 'Salary Configuration';
                professionalTitle.textContent = 'Salary Configuration';
                professionalSubtitle.textContent = 'Set up the salary structure for this employee';
            }
            
            // Update footer
            document.getElementById('admissionFooterInfo').textContent = `Step ${currentAdmissionStep} of 2`;
            document.getElementById('admissionBackBtn').style.display = currentAdmissionStep === 2 ? 'inline-block' : 'none';
            const isEditingMode = document.getElementById('admissionId').value;
            const finalStepText = isEditingMode ? 'Save Changes' : 'Save Staff';
            document.getElementById('admissionNextBtn').textContent = currentAdmissionStep === 1 ? 'Next' : finalStepText;
            document.getElementById('admissionSaveBtn').style.display = 'none'; // Always hidden in two-step mode
        }
        
        function setupValidationErrorClearing() {
            // Get all form inputs, selects, and textareas in the modal
            const formFields = document.querySelectorAll('#admissionModal input, #admissionModal select, #admissionModal textarea');
            
            formFields.forEach(field => {
                // Clear error styling when user starts typing/selecting
                field.addEventListener('input', function() {
                    if (this.style.borderColor === 'rgb(239, 68, 68)' || this.style.borderColor === '#ef4444') {
                        this.style.borderColor = '#e0e0e0';
                        this.style.boxShadow = 'none';
                    }
                });
                
                // Also clear on change for select elements
                field.addEventListener('change', function() {
                    if (this.style.borderColor === 'rgb(239, 68, 68)' || this.style.borderColor === '#ef4444') {
                        this.style.borderColor = '#e0e0e0';
                        this.style.boxShadow = 'none';
                    }
                });
            });
        }

        function openDesignationModal(designation = null) {
            // Check permissions
            if (!designation && !canWriteSection('designations')) {
                alert("You don't have permission to add new designations.");
                return;
            }
            if (designation && !canEditSection('designations')) {
                alert("You don't have permission to edit designations.");
                return;
            }
            const title = document.getElementById('designationModalTitle');
            const nameInput = document.getElementById('designationNameInput');
            
            if (designation) {
                title.textContent = 'Edit Designation';
                document.getElementById('designationId').value = designation.id;
                nameInput.value = designation.name || '';
            } else {
                title.textContent = 'Add New Designation';
                document.getElementById('designationForm').reset();
                document.getElementById('designationId').value = '';
            }
            
            // Clear validation states
            nameInput.classList.remove('invalid', 'valid');
            
            openProfessionalModal('designationModal');
            
            // Add text-only validation to the input
            nameInput.addEventListener('input', function() {
                // Allow only letters, spaces, apostrophes, dots, and hyphens
                this.value = this.value.replace(/[^a-zA-Z\s.'-]/g, '');
                // Update validation state
                if (this.value.trim()) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            setTimeout(() => {
                nameInput.focus();
                if (designation) {
                    nameInput.select(); // Select all text for easy editing
                }
            }, 400);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Permissions dropdown functions
        let permissionsDropdownInitialized = false;
        
        function initializePermissionsDropdown() {
            console.log('Initializing permissions dropdown');
            
            // Get all tab headers
            const headers = document.querySelectorAll('.tab-header');
            if (headers.length === 0) {
                console.log('No tab headers found');
                return;
            }
            
            // Remove any existing click handlers by using a named function
            if (!permissionsDropdownInitialized) {
                headers.forEach(header => {
                    header.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('Dropdown header clicked');
                        const parentItem = this.closest('.tab-permission-item');
                        if (!parentItem) {
                            console.error('Parent item not found');
                            return;
                        }
                        
                        const isActive = parentItem.classList.contains('active');
                        
                        // Close all other dropdowns
                        document.querySelectorAll('.tab-permission-item').forEach(item => {
                            if (item !== parentItem) {
                                item.classList.remove('active');
                            }
                        });
                        
                        // Toggle current dropdown
                        if (!isActive) {
                            parentItem.classList.add('active');
                            console.log('Dropdown opened for', parentItem.dataset.tab);
                        } else {
                            parentItem.classList.remove('active');
                            console.log('Dropdown closed for', parentItem.dataset.tab);
                        }
                    };
                });
                
                permissionsDropdownInitialized = true;
            }

            // Initialize permission counts
            document.querySelectorAll('.tab-permission-item').forEach(item => {
                updatePermissionCount(item.dataset.tab);
            });
        }

        // Toggle permission functionality
        function togglePermission(permissionOption, event) {
            // Prevent double-toggle when clicking directly on checkbox
            if (event && event.target.type === 'checkbox') {
                return;
            }
            
            const checkbox = permissionOption.querySelector('.permission-checkbox');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                permissionOption.classList.add('selected');
            } else {
                permissionOption.classList.remove('selected');
            }
            
            updatePermissionCount(checkbox.dataset.tab);
        }

        // Select all permissions for a tab
        function selectAllPermissions(tabId) {
            const tabItem = document.querySelector(`[data-tab="${tabId}"]`);
            const checkboxes = tabItem.querySelectorAll('.permission-checkbox');
            const options = tabItem.querySelectorAll('.permission-option');
            
            checkboxes.forEach(checkbox => checkbox.checked = true);
            options.forEach(option => option.classList.add('selected'));
            
            updatePermissionCount(tabId);
        }

        // Clear all permissions for a tab
        function clearAllPermissions(tabId) {
            const tabItem = document.querySelector(`[data-tab="${tabId}"]`);
            const checkboxes = tabItem.querySelectorAll('.permission-checkbox');
            const options = tabItem.querySelectorAll('.permission-option');
            
            checkboxes.forEach(checkbox => checkbox.checked = false);
            options.forEach(option => option.classList.remove('selected'));
            
            updatePermissionCount(tabId);
        }

        // Update permission count badge
        function updatePermissionCount(tabId) {
            const tabItem = document.querySelector(`[data-tab="${tabId}"]`);
            if (!tabItem) return;
            
            const checkedCount = tabItem.querySelectorAll('.permission-checkbox:checked').length;
            const countBadge = tabItem.querySelector('.permissions-count');
            
            countBadge.textContent = checkedCount;
            if (checkedCount > 0) {
                countBadge.classList.remove('empty');
            } else {
                countBadge.classList.add('empty');
            }
        }

        // Load user permissions into dropdown
        function loadUserPermissions(user) {
            // Clear all permissions first
            document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.closest('.permission-option').classList.remove('selected');
            });

            // Handle new permissions format
            if (user.permissions && typeof user.permissions === 'object') {
                Object.keys(user.permissions).forEach(tabId => {
                    const permissions = user.permissions[tabId];
                    if (Array.isArray(permissions)) {
                        permissions.forEach(permission => {
                            const checkbox = document.querySelector(`[data-tab="${tabId}"][data-permission="${permission}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                                checkbox.closest('.permission-option').classList.add('selected');
                            }
                        });
                    }
                });
            }
            // Handle backward compatibility with old rights format
            else if (user.rights && Array.isArray(user.rights)) {
                // For old format, apply rights to dashboard by default
                user.rights.forEach(right => {
                    const checkbox = document.querySelector(`[data-tab="dashboard"][data-permission="${right}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                        checkbox.closest('.permission-option').classList.add('selected');
                    }
                });
            }

            // Update all counts
            document.querySelectorAll('.tab-permission-item').forEach(item => {
                updatePermissionCount(item.dataset.tab);
            });
        }

        // Get user permissions from dropdown
        function getUserPermissions() {
            const permissions = {};
            document.querySelectorAll('.tab-permission-item').forEach(item => {
                const tabId = item.dataset.tab;
                const checkedPermissions = item.querySelectorAll('.permission-checkbox:checked');
                if (checkedPermissions.length > 0) {
                    permissions[tabId] = Array.from(checkedPermissions).map(cb => cb.dataset.permission);
                }
            });
            return permissions;
        }

        // Code management functions
        function openCodeModal(code = null) {
            // Check permissions
            if (!code && !canWriteSection('codes')) {
                alert("You don't have permission to add new codes.");
                return;
            }
            if (code && !canEditSection('codes')) {
                alert("You don't have permission to edit codes.");
                return;
            }
            
            const title = document.getElementById('codeModalTitle');
            const codeInput = document.getElementById('codeInput');
            const typeInput = document.getElementById('codeTypeInput');
            const descriptionInput = document.getElementById('codeDescriptionInput');
            
            if (code) {
                title.textContent = 'Edit Code';
                document.getElementById('codeId').value = code.id;
                codeInput.value = code.code || '';
                typeInput.value = code.type || '';
                descriptionInput.value = code.description || '';
            } else {
                title.textContent = 'Create New Code';
                document.getElementById('codeForm').reset();
                document.getElementById('codeId').value = '';
            }
            
            // Clear validation states
            [codeInput, typeInput, descriptionInput].forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
            
            openProfessionalModal('codeModal');
            
            // Add number-only validation to code input
            codeInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^0-9]/g, '');
                // Update validation state
                if (this.value.trim()) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            // Add validation to type input
            typeInput.addEventListener('change', function() {
                if (this.value) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            // Add validation to description input (text and numbers, no special characters)
            descriptionInput.addEventListener('input', function() {
                this.value = this.value.replace(/[^a-zA-Z0-9\s]/g, '');
                // Update validation state
                if (this.value.trim()) {
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            setTimeout(() => {
                codeInput.focus();
                if (code) {
                    codeInput.select();
                }
            }, 400);
        }

        function saveCode(event) {
            event.preventDefault();
            
            // Validate form before proceeding
            if (!validateProfessionalForm('codeForm')) {
                return false;
            }
            
            const id = document.getElementById('codeId').value;
            const code = document.getElementById('codeInput').value.trim();
            const type = document.getElementById('codeTypeInput').value;
            const description = document.getElementById('codeDescriptionInput').value.trim();
            
            // Validate inputs
            if (!code) {
                alert('Please enter a code.');
                return;
            }
            
            if (!type) {
                alert('Please select a code type.');
                return;
            }
            
            if (!description) {
                alert('Please enter a description.');
                return;
            }
            
            // Check if code already exists with the same type (excluding current record for edit)
            const existingCode = codes.find(c => 
                c.code === code && c.type === type && c.id !== parseInt(id)
            );
            
            if (existingCode) {
                alert(`A ${type.toLowerCase()} with code "${code}" already exists. Please choose a different code or select a different type.`);
                return;
            }
            
            if (id) {
                // Update existing
                const index = codes.findIndex(c => c.id === parseInt(id));
                if (index !== -1) {
                    const oldCode = codes[index].code;
                    codes[index].code = code;
                    codes[index].type = type;
                    codes[index].description = description;
                    
                    // Update codes in admission records
                    admissions.forEach(admission => {
                        if (admission.functionCode === oldCode || admission.objectCode === oldCode) {
                            if (type === 'Function code' && admission.functionCode === oldCode) {
                                admission.functionCode = code;
                            }
                            if (type === 'Object code' && admission.objectCode === oldCode) {
                                admission.objectCode = code;
                            }
                        }
                    });
                    
                    saveAdmissionsToStorage();
                    saveCodesToStorage();
                }
            } else {
                // Add new
                const newCode = {
                    id: codes.length > 0 ? Math.max(...codes.map(c => c.id)) + 1 : 1,
                    code: code,
                    type: type,
                    description: description
                };
                codes.push(newCode);
                saveCodesToStorage();
            }
            
            // Update dropdowns in admission form
            updateCodeDropdowns();
            
            // Close modal first
            closeProfessionalModal('codeModal');
            
            // Call callback if exists (for staff form integration)
            // Use setTimeout to ensure DOM is updated after modal closes
            if (window.codeModalCallback) {
                const savedCode = id ? codes.find(c => c.id === parseInt(id)) : codes[codes.length - 1];
                setTimeout(() => {
                    window.codeModalCallback(savedCode);
                    window.codeModalCallback = null; // Clear callback
                }, 100);
            } else {
                // Only refresh the codes list if we're currently on the codes tab
                // (i.e., no callback means we opened the modal from the codes tab directly)
                showCodes(); // Refresh the codes list
            }
        }

        function editCode(id) {
            const code = codes.find(c => c.id === id);
            if (code) {
                openCodeModal(code);
            }
        }

        function deleteCode(id) {
            // Check permissions first
            if (!canEditSection('codes')) {
                alert('You do not have permission to delete codes. Edit permission is required.');
                return;
            }
            
            const code = codes.find(c => c.id === id);
            if (!code) return;
            
            // Check if code is being used in any admissions and collect details
            const usedInAdmissions = admissions.filter(admission => 
                admission.functionCode === code.code || admission.objectCode === code.code
            );
            
            if (usedInAdmissions.length > 0) {
                // Create usage list for the professional modal
                const usageList = usedInAdmissions.map(admission => ({
                    name: admission.staffName,
                    id: admission.staffId,
                    type: admission.functionCode === code.code ? 'Function Code' : 'Object Code'
                }));
                
                showCannotDeleteModal('Code', code.code, usageList, true);
                return;
            }
            
            showDeleteModal('Code', code.code, id, async function(codeId) {
                try {
                    // Make API call to delete from backend database
                    const response = await fetch(`/api/codes/${codeId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Only update frontend after successful backend deletion
                        codes = codes.filter(c => c.id !== codeId);
                        localStorage.setItem('cantonment_codes', JSON.stringify(codes));
                        showCodes(); // Refresh the codes list
                        updateCodeDropdowns(); // Update dropdowns in admission form
                        alert('Code deleted successfully from database!');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to delete code');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete code: ' + error.message);
                }
            });
        }

        function updateCodeDropdowns() {
            const functionCodeSelect = document.getElementById('functionCode');
            const objectCodeSelect = document.getElementById('objectCode');
            
            if (functionCodeSelect) {
                const functionCodes = codes.filter(c => c.type === 'Function code');
                functionCodeSelect.innerHTML = '<option value="">Select Function Code</option>' +
                    functionCodes.map(code => `<option value="${code.code}">${code.code} - ${code.description}</option>`).join('');
            }
            
            if (objectCodeSelect) {
                const objectCodes = codes.filter(c => c.type === 'Object code');
                objectCodeSelect.innerHTML = '<option value="">Select Object Code</option>' +
                    objectCodes.map(code => `<option value="${code.code}">${code.code} - ${code.description}</option>`).join('');
            }
        }

        // Attendance Management Functions
        let defaultLeaveTypes = [
            { id: 1, name: 'Casual Leave', type: 'casual', color: '#f59e0b', description: 'Service-based: 0-10yrs=10 days, 10-20yrs=20 days, >20yrs=20 days' },
            { id: 2, name: 'Earned Leave', type: 'earned', color: '#10b981', description: 'Bi-annual: 15 days Jan 1st, 15 days July 1st, year-end carryover, max 300 days' },
            { id: 3, name: 'Half Pay Leave', type: 'halfpay', color: '#3b82f6', description: '6-month cycles: 10 days Jan-Jun, 10 days Jul-Dec (no carryover)' }
        ];

        let leaveTypes = JSON.parse(localStorage.getItem('leaveTypes')) || defaultLeaveTypes;
        let leaveApplications = JSON.parse(localStorage.getItem('leaveApplications')) || [];
        
        // Fake time system for testing
        let fakeCurrentDate = new Date(); // Can be modified for testing
        let fakeSystemTime = {
            currentDate: fakeCurrentDate,
            currentYear: fakeCurrentDate.getFullYear(),
            isFirstHalf: fakeCurrentDate.getMonth() < 6 // January to June = first half
        };
        
        // Initialize leave types in localStorage if not present
        if (!localStorage.getItem('leaveTypes')) {
            localStorage.setItem('leaveTypes', JSON.stringify(defaultLeaveTypes));
        }
        
        // Ensure leaveTypes variable is properly set
        if (!leaveTypes || leaveTypes.length === 0) {
            leaveTypes = [...defaultLeaveTypes];
            localStorage.setItem('leaveTypes', JSON.stringify(defaultLeaveTypes));
            console.log('Initialized leave types:', leaveTypes);
        }

        // Initialize sample data with joining dates for testing
        function initializeSampleData() {
            // Disabled - no fake data initialization
        }

        // Initialize sample data only when needed (not on page load)
        // initializeSampleData(); // Moved to be called only when user portal loads

        function showLeaveManagement() {
            // Ensure data is loaded
            if (!admissions) {
                admissions = JSON.parse(localStorage.getItem('admissions')) || [];
            }
            if (!leaveTypes) {
                leaveTypes = JSON.parse(localStorage.getItem('leaveTypes')) || defaultLeaveTypes;
            }
            if (!leaveApplications) {
                leaveApplications = JSON.parse(localStorage.getItem('leaveApplications')) || [];
            }
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="section-header">
                    <div class="section-header-left">
                        <h3>Staff Attendance</h3>
                    </div>
                    <div class="section-header-right">
                        <div class="attendance-quick-stats">
                            ${renderAttendanceQuickStats()}
                        </div>
                    </div>
                </div>
                
                <!-- Fake Time System for Testing -->
                <div class="fake-time-controls">
                    <h4>üß™ Testing Controls</h4>
                    
                    <!-- Current Date Display -->
                    <div class="current-date-display">
                        <strong>Current System Date: </strong>
                        <span id="currentDateDisplay">${formatDateToDDMMYYYY(fakeSystemTime.currentDate)}</span>
                    </div>
                    
                    <!-- Date Selection Controls -->
                    <div class="date-selection-controls">
                        <h5>Set Date for Testing:</h5>
                        <div class="date-selectors">
                            <div class="form-group">
                                <label for="testDay">Day:</label>
                                <select id="testDay" class="form-control">
                                    ${Array.from({length: 31}, (_, i) => {
                                        const day = i + 1;
                                        const currentDay = fakeSystemTime.currentDate.getDate();
                                        return `<option value="${day}" ${day === currentDay ? 'selected' : ''}>${day}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="testMonth">Month:</label>
                                <select id="testMonth" class="form-control">
                                    <option value="0" ${fakeSystemTime.currentDate.getMonth() === 0 ? 'selected' : ''}>January</option>
                                    <option value="1" ${fakeSystemTime.currentDate.getMonth() === 1 ? 'selected' : ''}>February</option>
                                    <option value="2" ${fakeSystemTime.currentDate.getMonth() === 2 ? 'selected' : ''}>March</option>
                                    <option value="3" ${fakeSystemTime.currentDate.getMonth() === 3 ? 'selected' : ''}>April</option>
                                    <option value="4" ${fakeSystemTime.currentDate.getMonth() === 4 ? 'selected' : ''}>May</option>
                                    <option value="5" ${fakeSystemTime.currentDate.getMonth() === 5 ? 'selected' : ''}>June</option>
                                    <option value="6" ${fakeSystemTime.currentDate.getMonth() === 6 ? 'selected' : ''}>July</option>
                                    <option value="7" ${fakeSystemTime.currentDate.getMonth() === 7 ? 'selected' : ''}>August</option>
                                    <option value="8" ${fakeSystemTime.currentDate.getMonth() === 8 ? 'selected' : ''}>September</option>
                                    <option value="9" ${fakeSystemTime.currentDate.getMonth() === 9 ? 'selected' : ''}>October</option>
                                    <option value="10" ${fakeSystemTime.currentDate.getMonth() === 10 ? 'selected' : ''}>November</option>
                                    <option value="11" ${fakeSystemTime.currentDate.getMonth() === 11 ? 'selected' : ''}>December</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="testYear">Year:</label>
                                <select id="testYear" class="form-control">
                                    ${Array.from({length: 20}, (_, i) => {
                                        const year = 2020 + i;
                                        const currentYear = fakeSystemTime.currentDate.getFullYear();
                                        return `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="applyTestDate()">Apply Date</button>
                                <button type="button" class="btn btn-secondary" onclick="resetToTodayDate()">Reset to Today</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Info -->
                    <div class="system-info">
                        <span>Current Year: ${fakeSystemTime.currentYear}</span>
                        <span>Period: ${fakeSystemTime.isFirstHalf ? 'First Half (Jan-Jun)' : 'Second Half (Jul-Dec)'}</span>
                    </div>
                        <div class="reset-controls">
                            <button class="btn btn-warning" onclick="resetAllTestingData()">üîÑ Reset All Data</button>
                            <span class="reset-info">Clears all leave applications, carryover data, and resets to fresh state</span>
                        </div>
                    </div>
                </div>
                
                <div class="attendance-overview">
                    <div class="attendance-tabs">
                        <div class="attendance-tabs-left">
                            <button class="attendance-tab active" onclick="showAttendanceTab('overview')">Overview</button>
                            <button class="attendance-tab" onclick="showAttendanceTab('applications')">Leave Applications</button>
                            <button class="attendance-tab" onclick="showAttendanceTab('calendar')">Calendar View</button>
                            <button class="attendance-tab disabled" onclick="event.preventDefault(); showAlert('Coming Soon', 'The Reports section is currently under development and will be available soon.');" style="opacity: 0.5; cursor: not-allowed;">Reports</button>
                        </div>
                        <div class="attendance-tabs-right">
                            ${canWriteSection('leave') ? '<button class="btn btn-primary btn-small" onclick="openLeaveApplicationModal()">Apply for Leave</button>' : ''}
                            <button class="btn btn-secondary btn-small" onclick="openLeaveTypesModal()">Configure Leave Types</button>
                        </div>
                    </div>
                    
                    <div id="attendanceContent" class="attendance-content">
                        ${renderAttendanceOverview()}
                    </div>
                </div>
            `;
            
            // Initialize the fake date picker after DOM is updated
            setTimeout(() => {
                initializeFakeDatePicker();
                // Initialize the attendance view with current month
                updateAttendanceView();
            }, 100);
        }

        function showAttendanceTab(tab) {
            // Update attendance tab buttons
            document.querySelectorAll('.attendance-tab').forEach(t => t.classList.remove('active'));
            if (event && event.target && event.target.classList.contains('attendance-tab')) {
                event.target.classList.add('active');
            } else {
                // If called programmatically, find the correct tab button
                const tabButtons = document.querySelectorAll('.attendance-tab');
                tabButtons.forEach(button => {
                    if ((tab === 'applications' && button.textContent.includes('Leave Applications')) ||
                        (tab === 'calendar' && button.textContent.includes('Calendar')) ||
                        (tab === 'overview' && button.textContent.includes('Overview')) ||
                        (tab === 'reports' && button.textContent.includes('Reports'))) {
                        button.classList.add('active');
                    }
                });
            }
            
            // Update view toggle buttons if they exist
            const viewToggleButtons = document.querySelectorAll('.view-toggle-btn');
            viewToggleButtons.forEach(btn => btn.classList.remove('active'));
            if (tab === 'applications') {
                const listViewBtn = document.querySelector('.view-toggle-btn[onclick*="applications"]');
                if (listViewBtn) listViewBtn.classList.add('active');
            } else if (tab === 'calendar') {
                const calendarViewBtn = document.querySelector('.view-toggle-btn[onclick*="calendar"]');
                if (calendarViewBtn) calendarViewBtn.classList.add('active');
            }
            
            const content = document.getElementById('attendanceContent');
            switch(tab) {
                case 'overview':
                    content.innerHTML = renderAttendanceOverview();
                    // Initialize the view with current month
                    setTimeout(() => {
                        updateAttendanceView();
                    }, 100);
                    break;
                case 'applications':
                    content.innerHTML = renderLeaveApplications();
                    break;
                case 'calendar':
                    content.innerHTML = renderAttendanceCalendar();
                    break;
                case 'reports':
                    // Reports section is disabled for now
                    showAlert('Coming Soon', 'The Reports section is currently under development and will be available soon.');
                    return;
                    break;
            }
        }

        // Function to render quick attendance stats for the header
        function renderAttendanceQuickStats() {
            // Ensure admissions array exists
            if (!admissions || admissions.length === 0) {
                return `
                    <div class="quick-stat-item">
                        <div class="quick-stat-value">0</div>
                        <div class="quick-stat-label">Present Today</div>
                    </div>
                    <div class="quick-stat-item">
                        <div class="quick-stat-value">0</div>
                        <div class="quick-stat-label">On Leave</div>
                    </div>
                    <div class="quick-stat-item">
                        <div class="quick-stat-value">0</div>
                        <div class="quick-stat-label">Total Staff</div>
                    </div>
                `;
            }

            // Calculate attendance statistics
            const presentCount = admissions.filter(staff => {
                try {
                    // Check if staff has any approved leave for today
                    const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                    const hasLeaveToday = leaveApplications && leaveApplications.some(app => 
                        app.staffId === staff.id && 
                        app.status === 'approved' &&
                        isDateInRange(today, app.startDate, app.endDate)
                    );
                    return !hasLeaveToday;
                } catch (e) {
                    console.log('Error checking leave status for staff:', staff.id, e);
                    return true; // Default to present if error
                }
            }).length;
            
            const onLeaveCount = admissions.length - presentCount;
            const totalStaff = admissions.length;

            return `
                <div class="quick-stat-item">
                    <div class="quick-stat-value">${presentCount}</div>
                    <div class="quick-stat-label">Present Today</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-value">${onLeaveCount}</div>
                    <div class="quick-stat-label">On Leave</div>
                </div>
                <div class="quick-stat-item">
                    <div class="quick-stat-value">${totalStaff}</div>
                    <div class="quick-stat-label">Total Staff</div>
                </div>
            `;
        }

        // Helper function to generate month options
        function generateMonthOptions(selectedMonth) {
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            let options = '';
            for (let i = 1; i <= 12; i++) {
                options += `<option value="${i}" ${i === selectedMonth ? 'selected' : ''}>${monthNames[i]}</option>`;
            }
            return options;
        }

        // Helper function to generate year options
        function generateYearOptions(selectedYear) {
            const currentYear = new Date().getFullYear();
            let options = '';
            // Show last 5 years plus current year
            for (let year = currentYear - 5; year <= currentYear; year++) {
                options += `<option value="${year}" ${year === selectedYear ? 'selected' : ''}>${year}</option>`;
            }
            return options;
        }

        // Function to update attendance view based on selected month/year
        function updateAttendanceView() {
            const selectedMonth = parseInt(document.getElementById('attendanceViewMonth').value);
            const selectedYear = parseInt(document.getElementById('attendanceViewYear').value);
            
            // Update the staff tiles to show attendance for selected month
            updateStaffTilesForMonth(selectedMonth, selectedYear);
        }

        // Function to reset to current month
        function viewCurrentMonth() {
            const currentDate = fakeSystemTime.currentDate;
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            document.getElementById('attendanceViewMonth').value = currentMonth;
            document.getElementById('attendanceViewYear').value = currentYear;
            
            updateAttendanceView();
        }

        // Function to update staff tiles based on selected month/year
        function updateStaffTilesForMonth(month, year) {
            const staffTilesGrid = document.getElementById('staffTilesGrid');
            if (!staffTilesGrid) return;

            // Get saved attendance records for the selected month/year
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            
            // Initialize counters for summary
            let fullAttendanceCount = 0;
            let partialAttendanceCount = 0;
            let noAttendanceCount = 0;
            let noDataCount = 0;
            
            // Check if we're viewing historical data
            const currentDate = fakeSystemTime.currentDate;
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            const isCurrentMonth = (month === currentMonth && year === currentYear);
            
            admissions.forEach(staff => {
                const tile = staffTilesGrid.querySelector(`[data-staff-id="${staff.id}"]`);
                if (!tile) return;

                if (isCurrentMonth) {
                    // For current month, show today's status
                    const today = formatDateToDDMMYYYY(currentDate);
                    const hasLeaveToday = leaveApplications.some(app => 
                        app.staffId === staff.id && 
                        app.status === 'approved' &&
                        isDateInRange(today, app.startDate, app.endDate)
                    );
                    
                    const statusElement = tile.querySelector('.staff-tile-status');
                    statusElement.className = `staff-tile-status ${hasLeaveToday ? 'status-leave' : 'status-present'}`;
                    statusElement.innerHTML = `<span class="status-dot"></span>${hasLeaveToday ? 'On Leave' : 'Present Today'}`;
                    tile.setAttribute('data-status', hasLeaveToday ? 'leave' : 'present');
                    
                    if (hasLeaveToday) {
                        noAttendanceCount++;
                    } else {
                        fullAttendanceCount++;
                    }
                } else {
                    // For historical months, show saved attendance data
                    const attendanceRecord = savedRecords.find(record => 
                        record.staffId === staff.staffId && 
                        parseInt(record.month) === month && 
                        parseInt(record.year) === year
                    );

                    if (attendanceRecord) {
                        // Update tile with historical attendance data
                        const statusElement = tile.querySelector('.staff-tile-status');
                        const daysPresent = attendanceRecord.daysPresent || 0;
                        const totalDays = getDaysInMonth(month, year);
                        
                        // Update status based on attendance
                        if (daysPresent === 0) {
                            statusElement.className = 'staff-tile-status status-leave';
                            statusElement.innerHTML = '<span class="status-dot"></span>Absent (0 days)';
                            tile.setAttribute('data-status', 'leave');
                            noAttendanceCount++;
                        } else if (daysPresent < totalDays) {
                            statusElement.className = 'staff-tile-status status-partial';
                            statusElement.innerHTML = `<span class="status-dot"></span>Present ${daysPresent}/${totalDays} days`;
                            tile.setAttribute('data-status', 'partial');
                            partialAttendanceCount++;
                        } else {
                            statusElement.className = 'staff-tile-status status-present';
                            statusElement.innerHTML = `<span class="status-dot"></span>Full Attendance (${daysPresent} days)`;
                            tile.setAttribute('data-status', 'present');
                            fullAttendanceCount++;
                        }
                    } else {
                        // No record found for this month/year
                        const statusElement = tile.querySelector('.staff-tile-status');
                        statusElement.className = 'staff-tile-status';
                        statusElement.innerHTML = '<span class="status-dot"></span>No data available';
                        tile.setAttribute('data-status', 'no-data');
                        noDataCount++;
                    }
                }
            });
            
            // Update summary display
            const summaryDiv = document.getElementById('monthlyAttendanceSummary');
            if (summaryDiv) {
                if (isCurrentMonth) {
                    // Hide summary for current month
                    summaryDiv.style.display = 'none';
                } else {
                    // Show summary for historical months
                    summaryDiv.style.display = 'block';
                    document.getElementById('summaryFullAttendance').textContent = fullAttendanceCount;
                    document.getElementById('summaryPartialAttendance').textContent = partialAttendanceCount;
                    document.getElementById('summaryNoAttendance').textContent = noAttendanceCount;
                    document.getElementById('summaryNoData').textContent = noDataCount;
                }
            }
        }

        function renderAttendanceOverview() {
            // Ensure admissions array exists
            if (!admissions || admissions.length === 0) {
                return `
                    <!-- Search and Filter Controls -->
                    <div class="attendance-controls">
                        <div class="search-box">
                            <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="attendanceSearchInput" placeholder="Search by name or designation..." 
                                   onkeypress="return /[a-zA-Z0-9\s]/.test(event.key)"
                                   oninput="handleSearchInput(this)"
                                   onkeyup="searchAttendanceStaff()">
                        </div>
                        <select class="filter-dropdown" id="attendanceFilterDropdown" onchange="filterAttendanceStaff()">
                            <option value="all">All Staff</option>
                            <option value="present">Present Only</option>
                            <option value="leave">On Leave</option>
                        </select>
                    </div>
                    <div class="staff-tiles-grid">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <p>No staff records found. Please add staff members first.</p>
                        </div>
                    </div>
                `;
            }

            // Get current month and year for default selection
            const currentDate = fakeSystemTime.currentDate;
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();

            return `
                <!-- Month/Year Selection Controls -->
                <div class="attendance-period-selector" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
                    <label style="font-weight: 600; color: #333;">View Attendance For:</label>
                    <select id="attendanceViewMonth" class="filter-dropdown" style="min-width: 150px;" onchange="updateAttendanceView()">
                        ${generateMonthOptions(currentMonth)}
                    </select>
                    <select id="attendanceViewYear" class="filter-dropdown" style="min-width: 100px;" onchange="updateAttendanceView()">
                        ${generateYearOptions(currentYear)}
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="viewCurrentMonth()" style="margin-left: auto;">Current Month</button>
                </div>

                <!-- Monthly Attendance Summary -->
                <div id="monthlyAttendanceSummary" style="background: #fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; display: none;">
                    <h4 style="margin: 0 0 10px 0; color: #374151;">Attendance Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div style="text-align: center;">
                            <div id="summaryFullAttendance" style="font-size: 24px; font-weight: bold; color: #10b981;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Full Attendance</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="summaryPartialAttendance" style="font-size: 24px; font-weight: bold; color: #f59e0b;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">Partial Attendance</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="summaryNoAttendance" style="font-size: 24px; font-weight: bold; color: #ef4444;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">No Attendance</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="summaryNoData" style="font-size: 24px; font-weight: bold; color: #9ca3af;">0</div>
                            <div style="font-size: 14px; color: #6b7280;">No Data</div>
                        </div>
                    </div>
                </div>

                <!-- Search and Filter Controls -->
                <div class="attendance-controls">
                    <div class="search-box">
                        <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" id="attendanceSearchInput" placeholder="Search by name or designation..." 
                               onkeypress="return /[a-zA-Z0-9\s]/.test(event.key)"
                               oninput="handleSearchInput(this)"
                               onkeyup="searchAttendanceStaff()">
                    </div>
                    <select class="filter-dropdown" id="attendanceFilterDropdown" onchange="filterAttendanceStaff()">
                        <option value="all">All Staff</option>
                        <option value="present">Present Only</option>
                        <option value="leave">On Leave</option>
                    </select>
                </div>

                <!-- Staff Tiles Grid -->
                <div class="staff-tiles-grid" id="staffTilesGrid">
                    ${admissions.map(staff => {
                        try {
                            const staffLeaves = getStaffLeaveBalance ? getStaffLeaveBalance(staff.id) : {};
                            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
                        
                        // Check if staff is on leave today
                        const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                        const hasLeaveToday = leaveApplications.some(app => 
                            app.staffId === staff.id && 
                            app.status === 'approved' &&
                            isDateInRange(today, app.startDate, app.endDate)
                        );
                        
                        // Calculate total leaves remaining
                        let totalLeavesRemaining = 0;
                        let totalLeavesAllowed = 0;
                        
                        if (isMale && leaveTypes && leaveTypes.length > 0) {
                            leaveTypes.forEach(type => {
                                const leaveData = staffLeaves[type.id] || {};
                                if (type.id === 1) { // Casual Leave
                                    totalLeavesRemaining += Math.max(0, (leaveData.available || 0) - (leaveData.used || 0));
                                    totalLeavesAllowed += (leaveData.available || 0);
                                } else if (type.id === 2) { // Earned Leave
                                    totalLeavesRemaining += Math.max(0, (leaveData.available || 0) - (leaveData.used || 0));
                                    totalLeavesAllowed += (leaveData.available || 0);
                                } else if (type.id === 3) { // Half Pay Leave
                                    totalLeavesRemaining += Math.max(0, (leaveData.available || 0) - (leaveData.used || 0));
                                    totalLeavesAllowed += (leaveData.available || 0);
                                } else if (type.customType) {
                                    totalLeavesRemaining += Math.max(0, type.entitlement - (leaveData.used || 0));
                                    totalLeavesAllowed += type.entitlement;
                                }
                            });
                        }
                        
                        // Generate avatar with random colors if no photo
                        const avatarColors = [
                            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                            'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #fecfef 0%, #fecfef 100%)',
                            'linear-gradient(135deg, #f6d365 0%, #fda085 100%)',
                            'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
                            'linear-gradient(135deg, #fdcbf1 0%, #fdcbf1 1%, #e6dee9 100%)'
                        ];
                        const avatarColor = avatarColors[staff.id % avatarColors.length];
                        const initials = staff.staffName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                        
                        return `
                            <div class="staff-tile" onclick="toggleStaffTile(this)" data-staff-id="${staff.id}" data-status="${hasLeaveToday ? 'leave' : 'present'}">
                                <div class="expand-arrow">
                                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                                <div class="staff-tile-info">
                                    ${staff.photo ? 
                                        `<div class="staff-avatar"><img src="${staff.photo}" alt="${staff.staffName}"></div>` :
                                        `<div class="staff-avatar" style="background: ${avatarColor};">${initials}</div>`
                                    }
                                    <div class="staff-tile-details">
                                        <div class="staff-tile-name">${staff.staffName}</div>
                                        <div class="staff-tile-designation">${staff.designation || 'N/A'}</div>
                                        <div class="staff-tile-status ${hasLeaveToday ? 'status-leave' : 'status-present'}">
                                            <span class="status-dot"></span>
                                            ${hasLeaveToday ? 'On Leave' : 'Present Today'}
                                        </div>
                                    </div>
                                </div>
                                <div class="staff-total-leaves">
                                    <span class="leaves-label">Total Leaves Remaining</span>
                                    <div>
                                        ${isMale ? 
                                            `<span class="leaves-count">${totalLeavesRemaining}</span>
                                             <span class="leaves-total"> / ${totalLeavesAllowed}</span>` :
                                            `<span style="color: #9ca3af; font-size: 14px;">N/A (Female)</span>`
                                        }
                                    </div>
                                </div>
                                <div class="leave-details-dropdown">
                                    ${!isMale ? 
                                        '<div class="female-restriction">Female staff leave rules not implemented yet</div>' :
                                        (leaveTypes && leaveTypes.length > 0 ? leaveTypes.map(type => {
                                            const leaveData = staffLeaves[type.id] || {};
                                            let displayInfo = '';
                                            
                                            if (type.id === 1) { // Casual Leave
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const remaining = available - used;
                                                const percentage = available > 0 ? (used / available) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-category-item">
                                                        <span class="category-name">${type.name} (CL)</span>
                                                        <div class="category-count">
                                                            <span class="count-used">${remaining}</span>
                                                            <span class="count-separator">/</span>
                                                            <span class="count-total">${available}</span>
                                                        </div>
                                                    </div>
                                                    <div class="leave-progress">
                                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                                    </div>
                                                `;
                                            } else if (type.id === 2) { // Earned Leave  
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const remaining = available - used;
                                                const percentage = available > 0 ? (used / available) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-category-item" style="margin-top: 12px;">
                                                        <span class="category-name">${type.name} (EL)</span>
                                                        <div class="category-count">
                                                            <span class="count-used">${remaining}</span>
                                                            <span class="count-separator">/</span>
                                                            <span class="count-total">${available}</span>
                                                        </div>
                                                    </div>
                                                    <div class="leave-progress">
                                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                                    </div>
                                                `;
                                            } else if (type.id === 3) { // Half Pay Leave
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const remaining = available - used;
                                                const percentage = available > 0 ? (used / available) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-category-item" style="margin-top: 12px;">
                                                        <span class="category-name">${type.name} (HPL)</span>
                                                        <div class="category-count">
                                                            <span class="count-used">${remaining}</span>
                                                            <span class="count-separator">/</span>
                                                            <span class="count-total">${available}</span>
                                                        </div>
                                                    </div>
                                                    <div class="leave-progress">
                                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                                    </div>
                                                `;
                                            } else if (type.customType) {
                                                const used = leaveData.used || 0;
                                                const remaining = type.entitlement - used;
                                                const percentage = type.entitlement > 0 ? (used / type.entitlement) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-category-item" style="margin-top: 12px;">
                                                        <span class="category-name">${type.name}</span>
                                                        <div class="category-count">
                                                            <span class="count-used">${remaining}</span>
                                                            <span class="count-separator">/</span>
                                                            <span class="count-total">${type.entitlement}</span>
                                                        </div>
                                                    </div>
                                                    <div class="leave-progress">
                                                        <div class="progress-fill" style="width: ${percentage}%"></div>
                                                    </div>
                                                `;
                                            }
                                            
                                            return displayInfo;
                                        }).join('') : '<div style="padding: 10px; color: #666;">No leave types configured</div>')
                                    }
                                </div>
                            </div>
                        `;
                        } catch (e) {
                            console.log('Error rendering staff tile for:', staff.staffName, e);
                            return `
                                <div class="staff-tile">
                                    <div class="staff-tile-info">
                                        <div class="staff-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">?</div>
                                        <div class="staff-tile-details">
                                            <div class="staff-tile-name">${staff.staffName || 'Unknown'}</div>
                                            <div class="staff-tile-designation">${staff.designation || 'N/A'}</div>
                                            <div class="staff-tile-status status-present">
                                                <span class="status-dot"></span>
                                                Present Today
                                            </div>
                                        </div>
                                    </div>
                                    <div class="staff-total-leaves">
                                        <span class="leaves-label">Total Leaves Remaining</span>
                                        <div>
                                            <span class="leaves-count">0</span>
                                            <span class="leaves-total"> / 0</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }).join('')}
                </div>
            `;
        }

        // Helper function to parse date from DD/MM/YYYY format
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            // DD/MM/YYYY format: parts[0] = day, parts[1] = month, parts[2] = year
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }

        // Helper function to check if a date is in range
        function isDateInRange(date, startDate, endDate) {
            const checkDate = parseDate(date);
            const start = parseDate(startDate);
            const end = parseDate(endDate);
            
            if (!checkDate || !start || !end) return false;
            return checkDate >= start && checkDate <= end;
        }

        // Toggle staff tile expansion
        function toggleStaffTile(tile) {
            // Close other expanded tiles
            const allTiles = document.querySelectorAll('.staff-tile');
            allTiles.forEach(t => {
                if (t !== tile && t.classList.contains('expanded')) {
                    t.classList.remove('expanded');
                }
            });
            
            // Toggle current tile
            tile.classList.toggle('expanded');
        }

        // Search functionality
        function searchAttendanceStaff() {
            const searchTerm = document.getElementById('attendanceSearchInput').value.toLowerCase();
            const tiles = document.querySelectorAll('.staff-tile');
            
            tiles.forEach(tile => {
                const name = tile.querySelector('.staff-tile-name').textContent.toLowerCase();
                const designation = tile.querySelector('.staff-tile-designation').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || designation.includes(searchTerm)) {
                    tile.style.display = 'block';
                } else {
                    tile.style.display = 'none';
                }
            });
        }

        // Filter functionality
        function filterAttendanceStaff() {
            const filter = document.getElementById('attendanceFilterDropdown').value;
            const tiles = document.querySelectorAll('.staff-tile');
            
            tiles.forEach(tile => {
                const status = tile.getAttribute('data-status');
                
                if (filter === 'all') {
                    tile.style.display = 'block';
                } else if (filter === 'present' && (status === 'present' || status === 'partial')) {
                    tile.style.display = 'block';
                } else if (filter === 'leave' && (status === 'leave' || status === 'no-data')) {
                    tile.style.display = 'block';
                } else {
                    tile.style.display = 'none';
                }
            });
        }

        // Keep the old function signature for backward compatibility
        function renderAttendanceOverviewOld() {
            return `
                <div class="attendance-stats">
                    ${admissions.map(staff => {
                        const staffLeaves = getStaffLeaveBalance(staff.id);
                        const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
                        
                        return `
                            <div class="staff-attendance-card">
                                <div class="staff-info">
                                    <h4>${staff.staffName} ${!isMale ? '(‚ôÄ)' : '(‚ôÇ)'}</h4>
                                    <p>${staff.designation || 'N/A'}</p>
                                    <p><small>Joined: ${staff.dateOfJoining || 'N/A'}</small></p>
                                </div>
                                <div class="leave-balance">
                                    ${!isMale ? 
                                        '<div class="female-restriction">Female staff leave rules not implemented yet</div>' :
                                        leaveTypes.map(type => {
                                            const leaveData = staffLeaves[type.id] || {};
                                            let displayInfo = '';
                                            
                                            if (type.id === 1) { // Casual Leave
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const remaining = available - used;
                                                const servicePeriod = leaveData.servicePeriod || 0;
                                                const percentage = available > 0 ? (used / available) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-type-balance">
                                                        <div class="leave-type-header">
                                                            <span>${type.name}</span>
                                                            <span>${Math.max(0, remaining)}/${available} days</span>
                                                        </div>
                                                        <div class="leave-progress-bar">
                                                            <div class="leave-progress-fill" style="width: ${percentage}%; background-color: ${type.color};"></div>
                                                        </div>
                                                        <div class="leave-details">
                                                            <small>Service: ${servicePeriod} years</small>
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (type.id === 2) { // Earned Leave
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const carryover = leaveData.carryover || 0;
                                                const total = leaveData.total || 0;
                                                const percentage = total > 0 ? (used / total) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-type-balance">
                                                        <div class="leave-type-header">
                                                            <span>${type.name}</span>
                                                            <span>${available}/${total} days</span>
                                                        </div>
                                                        <div class="leave-progress-bar">
                                                            <div class="leave-progress-fill" style="width: ${percentage}%; background-color: ${type.color};"></div>
                                                        </div>
                                                        <div class="leave-details">
                                                            <small>Carryover: ${carryover} days</small>
                                                        </div>
                                                    </div>
                                                `;
                                            } else if (type.id === 3) { // Half Pay Leave
                                                const available = leaveData.available || 0;
                                                const used = leaveData.used || 0;
                                                const firstHalfUsed = leaveData.firstHalfUsed || 0;
                                                const yearlyEntitlement = leaveData.yearlyEntitlement || 0;
                                                const percentage = yearlyEntitlement > 0 ? (used / yearlyEntitlement) * 100 : 0;
                                                
                                                displayInfo = `
                                                    <div class="leave-type-balance">
                                                        <div class="leave-type-header">
                                                            <span>${type.name}</span>
                                                            <span>${available}/${yearlyEntitlement} days</span>
                                                        </div>
                                                        <div class="leave-progress-bar">
                                                            <div class="leave-progress-fill" style="width: ${percentage}%; background-color: ${type.color};"></div>
                                                        </div>
                                                        <div class="leave-details">
                                                            <small>First Half Used: ${firstHalfUsed} days</small>
                                                        </div>
                                                    </div>
                                                `;
                                            }
                                            
                                            return displayInfo;
                                        }).join('')
                                    }
                                </div>
                                <button class="btn btn-small btn-primary" onclick="viewStaffAttendance(${staff.id})">View Details</button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderLeaveApplications() {
            // Get all leave applications
            const allApplications = leaveApplications || [];
            
            return `
                <div class="list-view-container">
                    <!-- List View Header -->
                    <div class="list-view-header">
                        <h3 class="list-view-title">üìã Leave Applications List</h3>
                        <div class="list-view-filters">
                            <select class="filter-dropdown" onchange="filterLeaveApplications('status', this.value)">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <select class="filter-dropdown" onchange="filterLeaveApplications('type', this.value)">
                                <option value="all">All Types</option>
                                <option value="casual">Casual Leave</option>
                                <option value="earned">Earned Leave</option>
                                <option value="halfpay">Half Pay Leave</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Leave Applications Table -->
                    <table class="leave-table">
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Leave Type</th>
                                <th>Date Range</th>
                                <th>Duration</th>
                                <th>Status</th>
                                <th>Applied Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leaveApplicationsTableBody">
                            ${allApplications.length === 0 ? 
                                '<tr><td colspan="7" style="text-align: center; color: #666; padding: 40px;">No leave applications found</td></tr>' :
                                allApplications.map(app => renderLeaveApplicationRow(app)).join('')
                            }
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <div class="pagination">
                        <div class="pagination-info">
                            Showing ${allApplications.length} applications
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn">‚Äπ Previous</button>
                            <button class="pagination-btn active">1</button>
                            <button class="pagination-btn">Next ‚Ä∫</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLeaveApplicationRow(application) {
            const staff = admissions.find(s => s.id === application.staffId);
            const leaveType = leaveTypes.find(t => t.id === application.leaveTypeId);
            
            // Generate staff initials and avatar
            const staffName = staff ? staff.staffName : 'Unknown';
            const staffId = staff ? staff.id : 'N/A';
            const initials = staffName.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
            
            // Generate random gradient for staff avatar
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
            ];
            const avatarGradient = gradients[Math.abs(staffId.toString().split('').reduce((a, b) => a + b.charCodeAt(0), 0)) % gradients.length];
            
            // Map leave type to defined types
            const leaveTypeName = leaveType ? leaveType.name.toLowerCase() : 'unknown';
            const leaveTypeClass = leaveTypeName.includes('casual') ? 'casual' : 
                                   leaveTypeName.includes('earned') ? 'earned' : 
                                   leaveTypeName.includes('half') ? 'halfpay' : 'casual';
            const leaveTypeDisplay = leaveTypeName.includes('casual') ? 'Casual' : 
                                     leaveTypeName.includes('earned') ? 'Earned' : 
                                     leaveTypeName.includes('half') ? 'Half Pay' : 'Casual';
            
            // Calculate duration
            const startDate = parseDate(application.startDate);
            const endDate = parseDate(application.endDate);
            const durationDays = startDate && endDate ? 
                Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1 : 
                (application.days || 1);
            
            return `
                <tr>
                    <td>
                        <div class="staff-info">
                            <div class="staff-avatar-small" style="background: ${avatarGradient};">${initials}</div>
                            <div class="staff-details-small">
                                <span class="staff-name-small">${staffName}</span>
                                <span class="staff-id-small">${staffId}</span>
                            </div>
                        </div>
                    </td>
                    <td><span class="leave-type-badge ${leaveTypeClass}">${leaveTypeDisplay}</span></td>
                    <td>
                        <div class="date-range">
                            <span class="date">${application.startDate}</span> to <span class="date">${application.endDate}</span>
                        </div>
                    </td>
                    <td><span class="duration">${durationDays} day${durationDays !== 1 ? 's' : ''}</span></td>
                    <td><span class="status-badge ${application.status}">${application.status.toUpperCase()}</span></td>
                    <td>${application.appliedDate || application.startDate}</td>
                    <td>
                        <div class="leave-actions">
                            <button class="action-btn view" onclick="viewLeaveApplication(${application.id})">View</button>
                            ${application.status === 'pending' && canWrite() ? `
                                <button class="action-btn approve" onclick="approveLeave(${application.id})">Approve</button>
                                <button class="action-btn reject" onclick="rejectLeave(${application.id})">Reject</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `;
        }

        // Filter function for leave applications
        function filterLeaveApplications(filterType, filterValue) {
            // Get current filter values
            const statusFilter = document.querySelector('.filter-dropdown:nth-of-type(1)').value;
            const typeFilter = document.querySelector('.filter-dropdown:nth-of-type(2)').value;
            
            let filteredApplications = leaveApplications || [];
            
            // Apply status filter
            if (statusFilter !== 'all') {
                filteredApplications = filteredApplications.filter(app => app.status === statusFilter);
            }
            
            // Apply type filter
            if (typeFilter !== 'all') {
                filteredApplications = filteredApplications.filter(app => {
                    const leaveType = leaveTypes.find(t => t.id === app.leaveTypeId);
                    if (!leaveType) return false;
                    
                    const leaveTypeName = leaveType.name.toLowerCase();
                    return leaveTypeName.includes(typeFilter);
                });
            }
            
            // Update table body
            const tableBody = document.getElementById('leaveApplicationsTableBody');
            if (tableBody) {
                tableBody.innerHTML = filteredApplications.length === 0 ? 
                    '<tr><td colspan="7" style="text-align: center; color: #666; padding: 40px;">No leave applications found matching filters</td></tr>' :
                    filteredApplications.map(app => renderLeaveApplicationRow(app)).join('');
            }
            
            // Update pagination info
            const paginationInfo = document.querySelector('.pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = `Showing ${filteredApplications.length} applications`;
            }
        }

        // View leave application details
        function viewLeaveApplication(applicationId) {
            const application = leaveApplications.find(app => app.id === applicationId);
            if (!application) return;
            
            const staff = admissions.find(s => s.id === application.staffId);
            const leaveType = leaveTypes.find(t => t.id === application.leaveTypeId);
            
            showAlert('Leave Application Details', `
                <div style="text-align: left;">
                    <p><strong>Staff:</strong> ${staff ? staff.staffName : 'Unknown'} (${staff ? staff.id : 'N/A'})</p>
                    <p><strong>Leave Type:</strong> ${leaveType ? leaveType.name : 'Unknown'}</p>
                    <p><strong>From:</strong> ${application.startDate}</p>
                    <p><strong>To:</strong> ${application.endDate}</p>
                    <p><strong>Duration:</strong> ${application.days} days</p>
                    <p><strong>Reason:</strong> ${application.reason}</p>
                    <p><strong>Status:</strong> ${application.status.toUpperCase()}</p>
                    ${application.willDeductSalary ? '<p style="color: #f56565;"><strong>‚ö†Ô∏è Salary Deduction:</strong> Yes (exceeded leave limit)</p>' : ''}
                </div>
            `);
        }

        function renderAttendanceCalendar() {
            // Get current calendar date
            const now = fakeSystemTime ? fakeSystemTime.currentDate : new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();
            
            // Calculate leave statistics
            const totalApplications = leaveApplications.length;
            const pendingApplications = leaveApplications.filter(app => app.status === 'pending').length;
            const approvedApplications = leaveApplications.filter(app => app.status === 'approved').length;
            const rejectedApplications = leaveApplications.filter(app => app.status === 'rejected').length;
            
            // Generate calendar days
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // Get previous month's last days
            const prevMonth = new Date(currentYear, currentMonth, 0);
            const daysInPrevMonth = prevMonth.getDate();
            
            let calendarDays = '';
            
            // Previous month's trailing days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                calendarDays += `
                    <div class="calendar-day other-month">
                        <div class="calendar-day-number">${day}</div>
                    </div>
                `;
            }
            
            // Current month's days
            for (let day = 1; day <= daysInMonth; day++) {
                const isToday = day === currentDay;
                const dayEvents = getLeaveEventsForDay(currentYear, currentMonth, day);
                
                calendarDays += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectCalendarDay(${currentYear}, ${currentMonth}, ${day})">
                        <div class="calendar-day-number">${day}</div>
                        <div class="leave-events">
                            ${dayEvents.map(event => `
                                <div class="leave-event ${event.type}" onclick="viewLeaveDetails(${event.id})" title="${event.details}">
                                    ${event.staff} - ${event.typeLabel}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Next month's leading days
            const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                calendarDays += `
                    <div class="calendar-day other-month">
                        <div class="calendar-day-number">${day}</div>
                    </div>
                `;
            }
            
            return `
                <!-- Leave Statistics -->
                <div class="leave-stats">
                    <div class="leave-stat-card">
                        <h3>${totalApplications}</h3>
                        <p>Total Leave Applications</p>
                    </div>
                    <div class="leave-stat-card pending">
                        <h3>${pendingApplications}</h3>
                        <p>Pending Approvals</p>
                    </div>
                    <div class="leave-stat-card approved">
                        <h3>${approvedApplications}</h3>
                        <p>Approved Leaves</p>
                    </div>
                    <div class="leave-stat-card rejected">
                        <h3>${rejectedApplications}</h3>
                        <p>Rejected Leaves</p>
                    </div>
                </div>
                
                <!-- Leave Management Header -->
                <div class="leave-management-header">
                    <div class="leave-header-left">
                        <h2>üìÖ Leave Management Calendar</h2>
                        <p>View and manage staff leave applications</p>
                    </div>
                </div>
                
                <!-- Calendar -->
                <div class="calendar-container">
                    <!-- Calendar Header -->
                    <div class="calendar-header">
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" onclick="navigateCalendarMonth(-1)">‚Äπ</button>
                            <div class="calendar-month-year" id="calendarMonthYear">${now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</div>
                            <button class="calendar-nav-btn" onclick="navigateCalendarMonth(1)">‚Ä∫</button>
                        </div>
                        <div class="calendar-actions">
                            <button class="calendar-btn" onclick="goToToday()">Today</button>
                            <button class="calendar-btn" onclick="exportCalendar()">Export</button>
                            <button class="calendar-btn" onclick="printCalendar()">Print</button>
                        </div>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Day Headers -->
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                        
                        <!-- Calendar Days -->
                        ${calendarDays}
                    </div>
                    
                    <!-- Calendar Legend -->
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-color casual"></div>
                            <span>Casual Leave</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color annual"></div>
                            <span>Earned Leave</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color sick"></div>
                            <span>Half Pay Leave</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAttendanceReports() {
            // Calculate current stats
            const totalStaff = admissions.length;
            const presentCount = admissions.filter(staff => {
                try {
                    const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                    const hasLeaveToday = leaveApplications && leaveApplications.some(app => 
                        app.staffId === staff.id && 
                        app.status === 'approved' &&
                        isDateInRange(today, app.startDate, app.endDate)
                    );
                    return !hasLeaveToday;
                } catch (e) {
                    return true;
                }
            }).length;
            const onLeaveCount = leaveApplications ? leaveApplications.filter(app => 
                app.status === 'approved' && 
                isDateInRange(formatDateToDDMMYYYY(fakeSystemTime.currentDate), app.startDate, app.endDate)
            ).length : 0;
            const absentCount = totalStaff - presentCount;
            const lateCount = 2; // Mock data for late arrivals
            
            const currentDate = fakeSystemTime.currentDate;
            const currentMonth = currentDate.toLocaleDateString('en-US', { month: 'long' });
            const currentYear = currentDate.getFullYear();
            
            return `
                <!-- Reports Header -->
                <div class="reports-header">
                    <div class="reports-header-left">
                        <h2>üìä Attendance & Leave Reports</h2>
                        <p>Generate comprehensive reports and analytics</p>
                    </div>
                    <div class="reports-header-right">
                        <button class="btn-filter primary" onclick="exportAllReports()">üì• Export All</button>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="quick-stats">
                    <div class="quick-stat-card present">
                        <div class="quick-stat-icon">üë•</div>
                        <div class="quick-stat-value">${presentCount}</div>
                        <div class="quick-stat-label">Present Today</div>
                    </div>
                    <div class="quick-stat-card absent">
                        <div class="quick-stat-icon">‚ùå</div>
                        <div class="quick-stat-value">${absentCount}</div>
                        <div class="quick-stat-label">Absent Today</div>
                    </div>
                    <div class="quick-stat-card leave">
                        <div class="quick-stat-icon">üèñÔ∏è</div>
                        <div class="quick-stat-value">${onLeaveCount}</div>
                        <div class="quick-stat-label">On Leave</div>
                    </div>
                    <div class="quick-stat-card late">
                        <div class="quick-stat-icon">‚è∞</div>
                        <div class="quick-stat-value">${lateCount}</div>
                        <div class="quick-stat-label">Late Arrivals</div>
                    </div>
                </div>

                <!-- Report Filter Section -->
                <div class="reports-filters">
                    <div class="filters-title">
                        üîç Report Filters
                    </div>
                    
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">Report Type</label>
                            <select class="filter-select" id="reportType">
                                <option value="attendance">Attendance Report</option>
                                <option value="leave">Leave Report</option>
                                <option value="summary">Monthly Summary</option>
                                <option value="payroll">Payroll Report</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Department</label>
                            <select class="filter-select" id="reportDepartment">
                                <option value="all">All Departments</option>
                                <option value="administration">Administration</option>
                                <option value="accounts">Accounts</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="security">Security</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">From Date</label>
                            <input type="date" class="filter-input" id="reportFromDate" value="${currentYear}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">To Date</label>
                            <input type="date" class="filter-input" id="reportToDate" value="${currentYear}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}">
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Staff Member</label>
                            <select class="filter-select" id="reportStaffMember">
                                <option value="all">All Staff</option>
                                ${admissions.map(staff => `<option value="${staff.id}">${staff.staffName} (${staff.id})</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">Status</label>
                            <select class="filter-select" id="reportStatus">
                                <option value="all">All Status</option>
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="leave">On Leave</option>
                                <option value="late">Late</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="filters-actions">
                        <button class="btn-filter secondary" onclick="clearReportFilters()">Clear Filters</button>
                        <button class="btn-filter primary" onclick="generateFilteredReport()">Generate Report</button>
                    </div>
                </div>

                <!-- Report Type Cards -->
                <div class="reports-grid">
                    <!-- Monthly Attendance Report -->
                    <div class="report-card">
                        <div class="report-card-header">
                            <div class="report-card-icon">üìÖ</div>
                            <h3 class="report-card-title">Monthly Attendance</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Comprehensive monthly attendance report with daily breakdown, total working days, and attendance percentage for each staff member.</p>
                            <ul class="report-card-features">
                                <li>Daily attendance tracking</li>
                                <li>Department-wise summary</li>
                                <li>Attendance percentage calculation</li>
                                <li>Late arrival tracking</li>
                                <li>Export to PDF/Excel</li>
                            </ul>
                            <button class="report-generate-btn" onclick="generateMonthlyAttendanceReport()">Generate Monthly Report</button>
                        </div>
                    </div>

                    <!-- Leave Summary Report -->
                    <div class="report-card">
                        <div class="report-card-header" style="background: linear-gradient(135deg, #ffa726 0%, #ff8f00 100%);">
                            <div class="report-card-icon">üèñÔ∏è</div>
                            <h3 class="report-card-title">Leave Summary</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Detailed leave utilization report showing leave balances, applications, approvals, and remaining entitlements by leave type.</p>
                            <ul class="report-card-features">
                                <li>Leave balance summary</li>
                                <li>Leave type breakdown</li>
                                <li>Pending applications</li>
                                <li>Approval/rejection ratios</li>
                                <li>Year-end projections</li>
                            </ul>
                            <button class="report-generate-btn" onclick="generateLeaveSummaryReport()">Generate Leave Report</button>
                        </div>
                    </div>

                    <!-- Payroll Deductions Report -->
                    <div class="report-card">
                        <div class="report-card-header" style="background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);">
                            <div class="report-card-icon">üí∞</div>
                            <h3 class="report-card-title">Payroll & Deductions</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Complete payroll report including salary calculations, deductions, loan recoveries, and net pay calculations for payroll processing.</p>
                            <ul class="report-card-features">
                                <li>Salary calculations</li>
                                <li>Deduction breakdowns</li>
                                <li>Loan recovery tracking</li>
                                <li>Tax computations</li>
                                <li>Bank transfer format</li>
                            </ul>
                            <button class="report-generate-btn" onclick="generatePayrollDeductionsReport()">Generate Payroll Report</button>
                        </div>
                    </div>

                    <!-- Performance Analytics -->
                    <div class="report-card">
                        <div class="report-card-header" style="background: linear-gradient(135deg, #ef5350 0%, #d32f2f 100%);">
                            <div class="report-card-icon">üìà</div>
                            <h3 class="report-card-title">Performance Analytics</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Advanced analytics dashboard with trends, comparisons, and insights for workforce management and performance tracking.</p>
                            <ul class="report-card-features">
                                <li>Attendance trends</li>
                                <li>Department comparisons</li>
                                <li>Seasonal patterns</li>
                                <li>Productivity metrics</li>
                                <li>Predictive insights</li>
                            </ul>
                            <button class="report-generate-btn" onclick="generatePerformanceAnalytics()">Generate Analytics</button>
                        </div>
                    </div>

                    <!-- Custom Reports -->
                    <div class="report-card">
                        <div class="report-card-header" style="background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                            <div class="report-card-icon">‚öôÔ∏è</div>
                            <h3 class="report-card-title">Custom Reports</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Build custom reports with specific criteria, date ranges, and data fields tailored to your organizational requirements.</p>
                            <ul class="report-card-features">
                                <li>Custom date ranges</li>
                                <li>Flexible data fields</li>
                                <li>Multiple export formats</li>
                                <li>Saved report templates</li>
                                <li>Scheduled generation</li>
                            </ul>
                            <button class="report-generate-btn" onclick="openCustomReportBuilder()">Build Custom Report</button>
                        </div>
                    </div>

                    <!-- Document Management -->
                    <div class="report-card">
                        <div class="report-card-header" style="background: linear-gradient(135deg, #00bcd4 0%, #0097a7 100%);">
                            <div class="report-card-icon">üìã</div>
                            <h3 class="report-card-title">Document Reports</h3>
                        </div>
                        <div class="report-card-body">
                            <p class="report-card-description">Generate official documents, certificates, and compliance reports for audit purposes and regulatory requirements.</p>
                            <ul class="report-card-features">
                                <li>Attendance certificates</li>
                                <li>Service records</li>
                                <li>Compliance reports</li>
                                <li>Audit documentation</li>
                                <li>Official letterheads</li>
                            </ul>
                            <button class="report-generate-btn" onclick="generateDocumentReports()">Generate Documents</button>
                        </div>
                    </div>
                </div>

                <!-- Sample Report Results (initially hidden) -->
                <div class="report-results" id="reportResults" style="display: none;">
                    <div class="report-results-header">
                        <h3 class="report-results-title">üìã Monthly Attendance Report - ${currentMonth} ${currentYear}</h3>
                        <div class="report-actions">
                            <button class="report-action-btn" onclick="showReportCharts()">üìä Charts</button>
                            <button class="report-action-btn" onclick="exportReportPDF()">üìÑ PDF</button>
                            <button class="report-action-btn" onclick="exportReportExcel()">üìä Excel</button>
                            <button class="report-action-btn" onclick="printReport()">üñ®Ô∏è Print</button>
                        </div>
                    </div>
                    
                    <table class="report-table" id="reportTable">
                        <!-- Report content will be dynamically generated -->
                    </table>
                    
                    <!-- Report Summary -->
                    <div style="padding: 20px 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: #666; font-size: 14px;" id="reportSummary">
                                Report generated on: ${formatDateToDDMMYYYY(currentDate)} | Total Records: ${totalStaff} | Average Attendance: 88.2%
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="report-action-btn" onclick="emailReport()">üìß Email Report</button>
                                <button class="report-action-btn" onclick="saveReportTemplate()">üíæ Save Template</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Chart (initially hidden) -->
                <div class="chart-container" id="reportChart" style="display: none;">
                    <h3 class="chart-title">üìä Monthly Attendance Trends</h3>
                    <div class="chart-placeholder">
                        Chart visualization would appear here<br>
                        (Integration with Chart.js, D3.js, or similar library)
                    </div>
                </div>
            `;
        }

        // Calendar helper functions
        let currentCalendarDate = fakeSystemTime ? new Date(fakeSystemTime.currentDate) : new Date();

        function getLeaveEventsForDay(year, month, day) {
            const events = [];
            const targetDate = new Date(year, month, day);
            const targetDateStr = formatDateToDDMMYYYY(targetDate);
            
            // Find leave applications for this date
            leaveApplications.forEach(application => {
                if (application.status !== 'approved') return;
                
                const startDate = parseDDMMYYYY(application.startDate);
                const endDate = parseDDMMYYYY(application.endDate);
                
                if (startDate && endDate && targetDate >= startDate && targetDate <= endDate) {
                    const staff = admissions.find(s => s.id === application.staffId);
                    const staffName = staff ? staff.staffName : 'Unknown Staff';
                    
                    // Map leave type to CSS class
                    const leaveType = leaveTypes.find(t => t.id === application.leaveTypeId);
                    const leaveTypeName = leaveType ? leaveType.name.toLowerCase() : 'unknown';
                    let typeClass = 'casual'; // default
                    
                    if (leaveTypeName.includes('casual')) {
                        typeClass = 'casual';
                    } else if (leaveTypeName.includes('earned')) {
                        typeClass = 'annual'; // Use annual color for earned leave
                    } else if (leaveTypeName.includes('half')) {
                        typeClass = 'sick'; // Use sick color for half pay leave
                    }
                    
                    events.push({
                        id: application.id,
                        staff: staffName,
                        type: typeClass,
                        typeLabel: leaveType ? leaveType.name : 'Unknown',
                        details: `${staffName} - ${leaveType ? leaveType.name : 'Unknown'} (${application.startDate} to ${application.endDate})`
                    });
                }
            });
            
            return events;
        }

        function navigateCalendarMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            
            // Update fake system time if it exists
            if (fakeSystemTime) {
                fakeSystemTime.currentDate = new Date(currentCalendarDate);
            }
            
            // Re-render the calendar
            showAttendanceTab('calendar');
        }

        function goToToday() {
            currentCalendarDate = fakeSystemTime ? new Date(fakeSystemTime.currentDate) : new Date();
            showAttendanceTab('calendar');
        }

        function selectCalendarDay(year, month, day) {
            const selectedDate = new Date(year, month, day);
            const events = getLeaveEventsForDay(year, month, day);
            
            if (events.length > 0) {
                console.log(`Selected ${day}/${month + 1}/${year} with ${events.length} leave event(s)`);
                // Could show day details modal here
            } else {
                console.log(`Selected ${day}/${month + 1}/${year} - No leave events`);
            }
        }

        function viewLeaveDetails(applicationId) {
            const application = leaveApplications.find(app => app.id === applicationId);
            if (application) {
                console.log('Viewing leave details for application:', application);
                // Could open leave details modal here
            }
        }

        function exportCalendar() {
            console.log('Exporting calendar view...');
            alert('Calendar export functionality - Coming soon!');
        }

        function printCalendar() {
            console.log('Printing calendar view...');
            window.print();
        }

        function getStaffServicePeriod(staffId) {
            const staff = admissions.find(s => s.id === staffId);
            if (!staff || (!staff.dateOfAppointment && !staff.dateOfJoining)) return 0;
            
            const joiningDateString = staff.dateOfAppointment || staff.dateOfJoining;
            let joiningDate;
            
            if (joiningDateString) {
                if (joiningDateString.includes('/')) {
                    joiningDate = parseDDMMYYYY(joiningDateString);
                } else if (joiningDateString.includes('-')) {
                    // Handle DD-MM-YYYY format with dashes
                    const parts = joiningDateString.split('-');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                        const year = parseInt(parts[2]);
                        joiningDate = new Date(year, month, day);
                    } else {
                        joiningDate = new Date(joiningDateString);
                    }
                } else {
                    joiningDate = new Date(joiningDateString);
                }
            }
            
            if (!joiningDate) return 0;
            
            const currentDate = fakeSystemTime.currentDate;
            const years = (currentDate - joiningDate) / (365.25 * 24 * 60 * 60 * 1000);
            return Math.floor(years);
        }

        function calculateCasualLeaveEntitlement(staffId) {
            const servicePeriod = getStaffServicePeriod(staffId);
            if (servicePeriod < 10) return 10;
            if (servicePeriod < 20) return 15;
            return 20;
        }

        function calculateEarnedLeaveBalance(staffId) {
            const staff = admissions.find(s => s.id === staffId);
            if (!staff) return { available: 0, used: 0, carryover: 0, total: 0 };
            
            const currentYear = fakeSystemTime.currentYear;
            const isFirstHalf = fakeSystemTime.isFirstHalf;
            
            // Get appointment date
            const appointmentDateStr = staff.dateOfAppointment || staff.dateOfJoining;
            let appointmentDate;
            
            if (appointmentDateStr) {
                if (appointmentDateStr.includes('/')) {
                    appointmentDate = parseDDMMYYYY(appointmentDateStr);
                } else if (appointmentDateStr.includes('-')) {
                    // Handle DD-MM-YYYY format with dashes
                    const parts = appointmentDateStr.split('-');
                    if (parts.length === 3) {
                        const day = parseInt(parts[0]);
                        const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                        const year = parseInt(parts[2]);
                        appointmentDate = new Date(year, month, day);
                    } else {
                        appointmentDate = new Date(appointmentDateStr);
                    }
                } else {
                    appointmentDate = new Date(appointmentDateStr);
                }
            }
            
            if (!appointmentDate) {
                return { available: 0, used: 0, carryover: 0, total: 0 };
            }
            
            const appointmentYear = appointmentDate.getFullYear();
            const appointmentMonth = appointmentDate.getMonth(); // 0-11
            
            // Get carryover from previous year (unlimited carryover, but total capped at 300)
            const previousYearCarryover = getStaffLeaveCarryover(staffId, currentYear - 1);
            
            // Calculate current year entitlement based on appointment date
            let currentYearEntitlement = 0;
            
            if (currentYear > appointmentYear) {
                // Full year entitlement for years after joining
                currentYearEntitlement = 15; // January 1st allocation
                if (!isFirstHalf) {
                    currentYearEntitlement += 15; // July 1st additional allocation
                }
            } else if (currentYear === appointmentYear) {
                // Prorated for joining year
                if (appointmentMonth < 6) {
                    // Joined in first half (Jan-June), gets Jan 1st allocation
                    currentYearEntitlement = 15;
                    if (!isFirstHalf && appointmentMonth < 6) {
                        currentYearEntitlement += 15; // Also gets July 1st allocation
                    }
                } else {
                    // Joined in second half (July-Dec), only gets July 1st allocation if joined by July 1st
                    if (appointmentMonth === 6 && appointmentDate.getDate() === 1) {
                        currentYearEntitlement = 15; // July 1st allocation
                    } else if (appointmentMonth === 6 && appointmentDate.getDate() > 1) {
                        currentYearEntitlement = 0; // Joined after July 1st, no earned leave for that year
                    } else {
                        currentYearEntitlement = 0; // Joined after July, no earned leave for that year
                    }
                }
            }
            
            // Calculate total before cap (carryover + current year allocation)
            const totalBeforeCap = previousYearCarryover + currentYearEntitlement;
            
            // Apply 300 leave maximum cap
            const totalAvailable = Math.min(totalBeforeCap, 300);
            
            // If total exceeds 300, the excess is lost (cannot be carried forward)
            const lostLeaves = Math.max(0, totalBeforeCap - 300);
            
            // Calculate used leaves for current year
            const usedThisYear = leaveApplications
                .filter(app => app.staffId === staffId && app.status === 'approved' && 
                               app.leaveTypeId === 2 && // Earned leave
                               new Date(app.startDate).getFullYear() === currentYear)
                .reduce((sum, app) => sum + app.days, 0);
            
            const remaining = totalAvailable - usedThisYear;
            
            return {
                available: Math.max(0, remaining),
                used: usedThisYear,
                carryover: previousYearCarryover,
                currentYearEntitlement: currentYearEntitlement,
                total: totalAvailable,
                totalBeforeCap: totalBeforeCap,
                lostLeaves: lostLeaves,
                yearlyEntitlement: currentYearEntitlement // Keep for backward compatibility
            };
        }

        function calculateHalfPayLeaveBalance(staffId) {
            const staff = admissions.find(s => s.id === staffId);
            if (!staff) return { available: 0, used: 0, firstHalfUsed: 0 };
            
            const currentYear = fakeSystemTime.currentYear;
            const isFirstHalf = fakeSystemTime.isFirstHalf;
            
            // Base entitlement: 15 days on Jan 1st, 10 days on July 1st
            let yearlyEntitlement = 15; // January 1st allocation
            if (!isFirstHalf) {
                yearlyEntitlement += 10; // July 1st additional allocation
            }
            
            // Calculate used leaves for current year
            const usedThisYear = leaveApplications
                .filter(app => app.staffId === staffId && app.status === 'approved' && 
                               app.leaveTypeId === 3 && // Half pay leave
                               new Date(app.startDate).getFullYear() === currentYear)
                .reduce((sum, app) => sum + app.days, 0);
            
            // Calculate first half usage (Jan-June)
            const firstHalfUsed = leaveApplications
                .filter(app => app.staffId === staffId && app.status === 'approved' && 
                               app.leaveTypeId === 3 && // Half pay leave
                               new Date(app.startDate).getFullYear() === currentYear &&
                               new Date(app.startDate).getMonth() < 6)
                .reduce((sum, app) => sum + app.days, 0);
            
            // Special rule: First half usage is deducted from initial 10 days
            let available = yearlyEntitlement;
            if (isFirstHalf) {
                // In first half, only 15 days are available
                available = Math.max(0, 15 - usedThisYear);
            } else {
                // In second half, add remaining from first half to July allocation
                const firstHalfRemaining = Math.max(0, 10 - firstHalfUsed);
                available = firstHalfRemaining + 10 - (usedThisYear - firstHalfUsed);
            }
            
            return {
                available: Math.max(0, available),
                used: usedThisYear,
                firstHalfUsed: firstHalfUsed,
                yearlyEntitlement: yearlyEntitlement
            };
        }

        function getStaffLeaveCarryover(staffId, year) {
            // This would typically be stored in a database
            // For demo, we'll calculate based on actual service years
            const carryoverData = JSON.parse(localStorage.getItem('leaveCarryover')) || {};
            const key = `${staffId}_${year}`;
            
            // If no data exists, calculate based on appointment date
            if (!carryoverData[key]) {
                const staff = admissions.find(s => s.id === staffId);
                if (staff) {
                    const appointmentDateStr = staff.dateOfAppointment || staff.dateOfJoining;
                    let appointmentDate;
                    
                    if (appointmentDateStr) {
                        if (appointmentDateStr.includes('/')) {
                            appointmentDate = parseDDMMYYYY(appointmentDateStr);
                        } else if (appointmentDateStr.includes('-')) {
                            // Handle DD-MM-YYYY format with dashes
                            const parts = appointmentDateStr.split('-');
                            if (parts.length === 3) {
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                                const year = parseInt(parts[2]);
                                appointmentDate = new Date(year, month, day);
                            } else {
                                appointmentDate = new Date(appointmentDateStr);
                            }
                        } else {
                            appointmentDate = new Date(appointmentDateStr);
                        }
                    }
                    
                    if (!appointmentDate) {
                        return 0;
                    }
                    
                    const appointmentYear = appointmentDate.getFullYear();
                    const appointmentMonth = appointmentDate.getMonth();
                    
                    // Calculate accumulated earned leave from joining year up to (and including) requested year
                    let totalAccumulated = 0;
                    
                    for (let y = appointmentYear; y <= year; y++) {
                        if (y === appointmentYear) {
                            // First year - prorated
                            if (appointmentMonth < 6) {
                                totalAccumulated += 30; // Gets both Jan and July allocations
                            } else if (appointmentMonth === 6 && appointmentDate.getDate() === 1) {
                                totalAccumulated += 15; // Only July allocation
                            }
                            // If joined after July 1st, no earned leave for that year
                        } else {
                            // Full years get 30 days
                            totalAccumulated += 30;
                        }
                    }
                    
                    // Calculate actual used leaves from appointment year up to (and including) requested year
                    let actualUsed = 0;
                    for (let y = appointmentYear; y <= year; y++) {
                        actualUsed += leaveApplications
                            .filter(app => app.staffId === staffId && 
                                          app.status === 'approved' && 
                                          app.leaveTypeId === 2 && // Earned leave
                                          new Date(app.startDate).getFullYear() === y)
                            .reduce((sum, app) => sum + app.days, 0);
                    }
                    
                    // Carryover = Total accumulated - Actually used
                    const carryover = totalAccumulated - actualUsed;
                    
                    // Cap at 300 as per policy
                    carryoverData[key] = Math.min(Math.max(0, carryover), 300);
                    
                    // Save the calculated data
                    localStorage.setItem('leaveCarryover', JSON.stringify(carryoverData));
                }
            }
            
            return carryoverData[key] || 0;
        }

        function getStaffLeaveBalance(staffId) {
            const staff = admissions.find(s => s.id === staffId);
            if (!staff) return {};
            
            // Only calculate for male staff for now
            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender; // Default to male if not specified
            
            if (!isMale) {
                return {
                    1: { available: 0, message: 'Female staff leave rules not implemented yet' },
                    2: { available: 0, message: 'Female staff leave rules not implemented yet' },
                    3: { available: 0, message: 'Female staff leave rules not implemented yet' }
                };
            }
            
            return {
                1: { // Casual Leave
                    available: calculateCasualLeaveEntitlement(staffId),
                    used: leaveApplications
                        .filter(app => app.staffId === staffId && app.status === 'approved' && 
                                       app.leaveTypeId === 1 && 
                                       new Date(app.startDate).getFullYear() === fakeSystemTime.currentYear)
                        .reduce((sum, app) => sum + app.days, 0),
                    servicePeriod: getStaffServicePeriod(staffId)
                },
                2: calculateEarnedLeaveBalance(staffId), // Earned Leave
                3: calculateHalfPayLeaveBalance(staffId) // Half Pay Leave
            };
        }
        
        // Function to completely reset and recalculate leave data
        function resetAndRecalculateLeaveData(staffName) {
            // Find staff by name
            const staff = admissions.find(s => 
                s.staffName && s.staffName.toLowerCase() === staffName.toLowerCase()
            );
            
            if (!staff) {
                console.error(`Staff member "${staffName}" not found`);
                return false;
            }
            
            console.log(`=== RESETTING LEAVE DATA FOR ${staff.staffName.toUpperCase()} ===`);
            
            // Clear ALL leave-related localStorage data
            localStorage.removeItem('leaveCarryover');
            localStorage.removeItem('cantonment_staff_leave_balances');
            
            console.log('Cleared all cached leave data from localStorage');
            
            // Test date parsing
            const dateStr = staff.dateOfAppointment;
            console.log('Original date string:', dateStr);
            
            let testDate;
            if (dateStr && dateStr.includes('-')) {
                const parts = dateStr.split('-');
                const day = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const year = parseInt(parts[2]);
                testDate = new Date(year, month, day);
            } else {
                // Fallback: try to parse as standard date or create current date
                testDate = dateStr ? new Date(dateStr) : new Date();
                if (isNaN(testDate.getTime())) {
                    console.warn('Could not parse date, using current date as fallback');
                    testDate = new Date();
                }
            }
            
            console.log('Parsed date:', testDate);
            if (testDate && !isNaN(testDate.getTime())) {
                console.log('Month (0-indexed):', testDate.getMonth(), '(6 = July)');
                console.log('Is July?', testDate.getMonth() === 6);
            } else {
                console.error('Invalid date object created');
            }
            
            // Force fresh calculation
            const newBalance = calculateEarnedLeaveBalance(staff.id);
            
            console.log('\n=== FRESH CALCULATION RESULTS ===');
            console.log('- Previous Year Carryover:', newBalance.carryover, 'days');
            console.log('- Current Year Entitlement:', newBalance.currentYearEntitlement, 'days');
            console.log('- Total Available:', newBalance.total, 'days');
            console.log('- Used This Year:', newBalance.used, 'days');
            console.log('- Remaining:', newBalance.available, 'days');
            
            return true;
        }

        // Function to update leave data for a specific staff member
        function updateStaffLeaveData(staffName) {
            // Find staff by name
            const staff = admissions.find(s => 
                s.staffName && s.staffName.toLowerCase() === staffName.toLowerCase()
            );
            
            if (!staff) {
                console.error(`Staff member "${staffName}" not found`);
                return false;
            }
            
            console.log(`Updating leave data for ${staff.staffName} (ID: ${staff.id})`);
            
            // Clear existing carryover data for this staff
            const carryoverData = JSON.parse(localStorage.getItem('leaveCarryover')) || {};
            const currentYear = fakeSystemTime.currentYear;
            
            // Remove all carryover entries for this staff
            Object.keys(carryoverData).forEach(key => {
                if (key.startsWith(`${staff.id}_`)) {
                    delete carryoverData[key];
                }
            });
            
            // Save cleared data
            localStorage.setItem('leaveCarryover', JSON.stringify(carryoverData));
            
            // Force recalculation by calling the balance function
            const newBalance = calculateEarnedLeaveBalance(staff.id);
            
            console.log('Updated earned leave balance:', newBalance);
            console.log(`- Previous Year Carryover: ${newBalance.carryover} days`);
            console.log(`- Current Year Entitlement: ${newBalance.currentYearEntitlement} days`);
            console.log(`- Total Available: ${newBalance.total} days`);
            console.log(`- Used This Year: ${newBalance.used} days`);
            console.log(`- Remaining: ${newBalance.available} days`);
            
            // If there's a UI component showing leave balance, refresh it
            if (typeof showLeaveManagement === 'function') {
                showLeaveManagement();
            }
            
            return true;
        }
        
        // Expose functions globally for console access
        window.updateStaffLeaveData = updateStaffLeaveData;
        window.resetAndRecalculateLeaveData = resetAndRecalculateLeaveData;
        
        // Auto-update Paras Rathee's leave data on page load
        setTimeout(() => {
            const parasStaff = admissions.find(s => 
                s.staffName && s.staffName.toLowerCase().includes('paras') && 
                s.staffName.toLowerCase().includes('rathee')
            );
            if (parasStaff) {
                console.log('Auto-updating leave data for Paras Rathee with FIXED carryover calculation...');
                resetAndRecalculateLeaveData('Paras Rathee');
            }
        }, 1500);

        function openLeaveApplicationModal() {
            if (!canWriteSection('leave')) {
                alert("You don't have permission to apply for leave.");
                return;
            }
            // Ensure leave types are loaded first
            if (!leaveTypes || leaveTypes.length === 0) {
                leaveTypes = [...defaultLeaveTypes];
                localStorage.setItem('leaveTypes', JSON.stringify(defaultLeaveTypes));
            }
            
            // Use the simple original select dropdown with availability check
            const leaveTypeSelect = document.getElementById('leaveTypeId');
            if (leaveTypeSelect) {
                let optionsHTML = '<option value="">Select Leave Type</option>';
                
                // Get current staff data to check availability
                const staffNameField = document.getElementById('leaveStaffName');
                const databaseId = parseInt(staffNameField.getAttribute('data-staff-db-id'));
                
                leaveTypes.forEach(type => {
                    let isDisabled = false;
                    let displayName = type.name;
                    
                    // Check if staff is selected and get their leave balance
                    if (databaseId) {
                        const staff = getStaffByDatabaseId(databaseId);
                        if (staff) {
                            let available = 0;
                            
                            switch(type.id) {
                                case 1: // Casual Leave
                                    const casualBalance = getStaffLeaveBalanceComprehensive(databaseId);
                                    if (casualBalance) {
                                        available = casualBalance.casual.available;
                                    }
                                    break;
                                case 2: // Earned Leave
                                    const earnedData = calculateEarnedLeaveBalance(databaseId);
                                    available = earnedData ? earnedData.available : 0;
                                    break;
                                case 3: // Half Pay Leave
                                    const halfPayBalance = getStaffLeaveBalanceComprehensive(databaseId);
                                    if (halfPayBalance) {
                                        const cycleInfo = getHalfPayLeaveCycle();
                                        const firstHalfUsed = halfPayBalance.halfpay.firstHalfUsed || 0;
                                        const secondHalfUsed = halfPayBalance.halfpay.secondHalfUsed || 0;
                                        const currentCycleUsed = cycleInfo.isFirstHalf ? firstHalfUsed : secondHalfUsed;
                                        available = 10 - currentCycleUsed;
                                    }
                                    break;
                            }
                            
                            // Disable if no days available
                            if (available <= 0) {
                                isDisabled = true;
                                displayName = `${type.name} (No days available)`;
                            }
                        }
                    }
                    
                    optionsHTML += `<option value="${type.id}" ${isDisabled ? 'disabled style="color: #ccc; background-color: #f8f9fa;"' : ''}>${displayName}</option>`;
                });
                
                leaveTypeSelect.innerHTML = optionsHTML;
                
                // Make sure the original select is visible
                leaveTypeSelect.style.display = 'block';
                
                // Remove any custom dropdown if it exists
                const customDropdown = document.getElementById('customLeaveTypeDropdown');
                if (customDropdown) {
                    customDropdown.remove();
                }
            }
            
            // Reset form
            document.getElementById('leaveApplicationForm').reset();
            document.getElementById('leaveBalanceInfo').style.display = 'none';
            document.getElementById('leaveStaffName').value = '';
            document.getElementById('leaveStaffName').style.color = '';
            document.getElementById('leaveStaffName').removeAttribute('data-staff-id');
            document.getElementById('submitLeaveBtn').disabled = false;
            
            // Open modal using standard professional modal function
            openProfessionalModal('leaveApplicationModal');
            
            // Ensure modal opens at the top and focus on first field
            setTimeout(() => {
                const modal = document.getElementById('leaveApplicationModal');
                if (modal) {
                    // Scroll modal to top
                    modal.scrollTop = 0;
                    
                    // Focus on the first field (Staff Name)
                    const firstField = document.getElementById('leaveStaffName');
                    if (firstField) {
                        firstField.focus();
                    }
                }
            }, 100);
            
            // Reinitialize Pikaday calendars for modal date fields with enhanced scroll handling
            setTimeout(() => {
                // Clear any existing values first to ensure clean state
                document.getElementById('leaveStartDate').value = '';
                document.getElementById('leaveEndDate').value = '';
                document.getElementById('leaveDays').value = '';
                
                // Initialize leave date fields with Flatpickr
                initializeLeaveDateFields();
                
                // Additional setup for leave modal specific handling
                setTimeout(() => {
                    const leaveModal = document.getElementById('leaveApplicationModal');
                    const leaveModalBody = leaveModal ? leaveModal.querySelector('.professional-modal-body') : null;
                    const leaveStartField = document.getElementById('leaveStartDate');
                    const leaveEndField = document.getElementById('leaveEndDate');
                    
                    // Ensure change event handlers are properly set up after Pikaday initialization
                    [leaveStartField, leaveEndField].forEach(field => {
                        if (field) {
                            // Make sure the onchange attribute is preserved and working
                            field.setAttribute('onchange', 'calculateLeaveDays()');
                            
                            // Also add event listener as backup
                            field.addEventListener('change', calculateLeaveDays);
                        }
                    });
                    
                    if (leaveModalBody) {
                        // Set up scroll handling for Pikaday repositioning
                        [leaveStartField, leaveEndField].forEach(field => {
                            if (field && field._pikaday) {
                                const repositionHandler = () => {
                                    if (field._pikaday.isVisible()) {
                                        requestAnimationFrame(() => {
                                            field._pikaday.adjustPosition();
                                        });
                                    }
                                };
                                
                                // Add scroll listener specifically to the modal body
                                leaveModalBody.addEventListener('scroll', repositionHandler, { passive: true });
                                
                                // Store handler for cleanup
                                if (!field._modalScrollHandlers) {
                                    field._modalScrollHandlers = [];
                                }
                                field._modalScrollHandlers.push({
                                    container: leaveModalBody,
                                    handler: repositionHandler
                                });
                            }
                        });
                    }
                }, 200);
            }, 200);
        }

        function refreshLeaveTypesDropdown() {
            try {
                // Ensure leave types are loaded
                if (!leaveTypes || leaveTypes.length === 0) {
                    leaveTypes = [...defaultLeaveTypes];
                    localStorage.setItem('leaveTypes', JSON.stringify(defaultLeaveTypes));
                    console.log('Refreshing leave types with defaults:', leaveTypes);
                }
                
                console.log('Current leave types:', leaveTypes);
                
                // Clear existing dropdown and create custom dropdown with visual bars
                const leaveTypeSelect = document.getElementById('leaveTypeId');
                
                if (!leaveTypeSelect) {
                    console.error('Leave type select element not found');
                    return;
                }
            
            // Get staff ID if already selected to show their balances
            const staffNameField = document.getElementById('leaveStaffName');
            const databaseId = parseInt(staffNameField.getAttribute('data-staff-db-id'));
            
            // Hide the original select and create a custom dropdown
            leaveTypeSelect.style.display = 'none';
            
            // Check if custom dropdown already exists
            let customDropdown = document.getElementById('customLeaveTypeDropdown');
            if (customDropdown) {
                customDropdown.remove();
            }
            
            // Create custom dropdown container
            customDropdown = document.createElement('div');
            customDropdown.id = 'customLeaveTypeDropdown';
            customDropdown.className = 'custom-dropdown';
            
            // Create dropdown button
            const dropdownButton = document.createElement('div');
            dropdownButton.className = 'custom-dropdown-button';
            dropdownButton.innerHTML = '<span>Select Leave Type</span><span class="dropdown-arrow">‚ñº</span>';
            
            // Create dropdown options container
            const dropdownOptions = document.createElement('div');
            dropdownOptions.className = 'custom-dropdown-options';
            
            // Add default option
            const defaultOption = document.createElement('div');
            defaultOption.className = 'custom-dropdown-option';
            defaultOption.innerHTML = 'Select Leave Type';
            defaultOption.onclick = () => selectLeaveType('', 'Select Leave Type');
            dropdownOptions.appendChild(defaultOption);
            
            // Add leave type options with visual bars
            leaveTypes.forEach(type => {
                const option = document.createElement('div');
                option.className = 'custom-dropdown-option';
                option.setAttribute('data-value', type.id);
                
                let balanceBarHTML = '';
                let balanceText = '';
                let available = 0, total = 0, used = 0;
                
                if (databaseId) {
                    // Get leave balance for the selected staff using the comprehensive function
                    const staff = getStaffByDatabaseId(databaseId);
                    if (staff) {
                        const leaveBalance = getStaffLeaveBalanceComprehensive(databaseId);
                        if (leaveBalance) {
                            switch(type.id) {
                                case 1: // Casual Leave
                                    available = leaveBalance.casual.available;
                                    total = leaveBalance.casual.entitled;
                                    used = total - available;
                                    break;
                                case 2: // Earned Leave
                                    available = leaveBalance.earned.available;
                                    total = leaveBalance.earned.totalAccumulated;
                                    used = total - available;
                                    break;
                                case 3: // Half Pay Leave
                                    const cycleInfo = getHalfPayLeaveCycle();
                                    const firstHalfUsed = leaveBalance.halfpay.firstHalfUsed || 0;
                                    const secondHalfUsed = leaveBalance.halfpay.secondHalfUsed || 0;
                                    const currentCycleUsed = cycleInfo.isFirstHalf ? firstHalfUsed : secondHalfUsed;
                                    available = 10 - currentCycleUsed;
                                    total = 10;
                                    used = currentCycleUsed;
                                    break;
                            }
                            balanceText = `${available}/${total} available`;
                        }
                    } else {
                        // Show default values when staff not found
                        switch(type.id) {
                            case 1: // Casual Leave - show default 10 days
                                available = 10;
                                total = 10;
                                used = 0;
                                balanceText = `${available}/${total} available`;
                                break;
                            case 2: // Earned Leave - show default 30 days
                                available = 30;
                                total = 30;
                                used = 0;
                                balanceText = `${available}/${total} available`;
                                break;
                            case 3: // Half Pay Leave - show default 10 days for current cycle
                                available = 10;
                                total = 10;
                                used = 0;
                                balanceText = `${available}/${total} available this cycle`;
                                break;
                        }
                    }
                } else {
                    // Show default values when no staff selected
                    switch(type.id) {
                        case 1: // Casual Leave - show default 10 days
                            available = 10;
                            total = 10;
                            used = 0;
                            balanceText = `${available}/${total} available`;
                            break;
                        case 2: // Earned Leave - show default 30 days
                            available = 30;
                            total = 30;
                            used = 0;
                            balanceText = `${available}/${total} available`;
                            break;
                        case 3: // Half Pay Leave - show default 10 days for current cycle
                            available = 10;
                            total = 10;
                            used = 0;
                            balanceText = `${available}/${total} available this cycle`;
                            break;
                    }
                }
                
                // Always show the bar
                const usedPercentage = total > 0 ? (used / total) * 100 : 0;
                
                balanceBarHTML = `
                    <div class="leave-balance-bar">
                        <div class="leave-bar-background">
                            <div class="leave-bar-used" style="width: ${usedPercentage}%; background-color: #dc3545;"></div>
                            <div class="leave-bar-available" style="width: ${100 - usedPercentage}%; background-color: #28a745;"></div>
                        </div>
                        <div class="leave-bar-text">${balanceText}</div>
                    </div>
                `;
                
                option.innerHTML = `
                    <div class="leave-option-content">
                        <div class="leave-option-header">
                            <strong>${type.name}</strong>
                            <span class="leave-option-color" style="background-color: ${type.color};"></span>
                        </div>
                        ${balanceBarHTML}
                    </div>
                `;
                
                option.onclick = () => selectLeaveType(type.id, type.name);
                dropdownOptions.appendChild(option);
            });
            
            // Toggle dropdown functionality
            dropdownButton.onclick = () => {
                dropdownOptions.style.display = dropdownOptions.style.display === 'block' ? 'none' : 'block';
            };
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!customDropdown.contains(e.target)) {
                    dropdownOptions.style.display = 'none';
                }
            });
            
            customDropdown.appendChild(dropdownButton);
            customDropdown.appendChild(dropdownOptions);
            
                // Insert after the original select
                leaveTypeSelect.parentNode.insertBefore(customDropdown, leaveTypeSelect.nextSibling);
                
            } catch (error) {
                console.error('Error creating custom dropdown:', error);
                // Fallback to showing the original select
                const leaveTypeSelect = document.getElementById('leaveTypeId');
                if (leaveTypeSelect) {
                    leaveTypeSelect.style.display = 'block';
                    leaveTypeSelect.innerHTML = '<option value="">Select Leave Type</option>' +
                        leaveTypes.map(type => `<option value="${type.id}">${type.name}</option>`).join('');
                }
            }
        }
        
        function selectLeaveType(value, text) {
            const originalSelect = document.getElementById('leaveTypeId');
            const customButton = document.querySelector('.custom-dropdown-button span');
            const dropdownOptions = document.querySelector('.custom-dropdown-options');
            
            // Update original select (for form submission)
            originalSelect.value = value;
            
            // Update button text
            customButton.textContent = text;
            
            // Close dropdown
            dropdownOptions.style.display = 'none';
            
            // Trigger change event for leave balance check
            if (value) {
                checkLeaveBalance();
            }
        }

        function updateLeaveTypesAvailability() {
            const leaveTypeSelect = document.getElementById('leaveTypeId');
            const staffNameField = document.getElementById('leaveStaffName');
            const databaseId = parseInt(staffNameField.getAttribute('data-staff-db-id'));
            
            if (!leaveTypeSelect || !databaseId) return;
            
            let optionsHTML = '<option value="">Select Leave Type</option>';
            
            leaveTypes.forEach(type => {
                let isDisabled = false;
                let displayName = type.name;
                
                const staff = getStaffByDatabaseId(databaseId);
                if (staff) {
                    let available = 0;
                    
                    switch(type.id) {
                        case 1: // Casual Leave
                            const casualBalance = getStaffLeaveBalanceComprehensive(databaseId);
                            if (casualBalance) {
                                available = casualBalance.casual.available;
                            }
                            break;
                        case 2: // Earned Leave
                            const earnedData = calculateEarnedLeaveBalance(databaseId);
                            available = earnedData ? earnedData.available : 0;
                            break;
                        case 3: // Half Pay Leave
                            const halfPayBalance = getStaffLeaveBalanceComprehensive(databaseId);
                            if (halfPayBalance) {
                                const cycleInfo = getHalfPayLeaveCycle();
                                const firstHalfUsed = halfPayBalance.halfpay.firstHalfUsed || 0;
                                const secondHalfUsed = halfPayBalance.halfpay.secondHalfUsed || 0;
                                const currentCycleUsed = cycleInfo.isFirstHalf ? firstHalfUsed : secondHalfUsed;
                                available = 10 - currentCycleUsed;
                            }
                            break;
                    }
                    
                    // Disable if no days available
                    if (available <= 0) {
                        isDisabled = true;
                        displayName = `${type.name} (No days available)`;
                    }
                }
                
                optionsHTML += `<option value="${type.id}" ${isDisabled ? 'disabled style="color: #ccc; background-color: #f8f9fa;"' : ''}>${displayName}</option>`;
            });
            
            leaveTypeSelect.innerHTML = optionsHTML;
        }

        function populateStaffName() {
            const userStaffId = document.getElementById('leaveStaffId').value.trim();
            const staffNameField = document.getElementById('leaveStaffName');
            
            if (!userStaffId) {
                staffNameField.value = '';
                document.getElementById('leaveBalanceInfo').style.display = 'none';
                return;
            }
            
            // Use standardized ID lookup function
            const staff = getStaffByUserStaffId(userStaffId);
            
            if (!staff) {
                staffNameField.value = 'Staff ID not found';
                staffNameField.style.color = '#dc3545';
                document.getElementById('leaveBalanceInfo').style.display = 'none';
                return;
            }
            
            staffNameField.value = staff.staffName;
            staffNameField.style.color = '#28a745';
            
            // Check if staff is male
            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
            if (!isMale) {
                staffNameField.value = `${staff.staffName} (Female - Leave not available)`;
                staffNameField.style.color = '#dc3545';
                document.getElementById('leaveBalanceInfo').style.display = 'none';
                return;
            }
            
            // Store the database ID for internal operations
            staffNameField.setAttribute('data-staff-db-id', staff.id);
            
            // Refresh leave types dropdown to update availability status
            updateLeaveTypesAvailability();
            
            // Reset leave balance info
            document.getElementById('leaveBalanceInfo').style.display = 'none';
            
            // Trigger leave balance check if leave type is already selected
            if (document.getElementById('leaveTypeId').value) {
                checkLeaveBalance();
            }
        }

        function openLeaveTypesModal() {
            renderLeaveTypesList();
            document.getElementById('modalOverlay').classList.add('show');
            document.getElementById('leaveTypesModal').classList.add('show');
        }

        function renderLeaveTypesList() {
            const container = document.getElementById('leaveTypesList');
            container.innerHTML = `
                <div class="system-leave-types">
                    <h4>System Leave Types (Cannot be modified)</h4>
                    ${leaveTypes.map(type => `
                        <div class="leave-type-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: #f8f9fa;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 30px; height: 30px; background-color: ${type.color}; border-radius: 50%;"></div>
                                <div>
                                    <h5 style="margin: 0; color: #333;">${type.name}</h5>
                                    <p style="margin: 0; color: #666; font-size: 14px;">${type.description}</p>
                                </div>
                            </div>
                            <div>
                                <span class="badge" style="background: ${type.color}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                                    ${type.type.toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="leave-type-info">
                    <h5>Leave Type Details:</h5>
                    <ul style="font-size: 14px; color: #666;">
                        <li><strong>Casual Leave:</strong> Based on service period (10/15/20 days)</li>
                        <li><strong>Earned Leave:</strong> 15 days on Jan 1st + 15 days on July 1st (max 300 carryover)</li>
                        <li><strong>Half Pay Leave:</strong> 15 days on Jan 1st + 10 days on July 1st</li>
                        <li><strong>Note:</strong> Currently only available for male staff members</li>
                    </ul>
                </div>
            `;
        }

        function addNewLeaveType() {
            document.getElementById('leaveTypeEditTitle').textContent = 'Add Leave Type';
            document.getElementById('leaveTypeEditForm').reset();
            document.getElementById('editLeaveTypeId').value = '';
            
            closeProfessionalModal('leaveTypesModal');
            setTimeout(() => {
                document.getElementById('leaveTypeEditModal').classList.add('show');
            }, 300);
        }

        function editLeaveType(id) {
            const leaveType = leaveTypes.find(t => t.id === id);
            if (!leaveType) return;
            
            document.getElementById('leaveTypeEditTitle').textContent = 'Edit Leave Type';
            document.getElementById('editLeaveTypeId').value = leaveType.id;
            document.getElementById('leaveTypeName').value = leaveType.name;
            document.getElementById('leaveTypeAllowedDays').value = leaveType.allowedDays;
            document.getElementById('leaveTypeColor').value = leaveType.color;
            
            closeProfessionalModal('leaveTypesModal');
            setTimeout(() => {
                document.getElementById('leaveTypeEditModal').classList.add('show');
            }, 300);
        }

        function deleteLeaveType(id) {
            const leaveType = leaveTypes.find(t => t.id === id);
            if (!leaveType) return;
            
            // Check if leave type is being used
            const isInUse = leaveApplications.some(app => app.leaveTypeId === id);
            if (isInUse) {
                alert(`Cannot delete "${leaveType.name}" because it has been used in leave applications.`);
                return;
            }
            
            showDeleteModal('Leave Type', leaveType.name, id, function(typeId) {
                leaveTypes = leaveTypes.filter(t => t.id !== typeId);
                saveLeaveTypesToStorage();
                renderLeaveTypesList();
            });
        }

        function saveLeaveType(event) {
            event.preventDefault();
            
            const id = document.getElementById('editLeaveTypeId').value;
            const name = document.getElementById('leaveTypeName').value;
            const allowedDays = parseInt(document.getElementById('leaveTypeAllowedDays').value);
            const color = document.getElementById('leaveTypeColor').value;
            
            if (id) {
                // Edit existing
                const leaveType = leaveTypes.find(t => t.id === parseInt(id));
                if (leaveType) {
                    leaveType.name = name;
                    leaveType.allowedDays = allowedDays;
                    leaveType.color = color;
                }
            } else {
                // Add new
                const newId = Math.max(...leaveTypes.map(t => t.id), 0) + 1;
                leaveTypes.push({ id: newId, name, allowedDays, color });
            }
            
            saveLeaveTypesToStorage();
            closeProfessionalModal('leaveTypeEditModal');
            
            setTimeout(() => {
                renderLeaveTypesList();
                document.getElementById('leaveTypesModal').classList.add('show');
            }, 300);
        }

        function saveLeaveTypes() {
            saveLeaveTypesToStorage();
            closeProfessionalModal('leaveTypesModal');
            showLeaveManagement(); // Refresh the leave management view
        }

        function saveLeaveTypesToStorage() {
            localStorage.setItem('leaveTypes', JSON.stringify(leaveTypes));
        }

        function initializeLeaveDateFields() {
            console.log('Initializing leave date fields with Flatpickr...');
            
            const leaveStartInput = document.getElementById('leaveStartDate');
            const leaveEndInput = document.getElementById('leaveEndDate');
            
            if (!leaveStartInput || !leaveEndInput) {
                console.error('Leave date fields not found');
                return;
            }
            
            // Initialize Flatpickr for start date field
            if (leaveStartInput) {
                // Destroy existing instances
                if (leaveStartInput._flatpickr) {
                    try {
                        leaveStartInput._flatpickr.destroy();
                    } catch (e) {
                        console.log('Error destroying existing Flatpickr instance:', e);
                    }
                }
                
                if (leaveStartInput._pikaday) {
                    try {
                        leaveStartInput._pikaday.destroy();
                        delete leaveStartInput._pikaday;
                    } catch (e) {
                        console.log('Error destroying existing Pikaday instance:', e);
                    }
                }
                
                try {
                    // Initialize Flatpickr for start date - no past dates allowed
                    const startDatePicker = flatpickr(leaveStartInput, {
                        dateFormat: "d/m/Y",
                        altInput: true,
                        altFormat: "j F Y",
                        allowInput: true,
                        disableMobile: true,
                        theme: "light",
                        animate: true,
                        clickOpens: true,
                        closeOnSelect: true,
                        enableTime: false,
                        monthSelectorType: "dropdown",
                        yearSelectorType: "dropdown",
                        showMonths: 1,
                        minDate: "today", // Prevent selecting past dates
                        maxDate: new Date().fp_incr(365), // Allow up to 1 year in future
                        onChange: function(selectedDates, dateStr, instance) {
                            console.log('Leave start date selected:', dateStr);
                            // Update end date min date
                            if (leaveEndInput._flatpickr && selectedDates.length > 0) {
                                leaveEndInput._flatpickr.set('minDate', selectedDates[0]);
                            }
                            // Trigger the leave days calculation
                            if (typeof calculateLeaveDays === 'function') {
                                calculateLeaveDays();
                            }
                        },
                        onOpen: function(selectedDates, dateStr, instance) {
                            // Position calendar below the input
                            const rect = instance._input.getBoundingClientRect();
                            const calendar = instance.calendarContainer;
                            
                            if (calendar) {
                                calendar.style.top = (rect.bottom + window.scrollY) + 'px';
                                calendar.style.left = rect.left + 'px';
                            }
                        }
                    });
                    
                    // Store the instance
                    leaveStartInput._flatpickr = startDatePicker;
                    
                    // Make sure the field is properly styled
                    leaveStartInput.classList.add('google-calendar-input');
                    leaveStartInput.style.cursor = 'pointer';
                    leaveStartInput.style.backgroundColor = '#ffffff';
                    
                    console.log('Flatpickr initialized successfully for start date');
                    
                } catch (error) {
                    console.error('Error initializing Flatpickr for start date:', error);
                }
            }
            
            // Initialize Flatpickr for end date field
            if (leaveEndInput) {
                // Destroy existing instances
                if (leaveEndInput._flatpickr) {
                    try {
                        leaveEndInput._flatpickr.destroy();
                    } catch (e) {
                        console.log('Error destroying existing Flatpickr instance:', e);
                    }
                }
                
                if (leaveEndInput._pikaday) {
                    try {
                        leaveEndInput._pikaday.destroy();
                        delete leaveEndInput._pikaday;
                    } catch (e) {
                        console.log('Error destroying existing Pikaday instance:', e);
                    }
                }
                
                try {
                    // Initialize Flatpickr for end date
                    const endDatePicker = flatpickr(leaveEndInput, {
                        dateFormat: "d/m/Y",
                        altInput: true,
                        altFormat: "j F Y",
                        allowInput: true,
                        disableMobile: true,
                        theme: "light",
                        animate: true,
                        clickOpens: true,
                        closeOnSelect: true,
                        enableTime: false,
                        monthSelectorType: "dropdown",
                        yearSelectorType: "dropdown",
                        showMonths: 1,
                        minDate: "today", // Also prevent past dates for end date
                        maxDate: new Date().fp_incr(365), // Allow up to 1 year in future
                        onChange: function(selectedDates, dateStr, instance) {
                            console.log('Leave end date selected:', dateStr);
                            // Trigger the leave days calculation
                            if (typeof calculateLeaveDays === 'function') {
                                calculateLeaveDays();
                            }
                        },
                        onOpen: function(selectedDates, dateStr, instance) {
                            // Position calendar below the input
                            const rect = instance._input.getBoundingClientRect();
                            const calendar = instance.calendarContainer;
                            
                            if (calendar) {
                                calendar.style.top = (rect.bottom + window.scrollY) + 'px';
                                calendar.style.left = rect.left + 'px';
                            }
                        }
                    });
                    
                    // Store the instance
                    leaveEndInput._flatpickr = endDatePicker;
                    
                    // Make sure the field is properly styled
                    leaveEndInput.classList.add('google-calendar-input');
                    leaveEndInput.style.cursor = 'pointer';
                    leaveEndInput.style.backgroundColor = '#ffffff';
                    
                    console.log('Flatpickr initialized successfully for end date');
                    
                } catch (error) {
                    console.error('Error initializing Flatpickr for end date:', error);
                }
            }
            
            console.log('Leave date fields initialized with Flatpickr');
        }

        function calculateLeaveDays() {
            try {
                const startDateField = document.getElementById('leaveStartDate');
                const endDateField = document.getElementById('leaveEndDate');
                const leaveDaysField = document.getElementById('leaveDays');
                
                if (!startDateField || !endDateField || !leaveDaysField) {
                    console.log('Leave date fields not found');
                    return;
                }
                
                const startDate = startDateField.value;
                const endDate = endDateField.value;
                
                console.log('Calculating leave days:', { startDate, endDate });
                
                if (startDate && endDate) {
                    const start = parseDDMMYYYY(startDate);
                    const end = parseDDMMYYYY(endDate);
                    
                    if (!start || !end) {
                        console.log('Invalid date format');
                        leaveDaysField.value = '';
                        return;
                    }
                    
                    if (end < start) {
                        console.log('End date is before start date');
                        leaveDaysField.value = '';
                        return;
                    }
                    
                    const diffTime = Math.abs(end - start);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                    
                    console.log('Calculated days:', diffDays);
                    leaveDaysField.value = diffDays;
                    
                    // Trigger leave balance check
                    checkLeaveBalance();
                } else {
                    leaveDaysField.value = '';
                    console.log('One or both dates are empty');
                }
            } catch (error) {
                console.error('Error calculating leave days:', error);
            }
        }

        function updateFakeDate() {
            const newDate = parseDDMMYYYY(document.getElementById('fakeDate').value);
            if (!newDate) return;
            fakeSystemTime.currentDate = newDate;
            fakeSystemTime.currentYear = newDate.getFullYear();
            fakeSystemTime.isFirstHalf = newDate.getMonth() < 6;
            
            // Update the system info display
            updateFakeTimeDisplay();
            
            // Refresh the attendance view
            showLeaveManagement();
        }
        
        function openFakeDateCalendar() {
            // Trigger click on the input to open Pikaday calendar if it's initialized
            const input = document.getElementById('fakeDate');
            if (input && input._pikaday) {
                input._pikaday.show();
            } else {
                // Initialize Pikaday for this field if not already done
                initializeFakeDatePicker();
            }
        }
        
        function initializeFakeDatePicker() {
            const input = document.getElementById('fakeDate');
            if (!input || input._pikaday) return;
            
            try {
                const pikaday = new Pikaday({
                    field: input,
                    format: 'DD/MM/YYYY',
                    yearRange: [2020, 2030],
                    showWeekNumber: false,
                    showMonthAfterYear: false,
                    showDaysInNextAndPreviousMonths: true,
                    enableSelectionDaysInNextAndPreviousMonths: true,
                    onSelect: function(date) {
                        const formattedDate = formatDateToDDMMYYYY(date);
                        input.value = formattedDate;
                        updateFakeDate();
                    }
                });
                input._pikaday = pikaday;
            } catch (error) {
                console.error('Error initializing fake date picker:', error);
                // Fallback: make field editable
                input.readOnly = false;
                input.style.cursor = 'text';
            }
        }
        
        // Initialize Flatpickr for Date of Birth field with Google Calendar style
        function initializeDateOfBirthFlatpickr() {
            const dobField = document.getElementById('dateOfBirth');
            if (!dobField) {
                console.error('Date of Birth field not found');
                return;
            }
            
            // Destroy existing Pikaday instance if any
            if (dobField._pikaday) {
                try {
                    dobField._pikaday.destroy();
                    delete dobField._pikaday;
                } catch (e) {
                    console.log('Error destroying existing Pikaday instance:', e);
                }
            }
            
            // Destroy existing Flatpickr instance if any
            if (dobField._flatpickr) {
                try {
                    dobField._flatpickr.destroy();
                } catch (e) {
                    console.log('Error destroying existing Flatpickr instance:', e);
                }
            }
            
            // Remove old event handlers and attributes
            dobField.removeAttribute('onclick');
            dobField.removeAttribute('onchange');
            dobField.removeAttribute('oninput');
            
            try {
                // Initialize Flatpickr with Google Calendar styling
                const flatpickrInstance = flatpickr(dobField, {
                    dateFormat: "d-m-Y",
                    maxDate: "today",
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    monthSelectorType: "dropdown",
                    yearSelectorType: "dropdown",
                    appendTo: document.body,
                    positionElement: dobField,
                    onChange: function(selectedDates, dateStr, instance) {
                        // Close the date picker automatically after selection
                        setTimeout(() => {
                            instance.close();
                        }, 100);
                        // Calculate age directly from selectedDates
                        if (selectedDates.length > 0) {
                            const dob = selectedDates[0];
                            const today = new Date();
                            let age = today.getFullYear() - dob.getFullYear();
                            const monthDiff = today.getMonth() - dob.getMonth();
                            
                            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                                age--;
                            }
                            
                            // Try to find and update age field
                            let ageField = document.getElementById('age');
                            if (ageField) {
                                const ageValue = age >= 0 ? age.toString() : '';
                                
                                // Create a completely new input element
                                const newAgeField = document.createElement('input');
                                newAgeField.type = 'text';
                                newAgeField.id = 'age';
                                newAgeField.value = ageValue;
                                newAgeField.readOnly = true;
                                newAgeField.placeholder = 'Auto-calculated';
                                newAgeField.style.background = '#f8f9fa';
                                newAgeField.style.color = '#000';
                                newAgeField.style.fontWeight = 'bold';
                                newAgeField.style.padding = '12px';
                                newAgeField.style.border = '1px solid #ddd';
                                newAgeField.style.borderRadius = '8px';
                                newAgeField.style.height = '45px';
                                
                                // Replace the old field with the new one
                                ageField.parentNode.replaceChild(newAgeField, ageField);
                                
                                console.log('New age field created with value:', newAgeField.value);
                            }
                            
                            // Auto-calculate retirement date (60 years from DOB, last date of that month)
                            const retirementDate = new Date(dob);
                            retirementDate.setFullYear(retirementDate.getFullYear() + 60);
                            // Set to last date of that month
                            retirementDate.setMonth(retirementDate.getMonth() + 1, 0);
                            
                            // Try to find and update retirement date field (same approach as age field)
                            let retirementField = document.getElementById('retirementDate');
                            if (retirementField && !window.isPopulatingEditForm) {
                                const formattedRetirementDate = formatDateToDDMMYYYY(retirementDate);
                                
                                // Create a completely new input element (same approach as age field)
                                const newRetirementField = document.createElement('input');
                                newRetirementField.type = 'text';
                                newRetirementField.id = 'retirementDate';
                                newRetirementField.readOnly = true;
                                newRetirementField.title = 'Auto-calculated from date of birth';
                                newRetirementField.style.background = '#f8f9fa';
                                newRetirementField.style.color = '#000';
                                newRetirementField.style.fontWeight = 'bold';
                                newRetirementField.style.fontSize = '16px';
                                newRetirementField.style.padding = '12px';
                                newRetirementField.style.border = '1px solid #ddd';
                                newRetirementField.style.borderRadius = '8px';
                                newRetirementField.style.height = '45px';
                                newRetirementField.style.width = '100%';
                                newRetirementField.style.display = 'block';
                                newRetirementField.required = true;
                                
                                // Replace the old field with the new one (same as age field)
                                retirementField.parentNode.replaceChild(newRetirementField, retirementField);
                                
                                // Set the value AFTER adding to DOM and force display
                                setTimeout(() => {
                                    newRetirementField.value = formattedRetirementDate;
                                    newRetirementField.setAttribute('value', formattedRetirementDate);
                                    newRetirementField.defaultValue = formattedRetirementDate;
                                    
                                    // Remove placeholder to show actual value
                                    newRetirementField.removeAttribute('placeholder');
                                    
                                    // Force a visual refresh
                                    newRetirementField.style.display = 'none';
                                    newRetirementField.offsetHeight; // Force reflow
                                    newRetirementField.style.display = 'block';
                                }, 10);
                                
                                console.log('New retirement field created with value:', newRetirementField.value);
                            }
                        }
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        // Add custom class for styling
                        instance.calendarContainer.classList.add('google-calendar-style');
                    }
                });
                
                // Store the instance
                dobField._flatpickr = flatpickrInstance;
                
                // Make sure the field is properly styled
                dobField.classList.add('google-calendar-input');
                
                console.log('Flatpickr initialized successfully for Date of Birth field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for Date of Birth:', error);
            }
        }
        
        // Initialize Flatpickr for Date of Appointment field
        function initializeDateOfAppointmentFlatpickr() {
            const field = document.getElementById('dateOfAppointment');
            if (!field) {
                console.error('Date of Appointment field not found');
                return;
            }
            
            try {
                const flatpickrInstance = flatpickr(field, {
                    dateFormat: "d-m-Y",
                    maxDate: "today",
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    monthSelectorType: "dropdown",
                    yearSelectorType: "dropdown",
                    appendTo: document.body,
                    positionElement: field,
                    onChange: function(selectedDates, dateStr, instance) {
                        // Close the date picker automatically after selection
                        setTimeout(() => {
                            instance.close();
                        }, 100);
                        
                        // Validate appointment date against birth date (18-year rule)
                        const dobField = document.getElementById('dateOfBirth');
                        if (dobField && dobField.value) {
                            console.log('DOB field value:', dobField.value);
                            
                            // Parse birth date
                            let birthDate;
                            if (dobField.value.includes('-')) {
                                const parts = dobField.value.split('-');
                                birthDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])); // DD-MM-YYYY
                            } else {
                                birthDate = new Date(dobField.value);
                            }
                            
                            // Parse appointment date
                            let appointmentDate;
                            if (dateStr.includes('-')) {
                                const parts = dateStr.split('-');
                                if (parts.length === 3) {
                                    if (parts[0].length === 4) {
                                        // YYYY-MM-DD format
                                        appointmentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                    } else {
                                        // DD-MM-YYYY format
                                        appointmentDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    }
                                }
                            } else {
                                appointmentDate = new Date(dateStr);
                            }
                            
                            // Check if person is at least 18 years old at appointment
                            const minAppointmentDate = new Date(birthDate);
                            minAppointmentDate.setFullYear(minAppointmentDate.getFullYear() + 18);
                            
                            console.log('Birth date:', birthDate);
                            console.log('Appointment date:', appointmentDate);
                            console.log('Min appointment date (18 years after birth):', minAppointmentDate);
                            console.log('Is appointment valid (18+ years)?', appointmentDate >= minAppointmentDate);
                            
                            if (appointmentDate < minAppointmentDate) {
                                console.log('Date of appointment validation failed in Flatpickr');
                                
                                // Clear the field first to prevent further processing
                                field.value = '';
                                field.dataset.previousValue = '';
                                
                                // Show red error message after a small delay to ensure DOM is updated
                                setTimeout(function() {
                                    const errorElement = document.getElementById('dateOfAppointmentError');
                                    if (errorElement) {
                                        errorElement.style.display = 'block';
                                        errorElement.textContent = 'Invalid date';
                                        console.log('Error message displayed');
                                        
                                        // Hide the error after 5 seconds
                                        setTimeout(function() {
                                            errorElement.style.display = 'none';
                                        }, 5000);
                                    }
                                }, 50);
                                
                                return;
                            }
                        }
                        
                        // Store current valid value as previous value for future use
                        field.dataset.previousValue = dateStr;
                        
                        // Update Date of Next Increment minimum date and validate
                        const nextIncrementField = document.getElementById('dateOfNextIncrement');
                        if (nextIncrementField && nextIncrementField._flatpickr) {
                            console.log('Appointment dateStr from Flatpickr:', dateStr);
                            
                            // Parse appointment date correctly
                            let appointmentDate;
                            if (dateStr.includes('-')) {
                                const parts = dateStr.split('-');
                                if (parts.length === 3) {
                                    if (parts[0].length === 4) {
                                        // YYYY-MM-DD format
                                        appointmentDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                                    } else {
                                        // DD-MM-YYYY format
                                        appointmentDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                                    }
                                }
                            } else {
                                appointmentDate = new Date(dateStr);
                            }
                            
                            const oneYearAfter = new Date(appointmentDate);
                            oneYearAfter.setFullYear(oneYearAfter.getFullYear() + 1); // Set minimum to 1 year after appointment
                            
                            console.log('Parsed appointment date:', appointmentDate);
                            console.log('One year after:', oneYearAfter);
                            
                            // Update the minimum date for Date of Next Increment picker
                            nextIncrementField._flatpickr.set('minDate', oneYearAfter);
                            
                            // Check if current increment date is now invalid
                            if (nextIncrementField.value) {
                                let incrementDate;
                                if (nextIncrementField.value.includes('-')) {
                                    const parts = nextIncrementField.value.split('-');
                                    incrementDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0])); // DD-MM-YYYY
                                } else {
                                    incrementDate = new Date(nextIncrementField.value);
                                }
                                
                                console.log('Current increment date:', incrementDate);
                                console.log('Is current increment valid?', incrementDate >= oneYearAfter);
                                
                                if (incrementDate < oneYearAfter) {
                                    const minDateStr = formatDateToDD_MM_YYYY(oneYearAfter);
                                    // Show red error message for Date of Next Increment
                                    const errorElement = document.getElementById('dateOfNextIncrementError');
                                    if (errorElement) {
                                        errorElement.style.display = 'block';
                                        errorElement.textContent = 'Invalid date';
                                        console.log('Next increment error message displayed from appointment change');
                                        
                                        // Hide the error after 5 seconds
                                        setTimeout(function() {
                                            errorElement.style.display = 'none';
                                        }, 5000);
                                    }
                                    // Clear the field without using setDate to avoid recursion
                                    nextIncrementField.value = '';
                                    nextIncrementField.dataset.previousValue = '';
                                }
                            }
                        }
                    },
                    onClose: function(selectedDates, dateStr, instance) {
                        // Store valid value when calendar closes normally (not through validation)
                        if (dateStr && !instance.validation_clearing) {
                            field.dataset.previousValue = dateStr;
                        }
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        instance.calendarContainer.classList.add('google-calendar-style');
                        // Store initial value if field has one
                        if (field.value) {
                            field.dataset.previousValue = field.value;
                        }
                    }
                });
                
                field._flatpickr = flatpickrInstance;
                console.log('Flatpickr initialized successfully for Date of Appointment field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for Date of Appointment:', error);
            }
        }
        
        // Initialize Flatpickr for Date of Next Increment field
        function initializeDateOfNextIncrementFlatpickr() {
            const field = document.getElementById('dateOfNextIncrement');
            if (!field) {
                console.error('Date of Next Increment field not found');
                return;
            }
            
            try {
                // Clear any existing Flatpickr instance
                if (field._flatpickr) {
                    field._flatpickr.destroy();
                }
                
                const flatpickrInstance = flatpickr(field, {
                    dateFormat: "d-m-Y",
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    monthSelectorType: "dropdown",
                    yearSelectorType: "dropdown",
                    appendTo: document.body,
                    positionElement: field,
                    onChange: function(selectedDates, dateStr, instance) {
                        console.log('Flatpickr selected date:', selectedDates[0]);
                        console.log('Formatted dateStr:', dateStr);
                        
                        // Close the date picker automatically after selection
                        setTimeout(() => {
                            instance.close();
                        }, 100);
                        
                        // Validate that Date of Next Increment is at least 1 year after Date of Appointment
                        const appointmentField = document.getElementById('dateOfAppointment');
                        if (appointmentField && appointmentField.value) {
                            console.log('Appointment field value:', appointmentField.value);
                            
                            // Parse appointment date (DD-MM-YYYY format)
                            const appointmentDate = parseDDMMYYYY(appointmentField.value);
                            // Use the selected date from Flatpickr
                            const incrementDate = selectedDates[0];
                            
                            console.log('Parsed appointment date:', appointmentDate);
                            console.log('Selected increment date:', incrementDate);
                            
                            if (appointmentDate && incrementDate) {
                                // Calculate one year after appointment (same day next year)
                                const oneYearAfterAppointment = new Date(appointmentDate);
                                oneYearAfterAppointment.setFullYear(oneYearAfterAppointment.getFullYear() + 1);
                                
                                console.log('One year after appointment:', oneYearAfterAppointment);
                                console.log('Is increment date valid?', incrementDate >= oneYearAfterAppointment);
                                
                                if (incrementDate < oneYearAfterAppointment) {
                                    console.log('Date of next increment validation failed');
                                    
                                    // Clear the field
                                    field.value = '';
                                    
                                    // Show red error message after a small delay
                                    setTimeout(function() {
                                        const errorElement = document.getElementById('dateOfNextIncrementError');
                                        if (errorElement) {
                                            errorElement.style.display = 'block';
                                            errorElement.textContent = 'Invalid date';
                                            console.log('Next increment error message displayed');
                                            
                                            // Hide the error after 5 seconds
                                            setTimeout(function() {
                                                errorElement.style.display = 'none';
                                            }, 5000);
                                        }
                                    }, 50);
                                    
                                    return;
                                }
                            }
                        }
                    }
                });
                
                // Store the instance for later use
                field._flatpickr = flatpickrInstance;
                
                console.log('Flatpickr initialized successfully for Date of Next Increment field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for Date of Next Increment:', error);
            }
        }
        
        function updateFakeTimeDisplay() {
            // Update the system info display in the testing controls
            const systemInfo = document.querySelector('.system-info');
            if (systemInfo) {
                systemInfo.innerHTML = `
                    <span>Current Year: ${fakeSystemTime.currentYear}</span>
                    <span>Period: ${fakeSystemTime.isFirstHalf ? 'First Half (Jan-Jun)' : 'Second Half (Jul-Dec)'}</span>
                `;
            }
            
            // Update the current date display
            const currentDateDisplay = document.getElementById('currentDateDisplay');
            if (currentDateDisplay) {
                currentDateDisplay.textContent = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            }
        }
        
        // Function to refresh the current view without switching tabs
        function refreshCurrentView() {
            // Get the currently active nav item
            const activeNavItem = document.querySelector('.nav-item.active');
            if (!activeNavItem) {
                console.log('No active tab found, skipping refresh');
                return;
            }
            
            // Get the onclick attribute to determine current section
            const onclickAttr = activeNavItem.getAttribute('onclick');
            if (onclickAttr) {
                const sectionMatch = onclickAttr.match(/showSection\('([^']+)'\)/);
                if (sectionMatch) {
                    const currentSection = sectionMatch[1];
                    console.log(`Refreshing current section: ${currentSection}`);
                    
                    // Refresh based on current section
                    switch(currentSection) {
                        case 'attendance':
                            if (typeof showAttendanceNew === 'function') {
                                showAttendanceNew();
                            }
                            break;
                        case 'leave':
                            if (typeof showLeaveManagement === 'function') {
                                showLeaveManagement();
                            }
                            break;
                        case 'payslip':
                            if (typeof showPaySlip === 'function') {
                                showPaySlip();
                            }
                            break;
                        case 'ps-verification':
                            if (typeof showPSVerification === 'function') {
                                showPSVerification();
                            }
                            break;
                        case 'deduction-balance':
                            if (typeof showDeductionBalance === 'function') {
                                showDeductionBalance();
                            }
                            break;
                        default:
                            console.log(`No refresh handler for section: ${currentSection}`);
                    }
                } else {
                    console.log('Could not determine current section from onclick attribute');
                }
            } else {
                console.log('Active nav item has no onclick attribute');
            }
        }

        // Apply the selected test date
        function applyTestDate() {
            const day = parseInt(document.getElementById('testDay').value);
            const month = parseInt(document.getElementById('testMonth').value);
            const year = parseInt(document.getElementById('testYear').value);
            
            // Validate the date
            const selectedDate = new Date(year, month, day);
            
            // Check if the date is valid (handles cases like Feb 31st)
            if (selectedDate.getDate() !== day || selectedDate.getMonth() !== month || selectedDate.getFullYear() !== year) {
                alert('Invalid date selected. Please choose a valid date.');
                return;
            }
            
            // Update fake system time
            fakeSystemTime.currentDate = selectedDate;
            fakeSystemTime.currentYear = year;
            fakeSystemTime.isFirstHalf = month < 6; // January to June = first half
            
            // Update displays
            updateFakeTimeDisplay();
            
            // Update the fake date input if it exists
            const fakeDateInput = document.getElementById('fakeDate');
            if (fakeDateInput) {
                fakeDateInput.value = formatDateToDDMMYYYY(selectedDate);
                updateFakeDate();
            }
            
            // Refresh current view without switching tabs
            refreshCurrentView();
            
            console.log(`‚úÖ Test date applied: ${formatDateToDDMMYYYY(selectedDate)}`);
            console.log(`Year: ${year}, First Half: ${month < 6 ? 'Yes' : 'No'}`);
        }
        
        // Reset to today's actual date
        function resetToTodayDate() {
            const today = new Date();
            
            // Reset fake system time to actual current date
            fakeSystemTime.currentDate = today;
            fakeSystemTime.currentYear = today.getFullYear();
            fakeSystemTime.isFirstHalf = today.getMonth() < 6;
            
            // Update the dropdown selectors
            document.getElementById('testDay').value = today.getDate();
            document.getElementById('testMonth').value = today.getMonth();
            document.getElementById('testYear').value = today.getFullYear();
            
            // Update displays
            updateFakeTimeDisplay();
            
            // Update the fake date input if it exists
            const fakeDateInput = document.getElementById('fakeDate');
            if (fakeDateInput) {
                fakeDateInput.value = formatDateToDDMMYYYY(today);
                updateFakeDate();
            }
            
            // Refresh current view without switching tabs
            refreshCurrentView();
            
            console.log(`‚úÖ Reset to today: ${formatDateToDDMMYYYY(today)}`);
        }

        function resetAllTestingData() {
            // Show confirmation dialog
            if (!confirm('‚ö†Ô∏è This will permanently delete all leave applications, carryover data, and reset to a fresh testing state. Are you sure?')) {
                return;
            }
            
            // Clear all leave-related localStorage data
            localStorage.removeItem('leaveApplications');
            localStorage.removeItem('leaveCarryover');
            localStorage.removeItem('leaveTypes');
            localStorage.removeItem('cantonment_staff_leave_balances'); // Clear new leave balance system
            
            // Reset global arrays and objects
            leaveApplications.length = 0;
            if (typeof leaveTypes !== 'undefined') {
                leaveTypes.length = 0;
                leaveTypes.push(...defaultLeaveTypes); // Restore default leave types
            }
            if (typeof staffLeaveBalances !== 'undefined') {
                staffLeaveBalances = {}; // Clear leave balances
            }
            
            // Save the reset state to localStorage
            saveLeaveApplicationsToStorage();
            localStorage.setItem('leaveTypes', JSON.stringify(defaultLeaveTypes));
            saveLeaveBalancesToStorage();
            
            // Refresh leave types in memory
            leaveTypes = [...defaultLeaveTypes];
            
            // Reset fake time to current date
            fakeSystemTime.currentDate = new Date();
            fakeSystemTime.currentYear = fakeSystemTime.currentDate.getFullYear();
            fakeSystemTime.isFirstHalf = fakeSystemTime.currentDate.getMonth() < 6;
            
            // Refresh the attendance view
            showLeaveManagement();
            
            // Re-initialize date picker with new date
            setTimeout(() => {
                const fakeDateInput = document.getElementById('fakeDate');
                if (fakeDateInput) {
                    fakeDateInput.value = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                    updateFakeTimeDisplay();
                    // Ensure the date picker is properly initialized
                    initializeFakeDatePicker();
                }
            }, 100);
            
            // Show success message
            setTimeout(() => {
                alert('‚úÖ All testing data has been reset successfully!\n\n‚Ä¢ Leave applications: Cleared\n‚Ä¢ Carryover data: Cleared\n‚Ä¢ System date: Reset to current\n‚Ä¢ Leave balances: Reset to defaults\n‚Ä¢ Leave types: Restored to defaults');
            }, 200);
        }

        function updateFileLabel() {
            const fileInput = document.getElementById('leaveDocument');
            const fileLabel = document.getElementById('fileLabel');
            const fileLabelElement = document.querySelector('.file-upload-label');
            const fileInfo = document.getElementById('fileInfo');
            
            if (fileInput.files && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const fileName = file.name;
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // Convert to MB
                
                // Check file size (5MB limit)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    fileInput.value = '';
                    fileLabel.textContent = 'Choose file or drag here';
                    fileLabelElement.classList.remove('has-file');
                    fileInfo.style.display = 'none';
                    return;
                }
                
                fileLabel.innerHTML = `<span style="color: #059669;">üìé ${fileName}</span> <small>(${fileSize} MB)</small>`;
                fileLabelElement.classList.add('has-file');
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `<small style="color: #059669;">‚úì File attached successfully</small>`;
            } else {
                fileLabel.textContent = 'Choose file or drag here';
                fileLabelElement.classList.remove('has-file');
                fileInfo.style.display = 'none';
            }
        }

        function checkLeaveBalance() {
            const staffNameField = document.getElementById('leaveStaffName');
            const databaseId = parseInt(staffNameField.getAttribute('data-staff-db-id'));
            const leaveTypeId = parseInt(document.getElementById('leaveTypeId').value);
            const days = parseInt(document.getElementById('leaveDays').value) || 0;
            
            console.log('checkLeaveBalance called with:', {
                databaseId: databaseId,
                leaveTypeId: leaveTypeId,
                days: days,
                staffNameFieldValue: staffNameField.value
            });
            
            if (!databaseId || !leaveTypeId) {
                document.getElementById('leaveBalanceInfo').style.display = 'none';
                document.getElementById('submitLeaveBtn').disabled = false;
                return;
            }
            
            // Use standardized ID lookup function
            const staff = getStaffByDatabaseId(databaseId);
            if (!staff) return;
            
            // Check if staff is male
            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
            if (!isMale) {
                document.getElementById('leaveBalanceInfo').style.display = 'block';
                document.getElementById('balanceDetails').innerHTML = '<p style="color: #dc3545;">‚ùå Female staff leave rules not implemented yet</p>';
                document.getElementById('validationMessage').innerHTML = '<p style="color: #dc3545;">Cannot apply for leave</p>';
                document.getElementById('submitLeaveBtn').disabled = true;
                return;
            }
            
            // Use new leave balance tracking system
            const leaveBalance = getStaffLeaveBalanceComprehensive(databaseId);
            console.log('Leave balance for staff ID', databaseId, ':', leaveBalance);
            
            if (!leaveBalance) {
                console.log('No leave balance found for staff ID:', databaseId);
                document.getElementById('leaveBalanceInfo').style.display = 'block';
                document.getElementById('balanceDetails').innerHTML = '<p style="color: #dc3545;">‚ùå Unable to load leave balance</p>';
                document.getElementById('validationMessage').innerHTML = '<p style="color: #dc3545;">Cannot apply for leave</p>';
                document.getElementById('submitLeaveBtn').disabled = true;
                return;
            }
            
            let balanceInfo = '';
            let validationMessage = '';
            let canSubmit = true;
            
            // Get specific leave type balance
            let currentLeaveType, availableDays, usedDays, entitledDays;
            
            console.log('Processing leave type:', leaveTypeId);
            
            switch(leaveTypeId) {
                case 1: // Casual Leave
                    currentLeaveType = leaveBalance.casual;
                    availableDays = currentLeaveType.available;
                    usedDays = currentLeaveType.used;
                    entitledDays = currentLeaveType.entitled;
                    console.log('Casual Leave - Available:', availableDays, 'Used:', usedDays, 'Entitled:', entitledDays);
                    const serviceYears = leaveBalance.serviceYears || 0;
                    
                    // Determine service category
                    let serviceCategory;
                    if (serviceYears <= 10) {
                        serviceCategory = `0-10 years service (${serviceYears} years)`;
                    } else if (serviceYears <= 20) {
                        serviceCategory = `10-20 years service (${serviceYears} years)`;
                    } else {
                        serviceCategory = `>20 years service (${serviceYears} years)`;
                    }
                    
                    balanceInfo = `
                        <div class="balance-item">
                            <strong>üèñÔ∏è Casual Leave Balance (Service-Based):</strong>
                            <div class="balance-breakdown">
                                <p>üîπ Service Period: <strong>${serviceCategory}</strong></p>
                                <p>üîπ Annual Entitlement: ${entitledDays} days</p>
                                <p>üîπ Already Used: ${usedDays} days</p>
                                <p>üîπ Available: <span style="color: ${availableDays > 0 ? '#28a745' : '#dc3545'}">${availableDays} days</span></p>
                                <p style="color: #6c757d;">üìù Note: No carryover to next year</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 2: // Earned Leave
                    // Use the same calculation as Leave Management tab for consistency
                    const earnedLeaveData = calculateEarnedLeaveBalance(databaseId);
                    currentLeaveType = leaveBalance.earned;
                    availableDays = earnedLeaveData.available;
                    usedDays = earnedLeaveData.used;
                    console.log('Earned Leave - Available:', availableDays, 'Used:', usedDays, 'Full earned data:', earnedLeaveData);
                    const earnedCycleInfo = getEarnedLeaveCycle();
                    
                    // Format dates for display
                    const formatDate = (date) => {
                        return date.toLocaleDateString('en-IN', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                    };
                    
                    // Calculate if allocation was capped due to 300-day limit
                    const currentYearAllocations = currentLeaveType.janAllocation + currentLeaveType.julyAllocation;
                    const totalPossible = currentLeaveType.carryoverFromPrevYear + currentYearAllocations;
                    const wasCapped = totalPossible > currentLeaveType.maxAccumulation;
                    
                    let allocationStatus = '';
                    if (earnedCycleInfo.isFirstHalf) {
                        // Jan-Jun period: Show that July allocation is pending
                        allocationStatus = `
                            <p>üîπ Jan 1st Allocation: <span style="color: #28a745;">‚úÖ ${currentLeaveType.janAllocation} days (credited)</span></p>
                            <p>üîπ July 1st Allocation: <span style="color: #6c757d;">‚è≥ ${currentLeaveType.julyAllocation} days (pending ${formatDate(earnedCycleInfo.nextCycleStart)})</span></p>
                        `;
                    } else {
                        // Jul-Dec period: Both allocations credited
                        allocationStatus = `
                            <p>üîπ Jan 1st Allocation: <span style="color: #28a745;">‚úÖ ${currentLeaveType.janAllocation} days (credited)</span></p>
                            <p>üîπ July 1st Allocation: <span style="color: #28a745;">‚úÖ ${currentLeaveType.julyAllocation} days (credited)</span></p>
                        `;
                    }
                    
                    balanceInfo = `
                        <div class="balance-item">
                            <strong>üìÖ Earned Leave Balance (Bi-Annual with Year-End Carryover):</strong>
                            <div class="balance-breakdown">
                                <p>üîπ Carryover from Previous Year: ${currentLeaveType.carryoverFromPrevYear} days</p>
                                ${allocationStatus}
                                <p>üîπ Total Accumulated: ${currentLeaveType.totalAccumulated} days</p>
                                <p>üîπ Used This Year: ${usedDays} days</p>
                                <p>üîπ Available for Use: <span style="color: ${availableDays > 0 ? '#28a745' : '#dc3545'}">${availableDays} days</span></p>
                                ${wasCapped ? 
                                    `<p style="color: #f0ad4e;">‚ö†Ô∏è Allocation capped at 300-day limit (${totalPossible - currentLeaveType.maxAccumulation} days not credited)</p>` : ''}
                                <hr style="margin: 8px 0; border: 1px solid #eee;">
                                <p>üìä <strong>Year-End Carryover:</strong></p>
                                <p>üîπ Will carry forward: ${availableDays} days to next year</p>
                                <p>üîπ Maximum Accumulation: ${currentLeaveType.maxAccumulation} days</p>
                                <p style="color: #6c757d;">üìù Note: Unused leaves carry to next year, max 300 days total</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 3: // Half Pay Leave
                    currentLeaveType = leaveBalance.halfpay;
                    const firstHalfUsed = currentLeaveType.firstHalfUsed || 0;
                    const secondHalfUsed = currentLeaveType.secondHalfUsed || 0;
                    const cycleInfo = getHalfPayLeaveCycle();
                    
                    // Current cycle availability
                    const currentCycleUsed = cycleInfo.isFirstHalf ? firstHalfUsed : secondHalfUsed;
                    const currentCycleAvailable = cycleInfo.entitlement - currentCycleUsed;
                    
                    // Format dates for display
                    const formatDateHalfPay = (date) => {
                        return date.toLocaleDateString('en-IN', { 
                            day: 'numeric', 
                            month: 'short',
                            year: 'numeric'
                        });
                    };
                    
                    balanceInfo = `
                        <div class="balance-item">
                            <strong>üí∞ Half Pay Leave Balance (6-Month Cycles):</strong>
                            <div class="balance-breakdown">
                                <p>üîπ Current Cycle: <strong>${cycleInfo.period}</strong> (${cycleInfo.periodName})</p>
                                <p>üîπ Cycle Period: ${formatDateHalfPay(cycleInfo.startDate)} to ${formatDateHalfPay(cycleInfo.endDate)}</p>
                                <p>üîπ Current Cycle Entitlement: ${cycleInfo.entitlement} days</p>
                                <p>üîπ Current Cycle Used: ${currentCycleUsed} days</p>
                                <p>üîπ Current Cycle Available: <span style="color: ${currentCycleAvailable > 0 ? '#28a745' : '#dc3545'}">${currentCycleAvailable} days</span></p>
                                <p>üîπ Next Cycle Starts: ${formatDateHalfPay(cycleInfo.nextCycleStart)}</p>
                                <hr style="margin: 8px 0; border: 1px solid #eee;">
                                <p>üìä <strong>Year Summary:</strong></p>
                                <p>üîπ Jan-Jun Cycle Used: ${firstHalfUsed} / 10 days</p>
                                <p>üîπ Jul-Dec Cycle Used: ${secondHalfUsed} / 10 days</p>
                                <p style="color: #f0ad4e;">‚ö†Ô∏è Note: Half pay deducted & no carryover between cycles</p>
                            </div>
                        </div>
                    `;
                    // Use current cycle available for validation
                    availableDays = currentCycleAvailable;
                    break;
                    
                default:
                    balanceInfo = `<p style="color: #dc3545;">‚ùå Unknown leave type</p>`;
                    canSubmit = false;
            }
            
            // Validate requested days
            if (days > 0) {
                if (days > availableDays) {
                    validationMessage = `<p style="color: #dc3545;">‚ö†Ô∏è You are requesting ${days} days but only ${availableDays} days are available. Extra ${days - availableDays} days will be deducted from salary.</p>`;
                    // Still allow submission but with warning
                    canSubmit = true;
                } else {
                    validationMessage = `<p style="color: #28a745;">‚úÖ Request for ${days} days is within your available balance.</p>`;
                }
            }
            
            // Update UI
            console.log('Generated balance info HTML:', balanceInfo);
            console.log('Can submit:', canSubmit);
            
            document.getElementById('balanceDetails').innerHTML = balanceInfo;
            document.getElementById('validationMessage').innerHTML = validationMessage;
            document.getElementById('leaveBalanceInfo').style.display = 'block';
            document.getElementById('submitLeaveBtn').disabled = !canSubmit;
        }

        function viewStaffAttendance(staffId) {
            // Detailed staff attendance view
            alert(`Viewing attendance details for staff ID: ${staffId}`);
        }

        function submitLeaveApplication(event) {
            event.preventDefault();
            
            const staffNameField = document.getElementById('leaveStaffName');
            const staffId = parseInt(staffNameField.getAttribute('data-staff-db-id'));
            const leaveTypeId = parseInt(document.getElementById('leaveTypeId').value);
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const days = parseInt(document.getElementById('leaveDays').value);
            const reason = document.getElementById('leaveReason').value;
            const documentFile = document.getElementById('leaveDocument').files[0];
            
            // Validation
            if (!staffId || !leaveTypeId || !startDate || !endDate || !days || !reason.trim()) {
                alert('Please fill in all required fields');
                return;
            }
            
            const staff = admissions.find(s => s.id === staffId);
            if (!staff) {
                alert('Staff member not found');
                return;
            }
            
            // Check if staff is male
            const isMale = staff.gender === 'Male' || staff.gender === 'male' || !staff.gender;
            if (!isMale) {
                alert('Leave application for female staff is not implemented yet');
                return;
            }
            
            // Validate dates - parse DD/MM/YYYY format correctly
            const startDateObj = parseDDMMYYYY(startDate);
            const endDateObj = parseDDMMYYYY(endDate);
            if (!startDateObj || !endDateObj) {
                alert('Invalid date format. Please use DD/MM/YYYY format');
                return;
            }
            
            // CRITICAL: Check appointment date - leave cannot be applied before appointment
            const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
            if (appointmentDate) {
                const staffAppointmentDate = new Date(appointmentDate);
                staffAppointmentDate.setHours(0, 0, 0, 0);
                
                startDateObj.setHours(0, 0, 0, 0);
                if (startDateObj < staffAppointmentDate) {
                    alert(`Leave cannot be applied before staff appointment date (${formatDateForDisplay(appointmentDate)})`);
                    return;
                }
            }
            
            // Get today's date at midnight for comparison
            const today = new Date(fakeSystemTime.currentDate);
            today.setHours(0, 0, 0, 0);
            
            // Set time to midnight for date-only comparison
            startDateObj.setHours(0, 0, 0, 0);
            endDateObj.setHours(0, 0, 0, 0);
            
            // Allow today's date by using less than comparison without equality
            if (startDateObj < today) {
                alert('Start date cannot be in the past');
                return;
            }
            
            if (endDateObj < startDateObj) {
                alert('End date cannot be before start date');
                return;
            }
            
            const staffLeaves = getStaffLeaveBalance(staffId);
            const leaveData = staffLeaves[leaveTypeId] || {};
            const availableDays = leaveData.available || 0;
            const willDeductSalary = days > availableDays;
            
            // Confirmation dialog if salary will be deducted
            if (willDeductSalary) {
                const confirm = window.confirm(
                    `This application exceeds available leave balance by ${days - availableDays} days. ` +
                    `These extra days will be deducted from salary. Do you want to proceed?`
                );
                if (!confirm) {
                    return;
                }
            }
            
            const newApplication = {
                id: Date.now(),
                staffId,
                leaveTypeId,
                startDate,
                endDate,
                days,
                reason,
                status: 'pending',
                willDeductSalary,
                appliedDate: fakeSystemTime.currentDate.toISOString().split('T')[0],
                appliedYear: fakeSystemTime.currentYear,
                appliedInFirstHalf: fakeSystemTime.isFirstHalf,
                hasDocument: !!documentFile,
                documentName: documentFile ? documentFile.name : null,
                documentSize: documentFile ? (documentFile.size / 1024 / 1024).toFixed(2) + ' MB' : null
            };
            
            leaveApplications.push(newApplication);
            saveLeaveApplicationsToStorage();
            
            // Reset form
            document.getElementById('leaveApplicationForm').reset();
            document.getElementById('leaveStaffName').removeAttribute('data-staff-db-id');
            document.getElementById('leaveBalanceInfo').style.display = 'none';
            
            // Reset file upload
            updateFileLabel();
            
            closeProfessionalModal('leaveApplicationModal');
            showAttendanceTab('applications');
            
            // Show success message
            showChangesAppliedModal();
        }

        function viewStaffAttendance(staffId) {
            // Detailed staff attendance view
            alert(`Viewing attendance details for staff ID: ${staffId}`);
        }

        function approveLeave(applicationId) {
            const application = leaveApplications.find(app => app.id === applicationId);
            if (application) {
                // Update leave balance when approving
                const deducted = applyLeaveToBalance(application.staffId, application.leaveTypeId, application.days);
                if (deducted) {
                    application.status = 'approved';
                    console.log(`‚úÖ Leave approved and ${application.days} days deducted from staff ${application.staffId}'s balance`);
                } else {
                    application.status = 'approved';
                    console.log(`‚ö†Ô∏è Leave approved but balance deduction failed for staff ${application.staffId}`);
                }
                saveLeaveApplicationsToStorage();
                showAttendanceTab('applications');
            }
        }

        function rejectLeave(applicationId) {
            const application = leaveApplications.find(app => app.id === applicationId);
            if (application) {
                const wasApproved = application.status === 'approved';
                application.status = 'rejected';
                
                // If leave was previously approved, restore the balance
                if (wasApproved) {
                    restoreLeaveBalance(application.staffId, application.leaveTypeId, application.days);
                    console.log(`üîÑ Leave rejected and ${application.days} days restored to staff ${application.staffId}'s balance`);
                }
                
                saveLeaveApplicationsToStorage();
                showAttendanceTab('applications');
            }
        }
        
        // Function to restore leave balance when rejecting a previously approved leave
        function restoreLeaveBalance(databaseId, leaveTypeId, days) {
            const balance = getStaffLeaveBalanceComprehensive(databaseId);
            if (!balance) return false;
            
            switch(leaveTypeId) {
                case 1: // Casual Leave
                    balance.casual.used = Math.max(0, balance.casual.used - days);
                    balance.casual.available = balance.casual.entitled - balance.casual.used;
                    break;
                case 2: // Earned Leave
                    // Restore to total pool
                    balance.earned.used = Math.max(0, balance.earned.used - days);
                    
                    // Recalculate balance after restoration
                    calculateEarnedLeaveBalance(balance);
                    break;
                case 3: // Half Pay Leave
                    // For half pay leave, restore to the current cycle
                    const cycleInfo = getHalfPayLeaveCycle();
                    if (cycleInfo.isFirstHalf && balance.halfpay.firstHalfUsed >= days) {
                        balance.halfpay.firstHalfUsed = Math.max(0, balance.halfpay.firstHalfUsed - days);
                    } else if (!cycleInfo.isFirstHalf && balance.halfpay.secondHalfUsed >= days) {
                        balance.halfpay.secondHalfUsed = Math.max(0, balance.halfpay.secondHalfUsed - days);
                    }
                    balance.halfpay.used = Math.max(0, balance.halfpay.used - days);
                    break;
            }
            
            saveLeaveBalancesToStorage();
            return true;
        }

        function saveLeaveApplicationsToStorage() {
            localStorage.setItem('leaveApplications', JSON.stringify(leaveApplications));
        }

        function saveAttendanceRecordsToStorage() {
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
        }

        // Report generation functions
        function clearReportFilters() {
            document.getElementById('reportType').value = 'attendance';
            document.getElementById('reportDepartment').value = 'all';
            const currentDate = fakeSystemTime.currentDate;
            const currentYear = currentDate.getFullYear();
            document.getElementById('reportFromDate').value = `${currentYear}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-01`;
            document.getElementById('reportToDate').value = `${currentYear}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
            document.getElementById('reportStaffMember').value = 'all';
            document.getElementById('reportStatus').value = 'all';
        }

        function generateFilteredReport() {
            const reportType = document.getElementById('reportType').value;
            const department = document.getElementById('reportDepartment').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const staffMember = document.getElementById('reportStaffMember').value;
            const status = document.getElementById('reportStatus').value;
            
            console.log('Generating report with filters:', {
                reportType, department, fromDate, toDate, staffMember, status
            });
            
            // Generate report based on type
            switch(reportType) {
                case 'attendance':
                    generateMonthlyAttendanceReport();
                    break;
                case 'leave':
                    generateLeaveSummaryReport();
                    break;
                case 'summary':
                    generateMonthlySummaryReport();
                    break;
                case 'payroll':
                    generatePayrollDeductionsReport();
                    break;
            }
            
            showProfessionalAlert('Report Generated!', `${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report has been generated successfully with the applied filters.`);
        }

        function generateMonthlyAttendanceReport() {
            const reportResults = document.getElementById('reportResults');
            const reportTable = document.getElementById('reportTable');
            
            // Generate sample report data
            const reportData = admissions.map((staff, index) => {
                const workingDays = 22;
                const present = Math.floor(Math.random() * 3) + 20; // 20-22 days
                const absent = workingDays - present;
                const leaveCount = Math.floor(Math.random() * 3); // 0-2 leave days
                const late = Math.floor(Math.random() * 3); // 0-2 late arrivals
                const attendancePercent = ((present / workingDays) * 100).toFixed(1);
                
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                    'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
                ];
                const avatarGradient = gradients[index % gradients.length];
                const initials = staff.staffName.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
                
                let performance = 'Good';
                let performanceClass = 'present';
                if (attendancePercent >= 95) {
                    performance = 'Excellent';
                    performanceClass = 'present';
                } else if (attendancePercent >= 90) {
                    performance = 'Good';
                    performanceClass = 'present';
                } else if (attendancePercent >= 80) {
                    performance = 'Average';
                    performanceClass = 'leave';
                } else {
                    performance = 'Poor';
                    performanceClass = 'absent';
                }
                
                return {
                    staff,
                    workingDays,
                    present,
                    absent,
                    leaveCount,
                    late,
                    attendancePercent,
                    performance,
                    performanceClass,
                    avatarGradient,
                    initials
                };
            });
            
            // Generate table HTML
            reportTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>Department</th>
                        <th>Working Days</th>
                        <th>Present</th>
                        <th>Absent</th>
                        <th>Leave</th>
                        <th>Late</th>
                        <th>Attendance %</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody>
                    ${reportData.map(data => `
                        <tr>
                            <td>
                                <div class="staff-info">
                                    <div class="staff-avatar-small" style="background: ${data.avatarGradient};">${data.initials}</div>
                                    <div class="staff-details-small">
                                        <span class="staff-name-small">${data.staff.staffName}</span>
                                        <span class="staff-id-small">${data.staff.id}</span>
                                    </div>
                                </div>
                            </td>
                            <td>${data.staff.designation || 'N/A'}</td>
                            <td>${data.workingDays}</td>
                            <td>${data.present}</td>
                            <td>${data.absent}</td>
                            <td>${data.leaveCount}</td>
                            <td>${data.late}</td>
                            <td>${data.attendancePercent}%</td>
                            <td><span class="attendance-status ${data.performanceClass}">${data.performance}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            
            // Show the report
            reportResults.style.display = 'block';
            reportResults.scrollIntoView({ behavior: 'smooth' });
        }

        function generateLeaveSummaryReport() {
            showProfessionalAlert('Leave Summary Report', 'Leave summary report with balances, applications, and utilization has been generated successfully.');
        }

        function generateMonthlySummaryReport() {
            showProfessionalAlert('Monthly Summary Report', 'Complete monthly summary report with attendance, leave, and performance metrics has been generated.');
        }

        function generatePayrollDeductionsReport() {
            showProfessionalAlert('Payroll Report', 'Comprehensive payroll report with salary calculations, deductions, and net pay has been generated for processing.');
        }

        function generatePerformanceAnalytics() {
            // Show chart
            const reportChart = document.getElementById('reportChart');
            reportChart.style.display = 'block';
            reportChart.scrollIntoView({ behavior: 'smooth' });
            
            showProfessionalAlert('Performance Analytics', 'Advanced analytics dashboard with trends, comparisons, and workforce insights has been generated.');
        }

        function openCustomReportBuilder() {
            showProfessionalAlert('Custom Report Builder', 'Custom report builder with flexible criteria, date ranges, and data fields is now opening...');
        }

        function generateDocumentReports() {
            showProfessionalAlert('Document Reports', 'Official documents, certificates, and compliance reports have been generated for audit and regulatory purposes.');
        }

        function exportAllReports() {
            showProfessionalAlert('Export All Reports', 'All reports are being exported to PDF and Excel formats. Download will begin shortly.');
        }

        // Report action functions
        function showReportCharts() {
            const reportChart = document.getElementById('reportChart');
            if (reportChart.style.display === 'none') {
                reportChart.style.display = 'block';
                reportChart.scrollIntoView({ behavior: 'smooth' });
            } else {
                reportChart.style.display = 'none';
            }
        }

        function exportReportPDF() {
            showProfessionalAlert('Export PDF', 'Report is being exported to PDF format. Download will begin shortly.');
        }

        function exportReportExcel() {
            showProfessionalAlert('Export Excel', 'Report is being exported to Excel format. Download will begin shortly.');
        }

        function printReport() {
            window.print();
        }

        function emailReport() {
            showProfessionalAlert('Email Report', 'Report has been prepared for email. Please check your email client to send the report.');
        }

        function saveReportTemplate() {
            showProfessionalAlert('Save Template', 'Report template has been saved successfully. You can reuse this template for future reports.');
        }

        // Legacy functions for backward compatibility
        function generateMonthlyReport() {
            generateMonthlyAttendanceReport();
        }

        function generateAnnualReport() {
            generatePerformanceAnalytics();
        }

        function exportAttendanceData() {
            const data = {
                leaveTypes,
                leaveApplications,
                attendanceRecords,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `attendance_data_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Function to update current period with present date
        function updateCurrentPeriod() {
            const now = new Date();
            const currentMonth = now.toLocaleDateString('en-US', { month: 'short' });
            const currentYear = now.getFullYear();
            const currentDay = now.getDate();
            
            // Calculate days in current month
            const daysInMonth = new Date(currentYear, now.getMonth() + 1, 0).getDate();
            
            // Calculate staff joined this month
            const currentMonthStart = new Date(currentYear, now.getMonth(), 1);
            const currentMonthEnd = new Date(currentYear, now.getMonth() + 1, 0);
            
            const newStaffThisMonth = admissions.filter(staff => {
                if (!staff.dateOfAppointment) return false;
                const appointmentDate = parseDate(staff.dateOfAppointment);
                return appointmentDate >= currentMonthStart && appointmentDate <= currentMonthEnd;
            }).length;
            
            // Update the elements
            setTimeout(() => {
                const periodValueElement = document.getElementById('currentPeriodValue');
                const periodDaysElement = document.getElementById('currentPeriodDays');
                const totalStaffValueElement = document.getElementById('totalStaffValue');
                const totalStaffTrendElement = document.getElementById('totalStaffTrend');
                
                if (periodValueElement) {
                    periodValueElement.textContent = `${currentMonth} ${currentYear}`;
                }
                
                if (periodDaysElement) {
                    periodDaysElement.textContent = `${currentDay} of ${daysInMonth} days`;
                }
                
                if (totalStaffValueElement) {
                    totalStaffValueElement.textContent = admissions.length;
                }
                
                if (totalStaffTrendElement) {
                    totalStaffTrendElement.textContent = `${newStaffThisMonth} new this month`;
                }
            }, 100);
        }

        // New Attendance Management Function
        function showAttendanceNew() {
            // Current navigation state (add to global scope if needed)
            if (typeof currentNavMonth === 'undefined') {
                window.currentNavMonth = new Date().getMonth() + 1;
                window.currentNavYear = new Date().getFullYear();
            }

            // Ensure data is loaded
            if (!admissions) {
                admissions = JSON.parse(localStorage.getItem('admissions')) || [];
            }
            // Refresh global data from localStorage
            refreshGlobalData();
            
            // Update current period with present date
            updateCurrentPeriod();

            const content = document.getElementById('content');
            content.innerHTML = `
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    :root {
                        --primary-color: #2563eb;
                        --primary-hover: #1d4ed8;
                        --secondary-color: #64748b;
                        --success-color: #10b981;
                        --warning-color: #f59e0b;
                        --danger-color: #ef4444;
                        --background: #f8fafc;
                        --card-background: #ffffff;
                        --border-color: #e2e8f0;
                        --text-primary: #1e293b;
                        --text-secondary: #64748b;
                        --text-muted: #94a3b8;
                        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
                        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                    }

                    .attendance-container {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                        background: var(--background);
                        color: var(--text-primary);
                        line-height: 1.6;
                        -webkit-font-smoothing: antialiased;
                        -moz-osx-font-smoothing: grayscale;
                        padding: 24px;
                        margin: -30px;
                        min-height: 100vh;
                    }

                    .dashboard-header {
                        background: var(--card-background);
                        border-radius: 16px;
                        padding: 32px;
                        margin-bottom: 24px;
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--border-color);
                    }

                    .header-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        gap: 24px;
                        flex-wrap: wrap;
                    }

                    .header-title {
                        flex: 1;
                    }

                    .header-title h1 {
                        font-size: 32px;
                        font-weight: 700;
                        color: var(--text-primary);
                        margin-bottom: 8px;
                        letter-spacing: -0.025em;
                    }

                    .header-title p {
                        color: var(--text-secondary);
                        font-size: 16px;
                        font-weight: 400;
                    }

                    .header-actions {
                        display: flex;
                        gap: 12px;
                        align-items: center;
                    }

                    .icon-button {
                        width: 44px;
                        height: 44px;
                        border-radius: 10px;
                        border: 1px solid var(--border-color);
                        background: var(--card-background);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        color: var(--text-secondary);
                    }

                    .icon-button:hover {
                        background: var(--background);
                        transform: translateY(-1px);
                        box-shadow: var(--shadow-md);
                    }

                    .stats-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                        gap: 20px;
                        margin-bottom: 24px;
                    }

                    .stat-card {
                        background: var(--card-background);
                        border-radius: 16px;
                        padding: 12px;
                        border: 1px solid var(--border-color);
                        box-shadow: var(--shadow-sm);
                        transition: all 0.3s ease;
                        position: relative;
                        overflow: hidden;
                        min-height: 60px;
                    }

                    .stat-card::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 4px;
                        height: 100%;
                        background: var(--primary-color);
                        opacity: 0;
                        transition: opacity 0.3s ease;
                    }

                    .stat-card:hover {
                        transform: translateY(-2px);
                        box-shadow: var(--shadow-md);
                    }

                    .stat-card:hover::before {
                        opacity: 1;
                    }

                    .stat-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: start;
                        margin-bottom: 16px;
                    }

                    .stat-icon {
                        width: 48px;
                        height: 48px;
                        border-radius: 12px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 24px;
                    }

                    .stat-icon.blue {
                        background: #eff6ff;
                        color: #2563eb;
                    }

                    .stat-icon.green {
                        background: #f0fdf4;
                        color: #10b981;
                    }

                    .stat-icon.amber {
                        background: #fffbeb;
                        color: #f59e0b;
                    }

                    .stat-icon.purple {
                        background: #faf5ff;
                        color: #9333ea;
                    }

                    .stat-content h3 {
                        font-size: 14px;
                        font-weight: 500;
                        color: var(--text-secondary);
                        margin-bottom: 4px;
                        text-transform: uppercase;
                        letter-spacing: 0.05em;
                    }

                    .stat-value {
                        font-size: 32px;
                        font-weight: 700;
                        color: var(--text-primary);
                        line-height: 1.2;
                    }

                    .stat-trend {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        margin-top: 8px;
                        font-size: 14px;
                    }

                    .trend-up {
                        color: var(--success-color);
                    }

                    .trend-down {
                        color: var(--danger-color);
                    }

                    .controls-section {
                        background: var(--card-background);
                        border-radius: 16px;
                        padding: 16px 24px;
                        margin-bottom: 24px;
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--border-color);
                    }

                    .controls-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .controls-title {
                        font-size: 18px;
                        font-weight: 600;
                        color: var(--text-primary);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .control-group {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                        margin-bottom: 0;
                    }

                    .control-label {
                        font-size: 14px;
                        font-weight: 500;
                        color: var(--text-secondary);
                    }

                    .select-wrapper {
                        position: relative;
                    }

                    /* Attendance tab specific select styling */
                    .attendance-container .modern-select {
                        appearance: none;
                        padding: 8px 32px 8px 12px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--card-background);
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        height: 40px;
                        width: 100%;
                    }

                    .attendance-container .modern-select:hover {
                        border-color: var(--primary-color);
                    }

                    .attendance-container .modern-select:focus {
                        outline: none;
                        border-color: var(--primary-color);
                        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
                    }

                    .attendance-container .select-arrow {
                        position: absolute;
                        right: 12px;
                        top: 50%;
                        transform: translateY(-50%);
                        pointer-events: none;
                        color: var(--text-secondary);
                    }

                    /* Button alignment with dropdowns */
                    .btn-sm {
                        padding: 8px 16px;
                        font-size: 13px;
                        height: 40px; /* Match dropdown height */
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 8px;
                        border: none;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        font-weight: 500;
                    }

                    .modern-select:hover {
                        border-color: var(--primary-color);
                    }

                    .select-arrow {
                        position: absolute;
                        right: 12px;
                        top: 50%;
                        transform: translateY(-50%);
                        pointer-events: none;
                        color: var(--text-secondary);
                    }

                    .btn {
                        padding: 8px 16px;
                        border: none;
                        border-radius: 8px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                    }

                    .btn-primary {
                        background: var(--primary-color);
                        color: white;
                    }

                    .btn-primary:hover {
                        background: var(--primary-hover);
                        transform: translateY(-1px);
                        box-shadow: var(--shadow-md);
                    }

                    .btn-secondary {
                        background: transparent;
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }

                    .btn-secondary:hover {
                        background: var(--background);
                        color: var(--text-primary);
                    }

                    .data-section {
                        background: var(--card-background);
                        border-radius: 16px;
                        padding: 24px;
                        box-shadow: var(--shadow-sm);
                        border: 1px solid var(--border-color);
                    }

                    .section-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 24px;
                        padding-bottom: 16px;
                        border-bottom: 1px solid var(--border-color);
                    }

                    .section-title {
                        font-size: 20px;
                        font-weight: 600;
                        color: var(--text-primary);
                    }

                    .search-bar {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        background: var(--background);
                        border: 1px solid var(--border-color);
                        border-radius: 10px;
                        padding: 8px 16px;
                        width: 300px;
                        transition: all 0.2s ease;
                    }

                    .search-bar:focus-within {
                        border-color: var(--primary-color);
                        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                    }

                    .search-input {
                        border: none;
                        background: none;
                        outline: none;
                        flex: 1;
                        font-size: 14px;
                        color: var(--text-primary);
                    }

                    .table-container {
                        overflow-x: auto;
                        border-radius: 12px;
                        border: 1px solid var(--border-color);
                    }

                    .modern-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 14px;
                    }

                    .modern-table th {
                        background: var(--background);
                        padding: 16px 20px;
                        text-align: left;
                        font-weight: 600;
                        color: var(--text-secondary);
                        text-transform: uppercase;
                        font-size: 12px;
                        letter-spacing: 0.05em;
                        border-bottom: 1px solid var(--border-color);
                        white-space: nowrap;
                    }

                    .modern-table td {
                        padding: 16px 20px;
                        border-bottom: 1px solid var(--border-color);
                    }

                    .modern-table tbody tr {
                        transition: background 0.2s ease;
                    }

                    .modern-table tbody tr:hover {
                        background: rgba(37, 99, 235, 0.02);
                    }

                    .modern-table tbody tr:last-child td {
                        border-bottom: none;
                    }

                    .staff-cell {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .staff-avatar {
                        width: 40px;
                        height: 40px;
                        border-radius: 10px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: 600;
                        font-size: 16px;
                    }

                    .staff-details {
                        display: flex;
                        flex-direction: column;
                    }

                    .staff-name {
                        font-weight: 600;
                        color: var(--text-primary);
                        font-size: 14px;
                    }

                    .staff-id {
                        font-size: 12px;
                        color: var(--text-muted);
                    }

                    .designation-badge {
                        padding: 4px 10px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        background: var(--background);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                        white-space: nowrap;
                    }

                    .contact-info {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        color: var(--text-secondary);
                        font-size: 13px;
                    }

                    .status-badge {
                        padding: 4px 8px;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 500;
                        white-space: nowrap;
                    }

                    .status-badge.present {
                        background: #f0fdf4;
                        color: #10b981;
                        border: 1px solid #bbf7d0;
                    }

                    .status-badge.absent {
                        background: #fef2f2;
                        color: #ef4444;
                        border: 1px solid #fecaca;
                    }

                    .status-badge.late {
                        background: #fffbeb;
                        color: #f59e0b;
                        border: 1px solid #fed7aa;
                    }

                    .status-badge.not-marked {
                        background: var(--background);
                        color: var(--text-secondary);
                        border: 1px solid var(--border-color);
                    }

                    .compact-select {
                        padding: 6px 32px 6px 12px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        background: var(--card-background);
                        font-size: 13px;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .compact-select:hover {
                        border-color: var(--primary-color);
                    }

                    .days-input {
                        width: 80px;
                        padding: 6px 12px;
                        border: 1px solid var(--border-color);
                        border-radius: 8px;
                        font-size: 13px;
                        text-align: center;
                        transition: all 0.2s ease;
                    }

                    .days-input:focus {
                        outline: none;
                        border-color: var(--primary-color);
                        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
                    }

                    .action-footer {
                        margin-top: 32px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding-top: 24px;
                        border-top: 1px solid var(--border-color);
                    }

                    .footer-info {
                        color: var(--text-secondary);
                        font-size: 14px;
                    }

                    .footer-actions {
                        display: flex;
                        gap: 12px;
                    }

                    .toast {
                        position: fixed;
                        bottom: 24px;
                        right: 24px;
                        background: var(--text-primary);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 10px;
                        box-shadow: var(--shadow-md);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        font-size: 14px;
                        transform: translateY(100px);
                        opacity: 0;
                        transition: all 0.3s ease;
                    }

                    .toast.show {
                        transform: translateY(0);
                        opacity: 1;
                    }

                    @media (max-width: 768px) {
                        .attendance-container {
                            padding: 16px;
                            margin: -30px -16px;
                        }

                        .header-content {
                            flex-direction: column;
                            align-items: start;
                        }

                        .stats-grid {
                            grid-template-columns: 1fr;
                        }

                        .controls-content {
                            flex-direction: column;
                            align-items: stretch;
                        }

                        .search-bar {
                            width: 100%;
                        }

                        .table-container {
                            margin: 0 -16px;
                            border-radius: 0;
                        }
                    }
                </style>

                <div class="attendance-container">
                    <!-- Header Section -->
                    <div class="dashboard-header">
                        <div class="header-content">
                            <div class="header-title">
                                <h1>üìä Attendance Management</h1>
                                <p>Track and manage staff attendance records efficiently</p>
                            </div>
                            <div class="header-actions">
                                <button class="icon-button" title="Reset All Attendance Data" onclick="resetAllAttendanceData()" style="margin-right: 8px; background-color: #ef4444; color: white;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="1 4 1 10 7 10"></polyline>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                                    </svg>
                                </button>
                                <button class="icon-button" title="Export Data" onclick="exportAttendanceReport()" style="display: none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                                    </svg>
                                </button>
                                <button class="icon-button" title="Print" style="display: none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2M6 14h12v8H6z"/>
                                    </svg>
                                </button>
                                <button class="icon-button" title="Settings" style="display: none;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m3.66-10.66l-2.12 2.12m-3.08 3.08l-2.12 2.12M21 12h-6m-6 0H3m16.66 3.66l-2.12-2.12m-3.08-3.08l-2.12-2.12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75M9 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3>Total Staff</h3>
                                <div class="stat-value" id="totalStaffValue">${admissions.length}</div>
                                <div class="stat-trend trend-up">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12l5-5 4 4 5-5m0 0h-4m4 0v4"/>
                                    </svg>
                                    <span id="totalStaffTrend">3 new this month</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3>Records Entered</h3>
                                <div class="stat-value">${getRecordsEnteredCount()}</div>
                                <div class="stat-trend trend-up">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12l5-5 4 4 5-5m0 0h-4m4 0v4"/>
                                    </svg>
                                    <span>${getRecordsCompletionPercentage()}% complete</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon amber">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M12 6v6l4 2"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3>Pending Entry</h3>
                                <div class="stat-value">${getPendingEntryCount()}</div>
                                <div class="stat-trend trend-down">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12l5 5 4-4 5 5m0 0v-4m0 4h-4"/>
                                    </svg>
                                    <span>${getPendingPercentage()}% remaining</span>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon purple">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="stat-content">
                                <h3>Current Period</h3>
                                <div class="stat-value" id="currentPeriodValue">Jul 2025</div>
                                <div class="stat-trend">
                                    <span style="color: var(--text-secondary);" id="currentPeriodDays">26 days elapsed</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Combined Controls Section -->
                    <div class="controls-section">
                        <div class="controls-content" style="display: grid; grid-template-columns: auto 1fr; gap: 30px; align-items: start;">
                            <!-- Month Navigation -->
                            <div style="border-right: 1px solid #e5e7eb; padding-right: 30px; min-width: 200px;">
                                <div class="controls-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4m-6 0H5a2 2 0 01-2-2V5a2 2 0 012-2h4m8 0V1m-8 2V1"/>
                                    </svg>
                                    Month Navigation
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
                                    <button class="btn btn-secondary btn-sm" onclick="navigateMonth('prev')" title="Previous Month" style="padding: 8px 12px;">
                                        ‚óÄ Prev
                                    </button>
                                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 120px;">
                                        <span id="currentMonthDisplay" style="font-weight: 600; color: var(--primary-color); font-size: 14px;">August 2025</span>
                                        <span style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Current View</span>
                                    </div>
                                    <button class="btn btn-secondary btn-sm" onclick="navigateMonth('next')" title="Next Month" style="padding: 8px 12px;">
                                        Next ‚ñ∂
                                    </button>
                                </div>
                            </div>
                            
                            <!-- View Historical Attendance -->
                            <div>
                                <div class="controls-title" style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                                    </svg>
                                    View Historical Attendance
                                </div>
                                <div style="display: flex; gap: 16px; align-items: end;">
                                    <div class="control-group" style="margin-bottom: 0;">
                                        <label class="control-label">Month</label>
                                        <div class="select-wrapper">
                                            <select id="viewHistoricalMonth" class="modern-select" style="min-width: 140px;" onchange="updateHistoricalAttendanceView()">
                                                <option value="">Select Month</option>
                                                <!-- Dynamic options will be populated -->
                                            </select>
                                            <span class="select-arrow">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9l6 6 6-6"/>
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="control-group" style="margin-bottom: 0;">
                                        <label class="control-label">Year</label>
                                        <div class="select-wrapper">
                                            <select id="viewHistoricalYear" class="modern-select" style="min-width: 100px;" onchange="updateHistoricalAttendanceView()">
                                                <option value="">Select Year</option>
                                                <!-- Dynamic options will be populated -->
                                            </select>
                                            <span class="select-arrow">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M6 9l6 6 6-6"/>
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                    <div style="margin-bottom: 0;">
                                        <button class="btn btn-secondary btn-sm" onclick="clearHistoricalFilters()">
                                            Clear
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table Section -->
                    <div class="data-section">
                        <div class="section-header">
                            <h3 class="section-title">Staff Attendance Records</h3>
                            <div class="search-bar">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                </svg>
                                <input type="text" class="search-input" placeholder="Search staff..." 
                                       onkeypress="return /[a-zA-Z0-9\s]/.test(event.key)"
                                       oninput="handleSearchInput(this)"
                                       onkeyup="searchAttendanceTable(this.value)">
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="modern-table" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Staff Member</th>
                                        <th>Designation</th>
                                        <th>Contact</th>
                                        <th>Month</th>
                                        <th>Year</th>
                                        <th>Days Present</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    ${renderEnhancedAttendanceTable()}
                                </tbody>
                            </table>
                        </div>

                        <div class="action-footer">
                            <div class="footer-info">
                                Showing ${admissions.length} staff members for ${formatDateToDDMMYYYY(fakeSystemTime.currentDate)}
                            </div>
                            <div class="footer-actions">
                                <button class="btn btn-primary" onclick="showSaveAttendanceModal();">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 13l4 4L19 7"/>
                                    </svg>
                                    Save Record
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toast Notification -->
                <div id="attendanceToast" class="toast">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span id="attendanceToastMessage">Changes saved successfully!</span>
                </div>

                <!-- Save Attendance Records Confirmation Modal -->
                <div class="modal-overlay" id="saveAttendanceModalOverlay"></div>
                <div class="save-modal" id="saveAttendanceModal">
                    <div class="save-modal-header">
                        <div class="save-icon-wrapper">
                            <div class="save-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                    <polyline points="17,21 17,13 7,13 7,21"/>
                                    <polyline points="7,3 7,8 15,8"/>
                                </svg>
                            </div>
                        </div>
                        <h3 class="save-modal-title">Save Attendance Records</h3>
                        <p class="save-modal-subtitle">Are you sure you want to save all attendance records? This action cannot be undone and records will become read-only.</p>
                    </div>
                    <div class="save-modal-footer">
                        <button class="modal-btn modal-btn-secondary" onclick="closeSaveAttendanceModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="confirmSaveAttendanceRecords()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="M5 13l4 4L19 7"/>
                            </svg>
                            Save Records
                        </button>
                    </div>
                </div>
            `;

            // Check if records were previously saved and apply read-only state
            setTimeout(() => {
                checkIfRecordsSaved();
                // Update attendance statistics after data is loaded
                updateAttendanceStatistics();
            }, 100);
        }

        function getTodayPresentCount() {
            const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            return attendanceRecords.filter(record => 
                record.date === today && record.status === 'present'
            ).length;
        }

        function getTodayAbsentCount() {
            const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            const presentCount = getTodayPresentCount();
            return Math.max(0, admissions.length - presentCount);
        }

        function getTodayLateCount() {
            const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            return attendanceRecords.filter(record => 
                record.date === today && record.status === 'late'
            ).length;
        }

        function renderAttendanceTable() {
            const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            
            return admissions.map(staff => {
                const record = attendanceRecords.find(r => 
                    r.staffId === staff.id && r.date === selectedDate
                );
                
                const status = record?.status || 'not-marked';
                const timeIn = record?.timeIn || '';
                const timeOut = record?.timeOut || '';
                
                return `
                    <tr class="attendance-row ${status}">
                        <td><strong>${staff.staffId || 'N/A'}</strong></td>
                        <td>${staff.staffName}</td>
                        <td>${staff.designation}</td>
                        <td>
                            <span class="status-badge ${status}">
                                ${getStatusText(status)}
                            </span>
                        </td>
                        <td>${timeIn}</td>
                        <td>${timeOut}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-xs" onclick="markPresent(${staff.id})">Present</button>
                                <button class="btn btn-danger btn-xs" onclick="markAbsent(${staff.id})">Absent</button>
                                <button class="btn btn-warning btn-xs" onclick="markLate(${staff.id})">Late</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusText(status) {
            switch(status) {
                case 'present': return '‚úÖ Present';
                case 'absent': return '‚ùå Absent';
                case 'late': return '‚è∞ Late';
                default: return '‚ö™ Not Marked';
            }
        }

        function markPresent(staffId) {
            markAttendance(staffId, 'present');
        }

        function markAbsent(staffId) {
            markAttendance(staffId, 'absent');
        }

        function markLate(staffId) {
            markAttendance(staffId, 'late');
        }

        function markAttendance(staffId, status) {
            const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            const currentTime = new Date().toLocaleTimeString('en-GB', { hour12: false });
            
            // CRITICAL: Check appointment date - attendance cannot be marked before appointment
            const staff = admissions.find(s => s.id === staffId || s.staffId === staffId);
            if (staff) {
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate) {
                    const staffAppointmentDate = new Date(appointmentDate);
                    staffAppointmentDate.setHours(0, 0, 0, 0);
                    
                    const attendanceDate = parseDDMMYYYY(selectedDate);
                    if (attendanceDate) {
                        attendanceDate.setHours(0, 0, 0, 0);
                        if (attendanceDate < staffAppointmentDate) {
                            alert(`Attendance cannot be marked for ${staff.staffName || staff.name} before their appointment date (${formatDateForDisplay(appointmentDate)})`);
                            return;
                        }
                    }
                }
            }
            
            // Find existing record
            const existingRecordIndex = attendanceRecords.findIndex(r => 
                r.staffId === staffId && r.date === selectedDate
            );
            
            const record = {
                id: existingRecordIndex >= 0 ? attendanceRecords[existingRecordIndex].id : Date.now(),
                staffId: staffId,
                date: selectedDate,
                status: status,
                timeIn: status === 'present' || status === 'late' ? currentTime : '',
                timeOut: '',
                markedBy: currentUserData?.name || 'Admin',
                timestamp: new Date().toISOString()
            };
            
            if (existingRecordIndex >= 0) {
                attendanceRecords[existingRecordIndex] = record;
            } else {
                attendanceRecords.push(record);
            }
            
            saveAttendanceRecordsToStorage();
            refreshAttendanceTable();
            
            // Show toast notification
            const staffMember = admissions.find(s => s.id === staffId);
            const staffName = staffMember ? staffMember.staffName : 'Staff member';
            showAttendanceToast(`${staffName} marked as ${status}`);
        }

        function markAllPresent() {
            const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            const currentTime = new Date().toLocaleTimeString('en-GB', { hour12: false });
            
            // CRITICAL: Filter staff based on appointment date - only mark attendance for staff appointed in or before the selected month/year
            const attendanceDate = parseDDMMYYYY(selectedDate);
            const filteredAdmissions = admissions.filter(staff => {
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate && attendanceDate) {
                    // Parse DD-MM-YYYY format correctly
                    let staffAppointmentDate;
                    if (appointmentDate.includes('-') && appointmentDate.split('-').length === 3) {
                        const parts = appointmentDate.split('-');
                        if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            // DD-MM-YYYY format - parse correctly
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                            const year = parseInt(parts[2]);
                            staffAppointmentDate = new Date(year, month, day);
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                    } else {
                        staffAppointmentDate = new Date(appointmentDate);
                    }
                    
                    const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1; // 1-12
                    const staffAppointmentYear = staffAppointmentDate.getFullYear();
                    
                    const filterMonth = attendanceDate.getMonth() + 1; // 1-12
                    const filterYear = attendanceDate.getFullYear();
                    
                    // Staff should be included if appointed in or before the selected month/year
                    if (staffAppointmentYear < filterYear) {
                        return true; // Appointed in previous years
                    } else if (staffAppointmentYear === filterYear) {
                        return staffAppointmentMonth <= filterMonth; // Appointed in same year, check month
                    } else {
                        return false; // Appointed in future years
                    }
                }
                return true; // Include staff without appointment date
            });
            
            filteredAdmissions.forEach(staff => {
                const existingRecordIndex = attendanceRecords.findIndex(r => 
                    r.staffId === staff.staffId && r.date === selectedDate
                );
                
                const record = {
                    id: existingRecordIndex >= 0 ? attendanceRecords[existingRecordIndex].id : Date.now() + staff.id,
                    staffId: staff.staffId,
                    date: selectedDate,
                    status: 'present',
                    timeIn: currentTime,
                    timeOut: '',
                    markedBy: currentUserData?.name || 'Admin',
                    timestamp: new Date().toISOString()
                };
                
                if (existingRecordIndex >= 0) {
                    attendanceRecords[existingRecordIndex] = record;
                } else {
                    attendanceRecords.push(record);
                }
            });
            
            saveAttendanceRecordsToStorage();
            refreshAttendanceTable();
            showAttendanceToast(`All ${filteredAdmissions.length} eligible staff marked as present for ${selectedDate}`);
        }

        function refreshAttendanceTable() {
            const tbody = document.getElementById('attendanceTableBody');
            if (tbody) {
                // Calculate filtered staff count for current view
                const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                const filterDate = parseDDMMYYYY(selectedDate);
                const filteredCount = admissions.filter(staff => {
                    const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                    if (appointmentDate && filterDate) {
                        // Parse DD-MM-YYYY format correctly
                        let staffAppointmentDate;
                        if (appointmentDate.includes('-') && appointmentDate.split('-').length === 3) {
                            const parts = appointmentDate.split('-');
                            if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                                // DD-MM-YYYY format - parse correctly
                                const day = parseInt(parts[0]);
                                const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                                const year = parseInt(parts[2]);
                                staffAppointmentDate = new Date(year, month, day);
                            } else {
                                staffAppointmentDate = new Date(appointmentDate);
                            }
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                        
                        const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1; // 1-12
                        const staffAppointmentYear = staffAppointmentDate.getFullYear();
                        
                        const filterMonth = filterDate.getMonth() + 1; // 1-12
                        const filterYear = filterDate.getFullYear();
                        
                        // Staff should appear if appointed in or before the selected month/year
                        if (staffAppointmentYear < filterYear) {
                            return true; // Appointed in previous years
                        } else if (staffAppointmentYear === filterYear) {
                            return staffAppointmentMonth <= filterMonth; // Appointed in same year, check month
                        } else {
                            return false; // Appointed in future years
                        }
                    }
                    return true; // Count staff without appointment date
                }).length;
                
                tbody.innerHTML = renderEnhancedAttendanceTable();
                
                // Update footer info to show correct count
                const footerInfo = document.querySelector('.footer-info');
                if (footerInfo) {
                    footerInfo.textContent = `Showing ${filteredCount} eligible staff members for ${selectedDate}`;
                }
                
                // Initialize month options for all dropdowns after rendering
                initializeMonthDropdowns();
                // Restore saved values and make them read-only
                setTimeout(() => {
                    makeOnlySavedRecordsReadOnly();
                }, 100);
            }
        }
        
        function refreshAttendanceTableWithHistoricalData(selectedMonth, selectedYear) {
            const tbody = document.getElementById('attendanceTableBody');
            if (!tbody) return;
            
            // Store the selected month/year globally for the render function to use
            window.historicalViewMonth = selectedMonth;
            window.historicalViewYear = selectedYear;
            
            // Calculate filtered staff count for historical view
            const filterDate = new Date(selectedYear, selectedMonth - 1, 1);
            const filteredCount = admissions.filter(staff => {
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate) {
                    // Parse DD-MM-YYYY format correctly
                    let staffAppointmentDate;
                    if (appointmentDate.includes('-') && appointmentDate.split('-').length === 3) {
                        const parts = appointmentDate.split('-');
                        if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            // DD-MM-YYYY format - parse correctly
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                            const year = parseInt(parts[2]);
                            staffAppointmentDate = new Date(year, month, day);
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                    } else {
                        staffAppointmentDate = new Date(appointmentDate);
                    }
                    
                    const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1; // 1-12
                    const staffAppointmentYear = staffAppointmentDate.getFullYear();
                    
                    const filterMonth = filterDate.getMonth() + 1; // 1-12
                    const filterYear = filterDate.getFullYear();
                    
                    // Staff should appear if appointed in or before the selected month/year
                    if (staffAppointmentYear < filterYear) {
                        return true; // Appointed in previous years
                    } else if (staffAppointmentYear === filterYear) {
                        return staffAppointmentMonth <= filterMonth; // Appointed in same year, check month
                    } else {
                        return false; // Appointed in future years
                    }
                }
                return true; // Count staff without appointment date
            }).length;
            
            // Use the existing render function to maintain consistent formatting
            tbody.innerHTML = renderEnhancedAttendanceTable(true, selectedMonth, selectedYear);
            
            // Update footer info to show historical period with correct count
            const footerInfo = document.querySelector('.footer-info');
            if (footerInfo) {
                footerInfo.textContent = `Showing ${filteredCount} eligible staff members for ${getMonthName(selectedMonth)} ${selectedYear}`;
            }
            
            // Clean up
            delete window.historicalViewMonth;
            delete window.historicalViewYear;
        }
        
        function initializeMonthDropdowns() {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            // Update all month dropdowns based on their corresponding year selection
            document.querySelectorAll('.year-select').forEach(yearSelect => {
                // First try to find the row (standard table structure)
                let row = yearSelect.closest('tr');
                let monthSelect;
                
                if (row) {
                    // Standard table structure - look for month select in same row
                    monthSelect = row.querySelector('.month-select');
                } else {
                    // Alternative: look for corresponding month select by ID pattern
                    const yearId = yearSelect.id;
                    if (yearId && yearId.startsWith('year-')) {
                        const staffId = yearId.replace('year-', '');
                        monthSelect = document.getElementById(`month-${staffId}`);
                    }
                }
                
                if (!monthSelect) {
                    console.warn('Month select element not found for year select:', yearSelect.id);
                    return;
                }
                const selectedYear = parseInt(yearSelect.value);
                
                if (selectedYear === currentYear) {
                    // Current year: only show months up to current month
                    updateMonthOptionsForYear(monthSelect, currentMonth);
                } else if (selectedYear && selectedYear < currentYear) {
                    // Past year: show all 12 months
                    updateMonthOptionsForYear(monthSelect, 12);
                } else {
                    // No year selected or future year: show only current month options by default
                    updateMonthOptionsForYear(monthSelect, currentMonth);
                }
            });
        }

        function renderEnhancedAttendanceTable(isHistoricalView = false, histMonth = null, histYear = null) {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            // Get saved records for any view (historical or current)
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            
            // CRITICAL: Filter staff based on appointment date - only show staff appointed before the selected period
            let filterDate;
            
            if (isHistoricalView && histMonth && histYear) {
                // For historical view, use the selected month/year (first day of that month)
                filterDate = new Date(histYear, histMonth - 1, 1);
            } else {
                // For current view, use the selected attendance date
                const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
                filterDate = parseDDMMYYYY(selectedDate);
            }
            
            const filteredAdmissions = admissions.filter(staff => {
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate && filterDate) {
                    // Parse DD-MM-YYYY format correctly
                    let staffAppointmentDate;
                    if (appointmentDate.includes('-') && appointmentDate.split('-').length === 3) {
                        const parts = appointmentDate.split('-');
                        if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            // DD-MM-YYYY format - parse correctly
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                            const year = parseInt(parts[2]);
                            staffAppointmentDate = new Date(year, month, day);
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                    } else {
                        staffAppointmentDate = new Date(appointmentDate);
                    }
                    
                    const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1; // 1-12
                    const staffAppointmentYear = staffAppointmentDate.getFullYear();
                    
                    const filterMonth = filterDate.getMonth() + 1; // 1-12
                    const filterYear = filterDate.getFullYear();
                    
                    // Staff should appear if appointed in or before the selected month/year
                    if (staffAppointmentYear < filterYear) {
                        return true; // Appointed in previous years
                    } else if (staffAppointmentYear === filterYear) {
                        return staffAppointmentMonth <= filterMonth; // Appointed in same year, check month
                    } else {
                        return false; // Appointed in future years
                    }
                }
                return true; // Show staff without appointment date
            });
            
            return filteredAdmissions.map((staff, index) => {
                // Generate staff avatar initials
                const initials = staff.staffName ? staff.staffName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) : 'NA';
                
                // Generate different gradient colors for avatars
                const gradients = [
                    'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                    'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                    'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                    'linear-gradient(135deg, #f77062 0%, #fe5196 100%)'
                ];
                const gradient = gradients[index % gradients.length];
                
                // Generate month options (dynamic based on current date)
                let monthOptions = '<option value="">Select Month</option>';
                const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                
                // For past years, show all 12 months
                // For current year, only show months up to current month
                const maxMonth = currentYear;
                for (let month = 1; month <= 12; month++) {
                    monthOptions += `<option value="${month}" data-month="${month}">${monthNames[month]}</option>`;
                }
                
                // Generate year options (only past and current year)
                let yearOptions = '<option value="">Select Year</option>';
                for (let year = 2020; year <= currentYear; year++) {
                    yearOptions += `<option value="${year}">${year}</option>`;
                }
                
                return `
                    <tr>
                        <td>
                            <div class="staff-cell">
                                <div class="staff-avatar" style="background: ${gradient};">${initials}</div>
                                <div class="staff-details">
                                    <span class="staff-name">${staff.staffName}</span>
                                    <span class="staff-id">${staff.staffId || 'CBA' + String(index + 1).padStart(3, '0')}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="designation-badge">${staff.designation}</span>
                        </td>
                        <td>
                            <span class="contact-info">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                </svg>
                                ${staff.phone || '+91 98765 432' + String(10 + index)}
                            </span>
                        </td>
                        <td>
                            <div class="select-wrapper">
                                ${(() => {
                                    if (isHistoricalView) {
                                        // For historical view, check if record exists
                                        const savedRecord = savedRecords.find(r => 
                                            r.staffId === staff.staffId && 
                                            parseInt(r.month) === histMonth && 
                                            parseInt(r.year) === histYear
                                        );
                                        
                                        if (savedRecord) {
                                            // Show saved record as readonly
                                            return `<select class="compact-select month-select" id="month-${staff.staffId}" disabled style="background: #e8f5e9;">
                                                <option value="${histMonth}">${getMonthName(histMonth)}</option>
                                            </select>`;
                                        } else {
                                            // Allow editing for new records
                                            return `<select class="compact-select month-select" id="month-${staff.staffId}" onchange="handleMonthYearChange(this)">
                                                <option value="">Select Month</option>
                                                <option value="${histMonth}" selected>${getMonthName(histMonth)}</option>
                                            </select>`;
                                        }
                                    } else {
                                        // Normal data entry view
                                        return `<select class="compact-select month-select" id="month-${staff.staffId}" onchange="handleMonthYearChange(this)">
                                            ${monthOptions}
                                        </select>`;
                                    }
                                })()}
                                <span class="select-arrow">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </span>
                            </div>
                        </td>
                        <td>
                            <div class="select-wrapper">
                                ${(() => {
                                    if (isHistoricalView) {
                                        // For historical view, check if record exists
                                        const savedRecord = savedRecords.find(r => 
                                            r.staffId === staff.staffId && 
                                            parseInt(r.month) === histMonth && 
                                            parseInt(r.year) === histYear
                                        );
                                        
                                        if (savedRecord) {
                                            // Show saved record as readonly
                                            return `<select class="compact-select year-select" id="year-${staff.staffId}" disabled style="background: #e8f5e9;">
                                                <option value="${histYear}">${histYear}</option>
                                            </select>`;
                                        } else {
                                            // Allow editing for new records
                                            return `<select class="compact-select year-select" id="year-${staff.staffId}" onchange="handleMonthYearChange(this)">
                                                <option value="">Select Year</option>
                                                <option value="${histYear}" selected>${histYear}</option>
                                            </select>`;
                                        }
                                    } else {
                                        // Normal data entry view
                                        return `<select class="compact-select year-select" id="year-${staff.staffId}" onchange="handleMonthYearChange(this)">
                                            ${yearOptions}
                                        </select>`;
                                    }
                                })()}
                                <span class="select-arrow">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M6 9l6 6 6-6"/>
                                    </svg>
                                </span>
                            </div>
                        </td>
                        <td>
                            ${(() => {
                                if (isHistoricalView) {
                                    // For historical view, check if record exists
                                    const savedRecord = savedRecords.find(r => 
                                        r.staffId === staff.staffId && 
                                        parseInt(r.month) === histMonth && 
                                        parseInt(r.year) === histYear
                                    );
                                    
                                    if (savedRecord) {
                                        // Show saved record as readonly
                                        return `<input type="number" class="days-input" id="days-${staff.staffId}" value="${savedRecord.daysPresent}" placeholder="Days" readonly style="background: #e8f5e9;">`;
                                    } else {
                                        // Allow editing for new records
                                        return `<input type="number" class="days-input" id="days-${staff.staffId}" min="0" max="31" step="1" value="" placeholder="Days" oninput="validateDaysInput(this)" onblur="validateDaysInput(this)" onkeypress="return isNumericInput(event)">`;
                                    }
                                } else {
                                    // Normal data entry view
                                    return `<input type="number" class="days-input" id="days-${staff.staffId}" min="0" max="31" step="1" value="" placeholder="Days" oninput="validateDaysInput(this)" onblur="validateDaysInput(this)" onkeypress="return isNumericInput(event)">`;
                                }
                            })()}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getEnhancedStatusText(status) {
            switch(status) {
                case 'present': return '‚úÖ Present';
                case 'absent': return '‚ùå Absent';
                case 'late': return '‚è∞ Late';
                default: return '‚ö™ Not Marked';
            }
        }

        function searchAttendanceTable(value) {
            const table = document.getElementById('attendanceTable');
            if (!table) return;
            
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            
            for (let row of rows) {
                const nameEl = row.querySelector('.staff-name');
                const idEl = row.querySelector('.staff-id');
                const designationEl = row.querySelector('.designation-badge');
                
                if (nameEl && idEl && designationEl) {
                    const name = nameEl.textContent.toLowerCase();
                    const id = idEl.textContent.toLowerCase();
                    const designation = designationEl.textContent.toLowerCase();
                    
                    if (name.includes(value.toLowerCase()) || 
                        id.includes(value.toLowerCase()) || 
                        designation.includes(value.toLowerCase())) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                }
            }
        }

        function showAttendanceToast(message, type = 'success') {
            const toast = document.getElementById('attendanceToast');
            const toastMessage = document.getElementById('attendanceToastMessage');
            
            if (toast && toastMessage) {
                toastMessage.textContent = message;
                
                if (type === 'error') {
                    toast.style.background = '#ef4444';
                } else if (type === 'info') {
                    toast.style.background = '#3b82f6';
                } else {
                    toast.style.background = '#1e293b';
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }


        function resetAll() {
            // Show confirmation dialog for complete reset
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL attendance records (both current and saved) and reset everything. Are you sure you want to continue?')) {
                return;
            }
            
            // Clear ALL attendance data from localStorage
            localStorage.removeItem('attendanceRecords');
            localStorage.removeItem('savedAttendanceRecords');
            localStorage.removeItem('attendanceRecordsSaved');
            localStorage.removeItem('attendanceStats');
            
            // Reset master controls
            const masterMonth = document.getElementById('masterMonth');
            const masterYear = document.getElementById('masterYear');
            
            if (masterMonth) {
                masterMonth.value = '';
                masterMonth.disabled = false;
                masterMonth.style.background = '';
            }
            if (masterYear) {
                masterYear.value = '';
                masterYear.disabled = false;
                masterYear.style.background = '';
            }
            
            // Reset historical view controls
            const viewMonth = document.getElementById('viewHistoricalMonth');
            const viewYear = document.getElementById('viewHistoricalYear');
            if (viewMonth) viewMonth.value = '';
            if (viewYear) viewYear.value = '';
            
            // Force refresh table to normal data entry mode FIRST
            // This ensures we're working with editable fields
            refreshAttendanceTable();
            
            // Give the table a moment to re-render, then reset all fields
            setTimeout(() => {
                admissions.forEach(staff => {
                    const monthSelect = document.querySelector(`#month-${staff.staffId}`);
                    const yearSelect = document.querySelector(`#year-${staff.staffId}`);
                    const daysInput = document.querySelector(`#days-${staff.staffId}`);
                    
                    if (monthSelect) {
                        monthSelect.value = '';
                        monthSelect.disabled = false;
                        monthSelect.style.background = '';
                        monthSelect.style.color = '';
                    }
                    if (yearSelect) {
                        yearSelect.value = '';
                        yearSelect.disabled = false;
                        yearSelect.style.background = '';
                        yearSelect.style.color = '';
                    }
                    if (daysInput) {
                        daysInput.value = '';
                        daysInput.readOnly = true; // Keep readonly until month/year selected
                        daysInput.style.background = '#f8f9fa';
                        daysInput.style.color = '#6c757d';
                        daysInput.placeholder = 'Select Month & Year first';
                    }
                });
                
                // Reset attendance-related global variables
                if (typeof attendanceRecords !== 'undefined') {
                    attendanceRecords = [];
                }
                
                // Update statistics to reflect reset state
                updateAttendanceStatistics();
                
                // Update save button state
                updateSaveButtonStateSelective();
                
                // Show success message
                showAttendanceToast('All attendance data has been reset successfully. All fields are now editable for re-entry.', 'info');
            }, 100);
        }

        function getMonthName(monthNumber) {
            const months = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            return months[parseInt(monthNumber)] || '';
        }

        // Month Navigation Functions
        function navigateMonth(direction) {
            const currentDate = new Date();
            const actualCurrentMonth = currentDate.getMonth() + 1;
            const actualCurrentYear = currentDate.getFullYear();
            
            // Initialize navigation state if not exists
            if (typeof window.currentNavMonth === 'undefined') {
                window.currentNavMonth = actualCurrentMonth;
                window.currentNavYear = actualCurrentYear;
            }
            
            if (direction === 'next') {
                // Check if we're trying to go to a future month
                if (window.currentNavYear > actualCurrentYear || 
                    (window.currentNavYear === actualCurrentYear && window.currentNavMonth >= actualCurrentMonth)) {
                    showAttendanceToast('Cannot navigate to future months', 'error');
                    return;
                }
                
                window.currentNavMonth++;
                if (window.currentNavMonth > 12) {
                    window.currentNavMonth = 1;
                    window.currentNavYear++;
                }
            } else if (direction === 'prev') {
                // Prevent going too far back (e.g., before 2020)
                if (window.currentNavYear <= 2020 && window.currentNavMonth <= 1) {
                    showAttendanceToast('Cannot navigate further back', 'error');
                    return;
                }
                
                window.currentNavMonth--;
                if (window.currentNavMonth < 1) {
                    window.currentNavMonth = 12;
                    window.currentNavYear--;
                }
            }
            
            // Update the historical view dropdowns to reflect the navigation
            const viewMonthSelect = document.getElementById('viewHistoricalMonth');
            const viewYearSelect = document.getElementById('viewHistoricalYear');
            
            if (viewMonthSelect && viewYearSelect) {
                viewMonthSelect.value = window.currentNavMonth;
                viewYearSelect.value = window.currentNavYear;
            }
            
            // Update display and load data
            updateCurrentMonthDisplay();
            updateHistoricalAttendanceView();
            
            // Update attendance statistics cards for the new month
            updateAttendanceStatistics();
        }

        function updateCurrentMonthDisplay() {
            const monthDisplay = document.getElementById('currentMonthDisplay');
            if (monthDisplay) {
                // Initialize navigation state if not exists
                if (typeof window.currentNavMonth === 'undefined') {
                    const now = new Date();
                    window.currentNavMonth = now.getMonth() + 1;
                    window.currentNavYear = now.getFullYear();
                }
                monthDisplay.textContent = `${getMonthName(window.currentNavMonth)} ${window.currentNavYear}`;
            }
        }

        function getRecordsEnteredCount() {
            // Get current navigation month/year
            const currentMonth = window.currentNavMonth || new Date().getMonth() + 1;
            const currentYear = window.currentNavYear || new Date().getFullYear();
            
            // Count only saved records for the specific month/year
            const allSavedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            const monthSpecificRecords = allSavedRecords.filter(record => {
                const recordMonth = parseInt(record.month);
                const recordYear = parseInt(record.year);
                return recordMonth === currentMonth && recordYear === currentYear;
            });
            
            
            return monthSpecificRecords.length;
        }

        function getPendingEntryCount() {
            // Get current navigation month/year
            const currentMonth = window.currentNavMonth || new Date().getMonth() + 1;
            const currentYear = window.currentNavYear || new Date().getFullYear();
            
            // Count records that are not saved for the specific month/year
            const allSavedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            const monthSpecificSavedRecords = allSavedRecords.filter(record => 
                parseInt(record.month) === currentMonth && parseInt(record.year) === currentYear
            );
            
            // Find staff who don't have saved records for this month/year
            const savedStaffIds = monthSpecificSavedRecords.map(record => record.staffId);
            const pendingRecords = admissions.filter(staff => 
                !savedStaffIds.includes(staff.staffId)
            );
            return pendingRecords.length;
        }

        function getRecordsCompletionPercentage() {
            if (admissions.length === 0) return 0;
            const completed = getRecordsEnteredCount(); // Now month-specific
            return Math.round((completed / admissions.length) * 100);
        }

        function getPendingPercentage() {
            if (admissions.length === 0) return 0;
            const pending = getPendingEntryCount(); // Now month-specific
            return Math.round((pending / admissions.length) * 100);
        }

        function isNumericInput(event) {
            // Allow: backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].indexOf(event.keyCode) !== -1 ||
                // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (event.keyCode === 65 && event.ctrlKey === true) ||
                (event.keyCode === 67 && event.ctrlKey === true) ||
                (event.keyCode === 86 && event.ctrlKey === true) ||
                (event.keyCode === 88 && event.ctrlKey === true)) {
                return true;
            }
            // Ensure that it is a number and stop the keypress
            if ((event.shiftKey || (event.keyCode < 48 || event.keyCode > 57)) && (event.keyCode < 96 || event.keyCode > 105)) {
                event.preventDefault();
                return false;
            }
            return true;
        }
        
        function validateDaysInput(input) {
            // Remove any non-numeric characters
            input.value = input.value.replace(/[^0-9]/g, '');
            
            const value = parseInt(input.value);
            
            // Handle empty or invalid input
            if (isNaN(value) || input.value === '') {
                // Update save button state even when field is empty
                updateSaveButtonStateSelective();
                return;
            }
            
            if (value < 0) {
                input.value = 0;
                showAttendanceToast('Days cannot be negative', 'error');
            } else if (value > 31) {
                input.value = 31;
                showAttendanceToast('Maximum 31 days allowed in a month', 'error');
            }
            
            // Also validate against selected month's actual days
            const row = input.closest('tr');
            const monthSelect = row?.querySelector('.compact-select[id^="month-"]');
            const yearSelect = row?.querySelector('.compact-select[id^="year-"]');
            
            if (monthSelect?.value && yearSelect?.value && value > 0) {
                const monthDays = getDaysInMonth(parseInt(monthSelect.value), parseInt(yearSelect.value));
                if (value > monthDays) {
                    input.value = monthDays;
                    showAttendanceToast(`${getMonthName(monthSelect.value)} ${yearSelect.value} has only ${monthDays} days`, 'error');
                }
            }
            
            // Update save button state dynamically
            updateSaveButtonStateSelective();
            
            // Note: Statistics will be updated only when records are actually saved
        }

        function getDaysInMonth(month, year) {
            const daysInMonth = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            
            // Check for leap year
            if (month === 2 && isLeapYear(year)) {
                return 29;
            }
            
            return daysInMonth[month - 1] || 31;
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function validateAttendanceFields(staffId) {
            const monthSelect = document.getElementById(`month-${staffId}`);
            const yearSelect = document.getElementById(`year-${staffId}`);
            const daysInput = document.getElementById(`days-${staffId}`);
            
            // If either month or year is not selected (empty value), disable days input
            if (monthSelect?.value === '' || yearSelect?.value === '') {
                if (daysInput) {
                    daysInput.value = '';
                    daysInput.readOnly = true;
                    daysInput.style.background = '#f8f9fa';
                    daysInput.style.color = '#6c757d';
                    daysInput.placeholder = 'Select Month & Year first';
                }
            } else {
                // If both month and year are selected, enable days input
                if (daysInput) {
                    daysInput.readOnly = false;
                    daysInput.style.background = '';
                    daysInput.style.color = '';
                    daysInput.placeholder = 'Enter days';
                }
            }
            
            // Update save button state
            updateSaveButtonStateSelective();
        }

        function validateAttendanceEntry(staffId) {
            const monthSelect = document.getElementById(`month-${staffId}`);
            const yearSelect = document.getElementById(`year-${staffId}`);
            const daysInput = document.getElementById(`days-${staffId}`);
            
            if (!daysInput || !monthSelect || !yearSelect) return;
            
            // Remove any non-numeric characters
            daysInput.value = daysInput.value.replace(/[^0-9]/g, '');
            
            const value = parseInt(daysInput.value);
            
            // Handle empty or invalid input
            if (isNaN(value) || daysInput.value === '') {
                updateSaveButtonStateSelective();
                return;
            }
            
            if (value < 0) {
                daysInput.value = 0;
                showAttendanceToast('Days cannot be negative', 'error');
            } else if (value > 31) {
                daysInput.value = 31;
                showAttendanceToast('Maximum 31 days allowed in a month', 'error');
            }
            
            // Validate against selected month's actual days
            if (monthSelect.value && yearSelect.value && value > 0) {
                const monthDays = getDaysInMonth(parseInt(monthSelect.value), parseInt(yearSelect.value));
                if (value > monthDays) {
                    daysInput.value = monthDays;
                    showAttendanceToast(`${getMonthName(monthSelect.value)} ${yearSelect.value} has only ${monthDays} days`, 'error');
                }
            }
            
            // Update save button state
            updateSaveButtonStateSelective();
        }

        function isStaffRecordSaved(staffId) {
            // Get the specific month/year for this staff member from the form
            const monthSelect = document.querySelector(`#month-${staffId}`);
            const yearSelect = document.querySelector(`#year-${staffId}`);
            
            if (!monthSelect?.value || !yearSelect?.value) {
                return false; // No month/year selected, so not saved
            }
            
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords')) || [];
            return savedRecords.some(record => 
                record.staffId === staffId && 
                parseInt(record.month) === parseInt(monthSelect.value) && 
                parseInt(record.year) === parseInt(yearSelect.value)
            );
        }
        
        function isStaffRecordComplete(staffId) {
            // Get all elements with the same ID and find the one with values
            const monthSelects = document.querySelectorAll(`#month-${staffId}`);
            const yearSelects = document.querySelectorAll(`#year-${staffId}`);
            const daysInputs = document.querySelectorAll(`#days-${staffId}`);
            
            // Find the elements that have values (not empty)
            let monthSelect = null;
            let yearSelect = null;
            let daysInput = null;
            
            for (let element of monthSelects) {
                if (element.value && element.value.trim() !== '') {
                    monthSelect = element;
                    break;
                }
            }
            
            for (let element of yearSelects) {
                if (element.value && element.value.trim() !== '') {
                    yearSelect = element;
                    break;
                }
            }
            
            for (let element of daysInputs) {
                if (element.value && element.value.trim() !== '') {
                    daysInput = element;
                    break;
                }
            }
            
            // All three fields must be selected/filled: Month, Year, and Days Present
            const hasMonth = monthSelect?.value && monthSelect.value.trim() !== '';
            const hasYear = yearSelect?.value && yearSelect.value.trim() !== '';
            const hasDays = daysInput?.value && daysInput.value.trim() !== '' && parseInt(daysInput.value) >= 0;
            
            return hasMonth && hasYear && hasDays;
        }

        function showSaveAttendanceModal() {
            // Count complete records that haven't been saved yet
            const completeUnsavedRecords = admissions.filter(staff => {
                // Check if record is complete and not already saved
                const isComplete = isStaffRecordComplete(staff.staffId);
                const isAlreadySaved = isStaffRecordSaved(staff.staffId);
                
                return isComplete && !isAlreadySaved;
            });
            
            // Count incomplete records to provide better feedback
            const incompleteRecords = admissions.filter(staff => {
                const isAlreadySaved = isStaffRecordSaved(staff.staffId);
                const isComplete = isStaffRecordComplete(staff.staffId);
                
                return !isAlreadySaved && !isComplete;
            });

            if (completeUnsavedRecords.length === 0) {
                if (incompleteRecords.length > 0) {
                    showAttendanceToast(`Cannot save: ${incompleteRecords.length} record(s) are missing Month, Year, or Days Present data`, 'error');
                } else {
                    showAttendanceToast('No new complete attendance records to save', 'error');
                }
                return;
            }

            // Update modal message to show how many records will be saved
            const modalSubtitle = document.querySelector('#saveAttendanceModal .save-modal-subtitle');
            if (modalSubtitle) {
                modalSubtitle.textContent = `You are about to save ${completeUnsavedRecords.length} complete attendance record(s). These records will become read-only and cannot be edited in the future.`;
            }

            const modal = document.getElementById('saveAttendanceModal');
            const overlay = document.getElementById('saveAttendanceModalOverlay');
            
            overlay.classList.add('show');
            modal.classList.add('show');
        }

        function closeSaveAttendanceModal() {
            const modal = document.getElementById('saveAttendanceModal');
            const overlay = document.getElementById('saveAttendanceModalOverlay');
            
            modal.classList.remove('show');
            overlay.classList.remove('show');
        }

        function confirmSaveAttendanceRecords() {
            // Close the modal first
            closeSaveAttendanceModal();
            
            // Collect only complete unsaved attendance data
            const attendanceData = [];
            
            admissions.forEach(staff => {
                const monthSelect = document.querySelector(`#month-${staff.staffId}`);
                const yearSelect = document.querySelector(`#year-${staff.staffId}`);
                const daysInput = document.querySelector(`#days-${staff.staffId}`);
                
                // Only save records that are complete and not already saved
                // All three fields must be selected/filled: Month, Year, and Days Present
                const isComplete = isStaffRecordComplete(staff.staffId);
                const isAlreadySaved = isStaffRecordSaved(staff.staffId);
                
                // Find elements with values (handle duplicate elements by finding the one with data)
                const allMonthElements = document.querySelectorAll(`[id*="month-${staff.staffId}"]`);
                const allYearElements = document.querySelectorAll(`[id*="year-${staff.staffId}"]`);
                const allDaysElements = document.querySelectorAll(`[id*="days-${staff.staffId}"]`);
                
                // Find the element that has a value
                let workingMonth = null, workingYear = null, workingDays = null;
                
                for(let elem of allMonthElements) {
                    if(elem.value && elem.value.trim() !== '') {
                        workingMonth = elem;
                        break;
                    }
                }
                for(let elem of allYearElements) {
                    if(elem.value && elem.value.trim() !== '') {
                        workingYear = elem;
                        break;
                    }
                }
                for(let elem of allDaysElements) {
                    if(elem.value && elem.value.trim() !== '') {
                        workingDays = elem;
                        break;
                    }
                }
                
                if (isComplete && !isAlreadySaved && workingMonth && workingYear && workingDays) {
                    attendanceData.push({
                        staffId: staff.staffId,
                        staffName: staff.staffName,
                        designation: staff.designation,
                        month: parseInt(workingMonth.value),
                        year: parseInt(workingYear.value),
                        daysPresent: parseInt(workingDays.value) || 0,
                        savedAt: new Date().toISOString(),
                        isReadOnly: true
                    });
                }
            });
            
            // Save to localStorage
            const existingRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords')) || [];
            const newSavedRecords = [...existingRecords, ...attendanceData];
            localStorage.setItem('savedAttendanceRecords', JSON.stringify(newSavedRecords));
            
            // Make only saved records read-only
            makeOnlySavedRecordsReadOnly();
            
            // Show success message
            showAttendanceToast(`Successfully saved ${attendanceData.length} attendance records. These records are now read-only.`);
            
            // Update statistics
            updateAttendanceStatistics();
            
            // Update the save button state
            updateSaveButtonStateSelective();
            
            // Refresh the current view to show updated records
            setTimeout(() => {
                const viewMonth = document.getElementById('viewHistoricalMonth');
                const viewYear = document.getElementById('viewHistoricalYear');
                
                // Always reload the entire attendance view to show updated data
                if (viewMonth?.value && viewYear?.value) {
                    // We're in historical view mode - refresh with selected month/year
                    refreshAttendanceTableWithHistoricalData(parseInt(viewMonth.value), parseInt(viewYear.value));
                } else {
                    // We're in current month data entry mode - reload the attendance interface
                    showAttendanceNew();
                }
                
                // Update statistics again after refresh to ensure consistency
                updateAttendanceStatistics();
            }, 300); // Small delay for smooth transition
        }

        function makeOnlySavedRecordsReadOnly() {
            // Make only saved staff records read-only and show saved values
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords')) || [];
            
            admissions.forEach(staff => {
                if (isStaffRecordSaved(staff.staffId)) {
                    // Find the saved record for this staff member for the specific month/year being displayed
                    const monthSelect = document.querySelector(`#month-${staff.staffId}`);
                    const yearSelect = document.querySelector(`#year-${staff.staffId}`);
                    
                    const savedRecord = savedRecords.find(record => 
                        record.staffId === staff.staffId &&
                        parseInt(record.month) === parseInt(monthSelect?.value || 0) &&
                        parseInt(record.year) === parseInt(yearSelect?.value || 0)
                    );
                    
                    const daysInput = document.querySelector(`#days-${staff.staffId}`);
                    
                    if (monthSelect && savedRecord) {
                        monthSelect.value = savedRecord.month;
                        monthSelect.disabled = true;
                        monthSelect.style.background = '#f8f9fa';
                        monthSelect.style.color = '#6c757d';
                    }
                    
                    if (yearSelect && savedRecord) {
                        yearSelect.value = savedRecord.year;
                        yearSelect.disabled = true;
                        yearSelect.style.background = '#f8f9fa';
                        yearSelect.style.color = '#6c757d';
                    }
                    
                    if (daysInput && savedRecord) {
                        daysInput.value = savedRecord.daysPresent;
                        daysInput.readOnly = true;
                        daysInput.style.background = '#f8f9fa';
                        daysInput.style.color = '#6c757d';
                    }
                }
            });
        }

        function makeAttendanceRecordsReadOnly() {
            // Legacy function - make all records read-only (kept for backward compatibility)
            document.querySelectorAll('.compact-select[id^="month-"]').forEach(select => {
                select.disabled = true;
                select.style.background = '#f8f9fa';
                select.style.color = '#6c757d';
            });
            
            document.querySelectorAll('.compact-select[id^="year-"]').forEach(select => {
                select.disabled = true;
                select.style.background = '#f8f9fa';
                select.style.color = '#6c757d';
            });
            
            document.querySelectorAll('.days-input').forEach(input => {
                input.readOnly = true;
                input.style.background = '#f8f9fa';
                input.style.color = '#6c757d';
            });
            
            document.getElementById('masterMonth').disabled = true;
            document.getElementById('masterYear').disabled = true;
            document.getElementById('masterMonth').style.background = '#f8f9fa';
            document.getElementById('masterYear').style.background = '#f8f9fa';
        }

        function updateSaveButtonStateSelective() {
            const saveButton = document.querySelector('button[onclick="showSaveAttendanceModal()"]');
            if (saveButton) {
                // Check if ALL staff have been entered and saved
                const allStaffEntered = admissions.every(staff => {
                    const isComplete = isStaffRecordComplete(staff.staffId);
                    const isAlreadySaved = isStaffRecordSaved(staff.staffId);
                    
                    return isComplete && isAlreadySaved;
                });
                
                // Button never gets disabled - only text changes when all records are saved
                if (allStaffEntered) {
                    saveButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                        </svg>
                        All Records Saved
                    `;
                } else {
                    saveButton.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 13l4 4L19 7"/>
                        </svg>
                        Save Record
                    `;
                }
                
                // Button remains enabled and functional
                saveButton.disabled = false;
                saveButton.style.background = '';
                saveButton.style.opacity = '';
                saveButton.onclick = showSaveAttendanceModal;
            }
        }

        function updateSaveButtonState() {
            // Legacy function - disable button completely
            const saveButton = document.querySelector('button[onclick="showSaveAttendanceModal()"]');
            if (saveButton) {
                saveButton.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 13l4 4L19 7"/>
                    </svg>
                    Records Saved
                `;
                saveButton.disabled = true;
                saveButton.style.background = '#10b981';
                saveButton.style.opacity = '0.7';
                saveButton.onclick = null;
            }
        }

        function updateAttendanceStatistics() {
            // Get current navigation month/year for display context
            const currentMonth = window.currentNavMonth || new Date().getMonth() + 1;
            const currentYear = window.currentNavYear || new Date().getFullYear();
            const monthName = getMonthName(currentMonth);
            
            // Force update the statistics cards by re-rendering their content
            const statCards = document.querySelectorAll('.stat-value');
            if (statCards.length >= 4) {
                statCards[0].textContent = admissions.length; // Total Staff (always same)
                statCards[1].textContent = getRecordsEnteredCount(); // Records Entered (month-specific)
                statCards[2].textContent = getPendingEntryCount(); // Pending Entry (month-specific)
                // statCards[3] is Current Period, update to show current month
                const currentPeriodElement = statCards[3].closest('.stat-card').querySelector('h3');
                if (currentPeriodElement) {
                    currentPeriodElement.textContent = `${monthName} ${currentYear}`;
                }
            }
            
            // Update percentages (now month-specific)
            const percentageElements = document.querySelectorAll('.stat-trend span');
            if (percentageElements.length >= 2) {
                percentageElements[1].textContent = `${getRecordsCompletionPercentage()}% complete`;
                percentageElements[2].textContent = `${getPendingPercentage()}% remaining`;
            }
            
            // Debug logging
            console.log(`Attendance stats updated for ${monthName} ${currentYear}:`, {
                totalStaff: admissions.length,
                recordsEntered: getRecordsEnteredCount(),
                pendingEntry: getPendingEntryCount(),
                month: currentMonth,
                year: currentYear
            });
        }

        function checkIfRecordsSaved() {
            // Apply selective read-only mode based on saved records
            makeOnlySavedRecordsReadOnly();
            updateSaveButtonStateSelective();
            // Initialize statistics only on page load (not during data entry)
            updateAttendanceStatistics();
            // Initialize month dropdowns with proper restrictions
            initializeMonthDropdowns();
            // Initialize historical view dropdowns
            initializeHistoricalDropdowns();
            // Initialize month navigation display
            setTimeout(() => {
                updateCurrentMonthDisplay();
                
                // Show current month's saved attendance data by default
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();
                refreshAttendanceTableWithHistoricalData(currentMonth, currentYear);
            }, 100);
        }

        // Function to reset saved state (for testing/development)
        function resetAttendanceSavedState() {
            localStorage.removeItem('attendanceRecordsSaved');
            localStorage.removeItem('savedAttendanceRecords');
            showAttendanceToast('Saved state reset. Refresh the page to make records editable again.');
        }

        // Function to reset all attendance data
        function resetAllAttendanceData() {
            // Show confirmation dialog
            if (!confirm('‚ö†Ô∏è This will permanently delete ALL attendance data and reset everything on this page. Are you sure you want to continue?')) {
                return;
            }
            
            // Clear all attendance-related localStorage data
            localStorage.removeItem('attendanceRecords');
            localStorage.removeItem('savedAttendanceRecords');
            localStorage.removeItem('attendanceRecordsSaved');
            localStorage.removeItem('attendanceStats');
            localStorage.removeItem('dailyAttendanceData');
            localStorage.removeItem('monthlyAttendanceData');
            
            // Reset global attendance arrays and objects
            attendanceRecords = [];
            if (typeof savedAttendanceRecords !== 'undefined') {
                savedAttendanceRecords = [];
            }
            
            // Clear any attendance-related session data
            sessionStorage.removeItem('currentAttendanceDate');
            sessionStorage.removeItem('attendanceFilters');
            
            // Reset attendance form fields if they exist
            const attendanceDateField = document.getElementById('attendanceDate');
            if (attendanceDateField) {
                attendanceDateField.value = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            }
            
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) {
                monthSelect.value = fakeSystemTime.currentDate.getMonth() + 1;
            }
            
            const yearSelect = document.getElementById('yearSelect');
            if (yearSelect) {
                yearSelect.value = fakeSystemTime.currentYear;
            }
            
            // Refresh the attendance view to show empty/reset state
            showAttendanceNew();
            
            // Show success message
            setTimeout(() => {
                alert('‚úÖ All attendance data has been reset successfully!\n\n‚Ä¢ Attendance records: Cleared\n‚Ä¢ Saved records: Cleared\n‚Ä¢ Statistics: Reset\n‚Ä¢ Form fields: Reset to defaults\n\nThe attendance page has been refreshed to show the clean state.');
            }, 200);
        }

        function handleMonthYearChange(selectElement) {
            const row = selectElement.closest('tr');
            const monthSelect = row.querySelector('.month-select');
            const yearSelect = row.querySelector('.year-select');
            const daysInput = row.querySelector('.days-input');
            
            // Get current date for validation
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            // Check for future date selection
            const selectedYear = parseInt(yearSelect.value);
            const selectedMonth = parseInt(monthSelect.value);
            
            if (selectedYear && selectedMonth) {
                // Check if selected date is in the future
                if (selectedYear > currentYear || (selectedYear === currentYear && selectedMonth > currentMonth)) {
                    showAttendanceToast('Cannot select future dates for attendance', 'error');
                    if (selectElement.classList.contains('month-select')) {
                        monthSelect.value = '';
                    } else {
                        yearSelect.value = '';
                    }
                    return;
                }
            }
            
            // Update month dropdown dynamically based on selected year
            if (selectElement.classList.contains('year-select')) {
                if (selectedYear === currentYear) {
                    // Current year: only show months up to current month
                    updateMonthOptionsForYear(monthSelect, currentMonth);
                } else if (selectedYear < currentYear) {
                    // Past year: show all 12 months
                    updateMonthOptionsForYear(monthSelect, 12);
                } else {
                    // Future year: clear selection and show error
                    yearSelect.value = '';
                    showAttendanceToast('Cannot select future years for attendance', 'error');
                    return;
                }
            }
            
            // If either month or year is not selected (empty value), disable days input
            if (monthSelect.value === '' || yearSelect.value === '') {
                daysInput.value = '';
                daysInput.readOnly = true;
                daysInput.style.background = '#f8f9fa';
                daysInput.style.color = '#6c757d';
                daysInput.placeholder = 'Select Month & Year first';
            } else {
                // If both month and year are selected, enable days input
                daysInput.readOnly = false;
                daysInput.style.background = '';
                daysInput.style.color = '';
                daysInput.placeholder = 'Days';
            }
            
            // Update save button state when month/year changes
            updateSaveButtonStateSelective();
        }
        
        function updateMonthOptionsForYear(monthSelect, maxMonth) {
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
            
            // Save current selection
            const currentSelection = monthSelect.value;
            
            // Clear and rebuild month options
            monthSelect.innerHTML = '<option value="">Select Month</option>';
            for (let month = 1; month <= maxMonth; month++) {
                const option = `<option value="${month}">${monthNames[month]}</option>`;
                monthSelect.innerHTML += option;
            }
            
            // Restore selection if it's still valid
            if (currentSelection && parseInt(currentSelection) <= maxMonth) {
                monthSelect.value = currentSelection;
            } else if (currentSelection && parseInt(currentSelection) > maxMonth) {
                // Clear invalid selection and show message
                monthSelect.value = '';
                showAttendanceToast(`${monthNames[currentSelection]} is not available for the selected year`, 'info');
            }
        }
        
        // Function to format dates for display in payslip
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return 'N/A';
            
            let date;
            if (dateStr.includes('/')) {
                date = parseDDMMYYYY(dateStr);
            } else if (dateStr.includes('-')) {
                // Handle DD-MM-YYYY format with dashes
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1; // Month is 0-indexed
                    const year = parseInt(parts[2]);
                    date = new Date(year, month, day);
                } else {
                    date = new Date(dateStr);
                }
            } else {
                date = new Date(dateStr);
            }
            
            if (!date || isNaN(date.getTime())) {
                return dateStr; // Return original string if parsing fails
            }
            
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Show Deduction Balance Overview
        function showDeductionBalance() {
            // Ensure data is loaded
            if (!admissions) {
                admissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || [];
            }
            
            // Load deduction balance data
            const deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
            
            const content = document.getElementById('content');
            content.innerHTML = `
                <style>
                    /* Deduction Balance Overview Styles */
                    .deduction-container {
                        max-width: 1400px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 15px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                        overflow: hidden;
                    }

                    .deduction-header {
                        background: linear-gradient(135deg, #2C2C2C 0%, #1a1a1a 100%);
                        color: white;
                        padding: 25px 30px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                    }

                    .header-left {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                    }

                    .header-icon {
                        background: #667eea;
                        padding: 12px;
                        border-radius: 10px;
                        font-size: 24px;
                    }

                    .header-title {
                        font-size: 28px;
                        font-weight: 600;
                        margin: 0;
                    }

                    .header-subtitle {
                        font-size: 14px;
                        opacity: 0.8;
                        margin-top: 5px;
                    }

                    .header-stats {
                        display: flex;
                        gap: 20px;
                    }

                    .stat-item {
                        text-align: center;
                    }

                    .stat-number {
                        font-size: 24px;
                        font-weight: 700;
                        color: #667eea;
                    }

                    .stat-label {
                        font-size: 12px;
                        opacity: 0.8;
                    }

                    .filters {
                        background: #f8f9fa;
                        padding: 20px 30px;
                        border-bottom: 1px solid #e0e0e0;
                    }

                    .filter-row {
                        display: flex;
                        gap: 20px;
                        align-items: center;
                        flex-wrap: wrap;
                    }

                    .filter-group {
                        display: flex;
                        flex-direction: column;
                        gap: 5px;
                    }

                    .filter-label {
                        font-size: 12px;
                        font-weight: 600;
                        color: #666;
                        text-transform: uppercase;
                    }

                    .filter-select, .filter-input {
                        padding: 8px 12px;
                        border: 2px solid #e0e0e0;
                        border-radius: 6px;
                        font-size: 14px;
                        min-width: 150px;
                    }

                    .filter-select:focus, .filter-input:focus {
                        outline: none;
                        border-color: #667eea;
                    }

                    .export-btn {
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: 600;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: all 0.3s ease;
                    }

                    .export-btn:hover {
                        background: #218838;
                        transform: translateY(-2px);
                    }

                    .table-container {
                        overflow-x: auto;
                    }

                    .deduction-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 13px;
                    }

                    .deduction-table th {
                        background: #2C2C2C;
                        color: white;
                        padding: 15px 8px;
                        text-align: center;
                        font-weight: 600;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }

                    .deduction-table th.staff-column {
                        background: #667eea;
                        text-align: left;
                        min-width: 200px;
                        max-width: 200px;
                    }

                    .deduction-table th.category-header {
                        background: #1a1a1a;
                        font-size: 11px;
                        writing-mode: vertical-rl;
                        text-orientation: mixed;
                        min-width: 80px;
                        max-width: 80px;
                        position: relative;
                    }

                    .deduction-table td {
                        padding: 12px 8px;
                        text-align: center;
                        border-bottom: 1px solid #f0f0f0;
                        vertical-align: middle;
                    }

                    .staff-info {
                        text-align: left !important;
                        padding: 15px !important;
                    }

                    .staff-name {
                        font-weight: 600;
                        color: #2C2C2C;
                        font-size: 14px;
                    }

                    .staff-id {
                        color: #666;
                        font-size: 12px;
                        margin-top: 2px;
                    }

                    .staff-designation {
                        color: #667eea;
                        font-size: 11px;
                        margin-top: 2px;
                        font-style: italic;
                    }

                    .balance-amount {
                        font-weight: 600;
                        padding: 6px 10px;
                        border-radius: 4px;
                        font-size: 12px;
                        min-width: 70px;
                        display: inline-block;
                    }

                    .balance-positive {
                        background: #e8f5e8;
                        color: #28a745;
                    }

                    .balance-zero {
                        background: #f8f9fa;
                        color: #6c757d;
                    }

                    .balance-na {
                        background: #f0f0f0;
                        color: #999;
                    }

                    .summary-row {
                        background: #f8f9fa;
                        font-weight: 600;
                    }

                    .summary-row td {
                        border-top: 2px solid #2C2C2C;
                    }

                    .legend {
                        padding: 20px 30px;
                        background: #f8f9fa;
                        border-top: 1px solid #e0e0e0;
                    }

                    .legend-title {
                        font-size: 14px;
                        font-weight: 600;
                        margin-bottom: 10px;
                        color: #2C2C2C;
                    }

                    .legend-items {
                        display: flex;
                        gap: 30px;
                        flex-wrap: wrap;
                    }

                    .legend-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 12px;
                    }

                    .legend-color {
                        width: 20px;
                        height: 15px;
                        border-radius: 3px;
                    }

                    /* Responsive Design */
                    @media (max-width: 1200px) {
                        .filter-row {
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 15px;
                        }

                        .header-stats {
                            flex-direction: column;
                            gap: 10px;
                        }
                    }

                    @media (max-width: 768px) {
                        .deduction-header {
                            flex-direction: column;
                            gap: 20px;
                            text-align: center;
                        }

                        .header-stats {
                            flex-direction: row;
                            justify-content: center;
                        }

                        .deduction-table th.category-header {
                            writing-mode: horizontal-tb;
                            text-orientation: initial;
                            min-width: 60px;
                            font-size: 10px;
                        }
                    }
                </style>

                <div class="deduction-container">
                    <!-- Header Section -->
                    <div class="deduction-header">
                        <div class="header-left">
                            <div class="header-icon">
                                üìä
                            </div>
                            <div>
                                <h1 class="header-title">Deduction Balance Overview</h1>
                                <p class="header-subtitle">Track remaining balances across all deduction categories</p>
                            </div>
                        </div>
                        <div class="header-stats">
                            <div class="stat-item">
                                <div class="stat-number" id="totalStaffCount">0</div>
                                <div class="stat-label">Total Staff</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">23</div>
                                <div class="stat-label">Categories</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalBalanceAmount">‚Çπ0</div>
                                <div class="stat-label">Total Balance</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters Section -->
                    <div class="filters">
                        <div class="filter-row">
                            <div class="filter-group">
                                <label class="filter-label">Search Staff</label>
                                <input type="text" class="filter-input" id="deductionSearchInput" placeholder="Search by name or Staff ID..." oninput="filterDeductionTable()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Designation</label>
                                <select class="filter-select" id="deductionDesignationFilter" onchange="filterDeductionTable()">
                                    <option value="">All Designations</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Balance Status</label>
                                <select class="filter-select" id="deductionBalanceFilter" onchange="filterDeductionTable()">
                                    <option value="">All Statuses</option>
                                    <option value="positive">Has Balance</option>
                                    <option value="zero">Zero Balance</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Category Filter</label>
                                <select class="filter-select" id="deductionCategoryFilter" onchange="filterDeductionTable()">
                                    <option value="">All Categories</option>
                                    <option value="gpf">GPF Related</option>
                                    <option value="insurance">Insurance</option>
                                    <option value="utilities">Utilities</option>
                                    <option value="tax">Tax Related</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">Export</label>
                                <button class="export-btn" onclick="exportDeductionBalanceToExcel()">
                                    <span>üì•</span>
                                    Export Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Table Section -->
                    <div class="table-container">
                        <table class="deduction-table">
                            <thead>
                                <tr>
                                    <th class="staff-column">Staff Details</th>
                                    <th class="category-header">Wheat Advance</th>
                                    <th class="category-header">GPF Advance Recovery</th>
                                    <th class="category-header">GPF Ledger Balance</th>
                                    <th class="category-header">GPF Advance Balance</th>
                                    <th class="category-header">Bank Recovery</th>
                                    <th class="category-header">GIC</th>
                                    <th class="category-header">LIC</th>
                                    <th class="category-header">Electricity Bill</th>
                                    <th class="category-header">Water Charges</th>
                                    <th class="category-header">General Recovery</th>
                                    <th class="category-header">Leave Deductions</th>
                                    <th class="category-header">GPPC Subscription</th>
                                    <th class="category-header">GPF Extra Subscription</th>
                                    <th class="category-header">GPF Govt Contribution</th>
                                    <th class="category-header">NPS Govt Contribution</th>
                                    <th class="category-header">NPS Self Contribution</th>
                                    <th class="category-header">GPF Withdrawal</th>
                                    <th class="category-header">GPF Interest</th>
                                    <th class="category-header">Income Tax</th>
                                    <th class="category-header">Sur-charges</th>
                                    <th class="category-header">Other Ded-1</th>
                                    <th class="category-header">Other Ded-2</th>
                                    <th class="category-header">Other Ded-3</th>
                                </tr>
                            </thead>
                            <tbody id="deductionTableBody">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Legend Section -->
                    <div class="legend">
                        <div class="legend-title">Legend & Information</div>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-color balance-positive"></div>
                                <span>Remaining Balance (Amount left to be deducted)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color balance-zero"></div>
                                <span>Zero Balance (Fully recovered or no advance taken)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color balance-na"></div>
                                <span>Not Applicable (No deduction set for this category)</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load and display deduction balance data
            loadDeductionBalanceData();
        }

        function showPaySlip() {
            // Ensure data is loaded
            if (!admissions) {
                admissions = JSON.parse(localStorage.getItem('admissions')) || [];
            }
            
            // Refresh global data from localStorage
            refreshGlobalData();

            const content = document.getElementById('content');
            content.innerHTML = `
                <style>
                    .payslip-container {
                        padding: 20px;
                        max-width: 1200px;
                        margin: 0 auto;
                    }
                    
                    .payslip-header {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px;
                        border-radius: 10px;
                        margin-bottom: 30px;
                        text-align: center;
                    }
                    
                    .payslip-search {
                        background: white;
                        padding: 25px;
                        border-radius: 10px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin-bottom: 30px;
                    }
                    
                    .search-form {
                        display: flex;
                        gap: 15px;
                        align-items: end;
                        flex-wrap: wrap;
                    }
                    
                    .search-field {
                        flex: 1;
                        min-width: 200px;
                    }
                    
                    .search-field label {
                        display: block;
                        margin-bottom: 8px;
                        font-weight: 600;
                        color: #333;
                    }
                    
                    .search-field input {
                        width: 100%;
                        padding: 12px 15px;
                        border: 2px solid #e1e5e9;
                        border-radius: 8px;
                        font-size: 16px;
                        transition: border-color 0.3s;
                    }
                    
                    .search-field input:focus {
                        outline: none;
                        border-color: #667eea;
                    }
                    
                    .select-wrapper {
                        position: relative;
                        display: inline-block;
                        width: 100%;
                    }
                    
                    /* Payslip specific modern select styling */
                    .search-field .modern-select {
                        appearance: none;
                        width: 100%;
                        padding: 12px 45px 12px 16px;
                        border: 2px solid #e2e8f0;
                        border-radius: 10px;
                        font-size: 14px;
                        font-weight: 500;
                        background: #ffffff;
                        color: #1e293b;
                        cursor: pointer;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
                    }
                    
                    .search-field .modern-select:focus {
                        outline: none;
                        border-color: #2563eb;
                        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                        transform: translateY(-1px);
                    }
                    
                    .search-field .modern-select:hover {
                        border-color: #2563eb;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
                        transform: translateY(-1px);
                    }
                    
                    .search-field .select-arrow {
                        position: absolute;
                        right: 16px;
                        top: 50%;
                        transform: translateY(-50%);
                        pointer-events: none;
                        color: #2563eb;
                        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        opacity: 0.7;
                    }
                    
                    .search-field .select-wrapper:hover .select-arrow {
                        transform: translateY(-50%) rotate(180deg);
                        opacity: 1;
                    }
                    
                    .search-field .modern-select:focus + .select-arrow {
                        color: #2563eb;
                        opacity: 1;
                    }
                    
                    .search-results {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin-bottom: 30px;
                        max-height: 400px;
                        overflow: auto;
                    }
                    
                    .staff-result {
                        padding: 15px 20px;
                        border-bottom: 1px solid #eee;
                        cursor: pointer;
                        transition: background-color 0.3s;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    
                    .staff-result:hover {
                        background-color: #f8f9fa;
                    }
                    
                    .staff-result:last-child {
                        border-bottom: none;
                    }
                    
                    .staff-info h4 {
                        margin: 0 0 5px 0;
                        color: #333;
                    }
                    
                    .staff-info p {
                        margin: 0;
                        color: #666;
                        font-size: 14px;
                    }
                    
                    .payslip-document {
                        background: white;
                        border-radius: 10px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        padding: 30px;
                        margin-bottom: 30px;
                        font-family: 'Times New Roman', serif;
                    }
                    
                    .payslip-letterhead {
                        text-align: center;
                        border-bottom: 3px solid #667eea;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    
                    .payslip-letterhead h1 {
                        color: #333;
                        font-size: 28px;
                        margin-bottom: 5px;
                    }
                    
                    .payslip-letterhead h2 {
                        color: #667eea;
                        font-size: 22px;
                        margin-bottom: 10px;
                    }
                    
                    .payslip-letterhead p {
                        color: #666;
                        margin: 0;
                    }
                    
                    .payslip-section {
                        margin-bottom: 30px;
                    }
                    
                    .section-title {
                        background: #667eea;
                        color: white;
                        padding: 12px 20px;
                        margin-bottom: 15px;
                        font-size: 18px;
                        font-weight: 600;
                        border-radius: 5px;
                    }
                    
                    .info-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                    }
                    
                    .info-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 10px 0;
                        border-bottom: 1px solid #eee;
                    }
                    
                    .info-label {
                        font-weight: 600;
                        color: #333;
                    }
                    
                    .info-value {
                        color: #666;
                    }
                    
                    .salary-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                    }
                    
                    .salary-table th,
                    .salary-table td {
                        padding: 12px;
                        text-align: left;
                        border: 1px solid #ddd;
                    }
                    
                    .salary-table th {
                        background: #f8f9fa;
                        font-weight: 600;
                        color: #333;
                    }
                    
                    .salary-table .amount {
                        text-align: right;
                        font-weight: 600;
                    }
                    
                    .total-row {
                        background: #f0f8ff;
                        font-weight: 700;
                    }
                    
                    .net-salary {
                        background: #e8f5e8;
                        font-size: 18px;
                    }
                    
                    .action-buttons {
                        text-align: center;
                        margin-top: 30px;
                        padding-top: 20px;
                        border-top: 2px solid #eee;
                    }
                    
                    .btn-payslip {
                        background: #667eea;
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 6px;
                        font-size: 16px;
                        cursor: pointer;
                        margin: 0 10px;
                        transition: background-color 0.3s;
                    }
                    
                    .btn-payslip:hover {
                        background: #5a67d8;
                    }
                    
                    .btn-secondary {
                        background: #6c757d;
                    }
                    
                    .btn-secondary:hover {
                        background: #5a6268;
                    }
                    
                    .hidden {
                        display: none;
                    }
                    
                    @media print {
                        .payslip-search,
                        .search-results,
                        .action-buttons {
                            display: none !important;
                        }
                        
                        .payslip-document {
                            box-shadow: none;
                            margin: 0;
                            border: 1px solid #000;
                        }
                    }
                </style>
                
                <div class="payslip-container">
                    <div class="payslip-header">
                        <h1>üí∞ Pay Slip Generator</h1>
                        <p>Generate and print employee pay slips with comprehensive details</p>
                    </div>
                    
                    <div class="payslip-search">
                        <h3>üîç Search Staff Member</h3>
                        <div class="search-form">
                            <div class="search-field">
                                <label for="searchStaffId">Staff ID</label>
                                <input type="text" id="searchStaffId" placeholder="Enter Staff ID (e.g., CB001)" 
                                       onkeypress="return /[a-zA-Z0-9]/.test(event.key)"
                                       oninput="handleStaffIdSearchInput(this); searchStaff()">
                            </div>
                            <div class="search-field">
                                <label for="searchStaffName">Staff Name</label>
                                <input type="text" id="searchStaffName" placeholder="Enter Staff Name" 
                                       style="text-transform: capitalize;"
                                       onkeypress="return /[a-zA-Z\s]/.test(event.key)"
                                       oninput="handleStaffNameInput(this); searchStaff()">
                            </div>
                            <div class="search-field" style="min-width: 150px;">
                                <label for="payslipMonth">üìÖ Payslip Month</label>
                                <div class="select-wrapper">
                                    <select id="payslipMonth" class="modern-select" onchange="updatePayslipPeriod()">
                                        <option value="">Current Month</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                                    <span class="select-arrow">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                            <div class="search-field" style="min-width: 120px;">
                                <label for="payslipYear">üìä Payslip Year</label>
                                <div class="select-wrapper">
                                    <select id="payslipYear" class="modern-select" onchange="updatePayslipPeriod()">
                                        <option value="">Current Year</option>
                                        <option value="2025">2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                        <option value="2022">2022</option>
                                        <option value="2021">2021</option>
                                        <option value="2020">2020</option>
                                    </select>
                                    <span class="select-arrow">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="searchResults" class="search-results hidden">
                        <!-- Search results will appear here -->
                    </div>
                    
                    <div id="payslipDocument" class="payslip-document hidden">
                        <!-- Pay slip will be generated here -->
                    </div>
                </div>
            `;
            
            // Initialize search functionality
            initializePaySlipSearch();
        }
        
        function updatePayslipPeriod() {
            const payslipMonth = document.getElementById('payslipMonth').value;
            const payslipYear = document.getElementById('payslipYear').value;
            
            let periodText = 'Current Month';
            if (payslipMonth && payslipYear) {
                const monthNames = ["", "January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                periodText = `${monthNames[parseInt(payslipMonth)]} ${payslipYear}`;
            } else if (payslipMonth || payslipYear) {
                periodText = 'Please select both month and year';
            }
            
            // Update the header if it exists
            const headerText = document.querySelector('.payslip-header p');
            if (headerText) {
                headerText.textContent = `Generate payslips for ${periodText}`;
            }
            
            // Hide payslip document when period changes
            const payslipDoc = document.getElementById('payslipDocument');
            if (payslipDoc) {
                payslipDoc.classList.add('hidden');
            }
            
            // Refresh search results to show updated PS verification status
            if (document.getElementById('searchStaffId')?.value || document.getElementById('searchStaffName')?.value) {
                searchStaff();
            }
        }
        
        // Handle staff name input validation and capitalization
        function handleStaffNameInput(input) {
            let value = input.value;
            
            // Remove any non-alphabetic characters except spaces
            value = value.replace(/[^a-zA-Z\s]/g, '');
            
            // Capitalize first letter of each word
            value = value.replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
            
            // Prevent multiple consecutive spaces
            value = value.replace(/\s+/g, ' ');
            
            // Update the input value
            input.value = value;
        }

        // Handle full name input validation and capitalization for edit profile
        function handleFullNameInput(input) {
            let value = input.value;
            
            // Remove any non-alphabetic characters except spaces
            value = value.replace(/[^a-zA-Z\s]/g, '');
            
            // Capitalize first letter of each word
            value = value.replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
            
            // Prevent multiple consecutive spaces
            value = value.replace(/\s+/g, ' ');
            
            // Update the input value
            input.value = value;
        }

        // Handle username input validation for edit profile
        function handleUsernameInput(input) {
            let value = input.value;
            
            // Remove any characters that are not letters or numbers
            value = value.replace(/[^a-zA-Z0-9]/g, '');
            
            // Update the input value
            input.value = value;
        }

        // Generic search input validation - allows letters, numbers, and spaces only
        function handleSearchInput(input) {
            let value = input.value;
            
            // Remove special characters, allow only letters, numbers, and spaces
            value = value.replace(/[^a-zA-Z0-9\s]/g, '');
            
            // Prevent multiple consecutive spaces
            value = value.replace(/\s+/g, ' ');
            
            // Update the input value
            input.value = value;
        }

        // Staff ID search validation - allows letters and numbers only (no spaces)
        function handleStaffIdSearchInput(input) {
            let value = input.value;
            
            // Remove special characters and spaces, allow only letters and numbers
            value = value.replace(/[^a-zA-Z0-9]/g, '');
            
            // Convert to uppercase for consistency
            value = value.toUpperCase();
            
            // Update the input value
            input.value = value;
        }

        function initializePaySlipSearch() {
            window.searchStaff = function() {
                const staffIdInput = document.getElementById('searchStaffId').value.toLowerCase().trim();
                const staffNameInput = document.getElementById('searchStaffName').value.toLowerCase().trim();
                const searchResults = document.getElementById('searchResults');
                
                if (!staffIdInput && !staffNameInput) {
                    searchResults.classList.add('hidden');
                    return;
                }
                
                const filteredStaff = admissions.filter(staff => {
                    const matchesId = !staffIdInput || staff.staffId.toLowerCase().includes(staffIdInput);
                    const matchesName = !staffNameInput || staff.staffName.toLowerCase().includes(staffNameInput);
                    
                    // CRITICAL: Check appointment date - payslip can only be generated AFTER appointment
                    const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                    if (appointmentDate) {
                        // Get current date as default period for checking appointment eligibility
                        const currentDate = new Date();
                        const selectedMonth = currentDate.getMonth() + 1; // Current month
                        const selectedYear = currentDate.getFullYear(); // Current year
                        const selectedPeriodDate = new Date(selectedYear, selectedMonth - 1, 1);
                        
                        // Parse appointment date (handle DD-MM-YYYY format)
                        let staffAppointmentDate;
                        if (appointmentDate.includes('-')) {
                            const parts = appointmentDate.split('-');
                            if (parts.length === 3) {
                                staffAppointmentDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            }
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                        
                        // If appointment date is AFTER the selected payslip period, exclude
                        if (staffAppointmentDate && staffAppointmentDate > selectedPeriodDate) {
                            console.log(`Excluding ${staff.staffName} from payslip - appointed ${appointmentDate} after ${selectedMonth}/${selectedYear}`);
                            return false;
                        }
                    }
                    
                    return matchesId && matchesName;
                });
                
                if (filteredStaff.length > 0) {
                    // Get current payslip period
                    const payslipMonth = document.getElementById('payslipMonth').value;
                    const payslipYear = document.getElementById('payslipYear').value;
                    const currentDate = new Date();
                    const selectedMonth = payslipMonth ? parseInt(payslipMonth) : (currentDate.getMonth() + 1);
                    const selectedYear = payslipYear ? parseInt(payslipYear) : currentDate.getFullYear();
                    const periodKey = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}`;
                    
                    // Get PS verification data
                    const psVerifications = JSON.parse(localStorage.getItem('psVerifications')) || {};
                    const periodPSData = psVerifications[periodKey] || {};
                    
                    searchResults.innerHTML = filteredStaff.map(staff => {
                        const staffKey = staff.staffId || staff.id || staff.staff_id;
                        const psStatus = periodPSData[staffKey]?.status || 'pending';
                        const isApproved = psStatus === 'approved';
                        
                        const statusBadge = isApproved ? 
                            '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚úÖ Approved</span>' :
                            psStatus === 'rejected' ?
                            '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚ùå Rejected</span>' :
                            '<span style="background: #f59e0b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">‚è≥ Pending</span>';
                        
                        const clickAction = isApproved ? `generatePaySlip(${staff.id})` : `showPSValidationFromSearch('${staffKey}', '${staff.staffName}')`;
                        const clickText = isApproved ? 'Click to Generate ‚Üí' : 'PS Approval Required';
                        const clickColor = isApproved ? '#667eea' : '#ef4444';
                        
                        return `
                            <div class="staff-result" onclick="${clickAction}" style="${!isApproved ? 'opacity: 0.7; border-left: 4px solid #ef4444;' : ''}">
                                <div class="staff-info">
                                    <h4>${staff.staffName}</h4>
                                    <p>Staff ID: ${staff.staffId} | Designation: ${staff.designation}</p>
                                    <div style="margin-top: 8px;">${statusBadge}</div>
                                </div>
                                <div>
                                    <span style="color: ${clickColor}; font-weight: 600;">${clickText}</span>
                                </div>
                            </div>
                        `;
                    }).join('');
                    searchResults.classList.remove('hidden');
                } else {
                    searchResults.innerHTML = `
                        <div class="staff-result" style="text-align: center; color: #666;">
                            <p>No staff members found matching your search criteria</p>
                        </div>
                    `;
                    searchResults.classList.remove('hidden');
                }
            };
            
            window.generatePaySlip = function(staffId) {
                const staff = admissions.find(s => s.id === staffId);
                if (!staff) return;
                
                // Get selected month/year from dropdowns or use current
                const payslipMonth = document.getElementById('payslipMonth').value;
                const payslipYear = document.getElementById('payslipYear').value;
                
                const currentDate = new Date();
                const monthNames = ["January", "February", "March", "April", "May", "June",
                    "July", "August", "September", "October", "November", "December"];
                
                const selectedMonth = payslipMonth ? parseInt(payslipMonth) : (currentDate.getMonth() + 1);
                const selectedYear = payslipYear ? parseInt(payslipYear) : currentDate.getFullYear();
                
                // CRITICAL VALIDATION: Check PS Verification approval status
                const staffKey = staff.staffId || staff.id || staff.staff_id;
                const periodKey = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}`;
                
                // Get PS verification data for the selected period
                const psVerifications = JSON.parse(localStorage.getItem('psVerifications')) || {};
                const periodPSData = psVerifications[periodKey] || {};
                const psStatus = periodPSData[staffKey]?.status || 'pending';
                
                console.log('=== PS VERIFICATION VALIDATION ===');
                console.log('Staff:', staff.staffName);
                console.log('Staff Key:', staffKey);
                console.log('Period Key:', periodKey);
                console.log('PS Status:', psStatus);
                
                if (psStatus !== 'approved') {
                    const periodName = `${monthNames[selectedMonth - 1]} ${selectedYear}`;
                    showPSValidationError(staff, periodName, psStatus);
                    return; // Block payslip generation
                }
                
                console.log('‚úÖ PS Verification approved - proceeding with payslip generation');
                
                // Validate payslip date against date of appointment/joining
                const appointmentDateString = staff.dateOfAppointment || staff.dateOfJoining;
                
                // Debug logging
                console.log('=== PAYSLIP DATE VALIDATION DEBUG ===');
                console.log('Staff:', staff.staffName);
                console.log('Staff ID:', staff.staffId);
                console.log('dateOfAppointment:', staff.dateOfAppointment);
                console.log('dateOfJoining:', staff.dateOfJoining);
                console.log('Selected appointmentDateString:', appointmentDateString);
                console.log('Selected Month:', selectedMonth);
                console.log('Selected Year:', selectedYear);
                
                if (appointmentDateString) {
                    // Handle both date formats: DD/MM/YYYY and DD-MM-YYYY
                    const normalizedDateString = appointmentDateString.replace(/-/g, '/');
                    const appointmentDate = parseDDMMYYYY(normalizedDateString);
                    console.log('Normalized date string:', normalizedDateString);
                    console.log('Parsed appointment date object:', appointmentDate);
                    
                    if (appointmentDate) {
                        const appointmentMonth = appointmentDate.getMonth() + 1; // 1-based month
                        const appointmentYear = appointmentDate.getFullYear();
                        
                        console.log('Appointment Month:', appointmentMonth);
                        console.log('Appointment Year:', appointmentYear);
                        
                        // Check if payslip date is before appointment date
                        const isYearBefore = selectedYear < appointmentYear;
                        const isSameYearButMonthBefore = (selectedYear === appointmentYear && selectedMonth < appointmentMonth);
                        const shouldBlock = isYearBefore || isSameYearButMonthBefore;
                        
                        console.log('Year comparison - Selected < Appointment:', isYearBefore);
                        console.log('Month comparison - Same year but month before:', isSameYearButMonthBefore);
                        console.log('Should block payslip generation:', shouldBlock);
                        
                        if (shouldBlock) {
                            const fieldLabel = staff.dateOfAppointment ? 'appointed' : 'joined';
                            console.log('BLOCKING payslip generation!');
                            showPayslipValidationError(
                                `Cannot generate payslip for ${monthNames[selectedMonth - 1]} ${selectedYear}`,
                                `Staff member ${staff.staffName} ${fieldLabel} on ${appointmentDateString}. Payslip can only be generated from ${monthNames[appointmentMonth - 1]} ${appointmentYear} onwards.`
                            );
                            return;
                        } else {
                            console.log('ALLOWING payslip generation - date is valid');
                        }
                    } else {
                        console.log('Could not parse appointment date:', appointmentDateString);
                    }
                } else {
                    console.log('No appointment/joining date found for staff member');
                }
                console.log('=== END VALIDATION DEBUG ===');
                const currentMonth = monthNames[selectedMonth - 1];
                const currentYear = selectedYear;
                
                // Get salary components from actual staff data (no hardcoded values)
                const basicSalary = parseFloat(staff.basicSalary) || 0;
                
                // Get attendance data for the selected month/year
                const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
                const attendanceRecord = savedRecords.find(record => 
                    record.staffId === staff.staffId && 
                    parseInt(record.month) === selectedMonth && 
                    parseInt(record.year) === selectedYear
                );
                
                const daysWorked = attendanceRecord ? parseInt(attendanceRecord.daysPresent) : 0;
                const maxDaysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
                
                // Only use actual data from staff record - no hardcoded calculations
                const daPercentage = parseFloat(staff.da) || 0;
                const hraPercentage = parseFloat(staff.hra) || 0;
                const daAmount = daPercentage > 0 ? Math.round(basicSalary * daPercentage / 100) : 0;
                const hraAmount = hraPercentage > 0 ? Math.round(basicSalary * hraPercentage / 100) : 0;
                const specialPay = parseFloat(staff.specialPay) || 0;
                const specialAllowance = parseFloat(staff.specialAllowance) || 0;
                const otherAllowance = parseFloat(staff.otherAllowance) || 0;
                
                const grossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
                
                // Debug logging for salary calculation
                console.log('showPaySlip - Salary Calculation Debug:', {
                    staffId: staff.staffId,
                    basicSalary: basicSalary,
                    daPercentage: daPercentage,
                    hraPercentage: hraPercentage,
                    daAmount: daAmount,
                    hraAmount: hraAmount, 
                    specialPay: specialPay,
                    specialAllowance: specialAllowance,
                    otherAllowance: otherAllowance,
                    grossSalary: grossSalary,
                    calculation: `${basicSalary} + ${daAmount} + ${hraAmount} + ${specialPay} + ${specialAllowance} + ${otherAllowance} = ${grossSalary}`,
                    rawStaffData: {
                        'staff.da': staff.da,
                        'staff.hra': staff.hra,
                        'staff.specialPay': staff.specialPay,
                        'staff.specialAllowance': staff.specialAllowance,
                        'staff.otherAllowance': staff.otherAllowance
                    },
                    fullStaffRecord: staff
                });
                
                // Update deduction balances for this month
                updateDeductionBalances(staff.staffId, selectedMonth, selectedYear);
                
                // Get deductions from staffDeductions object or use sample values
                const staffDeductionData = staffDeductions[staff.staffId] || {};
                
                // Get monthly deduction amounts for pay slip display
                // Show deduction if monthly amount > 0 (regardless of total balance)
                const wheatAdvanceMonthly = parseFloat(staffDeductionData.wheatAdvanceRecovered) || 0;
                const wheatAdvance = wheatAdvanceMonthly;
                
                const gicMonthly = parseFloat(staffDeductionData.gicMonthly) || 0;
                const gic = gicMonthly;
                
                const licMonthly = parseFloat(staffDeductionData.licMonthly) || 0;
                const lic = licMonthly;
                
                const electricityBillMonthly = parseFloat(staffDeductionData.electricityBillMonthly) || 0;
                const electricityBill = electricityBillMonthly;
                
                const waterChargesMonthly = parseFloat(staffDeductionData.waterChargesMonthly) || 0;
                const waterCharges = waterChargesMonthly;
                
                const recoveryMonthly = parseFloat(staffDeductionData.recoveryMonthly) || 0;
                const recovery = recoveryMonthly;
                
                const leaveDeductions = parseFloat(staffDeductionData.leaveDeductionsMonthly) || 0;
                
                const gppcSubscription = parseFloat(staffDeductionData.gppcSubscriptionMonthly) || 0;
                
                const gpfExtraSubscription = parseFloat(staffDeductionData.gpfExtraSubscriptionMonthly) || 0;
                
                const gpfGovernmentContribution = parseFloat(staffDeductionData.gpfGovernmentContributionMonthly) || 0;
                
                const gpfAdvanceRecovery = parseFloat(staffDeductionData.gpfAdvanceRecoveryRecovered) || 0;
                
                const npsGovernmentContribution = parseFloat(staffDeductionData.npsGovernmentContributionMonthly) || 0;
                
                const npsSelfContribution = parseFloat(staffDeductionData.npsSelfContributionMonthly) || 0;
                
                const gpfWithdrawl = parseFloat(staffDeductionData.gpfWithdrawlMonthly) || 0;
                
                const gpfInterest = parseFloat(staffDeductionData.gpfInterestMonthly) || 0;
                
                const bankRecovery = parseFloat(staffDeductionData.bankRecoveryPaid) || 0;
                
                const incomeTax = parseFloat(staffDeductionData.incomeTaxMonthly) || 0;
                
                const surCharges = parseFloat(staffDeductionData.surChargesMonthly) || 0;
                
                const otherDeduction1 = parseFloat(staffDeductionData.otherDeduction1Monthly) || 0;
                
                const otherDeduction2 = parseFloat(staffDeductionData.otherDeduction2Monthly) || 0;
                
                const otherDeduction3 = parseFloat(staffDeductionData.otherDeduction3Monthly) || 0;
                
                const gpfLedBalance = parseFloat(staffDeductionData.gpfLedBalanceCurrent) || 0;
                
                const gpfAdvanceBalance = parseFloat(staffDeductionData.gpfAdvanceBalanceRecovery) || 0;
                
                // Use the simple "Total monthly deductions" from Deduction Management popup
                const totalDeductions = parseFloat(staffDeductionData.totalMonthlyDeductions) || 0;
                
                // Calculate net salary
                const netSalary = grossSalary - totalDeductions;
                
                const payslipDocument = document.getElementById('payslipDocument');
                payslipDocument.innerHTML = `
                    <div class="payslip-letterhead">
                        <h1>CANTONMENT BOARD AMBALA</h1>
                        <h2>PAY SLIP</h2>
                        <p>For the month of ${currentMonth} ${currentYear}</p>
                        <p style="margin-top: 10px; font-weight: bold; color: #1976d2;">Employee: ${staff.staffName}</p>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="section-title">üë§ Basic Information</div>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Staff ID:</span>
                                <span class="info-value">${staff.staffId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Staff Name:</span>
                                <span class="info-value">${staff.staffName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Father's Name:</span>
                                <span class="info-value">${staff.fatherName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Designation:</span>
                                <span class="info-value">${staff.designation}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Date of Birth:</span>
                                <span class="info-value">${formatDateForDisplay(staff.dateOfBirth)}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Date of Joining:</span>
                                <span class="info-value">${staff.dateOfAppointment ? (staff.dateOfAppointment.includes('/') ? staff.dateOfAppointment : new Date(staff.dateOfAppointment).toLocaleDateString()) : 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Mobile Number:</span>
                                <span class="info-value">${staff.mobileNumber}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value">${staff.emailId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Present Address:</span>
                                <span class="info-value">${staff.presentAddress}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Bank Name:</span>
                                <span class="info-value">${staff.bankName}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Account Number:</span>
                                <span class="info-value">${staff.accountNumber}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">IFSC Code:</span>
                                <span class="info-value">${staff.ifscCode}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">MICR Code:</span>
                                <span class="info-value">${staff.micrCode || 'N/A'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Days Worked:</span>
                                <span class="info-value">${daysWorked} / ${maxDaysInMonth}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="section-title">üí∞ Salary Structure & Earnings</div>
                        <table class="salary-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th class="amount">Amount (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Basic Pay</td><td class="amount">${basicSalary.toLocaleString()}</td></tr>
                                <tr><td>Dearness Allowance (${daPercentage}%)</td><td class="amount">${daAmount.toLocaleString()}</td></tr>
                                <tr><td>HRA (${hraPercentage}%)</td><td class="amount">${hraAmount.toLocaleString()}</td></tr>
                                ${specialPay > 0 ? `<tr><td>Special Pay</td><td class="amount">${specialPay.toLocaleString()}</td></tr>` : ''}
                                ${specialAllowance > 0 ? `<tr><td>Special Allowance</td><td class="amount">${specialAllowance.toLocaleString()}</td></tr>` : ''}
                                ${otherAllowance > 0 ? `<tr><td>Other Allowance</td><td class="amount">${otherAllowance.toLocaleString()}</td></tr>` : ''}
                                <tr class="total-row">
                                    <td><strong>Gross Salary</strong></td>
                                    <td class="amount"><strong>‚Çπ${grossSalary.toLocaleString()}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            <em>Note: Allowances include DA, HRA, and other allowances as per staff record</em>
                        </p>
                    </div>
                    
                    <div class="payslip-section">
                        <div class="section-title" style="margin-top: 120px;">üí∏ Deductions</div>
                        <table class="salary-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th class="amount">Amount (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${wheatAdvance > 0 ? `<tr><td>Wheat Advance</td><td class="amount">${wheatAdvance.toLocaleString()}</td></tr>` : ''}
                                ${gic > 0 ? `<tr><td>GIC (General Insurance Corporation)</td><td class="amount">${gic.toLocaleString()}</td></tr>` : ''}
                                ${lic > 0 ? `<tr><td>LIC (Life Insurance Corporation)</td><td class="amount">${lic.toLocaleString()}</td></tr>` : ''}
                                ${electricityBill > 0 ? `<tr><td>Electricity Bill</td><td class="amount">${electricityBill.toLocaleString()}</td></tr>` : ''}
                                ${waterCharges > 0 ? `<tr><td>Water Charges</td><td class="amount">${waterCharges.toLocaleString()}</td></tr>` : ''}
                                ${recovery > 0 ? `<tr><td>General Recovery</td><td class="amount">${recovery.toLocaleString()}</td></tr>` : ''}
                                ${leaveDeductions > 0 ? `<tr><td>Leave Deductions</td><td class="amount">${leaveDeductions.toLocaleString()}</td></tr>` : ''}
                                ${gppcSubscription > 0 ? `<tr><td>GPPC Subscription</td><td class="amount">${gppcSubscription.toLocaleString()}</td></tr>` : ''}
                                ${gpfExtraSubscription > 0 ? `<tr><td>GPF Extra Subscription</td><td class="amount">${gpfExtraSubscription.toLocaleString()}</td></tr>` : ''}
                                ${gpfGovernmentContribution > 0 ? `<tr><td>GPF Government Contribution</td><td class="amount">${gpfGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                ${gpfAdvanceRecovery > 0 ? `<tr><td>GPF Advance Recovery</td><td class="amount">${gpfAdvanceRecovery.toLocaleString()}</td></tr>` : ''}
                                ${npsGovernmentContribution > 0 ? `<tr><td>NPS Government Contribution</td><td class="amount">${npsGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                ${npsSelfContribution > 0 ? `<tr><td>NPS Self Contribution</td><td class="amount">${npsSelfContribution.toLocaleString()}</td></tr>` : ''}
                                ${gpfWithdrawl > 0 ? `<tr><td>GPF Withdrawal</td><td class="amount">${gpfWithdrawl.toLocaleString()}</td></tr>` : ''}
                                ${gpfInterest > 0 ? `<tr><td>GPF Interest</td><td class="amount">${gpfInterest.toLocaleString()}</td></tr>` : ''}
                                ${bankRecovery > 0 ? `<tr><td>Bank Recovery</td><td class="amount">${bankRecovery.toLocaleString()}</td></tr>` : ''}
                                ${incomeTax > 0 ? `<tr><td>Income Tax</td><td class="amount">${incomeTax.toLocaleString()}</td></tr>` : ''}
                                ${surCharges > 0 ? `<tr><td>Sur-charges</td><td class="amount">${surCharges.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction1 > 0 ? `<tr><td>Other Deduction-1</td><td class="amount">${otherDeduction1.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction2 > 0 ? `<tr><td>Other Deduction-2</td><td class="amount">${otherDeduction2.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction3 > 0 ? `<tr><td>Other Deduction-3</td><td class="amount">${otherDeduction3.toLocaleString()}</td></tr>` : ''}
                                ${gpfLedBalance > 0 ? `<tr><td>GPF LED Balance</td><td class="amount">${gpfLedBalance.toLocaleString()}</td></tr>` : ''}
                                ${gpfAdvanceBalance > 0 ? `<tr><td>GPF Advance Balance</td><td class="amount">${gpfAdvanceBalance.toLocaleString()}</td></tr>` : ''}
                                <tr class="total-row">
                                    <td><strong>Total Deductions</strong></td>
                                    <td class="amount"><strong>‚Çπ${totalDeductions.toLocaleString()}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="payslip-section">
                        <table class="salary-table">
                            <tbody>
                                <tr class="net-salary">
                                    <td><strong>NET SALARY</strong></td>
                                    <td class="amount"><strong>‚Çπ${netSalary.toLocaleString()}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn-payslip" onclick="printPaySlip()">üñ®Ô∏è Print Pay Slip</button>
                        <button class="btn-payslip btn-secondary" onclick="downloadPaySlip('${staff.staffName}', '${currentMonth}_${currentYear}')">üìÑ Download PDF</button>
                        <button class="btn-payslip btn-secondary" onclick="clearPaySlip()">üîÑ Clear & Search Again</button>
                    </div>
                `;
                
                payslipDocument.classList.remove('hidden');
                
                // Clear search results
                document.getElementById('searchResults').classList.add('hidden');
                
                // Scroll to pay slip
                payslipDocument.scrollIntoView({ behavior: 'smooth' });
            };
            
            window.printPaySlip = function() {
                const payslipElement = document.getElementById('payslipDocument');
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title> </title>
                        <style>
                            body { font-family: 'Times New Roman', serif; margin: 20px; }
                            .payslip-letterhead { text-align: center; border-bottom: 3px solid #667eea; padding-bottom: 20px; margin-bottom: 30px; }
                            .section-title { background: #667eea; color: white; padding: 12px 20px; margin-bottom: 15px; font-size: 18px; font-weight: 600; margin-top: 120px; }
                            .section-title:first-of-type { margin-top: 0; }
                            .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
                            .info-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
                            .salary-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                            .salary-table th, .salary-table td { padding: 12px; text-align: left; border: 1px solid #ddd; }
                            .salary-table th { background: #f8f9fa; font-weight: 600; }
                            .amount { text-align: right; font-weight: 600; }
                            .total-row { background: #f0f8ff; font-weight: 700; }
                            .net-salary { background: #e8f5e8; font-size: 18px; }
                            .action-buttons { display: none; }
                            @media print {
                                @page {
                                    margin: 0;
                                    size: auto;
                                }
                                body {
                                    margin: 15mm;
                                }
                                .action-buttons { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${payslipElement.innerHTML}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.focus();
                
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 100);
            };
            
            // Function to trim white space from canvas
            function trimCanvas(canvas) {
                const ctx = canvas.getContext('2d');
                const pixels = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = pixels.data;
                
                let minX = canvas.width;
                let minY = canvas.height;
                let maxX = 0;
                let maxY = 0;
                
                // Find the bounds of non-transparent pixels
                for (let y = 0; y < canvas.height; y++) {
                    for (let x = 0; x < canvas.width; x++) {
                        const index = (y * canvas.width + x) * 4;
                        const alpha = data[index + 3];
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // Check if pixel is not white/transparent
                        if (alpha > 0 && (r < 250 || g < 250 || b < 250)) {
                            minX = Math.min(minX, x);
                            minY = Math.min(minY, y);
                            maxX = Math.max(maxX, x);
                            maxY = Math.max(maxY, y);
                        }
                    }
                }
                
                // Add small padding
                const padding = 20;
                minX = Math.max(0, minX - padding);
                minY = Math.max(0, minY - padding);
                maxX = Math.min(canvas.width, maxX + padding);
                maxY = Math.min(canvas.height, maxY + padding);
                
                // Create trimmed canvas
                const trimmedWidth = maxX - minX;
                const trimmedHeight = maxY - minY;
                
                const trimmedCanvas = document.createElement('canvas');
                trimmedCanvas.width = trimmedWidth;
                trimmedCanvas.height = trimmedHeight;
                const trimmedCtx = trimmedCanvas.getContext('2d');
                
                trimmedCtx.drawImage(canvas, minX, minY, trimmedWidth, trimmedHeight, 0, 0, trimmedWidth, trimmedHeight);
                
                return trimmedCanvas;
            }

            window.downloadPaySlip = function(staffName, period) {
                const payslipElement = document.getElementById('payslipDocument');
                
                // Show loading indicator
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'pdfLoadingOverlay';
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.8);
                    z-index: 999999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                `;
                
                loadingOverlay.innerHTML = `
                    <div style="
                        background: white;
                        padding: 30px;
                        border-radius: 15px;
                        text-align: center;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <div style="
                            width: 50px;
                            height: 50px;
                            border: 4px solid #f3f3f3;
                            border-top: 4px solid #1976d2;
                            border-radius: 50%;
                            animation: spin 1s linear infinite;
                            margin: 0 auto 20px auto;
                        "></div>
                        <h3 style="margin: 0; color: #333; font-size: 18px;">Generating PDF...</h3>
                        <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">Please wait while we prepare your payslip</p>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                
                document.body.appendChild(loadingOverlay);
                
                // Hide action buttons temporarily
                const actionButtons = payslipElement.querySelectorAll('.action-buttons');
                actionButtons.forEach(btn => btn.style.display = 'none');
                
                // Small delay to ensure layout is fully rendered
                setTimeout(() => {
                    // Create a temporary white background container (hidden)
                    const tempContainer = document.createElement('div');
                    tempContainer.style.cssText = `
                        position: fixed;
                        top: -10000px;
                        left: -10000px;
                        width: 1000px;
                        height: auto;
                        background: white;
                        z-index: -1;
                        overflow: visible;
                        padding: 20px;
                        box-sizing: border-box;
                        opacity: 0;
                        pointer-events: none;
                    `;
                    
                    // Clone the payslip element
                    const payslipClone = payslipElement.cloneNode(true);
                    payslipClone.style.cssText = `
                        background: white !important;
                        margin: 0;
                        padding: 30px;
                        box-shadow: none;
                        border-radius: 0;
                    `;
                    
                    // Force white background on all child elements
                    const allChildren = payslipClone.querySelectorAll('*');
                    allChildren.forEach(child => {
                        const computedStyle = window.getComputedStyle(child);
                        if (computedStyle.backgroundColor && 
                            computedStyle.backgroundColor !== 'rgba(0, 0, 0, 0)' && 
                            computedStyle.backgroundColor !== 'transparent' &&
                            computedStyle.backgroundColor !== 'white' &&
                            computedStyle.backgroundColor !== 'rgb(255, 255, 255)') {
                            child.style.backgroundColor = 'white';
                        }
                    });
                    
                    tempContainer.appendChild(payslipClone);
                    document.body.appendChild(tempContainer);
                    
                    // Ensure element is fully rendered and get accurate dimensions
                    const elementHeight = payslipClone.scrollHeight;
                    const elementWidth = payslipClone.scrollWidth || 800;
                    
                    console.log('Capturing element:', { width: elementWidth, height: elementHeight });
                    
                    // Use html2canvas to capture the clean white version
                html2canvas(payslipClone, {
                    backgroundColor: 'white',
                    scale: 4,
                    useCORS: true,
                    allowTaint: false,
                    width: elementWidth,
                    height: elementHeight,
                    dpi: 300,
                    letterRendering: true,
                    logging: false,
                    imageTimeout: 15000,
                    removeContainer: true
                }).then(function(canvas) {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    
                    // A4 dimensions in mm
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 10;
                    const contentWidth = pageWidth - (margin * 2);
                    const contentHeight = pageHeight - (margin * 2);
                    
                    // Calculate scaling to fit content naturally on page
                    const pixelsPerMM = canvas.width / (elementWidth * 0.264583); // Convert px to mm
                    const naturalWidth = canvas.width / pixelsPerMM;
                    const naturalHeight = canvas.height / pixelsPerMM;
                    
                    let imgWidth = Math.min(naturalWidth, contentWidth);
                    let imgHeight = (imgWidth / naturalWidth) * naturalHeight;
                    
                    // If still too tall, scale down to fit height
                    if (imgHeight > contentHeight) {
                        imgHeight = contentHeight;
                        imgWidth = (imgHeight / naturalHeight) * naturalWidth;
                    }
                    
                    // Center the content
                    const x = (pageWidth - imgWidth) / 2;
                    const y = margin;
                    
                    // Add to PDF
                    if (imgHeight <= contentHeight) {
                        // Fits on one page
                        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
                    } else {
                        // Multiple pages needed
                        let currentY = 0;
                        let pageNumber = 0;
                        
                        while (currentY < imgHeight) {
                            if (pageNumber > 0) {
                                pdf.addPage();
                            }
                            
                            const remainingHeight = imgHeight - currentY;
                            const pageHeight = Math.min(remainingHeight, contentHeight);
                            const sourceY = (currentY / imgHeight) * canvas.height;
                            const sourceHeight = (pageHeight / imgHeight) * canvas.height;
                            
                            // Create section for this page
                            const pageCanvas = document.createElement('canvas');
                            pageCanvas.width = canvas.width;
                            pageCanvas.height = sourceHeight;
                            const pageCtx = pageCanvas.getContext('2d');
                            
                            pageCtx.drawImage(canvas, 0, sourceY, canvas.width, sourceHeight, 0, 0, canvas.width, sourceHeight);
                            
                            const pageImgData = pageCanvas.toDataURL('image/png');
                            pdf.addImage(pageImgData, 'JPEG', x, margin, imgWidth, pageHeight);
                            
                            currentY += pageHeight;
                            pageNumber++;
                        }
                    }
                    
                    pdf.save(`PaySlip_${staffName.replace(/\s+/g, '_')}_${period}.pdf`);
                    
                    // Remove temporary container
                    document.body.removeChild(tempContainer);
                    
                    // Remove loading overlay
                    document.body.removeChild(loadingOverlay);
                    
                    // Restore action buttons
                    actionButtons.forEach(btn => btn.style.display = '');
                    
                }).catch(function(error) {
                    console.error('Error generating PDF:', error);
                    
                    // Remove temporary container on error
                    if (tempContainer && document.body.contains(tempContainer)) {
                        document.body.removeChild(tempContainer);
                    }
                    
                    // Remove loading overlay on error
                    if (loadingOverlay && document.body.contains(loadingOverlay)) {
                        document.body.removeChild(loadingOverlay);
                    }
                    
                    // Restore action buttons on error
                    actionButtons.forEach(btn => btn.style.display = '');
                });
                
                }, 200); // End of setTimeout
            };
            
            window.verifyCalculation = function(staffId) {
                const staff = admissions.find(s => s.staffId === staffId);
                if (!staff) return;
                
                refreshGlobalData();
                const staffDeductionData = staffDeductions[staff.staffId] || {};
                
                // Get salary components from actual staff data (no hardcoded values)
                const basicSalary = parseFloat(staff.basicSalary) || 0;
                
                // Only use actual data from staff record - no hardcoded calculations
                const daPercentage = parseFloat(staff.da) || 0;
                const hraPercentage = parseFloat(staff.hra) || 0;
                const daAmount = daPercentage > 0 ? Math.round(basicSalary * daPercentage / 100) : 0;
                const hraAmount = hraPercentage > 0 ? Math.round(basicSalary * hraPercentage / 100) : 0;
                const specialPay = parseFloat(staff.specialPay) || 0;
                const specialAllowance = parseFloat(staff.specialAllowance) || 0;
                const otherAllowance = parseFloat(staff.otherAllowance) || 0;
                
                const grossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
                
                // Debug logging for salary calculation
                console.log('verifyCalculation - Salary Calculation Debug:', {
                    staffId: staffId,
                    basicSalary: basicSalary,
                    daAmount: daAmount,
                    hraAmount: hraAmount, 
                    specialPay: specialPay,
                    specialAllowance: specialAllowance,
                    otherAllowance: otherAllowance,
                    grossSalary: grossSalary,
                    calculation: `${basicSalary} + ${daAmount} + ${hraAmount} + ${specialPay} + ${specialAllowance} + ${otherAllowance} = ${grossSalary}`
                });
                
                const deductionBreakdown = {
                    'Wheat Advance': parseFloat(staffDeductionData.wheatAdvance) || 0,
                    'GIC': parseFloat(staffDeductionData.gic) || 0,
                    'LIC': parseFloat(staffDeductionData.lic) || 0,
                    'Electricity Bill': parseFloat(staffDeductionData.electricityBill) || 0,
                    'Water Charges': parseFloat(staffDeductionData.waterCharges) || 0,
                    'Recovery': parseFloat(staffDeductionData.recovery) || 0,
                    'Leave Deductions': parseFloat(staffDeductionData.leaveDeductions) || 0,
                    'GPPC Subscription': parseFloat(staffDeductionData.gppcSubscription) || 0,
                    'GPF Extra Subscription': parseFloat(staffDeductionData.gpfExtraSubscription) || 0,
                    'GPF Government Contribution': parseFloat(staffDeductionData.gpfGovernmentContribution) || 0,
                    'GPF Advance Recovery': parseFloat(staffDeductionData.gpfAdvanceRecovery) || 0,
                    'NPS Government Contribution': parseFloat(staffDeductionData.npsGovernmentContribution) || 0,
                    'NPS Self Contribution': parseFloat(staffDeductionData.npsSelfContribution) || 0,
                    'GPF Withdrawal': parseFloat(staffDeductionData.gpfWithdrawl) || 0,
                    'GPF Interest': parseFloat(staffDeductionData.gpfInterest) || 0,
                    'Bank Recovery': parseFloat(staffDeductionData.bankRecovery) || 0,
                    'Income Tax': parseFloat(staffDeductionData.incomeTax) || 0,
                    'Sur-charges': parseFloat(staffDeductionData.surCharges) || 0,
                    'Other Deduction-1': parseFloat(staffDeductionData.otherDeduction1) || 0,
                    'Other Deduction-2': parseFloat(staffDeductionData.otherDeduction2) || 0,
                    'Other Deduction-3': parseFloat(staffDeductionData.otherDeduction3) || 0,
                    'GPF LED Balance': parseFloat(staffDeductionData.gpfLedBalance) || 0,
                    'GPF Advance Balance': parseFloat(staffDeductionData.gpfAdvanceBalance) || 0
                };
                
                let calculationDetails = 'SALARY & DEDUCTION CALCULATION BREAKDOWN\\n';
                calculationDetails += '=====================================\\n';
                calculationDetails += 'SALARY COMPONENTS:\\n';
                calculationDetails += `Basic Pay: ‚Çπ${basicSalary.toLocaleString()}\\n`;
                calculationDetails += `Dearness Allowance (${daPercentage}%): ‚Çπ${daAmount.toLocaleString()}\\n`;
                calculationDetails += `HRA (${hraPercentage}%): ‚Çπ${hraAmount.toLocaleString()}\\n`;
                calculationDetails += `Special Pay: ‚Çπ${specialPay.toLocaleString()}\\n`;
                calculationDetails += `Special Allowance: ‚Çπ${specialAllowance.toLocaleString()}\\n`;
                calculationDetails += `Other Allowance: ‚Çπ${otherAllowance.toLocaleString()}\\n`;
                calculationDetails += `GROSS SALARY: ‚Çπ${grossSalary.toLocaleString()}\\n`;
                calculationDetails += '=====================================\\n';
                calculationDetails += 'DEDUCTIONS:\\n';
                let runningTotal = 0;
                
                Object.entries(deductionBreakdown).forEach(([key, value]) => {
                    if (value > 0) {
                        calculationDetails += `${key}: ‚Çπ${value.toLocaleString()}\\n`;
                        runningTotal += value;
                    }
                });
                
                calculationDetails += '=====================================\\n';
                calculationDetails += `TOTAL DEDUCTIONS: ‚Çπ${runningTotal.toLocaleString()}\\n`;
                calculationDetails += `GROSS SALARY: ‚Çπ${grossSalary.toLocaleString()}\\n`;
                calculationDetails += `NET SALARY: ‚Çπ${(grossSalary - runningTotal).toLocaleString()}\\n`;
                calculationDetails += '=====================================\\n';
                
                alert(calculationDetails);
            };
            
            window.clearPaySlip = function() {
                document.getElementById('payslipDocument').classList.add('hidden');
                document.getElementById('searchStaffId').value = '';
                document.getElementById('searchStaffName').value = '';
                document.getElementById('searchResults').classList.add('hidden');
            };
        }

        // Debug function to check attendance records (call from console)
        window.debugAttendanceRecords = function() {
            const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            console.log('=== ATTENDANCE RECORDS DEBUG ===');
            console.log('Total Records:', savedAttendanceRecords.length);
            console.log('Records:', savedAttendanceRecords);
            savedAttendanceRecords.forEach((record, index) => {
                console.log(`Record ${index + 1}:`, {
                    staffId: record.staffId,
                    month: record.month,
                    year: record.year,
                    daysPresent: record.daysPresent,
                    daysAbsent: record.daysAbsent
                });
            });
            return savedAttendanceRecords;
        }

        // Debug function to check staff salary data (call from console)
        window.debugStaffSalaryData = function(staffId) {
            const staff = admissions.find(a => a.staffId === staffId);
            if (staff) {
                console.log('=== STAFF SALARY DATA DEBUG ===');
                console.log('Staff ID:', staffId);
                console.log('Basic Salary:', staff.basicSalary);
                console.log('DA Percentage:', staff.da);
                console.log('HRA Percentage:', staff.hra);
                console.log('Special Pay:', staff.specialPay);
                console.log('Special Allowance:', staff.specialAllowance);
                console.log('Other Allowance:', staff.otherAllowance);
                console.log('Full Staff Record:', staff);
                console.log('Available Field Names:', Object.keys(staff));
                return staff;
            } else {
                console.log('Staff not found with ID:', staffId);
                console.log('Available staff IDs:', admissions.map(a => a.staffId));
                return null;
            }
        };

        // Function to refresh Pay Slip in real-time when data changes
        function refreshPaySlipIfVisible() {
            // Check if Pay Slip is currently visible
            const payslipDocument = document.getElementById('payslipDocument');
            if (payslipDocument && !payslipDocument.classList.contains('hidden')) {
                // Get the currently displayed staff ID from the pay slip
                const payslipContent = payslipDocument.innerHTML;
                const staffIdMatch = payslipContent.match(/Staff ID:\s*([A-Z0-9]+)/);
                
                if (staffIdMatch) {
                    const currentStaffId = staffIdMatch[1];
                    console.log('Real-time Pay Slip update for Staff ID:', currentStaffId);
                    
                    // Refresh global data first
                    refreshGlobalData();
                    
                    // Find the staff member and regenerate pay slip
                    const staff = admissions.find(a => a.staffId === currentStaffId);
                    if (staff) {
                        // Debug logging for staff data being read
                        console.log('refreshPaySlipIfVisible - Staff Data Debug:', {
                            staffId: staff.staffId,
                            basicSalary: staff.basicSalary,
                            da: staff.da,
                            hra: staff.hra,
                            specialPay: staff.specialPay,
                            specialAllowance: staff.specialAllowance,
                            otherAllowance: staff.otherAllowance,
                            fullStaffRecord: staff
                        });
                        
                        // Regenerate the pay slip with updated data
                        generatePaySlipForStaff(staff);
                    }
                }
            }
        }

        // Show PS verification validation error modal for payslip generation
        function showPSValidationError(staff, periodName, currentStatus) {
            const statusDisplay = currentStatus === 'pending' ? 'Pending Verification' : 
                                  currentStatus === 'rejected' ? 'Rejected' : 'Not Approved';
            
            const statusColor = currentStatus === 'pending' ? '#f59e0b' : '#ef4444';
            const statusIcon = currentStatus === 'pending' ? '‚è≥' : '‚ùå';
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'psValidationErrorModal';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Create modal content
            modalOverlay.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9);
                    animation: modalAppear 0.3s ease-out forwards;
                    text-align: center;
                ">
                    <div style="
                        width: 64px;
                        height: 64px;
                        background: linear-gradient(135deg, ${statusColor} 0%, ${statusColor}dd 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 24px auto;
                        font-size: 28px;
                    ">${statusIcon}</div>
                    
                    <h3 style="
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        margin: 0 0 12px 0;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    ">Payslip Generation Blocked</h3>
                    
                    <p style="
                        color: #6b7280;
                        font-size: 16px;
                        line-height: 1.6;
                        margin: 0 0 20px 0;
                    ">PS Verification approval is required before generating payslips.</p>
                    
                    <div style="
                        background: #fef3c7;
                        border: 1px solid #fcd34d;
                        border-radius: 8px;
                        padding: 20px;
                        margin: 20px 0;
                        text-align: left;
                    ">
                        <div style="color: #92400e; font-size: 14px; margin-bottom: 12px;">
                            <strong>Staff Details:</strong>
                        </div>
                        <div style="color: #1f2937; font-size: 14px; margin-bottom: 8px;">
                            <strong>Name:</strong> ${staff.staffName || staff.name || 'N/A'}
                        </div>
                        <div style="color: #1f2937; font-size: 14px; margin-bottom: 8px;">
                            <strong>Staff ID:</strong> ${staff.staffId || staff.id || 'N/A'}
                        </div>
                        <div style="color: #1f2937; font-size: 14px; margin-bottom: 8px;">
                            <strong>Period:</strong> ${periodName}
                        </div>
                        <div style="color: ${statusColor}; font-size: 14px; font-weight: 600;">
                            <strong>PS Status:</strong> ${statusDisplay}
                        </div>
                    </div>
                    
                    <div style="
                        background: #e5f3ff;
                        border: 1px solid #b3d9ff;
                        border-radius: 8px;
                        padding: 16px;
                        margin: 20px 0;
                        text-align: left;
                    ">
                        <div style="color: #1e40af; font-size: 14px; font-weight: 600; margin-bottom: 8px;">
                            üìã Required Action:
                        </div>
                        <div style="color: #1e40af; font-size: 14px;">
                            Go to <strong>PS Verification</strong> tab and approve this staff member's payslip for <strong>${periodName}</strong> before generating the payslip.
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 24px;">
                        <button onclick="closePSValidationModal()" style="
                            background: #6b7280;
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        " onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                            Close
                        </button>
                        <button onclick="closePSValidationModal(); showSection('ps-verification')" style="
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            Go to PS Verification
                        </button>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes modalAppear {
                        from { 
                            transform: scale(0.9) translateY(20px); 
                            opacity: 0; 
                        }
                        to { 
                            transform: scale(1) translateY(0); 
                            opacity: 1; 
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Close modal when clicking overlay
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closePSValidationModal();
                }
            });
        }
        
        // Close PS validation modal
        function closePSValidationModal() {
            const modal = document.getElementById('psValidationErrorModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-in';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        // Show PS validation error from search results
        function showPSValidationFromSearch(staffKey, staffName) {
            // Find the staff object
            const staff = admissions.find(s => (s.staffId || s.id || s.staff_id) === staffKey);
            if (!staff) return;
            
            // Get current payslip period
            const payslipMonth = document.getElementById('payslipMonth').value;
            const payslipYear = document.getElementById('payslipYear').value;
            const currentDate = new Date();
            const selectedMonth = payslipMonth ? parseInt(payslipMonth) : (currentDate.getMonth() + 1);
            const selectedYear = payslipYear ? parseInt(payslipYear) : currentDate.getFullYear();
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const periodName = `${monthNames[selectedMonth - 1]} ${selectedYear}`;
            
            // Get PS verification status
            const periodKey = `${selectedYear}-${selectedMonth.toString().padStart(2, '0')}`;
            const psVerifications = JSON.parse(localStorage.getItem('psVerifications')) || {};
            const periodPSData = psVerifications[periodKey] || {};
            const psStatus = periodPSData[staffKey]?.status || 'pending';
            
            // Show validation error modal
            showPSValidationError(staff, periodName, psStatus);
        }

        // PS Verification Function
        async function showPSVerification() {
            // Clean up any existing hardcoded migration data first
            cleanupHardcodedData();
            
            // Initialize staff deductions (no sample data)
            initializeStaffDeductions();
            
            // Ensure data is loaded - prioritize existing staff records
            if (!admissions || admissions.length === 0) {
                const storedAdmissions = JSON.parse(localStorage.getItem('cantonment_admissions')) || [];
                console.log('Stored admissions from localStorage:', storedAdmissions);
                
                if (storedAdmissions.length > 0) {
                    admissions = storedAdmissions;
                    console.log('Using existing staff records:', admissions);
                } else {
                    // Only use empty data if no real data exists
                    admissions = [];
                    console.log('No existing staff found, starting with empty data');
                }
            } else {
                console.log('Using already loaded admissions:', admissions);
            }
            if (!staffDeductions) {
                staffDeductions = JSON.parse(localStorage.getItem('cantonment_staff_deductions')) || {};
            }
            
            // Initialize PS verification records in database if needed (only when API is available)
            try {
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    console.log('Running on web server - attempting API initialization');
                    if (authToken) {
                        const initResponse = await fetch('/api/ps-verification/initialize', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer ' + authToken,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (initResponse.ok) {
                            const initResult = await initResponse.json();
                            console.log('PS Verification initialized:', initResult);
                        }
                    } else {
                        console.log('No auth token available - skipping API initialization');
                    }
                } else {
                    console.log('Running from file system - skipping API initialization');
                }
            } catch (error) {
                console.error('Error initializing PS verification:', error);
                console.log('Falling back to localStorage mode');
            }

            const content = document.getElementById('content');
            content.innerHTML = `
                <style>
                    /* PS Verification Professional Styles */
                    * {
                        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    }

                    .ps-verification-container {
                        max-width: 1600px;
                        margin: 0 auto;
                        padding: 24px;
                        animation: fadeIn 0.5s ease;
                        background: #f0f4f8;
                        min-height: calc(100vh - 100px);
                    }

                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }

                    /* Enhanced Header */
                    .ps-header {
                        background: linear-gradient(135deg, #2d3748 0%, #1a365d 100%);
                        color: white;
                        padding: 40px;
                        border-radius: 20px;
                        margin-bottom: 32px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
                        position: relative;
                        overflow: hidden;
                    }

                    .ps-header::before {
                        content: '';
                        position: absolute;
                        top: -50%;
                        right: -50%;
                        width: 200%;
                        height: 200%;
                        background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
                        animation: pulse 15s ease-in-out infinite;
                    }

                    @keyframes pulse {
                        0%, 100% { transform: scale(1) rotate(0deg); }
                        50% { transform: scale(1.1) rotate(180deg); }
                    }

                    .ps-header-content {
                        position: relative;
                        z-index: 1;
                    }

                    .ps-title {
                        font-size: 32px;
                        font-weight: 800;
                        margin-bottom: 12px;
                        display: flex;
                        align-items: center;
                        gap: 16px;
                        letter-spacing: -0.5px;
                    }

                    .ps-subtitle {
                        font-size: 18px;
                        opacity: 0.9;
                        font-weight: 400;
                        line-height: 1.4;
                    }

                    /* Professional Period Selector */
                    .ps-period-selector {
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(10px);
                        padding: 12px 20px;
                        border-radius: 12px;
                        border: 1px solid rgba(0, 0, 0, 0.1);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        z-index: 1000;
                    }

                    .ps-period-label {
                        font-size: 14px;
                        font-weight: 500;
                        color: #333;
                    }

                    .ps-period-select {
                        background: white;
                        border: 1px solid #ddd;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 14px;
                        font-weight: 500;
                        color: #1a202c;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        min-width: 120px;
                    }

                    .ps-period-select:hover {
                        background: #f8f9fa;
                        border-color: #667eea;
                        transform: translateY(-1px);
                    }

                    .ps-period-select:focus {
                        outline: none;
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
                    }

                    /* Enhanced Filters Section */
                    .ps-filters-section {
                        background: white;
                        padding: 32px;
                        border-radius: 16px;
                        margin-bottom: 28px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                        border: 1px solid rgba(0, 0, 0, 0.06);
                        transition: all 0.3s ease;
                    }

                    .ps-filters-section:hover {
                        box-shadow: 0 6px 30px rgba(0, 0, 0, 0.08);
                    }

                    .ps-filters-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: #2d3748;
                        margin-bottom: 24px;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .ps-filters-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
                        gap: 24px;
                        align-items: end;
                    }

                    .ps-filter-group {
                        display: flex;
                        flex-direction: column;
                        gap: 8px;
                    }

                    .ps-filter-label {
                        font-size: 13px;
                        font-weight: 600;
                        color: #4a5568;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .ps-filter-input, .ps-filter-select {
                        padding: 12px 16px;
                        border: 2px solid #e2e8f0;
                        border-radius: 10px;
                        font-size: 15px;
                        transition: all 0.2s ease;
                        background: #f7fafc;
                    }

                    .ps-filter-input:hover, .ps-filter-select:hover {
                        background: white;
                        border-color: #cbd5e0;
                    }

                    .ps-filter-input:focus, .ps-filter-select:focus {
                        outline: none;
                        border-color: #4299e1;
                        background: white;
                        box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.1);
                    }

                    .ps-filter-actions {
                        display: flex;
                        gap: 12px;
                    }

                    .ps-filter-button {
                        padding: 12px 24px;
                        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        box-shadow: 0 4px 15px rgba(66, 153, 225, 0.25);
                    }

                    .ps-filter-button:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(66, 153, 225, 0.35);
                    }

                    .ps-filter-button.secondary {
                        background: #e2e8f0;
                        color: #4a5568;
                        box-shadow: none;
                    }

                    .ps-filter-button.secondary:hover {
                        background: #cbd5e0;
                        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                    }


                    /* Enhanced Table Section */
                    .ps-table-section {
                        background: white;
                        border-radius: 16px;
                        overflow: hidden;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                        border: 1px solid rgba(0, 0, 0, 0.06);
                    }

                    .ps-table-header {
                        padding: 16px 32px;
                        background: linear-gradient(to bottom, #f8fafc, #f1f5f9);
                        border-bottom: 1px solid #e2e8f0;
                    }

                    .ps-table-title {
                        font-size: 20px;
                        font-weight: 700;
                        color: #2d3748;
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    /* Professional Table */
                    .ps-table-wrapper {
                        overflow-x: auto;
                    }

                    .ps-table-stats {
                        display: flex;
                        gap: 25px;
                        flex-wrap: wrap;
                    }

                    .ps-stat-item {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                    }

                    .ps-stat-number {
                        font-size: 24px;
                        font-weight: 700;
                        color: #667eea;
                    }

                    .ps-stat-label {
                        font-size: 12px;
                        color: #64748b;
                        font-weight: 500;
                        text-transform: uppercase;
                    }

                    .ps-table {
                        width: 100%;
                        border-collapse: collapse;
                        font-size: 14px;
                    }

                    .ps-table th {
                        background: #f8fafc;
                        color: #2d3748;
                        font-weight: 700;
                        padding: 18px 24px;
                        text-align: left;
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.75px;
                        border-bottom: 2px solid #e2e8f0;
                        position: sticky;
                        top: 0;
                        z-index: 10;
                    }

                    .ps-table td {
                        padding: 18px 24px;
                        border-bottom: 1px solid #f1f5f9;
                        vertical-align: middle;
                        color: #4a5568;
                    }

                    .ps-table tr {
                        transition: all 0.2s ease;
                    }

                    .ps-table tr:hover {
                        background: #f8fafc;
                    }


                    .ps-staff-id-text {
                        font-weight: 600;
                        color: #1976d2;
                        font-size: 14px;
                    }

                    .ps-staff-name {
                        font-weight: 600;
                        color: #1e293b;
                        font-size: 14px;
                    }
                    
                    /* Designation Badge Styling - Removed for normal text display */

                    .ps-staff-name {
                        font-weight: 700;
                        color: #2d3748;
                        font-size: 15px;
                    }

                    .ps-staff-id {
                        font-size: 13px;
                        color: #718096;
                        font-family: 'SF Mono', Monaco, monospace;
                    }

                    .ps-father-name {
                        font-size: 13px;
                        color: #475569;
                    }

                    /* Enhanced Designation Badge */
                    .ps-designation-badge {
                        background: none;
                        color: #2d3748;
                        padding: 0;
                        border-radius: 0;
                        font-size: 14px;
                        font-weight: 600;
                        text-align: left;
                        border: none;
                    }

                    /* Enhanced Salary Display */
                    .ps-salary-amount {
                        font-weight: 700;
                        font-family: 'SF Mono', Monaco, monospace;
                        font-size: 15px;
                    }

                    .ps-salary-gross {
                        color: #38a169;
                    }

                    .ps-salary-deductions {
                        color: #e53e3e;
                    }

                    .ps-salary-net {
                        color: #3182ce;
                        font-size: 16px;
                    }

                    /* Enhanced Status Badges */
                    .ps-status-badge {
                        padding: 8px 16px;
                        border-radius: 8px;
                        font-size: 13px;
                        font-weight: 600;
                        text-align: center;
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                    }

                    .ps-status-pending {
                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                        color: #92400e;
                        border: 1px solid #f59e0b;
                    }

                    .ps-status-approved {
                        background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                        color: #065f46;
                        border: 1px solid #10b981;
                    }

                    .ps-status-rejected {
                        background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                        color: #991b1b;
                        border: 1px solid #ef4444;
                    }

                    /* Enhanced Action Buttons - Fixed Width to Prevent Layout Shift */
                    .ps-actions-cell {
                        display: flex;
                        gap: 8px;
                        flex-wrap: wrap;
                        justify-content: center;
                        align-items: center;
                        min-width: 280px;
                        width: 280px;
                        padding: 8px;
                    }
                    
                    /* Column Width Management */
                    .ps-table th:last-child,
                    .ps-table td:last-child {
                        width: 280px !important;
                        min-width: 280px !important;
                        max-width: 280px !important;
                        text-align: center;
                    }
                    
                    /* Designation column - ensure proper width for long titles */
                    .ps-table th:nth-child(4),
                    .ps-table td:nth-child(4) {
                        width: 160px !important;
                        min-width: 160px !important;
                        max-width: 160px !important;
                        white-space: normal;
                        word-wrap: break-word;
                        line-height: 1.4;
                        padding: 12px 8px;
                    }

                    .ps-action-btn {
                        padding: 8px 12px;
                        border: none;
                        border-radius: 6px;
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        text-decoration: none;
                        position: relative;
                        overflow: hidden;
                        min-width: 70px;
                        justify-content: center;
                        height: 32px;
                        white-space: nowrap;
                    }

                    .ps-action-btn::before {
                        content: '';
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        width: 0;
                        height: 0;
                        background: rgba(255, 255, 255, 0.2);
                        border-radius: 50%;
                        transform: translate(-50%, -50%);
                        transition: width 0.4s, height 0.4s;
                    }

                    .ps-action-btn:hover::before {
                        width: 100px;
                        height: 100px;
                    }

                    .ps-btn-view {
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25);
                    }

                    .ps-btn-view:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35);
                    }

                    .ps-btn-approve {
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.25);
                    }

                    .ps-btn-approve:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
                    }

                    .ps-btn-reject {
                        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                        color: white;
                        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.25);
                    }

                    .ps-btn-reject:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.35);
                    }

                    /* Loading Animation */
                    .loading {
                        display: inline-block;
                        width: 20px;
                        height: 20px;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                        border-top-color: white;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    }

                    @keyframes spin {
                        to { transform: rotate(360deg); }
                    }

                    /* Responsive Design */
                    @media (max-width: 1024px) {
                        .ps-period-selector {
                            position: static;
                            margin-top: 20px;
                            width: fit-content;
                        }

                    }

                    @media (max-width: 768px) {
                        .ps-verification-container {
                            padding: 16px;
                        }

                        .ps-title {
                            font-size: 24px;
                        }

                        .ps-filters-grid {
                            grid-template-columns: 1fr;
                        }


                        .ps-table {
                            font-size: 12px;
                        }

                        .ps-table th,
                        .ps-table td {
                            padding: 12px 8px;
                        }

                        .ps-actions-cell {
                            flex-direction: column;
                            min-width: 120px;
                            width: 120px;
                            gap: 6px;
                        }
                        
                        .ps-table th:last-child,
                        .ps-table td:last-child {
                            width: 120px !important;
                            min-width: 120px !important;
                            max-width: 120px !important;
                        }
                        
                        .ps-action-btn {
                            font-size: 11px;
                            padding: 6px 8px;
                            min-width: 60px;
                            height: 28px;
                        }

                        .ps-staff-info {
                            flex-direction: column;
                            align-items: flex-start;
                        }
                    }
                </style>

                <div class="ps-verification-container">
                    <!-- Enhanced Page Header -->
                    <div class="ps-header">
                        <div class="ps-header-content">
                            <h1 class="ps-title">
                                <i class="fas fa-file-invoice-dollar"></i>
                                PS Verification System
                            </h1>
                            <p class="ps-subtitle">Advanced payroll verification and approval management for staff salary processing</p>
                        </div>
                        
                        <!-- Period Selector -->
                        <div class="ps-period-selector">
                            <label class="ps-period-label">Period:</label>
                            <select id="psMonthFilter" class="ps-period-select" onchange="onPSDateChange()">
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="psYearFilter" class="ps-period-select" onchange="onPSDateChange()">
                                ${(() => {
                                    const currentYear = new Date().getFullYear();
                                    let options = '';
                                    for (let year = currentYear; year >= currentYear - 5; year--) {
                                        options += `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`;
                                    }
                                    return options;
                                })()}
                            </select>
                        </div>
                    </div>


                    <!-- Enhanced Filters Section -->
                    <div class="ps-filters-section">
                        <h3 class="ps-filters-title">
                            <i class="fas fa-filter"></i>
                            Advanced Filters
                        </h3>
                        <div class="ps-filters-grid">
                            <div class="ps-filter-group">
                                <label class="ps-filter-label">Search</label>
                                <input type="text" id="psSearchInput" class="ps-filter-input" placeholder="Name, Staff ID, or Father's name..." 
                                    oninput="this.value = this.value.replace(/[^a-zA-Z0-9\s]/g, ''); filterPSVerification()" 
                                    pattern="[a-zA-Z0-9\s]*" 
                                    title="Only letters, numbers and spaces are allowed">
                            </div>
                            <div class="ps-filter-group">
                                <label class="ps-filter-label">Designation</label>
                                <select id="psDesignationFilter" class="ps-filter-select" onchange="filterPSVerification()">
                                    <option value="">All Designations</option>
                                    ${[...new Set(admissions.map(a => a.designation))].sort().map(designation => 
                                        `<option value="${designation}">${designation}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="ps-filter-group">
                                <label class="ps-filter-label">Status</label>
                                <select id="psStatusFilter" class="ps-filter-select" onchange="filterPSVerification()">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="ps-filter-group">
                                <div class="ps-filter-actions" style="margin-top: 25px;">
                                    <button class="ps-filter-button" onclick="filterPSVerification()">
                                        <i class="fas fa-check"></i>
                                        Apply
                                    </button>
                                    <button class="ps-filter-button secondary" onclick="clearPSFilters()">
                                        <i class="fas fa-redo"></i>
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Table Section -->
                    <div class="ps-table-section">
                        <div class="ps-table-header">
                            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                                <h2 class="ps-table-title" style="margin: 0;">
                                    <i class="fas fa-list"></i>
                                    <span id="psTableTitle">Staff Payroll Verification</span>
                                </h2>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="resetAllPSVerifications()" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 14px;">
                                        <i class="fas fa-undo"></i> Reset All to Pending
                                    </button>
                                    <button onclick="exportPSVerification()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 14px; transition: all 0.2s ease;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="ps-table-wrapper">
                            <table class="ps-table">
                                <thead>
                                    <tr>
                                        <th style="text-align: center;">Staff ID</th>
                                        <th style="text-align: center;">Name</th>
                                        <th style="text-align: center;">Father's Name</th>
                                        <th style="text-align: center;">Designation</th>
                                        <th style="text-align: center;">Gross Salary</th>
                                        <th style="text-align: center;">Total Deductions</th>
                                        <th style="text-align: center;">Net Salary</th>
                                        <th style="text-align: center;">Status</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="psTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;

            // Initialize selected period to current month/year
            const currentDate = new Date();
            window.selectedPSPeriod = {
                month: currentDate.getMonth() + 1,
                year: currentDate.getFullYear()
            };

            // Initialize month/year selectors after DOM is ready
            setTimeout(async () => {
                const monthSelect = document.getElementById('psMonthFilter');
                const yearSelect = document.getElementById('psYearFilter');
                
                if (monthSelect) monthSelect.value = window.selectedPSPeriod.month.toString();
                if (yearSelect) yearSelect.value = window.selectedPSPeriod.year.toString();
                
                // Update header
                updatePSTableHeader();
                
                // Load PS verification data from API
                await loadPSVerificationData();
                
                // Load initial historical data for current period
                await loadHistoricalPayslipData();
                
                // Render table with loaded data
                renderPSVerificationTable();
            }, 100);
        }

        // Load PS verification data from API
        async function loadPSVerificationData() {
            console.log('loadPSVerificationData called, protocol:', window.location.protocol);
            console.log('authToken:', authToken);
            
            try {
                // Only attempt API calls when running on web server
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    console.log('Making API call to /api/ps-verification');
                    const response = await fetch('/api/ps-verification', {
                        headers: {
                            'Authorization': 'Bearer ' + authToken
                        }
                    });
                    
                    console.log('API response status:', response.status);
                    
                    if (response.ok) {
                        const psRecords = await response.json();
                        console.log('PS Verification records from API:', psRecords);
                        
                        // Convert API records to frontend format
                        const psVerifications = {};
                        psRecords.forEach(record => {
                            // Use staff_id from database records
                            const staffKey = record.staff_id;
                            psVerifications[staffKey] = {
                                staffId: staffKey,
                                status: record.status,
                                approvedBy: record.approved_by,
                                approvedDate: record.approved_date,
                                rejectedBy: record.rejected_by,
                                rejectedDate: record.rejected_date,
                                remarks: record.remarks,
                                createdDate: record.created_date,
                                updatedDate: record.updated_date
                            };
                        });
                        
                        window.psVerifications = psVerifications;
                        console.log('PS Verifications loaded from API:', window.psVerifications);
                        return; // Successfully loaded from API
                    } else {
                        const errorText = await response.text();
                        console.error('Failed to load PS verification records, status:', response.status, 'body:', errorText);
                    }
                } else {
                    console.log('Running from file system - using localStorage mode');
                    // For file:// protocol, directly fall back to localStorage
                    initializePSVerification();
                    return;
                }
            } catch (error) {
                console.error('Error loading PS verification data:', error);
            }
            
            console.log('Falling back to localStorage data');
            // Fall back to localStorage data
            initializePSVerification();
        }

        // Initialize PS verification data (fallback for localStorage)
        function initializePSVerification() {
            console.log('initializePSVerification called');
            console.log('Current admissions array:', admissions);
            
            // Get or create PS verification data with period-specific structure
            let psVerifications = JSON.parse(localStorage.getItem('psVerifications')) || {};
            console.log('Existing psVerifications from localStorage:', psVerifications);
            
            // Get current period
            const currentPeriod = window.selectedPSPeriod || { month: new Date().getMonth() + 1, year: new Date().getFullYear() };
            const periodKey = `${currentPeriod.year}-${currentPeriod.month.toString().padStart(2, '0')}`;
            console.log('Current period key:', periodKey);
            
            // Initialize period if not exists
            if (!psVerifications[periodKey]) {
                psVerifications[periodKey] = {};
            }

            // Create PS verification entries for all staff in current period if they don't exist
            admissions.forEach(staff => {
                // Use the ID field that exists in the staff object
                const staffKey = staff.staffId || staff.id || staff.staff_id;
                console.log('Processing staff:', staff, 'staffKey:', staffKey);
                
                if (staffKey && !psVerifications[periodKey][staffKey]) {
                    psVerifications[periodKey][staffKey] = {
                        staffId: staffKey,
                        status: 'pending',
                        approvedBy: null,
                        approvedDate: null,
                        rejectedBy: null,
                        rejectedDate: null,
                        remarks: '',
                        createdDate: new Date().toISOString(),
                        updatedDate: new Date().toISOString(),
                        period: currentPeriod
                    };
                    console.log('Created PS verification for staff:', staffKey, 'in period:', periodKey);
                }
            });

            // Save updated PS verifications
            localStorage.setItem('psVerifications', JSON.stringify(psVerifications));
            window.psVerifications = psVerifications;
            console.log('Final psVerifications:', window.psVerifications);
        }
        
        // Get PS verification data for current selected period
        function getCurrentPeriodPSData() {
            const currentPeriod = window.selectedPSPeriod || { month: new Date().getMonth() + 1, year: new Date().getFullYear() };
            const periodKey = `${currentPeriod.year}-${currentPeriod.month.toString().padStart(2, '0')}`;
            
            if (!window.psVerifications) {
                return {};
            }
            
            // If using old format (direct staff keys), migrate to period format
            if (window.psVerifications[Object.keys(window.psVerifications)[0]]?.staffId) {
                console.log('Migrating PS verification data to period format');
                const oldData = {...window.psVerifications};
                const newData = {};
                newData[periodKey] = oldData;
                window.psVerifications = newData;
                localStorage.setItem('psVerifications', JSON.stringify(newData));
            }
            
            return window.psVerifications[periodKey] || {};
        }
        
        // Update PS verification data for current period
        function updateCurrentPeriodPSData(staffId, data) {
            const currentPeriod = window.selectedPSPeriod || { month: new Date().getMonth() + 1, year: new Date().getFullYear() };
            const periodKey = `${currentPeriod.year}-${currentPeriod.month.toString().padStart(2, '0')}`;
            
            if (!window.psVerifications) {
                window.psVerifications = {};
            }
            
            if (!window.psVerifications[periodKey]) {
                window.psVerifications[periodKey] = {};
            }
            
            window.psVerifications[periodKey][staffId] = {
                ...window.psVerifications[periodKey][staffId],
                ...data,
                period: currentPeriod
            };
            
            localStorage.setItem('psVerifications', JSON.stringify(window.psVerifications));
        }

        // Render PS verification table
        function renderPSVerificationTable() {
            console.log('renderPSVerificationTable called');
            console.log('admissions array:', admissions);
            console.log('admissions length:', admissions.length);
            console.log('selectedPSPeriod:', window.selectedPSPeriod);
            
            // Debug: Show all staff with their appointment dates
            console.log('=== Staff Debug Info ===');
            admissions.forEach(staff => {
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                console.log(`Staff: ${staff.staffName}, Appointment: ${appointmentDate}, ID: ${staff.staffId || staff.id}`);
            });
            console.log('========================');
            
            console.log('psVerifications:', window.psVerifications);
            
            const tableBody = document.getElementById('psTableBody');
            
            if (!tableBody) {
                console.log('Table body element not found:', tableBody);
                return;
            }

            // Get current period PS data
            const currentPeriodPSData = getCurrentPeriodPSData();
            console.log('Current period PS data:', currentPeriodPSData);

            // Get search and filter values
            const searchTerm = (document.getElementById('psSearchInput')?.value || '').toLowerCase();
            const designationFilter = document.getElementById('psDesignationFilter')?.value || '';
            const statusFilter = document.getElementById('psStatusFilter')?.value || '';

            // Filter admissions based on search and filters
            let filteredStaff = admissions.filter(staff => {
                // Get the staff key
                const staffKey = staff.staffId || staff.id || staff.staff_id;
                
                // CRITICAL: Check appointment date - staff should only appear if appointed in or before selected month/year
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate && window.selectedPSPeriod) {
                    const selectedPeriod = window.selectedPSPeriod;
                    
                    // Parse appointment date (handle both DD-MM-YYYY and other formats)
                    let staffAppointmentDate;
                    if (appointmentDate.includes('-')) {
                        const parts = appointmentDate.split('-');
                        if (parts.length === 3) {
                            // Handle DD-MM-YYYY format
                            staffAppointmentDate = new Date(parts[2], parts[1] - 1, parts[0]);
                        }
                    } else if (appointmentDate.includes('/')) {
                        // Handle MM/DD/YYYY or DD/MM/YYYY format
                        staffAppointmentDate = new Date(appointmentDate);
                    } else {
                        staffAppointmentDate = new Date(appointmentDate);
                    }
                    
                    if (staffAppointmentDate) {
                        const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1; // 1-12
                        const staffAppointmentYear = staffAppointmentDate.getFullYear();
                        
                        const filterMonth = selectedPeriod.month; // 1-12
                        const filterYear = selectedPeriod.year;
                        
                        console.log(`FILTER DEBUG: ${staff.staffName} - Appointed: ${appointmentDate} (${staffAppointmentMonth}/${staffAppointmentYear}), Filter: ${filterMonth}/${filterYear}`);
                        
                        // Staff should appear if appointed in or before the selected month/year
                        if (staffAppointmentYear < filterYear) {
                            console.log(`Including ${staff.staffName} - appointed in previous year`);
                            // Appointed in previous years - include
                        } else if (staffAppointmentYear === filterYear) {
                            // Same year - check month
                            if (staffAppointmentMonth > filterMonth) {
                                console.log(`Excluding ${staff.staffName} - appointed ${appointmentDate} (${staffAppointmentMonth}/${staffAppointmentYear}) after selected period ${filterMonth}/${filterYear}`);
                                return false; // Appointed in future month of same year
                            } else {
                                console.log(`Including ${staff.staffName} - appointed in same year, same/previous month`);
                            }
                        } else {
                            // Appointed in future years - exclude
                            console.log(`Excluding ${staff.staffName} - appointed ${appointmentDate} in future year ${staffAppointmentYear} vs ${filterYear}`);
                            return false;
                        }
                    }
                }
                
                // Search filter
                const matchesSearch = searchTerm === '' || 
                    (staff.staffName && staff.staffName.toLowerCase().includes(searchTerm)) ||
                    (staffKey && staffKey.toString().toLowerCase().includes(searchTerm));

                // Designation filter
                const matchesDesignation = designationFilter === '' || staff.designation === designationFilter;

                // Status filter  
                const psStatus = currentPeriodPSData[staffKey]?.status || 'pending';
                const matchesStatus = statusFilter === '' || psStatus === statusFilter;

                return matchesSearch && matchesDesignation && matchesStatus;
            });

            // Calculate stats
            const totalRecords = filteredStaff.length;
            const pendingCount = filteredStaff.filter(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return (currentPeriodPSData[staffKey]?.status || 'pending') === 'pending';
            }).length;
            const approvedCount = filteredStaff.filter(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return (currentPeriodPSData[staffKey]?.status || 'pending') === 'approved';
            }).length;
            const rejectedCount = filteredStaff.filter(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return (currentPeriodPSData[staffKey]?.status || 'pending') === 'rejected';
            }).length;


            // Render table rows
            if (filteredStaff.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #64748b;">
                            üìã No staff records found.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredStaff.map(staff => {
                const staffKey = staff.staffId || staff.id || staff.staff_id;
                const grossSalary = calculateGrossSalaryForPS(staff);
                const totalDeductions = calculateTotalDeductions(staffKey);
                
                // Debug logging
                console.log(`Rendering PS table for ${staff.staffName}:`, {
                    staffKey: staffKey,
                    staffId: staff.staffId,
                    id: staff.id,
                    totalDeductions: totalDeductions,
                    deductionData: staffDeductions[staffKey] || staffDeductions[staff.staffId] || 'Not found'
                });
                
                const netSalary = grossSalary - totalDeductions;
                const psStatus = currentPeriodPSData[staffKey]?.status || 'pending';

                return `
                    <tr data-staff-id="${staffKey}">
                        <td style="text-align: center;">
                            <span class="ps-staff-id-text">${staffKey || 'N/A'}</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="ps-staff-name">${staff.staffName || 'N/A'}</span>
                        </td>
                        <td style="text-align: center;">${staff.fatherName || 'N/A'}</td>
                        <td style="text-align: center;">
                            <span class="ps-designation-badge">${staff.designation || 'N/A'}</span>
                        </td>
                        <td class="ps-salary-amount ps-salary-gross" style="text-align: center;">‚Çπ${grossSalary.toLocaleString()}</td>
                        <td class="ps-salary-amount ps-salary-deductions" style="text-align: center;">‚Çπ${totalDeductions.toLocaleString()}</td>
                        <td class="ps-salary-amount ps-salary-net" style="text-align: center;">‚Çπ${netSalary.toLocaleString()}</td>
                        <td style="text-align: center;">
                            <span class="ps-status-badge ps-status-${psStatus}">
                                ${getStatusIcon(psStatus)}
                                ${psStatus.charAt(0).toUpperCase() + psStatus.slice(1)}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div class="ps-actions-cell">
                                <button class="ps-action-btn ps-btn-view" onclick="viewPSDetails('${staffKey}')">
                                    <i class="fas fa-eye"></i>
                                    View
                                </button>
                                ${psStatus === 'pending' ? `
                                    <button class="ps-action-btn ps-btn-approve" onclick="approvePSVerification('${staffKey}')">
                                        <i class="fas fa-check"></i>
                                        Approve
                                    </button>
                                    <button class="ps-action-btn ps-btn-reject" onclick="rejectPSVerification('${staffKey}')">
                                        <i class="fas fa-times"></i>
                                        Reject
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get status icon
        function getStatusIcon(status) {
            const icons = {
                'pending': '<i class="fas fa-clock"></i>',
                'approved': '<i class="fas fa-check-circle"></i>',
                'rejected': '<i class="fas fa-times-circle"></i>'
            };
            return icons[status] || '';
        }

        // Calculate gross salary for PS verification - ALWAYS use live calculation
        function calculateGrossSalaryForPS(staff) {
            console.log('calculateGrossSalaryForPS called for:', staff.staffName || staff.id);
            
            // IMPORTANT: Use exact same calculation as Dashboard Details popup
            // Find the staff record in admissions array to ensure same data source
            const staffId = staff.staffId || staff.id || staff.staff_id;
            const admission = admissions.find(a => a.staffId === staffId || a.id === staffId);
            
            if (!admission) {
                console.warn('Staff not found in admissions for PS calculation:', staffId);
                return 0;
            }
            
            // Use EXACT same calculation logic as Dashboard Details
            let basicSalary = parseFloat(admission.basicPayCalculated) || 0;
            
            // If basicPayCalculated is empty, try to calculate from basicPayScale
            if (!basicSalary && admission.basicPayScale) {
                // Extract number from basicPayScale like "15600-39100" -> take the first number
                const scaleMatch = admission.basicPayScale.match(/(\d+)/);
                if (scaleMatch) {
                    basicSalary = parseFloat(scaleMatch[1]);
                }
            }
            
            // If still no basic salary, use basicPay as fallback
            if (!basicSalary) {
                basicSalary = parseFloat(admission.basicPay) || 0;
            }
            
            const daAmount = (basicSalary * 2) / 100;  // DA is always 2% of basic pay
            const hraAmount = (basicSalary * 2) / 100; // HRA is always 2% of basic pay
            const specialPay = parseFloat(admission.specialPay) || 0;
            const specialAllowance = parseFloat(admission.specialAllowance) || 0;
            const otherAllowance = parseFloat(admission.otherAllowance) || 0;
            const calculatedGrossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
            
            // Debug logging to compare values
            console.log(`‚úÖ PS Verification LIVE Gross Salary Calculation for ${admission.staffName}:`, {
                originalBasicPayCalculated: admission.basicPayCalculated,
                basicPay: admission.basicPay,
                basicPayScale: admission.basicPayScale,
                finalBasicSalary: basicSalary,
                daAmount: daAmount.toFixed(2) + " (2% of basic pay)",
                hraAmount: hraAmount.toFixed(2) + " (2% of basic pay)",
                specialPay,
                specialAllowance,
                otherAllowance,
                calculatedGrossSalary: calculatedGrossSalary.toFixed(2),
                formula: "Basic + DA(2%) + HRA(2%) + Special Pay + Special Allowance + Other Allowance"
            });
            
            return calculatedGrossSalary;
        }

        // Force refresh PS Verification table with updated calculations
        function refreshPSVerificationCalculations() {
            console.log('Refreshing PS Verification calculations...');
            
            // Clear any cached calculations
            if (window.psCalculationsCache) {
                window.psCalculationsCache = {};
            }
            
            // Re-render the PS verification table to pick up new calculations
            renderPSVerificationTable();
            
            console.log('PS Verification calculations refreshed');
        }

        // Force immediate refresh of PS Verification with updated calculations
        function forceRefreshPSVerification() {
            console.log('FORCE REFRESH: Updating PS Verification with corrected gross salary calculations...');
            
            // Clear all possible caches
            if (window.psCalculationsCache) window.psCalculationsCache = {};
            if (window.historicalPayslips) window.historicalPayslips = {};
            
            // Force re-render of PS verification table
            if (typeof renderPSVerificationTable === 'function') {
                renderPSVerificationTable();
                console.log('PS Verification table forcibly refreshed with updated calculations');
            }
            
            // Also refresh if visible
            const psVerificationSection = document.getElementById('ps-verification');
            if (psVerificationSection && psVerificationSection.style.display !== 'none') {
                console.log('PS Verification section is visible - applying immediate refresh');
                setTimeout(() => renderPSVerificationTable(), 100);
            }
        }

        // Call force refresh multiple times to ensure it takes effect
        setTimeout(forceRefreshPSVerification, 100);
        setTimeout(forceRefreshPSVerification, 500);
        setTimeout(forceRefreshPSVerification, 1000);
        setTimeout(forceRefreshPSVerification, 2000);

        // Add manual refresh capability - expose globally
        window.refreshPSGrossSalary = forceRefreshPSVerification;
        
        // Also try to refresh when PS Verification tab is clicked
        document.addEventListener('DOMContentLoaded', function() {
            // Monitor for PS Verification tab clicks
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    const psSection = document.getElementById('ps-verification');
                    if (psSection && psSection.style.display !== 'none') {
                        console.log('PS Verification section became visible - refreshing calculations');
                        setTimeout(forceRefreshPSVerification, 200);
                    }
                });
            });
            
            const content = document.getElementById('content');
            if (content) {
                observer.observe(content, { childList: true, subtree: true });
            }
        });

        // Calculate total deductions - use the simple "Total monthly deductions" from Deduction Management popup
        function calculateTotalDeductions(staffIdOrKey) {
            console.log('calculateTotalDeductions called with:', staffIdOrKey);
            
            const period = window.selectedPSPeriod;
            const periodKey = period ? `${period.year}-${period.month}` : null;
            
            // Check if we have historical payslip data for this period
            if (periodKey && window.historicalPayslips && window.historicalPayslips[periodKey] && window.historicalPayslips[periodKey][staffIdOrKey]) {
                const historicalPayslip = window.historicalPayslips[periodKey][staffIdOrKey];
                console.log('Using historical payslip data:', historicalPayslip.total_deductions);
                return parseFloat(historicalPayslip.total_deductions) || 0;
            }
            
            // Try multiple ways to find deduction data
            let deductionData = staffDeductions[staffIdOrKey];
            
            // If not found, try to find using staff record
            if (!deductionData) {
                const staff = admissions.find(a => 
                    a.staffId === staffIdOrKey || 
                    a.id == staffIdOrKey || 
                    a.staff_id === staffIdOrKey
                );
                
                if (staff) {
                    // Try all possible ID formats for this staff member
                    deductionData = staffDeductions[staff.staffId] || 
                                  staffDeductions[staff.id] || 
                                  staffDeductions[staff.staff_id];
                    
                    if (deductionData) {
                        console.log(`Found deduction data for ${staffIdOrKey} using staff record:`, {
                            originalKey: staffIdOrKey,
                            staffId: staff.staffId,
                            id: staff.id,
                            staff_id: staff.staff_id,
                            foundWith: staff.staffId && staffDeductions[staff.staffId] ? 'staffId' :
                                      staff.id && staffDeductions[staff.id] ? 'id' : 'staff_id'
                        });
                    }
                }
            }
            
            if (!deductionData) {
                console.log(`No deduction data found for ${staffIdOrKey} in staffDeductions keys:`, Object.keys(staffDeductions));
                return 0;
            }

            // Return the total monthly deductions directly - no complex calculation needed
            const totalDeductions = parseFloat(deductionData.totalMonthlyDeductions) || 0;
            console.log(`Total deductions for ${staffIdOrKey}:`, totalDeductions);
            return totalDeductions;
        }

        // Calculate net salary
        function calculateNetSalary(staff) {
            const staffKey = staff.staffId || staff.id || staff.staff_id;
            return calculateGrossSalaryForPS(staff) - calculateTotalDeductions(staffKey);
        }

        // Filter PS verification table
        function filterPSVerification() {
            renderPSVerificationTable();
        }
        
        // Function to refresh PS Verification in real-time when deductions change
        function refreshPSVerificationIfVisible() {
            // Check if PS Verification section is currently visible
            const psVerificationSection = document.getElementById('ps-verification');
            if (psVerificationSection && psVerificationSection.style.display !== 'none') {
                console.log('PS Verification is visible, refreshing data...');
                
                // Refresh global data first to get latest deductions
                refreshGlobalData();
                
                // Re-render the PS verification table with updated data
                renderPSVerificationTable();
                
                console.log('PS Verification table refreshed with latest deduction data');
            }
        }

        // Clear all filters
        function clearPSFilters() {
            document.getElementById('psSearchInput').value = '';
            document.getElementById('psDesignationFilter').value = '';
            document.getElementById('psStatusFilter').value = '';
            
            // Reset month/year to current date
            const currentDate = new Date();
            document.getElementById('psMonthFilter').value = (currentDate.getMonth() + 1).toString();
            document.getElementById('psYearFilter').value = currentDate.getFullYear().toString();
            
            // Update selected period
            window.selectedPSPeriod = {
                month: currentDate.getMonth() + 1,
                year: currentDate.getFullYear()
            };
            
            renderPSVerificationTable();
        }

        // Handle month/year change
        async function onPSDateChange() {
            const monthSelect = document.getElementById('psMonthFilter');
            const yearSelect = document.getElementById('psYearFilter');
            
            if (monthSelect && yearSelect) {
                const selectedMonth = parseInt(monthSelect.value);
                const selectedYear = parseInt(yearSelect.value);
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();
                
                // Validate that future dates cannot be selected
                if (selectedYear > currentYear || (selectedYear === currentYear && selectedMonth > currentMonth)) {
                    // Show custom error modal
                    showPeriodValidationError(selectedMonth, selectedYear, currentMonth, currentYear);
                    
                    // Reset to current month/year
                    monthSelect.value = currentMonth;
                    yearSelect.value = currentYear;
                    return;
                }
                
                window.selectedPSPeriod = {
                    month: selectedMonth,
                    year: selectedYear
                };
                
                console.log('PS Date changed to:', window.selectedPSPeriod);
                
                // Update table header to show selected period
                updatePSTableHeader();
                
                // Show loading indicator
                showPSLoadingIndicator(true);
                
                try {
                    // Load historical payslip data for the selected period
                    await loadHistoricalPayslipData();
                    
                    // Initialize PS verification data for the new period
                    initializePSVerification();
                    
                    // Re-render table for selected period
                    renderPSVerificationTable();
                } catch (error) {
                    console.error('Error loading historical data:', error);
                } finally {
                    // Hide loading indicator
                    showPSLoadingIndicator(false);
                }
            }
        }
        
        // Show custom period validation error modal
        function showPeriodValidationError(selectedMonth, selectedYear, currentMonth, currentYear) {
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            const selectedPeriod = `${monthNames[selectedMonth]} ${selectedYear}`;
            const currentPeriod = `${monthNames[currentMonth]} ${currentYear}`;
            
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.id = 'periodValidationModal';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Create modal content
            modalOverlay.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 420px;
                    width: 90%;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                    transform: scale(0.9);
                    animation: modalAppear 0.3s ease-out forwards;
                    text-align: center;
                ">
                    <div style="
                        width: 64px;
                        height: 64px;
                        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        margin: 0 auto 24px auto;
                        font-size: 28px;
                    ">‚ö†Ô∏è</div>
                    
                    <h3 style="
                        font-size: 24px;
                        font-weight: 700;
                        color: #1f2937;
                        margin: 0 0 12px 0;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    ">Invalid Period Selection</h3>
                    
                    <p style="
                        color: #6b7280;
                        font-size: 16px;
                        line-height: 1.6;
                        margin: 0 0 20px 0;
                    ">Future periods cannot be selected for payslip verification.</p>
                    
                    <div style="
                        background: #fef3c7;
                        border: 1px solid #fcd34d;
                        border-radius: 8px;
                        padding: 16px;
                        margin: 20px 0;
                        text-align: left;
                    ">
                        <div style="color: #92400e; font-size: 14px; margin-bottom: 8px;">
                            <strong>Selected:</strong> ${selectedPeriod}
                        </div>
                        <div style="color: #059669; font-size: 14px;">
                            <strong>Reset to:</strong> ${currentPeriod}
                        </div>
                    </div>
                    
                    <button onclick="closePeriodValidationModal()" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 12px 32px;
                        border-radius: 8px;
                        font-size: 16px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        Got it
                    </button>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    
                    @keyframes modalAppear {
                        from { 
                            transform: scale(0.9) translateY(20px); 
                            opacity: 0; 
                        }
                        to { 
                            transform: scale(1) translateY(0); 
                            opacity: 1; 
                        }
                    }
                </style>
            `;
            
            document.body.appendChild(modalOverlay);
            
            // Close modal when clicking overlay
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closePeriodValidationModal();
                }
            });
        }
        
        // Close period validation modal
        function closePeriodValidationModal() {
            const modal = document.getElementById('periodValidationModal');
            if (modal) {
                modal.style.animation = 'fadeOut 0.2s ease-in';
                setTimeout(() => modal.remove(), 200);
            }
        }
        
        // Show/hide loading indicator for PS verification
        function showPSLoadingIndicator(show) {
            let loadingDiv = document.getElementById('psLoadingIndicator');
            
            if (show && !loadingDiv) {
                loadingDiv = document.createElement('div');
                loadingDiv.id = 'psLoadingIndicator';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px 30px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    font-size: 16px;
                    color: #374151;
                `;
                loadingDiv.innerHTML = `
                    <div style="width: 20px; height: 20px; border: 2px solid #e5e5e5; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    Loading historical payslip data...
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loadingDiv);
            } else if (!show && loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        // Load historical payslip data for selected period
        async function loadHistoricalPayslipData() {
            const period = window.selectedPSPeriod;
            if (!period) return;
            
            try {
                // Initialize historical payslip storage
                if (!window.historicalPayslips) {
                    window.historicalPayslips = {};
                }
                
                const periodKey = `${period.year}-${period.month}`;
                
                // Check if data already loaded for this period
                if (window.historicalPayslips[periodKey]) {
                    console.log('Historical payslip data already loaded for:', periodKey);
                    return;
                }
                
                console.log(`Loading historical payslip data for ${periodKey}...`);
                
                // Initialize period data
                window.historicalPayslips[periodKey] = {};
                
                // Check if backend is available
                const backendAvailable = await checkBackendAvailability();
                
                if (backendAvailable) {
                    console.log('Backend is available, fetching historical payslip data...');
                    await loadHistoricalDataFromBackend(period, periodKey);
                } else {
                    console.log('Backend unavailable, using calculated payslip data for historical period');
                    generateHistoricalDataLocally(period, periodKey);
                }
                
                console.log(`Completed loading historical data for ${periodKey}`);
                
            } catch (error) {
                console.error('Error loading historical payslip data:', error);
                // Fallback to local calculation
                generateHistoricalDataLocally(period, periodKey);
            }
        }
        
        // Check if backend is available
        async function checkBackendAvailability() {
            try {
                const response = await fetch('http://localhost:5000/api/health', {
                    method: 'GET',
                    timeout: 3000
                });
                return response.ok;
            } catch (error) {
                console.log('Backend health check failed:', error.message);
                return false;
            }
        }
        
        // Load historical data from backend API
        async function loadHistoricalDataFromBackend(period, periodKey) {
            for (const staff of admissions) {
                try {
                    // Try to fetch existing payslip first
                    const response = await fetch(`http://localhost:5000/api/payslip/history/${staff.staffId}?year=${period.year}&limit=12`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        timeout: 5000
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const monthPayslip = data.payslips.find(p => p.month === period.month && p.year === period.year);
                        
                        if (monthPayslip) {
                            window.historicalPayslips[periodKey][staff.staffId] = monthPayslip;
                            console.log(`Found existing payslip for ${staff.staffName} - ${periodKey}`);
                            continue;
                        }
                    }
                    
                    // If no existing payslip found, generate one for the period
                    const generateResponse = await fetch(`http://localhost:5000/api/payslip/generate/${staff.staffId}/${period.year}/${period.month}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        },
                        timeout: 8000
                    });
                    
                    if (generateResponse.ok) {
                        const generateData = await generateResponse.json();
                        if (generateData.payslip) {
                            window.historicalPayslips[periodKey][staff.staffId] = generateData.payslip;
                            console.log(`Generated payslip for ${staff.staffName} - ${periodKey}`);
                        }
                    } else {
                        console.warn(`Failed to generate payslip for ${staff.staffName} - ${periodKey}, using local calculation`);
                        generateLocalPayslipForStaff(staff, period, periodKey);
                    }
                    
                } catch (error) {
                    console.warn(`API error for ${staff.staffName}, falling back to local calculation:`, error.message);
                    generateLocalPayslipForStaff(staff, period, periodKey);
                }
            }
        }
        
        // Generate historical data locally when backend is unavailable
        function generateHistoricalDataLocally(period, periodKey) {
            console.log(`Generating local historical data for ${periodKey}...`);
            
            admissions.forEach(staff => {
                generateLocalPayslipForStaff(staff, period, periodKey);
            });
        }
        
        // Generate local payslip data for a staff member
        function generateLocalPayslipForStaff(staff, period, periodKey) {
            try {
                const basicSalary = parseFloat(staff.basicSalary) || 0;
                const da = parseFloat(staff.da) || 0;
                const hra = parseFloat(staff.hra) || 0;
                const specialPay = parseFloat(staff.specialPay) || 0;
                const specialAllowance = parseFloat(staff.specialAllowance) || 0;
                const otherAllowance = parseFloat(staff.otherAllowance) || 0;
                
                const grossSalary = basicSalary + da + hra + specialPay + specialAllowance + otherAllowance;
                
                // Calculate deductions - use the simple "Total monthly deductions" field
                const deductionData = staffDeductions[staff.staffId] || {};
                const totalDeductions = parseFloat(deductionData.totalMonthlyDeductions) || 0;
                
                const netSalary = grossSalary - totalDeductions;
                
                // Create local payslip structure
                const localPayslip = {
                    id: `local_${staff.staffId}_${period.year}_${period.month}`,
                    staff_id: staff.staffId,
                    month: period.month,
                    year: period.year,
                    basic_pay: basicSalary,
                    da: da,
                    hra: hra,
                    special_pay: specialPay,
                    special_allowance: specialAllowance,
                    other_allowance: otherAllowance,
                    gross_salary: grossSalary,
                    total_deductions: totalDeductions,
                    net_salary: netSalary,
                    days_present: 26, // Default working days
                    days_absent: 0,
                    status: 'calculated',
                    generated_at: new Date().toISOString(),
                    staff_name: staff.staffName,
                    designation: staff.designation
                };
                
                if (!window.historicalPayslips[periodKey]) {
                    window.historicalPayslips[periodKey] = {};
                }
                
                window.historicalPayslips[periodKey][staff.staffId] = localPayslip;
                console.log(`Generated local payslip for ${staff.staffName} - ${periodKey}`);
                
            } catch (error) {
                console.error(`Error generating local payslip for ${staff.staffName}:`, error);
            }
        }

        // Update PS table header with selected period
        function updatePSTableHeader() {
            const period = window.selectedPSPeriod || { month: new Date().getMonth() + 1, year: new Date().getFullYear() };
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            
            const tableTitle = document.getElementById('psTableTitle');
            if (tableTitle) {
                tableTitle.textContent = `Staff Payroll Verification - ${monthNames[period.month]} ${period.year}`;
            }
        }

        // Create PS Details Modal HTML
        function createPSDetailsModalHTML(staff, salaryData, deductions, psData) {
            const {
                basicSalary, daAmount, hraAmount, specialPay, specialAllowance, otherAllowance,
                grossSalary, totalDeductions, netSalary, daPercentage, hraPercentage,
                currentMonth, currentYear
            } = salaryData;
            
            const {
                wheatAdvance, gic, lic, electricityBill, waterCharges, recovery,
                leaveDeductions, gppcSubscription, gpfExtraSubscription, gpfGovernmentContribution,
                gpfAdvanceRecovery, npsGovernmentContribution, npsSelfContribution,
                incomeTax, surCharges, otherDeduction1, otherDeduction2, otherDeduction3,
                gpfLedBalance, gpfAdvanceBalance, bankRecovery, gpfInterest, gpfWithdrawl
            } = deductions;
            
            return `
                <div id="psDetailsModal" style="position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); overflow-y: auto; padding: 20px; box-sizing: border-box;">
                    <div style="background: white; margin: 0 auto; border-radius: 12px; max-width: 1000px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative; min-height: 90vh;">
                        
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center; position: relative;">
                            <button onclick="closePSDetailsModal()" style="position: absolute; top: 15px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">&times;</button>
                            <h1 style="margin: 0; font-size: 24px; font-weight: 700;">CANTONMENT BOARD AMBALA</h1>
                            <h2 style="margin: 10px 0; font-size: 18px; font-weight: 600;">PAY SLIP - PS VERIFICATION</h2>
                            <p style="margin: 5px 0; font-size: 14px;">For the month of ${currentMonth} ${currentYear}</p>
                            <p style="margin: 10px 0 0; font-size: 16px; font-weight: 600;">Employee: ${staff.staffName}</p>
                        </div>
                        
                        <div style="padding: 30px;">
                            <!-- Employee Information -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #e2e8f0;">
                                <h3 style="margin: 0 0 15px; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 8px;"><span>üìã</span> Employee Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                                    <div><strong>Staff ID:</strong> ${staff.staffId}</div>
                                    <div><strong>Name:</strong> ${staff.staffName}</div>
                                    <div><strong>Father's Name:</strong> ${staff.fatherName || 'N/A'}</div>
                                    <div><strong>Designation:</strong> ${staff.designation || 'N/A'}</div>
                                    <div><strong>Mobile:</strong> ${staff.mobileNumber || 'N/A'}</div>
                                    <div><strong>Email:</strong> ${staff.email || 'N/A'}</div>
                                </div>
                            </div>
                            
                            <!-- Salary Structure -->
                            <h3 style="margin: 0 0 15px; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 8px;"><span>üí∞</span> Salary Structure</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #e2e8f0; font-size: 14px;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #374151; font-weight: 600;">Component</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0; color: #374151; font-weight: 600;">Amount (‚Çπ)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Basic Pay</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${basicSalary.toLocaleString()}</td></tr>
                                    <tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Dearness Allowance (${daPercentage}%)</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${daAmount.toLocaleString()}</td></tr>
                                    <tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">HRA (${hraPercentage}%)</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${hraAmount.toLocaleString()}</td></tr>
                                    ${specialPay > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Special Pay</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${specialPay.toLocaleString()}</td></tr>` : ''}
                                    ${specialAllowance > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Special Allowance</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${specialAllowance.toLocaleString()}</td></tr>` : ''}
                                    ${otherAllowance > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Other Allowance</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${otherAllowance.toLocaleString()}</td></tr>` : ''}
                                    <tr style="background: #f8fafc; font-weight: 600; border-top: 2px solid #e2e8f0;">
                                        <td style="padding: 12px;"><strong>Gross Salary</strong></td>
                                        <td style="padding: 12px; text-align: right; font-family: monospace;"><strong>‚Çπ${grossSalary.toLocaleString()}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Deductions -->
                            <h3 style="margin: 0 0 15px; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 8px;"><span>üìâ</span> Deductions</h3>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; border: 1px solid #e2e8f0; font-size: 14px;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #374151; font-weight: 600;">Component</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e2e8f0; color: #374151; font-weight: 600;">Amount (‚Çπ)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${wheatAdvance > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Wheat Advance</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${wheatAdvance.toLocaleString()}</td></tr>` : ''}
                                    ${gpfAdvanceRecovery > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Advance Recovery</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfAdvanceRecovery.toLocaleString()}</td></tr>` : ''}
                                    ${gpfLedBalance > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Ledger Balance</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfLedBalance.toLocaleString()}</td></tr>` : ''}
                                    ${gpfAdvanceBalance > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Advance Balance</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfAdvanceBalance.toLocaleString()}</td></tr>` : ''}
                                    ${bankRecovery > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Bank Recovery</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${bankRecovery.toLocaleString()}</td></tr>` : ''}
                                    ${gic > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GIC (General Insurance Corporation)</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gic.toLocaleString()}</td></tr>` : ''}
                                    ${lic > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">LIC (Life Insurance Corporation)</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${lic.toLocaleString()}</td></tr>` : ''}
                                    ${electricityBill > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Electricity Bill</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${electricityBill.toLocaleString()}</td></tr>` : ''}
                                    ${waterCharges > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Water Charges</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${waterCharges.toLocaleString()}</td></tr>` : ''}
                                    ${recovery > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">General Recovery</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${recovery.toLocaleString()}</td></tr>` : ''}
                                    ${leaveDeductions > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Leave Deductions</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${leaveDeductions.toLocaleString()}</td></tr>` : ''}
                                    ${gppcSubscription > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPPC Subscription</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gppcSubscription.toLocaleString()}</td></tr>` : ''}
                                    ${gpfExtraSubscription > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Extra Subscription</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfExtraSubscription.toLocaleString()}</td></tr>` : ''}
                                    ${gpfGovernmentContribution > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Government Contribution</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                    ${npsGovernmentContribution > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">NPS Government Contribution</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${npsGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                    ${npsSelfContribution > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">NPS Self Contribution</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${npsSelfContribution.toLocaleString()}</td></tr>` : ''}
                                    ${gpfWithdrawl > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Withdrawal</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfWithdrawl.toLocaleString()}</td></tr>` : ''}
                                    ${gpfInterest > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">GPF Interest</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${gpfInterest.toLocaleString()}</td></tr>` : ''}
                                    ${incomeTax > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Income Tax</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${incomeTax.toLocaleString()}</td></tr>` : ''}
                                    ${surCharges > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Sur-charges</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${surCharges.toLocaleString()}</td></tr>` : ''}
                                    ${otherDeduction1 > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Other Deduction-1</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${otherDeduction1.toLocaleString()}</td></tr>` : ''}
                                    ${otherDeduction2 > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Other Deduction-2</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${otherDeduction2.toLocaleString()}</td></tr>` : ''}
                                    ${otherDeduction3 > 0 ? `<tr><td style="padding: 10px; border-bottom: 1px solid #f1f5f9;">Other Deduction-3</td><td style="padding: 10px; text-align: right; border-bottom: 1px solid #f1f5f9; font-family: monospace;">${otherDeduction3.toLocaleString()}</td></tr>` : ''}
                                    ${totalDeductions === 0 ? '<tr><td colspan="2" style="padding: 10px; text-align: center; font-style: italic; color: #666;">No deductions for this month</td></tr>' : ''}
                                    <tr style="background: #f8fafc; font-weight: 600; border-top: 2px solid #e2e8f0;">
                                        <td style="padding: 12px;"><strong>Total Deductions</strong></td>
                                        <td style="padding: 12px; text-align: right; font-family: monospace;"><strong>‚Çπ${totalDeductions.toLocaleString()}</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Net Salary -->
                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 25px;">
                                <h3 style="margin: 0; font-size: 18px;">üíµ Net Salary</h3>
                                <div style="font-size: 28px; font-weight: 700; margin: 8px 0;">‚Çπ${netSalary.toLocaleString()}</div>
                                <p style="margin: 5px 0; font-size: 14px; opacity: 0.9;">Gross Salary - Total Deductions</p>
                            </div>
                            
                            <!-- Verification Status -->
                            <div style="background: #fffbeb; border: 1px solid #fcd34d; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                                <h4 style="margin: 0 0 15px; color: #d97706; font-size: 16px;">üìä Verification Status</h4>
                                <p style="margin: 8px 0;"><strong>Status:</strong> <span style="color: ${psData.status === 'approved' ? '#16a34a' : psData.status === 'rejected' ? '#dc2626' : '#d97706'}; font-weight: 600;">${psData.status ? psData.status.charAt(0).toUpperCase() + psData.status.slice(1) : 'Pending'}</span></p>
                                ${psData.approvedBy ? `<p style="margin: 8px 0;"><strong>Approved By:</strong> ${psData.approvedBy}</p>` : ''}
                                ${psData.approvedDate ? `<p style="margin: 8px 0;"><strong>Approved Date:</strong> ${new Date(psData.approvedDate).toLocaleDateString()}</p>` : ''}
                                ${psData.rejectedBy ? `<p style="margin: 8px 0;"><strong>Rejected By:</strong> ${psData.rejectedBy}</p>` : ''}
                                ${psData.rejectedDate ? `<p style="margin: 8px 0;"><strong>Rejected Date:</strong> ${new Date(psData.rejectedDate).toLocaleDateString()}</p>` : ''}
                                ${psData.remarks ? `<p style="margin: 8px 0;"><strong>Remarks:</strong> ${psData.remarks}</p>` : ''}
                                <p style="margin: 15px 0 0; font-size: 12px; color: #64748b;">Generated on: ${new Date().toLocaleString()}</p>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                                ${(!psData.status || psData.status === 'pending') ? `
                                    <button onclick="closePSDetailsModal(); approvePSVerification('${staff.staffId}')" style="background: #16a34a; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 0 8px; display: inline-flex; align-items: center; gap: 8px;">‚úÖ Approve</button>
                                    <button onclick="closePSDetailsModal(); rejectPSVerification('${staff.staffId}')" style="background: #dc2626; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 14px; cursor: pointer; margin: 0 8px; display: inline-flex; align-items: center; gap: 8px;">‚ùå Reject</button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // View PS details
        function viewPSDetails(staffId) {
            console.log('viewPSDetails called with staffId:', staffId);
            console.log('Current admissions data:', admissions);
            
            const staff = admissions.find(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return staffKey === staffId || staffKey == staffId;
            });
            console.log('Found staff:', staff);
            
            if (!staff) {
                alert('Staff not found!');
                return;
            }

            // Get comprehensive deduction data
            const staffDeductionData = staffDeductions[staffId] || {};
            
            // Calculate salary components (matching the payslip structure)
            const basicSalary = parseFloat(staff.basicSalary) || 0;
            const daPercentage = parseFloat(staff.da) || 0;
            const hraPercentage = parseFloat(staff.hra) || 0;
            const daAmount = daPercentage > 0 ? Math.round(basicSalary * daPercentage / 100) : 0;
            const hraAmount = hraPercentage > 0 ? Math.round(basicSalary * hraPercentage / 100) : 0;
            const specialPay = parseFloat(staff.specialPay) || 0;
            const specialAllowance = parseFloat(staff.specialAllowance) || 0;
            const otherAllowance = parseFloat(staff.otherAllowance) || 0;
            
            const grossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;

            // Calculate comprehensive deductions (matching the full payslip structure)
            const wheatAdvanceBalance = parseFloat(staffDeductionData.wheatAdvanceTotal) || 0;
            const wheatAdvance = wheatAdvanceBalance > 0 ? (parseFloat(staffDeductionData.wheatAdvanceRecovered) || 0) : 0;
            
            const gicBalance = parseFloat(staffDeductionData.gicTotal) || 0;
            const gicMonthly = parseFloat(staffDeductionData.gicMonthly) || 0;
            const gic = gicMonthly > 0 ? gicMonthly : 0;
            
            const licBalance = parseFloat(staffDeductionData.licTotal) || 0;
            const licMonthly = parseFloat(staffDeductionData.licMonthly) || 0;
            const lic = licMonthly > 0 ? licMonthly : 0;
            
            const electricityBillBalance = parseFloat(staffDeductionData.electricityBillTotal) || 0;
            const electricityBillMonthly = parseFloat(staffDeductionData.electricityBillMonthly) || 0;
            const electricityBill = electricityBillMonthly > 0 ? electricityBillMonthly : 0;
            
            const waterChargesBalance = parseFloat(staffDeductionData.waterChargesTotal) || 0;
            const waterChargesMonthly = parseFloat(staffDeductionData.waterChargesMonthly) || 0;
            const waterCharges = waterChargesMonthly > 0 ? waterChargesMonthly : 0;
            
            const recoveryBalance = parseFloat(staffDeductionData.recoveryTotal) || 0;
            const recoveryMonthly = parseFloat(staffDeductionData.recoveryMonthly) || 0;
            const recovery = recoveryMonthly > 0 ? recoveryMonthly : 0;
            
            const leaveDeductionsBalance = parseFloat(staffDeductionData.leaveDeductionsTotal) || 0;
            const leaveDeductions = leaveDeductionsBalance > 0 ? (parseFloat(staffDeductionData.leaveDeductionsMonthly) || 0) : 0;
            
            const gppcSubscriptionBalance = parseFloat(staffDeductionData.gppcSubscriptionTotal) || 0;
            const gppcSubscription = gppcSubscriptionBalance > 0 ? (parseFloat(staffDeductionData.gppcSubscriptionMonthly) || 0) : 0;
            
            const gpfExtraSubscriptionBalance = parseFloat(staffDeductionData.gpfExtraSubscriptionTotal) || 0;
            const gpfExtraSubscription = gpfExtraSubscriptionBalance > 0 ? (parseFloat(staffDeductionData.gpfExtraSubscriptionMonthly) || 0) : 0;
            
            const gpfGovernmentContributionBalance = parseFloat(staffDeductionData.gpfGovernmentContributionTotal) || 0;
            const gpfGovernmentContribution = gpfGovernmentContributionBalance > 0 ? (parseFloat(staffDeductionData.gpfGovernmentContributionMonthly) || 0) : 0;
            
            const gpfAdvanceRecoveryBalance = parseFloat(staffDeductionData.gpfAdvanceRecoveryTotal) || 0;
            const gpfAdvanceRecovery = gpfAdvanceRecoveryBalance > 0 ? (parseFloat(staffDeductionData.gpfAdvanceRecoveryRecovered) || 0) : 0;
            
            const npsGovernmentContributionBalance = parseFloat(staffDeductionData.npsGovernmentContributionTotal) || 0;
            const npsGovernmentContribution = npsGovernmentContributionBalance > 0 ? (parseFloat(staffDeductionData.npsGovernmentContributionMonthly) || 0) : 0;
            
            const npsSelfContributionBalance = parseFloat(staffDeductionData.npsSelfContributionTotal) || 0;
            const npsSelfContribution = npsSelfContributionBalance > 0 ? (parseFloat(staffDeductionData.npsSelfContributionMonthly) || 0) : 0;
            
            const incomeTaxBalance = parseFloat(staffDeductionData.incomeTaxTotal) || 0;
            const incomeTax = incomeTaxBalance > 0 ? (parseFloat(staffDeductionData.incomeTaxMonthly) || 0) : 0;
            
            const surChargesBalance = parseFloat(staffDeductionData.surChargesTotal) || 0;
            const surCharges = surChargesBalance > 0 ? (parseFloat(staffDeductionData.surChargesMonthly) || 0) : 0;
            
            const otherDeduction1Balance = parseFloat(staffDeductionData.otherDeduction1Total) || 0;
            const otherDeduction1 = otherDeduction1Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction1Monthly) || 0) : 0;
            
            const otherDeduction2Balance = parseFloat(staffDeductionData.otherDeduction2Total) || 0;
            const otherDeduction2 = otherDeduction2Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction2Monthly) || 0) : 0;
            
            const otherDeduction3Balance = parseFloat(staffDeductionData.otherDeduction3Total) || 0;
            const otherDeduction3 = otherDeduction3Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction3Monthly) || 0) : 0;

            // Add the 5 missing deduction categories
            const gpfLedBalanceOpening = parseFloat(staffDeductionData.gpfLedBalanceOpening) || 0;
            const gpfLedBalanceCurrent = parseFloat(staffDeductionData.gpfLedBalanceCurrent) || 0;
            const gpfLedBalance = gpfLedBalanceCurrent > 0 ? gpfLedBalanceCurrent : 0;
            
            const gpfAdvanceBalancePrevious = parseFloat(staffDeductionData.gpfAdvanceBalancePrevious) || 0;
            const gpfAdvanceBalanceRecovery = parseFloat(staffDeductionData.gpfAdvanceBalanceRecovery) || 0;
            const gpfAdvanceBalance = gpfAdvanceBalanceRecovery > 0 ? gpfAdvanceBalanceRecovery : 0;
            
            const bankRecoveryLoan = parseFloat(staffDeductionData.bankRecoveryLoan) || 0;
            const bankRecoveryPaid = parseFloat(staffDeductionData.bankRecoveryPaid) || 0;
            const bankRecovery = bankRecoveryPaid > 0 ? bankRecoveryPaid : 0;
            
            const gpfInterestTotal = parseFloat(staffDeductionData.gpfInterestTotal) || 0;
            const gpfInterestMonthly = parseFloat(staffDeductionData.gpfInterestMonthly) || 0;
            const gpfInterest = gpfInterestMonthly > 0 ? gpfInterestMonthly : 0;
            
            const gpfWithdrawlTotal = parseFloat(staffDeductionData.gpfWithdrawlTotal) || 0;
            const gpfWithdrawlMonthly = parseFloat(staffDeductionData.gpfWithdrawlMonthly) || 0;
            const gpfWithdrawl = gpfWithdrawlMonthly > 0 ? gpfWithdrawlMonthly : 0;

            // Use the simple "Total monthly deductions" from Deduction Management popup
            const totalDeductions = parseFloat(staffDeductionData.totalMonthlyDeductions) || 0;
            
            const netSalary = grossSalary - totalDeductions;
            
            // Use selected period instead of current date
            const selectedPeriod = window.selectedPSPeriod || { 
                month: new Date().getMonth() + 1, 
                year: new Date().getFullYear() 
            };
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const currentMonth = monthNames[selectedPeriod.month];
            const currentYear = selectedPeriod.year;
            
            const currentPeriodPSData = getCurrentPeriodPSData();
            const psData = currentPeriodPSData[staffId] || {};
            console.log('PS Data:', psData);
            console.log('Net salary calculated:', netSalary);

            const detailsHtml = `
                <div style="max-width: 900px; max-height: 85vh; overflow-y: auto;">
                    <style>
                        .ps-payslip-container {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            line-height: 1.4;
                        }
                        .ps-letterhead {
                            text-align: center;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .ps-letterhead h1 {
                            font-size: 24px;
                            margin: 0;
                            font-weight: 700;
                        }
                        .ps-letterhead h2 {
                            font-size: 18px;
                            margin: 5px 0;
                            font-weight: 600;
                        }
                        .ps-letterhead p {
                            font-size: 14px;
                            margin: 5px 0;
                        }
                        .ps-info-section {
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 15px;
                            border: 1px solid #e2e8f0;
                        }
                        .ps-info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 8px;
                            font-size: 14px;
                        }
                        .ps-info-grid div {
                            padding: 4px 0;
                        }
                        .ps-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 15px;
                            font-size: 14px;
                            border: 1px solid #e2e8f0;
                        }
                        .ps-table th {
                            background: #f1f5f9;
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                            border-bottom: 2px solid #e2e8f0;
                            color: #374151;
                        }
                        .ps-table td {
                            padding: 10px 8px;
                            border-bottom: 1px solid #f1f5f9;
                        }
                        .ps-amount {
                            text-align: right;
                            font-family: 'Courier New', monospace;
                            font-weight: 500;
                        }
                        .ps-total-row {
                            background: #f8fafc;
                            font-weight: 600;
                            border-top: 2px solid #e2e8f0;
                        }
                        .ps-section-title {
                            font-size: 16px;
                            font-weight: 600;
                            margin: 15px 0 10px 0;
                            color: #1e293b;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .ps-net-salary {
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            text-align: center;
                            margin: 15px 0;
                        }
                        .ps-net-amount {
                            font-size: 24px;
                            font-weight: 700;
                            margin: 5px 0;
                        }
                        .ps-verification-status {
                            background: #fffbeb;
                            border: 1px solid #fcd34d;
                            padding: 15px;
                            border-radius: 8px;
                            margin-top: 15px;
                        }
                        .ps-print-btn {
                            background: #0ea5e9;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 14px;
                            cursor: pointer;
                            margin: 10px 5px 0 0;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                        }
                        .ps-print-btn:hover {
                            background: #0284c7;
                        }
                        .ps-action-buttons {
                            margin-top: 15px;
                            text-align: center;
                            padding-top: 15px;
                            border-top: 1px solid #e2e8f0;
                        }
                    </style>
                    
                    <div class="ps-payslip-container">
                        <div class="ps-letterhead">
                            <h1>CANTONMENT BOARD AMBALA</h1>
                            <h2>PAY SLIP - PS VERIFICATION</h2>
                            <p>For the month of ${currentMonth} ${currentYear}</p>
                            <p style="margin-top: 10px; font-weight: bold;">Employee: ${staff.staffName}</p>
                        </div>
                        
                        <div class="ps-info-section">
                            <h3 class="ps-section-title">üìã Employee Information</h3>
                            <div class="ps-info-grid">
                                <div><strong>Staff ID:</strong> ${staff.staffId}</div>
                                <div><strong>Name:</strong> ${staff.staffName}</div>
                                <div><strong>Father's Name:</strong> ${staff.fatherName || 'N/A'}</div>
                                <div><strong>Mother's Name:</strong> ${staff.motherName || 'N/A'}</div>
                                <div><strong>Mobile:</strong> ${staff.mobileNumber || 'N/A'}</div>
                                <div><strong>Email:</strong> ${staff.email || 'N/A'}</div>
                                <div><strong>Designation:</strong> ${staff.designation || 'N/A'}</div>
                                <div><strong>Department:</strong> ${staff.department || 'N/A'}</div>
                                <div><strong>Date of Birth:</strong> ${staff.dateOfBirth || 'N/A'}</div>
                                <div><strong>Date of Joining:</strong> ${staff.dateOfAppointment || 'N/A'}</div>
                                <div><strong>Address:</strong> ${staff.address || 'N/A'}</div>
                                <div><strong>Nationality:</strong> ${staff.nationality || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <h3 class="ps-section-title">üí∞ Salary Structure</h3>
                        <table class="ps-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th class="ps-amount">Amount (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td>Basic Pay</td><td class="ps-amount">${basicSalary.toLocaleString()}</td></tr>
                                <tr><td>Dearness Allowance (${daPercentage}%)</td><td class="ps-amount">${daAmount.toLocaleString()}</td></tr>
                                <tr><td>HRA (${hraPercentage}%)</td><td class="ps-amount">${hraAmount.toLocaleString()}</td></tr>
                                ${specialPay > 0 ? `<tr><td>Special Pay</td><td class="ps-amount">${specialPay.toLocaleString()}</td></tr>` : ''}
                                ${specialAllowance > 0 ? `<tr><td>Special Allowance</td><td class="ps-amount">${specialAllowance.toLocaleString()}</td></tr>` : ''}
                                ${otherAllowance > 0 ? `<tr><td>Other Allowance</td><td class="ps-amount">${otherAllowance.toLocaleString()}</td></tr>` : ''}
                                <tr class="ps-total-row"><td><strong>Gross Salary</strong></td><td class="ps-amount"><strong>‚Çπ${grossSalary.toLocaleString()}</strong></td></tr>
                            </tbody>
                        </table>
                        
                        <h3 class="ps-section-title">üìâ Deductions</h3>
                        <table class="ps-table">
                            <thead>
                                <tr>
                                    <th>Component</th>
                                    <th class="ps-amount">Amount (‚Çπ)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${wheatAdvance > 0 ? `<tr><td>Wheat Advance</td><td class="ps-amount">${wheatAdvance.toLocaleString()}</td></tr>` : ''}
                                ${gic > 0 ? `<tr><td>GIC (General Insurance Corporation)</td><td class="ps-amount">${gic.toLocaleString()}</td></tr>` : ''}
                                ${lic > 0 ? `<tr><td>LIC (Life Insurance Corporation)</td><td class="ps-amount">${lic.toLocaleString()}</td></tr>` : ''}
                                ${electricityBill > 0 ? `<tr><td>Electricity Bill</td><td class="ps-amount">${electricityBill.toLocaleString()}</td></tr>` : ''}
                                ${waterCharges > 0 ? `<tr><td>Water Charges</td><td class="ps-amount">${waterCharges.toLocaleString()}</td></tr>` : ''}
                                ${recovery > 0 ? `<tr><td>General Recovery</td><td class="ps-amount">${recovery.toLocaleString()}</td></tr>` : ''}
                                ${leaveDeductions > 0 ? `<tr><td>Leave Deductions</td><td class="ps-amount">${leaveDeductions.toLocaleString()}</td></tr>` : ''}
                                ${gppcSubscription > 0 ? `<tr><td>GPPC Subscription</td><td class="ps-amount">${gppcSubscription.toLocaleString()}</td></tr>` : ''}
                                ${gpfExtraSubscription > 0 ? `<tr><td>GPF Extra Subscription</td><td class="ps-amount">${gpfExtraSubscription.toLocaleString()}</td></tr>` : ''}
                                ${gpfGovernmentContribution > 0 ? `<tr><td>GPF Government Contribution</td><td class="ps-amount">${gpfGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                ${gpfAdvanceRecovery > 0 ? `<tr><td>GPF Advance Recovery</td><td class="ps-amount">${gpfAdvanceRecovery.toLocaleString()}</td></tr>` : ''}
                                ${npsGovernmentContribution > 0 ? `<tr><td>NPS Government Contribution</td><td class="ps-amount">${npsGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                                ${npsSelfContribution > 0 ? `<tr><td>NPS Self Contribution</td><td class="ps-amount">${npsSelfContribution.toLocaleString()}</td></tr>` : ''}
                                ${incomeTax > 0 ? `<tr><td>Income Tax</td><td class="ps-amount">${incomeTax.toLocaleString()}</td></tr>` : ''}
                                ${surCharges > 0 ? `<tr><td>Sur-charges</td><td class="ps-amount">${surCharges.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction1 > 0 ? `<tr><td>Other Deduction-1</td><td class="ps-amount">${otherDeduction1.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction2 > 0 ? `<tr><td>Other Deduction-2</td><td class="ps-amount">${otherDeduction2.toLocaleString()}</td></tr>` : ''}
                                ${otherDeduction3 > 0 ? `<tr><td>Other Deduction-3</td><td class="ps-amount">${otherDeduction3.toLocaleString()}</td></tr>` : ''}
                                ${totalDeductions === 0 ? '<tr><td colspan="2" style="text-align: center; font-style: italic; color: #666;">No deductions for this month</td></tr>' : ''}
                                <tr class="ps-total-row"><td><strong>Total Deductions</strong></td><td class="ps-amount"><strong>‚Çπ${totalDeductions.toLocaleString()}</strong></td></tr>
                            </tbody>
                        </table>
                        
                        <div class="ps-net-salary">
                            <h3 style="margin: 0; font-size: 18px;">üíµ Net Salary</h3>
                            <div class="ps-net-amount">‚Çπ${netSalary.toLocaleString()}</div>
                            <p style="margin: 5px 0 0 0; font-size: 14px; opacity: 0.9;">Gross Salary - Total Deductions</p>
                        </div>
                        
                        <div class="ps-verification-status">
                            <h4 style="margin: 0 0 10px 0; color: #d97706;">üìä Verification Status</h4>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="color: ${psData.status === 'approved' ? '#16a34a' : psData.status === 'rejected' ? '#dc2626' : '#d97706'}; font-weight: 600;">${psData.status ? psData.status.charAt(0).toUpperCase() + psData.status.slice(1) : 'Pending'}</span></p>
                            ${psData.approvedBy ? `<p style="margin: 5px 0;"><strong>Approved By:</strong> ${psData.approvedBy}</p>` : ''}
                            ${psData.approvedDate ? `<p style="margin: 5px 0;"><strong>Approved Date:</strong> ${new Date(psData.approvedDate).toLocaleDateString()}</p>` : ''}
                            ${psData.rejectedBy ? `<p style="margin: 5px 0;"><strong>Rejected By:</strong> ${psData.rejectedBy}</p>` : ''}
                            ${psData.rejectedDate ? `<p style="margin: 5px 0;"><strong>Rejected Date:</strong> ${new Date(psData.rejectedDate).toLocaleDateString()}</p>` : ''}
                            ${psData.remarks ? `<p style="margin: 5px 0;"><strong>Remarks:</strong> ${psData.remarks}</p>` : ''}
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #64748b;">Generated on: ${new Date().toLocaleString()}</p>
                        </div>
                        
                        <div class="ps-action-buttons">
                            ${(!psData.status || psData.status === 'pending') ? `
                                <button class="ps-print-btn" style="background: #16a34a;" onclick="closePSDetailsModal(); approvePSVerification('${staffId}');">
                                    ‚úÖ Approve
                                </button>
                                <button class="ps-print-btn" style="background: #dc2626; margin-left: 10px;" onclick="closePSDetailsModal(); rejectPSVerification('${staffId}');">
                                    ‚ùå Reject
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            console.log('About to create modal...');
            
            // Create custom modal for PS details
            const existingModal = document.getElementById('psDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            console.log('Building modal HTML...');
            
            // Create professional payslip modal
            const modalHtml = createPSDetailsModalHTML(staff, {
                basicSalary,
                daAmount, 
                hraAmount,
                specialPay,
                specialAllowance, 
                otherAllowance,
                grossSalary,
                totalDeductions,
                netSalary,
                daPercentage,
                hraPercentage,
                currentMonth,
                currentYear
            }, {
                wheatAdvance,
                gic,
                lic,
                electricityBill,
                waterCharges,
                recovery,
                leaveDeductions,
                gppcSubscription,
                gpfExtraSubscription,
                gpfGovernmentContribution,
                gpfAdvanceRecovery,
                npsGovernmentContribution,
                npsSelfContribution,
                incomeTax,
                surCharges,
                otherDeduction1,
                otherDeduction2,
                otherDeduction3,
                gpfLedBalance,
                gpfAdvanceBalance,
                bankRecovery,
                gpfInterest,
                gpfWithdrawl
            }, psData);
            
            console.log('Inserting modal into DOM...');
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            console.log('Modal inserted successfully');
            
            // Disable body scrolling
            document.body.style.overflow = 'hidden';
            console.log('Body scroll disabled');
            
            // Close on overlay click
            document.getElementById('psDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePSDetailsModal();
                }
            });
        }

        // Close PS details modal function
        function closePSDetailsModal() {
            const modal = document.getElementById('psDetailsModal');
            if (modal) {
                modal.remove();
            }
            // Restore body scrolling
            document.body.style.overflow = '';
        }

        // Print PS payslip function
        function printPSPayslip(staffId, staffName) {
            const modalContent = document.querySelector('#psDetailsModal > div');
            if (!modalContent) {
                alert('Please open payslip details first');
                return;
            }
            
            const printContent = modalContent.innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title> </title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 0; 
                                padding: 20px;
                                color: #333;
                            }
                            table { 
                                border-collapse: collapse; 
                                width: 100%; 
                                margin-bottom: 20px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 8px; 
                                text-align: left;
                            }
                            th {
                                background-color: #f1f5f9 !important;
                                font-weight: 600;
                            }
                            .net-salary-section {
                                background: #10b981 !important;
                                color: white !important;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .header-section {
                                background: #667eea !important;
                                color: white !important;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            .action-buttons {
                                display: none !important;
                            }
                            @media print { 
                                body { margin: 0; padding: 10px; }
                                .action-buttons { display: none !important; }
                                button { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent.replace(/onclick="[^"]*"/g, '').replace(/<button[^>]*>.*?<\/button>/gs, '')}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Print payslip function (original)
        function printPayslip(staffId, staffName) {
            const printContent = document.querySelector('.ps-payslip-container').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title> </title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .ps-payslip-container { max-width: 100%; }
                            .ps-letterhead { background: #667eea !important; color: white !important; -webkit-print-color-adjust: exact; }
                            .ps-table { border-collapse: collapse; width: 100%; }
                            .ps-table th, .ps-table td { border: 1px solid #ddd; padding: 8px; }
                            .ps-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
                            .ps-net-salary { background: #10b981 !important; color: white !important; -webkit-print-color-adjust: exact; }
                            .ps-action-buttons { display: none; }
                            @media print { 
                                @page {
                                    margin: 0;
                                    size: auto;
                                }
                                body { 
                                    margin: 15mm; 
                                } 
                                .ps-action-buttons { display: none !important; } 
                            }
                        </style>
                    </head>
                    <body>
                        <div class="ps-payslip-container">
                            ${printContent.replace(/<div class="ps-action-buttons">.*?<\/div>/s, '')}
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Approve PS verification
        async function approvePSVerification(staffId) {
            const staff = admissions.find(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return staffKey === staffId || staffKey == staffId;
            });
            if (!staff) {
                alert('Staff not found!');
                return;
            }

            const grossSalary = calculateGrossSalaryForPS(staff);
            const totalDeductions = calculateTotalDeductions(staffId);
            const netSalary = grossSalary - totalDeductions;
            const currentUser = getCurrentUser();

            showPSApprovalConfirmation(staff, {
                grossSalary,
                totalDeductions,
                netSalary
            }, async () => {
                try {
                    // Call API to approve PS verification (only when running on web server)
                    if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                        const response = await fetch(`/api/ps-verification/${staffId}/approve`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': 'Bearer ' + authToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                approvedBy: currentUser ? currentUser.fullName : 'Current User',
                                remarks: ''
                            })
                        });

                        if (response.ok) {
                            console.log('PS verification approved via API');
                        } else {
                            const error = await response.json();
                            alert('Failed to approve PS verification: ' + (error.error || 'Unknown error'));
                            return; // Don't update local state if API failed
                        }
                    } else {
                        console.log('Running from file system - updating localStorage only');
                    }

                    // Update local PS verification status for current period
                    updateCurrentPeriodPSData(staffId, {
                        status: 'approved',
                        approvedBy: currentUser ? currentUser.fullName : 'Current User',
                        approvedDate: new Date().toISOString(),
                        updatedDate: new Date().toISOString()
                    });

                    // Re-render table
                    renderPSVerificationTable();

                    // Show success message
                    showPSApprovalSuccess(staff);
                } catch (error) {
                    console.error('Error approving PS verification:', error);
                    if (window.location.protocol === 'file:') {
                        // Still proceed with localStorage update when running from file system
                        updateCurrentPeriodPSData(staffId, {
                            status: 'approved',
                            approvedBy: currentUser ? currentUser.fullName : 'Current User',
                            approvedDate: new Date().toISOString(),
                            updatedDate: new Date().toISOString()
                        });
                        renderPSVerificationTable();
                        showPSApprovalSuccess(staff);
                    } else {
                        alert('Failed to approve PS verification. Please try again.');
                    }
                }
            });
        }

        // Reject PS verification
        async function rejectPSVerification(staffId) {
            const staff = admissions.find(s => {
                const staffKey = s.staffId || s.id || s.staff_id;
                return staffKey === staffId || staffKey == staffId;
            });
            if (!staff) {
                alert('Staff not found!');
                return;
            }

            const grossSalary = calculateGrossSalaryForPS(staff);
            const totalDeductions = calculateTotalDeductions(staffId);
            const netSalary = grossSalary - totalDeductions;
            const currentUser = getCurrentUser();
            const staffDisplay = staff.staffName || 'N/A';
            const staffIdDisplay = staffId || 'N/A';

            const reason = prompt(`‚ùå REJECT PAYROLL VERIFICATION

Please provide a reason for rejecting the payroll for:

Staff: ${staffDisplay} (${staffIdDisplay})
Net Salary: ‚Çπ${netSalary.toLocaleString()}`);
            
            if (reason && reason.trim()) {
                try {
                    // Call API to reject PS verification (only when running on web server)
                    if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                        const response = await fetch(`/api/ps-verification/${staffId}/reject`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': 'Bearer ' + authToken,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                rejectedBy: currentUser ? currentUser.fullName : 'Current User',
                                remarks: reason.trim()
                            })
                        });

                        if (response.ok) {
                            console.log('PS verification rejected via API');
                        } else {
                            const error = await response.json();
                            alert('Failed to reject PS verification: ' + (error.error || 'Unknown error'));
                            return; // Don't update local state if API failed
                        }
                    } else {
                        console.log('Running from file system - updating localStorage only');
                    }

                    // Update local PS verification status for current period
                    updateCurrentPeriodPSData(staffId, {
                        status: 'rejected',
                        rejectedBy: currentUser ? currentUser.fullName : 'Current User',
                        rejectedDate: new Date().toISOString(),
                        remarks: reason.trim(),
                        updatedDate: new Date().toISOString()
                    });

                    // Re-render table
                    renderPSVerificationTable();

                    // Show professional notification
                    showPSNotification('Rejected', `Payroll rejected for ${staffDisplay}`, 'error');
                } catch (error) {
                    console.error('Error rejecting PS verification:', error);
                    if (window.location.protocol === 'file:') {
                        // Still proceed with localStorage update when running from file system
                        updateCurrentPeriodPSData(staffId, {
                            status: 'rejected',
                            rejectedBy: currentUser ? currentUser.fullName : 'Current User',
                            rejectedDate: new Date().toISOString(),
                            remarks: reason.trim(),
                            updatedDate: new Date().toISOString()
                        });
                        renderPSVerificationTable();
                        showPSNotification('Rejected', `Payroll rejected for ${staffDisplay}`, 'error');
                    } else {
                        alert('Failed to reject PS verification. Please try again.');
                    }
                }
            }
        }

        // Show professional notification
        function showPSNotification(title, message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'times-circle'}"></i>
                <div>
                    <div style="font-weight: 600;">${title}</div>
                    <div style="opacity: 0.9;">${message}</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Add animation styles if not exist
            if (!document.getElementById('psNotificationStyles')) {
                const style = document.createElement('style');
                style.id = 'psNotificationStyles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Show professional PS approval confirmation modal
        function showPSApprovalConfirmation(staff, salaryInfo, onConfirm) {
            const { grossSalary, totalDeductions, netSalary } = salaryInfo;
            
            const modalHtml = `
                <div id="psApprovalModal" style="position: fixed; z-index: 15000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
                    <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 25px 80px rgba(0,0,0,0.4); overflow: hidden; animation: slideUp 0.3s ease;">
                        
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 30px; text-align: center; position: relative;">
                            <div style="background: rgba(255,255,255,0.2); width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                                ‚úÖ
                            </div>
                            <h2 style="margin: 0; font-size: 24px; font-weight: 700;">Approve PS Verification</h2>
                            <p style="margin: 10px 0 0; font-size: 14px; opacity: 0.9;">Confirm payroll approval for staff member</p>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 30px;">
                            <!-- Staff Info -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid #16a34a;">
                                <h3 style="margin: 0 0 15px; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                    <span style="background: #16a34a; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">üë§</span>
                                    Staff Information
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 14px;">
                                    <div><strong>Staff ID:</strong> <span style="color: #059669; font-weight: 600;">${staff.staffId}</span></div>
                                    <div><strong>Name:</strong> <span style="color: #059669; font-weight: 600;">${staff.staffName}</span></div>
                                    <div><strong>Father's Name:</strong> ${staff.fatherName || 'N/A'}</div>
                                    <div><strong>Designation:</strong> ${staff.designation || 'N/A'}</div>
                                </div>
                            </div>
                            
                            <!-- Salary Summary -->
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #bbf7d0;">
                                <h3 style="margin: 0 0 15px; color: #166534; font-size: 18px; display: flex; align-items: center; gap: 10px;">
                                    <span style="background: #16a34a; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">üí∞</span>
                                    Salary Summary
                                </h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 15px;">
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
                                        <div style="font-size: 12px; color: #65a30d; font-weight: 500; text-transform: uppercase; margin-bottom: 5px;">Gross Salary</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #16a34a;">‚Çπ${grossSalary.toLocaleString()}</div>
                                    </div>
                                    <div style="text-align: center; background: white; padding: 15px; border-radius: 8px; border: 1px solid #bbf7d0;">
                                        <div style="font-size: 12px; color: #dc2626; font-weight: 500; text-transform: uppercase; margin-bottom: 5px;">Deductions</div>
                                        <div style="font-size: 20px; font-weight: 700; color: #dc2626;">‚Çπ${totalDeductions.toLocaleString()}</div>
                                    </div>
                                </div>
                                <div style="text-align: center; background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 20px; border-radius: 12px; margin-top: 15px;">
                                    <div style="font-size: 14px; font-weight: 500; text-transform: uppercase; margin-bottom: 8px; opacity: 0.9;">Net Salary</div>
                                    <div style="font-size: 28px; font-weight: 800;">‚Çπ${netSalary.toLocaleString()}</div>
                                </div>
                            </div>
                            
                            <!-- Confirmation Message -->
                            <div style="background: #fffbeb; border: 2px solid #fbbf24; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center;">
                                <div style="font-size: 16px; color: #92400e; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è Confirmation Required</div>
                                <div style="font-size: 14px; color: #78350f;">Are you sure you want to approve this PS verification? This action cannot be undone easily.</div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <button onclick="closePSApprovalModal()" style="background: #f1f5f9; color: #475569; border: 2px solid #e2e8f0; padding: 12px 30px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px;" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f1f5f9'">
                                    Cancel
                                </button>
                                <button onclick="confirmPSApproval()" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; min-width: 120px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(22, 163, 74, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(22, 163, 74, 0.3)'">
                                    ‚úÖ Confirm Approval
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from { transform: translateY(30px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                </style>
            `;
            
            // Store the callback
            console.log('Storing PS approval callback:', onConfirm);
            window.pendingPSApproval = onConfirm;
            console.log('Stored callback:', window.pendingPSApproval);
            
            // Add to DOM
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
        }

        // Close PS approval modal
        function closePSApprovalModal() {
            const modal = document.getElementById('psApprovalModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
            window.pendingPSApproval = null;
        }

        // Confirm PS approval
        function confirmPSApproval() {
            console.log('confirmPSApproval called');
            console.log('pendingPSApproval:', window.pendingPSApproval);
            
            if (window.pendingPSApproval && typeof window.pendingPSApproval === 'function') {
                const callback = window.pendingPSApproval;
                closePSApprovalModal();
                callback();
            } else {
                console.error('No pending PS approval callback found');
                closePSApprovalModal();
            }
        }

        // Show PS approval success modal
        function showPSApprovalSuccess(staff) {
            const modalHtml = `
                <div id="psSuccessModal" style="position: fixed; z-index: 15000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; animation: fadeIn 0.3s ease;">
                    <div style="background: white; border-radius: 16px; max-width: 450px; width: 90%; box-shadow: 0 25px 80px rgba(0,0,0,0.4); overflow: hidden; text-align: center; animation: slideUp 0.3s ease;">
                        
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; padding: 40px 30px; position: relative;">
                            <div style="background: rgba(255,255,255,0.2); width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 50px; animation: bounce 0.6s ease;">
                                ‚úÖ
                            </div>
                            <h2 style="margin: 0; font-size: 26px; font-weight: 700;">Approval Successful!</h2>
                            <p style="margin: 15px 0 0; font-size: 16px; opacity: 0.9;">PS verification has been approved</p>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 30px;">
                            <div style="background: #f0fdf4; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #bbf7d0;">
                                <h3 style="margin: 0 0 10px; color: #166534; font-size: 18px;">Approved Staff Member</h3>
                                <p style="margin: 0; color: #059669; font-size: 16px; font-weight: 600;">${staff.staffName} (${staff.staffId})</p>
                                <p style="margin: 8px 0 0; color: #65a30d; font-size: 14px;">${staff.designation || 'N/A'}</p>
                            </div>
                            
                            <div style="background: #fefce8; padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid #fde047;">
                                <p style="margin: 0; color: #854d0e; font-size: 14px; font-weight: 500;">
                                    üìã The payroll verification has been approved and saved to the system.
                                </p>
                            </div>
                            
                            <button onclick="closePSSuccessModal()" style="background: linear-gradient(135deg, #16a34a 0%, #15803d 100%); color: white; border: none; padding: 15px 40px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
                
                <style>
                    @keyframes bounce {
                        0%, 20%, 60%, 100% { transform: translateY(0); }
                        40% { transform: translateY(-10px); }
                        80% { transform: translateY(-5px); }
                    }
                </style>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.body.style.overflow = 'hidden';
            
            // Auto-close after 3 seconds
            setTimeout(() => {
                closePSSuccessModal();
            }, 3000);
        }

        // Close PS success modal
        function closePSSuccessModal() {
            const modal = document.getElementById('psSuccessModal');
            if (modal) {
                modal.remove();
            }
            document.body.style.overflow = '';
        }

        // Reset all PS verifications back to pending status for current period
        function resetAllPSVerifications() {
            const currentPeriod = window.selectedPSPeriod || { month: new Date().getMonth() + 1, year: new Date().getFullYear() };
            const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const periodName = `${monthNames[currentPeriod.month]} ${currentPeriod.year}`;
            
            const confirmation = confirm(`üîÑ RESET PAYSLIPS FOR ${periodName.toUpperCase()}\n\nThis will reset ALL staff PS verifications back to "Pending" status for ${periodName} only.\n\nAre you sure you want to continue?`);
            
            if (confirmation) {
                console.log('Resetting all PS verifications to pending status for period:', periodName);
                
                const currentPeriodPSData = getCurrentPeriodPSData();
                
                // Reset all PS verification statuses for current period
                if (currentPeriodPSData) {
                    Object.keys(currentPeriodPSData).forEach(staffKey => {
                        updateCurrentPeriodPSData(staffKey, {
                            status: 'pending',
                            approvedBy: null,
                            approvedDate: null,
                            rejectedBy: null,
                            rejectedDate: null,
                            remarks: '',
                            updatedDate: new Date().toISOString()
                        });
                    });
                    
                    // Re-render the table
                    renderPSVerificationTable();
                    
                    // Show success message
                    showResetNotification(periodName);
                    
                    console.log('All PS verifications reset to pending status for period:', periodName);
                } else {
                    alert(`No PS verification data found for ${periodName}.`);
                }
            }
        }

        // Show reset success notification
        function showResetNotification(periodName = 'current period') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 14px;
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;
            
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <div>
                    <div style="font-weight: 600;">Reset Successful</div>
                    <div style="opacity: 0.9;">All payslips for ${periodName} reset to pending status</div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Export PS Verification data
        function exportPSVerification() {
            console.log('Export PS Verification clicked');
            
            // Get current period
            const currentPeriod = window.selectedPSPeriod || { 
                month: new Date().getMonth() + 1, 
                year: new Date().getFullYear() 
            };
            
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const periodName = `${monthNames[currentPeriod.month - 1]} ${currentPeriod.year}`;
            
            // Get filtered staff (same logic as PS Verification display)
            const filteredStaff = admissions.filter(staff => {
                // Apply the same appointment date filtering as PS Verification
                const appointmentDate = staff.dateOfAppointment || staff.date_of_appointment;
                if (appointmentDate && currentPeriod) {
                    // Parse appointment date correctly (DD-MM-YYYY format)
                    let staffAppointmentDate;
                    if (appointmentDate.includes('-') && appointmentDate.split('-').length === 3) {
                        const parts = appointmentDate.split('-');
                        if (parts.length === 3 && parts[0].length <= 2 && parts[1].length <= 2 && parts[2].length === 4) {
                            const day = parseInt(parts[0]);
                            const month = parseInt(parts[1]) - 1;
                            const year = parseInt(parts[2]);
                            staffAppointmentDate = new Date(year, month, day);
                        } else {
                            staffAppointmentDate = new Date(appointmentDate);
                        }
                    } else {
                        staffAppointmentDate = new Date(appointmentDate);
                    }
                    
                    if (staffAppointmentDate) {
                        const staffAppointmentMonth = staffAppointmentDate.getMonth() + 1;
                        const staffAppointmentYear = staffAppointmentDate.getFullYear();
                        
                        // Staff should appear if appointed in or before the selected month/year
                        if (staffAppointmentYear < currentPeriod.year) {
                            // Appointed in previous years - include
                        } else if (staffAppointmentYear === currentPeriod.year) {
                            // Same year - check month
                            if (staffAppointmentMonth > currentPeriod.month) {
                                return false; // Appointed in future month of same year
                            }
                        } else {
                            return false; // Appointed in future years
                        }
                    }
                }
                return true; // Include staff without appointment date or valid staff
            });
            
            // Create PDF document
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a3'); // A3 Landscape for more space
            
            // Set font
            doc.setFont('helvetica');
            
            // Header
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Cantonment Board Ambala', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            doc.setFontSize(14);
            doc.setFont('helvetica', 'normal');
            doc.text('Account Details', doc.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Period: ${periodName}`, doc.internal.pageSize.getWidth() / 2, 40, { align: 'center' });
            
            // Table headers
            const headers = [
                'Sr.No.',
                'Staff ID',
                'Name', 
                'Father Name',
                'Designation',
                'Net Salary',
                'Bank Name',
                'Account Number',
                'IFSC Code',
                'MICR Code'
            ];
            
            // Table data
            const tableData = filteredStaff.map((staff, index) => {
                // Use the same calculation method as PS Verification
                const netSalary = calculateNetSalary(staff);
                
                // Clean number formatting without currency symbols
                const cleanNetSalary = parseFloat(netSalary) || 0;
                
                return [
                    index + 1, // Sr.No. starting from 1
                    staff.staffId || 'N/A',
                    staff.staffName || 'N/A',
                    staff.fatherName || 'N/A',
                    staff.designation || 'N/A',
                    cleanNetSalary.toLocaleString('en-IN'),
                    staff.bankName || 'N/A',
                    staff.accountNumber || 'N/A',
                    staff.ifscCode || 'N/A',
                    staff.micrCode || 'N/A'
                ];
            });
            
            // Add table using autoTable plugin
            doc.autoTable({
                head: [headers],
                body: tableData,
                startY: 50,
                theme: 'striped',
                headStyles: {
                    fillColor: [41, 128, 185],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11,
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 3,
                    lineWidth: 0.2
                },
                columnStyles: {
                    0: { cellWidth: 20, halign: 'center' }, // Sr.No. (new column)
                    1: { cellWidth: 25, halign: 'center' }, // Staff ID (reduced)
                    2: { cellWidth: 45, halign: 'left' }, // Name (reduced, left aligned)
                    3: { cellWidth: 45, halign: 'left' }, // Father Name (reduced, left aligned)
                    4: { cellWidth: 50, halign: 'center' }, // Designation (increased)
                    5: { cellWidth: 30, halign: 'center' }, // Net Salary (reduced)
                    6: { cellWidth: 55, halign: 'center' }, // Bank Name (increased)
                    7: { cellWidth: 50, halign: 'center' }, // Account Number (increased)
                    8: { cellWidth: 35, halign: 'center' }, // IFSC Code (same)
                    9: { cellWidth: 30, halign: 'center' }  // MICR Code (same)
                },
                didParseCell: function(data) {
                    // Left align headers for Name and Father Name columns
                    if (data.section === 'head' && (data.column.index === 2 || data.column.index === 3)) {
                        data.cell.styles.halign = 'left';
                    }
                },
                tableWidth: 'auto',
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    // Footer
                    const pageCount = doc.internal.getNumberOfPages();
                    const currentPage = doc.internal.getCurrentPageInfo().pageNumber;
                    
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Generated on: ${new Date().toLocaleString('en-IN')}`, 10, doc.internal.pageSize.getHeight() - 10);
                    doc.text(`Page ${currentPage} of ${pageCount}`, doc.internal.pageSize.getWidth() - 30, doc.internal.pageSize.getHeight() - 10);
                }
            });
            
            // Calculate total net salary
            const totalNetSalary = filteredStaff.reduce((total, staff) => {
                const netSalary = calculateNetSalary(staff);
                const cleanNetSalary = parseFloat(netSalary) || 0;
                return total + cleanNetSalary;
            }, 0);
            
            // Add compact total amount box at the bottom of the page
            const pageHeight = doc.internal.pageSize.getHeight();
            const boxWidth = 80;
            const boxHeight = 20;
            const boxX = doc.internal.pageSize.getWidth() - boxWidth - 15;
            const boxY = pageHeight - 40; // Position near bottom of page
            
            // Draw shadow effect (slightly offset dark box)
            doc.setFillColor(200, 200, 200);
            doc.rect(boxX + 1, boxY + 1, boxWidth, boxHeight, 'F');
            
            // Draw main box
            doc.setDrawColor(41, 128, 185);
            doc.setLineWidth(1);
            doc.setFillColor(248, 252, 255); // Very light blue background
            doc.rect(boxX, boxY, boxWidth, boxHeight, 'FD');
            
            // Add total label
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(41, 128, 185);
            doc.text('TOTAL AMOUNT', boxX + boxWidth/2, boxY + 8, { align: 'center' });
            
            // Add amount
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 100, 0); // Dark green for money
            // Simple number formatting to avoid any PDF rendering issues
            const formattedTotal = Math.round(totalNetSalary).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            doc.text('Rs. ' + formattedTotal, boxX + boxWidth/2, boxY + 16, { align: 'center' });
            
            // Save the PDF
            const fileName = `CBA_Account_Details_${periodName.replace(' ', '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            doc.save(fileName);
            
            // Show enhanced success message
            setTimeout(() => {
                showExportSuccessModal(fileName, filteredStaff.length, periodName);
            }, 500);
        }

        // Enhanced export success modal
        function showExportSuccessModal(fileName, recordCount, periodName) {
            // Create modal backdrop
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                z-index: 10000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.6);
                backdrop-filter: blur(5px);
                animation: fadeIn 0.3s ease;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                padding: 40px;
                border-radius: 16px;
                box-shadow: 0 25px 50px rgba(0,0,0,0.25);
                text-align: center;
                max-width: 500px;
                width: 90%;
                position: relative;
                border: 1px solid #e2e8f0;
                animation: slideInUp 0.4s ease;
            `;

            modalContent.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        border-radius: 50%;
                        margin: 0 auto 20px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
                        animation: bounceIn 0.6s ease 0.2s both;
                    ">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="20 6L9 17l-5-5"/>
                        </svg>
                    </div>
                    
                    <h2 style="
                        color: #1e293b;
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 12px;
                        font-family: 'Segoe UI', sans-serif;
                    ">Export Successful!</h2>
                    
                    <p style="
                        color: #64748b;
                        font-size: 16px;
                        margin-bottom: 30px;
                        line-height: 1.5;
                    ">Account details have been exported successfully</p>
                </div>

                <div style="
                    background: #f1f5f9;
                    border-radius: 12px;
                    padding: 25px;
                    margin-bottom: 30px;
                    border-left: 4px solid #10b981;
                ">
                    <div style="display: grid; grid-template-columns: auto 1fr; gap: 15px; text-align: left;">
                        <div style="display: flex; align-items: center; color: #475569;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                            </svg>
                            <strong>File:</strong>
                        </div>
                        <div style="color: #334155; font-family: monospace; font-size: 14px; word-break: break-all;">
                            ${fileName}
                        </div>
                        
                        <div style="display: flex; align-items: center; color: #475569;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <path d="17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <strong>Records:</strong>
                        </div>
                        <div style="color: #334155; font-weight: 600;">
                            ${recordCount} staff members
                        </div>
                        
                        <div style="display: flex; align-items: center; color: #475569;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            <strong>Period:</strong>
                        </div>
                        <div style="color: #334155; font-weight: 600;">
                            ${periodName}
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button onclick="this.closest('.modal').remove()" style="
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        padding: 12px 30px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                        font-size: 16px;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                    " onmouseover="
                        this.style.transform='translateY(-2px)';
                        this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.4)';
                    " onmouseout="
                        this.style.transform='translateY(0px)';
                        this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.3)';
                    ">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px; vertical-align: middle;">
                            <path d="20 6L9 17l-5-5"/>
                        </svg>
                        Got it!
                    </button>
                </div>
            `;

            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideInUp {
                    from { 
                        opacity: 0; 
                        transform: translateY(30px) scale(0.9); 
                    }
                    to { 
                        opacity: 1; 
                        transform: translateY(0px) scale(1); 
                    }
                }
                @keyframes bounceIn {
                    0% { 
                        opacity: 0; 
                        transform: scale(0.3); 
                    }
                    50% { 
                        opacity: 1; 
                        transform: scale(1.05); 
                    }
                    70% { 
                        transform: scale(0.9); 
                    }
                    100% { 
                        opacity: 1; 
                        transform: scale(1); 
                    }
                }
            `;
            document.head.appendChild(style);

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Auto-close after 8 seconds
            setTimeout(() => {
                if (modal.parentNode) {
                    modal.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => modal.remove(), 300);
                }
            }, 8000);

            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Get current user
        function getCurrentUser() {
            // Return the current logged-in user data
            return currentUserData || JSON.parse(localStorage.getItem('currentUser')) || null;
        }

        // Function to generate pay slip for a specific staff member
        function generatePaySlipForStaff(staff) {
            const staffDeductionData = staffDeductions[staff.staffId] || {};
            
            // Debug logging for deduction data
            console.log('Pay slip generation - Staff ID:', staff.staffId);
            console.log('Pay slip generation - Deduction data loaded:', staffDeductionData);
            
            const basicSalary = parseFloat(staff.basicSalary) || 0;
            
            // Only use actual data from staff record - no hardcoded calculations
            const daPercentage = parseFloat(staff.da) || 0;
            const hraPercentage = parseFloat(staff.hra) || 0;
            const daAmount = daPercentage > 0 ? Math.round(basicSalary * daPercentage / 100) : 0;
            const hraAmount = hraPercentage > 0 ? Math.round(basicSalary * hraPercentage / 100) : 0;
            const specialPay = parseFloat(staff.specialPay) || 0;
            const specialAllowance = parseFloat(staff.specialAllowance) || 0;
            const otherAllowance = parseFloat(staff.otherAllowance) || 0;
            
            const grossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
            
            // Debug logging for salary calculation
            console.log('generatePaySlipForStaff - Salary Calculation Debug:', {
                staffId: staff.staffId,
                basicSalary: basicSalary,
                daPercentage: daPercentage,
                hraPercentage: hraPercentage,
                daAmount: daAmount,
                hraAmount: hraAmount, 
                specialPay: specialPay,
                specialAllowance: specialAllowance,
                otherAllowance: otherAllowance,
                grossSalary: grossSalary,
                calculation: `${basicSalary} + ${daAmount} + ${hraAmount} + ${specialPay} + ${specialAllowance} + ${otherAllowance} = ${grossSalary}`,
                rawStaffData: {
                    'staff.da': staff.da,
                    'staff.hra': staff.hra,
                    'staff.specialPay': staff.specialPay,
                    'staff.specialAllowance': staff.specialAllowance,
                    'staff.otherAllowance': staff.otherAllowance
                },
                fullStaffRecord: staff
            });
            
            // Get monthly deduction amounts (not balances) for pay slip display
            // Only show monthly deduction if there's sufficient balance
            const wheatAdvanceBalance = parseFloat(staffDeductionData.wheatAdvanceTotal) || 0;
            const wheatAdvance = wheatAdvanceBalance > 0 ? (parseFloat(staffDeductionData.wheatAdvanceRecovered) || 0) : 0;
            
            const gicBalance = parseFloat(staffDeductionData.gicTotal) || 0;
            const gicMonthly = parseFloat(staffDeductionData.gicMonthly) || 0;
            const gic = gicMonthly > 0 ? gicMonthly : 0;  // Show if monthly amount > 0
            
            // Debug logging for GIC calculation
            console.log('GIC Debug - Balance:', gicBalance, 'Monthly:', gicMonthly, 'Final Amount:', gic);
            
            const licBalance = parseFloat(staffDeductionData.licTotal) || 0;
            const licMonthly = parseFloat(staffDeductionData.licMonthly) || 0;
            const lic = licMonthly > 0 ? licMonthly : 0;  // Show if monthly amount > 0
            
            const electricityBillBalance = parseFloat(staffDeductionData.electricityBillTotal) || 0;
            const electricityBillMonthly = parseFloat(staffDeductionData.electricityBillMonthly) || 0;
            const electricityBill = electricityBillMonthly > 0 ? electricityBillMonthly : 0;
            
            const waterChargesBalance = parseFloat(staffDeductionData.waterChargesTotal) || 0;
            const waterChargesMonthly = parseFloat(staffDeductionData.waterChargesMonthly) || 0;
            const waterCharges = waterChargesMonthly > 0 ? waterChargesMonthly : 0;
            
            const recoveryBalance = parseFloat(staffDeductionData.recoveryTotal) || 0;
            const recoveryMonthly = parseFloat(staffDeductionData.recoveryMonthly) || 0;
            const recovery = recoveryMonthly > 0 ? recoveryMonthly : 0;
            
            const leaveDeductionsBalance = parseFloat(staffDeductionData.leaveDeductions) || 0;
            const leaveDeductions = leaveDeductionsBalance > 0 ? (parseFloat(staffDeductionData.leaveDeductionsMonthly) || 0) : 0;
            
            const gppcSubscriptionBalance = parseFloat(staffDeductionData.gppcSubscription) || 0;
            const gppcSubscription = gppcSubscriptionBalance > 0 ? (parseFloat(staffDeductionData.gppcSubscriptionMonthly) || 0) : 0;
            
            const gpfExtraSubscriptionBalance = parseFloat(staffDeductionData.gpfExtraSubscription) || 0;
            const gpfExtraSubscription = gpfExtraSubscriptionBalance > 0 ? (parseFloat(staffDeductionData.gpfExtraSubscriptionMonthly) || 0) : 0;
            
            const gpfGovernmentContributionBalance = parseFloat(staffDeductionData.gpfGovernmentContribution) || 0;
            const gpfGovernmentContribution = gpfGovernmentContributionBalance > 0 ? (parseFloat(staffDeductionData.gpfGovernmentContributionMonthly) || 0) : 0;
            
            const gpfAdvanceRecoveryBalance = parseFloat(staffDeductionData.gpfAdvanceRecovery) || 0;
            const gpfAdvanceRecovery = gpfAdvanceRecoveryBalance > 0 ? (parseFloat(staffDeductionData.gpfAdvanceRecoveryRecovered) || 0) : 0;
            
            const npsGovernmentContributionBalance = parseFloat(staffDeductionData.npsGovernmentContribution) || 0;
            const npsGovernmentContribution = npsGovernmentContributionBalance > 0 ? (parseFloat(staffDeductionData.npsGovernmentContributionMonthly) || 0) : 0;
            
            const npsSelfContributionBalance = parseFloat(staffDeductionData.npsSelfContribution) || 0;
            const npsSelfContribution = npsSelfContributionBalance > 0 ? (parseFloat(staffDeductionData.npsSelfContributionMonthly) || 0) : 0;
            
            const gpfWithdrawlBalance = parseFloat(staffDeductionData.gpfWithdrawl) || 0;
            const gpfWithdrawl = gpfWithdrawlBalance > 0 ? (parseFloat(staffDeductionData.gpfWithdrawlMonthly) || 0) : 0;
            
            const gpfInterestBalance = parseFloat(staffDeductionData.gpfInterest) || 0;
            const gpfInterest = gpfInterestBalance > 0 ? (parseFloat(staffDeductionData.gpfInterestMonthly) || 0) : 0;
            
            const bankRecoveryBalance = parseFloat(staffDeductionData.bankRecovery) || 0;
            const bankRecovery = bankRecoveryBalance > 0 ? (parseFloat(staffDeductionData.bankRecoveryPaid) || 0) : 0;
            
            const incomeTaxBalance = parseFloat(staffDeductionData.incomeTax) || 0;
            const incomeTax = incomeTaxBalance > 0 ? (parseFloat(staffDeductionData.incomeTaxMonthly) || 0) : 0;
            
            const surChargesBalance = parseFloat(staffDeductionData.surCharges) || 0;
            const surCharges = surChargesBalance > 0 ? (parseFloat(staffDeductionData.surChargesMonthly) || 0) : 0;
            
            const otherDeduction1Balance = parseFloat(staffDeductionData.otherDeduction1) || 0;
            const otherDeduction1 = otherDeduction1Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction1Monthly) || 0) : 0;
            
            const otherDeduction2Balance = parseFloat(staffDeductionData.otherDeduction2Total) || 0;
            const otherDeduction2 = otherDeduction2Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction2Monthly) || 0) : 0;
            
            const otherDeduction3Balance = parseFloat(staffDeductionData.otherDeduction3Total) || 0;
            const otherDeduction3 = otherDeduction3Balance > 0 ? (parseFloat(staffDeductionData.otherDeduction3Monthly) || 0) : 0;
            
            const gpfLedBalanceBalance = parseFloat(staffDeductionData.gpfLedBalance) || 0;
            const gpfLedBalance = gpfLedBalanceBalance > 0 ? (parseFloat(staffDeductionData.gpfLedBalanceCurrent) || 0) : 0;
            
            const gpfAdvanceBalanceBalance = parseFloat(staffDeductionData.gpfAdvanceBalance) || 0;
            const gpfAdvanceBalance = gpfAdvanceBalanceBalance > 0 ? (parseFloat(staffDeductionData.gpfAdvanceBalanceRecovery) || 0) : 0;
            
            // Calculate total deductions
            // Use the simple "Total monthly deductions" from Deduction Management popup
            const totalDeductions = parseFloat(staffDeductionData.totalMonthlyDeductions) || 0;
            
            const netSalary = grossSalary - totalDeductions;
            
            const currentDate = new Date();
            const currentMonth = currentDate.toLocaleString('default', { month: 'long' });
            const currentYear = currentDate.getFullYear();
            
            const payslipDocument = document.getElementById('payslipDocument');
            payslipDocument.innerHTML = `
                <div class="payslip-letterhead">
                    <h1>CANTONMENT BOARD AMBALA</h1>
                    <h2>PAY SLIP</h2>
                    <p>For the month of ${currentMonth} ${currentYear}</p>
                    <p style="margin-top: 10px; font-weight: bold; color: #1976d2;">Employee: ${staff.staffName}</p>
                </div>
                
                <div class="payslip-basic-info">
                    <h3>üìã Basic Information</h3>
                    <div class="payslip-info-grid">
                        <div><strong>Staff ID:</strong> ${staff.staffId}</div>
                        <div><strong>Name:</strong> ${staff.staffName}</div>
                        <div><strong>Father's Name:</strong> ${staff.fatherName || 'N/A'}</div>
                        <div><strong>Mother's Name:</strong> ${staff.motherName || 'N/A'}</div>
                        <div><strong>Mobile:</strong> ${staff.mobile || 'N/A'}</div>
                        <div><strong>Email:</strong> ${staff.email || 'N/A'}</div>
                        <div><strong>Designation:</strong> ${staff.designation || 'N/A'}</div>
                        <div><strong>Department:</strong> ${staff.department || 'N/A'}</div>
                        <div><strong>Date of Birth:</strong> ${staff.dateOfBirth || 'N/A'}</div>
                        <div><strong>Date of Joining:</strong> ${staff.dateOfAppointment || 'N/A'}</div>
                        <div><strong>Address:</strong> ${staff.address || 'N/A'}</div>
                        <div><strong>Nationality:</strong> ${staff.nationality || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="payslip-basic-info">
                    <h3>üè¶ Bank Details</h3>
                    <div class="payslip-info-grid">
                        <div><strong>Bank Name:</strong> ${staff.bankName || 'N/A'}</div>
                        <div><strong>Account Number:</strong> ${staff.accountNumber || 'N/A'}</div>
                        <div><strong>IFSC Code:</strong> ${staff.ifscCode || 'N/A'}</div>
                        <div><strong>MICR Code:</strong> ${staff.micrCode || 'N/A'}</div>
                    </div>
                </div>
                
                <div class="payslip-salary-section">
                    <h3>üí∞ Salary Structure</h3>
                    <table class="payslip-table">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th class="amount">Amount (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td>Basic Pay</td><td class="amount">${basicSalary.toLocaleString()}</td></tr>
                            <tr><td>Dearness Allowance (${daPercentage}%)</td><td class="amount">${daAmount.toLocaleString()}</td></tr>
                            <tr><td>HRA (${hraPercentage}%)</td><td class="amount">${hraAmount.toLocaleString()}</td></tr>
                            ${specialPay > 0 ? `<tr><td>Special Pay</td><td class="amount">${specialPay.toLocaleString()}</td></tr>` : ''}
                            ${specialAllowance > 0 ? `<tr><td>Special Allowance</td><td class="amount">${specialAllowance.toLocaleString()}</td></tr>` : ''}
                            ${otherAllowance > 0 ? `<tr><td>Other Allowance</td><td class="amount">${otherAllowance.toLocaleString()}</td></tr>` : ''}
                            <tr class="total-row"><td><strong>Gross Salary</strong></td><td class="amount"><strong>‚Çπ${grossSalary.toLocaleString()}</strong></td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="payslip-deductions-section">
                    <h3>üìâ Deductions</h3>
                    <table class="payslip-table">
                        <thead>
                            <tr>
                                <th>Component</th>
                                <th class="amount">Amount (‚Çπ)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${wheatAdvance > 0 ? `<tr><td>Wheat Advance</td><td class="amount">${wheatAdvance.toLocaleString()}</td></tr>` : ''}
                            ${gpfAdvanceRecovery > 0 ? `<tr><td>GPF Advance Recovery</td><td class="amount">${gpfAdvanceRecovery.toLocaleString()}</td></tr>` : ''}
                            ${gpfLedBalance > 0 ? `<tr><td>GPF Ledger Balance</td><td class="amount">${gpfLedBalance.toLocaleString()}</td></tr>` : ''}
                            ${gpfAdvanceBalance > 0 ? `<tr><td>GPF Advance Balance</td><td class="amount">${gpfAdvanceBalance.toLocaleString()}</td></tr>` : ''}
                            ${bankRecovery > 0 ? `<tr><td>Bank Recovery</td><td class="amount">${bankRecovery.toLocaleString()}</td></tr>` : ''}
                            ${gic > 0 ? `<tr><td>GIC (General Insurance Corporation)</td><td class="amount">${gic.toLocaleString()}</td></tr>` : ''}
                            ${lic > 0 ? `<tr><td>LIC (Life Insurance Corporation)</td><td class="amount">${lic.toLocaleString()}</td></tr>` : ''}
                            ${electricityBill > 0 ? `<tr><td>Electricity Bill</td><td class="amount">${electricityBill.toLocaleString()}</td></tr>` : ''}
                            ${waterCharges > 0 ? `<tr><td>Water Charges</td><td class="amount">${waterCharges.toLocaleString()}</td></tr>` : ''}
                            ${recovery > 0 ? `<tr><td>General Recovery</td><td class="amount">${recovery.toLocaleString()}</td></tr>` : ''}
                            ${leaveDeductions > 0 ? `<tr><td>Leave Deductions</td><td class="amount">${leaveDeductions.toLocaleString()}</td></tr>` : ''}
                            ${gppcSubscription > 0 ? `<tr><td>GPPC Subscription</td><td class="amount">${gppcSubscription.toLocaleString()}</td></tr>` : ''}
                            ${gpfExtraSubscription > 0 ? `<tr><td>GPF Extra Subscription</td><td class="amount">${gpfExtraSubscription.toLocaleString()}</td></tr>` : ''}
                            ${gpfGovernmentContribution > 0 ? `<tr><td>GPF Government Contribution</td><td class="amount">${gpfGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                            ${npsGovernmentContribution > 0 ? `<tr><td>NPS Government Contribution</td><td class="amount">${npsGovernmentContribution.toLocaleString()}</td></tr>` : ''}
                            ${npsSelfContribution > 0 ? `<tr><td>NPS Self Contribution</td><td class="amount">${npsSelfContribution.toLocaleString()}</td></tr>` : ''}
                            ${gpfWithdrawl > 0 ? `<tr><td>GPF Withdrawal</td><td class="amount">${gpfWithdrawl.toLocaleString()}</td></tr>` : ''}
                            ${gpfInterest > 0 ? `<tr><td>GPF Interest</td><td class="amount">${gpfInterest.toLocaleString()}</td></tr>` : ''}
                            ${incomeTax > 0 ? `<tr><td>Income Tax</td><td class="amount">${incomeTax.toLocaleString()}</td></tr>` : ''}
                            ${surCharges > 0 ? `<tr><td>Sur-charges</td><td class="amount">${surCharges.toLocaleString()}</td></tr>` : ''}
                            ${otherDeduction1 > 0 ? `<tr><td>Other Deduction-1</td><td class="amount">${otherDeduction1.toLocaleString()}</td></tr>` : ''}
                            ${otherDeduction2 > 0 ? `<tr><td>Other Deduction-2</td><td class="amount">${otherDeduction2.toLocaleString()}</td></tr>` : ''}
                            ${otherDeduction3 > 0 ? `<tr><td>Other Deduction-3</td><td class="amount">${otherDeduction3.toLocaleString()}</td></tr>` : ''}
                            ${totalDeductions === 0 ? '<tr><td colspan="2" style="text-align: center; font-style: italic; color: #666;">No deductions for this month</td></tr>' : ''}
                            <tr class="total-row"><td><strong>Total Deductions</strong></td><td class="amount"><strong>‚Çπ${totalDeductions.toLocaleString()}</strong></td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="payslip-net-salary">
                    <h3>üíµ Net Salary</h3>
                    <div class="net-salary-amount">‚Çπ${netSalary.toLocaleString()}</div>
                </div>
                
                <div class="payslip-footer">
                    <p><em>This is a computer-generated pay slip and does not require a signature.</em></p>
                    <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    
                    <div class="action-buttons">
                        <button class="btn-payslip" onclick="printPaySlip()">üñ®Ô∏è Print Pay Slip</button>
                        <button class="btn-payslip btn-secondary" onclick="downloadPaySlip('${staff.staffName}', '${currentMonth}_${currentYear}')">üìÑ Download PDF</button>
                        <button class="btn-payslip btn-secondary" onclick="clearPaySlip()">üîÑ Clear & Search Again</button>
                    </div>
                `;
        }

        function initializeHistoricalDropdowns() {
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            
            // Initialize historical view dropdowns
            const viewHistoricalYear = document.getElementById('viewHistoricalYear');
            if (viewHistoricalYear) {
                viewHistoricalYear.innerHTML = '<option value="">Select Year</option>';
                for (let year = 2020; year <= currentYear; year++) {
                    viewHistoricalYear.innerHTML += `<option value="${year}">${year}</option>`;
                }
            }
            
            const viewHistoricalMonth = document.getElementById('viewHistoricalMonth');
            if (viewHistoricalMonth) {
                viewHistoricalMonth.innerHTML = '<option value="">Select Month</option>';
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                for (let i = 1; i <= 12; i++) {
                    viewHistoricalMonth.innerHTML += `<option value="${i}">${monthNames[i-1]}</option>`;
                }
            }
        }
        

        function openAttendanceCalendar(input) {
            const calendarInput = document.getElementById('attendanceDate_calendar');
            if (calendarInput) {
                calendarInput.click();
            }
        }

        function updateAttendanceDate(calendarInput) {
            const textInput = document.getElementById('attendanceDate');
            if (textInput && calendarInput.value) {
                const date = new Date(calendarInput.value);
                textInput.value = formatDateToDDMMYYYY(date);
                refreshAttendanceTable();
            }
        }

        function markTodayAttendance() {
            const today = formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            document.getElementById('attendanceDate').value = today;
            refreshAttendanceTable();
        }

        // Functions for viewing historical attendance
        function updateHistoricalAttendanceView() {
            const month = document.getElementById('viewHistoricalMonth').value;
            const year = document.getElementById('viewHistoricalYear').value;
            
            if (!month && !year) {
                // Show current month's saved attendance data when no filters selected
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();
                refreshAttendanceTableWithHistoricalData(currentMonth, currentYear);
                showAttendanceToast(`Showing current month (${getMonthName(currentMonth)} ${currentYear}) attendance data`, 'info');
                return;
            }
            
            if (!month || !year) {
                // If only one filter is selected, do nothing
                return;
            }
            
            // Check if it's a future month (not allowed)
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth() + 1;
            const currentYear = currentDate.getFullYear();
            
            if (parseInt(year) > currentYear || (parseInt(year) === currentYear && parseInt(month) > currentMonth)) {
                showAttendanceToast('Cannot view future months', 'error');
                return;
            }
            
            // Refresh the table with historical data (editable mode)
            refreshAttendanceTableWithHistoricalData(parseInt(month), parseInt(year));
            
            // Show appropriate message
            const monthName = getMonthName(month);
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            const monthRecords = savedRecords.filter(r => parseInt(r.month) === parseInt(month) && parseInt(r.year) === parseInt(year));
            
            if (monthRecords.length > 0) {
                showAttendanceToast(`${monthName} ${year} - ${monthRecords.length} saved records, others editable`, 'success');
            } else {
                showAttendanceToast(`${monthName} ${year} - Ready for attendance entry`, 'info');
            }
            
            // Update attendance statistics cards for the viewed month
            updateAttendanceStatistics();
        }
        
        // Function to clear historical filters
        function clearHistoricalFilters() {
            document.getElementById('viewHistoricalMonth').value = '';
            document.getElementById('viewHistoricalYear').value = '';
            
            // Reset navigation to current month
            const now = new Date();
            window.currentNavMonth = now.getMonth() + 1;
            window.currentNavYear = now.getFullYear();
            updateCurrentMonthDisplay();
            
            // Reset to normal data entry mode
            refreshAttendanceTable();
            
            // Update attendance statistics for current month
            updateAttendanceStatistics();
        }
        
        function updateAttendanceTableForMonth(month, year) {
            const savedRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            const tbody = document.getElementById('attendanceTableBody');
            if (!tbody) return;
            
            // Update each row to show data for the selected month/year
            admissions.forEach(staff => {
                const record = savedRecords.find(r => 
                    r.staffId === staff.staffId && 
                    parseInt(r.month) === month && 
                    parseInt(r.year) === year
                );
                
                // Find the row for this staff
                const monthSelect = document.getElementById(`month-${staff.id}`);
                const yearSelect = document.getElementById(`year-${staff.id}`);
                const daysInput = document.getElementById(`days-${staff.id}`);
                
                if (monthSelect && yearSelect && daysInput) {
                    if (record) {
                        // Show the saved data
                        monthSelect.value = record.month;
                        yearSelect.value = record.year;
                        daysInput.value = record.daysPresent;
                        
                        // Make fields read-only to indicate historical data
                        monthSelect.style.background = '#e8f5e9';
                        yearSelect.style.background = '#e8f5e9';
                        daysInput.style.background = '#e8f5e9';
                    } else {
                        // No data for this month/year
                        monthSelect.value = month;
                        yearSelect.value = year;
                        daysInput.value = '';
                        daysInput.placeholder = 'No data';
                        
                        monthSelect.style.background = '#f5f5f5';
                        yearSelect.style.background = '#f5f5f5';
                        daysInput.style.background = '#f5f5f5';
                    }
                }
            });
        }

        function exportAttendanceReport() {
            const selectedDate = document.getElementById('attendanceDate')?.value || formatDateToDDMMYYYY(fakeSystemTime.currentDate);
            const reportData = admissions.map(staff => {
                const record = attendanceRecords.find(r => 
                    r.staffId === staff.id && r.date === selectedDate
                );
                
                return {
                    staffId: staff.staffId || 'N/A',
                    name: staff.staffName,
                    designation: staff.designation,
                    status: record?.status || 'not-marked',
                    timeIn: record?.timeIn || '',
                    timeOut: record?.timeOut || '',
                    date: selectedDate
                };
            });
            
            const csv = convertToCSV(reportData);
            downloadCSV(csv, `attendance_report_${selectedDate.replace(/\//g, '_')}.csv`);
        }

        function convertToCSV(data) {
            const headers = ['Staff ID', 'Name', 'Designation', 'Status', 'Time In', 'Time Out', 'Date'];
            const csvContent = [
                headers.join(','),
                ...data.map(row => [
                    row.staffId,
                    `"${row.name}"`,
                    `"${row.designation}"`,
                    row.status,
                    row.timeIn,
                    row.timeOut,
                    row.date
                ].join(','))
            ].join('\n');
            
            return csvContent;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function addAttendanceCSS() {
            if (!document.getElementById('attendanceCSS')) {
                const style = document.createElement('style');
                style.id = 'attendanceCSS';
                style.textContent = `
                    .attendance-management-container {
                        padding: 20px;
                    }

                    .attendance-stats {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-bottom: 30px;
                    }

                    .stat-card {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        transition: transform 0.2s ease;
                    }

                    .stat-card:hover {
                        transform: translateY(-2px);
                    }

                    .stat-icon {
                        font-size: 32px;
                        width: 60px;
                        height: 60px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background: #f8f9fa;
                        border-radius: 50%;
                    }

                    .stat-info h3 {
                        margin: 0;
                        font-size: 14px;
                        color: #666;
                        font-weight: 500;
                    }

                    .stat-value {
                        font-size: 24px;
                        font-weight: 700;
                        color: #1976d2;
                        margin-top: 4px;
                    }

                    .date-selector {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 20px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }

                    .date-selector label {
                        font-weight: 600;
                        color: #333;
                    }

                    .date-selector input[type="text"] {
                        padding: 8px 12px;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 14px;
                        cursor: pointer;
                    }

                    .attendance-list {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                        overflow: hidden;
                    }

                    .list-header {
                        padding: 20px;
                        background: #f8f9fa;
                        border-bottom: 1px solid #e1e5e9;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .list-header h3 {
                        margin: 0;
                        color: #333;
                    }

                    .attendance-actions {
                        display: flex;
                        gap: 10px;
                    }

                    .attendance-table-wrapper {
                        overflow-x: auto;
                    }

                    .attendance-table {
                        width: 100%;
                        border-collapse: collapse;
                    }

                    .attendance-table th,
                    .attendance-table td {
                        padding: 12px;
                        text-align: left;
                        border-bottom: 1px solid #e1e5e9;
                    }

                    .attendance-table th {
                        background: #f8f9fa;
                        font-weight: 600;
                        color: #333;
                    }

                    .attendance-row.present {
                        background: #f0f9ff;
                    }

                    .attendance-row.absent {
                        background: #fef2f2;
                    }

                    .attendance-row.late {
                        background: #fffbeb;
                    }

                    .status-badge {
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 12px;
                        font-weight: 500;
                    }

                    .status-badge.present {
                        background: #dcfce7;
                        color: #166534;
                    }

                    .status-badge.absent {
                        background: #fee2e2;
                        color: #991b1b;
                    }

                    .status-badge.late {
                        background: #fef3c7;
                        color: #92400e;
                    }

                    .status-badge.not-marked {
                        background: #f3f4f6;
                        color: #6b7280;
                    }

                    .action-buttons {
                        display: flex;
                        gap: 5px;
                    }

                    .btn-xs {
                        padding: 4px 8px;
                        font-size: 11px;
                        border-radius: 4px;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Global function for calendar picker
        window.openCalendar = function() {
            console.log('Global openCalendar called');
            const calendarInput = document.getElementById('dateOfBirth_calendar');
            const textInput = document.getElementById('dateOfBirth');
            
            if (calendarInput && textInput) {
                console.log('Calendar input found, opening picker');
                
                // Set up the change listener first
                calendarInput.onchange = function() {
                    console.log('Date selected:', this.value);
                    if (this.value) {
                        const date = new Date(this.value);
                        const formattedDate = formatDateToDDMMYYYY(date);
                        textInput.value = formattedDate;
                        
                        // Trigger validation
                        const event = new Event('blur', { bubbles: true });
                        textInput.dispatchEvent(event);
                    }
                };
                
                // Try different methods to open the picker
                if (calendarInput.showPicker) {
                    try {
                        calendarInput.showPicker();
                    } catch (e) {
                        console.log('showPicker failed, trying click:', e);
                        calendarInput.focus();
                        calendarInput.click();
                    }
                } else {
                    calendarInput.focus();
                    calendarInput.click();
                }
            } else {
                console.error('Calendar or text input not found', {
                    calendarInput: !!calendarInput,
                    textInput: !!textInput
                });
            }
        };

        function enableFieldsAfterDateOfBirth() {
            const dateOfBirthInput = document.getElementById('dateOfBirth');
            const addChildButton = document.getElementById('addChildButton');
            const dateOfAppointmentInput = document.getElementById('dateOfAppointment');
            
            if (dateOfBirthInput && dateOfBirthInput.value && dateOfBirthInput.value.trim() !== '') {
                // Enable Add Child button
                if (addChildButton) {
                    addChildButton.disabled = false;
                    addChildButton.style.opacity = '1';
                    addChildButton.style.cursor = 'pointer';
                }
                
                // Enable Date of Appointment field
                if (dateOfAppointmentInput) {
                    dateOfAppointmentInput.disabled = false;
                    dateOfAppointmentInput.style.opacity = '1';
                    dateOfAppointmentInput.style.cursor = 'pointer';
                    dateOfAppointmentInput.style.backgroundColor = '';
                    dateOfAppointmentInput.title = 'Click to select date';
                }
            } else {
                // Disable Add Child button
                if (addChildButton) {
                    addChildButton.disabled = true;
                    addChildButton.style.opacity = '0.5';
                    addChildButton.style.cursor = 'not-allowed';
                }
                
                // Disable Date of Appointment field
                if (dateOfAppointmentInput) {
                    dateOfAppointmentInput.disabled = true;
                    dateOfAppointmentInput.style.opacity = '0.5';
                    dateOfAppointmentInput.style.cursor = 'not-allowed';
                    dateOfAppointmentInput.style.backgroundColor = '#f8f9fa';
                    dateOfAppointmentInput.title = 'Fill Date of Birth first';
                    dateOfAppointmentInput.value = ''; // Clear any existing value
                }
            }
            
            // Always check Date of Next Increment regardless of Date of Birth state
            enableDateOfNextIncrementField();
        }

        function enableDateOfNextIncrementField() {
            const dateOfAppointmentInput = document.getElementById('dateOfAppointment');
            const dateOfNextIncrementInput = document.getElementById('dateOfNextIncrement');
            
            if (dateOfAppointmentInput && dateOfAppointmentInput.value && dateOfAppointmentInput.value.trim() !== '') {
                // Enable Date of Next Increment field
                if (dateOfNextIncrementInput) {
                    dateOfNextIncrementInput.disabled = false;
                    dateOfNextIncrementInput.style.opacity = '1';
                    dateOfNextIncrementInput.style.cursor = 'pointer';
                    dateOfNextIncrementInput.style.backgroundColor = '';
                    dateOfNextIncrementInput.title = 'Click to select date';
                }
            } else {
                // Disable Date of Next Increment field
                if (dateOfNextIncrementInput) {
                    dateOfNextIncrementInput.disabled = true;
                    dateOfNextIncrementInput.style.opacity = '0.5';
                    dateOfNextIncrementInput.style.cursor = 'not-allowed';
                    dateOfNextIncrementInput.style.backgroundColor = '#f8f9fa';
                    dateOfNextIncrementInput.title = 'Fill Date of Appointment first';
                    dateOfNextIncrementInput.value = ''; // Clear any existing value
                }
            }
        }

        function updateDatePickerRestrictions() {
            const dateOfBirthInput = document.getElementById('dateOfBirth');
            const dateOfAppointmentInput = document.getElementById('dateOfAppointment');
            const dateOfNextIncrementInput = document.getElementById('dateOfNextIncrement');
            
            // Update Date of Appointment restrictions based on Date of Birth
            if (dateOfAppointmentInput && dateOfAppointmentInput._pikaday && dateOfBirthInput && dateOfBirthInput.value) {
                const birthDate = parseDDMMYYYY(dateOfBirthInput.value);
                if (birthDate) {
                    const minAppointmentDate = new Date(birthDate);
                    minAppointmentDate.setFullYear(minAppointmentDate.getFullYear() + 18);
                    
                    // Update Pikaday min date
                    dateOfAppointmentInput._pikaday.setMinDate(minAppointmentDate);
                    
                    // Disable dates before 18th birthday
                    dateOfAppointmentInput._pikaday._o.disableDayFn = function(date) {
                        return date < minAppointmentDate;
                    };
                    
                    // Force redraw
                    dateOfAppointmentInput._pikaday.draw();
                }
            }
            
            // Update Date of Next Increment restrictions based on Date of Appointment
            if (dateOfNextIncrementInput && dateOfNextIncrementInput._pikaday && dateOfAppointmentInput && dateOfAppointmentInput.value) {
                const appointmentDate = parseDDMMYYYY(dateOfAppointmentInput.value);
                if (appointmentDate) {
                    const minIncrementDate = new Date(appointmentDate);
                    minIncrementDate.setFullYear(minIncrementDate.getFullYear() + 1);
                    
                    // Update Pikaday min date
                    dateOfNextIncrementInput._pikaday.setMinDate(minIncrementDate);
                    
                    // Update year range to ensure we can navigate properly
                    const currentYear = new Date().getFullYear();
                    const minYear = minIncrementDate.getFullYear();
                    const maxYear = currentYear + 20; // Allow up to 20 years in future
                    
                    // Set proper year range for navigation
                    dateOfNextIncrementInput._pikaday._o.yearRange = [minYear, maxYear];
                    dateOfNextIncrementInput._pikaday._o.minYear = minYear;
                    dateOfNextIncrementInput._pikaday._o.maxYear = maxYear;
                    
                    // Disable dates before 1 year after appointment
                    dateOfNextIncrementInput._pikaday._o.disableDayFn = function(date) {
                        return date < minIncrementDate;
                    };
                    
                    // Force redraw
                    dateOfNextIncrementInput._pikaday.draw();
                }
            }
        }

        function initializeDateFields() {
            console.log('Initializing simple date fields...');
            
            // Wait a bit for modal to be fully rendered
            setTimeout(() => {
                const dateOfBirthInput = document.getElementById('dateOfBirth');
                const dateOfAppointmentInput = document.getElementById('dateOfAppointment');
                const dateOfNextIncrementInput = document.getElementById('dateOfNextIncrement');
                const retirementDateInput = document.getElementById('retirementDate');
                
                console.log('Date fields found:', {
                    dateOfBirth: !!dateOfBirthInput,
                    dateOfAppointment: !!dateOfAppointmentInput,
                    dateOfNextIncrement: !!dateOfNextIncrementInput,
                    retirementDate: !!retirementDateInput
                });
                
                // Setup all date fields with simple behavior
                if (dateOfBirthInput && !dateOfBirthInput.hasAttribute('data-initialized')) {
                    dateOfBirthInput.setAttribute('data-initialized', 'true');
                    console.log('Setting up date of birth field');
                    
                    dateOfBirthInput.addEventListener('change', function() {
                        // Skip validation if field is empty
                        if (!this.value || this.value.trim() === '') {
                            return;
                        }
                        
                        // Skip age recalculation during form population
                        if (window.isPopulatingEditForm) {
                            return;
                        }
                        
                        const validation = validateDateOfBirth(this.value);
                        if (!validation.valid) {
                            // Only show alert for actual logical errors, not format issues
                            if (validation.message !== 'Please enter a valid date!') {
                                console.log('Date of birth validation failed:', validation.message);
                                this.value = '';
                                
                                if (!window.isShowingValidationAlert) {
                                    window.isShowingValidationAlert = true;
                                    const self = this;
                                    setTimeout(function() {
                                        try {
                                            alert(validation.message);
                                        } finally {
                                            window.isShowingValidationAlert = false;
                                            try { self.focus(); } catch (e) {}
                                        }
                                    }, 100);
                                }
                                return;
                            }
                        }
                        
                        // Auto-calculate age
                        if (this.value) {
                            const dob = parseDDMMYYYY(this.value);
                            if (dob) {
                                const today = new Date();
                                let age = today.getFullYear() - dob.getFullYear();
                                const monthDiff = today.getMonth() - dob.getMonth();
                                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                                    age--;
                                }
                                const ageInput = document.getElementById('age');
                                if (ageInput) {
                                    ageInput.value = age >= 0 ? age : '';
                                }
                                
                                // Calculate retirement date (60 years from birth, last day of month)
                                const retirementInput = document.getElementById('retirementDate');
                                if (retirementInput) {
                                    const retirementYear = dob.getFullYear() + 60;
                                    const retirementMonth = dob.getMonth();
                                    
                                    // Get last day of the month when person turns 60
                                    const lastDayOfMonth = new Date(retirementYear, retirementMonth + 1, 0);
                                    
                                    // Format as DD/MM/YYYY
                                    const day = String(lastDayOfMonth.getDate()).padStart(2, '0');
                                    const month = String(lastDayOfMonth.getMonth() + 1).padStart(2, '0');
                                    const year = lastDayOfMonth.getFullYear();
                                    
                                    retirementInput.value = `${day}/${month}/${year}`;
                                }
                            }
                        }
                        
                        // Also validate appointment date if it exists
                        if (dateOfAppointmentInput && dateOfAppointmentInput.value) {
                            const appointmentValidation = validateDateOfAppointment(dateOfAppointmentInput.value, this.value);
                            const errorElement = document.getElementById('dateOfAppointmentError');
                            
                            if (!appointmentValidation.valid) {
                                console.log('Date of appointment validation failed from birth date change:', appointmentValidation.message);
                                dateOfAppointmentInput.value = '';
                                
                                // Show red error message
                                if (errorElement) {
                                    errorElement.style.display = 'block';
                                    errorElement.textContent = 'Invalid date';
                                    
                                    // Hide the error after 3 seconds
                                    setTimeout(function() {
                                        errorElement.style.display = 'none';
                                    }, 3000);
                                }
                                
                                dateOfAppointmentInput.focus();
                            } else {
                                // Hide error message if validation passes
                                if (errorElement) {
                                    errorElement.style.display = 'none';
                                }
                            }
                        }
                        
                        // Enable Add Child button and Date of Appointment field when Date of Birth is filled
                        enableFieldsAfterDateOfBirth();
                        
                        // Update date picker restrictions
                        updateDatePickerRestrictions();
                    });
                }
                
                if (dateOfAppointmentInput && !dateOfAppointmentInput.hasAttribute('data-initialized')) {
                    dateOfAppointmentInput.setAttribute('data-initialized', 'true');
                    console.log('Setting up date of appointment field');
                    
                    dateOfAppointmentInput.addEventListener('change', function(event) {
                        event.stopPropagation();
                        const birthDate = dateOfBirthInput ? dateOfBirthInput.value : '';
                        const validation = validateDateOfAppointment(this.value, birthDate);
                        const errorElement = document.getElementById('dateOfAppointmentError');
                        
                        if (!validation.valid) {
                            console.log('Date of appointment validation failed:', validation.message);
                            
                            // Prevent recursive event triggering by temporarily removing the listener
                            const self = this;
                            self.removeEventListener('change', arguments.callee);
                            
                            // Clear the field
                            self.value = '';
                            
                            // Re-attach the listener after a short delay
                            setTimeout(function() {
                                self.addEventListener('change', arguments.callee);
                            }, 100);
                            
                            // Show red error message
                            if (errorElement) {
                                errorElement.style.display = 'block';
                                errorElement.textContent = 'Invalid date';
                                
                                // Hide the error after 3 seconds
                                setTimeout(function() {
                                    errorElement.style.display = 'none';
                                }, 3000);
                            }
                            
                            self.focus();
                            return false;
                        } else {
                            // Hide error message if validation passes
                            if (errorElement) {
                                errorElement.style.display = 'none';
                            }
                        }
                        
                        // Enable Date of Next Increment field when Date of Appointment is filled
                        enableDateOfNextIncrementField();
                        
                        // Also validate next increment date if it exists
                        if (dateOfNextIncrementInput && dateOfNextIncrementInput.value) {
                            const incrementValidation = validateNextIncrementDate(dateOfNextIncrementInput.value);
                            if (!incrementValidation.valid) {
                                console.log('Date of next increment validation failed from appointment date change:', incrementValidation.message);
                                dateOfNextIncrementInput.value = '';
                                
                                // Show red error message
                                const errorElement = document.getElementById('dateOfNextIncrementError');
                                if (errorElement) {
                                    errorElement.style.display = 'block';
                                    errorElement.textContent = 'Invalid date';
                                    
                                    // Hide the error after 5 seconds
                                    setTimeout(function() {
                                        errorElement.style.display = 'none';
                                    }, 5000);
                                }
                                
                                dateOfNextIncrementInput.focus();
                            }
                        }
                        
                        // Update date picker restrictions
                        updateDatePickerRestrictions();
                    });
                }
                
                if (dateOfNextIncrementInput && !dateOfNextIncrementInput.hasAttribute('data-initialized')) {
                    dateOfNextIncrementInput.setAttribute('data-initialized', 'true');
                    console.log('Setting up date of next increment field');
                    
                    dateOfNextIncrementInput.addEventListener('change', function(event) {
                        event.stopPropagation();
                        const validation = validateNextIncrementDate(this.value);
                        const errorElement = document.getElementById('dateOfNextIncrementError');
                        
                        if (!validation.valid) {
                            console.log('Date of next increment validation failed:', validation.message);
                            
                            // Prevent recursive event triggering by temporarily removing the listener
                            const self = this;
                            self.removeEventListener('change', arguments.callee);
                            
                            // Clear the field
                            self.value = '';
                            
                            // Re-attach the listener after a short delay
                            setTimeout(function() {
                                self.addEventListener('change', arguments.callee);
                            }, 100);
                            
                            // Show red error message
                            if (errorElement) {
                                errorElement.style.display = 'block';
                                errorElement.textContent = 'Invalid date';
                                
                                // Hide the error after 5 seconds
                                setTimeout(function() {
                                    errorElement.style.display = 'none';
                                }, 5000);
                            }
                            
                            self.focus();
                            return false;
                        } else {
                            // Hide error message if validation passes
                            if (errorElement) {
                                errorElement.style.display = 'none';
                            }
                        }
                    });
                }
                
                if (retirementDateInput && !retirementDateInput.hasAttribute('data-initialized')) {
                    retirementDateInput.setAttribute('data-initialized', 'true');
                    console.log('Setting up retirement date field');
                }
                
                console.log('Simple date field initialization completed');
            }, 200);
        }

        // Helper functions to show/hide mobile number error
        function showMobileNumberError(message) {
            const errorElement = document.getElementById('mobileNumberError');
            const mobileInput = document.getElementById('mobileNumber');
            if (errorElement && mobileInput) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                mobileInput.style.borderColor = '#dc3545';
            }
        }
        
        function hideMobileNumberError() {
            const errorElement = document.getElementById('mobileNumberError');
            const mobileInput = document.getElementById('mobileNumber');
            if (errorElement && mobileInput) {
                errorElement.style.display = 'none';
                mobileInput.style.borderColor = '';
            }
        }

        function setupFormValidation() {
            // Age calculation
            const dobInput = document.getElementById('dateOfBirth');
            const ageInput = document.getElementById('age');
            
            if (dobInput && ageInput) {
                dobInput.addEventListener('change', function() {
                    // Skip age recalculation during form population
                    if (window.isPopulatingEditForm) {
                        return;
                    }
                    
                    // Parse DD/MM/YYYY date format
                    const dob = parseDDMMYYYY(this.value);
                    if (dob) {
                        const today = new Date();
                        let age = today.getFullYear() - dob.getFullYear();
                        const monthDiff = today.getMonth() - dob.getMonth();
                        
                        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                            age--;
                        }
                        
                        ageInput.value = age >= 0 ? age : '';
                        
                        // Calculate retirement date (60 years from birth, last day of month)
                        const retirementInput = document.getElementById('retirementDate');
                        if (retirementInput) {
                            const retirementYear = dob.getFullYear() + 60;
                            const retirementMonth = dob.getMonth();
                            
                            // Get last day of the month when person turns 60
                            const lastDayOfMonth = new Date(retirementYear, retirementMonth + 1, 0);
                            
                            // Format as DD/MM/YYYY
                            const day = String(lastDayOfMonth.getDate()).padStart(2, '0');
                            const month = String(lastDayOfMonth.getMonth() + 1).padStart(2, '0');
                            const year = lastDayOfMonth.getFullYear();
                            
                            retirementInput.value = `${day}/${month}/${year}`;
                        }
                    } else {
                        ageInput.value = '';
                        // Clear retirement date if DOB is invalid
                        const retirementInput = document.getElementById('retirementDate');
                        if (retirementInput) {
                            retirementInput.value = '';
                        }
                    }
                });
            }

            // Mobile number validation with user feedback
            const mobileInput = document.getElementById('mobileNumber');
            if (mobileInput) {
                mobileInput.addEventListener('input', function() {
                    // Remove non-digits and limit to 10 characters
                    const cleanedValue = this.value.replace(/\D/g, '').slice(0, 10);
                    this.value = cleanedValue;
                    
                    // Provide visual feedback
                    const length = cleanedValue.length;
                    if (length === 0) {
                        hideMobileNumberError();
                        this.setCustomValidity('Mobile number is required');
                    } else if (length < 10) {
                        showMobileNumberError(`Mobile number must be exactly 10 digits (${length}/10)`);
                        this.style.borderColor = '#ffc107'; // Yellow for incomplete
                        this.setCustomValidity(`Mobile number must be exactly 10 digits (${length}/10)`);
                    } else if (length === 10) {
                        hideMobileNumberError();
                        this.style.borderColor = '#28a745'; // Green for valid
                        this.setCustomValidity('');
                    }
                });
                
                // Clear validation styling on blur if valid
                mobileInput.addEventListener('blur', function() {
                    if (this.value.length === 10) {
                        setTimeout(() => {
                            hideMobileNumberError();
                            this.style.borderColor = '';
                        }, 1000);
                    }
                });
            }

            // Text-only validation for name fields
            const textOnlyFields = ['staffName', 'fatherName', 'motherName', 'grandFatherName', 'spouseName', 'childName'];
            textOnlyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        // Allow only letters, spaces, apostrophes, dots, and hyphens
                        this.value = this.value.replace(/[^a-zA-Z\s.'-]/g, '');
                    });
                }
            });

            // Number-only validation for numeric fields
            const numberOnlyFields = ['functionCode', 'objectCode'];
            numberOnlyFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        this.value = this.value.replace(/\D/g, '');
                    });
                }
            });

            // Account number validation (9-17 digits only)
            const accountNumberInput = document.getElementById('accountNumber');
            if (accountNumberInput) {
                accountNumberInput.addEventListener('input', function() {
                    // Allow only numbers and limit to 17 digits
                    this.value = this.value.replace(/\D/g, '').slice(0, 17);
                    
                    // Add visual feedback for length validation
                    if (this.value.length >= 9 && this.value.length <= 17) {
                        this.style.borderColor = '#28a745';
                    } else if (this.value.length > 0) {
                        this.style.borderColor = '#dc3545';
                    } else {
                        this.style.borderColor = '';
                    }
                });
                
                accountNumberInput.addEventListener('blur', function() {
                    // Validate on blur
                    if (this.value && (this.value.length < 9 || this.value.length > 17)) {
                        this.setCustomValidity('Account number must be between 9 and 17 digits');
                        this.reportValidity();
                    } else {
                        this.setCustomValidity('');
                    }
                    // Reset border color on blur
                    this.style.borderColor = '';
                });
            }

            // IFSC code validation (10-15 characters, letters and numbers only)
            const ifscCodeInput = document.getElementById('ifscCode');
            if (ifscCodeInput) {
                ifscCodeInput.addEventListener('input', function() {
                    // Allow only letters and numbers, convert to uppercase, limit to 15 characters
                    this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase().slice(0, 15);
                    
                    // Add visual feedback for length validation
                    if (this.value.length >= 10 && this.value.length <= 15) {
                        this.style.borderColor = '#28a745';
                    } else if (this.value.length > 0) {
                        this.style.borderColor = '#dc3545';
                    } else {
                        this.style.borderColor = '';
                    }
                });
                
                ifscCodeInput.addEventListener('blur', function() {
                    // Validate on blur
                    if (this.value && (this.value.length < 10 || this.value.length > 15)) {
                        this.setCustomValidity('IFSC code must be between 10 and 15 characters');
                        this.reportValidity();
                    } else {
                        this.setCustomValidity('');
                    }
                    // Reset border color on blur
                    this.style.borderColor = '';
                });
            }
            
            // MICR code validation (9 digits only)
            const micrCodeInput = document.getElementById('micrCode');
            if (micrCodeInput) {
                micrCodeInput.addEventListener('input', function() {
                    // Allow only numbers, limit to 9 digits
                    this.value = this.value.replace(/\D/g, '').slice(0, 9);
                });
            }

            // Aadhar number validation (12 digits with optional spaces)
            const aadharInput = document.getElementById('aadharNumber');
            if (aadharInput) {
                aadharInput.addEventListener('input', function() {
                    // Remove all non-digits first
                    let value = this.value.replace(/\D/g, '');
                    // Limit to 12 digits
                    value = value.slice(0, 12);
                    // Format with spaces: XXXX XXXX XXXX
                    if (value.length > 8) {
                        this.value = value.slice(0, 4) + ' ' + value.slice(4, 8) + ' ' + value.slice(8);
                    } else if (value.length > 4) {
                        this.value = value.slice(0, 4) + ' ' + value.slice(4);
                    } else {
                        this.value = value;
                    }
                });
            }
            
            // PAN number validation (letters and numbers only, no special characters)
            const panInput = document.getElementById('panNumber');
            if (panInput) {
                panInput.addEventListener('input', function() {
                    // Allow only letters and numbers, convert to uppercase
                    let value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    // Limit to 10 characters (standard PAN format)
                    if (value.length > 10) value = value.substring(0, 10);
                    this.value = value;
                });
            }

            // Auto-calculate retirement date (60 years from appointment)
            const appointmentInput = document.getElementById('dateOfAppointment');
            const retirementInput = document.getElementById('retirementDate');
            
            // Retirement date is now calculated from DOB, not appointment date
            // Keeping appointment input listener for any other validation if needed

            // Spouse name field toggle
            const maritalStatusSelect = document.getElementById('maritalStatus');
            const spouseNameInput = document.getElementById('spouseName');
            
            if (maritalStatusSelect && spouseNameInput) {
                maritalStatusSelect.addEventListener('change', function() {
                    const enableSpouse = this.value === 'Married';
                    
                    if (enableSpouse) {
                        spouseNameInput.disabled = false;
                        spouseNameInput.style.backgroundColor = '';
                        spouseNameInput.style.color = '';
                        spouseNameInput.required = true;
                    } else {
                        spouseNameInput.disabled = true;
                        spouseNameInput.style.backgroundColor = '#f5f5f5';
                        spouseNameInput.style.color = '#999';
                        spouseNameInput.required = false;
                        spouseNameInput.value = '';
                    }
                });
                
                // Initialize the field state
                maritalStatusSelect.dispatchEvent(new Event('change'));
            }
            
            // Initialize date fields for both new and existing admissions
            initializeDateFields();
        }

        // Validation functions
        async function validateStaffIdInput(input) {
            // Remove any non-alphanumeric characters
            input.value = input.value.replace(/[^a-zA-Z0-9]/g, '');
            
            // Real-time uniqueness check
            const staffId = input.value.trim();
            if (staffId.length >= 3) { // Only check when user has typed at least 3 characters
                const admissionId = document.getElementById('admissionId').value;
                const currentId = admissionId ? parseInt(admissionId) : null;
                
                    input.style.borderColor = '#fbbf24';
                input.style.boxShadow = '0 0 0 2px rgba(251, 191, 36, 0.2)';
                
                const isUnique = await validateStaffIdUniqueness(staffId, currentId);
                if (!isUnique) {
                    input.style.borderColor = '#ef4444';
                    input.style.boxShadow = '0 0 0 2px rgba(239, 68, 68, 0.2)';
                    
                    // Show tooltip or message
                    let tooltip = input.parentElement.querySelector('.staff-id-error');
                    if (!tooltip) {
                        tooltip = document.createElement('div');
                        tooltip.className = 'staff-id-error';
                        tooltip.style.cssText = 'color: #ef4444; font-size: 12px; margin-top: 4px;';
                        input.parentElement.appendChild(tooltip);
                    }
                    tooltip.textContent = 'This Staff ID is already in use';
                } else {
                    // Valid - reset styling
                    input.style.borderColor = '#10b981';
                    input.style.boxShadow = '0 0 0 2px rgba(16, 185, 129, 0.2)';
                    
                    // Remove error message
                    const tooltip = input.parentElement.querySelector('.staff-id-error');
                    if (tooltip) {
                        tooltip.remove();
                    }
                }
            } else {
                // Reset styling for short inputs
                input.style.borderColor = '';
                input.style.boxShadow = '';
                const tooltip = input.parentElement.querySelector('.staff-id-error');
                if (tooltip) {
                    tooltip.remove();
                }
            }
        }

        function validateNameInput(input) {
            // Remove any non-text characters (allow only letters and spaces)
            input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
        }

        function validateNumericInput(input) {
            // Remove any non-numeric characters
            input.value = input.value.replace(/[^0-9]/g, '');
        }

        function capitalizeFirstLetter(input) {
            // Capitalize first letter of each word
            input.value = input.value.replace(/\b\w/g, (char) => char.toUpperCase());
        }
        
        function validateTextOnlyAndCapitalize(input) {
            // Remove any non-alphabetic characters except spaces
            input.value = input.value.replace(/[^A-Za-z\s]/g, '');
            // Capitalize first letter of each word
            input.value = input.value.replace(/\b\w/g, (char) => char.toUpperCase());
        }
        
        function validatePercentageInput(input) {
            // Remove any non-numeric characters
            input.value = input.value.replace(/[^0-9]/g, '');
            
            // Convert to number and validate range
            const value = parseInt(input.value);
            if (value > 100) {
                input.value = '100';
            } else if (value < 1 && input.value !== '') {
                input.value = '1';
            }
            
            // Add visual feedback
            if (input.value && (value >= 1 && value <= 100)) {
                input.style.borderColor = '#28a745';
            } else if (input.value) {
                input.style.borderColor = '#dc3545';
            } else {
                input.style.borderColor = '';
            }
        }

        async function validateStaffIdUniqueness(staffId, currentRecordId = null) {
            // First check localStorage for immediate feedback
            const currentId = currentRecordId ? parseInt(currentRecordId) : null;
            const existingRecord = admissions.find(admission => 
                admission.staffId === staffId && 
                admission.id !== currentId
            );
            
            if (existingRecord) {
                return false;
            }
            
            // Then check database via API for definitive validation (only if API service is available)
            if (window.apiService && window.apiService.isOnline) {
                try {
                    const response = await fetch(`/api/admissions/check-staff-id/${staffId}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        return !result.exists;
                    } else {
                        console.warn('Failed to validate staff ID uniqueness via API');
                        return true; // Fallback to allow if API fails
                    }
                } catch (error) {
                    console.warn('Error validating staff ID uniqueness:', error);
                    return true; // Fallback to allow if API fails
                }
            } else {
                // API service not available, rely on local validation only
                return true;
            }
        }
        
        // Helper function to find staff by Staff ID (user-defined identifier)
        function findStaffByStaffId(staffId) {
            return admissions.find(staff => staff.staffId === staffId);
        }
        
        // Helper function to get all data linked to a Staff ID
        function getStaffLinkedData(staffId) {
            const staff = findStaffByStaffId(staffId);
            if (!staff) return null;
            
            // Get all data linked to this staff member
            const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]')
                .filter(record => record.staffId === staffId);
            
            const leaveApplications = JSON.parse(localStorage.getItem('leaveApplications') || '[]')
                .filter(app => app.userStaffId === staffId);
            
            const pensionNominees = JSON.parse(localStorage.getItem('pensionNominees') || '[]')
                .filter(nominee => nominee.staffId === staffId);
            
            return {
                staff: staff,
                attendanceRecords: savedAttendanceRecords,
                leaveApplications: leaveApplications,
                pensionNominees: pensionNominees
            };
        }

        function validateAppointmentAge(dateOfBirth, dateOfAppointment) {
            // Birth date is in ISO format when called from form submission
            const birthDate = new Date(dateOfBirth);
            const appointmentDate = new Date(dateOfAppointment);
            
            if (!birthDate || isNaN(birthDate.getTime())) return false;
            let ageAtAppointment = appointmentDate.getFullYear() - birthDate.getFullYear();
            const monthDiff = appointmentDate.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && appointmentDate.getDate() < birthDate.getDate())) {
                ageAtAppointment--;
            }
            
            return ageAtAppointment >= 18;
        }

        // Field labels mapping
        const fieldLabels = {
            'staffId': 'Staff ID',
            'designation': 'Designation',
            'staffName': 'Staff Name',
            'fatherName': 'Father Name',
            'motherName': 'Mother Name',
            'grandFatherName': 'Grandfather Name',
            'maritalStatus': 'Marital Status',
            'spouseName': 'Spouse Name',
            'dateOfBirth': 'Date of Birth',
            'age': 'Age',
            'sex': 'Gender',
            'nationality': 'Nationality',
            'dateOfAppointment': 'Date of Appointment',
            'retirementDate': 'Retirement Date',
            'functionCode': 'Function Code',
            'objectCode': 'Object Code',
            'dateOfNextIncrement': 'Date of Next Increment',
            'pensionScheme': 'Pension Scheme',
            'mobileNumber': 'Mobile Number',
            'aadharNumber': 'Aadhar Number',
            'panNumber': 'PAN Number',
            'permanentAddress': 'Permanent Address',
            'communicationAddress': 'Communication Address',
            // Salary-related fields
            'payBand': 'Pay Band',
            'basicPay': 'Basic Pay',
            'gradePay': 'Grade Pay',
            'payLevel': 'Pay Level',
            'payCell': 'Pay Cell',
            'da': 'Dearness Allowance (DA)',
            'hra': 'House Rent Allowance (HRA)',
            'cca': 'City Compensatory Allowance (CCA)',
            'medicalAllowance': 'Medical Allowance',
            'washingAllowance': 'Washing Allowance',
            'childEduAllowance': 'Child Education Allowance',
            'specialAllowance': 'Special Allowance',
            'otherAllowances': 'Other Allowances',
            'grossSalary': 'Gross Salary',
            // Deduction fields
            'providentFund': 'Provident Fund',
            'professionalTax': 'Professional Tax',
            'incomeTax': 'Income Tax',
            'groupInsurance': 'Group Insurance',
            'medicalInsurance': 'Medical Insurance',
            'otherDeductions': 'Other Deductions',
            'totalDeductions': 'Total Deductions',
            'netSalary': 'Net Salary'
        };

        // Function to detect changes in real-time
        function updateRealTimeChanges() {
            const changes = [];
            const form = document.getElementById('admissionForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            console.log('=== Change Detection Debug ===');
            console.log('Total inputs found:', inputs.length);
            console.log('Original form data keys:', Object.keys(originalFormData));
            
            inputs.forEach(input => {
                if (input.type !== 'hidden' && input.id && originalFormData.hasOwnProperty(input.id)) {
                    const originalValue = originalFormData[input.id] || '';
                    const currentValue = input.value || '';
                    
                    // Debug logging for all field comparisons
                    if (originalValue !== currentValue) {
                        console.log(`Field changed - ${input.id}:`, {
                            original: originalValue,
                            current: currentValue,
                            fieldLabel: fieldLabels[input.id] || input.id
                        });
                    }
                    
                    if (originalValue !== currentValue) {
                        const fieldName = fieldLabels[input.id] || input.id;
                        
                        // Skip only truly auto-calculated fields that users never directly modify
                        const autoCalculatedFields = ['age', 'grossSalary', 'totalDeductions', 'netSalary'];
                        if (autoCalculatedFields.includes(input.id)) {
                            return;
                        }
                        
                        // Format change information based on field type and length
                        const maxLength = 50;
                        let originalDisplay = originalValue;
                        let currentDisplay = currentValue;
                        
                        // Truncate long values for display
                        if (originalValue.length > maxLength) {
                            originalDisplay = originalValue.substring(0, maxLength) + '...';
                        }
                        if (currentValue.length > maxLength) {
                            currentDisplay = currentValue.substring(0, maxLength) + '...';
                        }
                        
                        // Show more detailed change information
                        if (originalValue === '') {
                            changes.push(`${fieldName}: Added "${currentDisplay}"`);
                        } else if (currentValue === '') {
                            changes.push(`${fieldName}: Cleared (was "${originalDisplay}")`);
                        } else {
                            changes.push(`${fieldName}: "${originalDisplay}" ‚Üí "${currentDisplay}"`);
                        }
                    }
                }
            });
            
            // Check for photo changes
            const originalPhoto = originalFormData.photo || '';
            const currentPhoto = currentPhotoData || '';
            if (originalPhoto !== currentPhoto) {
                if (originalPhoto === '' && currentPhoto !== '') {
                    changes.push('Photo: Added new photo');
                } else if (originalPhoto !== '' && currentPhoto === '') {
                    changes.push('Photo: Removed photo');
                } else {
                    changes.push('Photo: Updated photo');
                }
            }
            
            // Check for children changes
            const originalChildren = originalFormData.children || [];
            const currentChildrenData = currentChildren || [];
            if (JSON.stringify(originalChildren) !== JSON.stringify(currentChildrenData)) {
                if (originalChildren.length === 0 && currentChildrenData.length > 0) {
                    changes.push(`Children: Added ${currentChildrenData.length} child(ren)`);
                } else if (originalChildren.length > 0 && currentChildrenData.length === 0) {
                    changes.push('Children: Removed all children information');
                } else if (originalChildren.length !== currentChildrenData.length) {
                    changes.push(`Children: Changed from ${originalChildren.length} to ${currentChildrenData.length} child(ren)`);
                } else {
                    changes.push('Children: Updated children information');
                }
            }
            
            // Check for documents changes
            const originalDocs = originalFormData.documents || [];
            const currentDocs = uploadedDocuments || [];
            if (JSON.stringify(originalDocs) !== JSON.stringify(currentDocs)) {
                if (originalDocs.length === 0 && currentDocs.length > 0) {
                    changes.push(`Documents: Added ${currentDocs.length} document(s)`);
                } else if (originalDocs.length > 0 && currentDocs.length === 0) {
                    changes.push('Documents: Removed all documents');
                } else if (originalDocs.length !== currentDocs.length) {
                    changes.push(`Documents: Changed from ${originalDocs.length} to ${currentDocs.length} document(s)`);
                } else {
                    changes.push('Documents: Updated document information');
                }
            }
            
            realTimeChanges = changes;
            return changes;
        }

        // Function to set up real-time change tracking
        function setupRealTimeTracking() {
            const form = document.getElementById('admissionForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.type !== 'hidden' && input.id) {
                    input.addEventListener('input', updateRealTimeChanges);
                    input.addEventListener('change', updateRealTimeChanges);
                }
            });
        }

        // Function to detect changes in form (for save modal)
        function getFormChanges() {
            return updateRealTimeChanges();
        }

        // Save functions
        function saveAdmission(event) {
            console.log('saveAdmission called');
            event.preventDefault();
            
            // Check if this is from two-step process
            const isTwoStepSubmission = event.bypassTwoStepValidation || false;
            
            // Check if this is an edit operation
            const admissionId = document.getElementById('admissionId').value;
            if (admissionId) {
                // Get changes for edit operation
                const changes = getFormChanges();
                
                console.log('Edit operation detected. Changes found:', changes.length);
                console.log('Changes list:', changes);
                
                if (changes.length > 0) {
                    // Show save modal with changes
                    window.pendingSaveAction = () => {
                        processSaveAdmission(event, isTwoStepSubmission);
                    };
                    showSaveModal(changes);
                    return;
                } else {
                    console.log('No changes detected - proceeding with normal save');
                }
            }
            
            // For new admissions or no changes, proceed directly
            processSaveAdmission(event, isTwoStepSubmission);
        }

        async function processSaveAdmission(event, isTwoStepSubmission = false) {
            
            const formData = new FormData(event.target);
            const data = {};
            
            // Get all form values
            const form = document.getElementById('admissionForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.id && input.id !== 'admissionId') {
                    // For date fields that use Pikaday (text inputs in DD/MM/YYYY format)
                    if ((input.id === 'dateOfBirth' || input.id === 'dateOfAppointment' || 
                         input.id === 'dateOfNextIncrement' || input.id === 'retirementDate') && input.value) {
                        // Keep dates in DD/MM/YYYY format as entered
                        data[input.id] = input.value;
                    } else {
                        data[input.id] = input.value;
                    }
                }
            });
            
            // Copy values from edit salary fields to original fields (for existing staff)
            const isEdit = document.getElementById('admissionId').value;
            if (isEdit) {
                const daEdit = document.getElementById('daEdit').value;
                const hraEdit = document.getElementById('hraEdit').value;
                const specialPayEdit = document.getElementById('specialPayEdit').value;
                const specialAllowanceEdit = document.getElementById('specialAllowanceEdit').value;
                const otherAllowanceEdit = document.getElementById('otherAllowanceEdit').value;
                
                if (daEdit) {
                    data.da = daEdit;
                    document.getElementById('da').value = daEdit;
                }
                if (hraEdit) {
                    data.hra = hraEdit;
                    document.getElementById('hra').value = hraEdit;
                }
                if (specialPayEdit) {
                    data.specialPay = specialPayEdit;
                    document.getElementById('specialPay').value = specialPayEdit;
                }
                if (specialAllowanceEdit) {
                    data.specialAllowance = specialAllowanceEdit;
                    document.getElementById('specialAllowance').value = specialAllowanceEdit;
                }
                if (otherAllowanceEdit) {
                    data.otherAllowance = otherAllowanceEdit;
                    document.getElementById('otherAllowance').value = otherAllowanceEdit;
                }
            }
            
            // Save the calculated basic pay separately from the pay band dropdown
            const basicPayCalculatedElement = document.getElementById('basicPayCalculated');
            if (basicPayCalculatedElement && basicPayCalculatedElement.value) {
                data.basicSalary = basicPayCalculatedElement.value;
                // Keep data.basicPay as the Pay Band dropdown value
                // and set basicSalary as the calculated amount for Pay Slip compatibility
            }
            
            // Store pay structure fields separately for edit restoration
            const payBandElement = document.getElementById('basicPay');
            const gradePayElement = document.getElementById('gradePay');
            const payLevelElement = document.getElementById('payLevel');
            const payCellElement = document.getElementById('payCell');
            
            if (payBandElement && payBandElement.value) {
                data.payBand = payBandElement.value;
            }
            if (gradePayElement && gradePayElement.value) {
                data.gradePay = gradePayElement.value;
            }
            if (payLevelElement && payLevelElement.value) {
                data.payLevel = payLevelElement.value;
            }
            if (payCellElement && payCellElement.value) {
                data.payCell = payCellElement.value;
            }
            
            // Debug logging for salary fields
            console.log('=== SAVING SALARY FIELDS ===');
            console.log('processSaveAdmission - Salary Fields Debug:', {
                payBand: data.payBand,
                gradePay: data.gradePay,
                payLevel: data.payLevel,
                payCell: data.payCell,
                basicPay: data.basicPay,
                basicSalary: data.basicSalary,
                da: data.da,
                hra: data.hra,
                specialPay: data.specialPay,
                specialAllowance: data.specialAllowance,
                otherAllowance: data.otherAllowance
            });

            // Add photo data (including null to remove photo)
            data.photo = currentPhotoData;

            // Add documents data if available
            if (uploadedDocuments.length > 0) {
                data.documents = [...uploadedDocuments];
            }

            // Add children data if available
            if (currentChildren.length > 0) {
                data.children = [...currentChildren];
            }

            const id = document.getElementById('admissionId').value;
            
            // Debug logging
            console.log('Save Admission Debug:', {
                id: id,
                staffId: data.staffId,
                isEdit: !!id
            });
            
            // Validate staff ID uniqueness (only if creating new record or changing staff ID)
            if (!id) {
                // New record - check against all existing records
                console.log('New record validation');
                const isUnique = await validateStaffIdUniqueness(data.staffId, null);
                if (!isUnique) {
                    alert('Staff ID already exists. Please use a different ID.');
                    return;
                }
            } else {
                // Editing existing record - only validate if staff ID was changed
                const currentRecord = admissions.find(a => a.id === parseInt(id));
                console.log('Edit validation:', {
                    currentRecord: currentRecord,
                    currentStaffId: currentRecord?.staffId,
                    newStaffId: data.staffId,
                    staffIdChanged: currentRecord?.staffId !== data.staffId
                });
                
                if (currentRecord && currentRecord.staffId !== data.staffId) {
                    // Staff ID was changed, check for uniqueness
                    console.log('Staff ID changed, validating uniqueness');
                    const isUnique = await validateStaffIdUniqueness(data.staffId, id);
                    if (!isUnique) {
                        alert('Staff ID already exists. Please use a different ID.');
                        return;
                    }
                } else {
                    console.log('Staff ID not changed or record not found, skipping validation');
                }
                // If staff ID wasn't changed, skip validation entirely
            }
            
            // Validate mobile number - must be exactly 10 digits
            if (data.mobileNumber && data.mobileNumber.trim() !== '') {
                const mobileNumber = data.mobileNumber.replace(/\D/g, ''); // Remove non-digits
                if (mobileNumber.length !== 10) {
                    const mobileInput = document.getElementById('mobileNumber');
                    if (mobileInput) {
                        mobileInput.focus();
                        showMobileNumberError('Mobile number must be exactly 10 digits.');
                        setTimeout(() => {
                            hideMobileNumberError();
                        }, 3000);
                    }
                    return;
                }
                // Update the data with cleaned mobile number
                data.mobileNumber = mobileNumber;
            } else {
                const mobileInput = document.getElementById('mobileNumber');
                if (mobileInput) {
                    mobileInput.focus();
                    showMobileNumberError('Mobile number is required.');
                    setTimeout(() => {
                        hideMobileNumberError();
                    }, 3000);
                }
                return;
            }
            
            // Validate appointment age (skip if from two-step process since it was already validated in step 1)
            if (!isTwoStepSubmission && data.dateOfBirth && data.dateOfAppointment) {
                const birthDate = parseDDMMYYYY(data.dateOfBirth);
                const appointmentDate = parseDDMMYYYY(data.dateOfAppointment);
                
                if (birthDate && appointmentDate) {
                    const ageAtAppointment = (appointmentDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000);
                    
                    if (ageAtAppointment < 18) {
                        // Show red error message
                        const errorElement = document.getElementById('dateOfAppointmentError');
                        if (errorElement) {
                            errorElement.style.display = 'block';
                            errorElement.textContent = 'Invalid date';
                            
                            setTimeout(function() {
                                errorElement.style.display = 'none';
                            }, 3000);
                        }
                        return;
                    }
                }
            }
            
            let recordId;
            
            // Save to database via API
            try {
                if (id) {
                    // Update existing record
                    recordId = parseInt(id);
                    
                    if (window.apiService && window.apiService.isOnline) {
                        // Save to database
                        const updatedRecord = await window.apiService.updateAdmission(recordId, data);
                        console.log('Successfully updated record in database:', updatedRecord);
                        
                        // Update local array
                        const index = admissions.findIndex(a => a.id === recordId);
                        if (index !== -1) {
                            admissions[index] = { ...admissions[index], ...data, id: recordId };
                        }
                    } else {
                        // Fallback to localStorage
                        const index = admissions.findIndex(a => a.id === recordId);
                        if (index !== -1) {
                            admissions[index] = { ...admissions[index], ...data, id: recordId };
                        }
                    }
                } else {
                    // Add new record
                    if (window.apiService && window.apiService.isOnline) {
                        // Save to database
                        const newRecord = await window.apiService.createAdmission({
                            ...data,
                            status: 'approved', // Set as approved by default
                            created_at: new Date().toISOString()
                        });
                        console.log('Successfully created record in database:', newRecord);
                        recordId = newRecord.id;
                        
                        // Add to local array
                        admissions.push(newRecord);
                    } else {
                        // Fallback to localStorage
                        recordId = Math.max(...admissions.map(a => a.id), 0) + 1;
                        const newRecord = {
                            id: recordId,
                            ...data,
                            status: 'approved',
                            created_at: new Date().toISOString()
                        };
                        admissions.push(newRecord);
                    }
                }
            } catch (error) {
                console.error('Failed to save to database, using localStorage fallback:', error);
                
                // Fallback logic
                if (id) {
                    recordId = parseInt(id);
                    const index = admissions.findIndex(a => a.id === recordId);
                    if (index !== -1) {
                        admissions[index] = { ...admissions[index], ...data, id: recordId };
                    }
                } else {
                    recordId = Math.max(...admissions.map(a => a.id), 0) + 1;
                    admissions.push({
                        id: recordId,
                        ...data,
                        status: 'approved',
                        created_at: new Date().toISOString()
                    });
                }
            }
            
            // Save to localStorage
            saveAdmissionsToStorage();
            
            // Debug logging - check if updated data is in admissions array
            const savedStaff = admissions.find(a => a.id === recordId);
            if (savedStaff) {
                console.log('After Save - Staff Data in Array:', {
                    staffId: savedStaff.staffId,
                    basicSalary: savedStaff.basicSalary,
                    da: savedStaff.da,
                    hra: savedStaff.hra,
                    specialPay: savedStaff.specialPay,
                    specialAllowance: savedStaff.specialAllowance,
                    otherAllowance: savedStaff.otherAllowance
                });
            }
            
            // Refresh Pay Slip if currently visible (with small delay to ensure save completes)
            setTimeout(() => {
                refreshPaySlipIfVisible();
                // Also refresh PS Verification if visible to update Gross Salary and Total Deductions
                refreshPSVerificationIfVisible();
            }, 100);
            
            // Refresh Staff Management table to show the new/updated staff member
            if (typeof renderAdmissionsTable === 'function') {
                renderAdmissionsTable(admissions);
            }
            
            // Log the staff creation/update
            if (currentUserData) {
                const action = id ? 'staff_update' : 'staff_create';
                const actionText = id ? 'Updated' : 'Created';
                addUserLog(
                    currentUserData.id || 0,
                    currentUserData.fullName || 'Unknown User',
                    currentUserData.email || 'unknown@email.com',
                    action,
                    `${actionText} staff record: ${data.staffName || 'Unknown'} (${data.staffId || 'N/A'})`,
                    recordId,
                    'staff'
                );
            }
            
            console.log('About to close modal and refresh');
            
            // Check if this is from two-step submission (has success callback)
            if (isTwoStepSubmission && window.admissionSubmissionSuccess) {
                // Call the success callback which handles modal closure and step reset
                window.admissionSubmissionSuccess();
                // Clear form data for next use
                document.getElementById('admissionForm').reset();
                currentPhotoData = null;
                uploadedDocuments = [];
                currentChildren = [];
                updateChildrenDisplay();
                console.log('Two-step submission completed via callback');
                
                // Refresh details modal if it's currently open for this staff member
                if (recordId) {
                    refreshStaffDetailsIfOpen(recordId);
                }
                
                // Success message handled by modal
            } else {
                // Original logic for regular submissions
                // Close modal and clear form
                closeModal('admissionModal');
                console.log('Modal closed');
                
                // Clear form data for next use
                document.getElementById('admissionForm').reset();
                currentPhotoData = null;
                uploadedDocuments = [];
                currentChildren = [];
                updateChildrenDisplay();
                console.log('Form cleared');
                
                // Refresh dashboard to show updated data
                loadDashboardData();
                console.log('Dashboard refreshed');
                
                // Refresh details modal if it's currently open for this staff member
                if (recordId) {
                    refreshStaffDetailsIfOpen(recordId);
                }
                
                // Success message will be shown by the Changes Applied modal for edits
                // For new admissions, we can show an alert since it doesn't use the save modal
                if (!id) {
                    alert('Admission added successfully!');
                }
            }
        }

        // Child management functions
        let currentChildren = [];

        function openAddChildModal() {
            // Check if Date of Birth is filled before opening modal
            const dateOfBirthInput = document.getElementById('dateOfBirth');
            if (!dateOfBirthInput || !dateOfBirthInput.value || dateOfBirthInput.value.trim() === '') {
                alert('Please fill Date of Birth first before adding children.');
                return;
            }
            document.getElementById('addChildForm').reset();
            document.getElementById('childAge').value = '';
            
            // Clear any validation styling and error messages
            const dobInput = document.getElementById('childDOB');
            const ageInput = document.getElementById('childAge');
            const errorDiv = document.getElementById('childDOBError');
            
            if (dobInput) {
                dobInput.style.borderColor = '';
                dobInput.style.backgroundColor = '';
            }
            if (ageInput) {
                ageInput.style.borderColor = '';
                ageInput.style.backgroundColor = '';
            }
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            
            openProfessionalModal('addChildModal');
            
            // Initialize Flatpickr date picker for child DOB field
            setTimeout(() => {
                initializeChildDOBFlatpickr();
            }, 300);
        }
        
        // Initialize Flatpickr for child DOB field with Google Calendar style
        function initializeChildDOBFlatpickr() {
            const childDOBField = document.getElementById('childDOB');
            if (!childDOBField) {
                console.error('Child DOB field not found');
                return;
            }
            
            // Destroy existing instances if any
            if (childDOBField._flatpickr) {
                try {
                    childDOBField._flatpickr.destroy();
                    delete childDOBField._flatpickr;
                } catch (e) {
                    console.log('Error destroying existing Flatpickr instance:', e);
                }
            }
            
            if (childDOBField._pikaday) {
                try {
                    childDOBField._pikaday.destroy();
                    delete childDOBField._pikaday;
                } catch (e) {
                    console.log('Error destroying existing Pikaday instance:', e);
                }
            }
            
            try {
                const flatpickrInstance = flatpickr(childDOBField, {
                    dateFormat: "d/m/Y",  // DD/MM/YYYY format
                    maxDate: "today",
                    animate: true,
                    allowInput: false,
                    clickOpens: true,
                    monthSelectorType: "dropdown",
                    yearSelectorType: "dropdown",
                    appendTo: document.getElementById('addChildModal'),
                    positionElement: childDOBField,
                    onChange: function(selectedDates, dateStr, instance) {
                        // Ensure the date string is in correct format
                        if (dateStr) {
                            childDOBField.value = dateStr;
                            console.log('Child DOB selected:', dateStr);
                        }
                        
                        // Close the date picker automatically after selection
                        setTimeout(() => {
                            instance.close();
                        }, 100);
                        
                        // Trigger age calculation
                        calculateChildAge();
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        // Add Google Calendar style class
                        instance.calendarContainer.classList.add('google-calendar-style');
                    }
                });
                
                // Store the instance
                childDOBField._flatpickr = flatpickrInstance;
                
                // Make sure the field is properly styled
                childDOBField.classList.add('google-calendar-input');
                
                console.log('Flatpickr initialized successfully for child DOB field');
                
            } catch (error) {
                console.error('Error initializing Flatpickr for child DOB:', error);
            }
        }

        function calculateChildAge() {
            const dobInput = document.getElementById('childDOB');
            const ageInput = document.getElementById('childAge');
            
            // Clear any previous validation styling
            dobInput.style.borderColor = '';
            dobInput.style.backgroundColor = '';
            
            if (dobInput.value) {
                const birthDate = parseDDMMYYYY(dobInput.value);
                if (!birthDate) {
                    ageInput.value = '';
                    return;
                }
                const today = new Date();
                
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                
                ageInput.value = age >= 0 ? age : 0;
                
                // Real-time validation with visual feedback
                const validationResult = validateChildDateOfBirth(dobInput.value);
                if (!validationResult.isValid) {
                    // Show validation error with red border
                    dobInput.style.borderColor = '#dc3545';
                    dobInput.style.backgroundColor = '#fff5f5';
                    ageInput.style.borderColor = '#dc3545';
                    ageInput.style.backgroundColor = '#fff5f5';
                    
                    // Show error message below the age field
                    let errorDiv = document.getElementById('childDOBError');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.id = 'childDOBError';
                        errorDiv.style.cssText = `
                            color: #dc3545;
                            font-size: 12px;
                            margin-top: 5px;
                            padding: 5px;
                            background: #fff5f5;
                            border: 1px solid #dc3545;
                            border-radius: 4px;
                            display: flex;
                            align-items: center;
                            gap: 5px;
                        `;
                        ageInput.parentNode.appendChild(errorDiv);
                    }
                    errorDiv.innerHTML = `‚ö†Ô∏è ${validationResult.errorMessage}`;
                    errorDiv.style.display = 'block';
                } else {
                    // Clear validation error styling
                    dobInput.style.borderColor = '#28a745';
                    dobInput.style.backgroundColor = '#f8fff8';
                    ageInput.style.borderColor = '#28a745';
                    ageInput.style.backgroundColor = '#f8fff8';
                    
                    // Remove error message
                    const errorDiv = document.getElementById('childDOBError');
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                    }
                }
            } else {
                ageInput.value = '';
                // Remove any error messages when field is empty
                const errorDiv = document.getElementById('childDOBError');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
            }
        }

        function saveChild(event) {
            event.preventDefault();
            
            const childName = document.getElementById('childNameInput').value;
            const childGender = document.getElementById('childGender').value;
            const childDOB = document.getElementById('childDOB').value;
            const childAge = document.getElementById('childAge').value;
            
            console.log('Saving child with DOB:', childDOB);
            
            if (!childName || !childGender || !childDOB) {
                alert('Please fill all required fields');
                return;
            }
            
            // Validate child's date of birth
            const validationResult = validateChildDateOfBirth(childDOB);
            if (!validationResult.isValid) {
                alert(validationResult.errorMessage);
                return;
            }
            
            const child = {
                name: childName,
                gender: childGender,
                dob: childDOB,
                age: childAge
            };
            
            currentChildren.push(child);
            updateChildrenDisplay();
            closeModal('addChildModal');
            alert('Child added successfully!');
        }
        
        // Comprehensive child date of birth validation function
        function validateChildDateOfBirth(childDOBStr) {
            const result = { isValid: true, errorMessage: '' };
            
            // Get parent's date of birth from the main form (works for both add and edit modes)
            const parentDOBStr = document.getElementById('dateOfBirth').value;
            if (!parentDOBStr || parentDOBStr.trim() === '') {
                result.isValid = false;
                
                // Check if we're in edit mode
                const admissionId = document.getElementById('admissionId').value;
                if (admissionId) {
                    result.errorMessage = 'Please update the staff member\'s date of birth before adding/editing children.';
                } else {
                    result.errorMessage = 'Please enter the parent\'s date of birth first before adding children.';
                }
                return result;
            }
            
            // Parse dates
            const childDOB = parseDDMMYYYY(childDOBStr);
            const parentDOB = parseDDMMYYYY(parentDOBStr);
            const today = new Date();
            
            if (!childDOB) {
                console.error('Failed to parse child DOB:', childDOBStr);
                result.isValid = false;
                result.errorMessage = 'Invalid date format for child\'s date of birth. Please use DD/MM/YYYY format.';
                return result;
            }
            
            if (!parentDOB) {
                console.error('Failed to parse parent DOB:', parentDOBStr);
                result.isValid = false;
                result.errorMessage = 'Invalid date format for parent\'s date of birth. Please check the main form.';
                return result;
            }
            
            // Rule 1: Child's Date of Birth cannot be earlier than Parent's Date of Birth + 19 years
            const parentMinChildDate = new Date(parentDOB);
            parentMinChildDate.setFullYear(parentMinChildDate.getFullYear() + 19);
            
            if (childDOB < parentMinChildDate) {
                const minDateStr = formatDateToDDMMYYYY(parentMinChildDate);
                result.isValid = false;
                result.errorMessage = `Child's date of birth cannot be earlier than ${minDateStr}. A parent must be at least 19 years older than their child.`;
                return result;
            }
            
            // Rule 2: Child's Date of Birth cannot be later than today's date
            if (childDOB > today) {
                result.isValid = false;
                result.errorMessage = 'Child\'s date of birth cannot be in the future.';
                return result;
            }
            
            // Rule 3: Child's Date of Birth must always be less than the Parent's current age
            // (This is essentially the same as Rule 1, but let's be extra explicit)
            const parentCurrentAge = today.getFullYear() - parentDOB.getFullYear();
            const childAge = today.getFullYear() - childDOB.getFullYear();
            
            if (childAge >= parentCurrentAge) {
                result.isValid = false;
                result.errorMessage = `Child cannot be older than or the same age as the parent. Parent's current age is approximately ${parentCurrentAge} years.`;
                return result;
            }
            
            // Additional logical check: Child should not be older than 25 years (reasonable limit)
            if (childAge > 25) {
                result.isValid = false;
                result.errorMessage = 'Child\'s age cannot exceed 25 years. For dependents older than 25, please use a different category.';
                return result;
            }
            
            return result;
        }
        
        // Function to revalidate child dates when parent's date of birth changes
        function revalidateChildrenOnParentDateChange() {
            // Only revalidate if the child modal is currently open and has a date selected
            const childModal = document.getElementById('addChildModal');
            const childDOBInput = document.getElementById('childDOB');
            
            if (childModal && childModal.style.display === 'block' && childDOBInput && childDOBInput.value) {
                // Rerun the age calculation and validation
                calculateChildAge();
            }
        }
        
        // Enhanced function to setup parent date change listener
        function setupParentDateChangeListener() {
            const parentDOBInput = document.getElementById('dateOfBirth');
            if (parentDOBInput) {
                // Add event listener for when parent date changes
                parentDOBInput.addEventListener('change', function() {
                    // Small delay to ensure the value is properly set
                    setTimeout(() => {
                        revalidateChildrenOnParentDateChange();
                    }, 100);
                });
            }
        }

        function updateChildrenDisplay() {
            const childrenList = document.getElementById('childrenList');
            
            if (currentChildren.length === 0) {
                childrenList.innerHTML = '<div class="empty-children-message" style="color: #666; font-style: italic; margin-bottom: 10px;">No children added yet</div>';
            } else {
                childrenList.innerHTML = currentChildren.map((child, index) => `
                    <div class="child-item" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px; background: #f9f9f9;">
                        <div>
                            <strong>${child.name}</strong> (${child.gender}, ${child.age} years)
                        </div>
                        <button type="button" class="btn btn-danger btn-small" onclick="removeChild(${index})">Remove</button>
                    </div>
                `).join('');
            }
        }

        function removeChild(index) {
            currentChildren.splice(index, 1);
            updateChildrenDisplay();
        }

        // Pension Nominee Management
        function openPensionNomineeModal(admissionId) {
            // Find the staff record by admission ID
            const admission = admissions.find(a => a.id === admissionId);
            if (!admission || !admission.staffId) {
                alert('Staff ID not found for this record');
                return;
            }
            
            const staffId = admission.staffId;
            document.getElementById('nomineeStaffId').value = staffId;
            document.getElementById('pensionNomineeForm').reset();
            document.getElementById('nomineePercentage').value = '';
            
            // Load existing nominees for this staff
            updateNomineesDisplay(staffId);
            
            openProfessionalModal('pensionNomineeModal');
            
            // Scroll modal to top
            setTimeout(() => {
                const modalContent = document.querySelector('#pensionNomineeModal .modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
            }, 100);
        }

        async function saveNominee(event) {
            event.preventDefault();
            
            const staffId = document.getElementById('nomineeStaffId').value;
            const name = document.getElementById('nomineeName').value;
            const relation = document.getElementById('nomineeRelation').value;
            const percentage = parseInt(document.getElementById('nomineePercentage').value);
            
            if (!staffId) {
                alert('Error: Staff ID not found');
                return;
            }
            
            // Initialize nominees array for this staff if not exists
            if (!pensionNominees[staffId]) {
                pensionNominees[staffId] = [];
            }
            
            // Check if total percentage exceeds 100
            const currentTotal = pensionNominees[staffId].reduce((sum, nominee) => sum + nominee.percentage, 0);
            if (currentTotal + percentage > 100) {
                showNomineePercentageErrorModal(currentTotal, percentage);
                return;
            }
            
            const nomineeData = {
                nominee_name: name,
                relation: relation,
                percentage: percentage
            };
            
            try {
                // Save to database via API
                if (window.apiService && window.apiService.isOnline) {
                    const savedNominee = await window.apiService.createNominee(staffId, nomineeData);
                    console.log('Successfully saved nominee to database:', savedNominee);
                }
                
                // Add to local array for immediate display
                pensionNominees[staffId].push({
                    name: name,
                    relation: relation,
                    percentage: percentage
                });
                
                // Save to localStorage as fallback
                await savePensionNomineesToStorage();
                
            } catch (error) {
                console.error('Failed to save nominee to database, using localStorage fallback:', error);
                
                // Add to local array for immediate display
                pensionNominees[staffId].push({
                    name: name,
                    relation: relation,
                    percentage: percentage
                });
                
                // Save to localStorage
                await savePensionNomineesToStorage();
            }
            
            // Update display in real-time
            updateNomineesDisplay(staffId);
            
            // Update user object with nominees data for details view
            const userIndex = users.findIndex(u => u.id == staffId);
            if (userIndex !== -1) {
                users[userIndex].nominees = pensionNominees[staffId] || [];
                saveUsersToStorage();
            }
            
            // Update notification badge after nominee changes
            updateNotificationBadge();
            
            // Refresh details modal if it's currently open for this staff member
            refreshStaffDetailsIfOpen(staffId);
            
            // Clear form fields but keep modal open
            document.getElementById('nomineeName').value = '';
            document.getElementById('nomineeRelation').value = '';
            document.getElementById('nomineePercentage').value = '';
        }

        function updateNomineesDisplay(staffId) {
            const nomineesContent = document.getElementById('nomineesListContent');
            const totalElement = document.getElementById('pensionTotalPercentage');
            
            const nominees = pensionNominees[staffId] || [];
            
            if (nominees.length === 0) {
                nomineesContent.innerHTML = '<div class="pension-empty-state">üìã No nominees added yet</div>';
                totalElement.textContent = 'Total: 0%';
                totalElement.className = 'pension-total-percentage';
            } else {
                const totalPercentage = nominees.reduce((sum, nominee) => sum + nominee.percentage, 0);
                
                // Update total percentage with color coding
                totalElement.textContent = `Total: ${totalPercentage}%`;
                totalElement.className = 'pension-total-percentage';
                
                if (totalPercentage > 100) {
                    totalElement.classList.add('danger');
                } else if (totalPercentage > 80) {
                    totalElement.classList.add('warning');
                }
                
                nomineesContent.innerHTML = nominees.map((nominee, index) => `
                    <div class="pension-nominee-item">
                        <div class="pension-nominee-info">
                            <div class="pension-nominee-name">${nominee.name}</div>
                            <div class="pension-nominee-details">${nominee.relation}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="pension-nominee-percentage">${nominee.percentage}%</div>
                            <button type="button" class="btn btn-danger" onclick="removeNominee('${staffId}', ${index})">Remove</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function removeNominee(staffId, index) {
            if (pensionNominees[staffId]) {
                pensionNominees[staffId].splice(index, 1);
                savePensionNomineesToStorage();
                updateNomineesDisplay(staffId);
            }
        }

        async function savePensionNomineesToStorage() {
            try {
                if (window.apiService && window.apiService.isOnline) {
                    console.log('Saving nominees to database via API');
                    // Individual nominees are saved via createNominee
                } else {
                    localStorage.setItem('cantonment_pension_nominees', JSON.stringify(pensionNominees));
                }
            } catch (error) {
                console.error('Failed to save nominees to API, using localStorage:', error);
                localStorage.setItem('cantonment_pension_nominees', JSON.stringify(pensionNominees));
            }
        }

        function loadPensionNomineesFromStorage() {
            const saved = localStorage.getItem('cantonment_pension_nominees');
            if (saved) {
                pensionNominees = JSON.parse(saved);
            }
        }

        // Deductions Management

        function openDeductionsModal(admissionId) {
            // Close any existing modals first
            closeAllModals();
            
            // Find the staff record by admission ID
            const admission = admissions.find(a => a.id === admissionId);
            if (!admission || !admission.staffId) {
                alert('Staff ID not found for this record');
                return;
            }

            const staffId = admission.staffId;
            document.getElementById('deductionsStaffId').value = staffId;

            // Load existing deductions data if available
            const existingDeductions = staffDeductions[staffId] || {};
            
            // Populate form fields with existing data
            const fields = [
                // Calculation group input fields
                'wheatAdvanceTotal', 'wheatAdvanceRecovered',
                'gpfAdvanceRecoveryTotal', 'gpfAdvanceRecoveryRecovered',
                'gpfLedBalanceOpening', 'gpfLedBalanceCurrent',
                'gpfAdvanceBalancePrevious', 'gpfAdvanceBalanceRecovery',
                'bankRecoveryLoan', 'bankRecoveryPaid',
                'gicTotal', 'gicMonthly',
                'licTotal', 'licMonthly',
                'electricityBillTotal', 'electricityBillMonthly',
                'waterChargesTotal', 'waterChargesMonthly',
                'recoveryTotal', 'recoveryMonthly',
                'leaveDeductionsTotal', 'leaveDeductionsMonthly',
                'gppcSubscriptionTotal', 'gppcSubscriptionMonthly',
                'gpfExtraSubscriptionTotal', 'gpfExtraSubscriptionMonthly',
                'gpfGovernmentContributionTotal', 'gpfGovernmentContributionMonthly',
                'npsGovernmentContributionTotal', 'npsGovernmentContributionMonthly',
                'npsSelfContributionTotal', 'npsSelfContributionMonthly',
                'gpfWithdrawlTotal', 'gpfWithdrawlMonthly',
                'gpfInterestTotal', 'gpfInterestMonthly',
                'incomeTaxTotal', 'incomeTaxMonthly',
                'surChargesTotal', 'surChargesMonthly',
                'otherDeduction1Total', 'otherDeduction1Monthly',
                'otherDeduction2Total', 'otherDeduction2Monthly',
                'otherDeduction3Total', 'otherDeduction3Monthly',
                
                // Calculated result fields (readonly)
                'wheatAdvance', 'gpfAdvanceRecovery', 'gpfLedBalance', 'gpfAdvanceBalance', 'bankRecovery', 
                'gic', 'lic', 'electricityBill', 'waterCharges', 'recovery', 'leaveDeductions', 
                'gppcSubscription', 'gpfExtraSubscription', 'gpfGovernmentContribution',
                'npsGovernmentContribution', 'npsSelfContribution', 'gpfWithdrawl',
                'gpfInterest', 'incomeTax', 'surCharges', 'otherDeduction1',
                'otherDeduction2', 'otherDeduction3'
            ];

            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    element.value = existingDeductions[field] || '';
                }
            });

            // Load remarks
            const remarksElement = document.getElementById('deductionsRemarks');
            if (remarksElement) {
                remarksElement.value = existingDeductions.remarks || '';
            }

            openProfessionalModal('deductionsModal');
            
            // Trigger calculations for all calculation groups after loading existing data
            setTimeout(() => {
                // Check enable/disable state for all monthly fields
                checkEnableMonthlyField('wheatAdvanceTotal', 'wheatAdvanceRecovered');
                checkEnableMonthlyField('gpfAdvanceRecoveryTotal', 'gpfAdvanceRecoveryRecovered');
                checkEnableMonthlyField('gpfLedBalanceOpening', 'gpfLedBalanceCurrent');
                checkEnableMonthlyField('gpfAdvanceBalancePrevious', 'gpfAdvanceBalanceRecovery');
                checkEnableMonthlyField('bankRecoveryLoan', 'bankRecoveryPaid');
                checkEnableMonthlyField('gicTotal', 'gicMonthly');
                checkEnableMonthlyField('licTotal', 'licMonthly');
                checkEnableMonthlyField('electricityBillTotal', 'electricityBillMonthly');
                checkEnableMonthlyField('waterChargesTotal', 'waterChargesMonthly');
                checkEnableMonthlyField('recoveryTotal', 'recoveryMonthly');
                checkEnableMonthlyField('leaveDeductionsTotal', 'leaveDeductionsMonthly');
                checkEnableMonthlyField('gppcSubscriptionTotal', 'gppcSubscriptionMonthly');
                checkEnableMonthlyField('gpfExtraSubscriptionTotal', 'gpfExtraSubscriptionMonthly');
                checkEnableMonthlyField('gpfGovernmentContributionTotal', 'gpfGovernmentContributionMonthly');
                checkEnableMonthlyField('npsGovernmentContributionTotal', 'npsGovernmentContributionMonthly');
                checkEnableMonthlyField('npsSelfContributionTotal', 'npsSelfContributionMonthly');
                checkEnableMonthlyField('gpfWithdrawlTotal', 'gpfWithdrawlMonthly');
                checkEnableMonthlyField('gpfInterestTotal', 'gpfInterestMonthly');
                checkEnableMonthlyField('incomeTaxTotal', 'incomeTaxMonthly');
                checkEnableMonthlyField('surChargesTotal', 'surChargesMonthly');
                checkEnableMonthlyField('otherDeduction1Total', 'otherDeduction1Monthly');
                checkEnableMonthlyField('otherDeduction2Total', 'otherDeduction2Monthly');
                checkEnableMonthlyField('otherDeduction3Total', 'otherDeduction3Monthly');
                
                calculateWheatAdvance();
                calculateGPFAdvanceRecovery();
                calculateGPFLedBalance();
                calculateGPFAdvanceBalance();
                calculateBankRecovery();
                calculateGIC();
                calculateLIC();
                calculateElectricityBill();
                calculateWaterCharges();
                calculateRecovery();
                calculateLeaveDeductions();
                calculateGPPCSubscription();
                calculateGPFExtraSubscription();
                calculateGPFGovernmentContribution();
                calculateNPSGovernmentContribution();
                calculateNPSSelfContribution();
                calculateGPFWithdrawl();
                calculateGPFInterest();
                calculateIncomeTax();
                calculateSurCharges();
                calculateOtherDeduction1();
                calculateOtherDeduction2();
                calculateOtherDeduction3();
                updateTotalDeductions();
            }, 100);
            
            // Scroll modal to top
            setTimeout(() => {
                const modalContent = document.querySelector('#deductionsModal .modal-content');
                if (modalContent) {
                    modalContent.scrollTop = 0;
                }
            }, 100);
        }

        // Function to enable/disable monthly field based on total advance value
        function checkEnableMonthlyField(totalFieldId, monthlyFieldId) {
            const totalField = document.getElementById(totalFieldId);
            const monthlyField = document.getElementById(monthlyFieldId);
            
            if (totalField && monthlyField) {
                if (totalField.value && parseFloat(totalField.value) > 0) {
                    monthlyField.disabled = false;
                    monthlyField.max = totalField.value;
                    
                    // If monthly value exceeds total, adjust it
                    if (monthlyField.value && parseFloat(monthlyField.value) > parseFloat(totalField.value)) {
                        monthlyField.value = totalField.value;
                    }
                } else {
                    monthlyField.disabled = true;
                    monthlyField.value = '';
                }
            }
        }
        
        // Function to validate monthly deduction doesn't exceed total
        function validateMonthlyDeduction(totalFieldId, monthlyFieldId) {
            const totalField = document.getElementById(totalFieldId);
            const monthlyField = document.getElementById(monthlyFieldId);
            
            if (totalField && monthlyField && totalField.value && monthlyField.value) {
                const totalValue = parseFloat(totalField.value);
                const monthlyValue = parseFloat(monthlyField.value);
                
                if (monthlyValue > totalValue) {
                    monthlyField.value = totalValue;
                    alert(`Monthly deduction cannot exceed total advance of ${totalValue}`);
                }
            }
        }

        // Real-time total deductions calculation
        function updateTotalDeductions() {
            // Get all monthly deduction amounts from specific input fields
            const wheatAdvanceRecovered = parseFloat(document.getElementById('wheatAdvanceRecovered')?.value || 0);
            const gpfAdvanceRecoveryRecovered = parseFloat(document.getElementById('gpfAdvanceRecoveryRecovered')?.value || 0);
            const gpfLedBalanceCurrent = parseFloat(document.getElementById('gpfLedBalanceCurrent')?.value || 0);
            const gpfAdvanceBalanceRecovery = parseFloat(document.getElementById('gpfAdvanceBalanceRecovery')?.value || 0);
            
            // Get direct monthly input fields
            const bankRecoveryPaid = parseFloat(document.getElementById('bankRecoveryPaid')?.value || 0);
            const gicMonthly = parseFloat(document.getElementById('gicMonthly')?.value || 0);
            const licMonthly = parseFloat(document.getElementById('licMonthly')?.value || 0);
            const electricityBillMonthly = parseFloat(document.getElementById('electricityBillMonthly')?.value || 0);
            const waterChargesMonthly = parseFloat(document.getElementById('waterChargesMonthly')?.value || 0);
            const recoveryMonthly = parseFloat(document.getElementById('recoveryMonthly')?.value || 0);
            const leaveDeductionsMonthly = parseFloat(document.getElementById('leaveDeductionsMonthly')?.value || 0);
            const gppcSubscriptionMonthly = parseFloat(document.getElementById('gppcSubscriptionMonthly')?.value || 0);
            const gpfExtraSubscriptionMonthly = parseFloat(document.getElementById('gpfExtraSubscriptionMonthly')?.value || 0);
            const gpfGovernmentContributionMonthly = parseFloat(document.getElementById('gpfGovernmentContributionMonthly')?.value || 0);
            const npsGovernmentContributionMonthly = parseFloat(document.getElementById('npsGovernmentContributionMonthly')?.value || 0);
            const npsSelfContributionMonthly = parseFloat(document.getElementById('npsSelfContributionMonthly')?.value || 0);
            const gpfWithdrawlMonthly = parseFloat(document.getElementById('gpfWithdrawlMonthly')?.value || 0);
            const gpfInterestMonthly = parseFloat(document.getElementById('gpfInterestMonthly')?.value || 0);
            const incomeTaxMonthly = parseFloat(document.getElementById('incomeTaxMonthly')?.value || 0);
            const surChargesMonthly = parseFloat(document.getElementById('surChargesMonthly')?.value || 0);
            const otherDeduction1Monthly = parseFloat(document.getElementById('otherDeduction1Monthly')?.value || 0);
            const otherDeduction2Monthly = parseFloat(document.getElementById('otherDeduction2Monthly')?.value || 0);
            const otherDeduction3Monthly = parseFloat(document.getElementById('otherDeduction3Monthly')?.value || 0);
            
            // Calculate total
            const totalMonthlyDeductions = Math.round(
                wheatAdvanceRecovered + gpfAdvanceRecoveryRecovered + gpfLedBalanceCurrent + gpfAdvanceBalanceRecovery +
                bankRecoveryPaid + gicMonthly + licMonthly + electricityBillMonthly + waterChargesMonthly + recoveryMonthly +
                leaveDeductionsMonthly + gppcSubscriptionMonthly + gpfExtraSubscriptionMonthly + gpfGovernmentContributionMonthly +
                npsGovernmentContributionMonthly + npsSelfContributionMonthly + gpfWithdrawlMonthly + gpfInterestMonthly +
                incomeTaxMonthly + surChargesMonthly + otherDeduction1Monthly + otherDeduction2Monthly + otherDeduction3Monthly
            );
            
            // Update the display
            const totalAmountElement = document.getElementById('totalMonthlyAmount');
            if (totalAmountElement) {
                totalAmountElement.textContent = `‚Çπ${totalMonthlyDeductions.toLocaleString()}`;
                
                // Add visual feedback for changes
                totalAmountElement.style.transform = 'scale(1.05)';
                totalAmountElement.style.transition = 'transform 0.2s ease';
                setTimeout(() => {
                    totalAmountElement.style.transform = 'scale(1)';
                }, 200);
            }
            
            console.log('Total monthly deductions updated:', totalMonthlyDeductions);
            return totalMonthlyDeductions;
        }

        // New calculation functions for deduction groups
        function calculateWheatAdvance() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFAdvanceRecovery() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFLedBalance() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFAdvanceBalance() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateBankRecovery() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGIC() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateLIC() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateElectricityBill() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateWaterCharges() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateRecovery() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateLeaveDeductions() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPPCSubscription() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFExtraSubscription() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFGovernmentContribution() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateNPSGovernmentContribution() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateNPSSelfContribution() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFWithdrawl() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateGPFInterest() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateIncomeTax() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateSurCharges() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateOtherDeduction1() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateOtherDeduction2() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }
        
        function calculateOtherDeduction3() {
            // Balance field removed - no calculation needed
            updateTotalDeductions();
        }


        function saveDeductions(event) {
            event.preventDefault();
            
            const staffId = document.getElementById('deductionsStaffId').value;
            
            if (!staffId) {
                alert('Staff ID not found');
                return;
            }

            // Collect all deduction data including calculation field inputs
            const deductionData = {
                // Calculation group input fields
                wheatAdvanceTotal: document.getElementById('wheatAdvanceTotal').value || '0',
                wheatAdvanceRecovered: document.getElementById('wheatAdvanceRecovered').value || '0',
                gpfAdvanceRecoveryTotal: document.getElementById('gpfAdvanceRecoveryTotal').value || '0',
                gpfAdvanceRecoveryRecovered: document.getElementById('gpfAdvanceRecoveryRecovered').value || '0',
                gpfLedBalanceOpening: document.getElementById('gpfLedBalanceOpening').value || '0',
                gpfLedBalanceCurrent: document.getElementById('gpfLedBalanceCurrent').value || '0',
                gpfAdvanceBalancePrevious: document.getElementById('gpfAdvanceBalancePrevious').value || '0',
                gpfAdvanceBalanceRecovery: document.getElementById('gpfAdvanceBalanceRecovery').value || '0',
                bankRecoveryLoan: document.getElementById('bankRecoveryLoan').value || '0',
                bankRecoveryPaid: document.getElementById('bankRecoveryPaid').value || '0',
                gicTotal: document.getElementById('gicTotal').value || '0',
                gicMonthly: document.getElementById('gicMonthly').value || '0',
                licTotal: document.getElementById('licTotal').value || '0',
                licMonthly: document.getElementById('licMonthly').value || '0',
                electricityBillTotal: document.getElementById('electricityBillTotal').value || '0',
                electricityBillMonthly: document.getElementById('electricityBillMonthly').value || '0',
                waterChargesTotal: document.getElementById('waterChargesTotal').value || '0',
                waterChargesMonthly: document.getElementById('waterChargesMonthly').value || '0',
                recoveryTotal: document.getElementById('recoveryTotal').value || '0',
                recoveryMonthly: document.getElementById('recoveryMonthly').value || '0',
                leaveDeductionsTotal: document.getElementById('leaveDeductionsTotal').value || '0',
                leaveDeductionsMonthly: document.getElementById('leaveDeductionsMonthly').value || '0',
                gppcSubscriptionTotal: document.getElementById('gppcSubscriptionTotal').value || '0',
                gppcSubscriptionMonthly: document.getElementById('gppcSubscriptionMonthly').value || '0',
                gpfExtraSubscriptionTotal: document.getElementById('gpfExtraSubscriptionTotal').value || '0',
                gpfExtraSubscriptionMonthly: document.getElementById('gpfExtraSubscriptionMonthly').value || '0',
                gpfGovernmentContributionTotal: document.getElementById('gpfGovernmentContributionTotal').value || '0',
                gpfGovernmentContributionMonthly: document.getElementById('gpfGovernmentContributionMonthly').value || '0',
                npsGovernmentContributionTotal: document.getElementById('npsGovernmentContributionTotal').value || '0',
                npsGovernmentContributionMonthly: document.getElementById('npsGovernmentContributionMonthly').value || '0',
                npsSelfContributionTotal: document.getElementById('npsSelfContributionTotal').value || '0',
                npsSelfContributionMonthly: document.getElementById('npsSelfContributionMonthly').value || '0',
                gpfWithdrawlTotal: document.getElementById('gpfWithdrawlTotal').value || '0',
                gpfWithdrawlMonthly: document.getElementById('gpfWithdrawlMonthly').value || '0',
                gpfInterestTotal: document.getElementById('gpfInterestTotal').value || '0',
                gpfInterestMonthly: document.getElementById('gpfInterestMonthly').value || '0',
                incomeTaxTotal: document.getElementById('incomeTaxTotal').value || '0',
                incomeTaxMonthly: document.getElementById('incomeTaxMonthly').value || '0',
                surChargesTotal: document.getElementById('surChargesTotal').value || '0',
                surChargesMonthly: document.getElementById('surChargesMonthly').value || '0',
                otherDeduction1Total: document.getElementById('otherDeduction1Total').value || '0',
                otherDeduction1Monthly: document.getElementById('otherDeduction1Monthly').value || '0',
                otherDeduction2Total: document.getElementById('otherDeduction2Total').value || '0',
                otherDeduction2Monthly: document.getElementById('otherDeduction2Monthly').value || '0',
                otherDeduction3Total: document.getElementById('otherDeduction3Total').value || '0',
                otherDeduction3Monthly: document.getElementById('otherDeduction3Monthly').value || '0',
                
                
                // Total and remarks
                totalMonthlyDeductions: updateTotalDeductions(),
                remarks: document.getElementById('deductionsRemarks').value || '',
                updatedAt: new Date().toISOString()
            };

            // Debug logging
            console.log('Saving deduction data for staff:', staffId);
            console.log('Deduction data being saved:', deductionData);
            
            // Save to storage
            staffDeductions[staffId] = deductionData;
            saveDeductionsToStorage();
            
            // Sync data to deduction_balances format for Balance Overview
            syncDeductionData();
            
            // Refresh Balance Overview if currently visible
            if (currentSection === 'deduction-balance') {
                loadDeductionBalanceData();
            }
            
            // Update user object with deductions data for details view
            const userIndex = users.findIndex(u => u.id == staffId);
            if (userIndex !== -1) {
                users[userIndex].deductions = deductionData;
                saveUsersToStorage();
            }
            
            // Refresh Pay Slip if currently visible
            refreshPaySlipIfVisible();
            
            // Refresh PS Verification if currently visible
            refreshPSVerificationIfVisible();
            
            // Update notification badge after saving deductions
            updateNotificationBadge();
            
            // Refresh details modal if it's currently open for this staff member
            refreshStaffDetailsIfOpen(staffId);

            showDeductionsSavedModal();
            closeModal('deductionsModal');
        }

        function saveDeductionsToStorage() {
            localStorage.setItem('cantonment_staff_deductions', JSON.stringify(staffDeductions));
        }

        function showDeductionsSavedModal() {
            console.log('Showing deductions saved modal...');
            openProfessionalModal('deductionsSavedModal');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeDeductionsSavedModal();
            }, 3000);
        }

        function closeDeductionsSavedModal() {
            closeProfessionalModal('deductionsSavedModal');
        }

        function showNomineePercentageErrorModal(currentTotal, attemptedPercentage) {
            console.log('Showing nominee percentage error modal...');
            // Update modal content with dynamic values
            const modal = document.getElementById('nomineePercentageErrorModal');
            const currentTotalSpan = modal.querySelector('.current-total');
            const attemptedPercentageSpan = modal.querySelector('.attempted-percentage');
            const errorTotalSpan = modal.querySelector('.error-total');
            const maxAllowedSpan = modal.querySelector('.max-allowed');
            
            const wouldTotal = currentTotal + attemptedPercentage;
            
            if (currentTotalSpan) currentTotalSpan.textContent = currentTotal + '%';
            if (attemptedPercentageSpan) attemptedPercentageSpan.textContent = attemptedPercentage + '%';
            if (errorTotalSpan) errorTotalSpan.textContent = wouldTotal + '%';
            if (maxAllowedSpan) maxAllowedSpan.textContent = (100 - currentTotal) + '%';
            
            openProfessionalModal('nomineePercentageErrorModal');
            
            // Auto-hide after 5 seconds (longer for error messages)
            setTimeout(() => {
                closeNomineePercentageErrorModal();
            }, 5000);
        }

        function closeNomineePercentageErrorModal() {
            closeProfessionalModal('nomineePercentageErrorModal');
        }

        function loadDeductionsFromStorage() {
            const saved = localStorage.getItem('cantonment_staff_deductions');
            if (saved) {
                staffDeductions = JSON.parse(saved);
            }
        }
        
        // Function to check if deduction should be applied based on balance
        function getMonthlyDeductionAmount(totalAdvance, monthlyDeduction, currentBalance) {
            // If balance is 0 or negative, no deduction can be made
            if (currentBalance <= 0) {
                return 0;
            }
            // If balance is less than monthly deduction, only deduct what's available
            if (currentBalance < monthlyDeduction) {
                return currentBalance;
            }
            // Otherwise, deduct the full monthly amount
            return monthlyDeduction;
        }
        
        // Function to update balances when payslip is generated
        function updateDeductionBalances(staffId, payslipMonth, payslipYear) {
            const deductions = staffDeductions[staffId];
            if (!deductions) return;
            
            // Create a key for tracking which months have been processed
            const processedKey = `deduction_processed_${staffId}_${payslipYear}_${payslipMonth}`;
            const alreadyProcessed = localStorage.getItem(processedKey);
            
            if (alreadyProcessed) {
                console.log(`Deductions already processed for ${staffId} for ${payslipMonth}/${payslipYear}`);
                return;
            }
            
            // Update each deduction balance
            const deductionFields = [
                'wheatAdvance', 'gic', 'lic', 'electricityBill', 'waterCharges',
                'recovery', 'leaveDeductions', 'gppcSubscription', 'gpfExtraSubscription',
                'gpfGovernmentContribution', 'gpfAdvanceRecovery', 'npsGovernmentContribution',
                'npsSelfContribution', 'gpfWithdrawl', 'gpfInterest', 'incomeTax',
                'surCharges', 'otherDeduction1', 'otherDeduction2', 'otherDeduction3',
                'gpfLedBalance', 'gpfAdvanceBalance', 'bankRecovery'
            ];
            
            deductionFields.forEach(field => {
                const balance = parseFloat(deductions[field]) || 0;
                const monthlyAmount = parseFloat(deductions[field + 'Monthly']) || 0;
                
                if (balance > 0 && monthlyAmount > 0) {
                    // Deduct monthly amount from balance
                    const newBalance = Math.max(0, balance - monthlyAmount);
                    deductions[field] = newBalance.toFixed(2);
                }
            });
            
            // Mark this month as processed
            localStorage.setItem(processedKey, 'true');
            
            // Save updated deductions
            staffDeductions[staffId] = deductions;
            saveDeductionsToStorage();
        }

        function saveDesignation(event) {
            event.preventDefault();
            
            // Validate form before proceeding
            if (!validateProfessionalForm('designationForm')) {
                return false;
            }
            
            const id = document.getElementById('designationId').value;
            const name = document.getElementById('designationNameInput').value.trim();
            
            // Validate designation name
            if (!name) {
                alert('Please enter a designation name.');
                return;
            }
            
            // Check if designation name already exists (excluding current record for edit)
            const existingDesignation = designations.find(d => 
                d.name.toLowerCase() === name.toLowerCase() && 
                d.id !== parseInt(id)
            );
            
            if (existingDesignation) {
                alert('A designation with this name already exists. Please choose a different name.');
                return;
            }
            
            if (id) {
                // Update existing
                const index = designations.findIndex(d => d.id === parseInt(id));
                if (index !== -1) {
                    const oldName = designations[index].name;
                    designations[index].name = name;
                    
                    // Update designation in admission records
                    admissions.forEach(admission => {
                        if (admission.designation === oldName) {
                            admission.designation = name;
                        }
                    });
                    
                    // Update designation dropdown in admission form
                    updateDesignationDropdown();
                    saveDesignationsToStorage();
                    saveAdmissionsToStorage();
                    
                    // Refresh Pay Slip if currently visible
                    refreshPaySlipIfVisible();
                }
            } else {
                // Add new
                const newId = Math.max(...designations.map(d => d.id), 0) + 1;
                designations.push({ id: newId, name: name });
                updateDesignationDropdown();
                saveDesignationsToStorage();
                
                // Store the new designation name for later selection
                window.newlyAddedDesignation = name;
            }
            
            closeProfessionalModal('designationModal');
            
            // Only navigate to designations page if we're actually on the designations management page
            // Check if we're currently viewing the designations section
            const currentNavItem = document.querySelector('#sidebar .nav-item.active');
            const isOnDesignationsPage = currentNavItem && 
                currentNavItem.querySelector('.nav-text').textContent.toLowerCase() === 'designations';
            
            if (isOnDesignationsPage) {
                // We're on the designations management page, so refresh it
                showDesignations();
            } else {
                // We're on another page (like staff management), so just refresh the current view
                // without navigating away from it
                const activeNavItem = document.querySelector('#sidebar .nav-item.active');
                if (activeNavItem) {
                    const navText = activeNavItem.querySelector('.nav-text').textContent.toLowerCase();
                    if (navText === 'dashboard') {
                        // If we're on the dashboard (staff management), refresh it
                        showSection('dashboard');
                    }
                }
                
                // Auto-select the newly added designation in the staff form
                if (window.newlyAddedDesignation) {
                    setTimeout(() => {
                        const designationSelect = document.getElementById('designation');
                        if (designationSelect) {
                            designationSelect.value = window.newlyAddedDesignation;
                            // Clear the temporary variable
                            delete window.newlyAddedDesignation;
                        }
                    }, 100);
                }
                
                // Show success message without navigation
                alert('Designation saved successfully!');
            }
        }

        function updateDesignationDropdown() {
            const designationSelect = document.getElementById('designation');
            if (designationSelect) {
                const currentValue = designationSelect.value;
                
                // Clear existing options except the first one
                designationSelect.innerHTML = '<option value="">Select Designation</option>';
                
                // Add all designations
                designations.forEach(designation => {
                    const option = document.createElement('option');
                    option.value = designation.name;
                    option.textContent = designation.name;
                    designationSelect.appendChild(option);
                });
                
                // Restore selected value if it still exists
                if (currentValue && designations.some(d => d.name === currentValue)) {
                    designationSelect.value = currentValue;
                }
            }
            
            // Also update the dashboard filter dropdown
            updateDashboardDesignationFilter();
        }

        function updateDashboardDesignationFilter() {
            const designationFilter = document.getElementById('designationFilter');
            if (designationFilter) {
                const currentValue = designationFilter.value;
                
                // Clear existing options except the first one
                designationFilter.innerHTML = '<option value="all">All Designations</option>';
                
                // Add all designations from the master list
                designations.sort((a, b) => a.name.localeCompare(b.name)).forEach(designation => {
                    const option = document.createElement('option');
                    option.value = designation.name;
                    option.textContent = designation.name;
                    designationFilter.appendChild(option);
                });
                
                // Restore selected value if it still exists
                if (currentValue && (currentValue === 'all' || designations.some(d => d.name === currentValue))) {
                    designationFilter.value = currentValue;
                } else {
                    designationFilter.value = 'all';
                }
                
                // Re-apply the current filter using the current filter value
                const currentFilterValue = designationFilter.value || 'all';
                filterByDesignation(currentFilterValue);
            }
        }

        function editAdmission(id) {
            if (!canEditSection('dashboard')) {
                alert("You don't have permission to edit staff information.");
                return;
            }
            console.log('editAdmission called with id:', id);
            // Validate the ID
            if (!id || id === 0) {
                alert('Invalid admission ID. Please refresh the page and try again.');
                return;
            }
            
            const admission = admissions.find(a => a.id === id);
            console.log('Found admission:', admission);
            if (admission) {
                openAdmissionModal(admission);
            } else {
                alert('Admission record not found. Please refresh the page and try again.');
            }
        }
        

        async function deleteAdmission(id) {
            // Check permissions first
            if (!canEditSection('dashboard')) {
                alert('You do not have permission to delete staff records. Edit permission is required.');
                return;
            }
            const admission = admissions.find(a => a.id === id);
            if (admission) {
                showDeleteModal('Staff Record', admission.staffName, id, async function(admissionId) {
                    try {
                        
                        // Make API call to delete from backend database (online mode)
                        const response = await fetch(`/api/admissions/${admissionId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            // Only update frontend after successful backend deletion
                            const staffToDelete = admissions.find(a => a.id === admissionId);
                            const staffId = staffToDelete?.staffId;
                            
                            // Remove from admissions array
                            admissions = admissions.filter(a => a.id !== admissionId);
                            localStorage.setItem('cantonment_admissions', JSON.stringify(admissions));
                            
                            // Clean up attendance records for this staff member
                            if (staffId) {
                                const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
                                const filteredRecords = savedAttendanceRecords.filter(record => record.staffId !== staffId);
                                localStorage.setItem('savedAttendanceRecords', JSON.stringify(filteredRecords));
                                
                                const deletedRecords = savedAttendanceRecords.length - filteredRecords.length;
                                console.log(`Cleaned up ${deletedRecords} attendance records for staff ${staffId}`);
                            }
                            
                            // Refresh Pay Slip if currently visible
                            refreshPaySlipIfVisible();
                            
                            showSection('dashboard'); // Refresh dashboard to show updated data
                            alert('Staff record and all associated attendance records deleted successfully from database!');
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.message || 'Failed to delete staff record');
                        }
                    } catch (error) {
                        console.error('Delete error:', error);
                        
                        // If it's a network error and we're running offline, fall back to localStorage deletion
                        if (error.message.includes('NetworkError') || error.message.includes('fetch')) {
                            console.log('Network error detected - falling back to offline delete');
                            const staffToDelete = admissions.find(a => a.id === admissionId);
                            const staffId = staffToDelete?.staffId;
                            
                            // Remove from admissions array
                            admissions = admissions.filter(a => a.id !== admissionId);
                            localStorage.setItem('cantonment_admissions', JSON.stringify(admissions));
                            
                            // Clean up attendance records for this staff member
                            if (staffId) {
                                const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
                                const filteredRecords = savedAttendanceRecords.filter(record => record.staffId !== staffId);
                                localStorage.setItem('savedAttendanceRecords', JSON.stringify(filteredRecords));
                                
                                const deletedRecords = savedAttendanceRecords.length - filteredRecords.length;
                                console.log(`Cleaned up ${deletedRecords} attendance records for staff ${staffId}`);
                            }
                            
                            // Refresh Pay Slip if currently visible
                            refreshPaySlipIfVisible();
                            
                            showSection('dashboard'); // Refresh dashboard to show updated data
                            alert('Staff record and all associated attendance records deleted successfully (offline fallback)!');
                        } else {
                            alert('Failed to delete staff record: ' + error.message);
                        }
                    }
                });
            }
        }

        function viewStaffDetails(id) {
            const admission = admissions.find(a => a.id === id);
            if (!admission) {
                console.error('Staff record not found');
                return;
            }

            const modal = document.getElementById('staffDetailsModal');
            const title = document.getElementById('staffDetailsModalTitle');
            const body = document.getElementById('staffDetailsModalBody');

            title.textContent = `Staff Details - ${admission.staffName || 'N/A'}`;

            body.innerHTML = `
                <!-- Basic Information -->
                <div class="details-section">
                    <div class="details-section-title">Basic Information</div>
                    <div style="display: grid; grid-template-columns: 1fr 200px; gap: 30px; align-items: start;">
                        <div class="details-grid">
                            <div class="details-item">
                                <div class="details-label">Staff ID No.</div>
                                <div class="details-value">${admission.staffId}</div>
                            </div>
                            <div class="details-item">
                                <div class="details-label">Designation</div>
                                <div class="details-value">${admission.designation}</div>
                            </div>
                            <div class="details-item">
                                <div class="details-label">Staff Name</div>
                                <div class="details-value">${admission.staffName}</div>
                            </div>
                        </div>
                        ${admission.photo ? `
                            <div class="photo-section">
                                <div class="details-section-title" style="margin-bottom: 15px; font-size: 14px;">Staff Photo</div>
                                <div class="photo-preview" style="border: 2px solid #1976d2;">
                                    <img data-src="${admission.photo}" alt="Staff Photo" class="lazy-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23f0f0f0'/%3E%3C/svg%3E">
                                </div>
                            </div>
                        ` : `
                            <div class="photo-section">
                                <div class="details-section-title" style="margin-bottom: 15px; font-size: 14px;">Staff Photo</div>
                                <div class="photo-preview">
                                    <div class="photo-placeholder">
                                        <span style="font-size: 48px;">üì∑</span>
                                        <div>No Photo</div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Personal Details -->
                <div class="details-section">
                    <div class="details-section-title">Personal Details</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Date of Birth</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfBirth)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Age</div>
                            <div class="details-value">${admission.age} years</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Sex</div>
                            <div class="details-value">${admission.sex}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Nationality</div>
                            <div class="details-value">${admission.nationality}</div>
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="details-section">
                    <div class="details-section-title">Family Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Father Name</div>
                            <div class="details-value">${admission.fatherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Mother Name</div>
                            <div class="details-value">${admission.motherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Grand Father Name</div>
                            <div class="details-value">${admission.grandFatherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Marital Status</div>
                            <div class="details-value">${admission.maritalStatus}</div>
                        </div>
                        ${admission.spouseName ? `
                            <div class="details-item">
                                <div class="details-label">Spouse Name</div>
                                <div class="details-value">${admission.spouseName}</div>
                            </div>
                        ` : ''}
                        ${admission.children && admission.children.length > 0 ? `
                            <div class="details-item" style="grid-column: 1 / -1;">
                                <div class="details-label">Children</div>
                                <div class="details-value">
                                    ${admission.children.map(child => `${child.name} (${child.gender}, ${child.age} years)`).join(', ')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Employment Information -->
                <div class="details-section">
                    <div class="details-section-title">Employment Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Date of Appointment</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfAppointment)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Retirement Date</div>
                            <div class="details-value">${formatDateToDisplay(admission.retirementDate)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Function Code</div>
                            <div class="details-value">${admission.functionCode}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Object Code</div>
                            <div class="details-value">${admission.objectCode}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Date of Next Increment</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfNextIncrement)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Pension Scheme</div>
                            <div class="details-value">${admission.pensionScheme}</div>
                        </div>
                    </div>
                </div>

                <!-- Contact & Documents -->
                <div class="details-section">
                    <div class="details-section-title">Contact & Documents</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Mobile Number</div>
                            <div class="details-value">${admission.mobileNumber}</div>
                        </div>
                        ${admission.aadharNumber ? `
                            <div class="details-item">
                                <div class="details-label">Aadhar Number</div>
                                <div class="details-value">${admission.aadharNumber}</div>
                            </div>
                        ` : ''}
                        ${admission.panNumber ? `
                            <div class="details-item">
                                <div class="details-label">PAN Number</div>
                                <div class="details-value">${admission.panNumber}</div>
                            </div>
                        ` : ''}
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Permanent Address</div>
                            <div class="details-value">${admission.permanentAddress}</div>
                        </div>
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Communication Address</div>
                            <div class="details-value">${admission.communicationAddress}</div>
                        </div>
                        ${admission.remarks ? `
                            <div class="details-item" style="grid-column: 1 / -1;">
                                <div class="details-label">Remarks</div>
                                <div class="details-value">${admission.remarks}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Bank Details -->
                ${admission.bankName || admission.accountNumber || admission.ifscCode || admission.micrCode ? `
                <div class="details-section">
                    <div class="details-section-title">Bank Details</div>
                    <div class="details-grid">
                        ${admission.bankName ? `
                            <div class="details-item">
                                <div class="details-label">Bank Name</div>
                                <div class="details-value">${admission.bankName}</div>
                            </div>
                        ` : ''}
                        ${admission.accountNumber ? `
                            <div class="details-item">
                                <div class="details-label">Account Number</div>
                                <div class="details-value">${admission.accountNumber}</div>
                            </div>
                        ` : ''}
                        ${admission.ifscCode ? `
                            <div class="details-item">
                                <div class="details-label">IFSC Code</div>
                                <div class="details-value">${admission.ifscCode}</div>
                            </div>
                        ` : ''}
                        ${admission.micrCode ? `
                            <div class="details-item">
                                <div class="details-label">MICR Code</div>
                                <div class="details-value">${admission.micrCode}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Salary Structure -->
                ${admission.basicPay || admission.gradePay || admission.payLevel || admission.payCell || admission.da || admission.hra || admission.specialPay || admission.specialAllowance || admission.otherAllowance ? `
                <div class="details-section">
                    <div class="details-section-title">üí∞ Salary Structure</div>
                    <div class="details-grid">
                        ${admission.basicPay ? `
                            <div class="details-item">
                                <div class="details-label">Pay Band</div>
                                <div class="details-value">${admission.basicPay}</div>
                            </div>
                        ` : ''}
                        ${admission.gradePay ? `
                            <div class="details-item">
                                <div class="details-label">Grade Pay</div>
                                <div class="details-value">‚Çπ${admission.gradePay}</div>
                            </div>
                        ` : ''}
                        ${admission.payLevel ? `
                            <div class="details-item">
                                <div class="details-label">Pay Level</div>
                                <div class="details-value">Level ${admission.payLevel}</div>
                            </div>
                        ` : ''}
                        ${admission.payCell ? `
                            <div class="details-item">
                                <div class="details-label">Pay Cell</div>
                                <div class="details-value">${admission.payCell}</div>
                            </div>
                        ` : ''}
                        ${admission.basicPayCalculated ? `
                            <div class="details-item">
                                <div class="details-label">Basic Pay</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.basicPayCalculated).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.da ? `
                            <div class="details-item">
                                <div class="details-label">DA (Dearness Allowance)</div>
                                <div class="details-value">${admission.da}%</div>
                            </div>
                        ` : ''}
                        ${admission.hra ? `
                            <div class="details-item">
                                <div class="details-label">HRA (House Rent Allowance)</div>
                                <div class="details-value">${admission.hra}%</div>
                            </div>
                        ` : ''}
                        ${admission.specialPay ? `
                            <div class="details-item">
                                <div class="details-label">Special Pay</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.specialPay).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.specialAllowance ? `
                            <div class="details-item">
                                <div class="details-label">Special Allowance</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.specialAllowance).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.otherAllowance ? `
                            <div class="details-item">
                                <div class="details-label">Other Allowance</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.otherAllowance).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.grossSalary ? `
                            <div class="details-item">
                                <div class="details-label">Gross Salary</div>
                                <div class="details-value" style="font-weight: 600; color: #1976d2;">‚Çπ${parseFloat(admission.grossSalary).toLocaleString()}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;

            modal.style.display = 'block';
        }

        function editDesignation(id) {
            const designation = designations.find(d => d.id === id);
            if (designation) {
                openDesignationModal(designation);
            }
        }


        function deleteDesignation(id) {
            // Check permissions first
            if (!canEditSection('designations')) {
                alert('You do not have permission to delete designations. Edit permission is required.');
                return;
            }
            
            const designation = designations.find(d => d.id === id);
            if (!designation) return;
            
            // Check if designation is being used in any admissions and collect details
            const usedInAdmissions = admissions.filter(admission => admission.designation === designation.name);
            
            if (usedInAdmissions.length > 0) {
                // Create usage list for the professional modal
                const usageList = usedInAdmissions.map(admission => ({
                    name: admission.staffName,
                    id: admission.staffId
                }));
                
                showCannotDeleteModal('Designation', designation.name, usageList, false);
                return;
            }
            
            showDeleteModal('Designation', designation.name, id, async function(desigId) {
                try {
                    // Make API call to delete from backend database
                    const response = await fetch(`/api/designations/${desigId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Only update frontend after successful backend deletion
                        designations = designations.filter(d => d.id !== desigId);
                        localStorage.setItem('cantonment_designations', JSON.stringify(designations));
                        updateDesignationDropdown();
                        showDesignations();
                        alert('Designation deleted successfully from database!');
                    } else {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to delete designation');
                    }
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Failed to delete designation: ' + error.message);
                }
            });
        }

        // Confirmation modal state
        let confirmModalState = {
            action: null,
            data: null
        };

        // Confirmation modal functions
        function showConfirmModal(title, message, icon, actionText, actionClass, callback, data = null) {
            // Close any existing modals first
            closeAllModals();
            
            const modal = document.getElementById('confirmModal');
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmModalIcon').textContent = icon;
            
            const actionBtn = document.getElementById('confirmModalAction');
            actionBtn.textContent = actionText;
            actionBtn.className = `confirm-btn ${actionClass}`;
            
            confirmModalState = { action: callback, data: data };
            openProfessionalModal('confirmModal');
        }

        function closeConfirmModal() {
            closeProfessionalModal('confirmModal');
            confirmModalState = { action: null, data: null };
        }

        function executeConfirmAction() {
            if (confirmModalState.action) {
                confirmModalState.action(confirmModalState.data);
            }
            closeConfirmModal();
        }
        
        // Professional Delete Modal Functions
        function showDeleteModal(itemType, itemName, itemId, deleteCallback) {
            console.log('showDeleteModal called:', itemType, itemName, itemId);
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('deleteModal');
            const itemValue = document.getElementById('deleteItemValue');
            
            console.log('Modal elements:', { overlay, modal, itemValue });
            
            if (!overlay || !modal || !itemValue) {
                console.error('Modal elements not found');
                // Fallback to old confirm dialog
                if (confirm(`Are you sure you want to delete ${itemType} "${itemName}"? This action cannot be undone.`)) {
                    deleteCallback(itemId);
                }
                return;
            }
            
            // Update item information
            itemValue.textContent = `${itemType} - ${itemName} (ID: ${itemId})`;
            
            // Store callback for later execution
            window.pendingDeleteAction = () => {
                deleteCallback(itemId);
                closeDeleteModal();
            };
            
            // Show modal
            overlay.classList.add('show');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        function closeDeleteModal() {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('deleteModal');
            
            modal.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                modal.style.display = 'none';
                window.pendingDeleteAction = null;
            }, 300);
        }
        
        function confirmDelete() {
            const modal = document.getElementById('deleteModal');
            modal.classList.add('modal-shake');
            
            setTimeout(() => {
                modal.classList.remove('modal-shake');
                if (window.pendingDeleteAction) {
                    window.pendingDeleteAction();
                }
            }, 300);
        }
        
        // Professional Save Modal Functions
        function showSaveModal(changes = []) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('saveModal');
            const changesList = document.getElementById('saveChangesList');
            
            // Generate changes list
            if (changes.length > 0) {
                const changesHtml = changes.map(change => `
                    <div class="change-item">
                        <span class="change-icon">‚úì</span>
                        <span>${change}</span>
                    </div>
                `).join('');
                
                changesList.innerHTML = `
                    <div class="save-changes-title">
                        <span>üìù</span>
                        <span>Modified Fields (${changes.length}):</span>
                    </div>
                    ${changesHtml}
                `;
            } else {
                changesList.innerHTML = `
                    <div class="save-changes-title">
                        <span>‚ÑπÔ∏è</span>
                        <span>No Changes Detected</span>
                    </div>
                    <div class="change-item">
                        <span class="change-icon">üìã</span>
                        <span>All fields have the same values as before</span>
                    </div>
                `;
            }
            
            // Update modal title and subtitle
            modal.querySelector('.save-modal-title').textContent = changes.length > 0 ? 'Save Changes?' : 'No Changes Found';
            modal.querySelector('.save-modal-subtitle').textContent = changes.length > 0 ? 
                `Review the ${changes.length} modified field(s) below and click Save to apply changes.` : 
                'No modifications were detected in the form fields.';
            
            // Show modal
            overlay.classList.add('show');
            modal.style.display = 'block';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        function closeSaveModal() {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('saveModal');
            
            modal.classList.remove('show');
            overlay.classList.remove('show');
            
            setTimeout(() => {
                modal.style.display = 'none';
                // Reset modal state
                modal.classList.remove('success');
                modal.querySelector('.save-icon').innerHTML = 'üíæ';
                modal.querySelector('.save-modal-title').textContent = 'Save Changes?';
                modal.querySelector('.save-modal-subtitle').textContent = 'You have unsaved changes. Would you like to save them before proceeding?';
            }, 300);
        }
        
        function confirmSave() {
            // Execute the save action immediately
            if (window.pendingSaveAction) {
                window.pendingSaveAction();
                // Clear the pending action
                window.pendingSaveAction = null;
                
                // Close all modals immediately
                closeSaveModal();
                closeModal('admissionModal');
                closeAllProfessionalModals();
                
                // Show the Changes Applied modal on dashboard
                showChangesAppliedModal();
                
                // Refresh the dashboard
                showSection('dashboard');
            } else if (window.pendingAdminSaveAction) {
                try {
                    window.pendingAdminSaveAction();
                    window.pendingAdminSaveAction = null;
                    
                    // Close the save modal
                    closeSaveModal();
                    
                    // Show admin success modal
                    setTimeout(() => {
                        showAdminChangesAppliedModal();
                    }, 300);
                } catch (error) {
                    console.error('Error saving user:', error);
                    alert('Error saving user: ' + error.message);
                }
            }
        }

        // Functions for Changes Applied Modal
        function showChangesAppliedModal() {
            const modal = document.getElementById('changesAppliedModal');
            modal.classList.add('show');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeChangesAppliedModal();
            }, 3000);
        }

        function closeChangesAppliedModal() {
            const modal = document.getElementById('changesAppliedModal');
            modal.classList.remove('show');
        }

        // Admin Professional Modal Functions

        function showAdminChangesAppliedModal() {
            openProfessionalModal('adminChangesAppliedModal');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeAdminChangesAppliedModal();
            }, 3000);
        }

        function closeAdminChangesAppliedModal() {
            closeProfessionalModal('adminChangesAppliedModal');
        }

        // User Creation Success Modal
        function showUserCreatedSuccessModal() {
            openProfessionalModal('userCreatedSuccessModal');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeUserCreatedSuccessModal();
            }, 3000);
        }

        function closeUserCreatedSuccessModal() {
            closeProfessionalModal('userCreatedSuccessModal');
        }

        // User Already Exists Modal
        function showUserAlreadyExistsModal() {
            openProfessionalModal('userAlreadyExistsModal');
        }

        function closeUserAlreadyExistsModal() {
            closeProfessionalModal('userAlreadyExistsModal');
        }

        // User Status Confirm Modal
        function showUserStatusConfirmModal(user, isActivating) {
            const modal = document.getElementById('userStatusConfirmModal');
            const title = document.getElementById('statusChangeTitle');
            const subtitle = document.getElementById('statusChangeSubtitle');
            const confirmBtn = document.getElementById('confirmStatusChangeBtn');
            
            if (isActivating) {
                title.textContent = 'Activate User?';
                subtitle.textContent = `Do you want to activate ${user.fullName}'s account?`;
                confirmBtn.textContent = 'Activate';
            } else {
                title.textContent = 'Deactivate User?';
                subtitle.textContent = `Do you want to deactivate ${user.fullName}'s account?`;
                confirmBtn.textContent = 'Deactivate';
            }
            
            openProfessionalModal('userStatusConfirmModal');
        }

        function closeUserStatusConfirmModal() {
            closeProfessionalModal('userStatusConfirmModal');
            window.pendingUserStatusChange = null;
        }

        function confirmUserStatusChange() {
            if (window.pendingUserStatusChange) {
                window.pendingUserStatusChange();
                window.pendingUserStatusChange = null;
            }
            closeUserStatusConfirmModal();
        }

        // User Status Changed Modal
        function showUserStatusChangedModal(isActivated) {
            const modal = document.getElementById('userStatusChangedModal');
            const title = document.getElementById('statusChangedTitle');
            const subtitle = document.getElementById('statusChangedSubtitle');
            const description = document.getElementById('statusChangedDescription');
            
            if (isActivated) {
                title.textContent = 'User Activated';
                subtitle.textContent = 'Successfully Activated';
                description.textContent = 'The user account has been activated and they can now log in to the system.';
            } else {
                title.textContent = 'User Deactivated';
                subtitle.textContent = 'Successfully Deactivated';
                description.textContent = 'The user account has been deactivated and they can no longer access the system.';
            }
            
            openProfessionalModal('userStatusChangedModal');
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                closeUserStatusChangedModal();
            }, 3000);
        }

        function closeUserStatusChangedModal() {
            closeProfessionalModal('userStatusChangedModal');
        }

        // Professional Cannot Delete Modal Functions
        function showCannotDeleteModal(itemType, itemName, usageList, isCode = false) {
            const modal = document.getElementById('cannotDeleteModal');
            const title = document.getElementById('cannotDeleteTitle');
            const subtitle = document.getElementById('cannotDeleteSubtitle');
            const usageListElement = document.getElementById('cannotDeleteUsageList');
            const instructionsElement = document.getElementById('cannotDeleteInstructionsList');
            
            // Set title and subtitle
            title.textContent = `Cannot Delete ${itemType}`;
            subtitle.textContent = `"${itemName}" is currently being used and cannot be deleted.`;
            
            // Populate usage list
            usageListElement.innerHTML = usageList.map(item => `
                <div class="usage-item">
                    <div class="usage-item-name">${item.name}</div>
                    <div class="usage-item-id">(${item.id})</div>
                    ${item.type ? `<div class="usage-item-type">${item.type}</div>` : ''}
                </div>
            `).join('');
            
            // Populate instructions
            const fieldName = isCode ? (itemType === 'Code' ? 'Function Code or Object Code' : itemType) : 'Designation';
            const instructions = [
                'Go to Staff Records tab',
                'Edit each staff member listed above',
                `Change their ${fieldName} to a different value`,
                `Then try deleting this ${itemType.toLowerCase()} again`
            ];
            
            instructionsElement.innerHTML = instructions.map((instruction, index) => `
                <div class="instruction-step">
                    <div class="step-number">${index + 1}</div>
                    <div class="step-text">${instruction}</div>
                </div>
            `).join('');
            
            // Show modal
            openProfessionalModal('cannotDeleteModal');
        }

        function closeCannotDeleteModal() {
            closeProfessionalModal('cannotDeleteModal');
        }

        // Payslip Validation Error Modal Functions
        function showPayslipValidationError(title, message) {
            // Create or update payslip validation error modal content
            const modalId = 'payslipValidationErrorModal';
            let modal = document.getElementById(modalId);
            
            if (!modal) {
                // Create the modal if it doesn't exist
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal';
                modal.style.cssText = 'display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);';
                
                // Add click outside to close functionality
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePayslipValidationError();
                    }
                });
                modal.innerHTML = `
                    <div class="modal-content professional-modal-content" style="max-width: 500px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); margin: 0; z-index: 10001;">
                        <div class="professional-modal-header" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                            <div class="professional-modal-header-content">
                                <div class="professional-modal-title" id="payslipErrorTitle">Payslip Generation Error</div>
                                <div class="professional-modal-subtitle">Invalid payslip date</div>
                            </div>
                        </div>
                        
                        <div class="professional-modal-body" style="padding: 30px; text-align: center;">
                            <div style="font-size: 48px; color: #f44336; margin-bottom: 20px;">‚ö†Ô∏è</div>
                            <h3 id="payslipErrorMessage" style="color: #333; margin-bottom: 15px; font-size: 18px;"></h3>
                            <p id="payslipErrorDetails" style="color: #666; line-height: 1.6; font-size: 14px;"></p>
                        </div>
                        
                        <div class="professional-modal-footer">
                            <button class="professional-btn professional-btn-primary" onclick="closePayslipValidationError()" style="background: #f44336; border-color: #f44336;">
                                <span class="professional-btn-text">Understood</span>
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            document.getElementById('payslipErrorMessage').textContent = title;
            document.getElementById('payslipErrorDetails').textContent = message;
            
            // Show modal with custom display logic
            modal.style.display = 'block';
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.opacity = '0';
                    modalContent.style.transform = 'translate(-50%, -50%) scale(0.7)';
                    modalContent.style.transition = 'all 0.3s ease';
                    setTimeout(() => {
                        modalContent.style.opacity = '1';
                        modalContent.style.transform = 'translate(-50%, -50%) scale(1)';
                    }, 10);
                }
            }, 10);
        }

        function closePayslipValidationError() {
            const modal = document.getElementById('payslipValidationErrorModal');
            if (modal) {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.transform = 'translate(-50%, -50%) scale(0.7)';
                    modalContent.style.opacity = '0';
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 300);
                } else {
                    modal.style.display = 'none';
                }
            }
        }

        function closeAllProfessionalModals() {
            // Close all possible modals
            const modals = ['designationModal', 'codeModal', 'admissionModal', 'saveModal', 'deleteModal', 'adminSaveModal', 'adminChangesAppliedModal', 'userCreatedSuccessModal', 'userAlreadyExistsModal', 'userStatusConfirmModal', 'userStatusChangedModal', 'cannotDeleteModal', 'addChildModal', 'pensionNomineeModal', 'deductionsModal', 'confirmModal', 'leaveApplicationModal', 'leaveTypesModal', 'leaveTypeEditModal', 'deductionsSavedModal', 'nomineePercentageErrorModal', 'payslipValidationErrorModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                    modal.style.display = 'none';
                }
            });
            
            // Close overlay
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.classList.remove('show');
            }
        }
        
        function discardChanges() {
            closeSaveModal();
            // Close the admission modal since user is discarding changes
            closeModal('admissionModal');
            if (window.pendingDiscardAction) {
                window.pendingDiscardAction();
            }
        }
        
        // Professional Modal Functions
        function openProfessionalModal(modalId) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById(modalId);
            
            if (overlay && modal) {
                overlay.classList.add('show');
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.classList.add('show');
                }, 10);
            }
        }
        
        function closeProfessionalModal(modalId) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById(modalId);
            
            if (modal) {
                modal.classList.remove('show');
                overlay.classList.remove('show');
                setTimeout(() => {
                    modal.style.display = 'none';
                    
                    // Clean up modal-specific scroll handlers for leave application modal
                    if (modalId === 'leaveApplicationModal') {
                        const leaveStartField = document.getElementById('leaveStartDate');
                        const leaveEndField = document.getElementById('leaveEndDate');
                        
                        [leaveStartField, leaveEndField].forEach(field => {
                            if (field && field._modalScrollHandlers) {
                                field._modalScrollHandlers.forEach(({ container, handler }) => {
                                    if (container) {
                                        container.removeEventListener('scroll', handler);
                                    }
                                });
                                field._modalScrollHandlers = [];
                            }
                        });
                    }
                    
                    // Reset form validation states
                    const inputs = modal.querySelectorAll('.professional-form-input, .professional-form-select, .form-control');
                    inputs.forEach(input => {
                        input.classList.remove('invalid', 'valid');
                    });
                }, 300);
            }
            
            if (overlay) {
                overlay.classList.remove('show');
            }
        }
        
        function validateProfessionalForm(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('.professional-form-input, .professional-form-select');
            let isValid = true;
            
            inputs.forEach(input => {
                if (input.hasAttribute('required')) {
                    if (!input.value.trim()) {
                        input.classList.add('invalid');
                        input.classList.remove('valid');
                        isValid = false;
                    } else {
                        input.classList.add('valid');
                        input.classList.remove('invalid');
                    }
                }
            });
            
            return isValid;
        }
        

        // Comprehensive data cleanup function
        function cleanupOrphanedRecords() {
            console.log('üßπ Starting comprehensive data cleanup...');
            
            // Get current active staff IDs
            const currentStaffIds = admissions.map(staff => staff.staffId).filter(id => id);
            console.log('Active staff IDs:', currentStaffIds);
            
            let totalCleaned = 0;
            
            // 1. Clean up attendance records
            const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
            const validAttendanceRecords = savedAttendanceRecords.filter(record => 
                currentStaffIds.includes(record.staffId)
            );
            const attendanceDeleted = savedAttendanceRecords.length - validAttendanceRecords.length;
            if (attendanceDeleted > 0) {
                localStorage.setItem('savedAttendanceRecords', JSON.stringify(validAttendanceRecords));
                console.log(`üóëÔ∏è Cleaned up ${attendanceDeleted} orphaned attendance records`);
                totalCleaned += attendanceDeleted;
            }
            
            // 2. Clean up leave applications
            const leaveApplications = JSON.parse(localStorage.getItem('leaveApplications') || '[]');
            const validLeaveApplications = leaveApplications.filter(leave => 
                admissions.some(staff => staff.id === leave.staffId)
            );
            const leaveDeleted = leaveApplications.length - validLeaveApplications.length;
            if (leaveDeleted > 0) {
                localStorage.setItem('leaveApplications', JSON.stringify(validLeaveApplications));
                console.log(`üóëÔ∏è Cleaned up ${leaveDeleted} orphaned leave applications`);
                totalCleaned += leaveDeleted;
            }
            
            // 3. Clean up payslip data
            const payslipData = JSON.parse(localStorage.getItem('payslipData') || '{}');
            let payslipCleaned = 0;
            for (let staffId in payslipData) {
                if (!currentStaffIds.includes(staffId)) {
                    delete payslipData[staffId];
                    payslipCleaned++;
                }
            }
            if (payslipCleaned > 0) {
                localStorage.setItem('payslipData', JSON.stringify(payslipData));
                console.log(`üóëÔ∏è Cleaned up ${payslipCleaned} orphaned payslip records`);
                totalCleaned += payslipCleaned;
            }
            
            // 4. Clean up historical payslips
            if (window.historicalPayslips) {
                let historicalCleaned = 0;
                for (let period in window.historicalPayslips) {
                    for (let staffId in window.historicalPayslips[period]) {
                        if (!currentStaffIds.includes(staffId)) {
                            delete window.historicalPayslips[period][staffId];
                            historicalCleaned++;
                        }
                    }
                }
                if (historicalCleaned > 0) {
                    console.log(`üóëÔ∏è Cleaned up ${historicalCleaned} orphaned historical payslip records`);
                    totalCleaned += historicalCleaned;
                }
            }
            
            // 5. Clean up leave balances
            const leaveBalances = JSON.parse(localStorage.getItem('leaveBalances') || '{}');
            let leaveBalancesCleaned = 0;
            for (let staffId in leaveBalances) {
                if (!admissions.some(staff => staff.id.toString() === staffId)) {
                    delete leaveBalances[staffId];
                    leaveBalancesCleaned++;
                }
            }
            if (leaveBalancesCleaned > 0) {
                localStorage.setItem('leaveBalances', JSON.stringify(leaveBalances));
                console.log(`üóëÔ∏è Cleaned up ${leaveBalancesCleaned} orphaned leave balance records`);
                totalCleaned += leaveBalancesCleaned;
            }
            
            // 6. Clean up any other staff-related data
            const otherKeys = [
                'staffDeductions',
                'staffAllowances', 
                'staffAttendanceRecords',
                'staffLeaveHistory',
                'staffDocuments'
            ];
            
            otherKeys.forEach(key => {
                const data = JSON.parse(localStorage.getItem(key) || '{}');
                let cleaned = 0;
                for (let staffId in data) {
                    if (!currentStaffIds.includes(staffId) && !admissions.some(staff => staff.id.toString() === staffId)) {
                        delete data[staffId];
                        cleaned++;
                    }
                }
                if (cleaned > 0) {
                    localStorage.setItem(key, JSON.stringify(data));
                    console.log(`üóëÔ∏è Cleaned up ${cleaned} orphaned ${key} records`);
                    totalCleaned += cleaned;
                }
            });
            
            console.log(`‚úÖ Cleanup complete! Total records cleaned: ${totalCleaned}`);
            
            if (totalCleaned > 0) {
                alert(`üßπ Data cleanup completed!\n\n${totalCleaned} orphaned records were removed from the system.\n\nThis includes old attendance, leave, payslip, and other staff-related data that was no longer needed.`);
            } else {
                alert('‚úÖ No cleanup needed - all data is current and valid!');
            }
        }
        
        // Auto-cleanup function to run on app startup
        function performStartupCleanup() {
            // Only run cleanup if there are active admissions
            if (admissions && admissions.length > 0) {
                console.log('üîß Performing startup data cleanup...');
                cleanupOrphanedRecords();
            }
        }

        // Better delete confirmation
        function confirmDeleteAdmission(id, name) {
            showConfirmModal(
                'Delete Admission',
                `Are you sure you want to delete the admission record for "${name}"? This action cannot be undone.`,
                'üóëÔ∏è',
                'Delete',
                'confirm-btn-danger',
                function(id) {
                    const staffToDelete = admissions.find(a => a.id === id);
                    const staffId = staffToDelete?.staffId;
                    
                    // Remove from admissions array
                    admissions = admissions.filter(a => a.id !== id);
                    
                    // Save to localStorage
                    saveAdmissionsToStorage();
                    
                    // Clean up attendance records for this staff member
                    if (staffId) {
                        const savedAttendanceRecords = JSON.parse(localStorage.getItem('savedAttendanceRecords') || '[]');
                        const filteredRecords = savedAttendanceRecords.filter(record => record.staffId !== staffId);
                        localStorage.setItem('savedAttendanceRecords', JSON.stringify(filteredRecords));
                        
                        const deletedRecords = savedAttendanceRecords.length - filteredRecords.length;
                        console.log(`Cleaned up ${deletedRecords} attendance records for staff ${staffId}`);
                    }
                    
                    // Refresh Pay Slip if currently visible
                    refreshPaySlipIfVisible();
                    
                    showSection('dashboard'); // Refresh dashboard to show updated data
                    alert('Staff record and all associated attendance records deleted successfully!');
                },
                id
            );
        }

        // Pending requests functionality
        function showPendingRequests() {
            currentSection = 'pending';
            showSection('pending');
        }

        function showPendingRequestsContent() {
            const content = document.getElementById('content');
            const pendingAdmissions = admissions.filter(a => a.status === 'pending');
            
            content.innerHTML = `
                <div class="section-header">
                    <h3>Pending Admission Requests (${pendingAdmissions.length} requests)</h3>
                    <button class="btn btn-secondary" onclick="showSection('dashboard')">‚Üê Back to Dashboard</button>
                </div>
                
                <div class="pending-requests-container" id="pendingRequestsContainer">
                    ${pendingAdmissions.length === 0 ? '<div class="loading">No pending requests found.</div>' : ''}
                </div>
            `;
            
            if (pendingAdmissions.length > 0) {
                const container = document.getElementById('pendingRequestsContainer');
                container.innerHTML = pendingAdmissions.map(admission => `
                    <div class="pending-card" onclick="showAdmissionDetails(${admission.id})" style="cursor: pointer;">
                        <div class="pending-card-header">
                            <div class="pending-card-title" style="display: flex; align-items: center; gap: 10px;">
                                ${admission.photo ? 
                                    `<img data-src="${admission.photo}" alt="Staff Photo" class="staff-photo lazy-image" data-admission-id="${admission.id}" data-action="photo-pending" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect width='40' height='40' fill='%23f0f0f0'/%3E%3C/svg%3E">` : 
                                    `<div class="staff-photo-placeholder">üë§</div>`
                                }
                                <span>${admission.staffName || 'N/A'}</span>
                            </div>
                            <div class="pending-card-id">ID: ${admission.staffId || 'N/A'}</div>
                        </div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 10px;">
                            <strong>Designation:</strong> ${admission.designation || 'N/A'}<br>
                            <strong>Mobile:</strong> ${admission.mobileNumber || 'N/A'}<br>
                            <strong>Date of Appointment:</strong> ${formatDateToDisplay(admission.dateOfAppointment) || 'N/A'}<br>
                            <small style="color: #999; font-style: italic;">Click to view full details</small>
                        </div>
                        <div class="pending-card-actions" onclick="event.stopPropagation()">
                            <button class="action-btn action-btn-view" onclick="showAdmissionDetails(${admission.id})">
                                üëÅÔ∏è View Details
                            </button>
                            <button class="action-btn action-btn-approve" onclick="confirmApprove(${admission.id}, '${admission.staffName}')">
                                ‚úì Approve
                            </button>
                            <button class="action-btn action-btn-decline" onclick="showDeclineModal(${admission.id}, '${admission.staffName}')">
                                ‚úó Decline
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Add event listener for pending requests photo clicks
                container.removeEventListener('click', handlePendingClick);
                container.addEventListener('click', handlePendingClick);
                
                // Initialize lazy loading for newly added images
                window.lazyLoader.observe();
            }
        }
        
        function handlePendingClick(event) {
            const photo = event.target.closest('img[data-action="photo-pending"]');
            if (photo) {
                event.stopPropagation(); // Prevent the card click
                const admissionId = parseInt(photo.getAttribute('data-admission-id'));
                openPhotoModalById(admissionId);
                return;
            }
        }

        // Approval/Decline functionality
        function confirmApprove(id, name) {
            showConfirmModal(
                'Approve Request',
                `Are you sure you want to approve the admission request for "${name}"?`,
                '‚úÖ',
                'Approve',
                'confirm-btn-success',
                function(id) {
                    const admission = admissions.find(a => a.id === id);
                    if (admission) {
                        admission.status = 'approved';
                        admission.approvedDate = new Date().toISOString();
                        showPendingRequestsContent();
                        alert('Request approved successfully!');
                    }
                },
                id
            );
        }

        let currentDeclineId = null;

        function showDeclineModal(id, name) {
            currentDeclineId = id;
            const modal = document.getElementById('remarksModal');
            document.getElementById('declineRemarks').value = '';
            modal.style.display = 'block';
            document.getElementById('declineRemarks').focus();
        }

        function closeRemarksModal() {
            document.getElementById('remarksModal').style.display = 'none';
            currentDeclineId = null;
        }

        function confirmDecline() {
            if (currentDeclineId) {
                const remarks = document.getElementById('declineRemarks').value.trim();
                const admission = admissions.find(a => a.id === currentDeclineId);
                
                if (admission) {
                    admission.status = 'rejected';
                    admission.declineReason = remarks || 'No reason provided';
                    admission.declinedDate = new Date().toISOString();
                    
                    closeRemarksModal();
                    showPendingRequestsContent();
                    alert('Request declined successfully!');
                }
            }
        }

        // Details Modal Functions
        function showAdmissionDetails(id) {
            const admission = admissions.find(a => a.id === id);
            if (!admission) return;
            
            const modal = document.getElementById('detailsModal');
            const title = document.getElementById('detailsModalTitle');
            const body = document.getElementById('detailsModalBody');
            
            title.textContent = `Admission Details - ${admission.staffName || 'N/A'}`;
            
            body.innerHTML = `
                <!-- Basic Information -->
                <div class="details-section">
                    <div class="details-section-title">Basic Information</div>
                    <div style="display: grid; grid-template-columns: 1fr 200px; gap: 30px; align-items: start;">
                        <div class="details-grid">
                            <div class="details-item">
                                <div class="details-label">Staff ID No.</div>
                                <div class="details-value">${admission.staffId}</div>
                            </div>
                            <div class="details-item">
                                <div class="details-label">Designation</div>
                                <div class="details-value">${admission.designation}</div>
                            </div>
                            <div class="details-item">
                                <div class="details-label">Staff Name</div>
                                <div class="details-value">${admission.staffName}</div>
                            </div>
                        </div>
                        ${admission.photo ? `
                            <div class="photo-section">
                                <div class="details-section-title" style="margin-bottom: 15px; font-size: 14px;">Staff Photo</div>
                                <div class="photo-preview" style="border: 2px solid #1976d2;">
                                    <img data-src="${admission.photo}" alt="Staff Photo" class="lazy-image" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect width='200' height='200' fill='%23f0f0f0'/%3E%3C/svg%3E">
                                </div>
                            </div>
                        ` : `
                            <div class="photo-section">
                                <div class="details-section-title" style="margin-bottom: 15px; font-size: 14px;">Staff Photo</div>
                                <div class="photo-preview">
                                    <div class="photo-placeholder">
                                        <span style="font-size: 48px;">üì∑</span>
                                        <div>No Photo</div>
                                    </div>
                                </div>
                            </div>
                        `}
                    </div>
                </div>

                <!-- Personal Details -->
                <div class="details-section">
                    <div class="details-section-title">Personal Details</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Date of Birth</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfBirth)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Age</div>
                            <div class="details-value">${admission.age} years</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Sex</div>
                            <div class="details-value">${admission.sex}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Nationality</div>
                            <div class="details-value">${admission.nationality}</div>
                        </div>
                    </div>
                </div>

                <!-- Family Information -->
                <div class="details-section">
                    <div class="details-section-title">Family Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Father Name</div>
                            <div class="details-value">${admission.fatherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Mother Name</div>
                            <div class="details-value">${admission.motherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Grand Father Name</div>
                            <div class="details-value">${admission.grandFatherName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Marital Status</div>
                            <div class="details-value">${admission.maritalStatus}</div>
                        </div>
                        ${admission.spouseName ? `
                            <div class="details-item">
                                <div class="details-label">Spouse Name</div>
                                <div class="details-value">${admission.spouseName}</div>
                            </div>
                        ` : ''}
                        ${admission.children && admission.children.length > 0 ? `
                            <div class="details-item" style="grid-column: 1 / -1;">
                                <div class="details-label">Children</div>
                                <div class="details-value">
                                    ${admission.children.map(child => `${child.name} (${child.gender}, ${child.age} years)`).join(', ')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Employment Information -->
                <div class="details-section">
                    <div class="details-section-title">Employment Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Date of Appointment</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfAppointment)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Retirement Date</div>
                            <div class="details-value">${formatDateToDisplay(admission.retirementDate)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Function Code</div>
                            <div class="details-value">${admission.functionCode}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Object Code</div>
                            <div class="details-value">${admission.objectCode}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Date of Next Increment</div>
                            <div class="details-value">${formatDateToDisplay(admission.dateOfNextIncrement)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Pension Scheme</div>
                            <div class="details-value">${admission.pensionScheme}</div>
                        </div>
                    </div>
                </div>

                <!-- Contact & Documents -->
                <div class="details-section">
                    <div class="details-section-title">Contact & Documents</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Mobile Number</div>
                            <div class="details-value">${admission.mobileNumber}</div>
                        </div>
                        ${admission.aadharNumber ? `
                            <div class="details-item">
                                <div class="details-label">Aadhar Number</div>
                                <div class="details-value">${admission.aadharNumber}</div>
                            </div>
                        ` : ''}
                        ${admission.panNumber ? `
                            <div class="details-item">
                                <div class="details-label">PAN Number</div>
                                <div class="details-value">${admission.panNumber}</div>
                            </div>
                        ` : ''}
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Permanent Address</div>
                            <div class="details-value">${admission.permanentAddress}</div>
                        </div>
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Communication Address</div>
                            <div class="details-value">${admission.communicationAddress}</div>
                        </div>
                        ${admission.remarks ? `
                            <div class="details-item" style="grid-column: 1 / -1;">
                                <div class="details-label">Remarks</div>
                                <div class="details-value">${admission.remarks}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Bank Details -->
                ${admission.bankName || admission.accountNumber || admission.ifscCode || admission.micrCode ? `
                <div class="details-section">
                    <div class="details-section-title">Bank Details</div>
                    <div class="details-grid">
                        ${admission.bankName ? `
                            <div class="details-item">
                                <div class="details-label">Bank Name</div>
                                <div class="details-value">${admission.bankName}</div>
                            </div>
                        ` : ''}
                        ${admission.accountNumber ? `
                            <div class="details-item">
                                <div class="details-label">Account Number</div>
                                <div class="details-value">${admission.accountNumber}</div>
                            </div>
                        ` : ''}
                        ${admission.ifscCode ? `
                            <div class="details-item">
                                <div class="details-label">IFSC Code</div>
                                <div class="details-value">${admission.ifscCode}</div>
                            </div>
                        ` : ''}
                        ${admission.micrCode ? `
                            <div class="details-item">
                                <div class="details-label">MICR Code</div>
                                <div class="details-value">${admission.micrCode}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Salary Structure -->
                ${admission.basicPay || admission.gradePay || admission.payLevel || admission.payCell || admission.da || admission.hra || admission.specialPay || admission.specialAllowance || admission.otherAllowance ? `
                <div class="details-section">
                    <div class="details-section-title">üí∞ Salary Structure</div>
                    <div class="details-grid">
                        ${admission.basicPay ? `
                            <div class="details-item">
                                <div class="details-label">Pay Band</div>
                                <div class="details-value">${admission.basicPay}</div>
                            </div>
                        ` : ''}
                        ${admission.gradePay ? `
                            <div class="details-item">
                                <div class="details-label">Grade Pay</div>
                                <div class="details-value">‚Çπ${admission.gradePay}</div>
                            </div>
                        ` : ''}
                        ${admission.payLevel ? `
                            <div class="details-item">
                                <div class="details-label">Pay Level</div>
                                <div class="details-value">Level ${admission.payLevel}</div>
                            </div>
                        ` : ''}
                        ${admission.payCell ? `
                            <div class="details-item">
                                <div class="details-label">Pay Cell</div>
                                <div class="details-value">${admission.payCell}</div>
                            </div>
                        ` : ''}
                        ${admission.basicPayCalculated ? `
                            <div class="details-item">
                                <div class="details-label">Basic Pay</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.basicPayCalculated).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.da ? `
                            <div class="details-item">
                                <div class="details-label">DA (Dearness Allowance)</div>
                                <div class="details-value">${admission.da}%</div>
                            </div>
                        ` : ''}
                        ${admission.hra ? `
                            <div class="details-item">
                                <div class="details-label">HRA (House Rent Allowance)</div>
                                <div class="details-value">${admission.hra}%</div>
                            </div>
                        ` : ''}
                        ${admission.specialPay ? `
                            <div class="details-item">
                                <div class="details-label">Special Pay</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.specialPay).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.specialAllowance ? `
                            <div class="details-item">
                                <div class="details-label">Special Allowance</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.specialAllowance).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${admission.otherAllowance ? `
                            <div class="details-item">
                                <div class="details-label">Other Allowance</div>
                                <div class="details-value">‚Çπ${parseFloat(admission.otherAllowance).toLocaleString()}</div>
                            </div>
                        ` : ''}
                        ${(function() {
                            // Calculate gross salary same way as PS Verification for consistency
                            const basicSalary = parseFloat(admission.basicPayCalculated) || 0;
                            const daPercentage = parseFloat(admission.da) || 0;
                            const hraPercentage = parseFloat(admission.hra) || 0;
                            const daAmount = (basicSalary * daPercentage) / 100;
                            const hraAmount = (basicSalary * hraPercentage) / 100;
                            const specialPay = parseFloat(admission.specialPay) || 0;
                            const specialAllowance = parseFloat(admission.specialAllowance) || 0;
                            const otherAllowance = parseFloat(admission.otherAllowance) || 0;
                            const calculatedGrossSalary = basicSalary + daAmount + hraAmount + specialPay + specialAllowance + otherAllowance;
                            
                            if (calculatedGrossSalary > 0) {
                                return `
                                <div class="details-item">
                                    <div class="details-label">Gross Salary (Calculated)</div>
                                    <div class="details-value" style="font-weight: 600; color: #1976d2;">‚Çπ${calculatedGrossSalary.toLocaleString()}</div>
                                </div>
                                <div class="details-item" style="opacity: 0.7;">
                                    <div class="details-label">Calculation</div>
                                    <div class="details-value" style="font-size: 12px; color: #666;">
                                        Basic: ‚Çπ${basicSalary.toLocaleString()} + DA: ‚Çπ${daAmount.toLocaleString()} + HRA: ‚Çπ${hraAmount.toLocaleString()}${specialPay > 0 ? ` + Special Pay: ‚Çπ${specialPay.toLocaleString()}` : ''}${specialAllowance > 0 ? ` + Special Allowance: ‚Çπ${specialAllowance.toLocaleString()}` : ''}${otherAllowance > 0 ? ` + Other: ‚Çπ${otherAllowance.toLocaleString()}` : ''}
                                    </div>
                                </div>`;
                            }
                            return '';
                        })()}
                    </div>
                </div>
                ` : ''}

                ${admission.status === 'pending' ? `
                    <div class="details-actions">
                        <button class="confirm-btn confirm-btn-success" onclick="confirmApprove(${admission.id}, '${admission.staffName}'); closeDetailsModal();">
                            ‚úì Approve Request
                        </button>
                        <button class="confirm-btn confirm-btn-danger" onclick="showDeclineModal(${admission.id}, '${admission.staffName}'); closeDetailsModal();">
                            ‚úó Decline Request
                        </button>
                    </div>
                ` : ''}
            `;
            
            modal.style.display = 'block';
            
            // Initialize lazy loading for newly added images
            window.lazyLoader.observe();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        function viewUserDetails(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) {
                console.error('User not found');
                return;
            }

            const modal = document.getElementById('staffDetailsModal');
            const title = document.getElementById('staffDetailsModalTitle');
            const body = document.getElementById('staffDetailsModalBody');

            title.textContent = `${user.fullName} - Complete Profile`;

            // Get gradient for user
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #f77062 0%, #fe5196 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ffd89b 0%, #19547b 100%)',
                'linear-gradient(135deg, #c471ed 0%, #f64f59 100%)'
            ];
            const userIndex = users.findIndex(u => u.id === userId);
            const gradient = gradients[userIndex % gradients.length];
            const userInitials = user.fullName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

            body.innerHTML = `
                <!-- Photo Section -->
                <div class="staff-photo-section">
                    ${user.profilePhoto ? 
                        `<img src="${user.profilePhoto}" alt="${user.fullName}" class="staff-photo-large">` :
                        `<div class="staff-initials-large" style="background: ${gradient};">${userInitials}</div>`
                    }
                    <h3 style="margin: 0; color: #1976d2;">${user.fullName}</h3>
                    <p style="margin: 5px 0 0; color: #666;">${user.designation || 'No designation assigned'}</p>
                </div>

                <!-- Account Information -->
                <div class="details-section">
                    <div class="details-section-title">Account Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Full Name</div>
                            <div class="details-value">${user.fullName}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Username</div>
                            <div class="details-value">${user.username}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Email</div>
                            <div class="details-value">${user.email || 'Not provided'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="account-status ${user.status === 'active' ? 'status-active' : 'status-inactive'}">
                                    ${user.status === 'active' ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Details -->
                ${user.dateOfBirth || user.age || user.gender || user.fatherName || user.motherName || user.grandFatherName ? `
                <div class="details-section">
                    <div class="details-section-title">Personal Details</div>
                    <div class="details-grid">
                        ${user.dateOfBirth ? `
                            <div class="details-item">
                                <div class="details-label">Date of Birth</div>
                                <div class="details-value">${user.dateOfBirth}</div>
                            </div>
                        ` : ''}
                        ${user.age ? `
                            <div class="details-item">
                                <div class="details-label">Age</div>
                                <div class="details-value">${user.age} years</div>
                            </div>
                        ` : ''}
                        ${user.gender ? `
                            <div class="details-item">
                                <div class="details-label">Gender</div>
                                <div class="details-value">${user.gender}</div>
                            </div>
                        ` : ''}
                        ${user.fatherName ? `
                            <div class="details-item">
                                <div class="details-label">Father's Name</div>
                                <div class="details-value">${user.fatherName}</div>
                            </div>
                        ` : ''}
                        ${user.motherName ? `
                            <div class="details-item">
                                <div class="details-label">Mother's Name</div>
                                <div class="details-value">${user.motherName}</div>
                            </div>
                        ` : ''}
                        ${user.grandFatherName ? `
                            <div class="details-item">
                                <div class="details-label">Grand Father's Name</div>
                                <div class="details-value">${user.grandFatherName}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Contact Information -->
                ${user.address || user.mobile ? `
                <div class="details-section">
                    <div class="details-section-title">Contact Information</div>
                    <div class="details-grid">
                        ${user.address ? `
                            <div class="details-item">
                                <div class="details-label">Address</div>
                                <div class="details-value">${user.address}</div>
                            </div>
                        ` : ''}
                        ${user.mobile ? `
                            <div class="details-item">
                                <div class="details-label">Mobile Number</div>
                                <div class="details-value">${user.mobile}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Professional Details -->
                ${user.designation || user.appointmentDate ? `
                <div class="details-section">
                    <div class="details-section-title">Professional Details</div>
                    <div class="details-grid">
                        ${user.designation ? `
                            <div class="details-item">
                                <div class="details-label">Designation</div>
                                <div class="details-value">${user.designation}</div>
                            </div>
                        ` : ''}
                        ${user.appointmentDate ? `
                            <div class="details-item">
                                <div class="details-label">Appointment Date</div>
                                <div class="details-value">${user.appointmentDate}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- Identity Documents -->
                ${user.aadharNumber || user.panNumber ? `
                <div class="details-section">
                    <div class="details-section-title">Identity Documents</div>
                    <div class="details-grid">
                        ${user.aadharNumber ? `
                            <div class="details-item">
                                <div class="details-label">Aadhar Number</div>
                                <div class="details-value">${user.aadharNumber}</div>
                            </div>
                        ` : ''}
                        ${user.panNumber ? `
                            <div class="details-item">
                                <div class="details-label">PAN Number</div>
                                <div class="details-value">${user.panNumber}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}

                <!-- System Information -->
                ${user.createdAt ? `
                <div class="details-section">
                    <div class="details-section-title">System Information</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Account Created</div>
                            <div class="details-value">${user.createdAt}</div>
                        </div>
                    </div>
                </div>
                ` : ''}
            `;

            modal.style.display = 'block';
            
            // Initialize lazy loading for newly added images
            window.lazyLoader.observe();
        }

        function closeStaffDetailsModal() {
            document.getElementById('staffDetailsModal').style.display = 'none';
        }

        function refreshStaffDetailsIfOpen(userId) {
            const modal = document.getElementById('staffDetailsModal');
            // Check if the staff details modal is currently open
            if (modal && modal.style.display === 'block') {
                // Extract the user ID from the modal title or use a stored variable
                const title = document.getElementById('staffDetailsModalTitle');
                if (title && title.textContent.includes('-')) {
                    // If the modal is open and it's for the same user that was just updated, refresh it
                    if (userId) {
                        const user = users.find(u => u.id === parseInt(userId));
                        if (user && title.textContent.startsWith(user.fullName)) {
                            // Refresh the details modal content
                            viewUserDetails(parseInt(userId));
                        }
                    }
                }
            }
        }

        // Photo Upload and Camera Functions
        let currentPhotoData = null;
        let cameraStream = null;

        function openFileUpload() {
            document.getElementById('photoInput').click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        displayPhoto(e.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    alert('Please select a valid image file.');
                }
            }
        }

        function displayPhoto(imageSrc) {
            currentPhotoData = imageSrc;
            const preview = document.getElementById('photoPreview');
            const placeholder = document.getElementById('photoPlaceholder');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            preview.innerHTML = `<img src="${imageSrc}" alt="Staff Photo">`;
            removeBtn.style.display = 'flex';
        }

        function removePhoto() {
            currentPhotoData = null;
            const preview = document.getElementById('photoPreview');
            const placeholder = document.getElementById('photoPlaceholder');
            const removeBtn = document.getElementById('removePhotoBtn');
            
            preview.innerHTML = `
                <div class="photo-placeholder" id="photoPlaceholder">
                    <span style="font-size: 48px;">üì∑</span>
                    <div>Upload Photo</div>
                </div>
            `;
            removeBtn.style.display = 'none';
            
            // Clear file input
            document.getElementById('photoInput').value = '';
        }

        async function openCamera() {
            try {
                const modal = document.getElementById('cameraModal');
                const video = document.getElementById('cameraVideo');
                
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } 
                });
                
                video.srcObject = cameraStream;
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Unable to access camera. Please check your permissions or use file upload instead.');
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw the video frame to canvas
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to data URL
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Display the captured photo
            displayPhoto(imageData);
            
            // Close camera modal
            closeCameraModal();
        }

        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('cameraVideo');
            
            // Stop camera stream
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.style.display = 'none';
        }

        // Document Upload Functions
        let uploadedDocuments = [];

        function openDocumentUpload() {
            document.getElementById('documentInput').click();
        }

        function handleDocumentUpload(event) {
            const files = Array.from(event.target.files);
            processDocuments(files);
        }

        function handleDocumentDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = document.getElementById('documentUploadArea');
            uploadArea.classList.remove('drag-over');
            
            const files = Array.from(event.dataTransfer.files);
            processDocuments(files);
        }

        function handleDocumentDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = document.getElementById('documentUploadArea');
            uploadArea.classList.add('drag-over');
        }

        function handleDocumentDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = document.getElementById('documentUploadArea');
            uploadArea.classList.remove('drag-over');
        }

        function processDocuments(files) {
            const maxSize = 10 * 1024 * 1024; // 10MB
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png', 'image/gif', 'text/plain'];
            
            files.forEach(file => {
                // Check file size
                if (file.size > maxSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
                
                // Check file type
                if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|doc|docx|jpg|jpeg|png|gif|txt)$/i)) {
                    alert(`File "${file.name}" is not a supported format.`);
                    return;
                }
                
                // Check if file already exists
                if (uploadedDocuments.some(doc => doc.name === file.name && doc.size === file.size)) {
                    alert(`File "${file.name}" has already been uploaded.`);
                    return;
                }
                
                // Convert file to base64 for storage
                const reader = new FileReader();
                reader.onload = function(e) {
                    const document = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        data: e.target.result,
                        uploadDate: new Date().toISOString()
                    };
                    
                    uploadedDocuments.push(document);
                    updateDocumentDisplay();
                };
                reader.readAsDataURL(file);
            });
            
            // Clear input
            document.getElementById('documentInput').value = '';
        }

        function updateDocumentDisplay() {
            const documentList = document.getElementById('documentList');
            const documentCount = document.getElementById('documentCount');
            
            if (uploadedDocuments.length === 0) {
                documentList.style.display = 'none';
                documentCount.textContent = '';
                return;
            }
            
            documentList.style.display = 'block';
            documentCount.textContent = `${uploadedDocuments.length} document(s) uploaded`;
            
            // Clear existing content first
            documentList.innerHTML = '';
            
            // Create document items
            uploadedDocuments.forEach(doc => {
                const documentItem = document.createElement('div');
                documentItem.className = 'document-item';
                
                documentItem.innerHTML = `
                    <div class="document-info">
                        <div class="document-icon">${getDocumentIcon(doc.name, doc.type)}</div>
                        <div class="document-details">
                            <div class="document-name">${doc.name}</div>
                            <div class="document-size">${formatFileSize(doc.size)}</div>
                        </div>
                    </div>
                    <div class="document-actions">
                        <button type="button" class="doc-btn doc-btn-download" title="Download Document" data-doc-id="${doc.id}">
                            üíæ Download
                        </button>
                        <button type="button" class="doc-btn doc-btn-remove" title="Remove Document" data-doc-id="${doc.id}">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                `;
                
                // Add event listeners
                const downloadBtn = documentItem.querySelector('.doc-btn-download');
                const removeBtn = documentItem.querySelector('.doc-btn-remove');
                
                downloadBtn.addEventListener('click', () => {
                    console.log('Download button clicked for document:', doc.id);
                    downloadDocument(doc.id);
                });
                
                removeBtn.addEventListener('click', () => {
                    console.log('Remove button clicked for document:', doc.id);
                    removeDocument(doc.id);
                });
                
                documentList.appendChild(documentItem);
            });
        }

        function getDocumentIcon(filename, type) {
            const extension = filename.split('.').pop().toLowerCase();
            
            switch (extension) {
                case 'pdf': return 'üìÑ';
                case 'doc':
                case 'docx': return 'üìù';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif': return 'üñºÔ∏è';
                case 'txt': return 'üìÉ';
                default: return 'üìé';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function downloadDocument(documentId) {
            console.log('Attempting to download document with ID:', documentId);
            console.log('Available documents:', uploadedDocuments);
            
            const docData = uploadedDocuments.find(doc => doc.id == documentId);
            if (!docData) {
                alert('Document not found!');
                return;
            }
            
            try {
                // Create download link
                const link = document.createElement('a');
                link.href = docData.data;
                link.download = docData.name; // This preserves the original filename and extension
                
                // Add to DOM temporarily
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                document.body.removeChild(link);
                
                console.log(`Document '${document.name}' download initiated`);
                
            } catch (error) {
                console.error('Error downloading document:', error);
                alert('Unable to download document. Please try again.');
            }
        }

        function removeDocument(documentId) {
            uploadedDocuments = uploadedDocuments.filter(doc => doc.id != documentId);
            updateDocumentDisplay();
        }

        function clearAllDocuments() {
            uploadedDocuments = [];
            updateDocumentDisplay();
        }

        function downloadDocumentFromDetails(documentId, admissionId) {
            const admission = admissions.find(a => a.id == admissionId);
            if (!admission || !admission.documents) {
                alert('Document not found!');
                return;
            }
            
            const docData = admission.documents.find(doc => doc.id == documentId);
            if (!docData) {
                alert('Document not found!');
                return;
            }
            
            try {
                // Create download link
                const link = document.createElement('a');
                link.href = docData.data;
                link.download = docData.name; // This preserves the original filename and extension
                
                // Add to DOM temporarily
                document.body.appendChild(link);
                
                // Trigger download
                link.click();
                
                // Clean up
                document.body.removeChild(link);
                
                console.log(`Document '${document.name}' download initiated from details`);
                
            } catch (error) {
                console.error('Error downloading document:', error);
                alert('Unable to download document. Please try again.');
            }
        }

        // Custom modal state
        let customModalData = {
            type: '',
            callback: null,
            validation: null
        };

        // Custom modal functions
        function showCustomModal(title, placeholder, type, callback, validation) {
            // Don't close all modals - we want to keep the staff modal open
            // Only close other custom modals if any are open
            const existingCustomModal = document.getElementById('customModal');
            if (existingCustomModal && existingCustomModal.style.display === 'block') {
                existingCustomModal.style.display = 'none';
            }
            
            const modal = document.getElementById('customModal');
            const titleEl = document.getElementById('customModalTitle');
            const inputEl = document.getElementById('customModalInput');
            const errorEl = document.getElementById('customModalError');
            
            titleEl.textContent = title;
            inputEl.placeholder = placeholder;
            inputEl.value = '';
            inputEl.classList.remove('input-error');
            errorEl.style.display = 'none';
            
            customModalData = { type, callback, validation };
            modal.style.display = 'block';
            inputEl.focus();
            
            // Add real-time validation
            inputEl.oninput = function() {
                const value = this.value;
                if (validation && !validation.test(value)) {
                    this.classList.add('input-error');
                    errorEl.style.display = 'block';
                } else {
                    this.classList.remove('input-error');
                    errorEl.style.display = 'none';
                }
            };
            
            // Handle Enter key
            inputEl.onkeypress = function(e) {
                if (e.key === 'Enter') {
                    confirmCustomModal();
                }
            };
        }

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            customModalData = { type: '', callback: null, validation: null };
        }

        function confirmCustomModal() {
            const inputEl = document.getElementById('customModalInput');
            const errorEl = document.getElementById('customModalError');
            const value = inputEl.value.trim();
            
            if (!value) {
                inputEl.classList.add('input-error');
                errorEl.textContent = 'This field is required';
                errorEl.style.display = 'block';
                return;
            }
            
            if (customModalData.validation && !customModalData.validation.test(value)) {
                inputEl.classList.add('input-error');
                errorEl.style.display = 'block';
                return;
            }
            
            if (customModalData.callback) {
                customModalData.callback(value);
            }
            
            closeCustomModal();
        }

        // Add New functions for dynamic content
        function addNewDesignation() {
            console.log('üîß addNewDesignation called from staff form');
            
            // Verify that the staff modal is still open
            const staffModal = document.getElementById('admissionModal');
            console.log('üìã Staff modal state before opening custom modal:', 
                       staffModal ? staffModal.style.display : 'not found');
            showCustomModal(
                'Add New Designation',
                'Enter designation name (text only)',
                'designation',
                function(value) {
                    console.log('üìù Adding new designation:', value);
                    const designationSelect = document.getElementById('designation');
                    
                    if (!designationSelect) {
                        console.error('‚ùå Designation select element not found');
                        alert('Error: Could not find designation dropdown. Please try again.');
                        return;
                    }
                    
                    // Check if already exists
                    const existingOptions = Array.from(designationSelect.options);
                    const exists = existingOptions.some(option => option.value.toLowerCase() === value.toLowerCase());
                    
                    if (!exists) {
                        // Add to local designations array first
                        const newId = Math.max(...designations.map(d => d.id), 0) + 1;
                        designations.push({ id: newId, name: value });
                        saveDesignationsToStorage();
                        
                        // Update all designation dropdowns (this will recreate all options)
                        updateDesignationDropdown();
                        
                        // Ensure the new designation is selected in the current form
                        setTimeout(() => {
                            const updatedSelect = document.getElementById('designation');
                            if (updatedSelect) {
                                updatedSelect.value = value;
                                console.log('‚úÖ New designation selected:', updatedSelect.value);
                            }
                        }, 50);
                        
                        console.log('‚úÖ New designation added successfully');
                        
                        // Verify staff modal is still open after adding designation
                        setTimeout(() => {
                            const staffModal = document.getElementById('admissionModal');
                            console.log('üìã Staff modal state after adding designation:', 
                                       staffModal ? staffModal.style.display : 'not found');
                        }, 100);
                        
                        alert('New designation added successfully!');
                    } else {
                        console.log('‚ö†Ô∏è Designation already exists:', value);
                        alert('This designation already exists.');
                    }
                },
                /^[a-zA-Z\s.'-]+$/
            );
            
            document.getElementById('customModalError').textContent = 'Only letters, spaces, apostrophes, dots, and hyphens are allowed';
        }

        function addNewFunctionCode() {
            // Reset and prepare the code modal for function code
            const title = document.getElementById('codeModalTitle');
            const codeForm = document.getElementById('codeForm');
            const typeInput = document.getElementById('codeTypeInput');
            
            title.textContent = 'Add Function Code';
            codeForm.reset();
            document.getElementById('codeId').value = '';
            
            // Pre-select Function code type
            typeInput.value = 'Function code';
            typeInput.disabled = true; // Disable since we're specifically adding function code
            
            // Clear validation states
            const inputs = [
                document.getElementById('codeInput'),
                document.getElementById('codeTypeInput'),
                document.getElementById('codeDescriptionInput')
            ];
            inputs.forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
            
            // Store callback for after save
            window.codeModalCallback = function(savedCode) {
                if (savedCode && savedCode.type === 'Function code') {
                    // The dropdown has already been updated by saveCode
                    // Just select the newly added function code
                    setTimeout(() => {
                        const functionCodeSelect = document.getElementById('functionCode');
                        if (functionCodeSelect) {
                            functionCodeSelect.value = savedCode.code;
                            // Trigger change event in case there are any listeners
                            functionCodeSelect.dispatchEvent(new Event('change'));
                        }
                        alert('Function code added successfully!');
                    }, 50);
                }
            };
            
            openProfessionalModal('codeModal');
        }

        function addNewObjectCode() {
            // Reset and prepare the code modal for object code
            const title = document.getElementById('codeModalTitle');
            const codeForm = document.getElementById('codeForm');
            const typeInput = document.getElementById('codeTypeInput');
            
            title.textContent = 'Add Object Code';
            codeForm.reset();
            document.getElementById('codeId').value = '';
            
            // Pre-select Object code type
            typeInput.value = 'Object code';
            typeInput.disabled = true; // Disable since we're specifically adding object code
            
            // Clear validation states
            const inputs = [
                document.getElementById('codeInput'),
                document.getElementById('codeTypeInput'),
                document.getElementById('codeDescriptionInput')
            ];
            inputs.forEach(input => {
                input.classList.remove('invalid', 'valid');
            });
            
            // Store callback for after save
            window.codeModalCallback = function(savedCode) {
                if (savedCode && savedCode.type === 'Object code') {
                    // The dropdown has already been updated by saveCode
                    // Just select the newly added object code
                    setTimeout(() => {
                        const objectCodeSelect = document.getElementById('objectCode');
                        if (objectCodeSelect) {
                            objectCodeSelect.value = savedCode.code;
                            // Trigger change event in case there are any listeners
                            objectCodeSelect.dispatchEvent(new Event('change'));
                        }
                        alert('Object code added successfully!');
                    }, 50);
                }
            };
            
            openProfessionalModal('codeModal');
        }

        function addNewNationality() {
            showCustomModal(
                'Add New Nationality',
                'Enter nationality name',
                'nationality',
                function(value) {
                    const nationalitySelect = document.getElementById('nationality');
                    
                    // Check if already exists
                    const existingOptions = Array.from(nationalitySelect.options);
                    const exists = existingOptions.some(option => option.value.toLowerCase() === value.toLowerCase());
                    
                    if (!exists) {
                        const newOption = document.createElement('option');
                        newOption.value = value;
                        newOption.textContent = value;
                        nationalitySelect.appendChild(newOption);
                        nationalitySelect.value = value;
                        
                        alert('New nationality added successfully!');
                    } else {
                        alert('This nationality already exists.');
                    }
                },
                /^[a-zA-Z\s.'-]+$/
            );
            
            document.getElementById('customModalError').textContent = 'Only letters, spaces, apostrophes, dots, and hyphens are allowed';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const admissionModal = document.getElementById('admissionModal');
            const designationModal = document.getElementById('designationModal');
            const codeModal = document.getElementById('codeModal');
            const userModal = document.getElementById('userModal');
            const customModal = document.getElementById('customModal');
            const confirmModal = document.getElementById('confirmModal');
            const remarksModal = document.getElementById('remarksModal');
            const detailsModal = document.getElementById('detailsModal');
            const cameraModal = document.getElementById('cameraModal');
            
            // Handle popups
            const notificationsPopup = document.getElementById('notificationsPopup');
            const userDetailsPopup = document.getElementById('userDetailsPopup');
            
            if (event.target === admissionModal) {
                admissionModal.style.display = 'none';
            }
            if (event.target === designationModal) {
                closeProfessionalModal('designationModal');
            }
            if (event.target === codeModal) {
                closeProfessionalModal('codeModal');
            }
            if (event.target === userModal) {
                userModal.style.display = 'none';
            }
            if (event.target === customModal) {
                closeCustomModal();
            }
            if (event.target === confirmModal) {
                closeConfirmModal();
            }
            if (event.target === remarksModal) {
                closeRemarksModal();
            }
            if (event.target === detailsModal) {
                closeDetailsModal();
            }
            
            // Close popups when clicking outside
            const messagesPopup = document.getElementById('messagesPopup');
            
            // Check if click is outside all popups and not on header buttons
            const isClickOnHeaderButtons = event.target.classList.contains('icon-btn') || 
                                         event.target.classList.contains('notification') || 
                                         event.target.classList.contains('user-profile') ||
                                         event.target.closest('.user-profile') ||
                                         event.target.closest('.icon-btn');
            
            const isClickInsideAnyPopup = (notificationsPopup && notificationsPopup.contains(event.target)) ||
                                         (messagesPopup && messagesPopup.contains(event.target)) ||
                                         (userDetailsPopup && userDetailsPopup.contains(event.target));
            
            // If click is outside all popups and not on header buttons, close all popups
            if (!isClickOnHeaderButtons && !isClickInsideAnyPopup) {
                closeAllPopups();
            }
            if (event.target === cameraModal) {
                closeCameraModal();
            }
        }


        // Add specific click-outside handler for code modal
        document.addEventListener('DOMContentLoaded', function() {
            const codeModal = document.getElementById('codeModal');
            const modalOverlay = document.getElementById('modalOverlay');
            
            if (codeModal) {
                // Prevent clicks on modal content from closing the modal
                const modalHeader = codeModal.querySelector('.professional-modal-header');
                const modalBody = codeModal.querySelector('.professional-modal-body');
                const modalFooter = codeModal.querySelector('.professional-modal-footer');
                
                [modalHeader, modalBody, modalFooter].forEach(element => {
                    if (element) {
                        element.addEventListener('click', function(e) {
                            e.stopPropagation();
                        });
                    }
                });
                
                // Close modal when clicking on the modal background
                codeModal.addEventListener('click', function(e) {
                    if (e.target === codeModal) {
                        closeProfessionalModal('codeModal');
                    }
                });
            }
            
            // Add a global document click handler to catch clicks outside modal
            document.addEventListener('click', function(e) {
                if (codeModal && codeModal.style.display === 'block' && codeModal.classList.contains('show')) {
                    // Check if click is completely outside the modal
                    if (!codeModal.contains(e.target) && !e.target.closest('#codeModal')) {
                        closeProfessionalModal('codeModal');
                    }
                }
            });
        });

        console.log('All JavaScript loaded successfully');
        
        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Setting up event listeners');
            
            // Role selection cards
            const adminRoleCard = document.getElementById('adminRoleCard');
            const userRoleCard = document.getElementById('userRoleCard');
            const adminBackBtn = document.getElementById('adminBackBtn');
            const userBackBtn = document.getElementById('userBackBtn');
            
            console.log('Elements found:', {
                adminRoleCard: !!adminRoleCard,
                userRoleCard: !!userRoleCard,
                adminBackBtn: !!adminBackBtn,
                userBackBtn: !!userBackBtn
            });
            
            if (adminRoleCard) {
                adminRoleCard.addEventListener('click', function() {
                    console.log('Admin role card clicked');
                    selectRole('administrator');
                });
                adminRoleCard.style.cursor = 'pointer';
            }
            
            if (userRoleCard) {
                userRoleCard.addEventListener('click', function() {
                    console.log('User role card clicked');
                    selectRole('user');
                });
                userRoleCard.style.cursor = 'pointer';
            }
            
            if (adminBackBtn) {
                adminBackBtn.addEventListener('click', function() {
                    console.log('Admin back button clicked');
                    backToRoleSelection();
                });
            }
            
            if (userBackBtn) {
                userBackBtn.addEventListener('click', function() {
                    console.log('User back button clicked');
                    backToRoleSelection();
                });
            }
        });
        
        // Also try without DOMContentLoaded in case it's already loaded
        setTimeout(() => {
            console.log('Timeout setup - Setting up event listeners as backup');
            
            const adminRoleCard = document.getElementById('adminRoleCard');
            const userRoleCard = document.getElementById('userRoleCard');
            
            if (adminRoleCard && !adminRoleCard.onclick) {
                console.log('Setting up admin card listener via timeout');
                adminRoleCard.addEventListener('click', function() {
                    console.log('Admin role card clicked (timeout setup)');
                    selectRole('administrator');
                });
            }
            
            if (userRoleCard && !userRoleCard.onclick) {
                console.log('Setting up user card listener via timeout');
                userRoleCard.addEventListener('click', function() {
                    console.log('User role card clicked (timeout setup)');
                    selectRole('user');
                });
            }
            
            // Removed automatic date field initialization to prevent interference with edit modal
            // Date fields are now properly initialized when the modal is opened
        }, 500);
        
        // Photo Modal Functions
        function openPhotoModal(photoSrc, staffName) {
            const modal = document.getElementById('photoModal');
            const modalPhoto = document.getElementById('modalPhoto');
            const modalPhotoName = document.getElementById('modalPhotoName');
            
            modalPhoto.src = photoSrc;
            modalPhotoName.textContent = staffName;
            modal.style.display = 'block';
            
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }
        
        function openPhotoModalById(admissionId) {
            const admission = admissions.find(a => a.id === admissionId);
            if (admission && admission.photo) {
                openPhotoModal(admission.photo, admission.staffName || 'N/A');
            }
        }
        
        function openUserPhotoModal(userId) {
            const user = users.find(u => u.id === userId);
            if (user && user.photo) {
                openPhotoModal(user.photo, user.fullName || 'N/A');
            }
        }
        
        function closePhotoModal() {
            const modal = document.getElementById('photoModal');
            modal.style.display = 'none';
            
            // Restore body scrolling
            document.body.style.overflow = '';
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePhotoModal();
            }
        });
    </script>
    
    <!-- Add Child Modal -->
    <div id="addChildModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addChildModal')">&times;</span>
            <h2>Add Child</h2>
            <form id="addChildForm" onsubmit="saveChild(event)">
                <div class="form-group">
                    <label for="childNameInput">Name *</label>
                    <input type="text" id="childNameInput" required placeholder="Enter child's name" oninput="validateNameInput(this)">
                </div>
                <div class="form-group">
                    <label for="childGender">Gender *</label>
                    <select id="childGender" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Kinner">Kinner</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="childDOB">Date of Birth *</label>
                    <div class="date-input-wrapper">
                        <input type="text" id="childDOB" class="google-calendar-input" required onchange="calculateChildAge()" 
                               placeholder="Select date" readonly title="Click to select date">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                </div>
                <div class="form-group">
                    <label for="childAge">Age</label>
                    <input type="text" id="childAge" readonly placeholder="Age will be calculated automatically">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addChildModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Child</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Pension Nominee Modal -->
    <div id="pensionNomineeModal" class="modal">
        <div class="modal-content pension-modal-content">
            <div class="pension-modal-header">
                <h2>üë• Nominee Management</h2>
                <button class="pension-close-btn" onclick="closeModal('pensionNomineeModal')">&times;</button>
            </div>
            
            <div class="pension-modal-body">
                <form id="pensionNomineeForm" onsubmit="saveNominee(event)">
                    <input type="hidden" id="nomineeStaffId">
                    
                    <div class="pension-form-section">
                        <div class="pension-section-title">Add New Nominee</div>
                        
                        <div class="form-group">
                            <label for="nomineeName">Nominee Name *</label>
                            <input type="text" id="nomineeName" required placeholder="Enter nominee's full name" oninput="validateTextOnlyAndCapitalize(this)" pattern="[A-Za-z\s]+" title="Only letters and spaces allowed">
                        </div>
                        
                        <div class="form-group">
                            <label for="nomineeRelation">Relation *</label>
                            <input type="text" id="nomineeRelation" required placeholder="Enter relation (e.g., Spouse, Child)" oninput="validateTextOnlyAndCapitalize(this)" pattern="[A-Za-z\s]+" title="Only letters and spaces allowed">
                        </div>
                        
                        <div class="form-group">
                            <label for="nomineePercentage">Percentage Share *</label>
                            <div class="pension-percentage-container">
                                <input type="number" id="nomineePercentage" required placeholder="Enter percentage (1-100)" min="1" max="100" oninput="validatePercentageInput(this)">
                                <div class="pension-percentage-symbol">%</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pension-nominees-section">
                        <div class="pension-nominees-header">
                            <div class="pension-nominees-title">Current Nominees</div>
                            <div class="pension-total-percentage" id="pensionTotalPercentage">Total: 0%</div>
                        </div>
                        <div id="nomineesListContent">
                            <div class="pension-empty-state">üìã No nominees added yet</div>
                        </div>
                    </div>
                    
                    <div class="pension-modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('pensionNomineeModal')">Close</button>
                        <button type="submit" class="btn btn-primary">Add Nominee</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Deductions Management Modal -->
    <div id="deductionsModal" class="modal">
        <div class="modal-content pension-modal-content">
            <div class="pension-modal-header">
                <h2>üí∞ Deductions Management</h2>
                <button class="pension-close-btn" onclick="closeModal('deductionsModal')">&times;</button>
            </div>
            
            <div class="pension-modal-body">
                <form id="deductionsForm" onsubmit="saveDeductions(event)">
                    <input type="hidden" id="deductionsStaffId">
                    
                    <div class="pension-form-section">
                        <div class="pension-section-title">Deduction Details</div>
                        
                        <!-- Calculation Groups for Advance/Balance type fields -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üåæ Wheat Advance
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="wheatAdvanceTotal" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateWheatAdvance(); checkEnableMonthlyField('wheatAdvanceTotal', 'wheatAdvanceRecovered')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="wheatAdvanceRecovered" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('wheatAdvanceTotal', 'wheatAdvanceRecovered'); calculateWheatAdvance()"
                                           disabled>
                                </div>
                            </div>
                        </div>

                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üè¶ GPF Advance Recovery
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfAdvanceRecoveryTotal" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFAdvanceRecovery(); checkEnableMonthlyField('gpfAdvanceRecoveryTotal', 'gpfAdvanceRecoveryRecovered')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfAdvanceRecoveryRecovered" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfAdvanceRecoveryTotal', 'gpfAdvanceRecoveryRecovered'); calculateGPFAdvanceRecovery()" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üí∞ GPF Ledger Balance
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfLedBalanceOpening" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFLedBalance(); checkEnableMonthlyField('gpfLedBalanceOpening', 'gpfLedBalanceCurrent')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfLedBalanceCurrent" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfLedBalanceOpening', 'gpfLedBalanceCurrent'); calculateGPFLedBalance()" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìä GPF Advance Balance
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfAdvanceBalancePrevious" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFAdvanceBalance(); checkEnableMonthlyField('gpfAdvanceBalancePrevious', 'gpfAdvanceBalanceRecovery')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfAdvanceBalanceRecovery" placeholder="0" min="0" step="0.01" 
                                           onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46"
                                           oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfAdvanceBalancePrevious', 'gpfAdvanceBalanceRecovery'); calculateGPFAdvanceBalance()" disabled>
                                </div>
                            </div>
                        </div>

                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üèß Bank Recovery
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="bankRecoveryLoan" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateBankRecovery(); checkEnableMonthlyField('bankRecoveryLoan', 'bankRecoveryPaid')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="bankRecoveryPaid" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('bankRecoveryLoan', 'bankRecoveryPaid'); calculateBankRecovery()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- NEW: GIC with Calculation Fields -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üèõÔ∏è GIC (General Insurance Corporation)
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gicTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGIC(); checkEnableMonthlyField('gicTotal', 'gicMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gicMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gicTotal', 'gicMonthly'); calculateGIC()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- LIC Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üè¢ LIC (Life Insurance Corporation)
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="licTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateLIC(); checkEnableMonthlyField('licTotal', 'licMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="licMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('licTotal', 'licMonthly'); calculateLIC()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Electricity Bill Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üí° Electricity Bill
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="electricityBillTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateElectricityBill(); checkEnableMonthlyField('electricityBillTotal', 'electricityBillMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="electricityBillMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('electricityBillTotal', 'electricityBillMonthly'); calculateElectricityBill()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Water Charges Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üíß Water Charges
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="waterChargesTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateWaterCharges(); checkEnableMonthlyField('waterChargesTotal', 'waterChargesMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="waterChargesMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('waterChargesTotal', 'waterChargesMonthly'); calculateWaterCharges()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- General Recovery Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìã General Recovery
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="recoveryTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateRecovery(); checkEnableMonthlyField('recoveryTotal', 'recoveryMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="recoveryMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('recoveryTotal', 'recoveryMonthly'); calculateRecovery()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Leave Deductions Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìÖ Leave Deductions
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="leaveDeductionsTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateLeaveDeductions(); checkEnableMonthlyField('leaveDeductionsTotal', 'leaveDeductionsMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="leaveDeductionsMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('leaveDeductionsTotal', 'leaveDeductionsMonthly'); calculateLeaveDeductions()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- GPPC Subscription Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üè¶ GPPC Subscription
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gppcSubscriptionTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPPCSubscription(); checkEnableMonthlyField('gppcSubscriptionTotal', 'gppcSubscriptionMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gppcSubscriptionMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gppcSubscriptionTotal', 'gppcSubscriptionMonthly'); calculateGPPCSubscription()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- GPF Extra Subscription Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üí∞ GPF Extra Subscription
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfExtraSubscriptionTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFExtraSubscription(); checkEnableMonthlyField('gpfExtraSubscriptionTotal', 'gpfExtraSubscriptionMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfExtraSubscriptionMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfExtraSubscriptionTotal', 'gpfExtraSubscriptionMonthly'); calculateGPFExtraSubscription()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- GPF Government Contribution Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üèõÔ∏è GPF Government Contribution
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfGovernmentContributionTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFGovernmentContribution(); checkEnableMonthlyField('gpfGovernmentContributionTotal', 'gpfGovernmentContributionMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfGovernmentContributionMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfGovernmentContributionTotal', 'gpfGovernmentContributionMonthly'); calculateGPFGovernmentContribution()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- NPS Government Contribution Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üè¢ NPS Government Contribution
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="npsGovernmentContributionTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateNPSGovernmentContribution(); checkEnableMonthlyField('npsGovernmentContributionTotal', 'npsGovernmentContributionMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="npsGovernmentContributionMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('npsGovernmentContributionTotal', 'npsGovernmentContributionMonthly'); calculateNPSGovernmentContribution()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- NPS Self Contribution Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üíº NPS Self Contribution
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="npsSelfContributionTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateNPSSelfContribution(); checkEnableMonthlyField('npsSelfContributionTotal', 'npsSelfContributionMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="npsSelfContributionMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('npsSelfContributionTotal', 'npsSelfContributionMonthly'); calculateNPSSelfContribution()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- GPF Withdrawal Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üèß GPF Withdrawal
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfWithdrawlTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFWithdrawl(); checkEnableMonthlyField('gpfWithdrawlTotal', 'gpfWithdrawlMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfWithdrawlMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfWithdrawlTotal', 'gpfWithdrawlMonthly'); calculateGPFWithdrawl()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- GPF Interest Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìà GPF Interest
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="gpfInterestTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateGPFInterest(); checkEnableMonthlyField('gpfInterestTotal', 'gpfInterestMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="gpfInterestMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('gpfInterestTotal', 'gpfInterestMonthly'); calculateGPFInterest()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Income Tax Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üí∏ Income Tax
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="incomeTaxTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateIncomeTax(); checkEnableMonthlyField('incomeTaxTotal', 'incomeTaxMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="incomeTaxMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('incomeTaxTotal', 'incomeTaxMonthly'); calculateIncomeTax()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Sur-charges Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìä Sur-charges
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="surChargesTotal" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateSurCharges(); checkEnableMonthlyField('surChargesTotal', 'surChargesMonthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="surChargesMonthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('surChargesTotal', 'surChargesMonthly'); calculateSurCharges()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Other Deduction-1 Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìù Other Deduction-1
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="otherDeduction1Total" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateOtherDeduction1(); checkEnableMonthlyField('otherDeduction1Total', 'otherDeduction1Monthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="otherDeduction1Monthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('otherDeduction1Total', 'otherDeduction1Monthly'); calculateOtherDeduction1()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Other Deduction-2 Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìÑ Other Deduction-2
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="otherDeduction2Total" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateOtherDeduction2(); checkEnableMonthlyField('otherDeduction2Total', 'otherDeduction2Monthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="otherDeduction2Monthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('otherDeduction2Total', 'otherDeduction2Monthly'); calculateOtherDeduction2()" disabled>
                                </div>
                            </div>
                        </div>

                        <!-- Other Deduction-3 Calculation Group -->
                        <div class="calculation-group">
                            <div class="calculation-group-title">
                                üìÉ Other Deduction-3
                            </div>
                            <div class="calculation-row">
                                <div class="calculation-field">
                                    <label>Total Advance</label>
                                    <input type="number" id="otherDeduction3Total" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); calculateOtherDeduction3(); checkEnableMonthlyField('otherDeduction3Total', 'otherDeduction3Monthly')">
                                </div>
                                <div class="calculation-operator">‚Üí</div>
                                <div class="calculation-field">
                                    <label>Monthly Deduction</label>
                                    <input type="number" id="otherDeduction3Monthly" placeholder="0" min="0" step="0.01" onkeypress="return event.charCode === 0 || event.charCode === 8 || (event.charCode >= 48 && event.charCode <= 57) || event.charCode === 46" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1'); validateMonthlyDeduction('otherDeduction3Total', 'otherDeduction3Monthly'); calculateOtherDeduction3()" disabled>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Real-time Total Deductions Summary -->
                    <div class="deductions-total-summary" id="deductionsTotalSummary">
                        <div class="total-summary-header">
                            <h3>üìä Total Monthly Deductions</h3>
                        </div>
                        <div class="total-summary-content">
                            <div class="total-amount" id="totalMonthlyAmount">‚Çπ0</div>
                            <div class="total-label">Total amount to be deducted this month</div>
                        </div>
                    </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label for="deductionsRemarks">Remarks</label>
                            <textarea id="deductionsRemarks" placeholder="Enter any additional remarks or notes" rows="3" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
                        </div>
                    
                    <div class="pension-modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('deductionsModal')">Close</button>
                        <button type="submit" class="btn btn-primary">Save Deductions</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Professional Notifications Popup -->
    <div id="notificationsPopup" class="notifications-popup">
        <div class="notifications-header">
            <div class="notifications-title">
                Notifications
                <span class="notifications-badge" id="notificationsBadge">0</span>
            </div>
        </div>
        
        <div class="notifications-body" id="notificationsBody">
            <div class="notifications-empty">
                No new notifications
            </div>
        </div>
        
        <div class="notifications-footer">
            <a href="#" onclick="markAllNotificationsRead()">Mark all as read</a>
        </div>
    </div>

    <!-- Professional User Details Popup -->
    <div id="userDetailsPopup" class="user-details-popup">
        <div class="user-details-header">
            <div class="user-avatar-large" id="userAvatarLarge">U</div>
            <div class="user-name-large" id="userNameLarge">User</div>
            <div class="user-role-large" id="userRoleLarge">Staff Member</div>
        </div>
        
        <div class="user-details-body" id="userDetailsBody">
            <!-- User details will be populated here -->
        </div>
        
        <!-- Footer buttons are now added dynamically in toggleUserMenu function -->
    </div>

    <!-- Professional E-Messages Popup -->
    <div id="messagesPopup" class="messages-popup">
        <div class="messages-header">
            <div class="messages-header-content">
                <div class="messages-title">
                    <div class="messages-title-icon">üìß</div>
                    <span>Messages</span>
                </div>
                <div class="messages-count" id="messagesCount">0 new</div>
            </div>
        </div>
        
        <div class="messages-tabs">
            <button class="message-tab active" onclick="switchMessageTab(this, 'all')">All Messages</button>
            <button class="message-tab" onclick="switchMessageTab(this, 'unread')">Unread</button>
            <button class="message-tab" onclick="switchMessageTab(this, 'important')">Important</button>
        </div>
        
        <div class="messages-body" id="messagesBody">
            <div class="messages-empty">No messages</div>
        </div>
        
        <div class="messages-footer">
            <a href="#" class="messages-footer-link">
                View all messages
                <span>‚Üí</span>
            </a>
        </div>
    </div>

    <!-- Modal Overlay -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeDeleteModal(); closeSaveModal(); closeProfessionalModal('designationModal'); closeProfessionalModal('codeModal'); closeProfessionalModal('adminDesignationModal'); closeProfessionalModal('leaveApplicationModal'); closeProfessionalModal('leaveTypesModal'); closeProfessionalModal('leaveTypeEditModal');"></div>

    <!-- Professional Delete Confirmation Modal -->
    <div id="deleteModal" class="delete-modal">
        <div class="delete-modal-header">
            <div class="delete-icon-wrapper">
                <div class="delete-icon">üóëÔ∏è</div>
            </div>
            <h3 class="delete-modal-title">Delete Confirmation</h3>
            <p class="delete-modal-subtitle">
                Are you sure you want to delete this item? This action cannot be undone.
            </p>
        </div>
        
        <div class="delete-item-info">
            <div class="delete-item-label">Item to be deleted</div>
            <div class="delete-item-value" id="deleteItemValue">Item Name</div>
        </div>
        
        <div class="delete-modal-footer">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">Cancel</button>
            <button class="modal-btn modal-btn-delete" onclick="confirmDelete()">Delete</button>
        </div>
    </div>

    <!-- Professional Changes Applied Modal -->
    <div id="changesAppliedModal" class="changes-applied-modal">
        <div class="changes-applied-header">
            <div class="changes-applied-icon-wrapper">
                <div class="changes-applied-icon">‚úì</div>
            </div>
            <h3 class="changes-applied-title">Leave Application Submitted</h3>
            <p class="changes-applied-subtitle">Successfully Submitted</p>
        </div>
        
        <div class="changes-applied-body">
            <p class="changes-applied-description">
                Your leave application has been submitted successfully and is now pending approval.
            </p>
        </div>
    </div>

    <!-- Professional Save Changes Modal -->
    <div id="saveModal" class="save-modal">
        <div class="save-modal-header">
            <div class="save-modal-header-content">
                <div class="save-icon-wrapper">
                    <div class="save-icon">üíæ</div>
                </div>
                <h3 class="save-modal-title">Save Changes?</h3>
                <p class="save-modal-subtitle">
                    You have unsaved changes. Would you like to save them before proceeding?
                </p>
            </div>
        </div>
        
        <div class="save-changes-list" id="saveChangesList">
            <div class="save-changes-title">
                <span>üìù</span>
                <span>Modified Fields:</span>
            </div>
            <div class="change-item">
                <span class="change-icon">‚úì</span>
                <span>No changes detected</span>
            </div>
        </div>
        
        <div class="save-modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="discardChanges()">Discard</button>
            <button class="modal-btn modal-btn-primary" onclick="confirmSave()">Save Changes</button>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="photo-modal" onclick="closePhotoModal()">
        <div class="photo-modal-content" onclick="event.stopPropagation()">
            <button class="photo-modal-close" onclick="closePhotoModal()">&times;</button>
            <img id="modalPhoto" src="" alt="Staff Photo">
            <div id="modalPhotoName" style="text-align: center; margin-top: 15px; font-size: 16px; font-weight: 600; color: #333;"></div>
        </div>
    </div>


    <!-- Admin Professional Changes Applied Modal -->
    <div id="adminChangesAppliedModal" class="changes-applied-modal">
        <div class="changes-applied-header">
            <div class="changes-applied-icon-wrapper">
                <div class="changes-applied-icon">‚úì</div>
            </div>
            <h3 class="changes-applied-title">Changes Applied</h3>
            <p class="changes-applied-subtitle">Successfully Updated</p>
        </div>
        
        <div class="changes-applied-body">
            <p class="changes-applied-description">
                User information has been updated successfully and is now active in the system.
            </p>
        </div>
    </div>

    <!-- Deductions Saved Success Modal -->
    <div id="deductionsSavedModal" class="changes-applied-modal">
        <div class="changes-applied-header">
            <div class="changes-applied-icon-wrapper">
                <div class="changes-applied-icon">üí∞</div>
            </div>
            <h3 class="changes-applied-title">Deductions Saved</h3>
            <p class="changes-applied-subtitle">Successfully Updated</p>
        </div>
        
        <div class="changes-applied-body">
            <p class="changes-applied-description">
                Staff deduction information has been saved successfully and is now active in the system.
            </p>
        </div>
    </div>

    <!-- Nominee Percentage Error Modal -->
    <div id="nomineePercentageErrorModal" class="professional-modal">
        <div class="professional-modal-header">
            <button class="professional-modal-close" onclick="closeNomineePercentageErrorModal()">&times;</button>
            <div class="professional-modal-header-content">
                <div class="professional-modal-icon">
                    <div class="professional-modal-icon-inner">‚ö†Ô∏è</div>
                </div>
                <h3 class="professional-modal-title">Percentage Limit Exceeded</h3>
                <p class="professional-modal-subtitle">Cannot Add Nominee</p>
            </div>
        </div>
        
        <div class="professional-modal-body">
            <div class="error-details-container">
                <div class="error-message">
                    <h4>‚ùå Invalid Nominee Percentage</h4>
                    <p>The total nominee percentage cannot exceed <strong>100%</strong>.</p>
                </div>
                
                <div class="percentage-breakdown">
                    <div class="percentage-item">
                        <span class="percentage-label">Current Total:</span>
                        <span class="percentage-value current-total">0%</span>
                    </div>
                    <div class="percentage-item">
                        <span class="percentage-label">Attempted to Add:</span>
                        <span class="percentage-value attempted-percentage">0%</span>
                    </div>
                    <div class="percentage-divider">+</div>
                    <div class="percentage-item total">
                        <span class="percentage-label">Would Total:</span>
                        <span class="percentage-value error-total">0%</span>
                    </div>
                </div>
                
                <div class="recommendation">
                    <h5>üí° Recommendation</h5>
                    <p>Maximum percentage you can add: <strong class="max-allowed">0%</strong></p>
                    <p>Please adjust the nominee percentage and try again.</p>
                </div>
            </div>
        </div>
        
        <div class="professional-modal-footer">
            <button class="professional-btn professional-btn-primary" onclick="closeNomineePercentageErrorModal()">Understood</button>
        </div>
    </div>

    <!-- User Created Success Modal -->
    <div id="userCreatedSuccessModal" class="changes-applied-modal">
        <div class="changes-applied-header">
            <div class="changes-applied-icon-wrapper">
                <div class="changes-applied-icon">‚úì</div>
            </div>
            <h3 class="changes-applied-title">User Created Successfully</h3>
            <p class="changes-applied-subtitle">New User Added</p>
        </div>
        
        <div class="changes-applied-body">
            <p class="changes-applied-description">
                The new user has been created successfully and can now log in to the system.
            </p>
        </div>
    </div>

    <!-- User Already Exists Modal -->
    <div id="userAlreadyExistsModal" class="save-modal">
        <div class="save-modal-header">
            <div class="save-icon-wrapper" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="save-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">‚ö†Ô∏è</div>
            </div>
            <h3 class="save-modal-title">User Already Exists</h3>
            <p class="save-modal-subtitle">
                A user with this username already exists. Please choose a different username.
            </p>
        </div>
        
        <div class="save-modal-footer">
            <button class="modal-btn modal-btn-primary" onclick="closeUserAlreadyExistsModal()">OK</button>
        </div>
    </div>

    <!-- User Status Confirm Modal -->
    <div id="userStatusConfirmModal" class="save-modal">
        <div class="save-modal-header">
            <div class="save-icon-wrapper">
                <div class="save-icon" id="statusChangeIcon">üîÑ</div>
            </div>
            <h3 class="save-modal-title" id="statusChangeTitle">Change User Status?</h3>
            <p class="save-modal-subtitle" id="statusChangeSubtitle">
                Do you want to change this user's status?
            </p>
        </div>
        
        <div class="save-modal-footer">
            <button class="modal-btn modal-btn-secondary" onclick="closeUserStatusConfirmModal()">Cancel</button>
            <button class="modal-btn modal-btn-primary" id="confirmStatusChangeBtn" onclick="confirmUserStatusChange()">Confirm</button>
        </div>
    </div>

    <!-- User Status Changed Modal -->
    <div id="userStatusChangedModal" class="changes-applied-modal">
        <div class="changes-applied-header">
            <div class="changes-applied-icon-wrapper">
                <div class="changes-applied-icon">‚úì</div>
            </div>
            <h3 class="changes-applied-title" id="statusChangedTitle">User Status Updated</h3>
            <p class="changes-applied-subtitle" id="statusChangedSubtitle">Successfully Changed</p>
        </div>
        
        <div class="changes-applied-body">
            <p class="changes-applied-description" id="statusChangedDescription">
                The user status has been updated successfully.
            </p>
        </div>
    </div>

    <!-- Professional Cannot Delete Modal -->
    <div id="cannotDeleteModal" class="save-modal">
        <div class="save-modal-header">
            <div class="save-icon-wrapper" style="background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);">
                <div class="save-icon" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">‚ö†Ô∏è</div>
            </div>
            <h3 class="save-modal-title" id="cannotDeleteTitle">Cannot Delete Item</h3>
            <p class="save-modal-subtitle" id="cannotDeleteSubtitle">
                This item is currently being used and cannot be deleted.
            </p>
        </div>
        
        <div class="cannot-delete-usage">
            <div class="usage-title">
                <span>üë•</span>
                <span>Currently Used By:</span>
            </div>
            <div class="usage-list" id="cannotDeleteUsageList">
                <!-- Usage items will be populated dynamically -->
            </div>
        </div>

        <div class="cannot-delete-instructions">
            <div class="instructions-title">
                <span>üìã</span>
                <span>How to resolve this:</span>
            </div>
            <div class="instructions-list" id="cannotDeleteInstructionsList">
                <!-- Instructions will be populated dynamically -->
            </div>
        </div>
        
        <div class="save-modal-footer">
            <button class="modal-btn modal-btn-primary" onclick="closeCannotDeleteModal()">Got it</button>
        </div>
    </div>

    <!-- Leave Application Modal -->
    <div id="leaveApplicationModal" class="professional-modal">
        <form id="leaveApplicationForm" onsubmit="submitLeaveApplication(event)">
            <div class="professional-modal-header">
                <button type="button" class="professional-modal-close" onclick="closeProfessionalModal('leaveApplicationModal')">&times;</button>
                <div class="professional-modal-header-content">
                    <div class="professional-modal-icon">
                        <div class="professional-modal-icon-inner">üìù</div>
                    </div>
                    <h3 class="professional-modal-title">Apply for Leave</h3>
                    <p class="professional-modal-subtitle">Submit your leave application with required details</p>
                </div>
            </div>
            
            <div class="professional-modal-body">
                <div class="form-group">
                    <label for="leaveStaffId">Staff ID</label>
                    <input type="text" id="leaveStaffId" class="form-control" placeholder="Enter Staff ID (e.g., EMP001)" required onchange="populateStaffName()" oninput="populateStaffName()">
                </div>
                
                <div class="form-group">
                    <label for="leaveStaffName">Staff Name</label>
                    <input type="text" id="leaveStaffName" class="form-control" readonly placeholder="Name will be auto-populated">
                </div>
                
                <div class="form-group">
                    <label for="leaveTypeId">Leave Type</label>
                    <select id="leaveTypeId" class="form-control" required onchange="checkLeaveBalance()">
                        <option value="">Select Leave Type</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="leaveStartDate">Start Date</label>
                    <div class="date-input-wrapper">
                        <input type="text" id="leaveStartDate" class="form-control google-calendar-input" required onchange="calculateLeaveDays()" placeholder="Select date" readonly title="Click to select date">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="leaveEndDate">End Date</label>
                    <div class="date-input-wrapper">
                        <input type="text" id="leaveEndDate" class="form-control google-calendar-input" required onchange="calculateLeaveDays()" placeholder="Select date" readonly title="Click to select date">
                        <svg class="calendar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="leaveDays">Number of Days</label>
                    <input type="number" id="leaveDays" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label for="leaveReason">Reason for Leave</label>
                    <textarea id="leaveReason" class="form-control" rows="2" required placeholder="Enter reason for leave"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="leaveDocument">Supporting Document (Optional)</label>
                    <div class="file-upload-wrapper">
                        <input type="file" id="leaveDocument" class="file-input" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="updateFileLabel()">
                        <label for="leaveDocument" class="file-upload-label">
                            <span class="file-upload-icon">üìé</span>
                            <span id="fileLabel">Choose file or drag here</span>
                        </label>
                        <div class="file-info" id="fileInfo" style="display: none;">
                            <small>Accepted formats: PDF, DOC, DOCX, JPG, PNG (Max 5MB)</small>
                        </div>
                    </div>
                </div>
                
                <div id="leaveBalanceInfo" class="leave-balance-info" style="display: none;">
                    <div class="balance-details">
                        <h5>Leave Balance Information:</h5>
                        <div id="balanceDetails"></div>
                    </div>
                    <div class="validation-message" id="validationMessage"></div>
                </div>
            </div>
            
            <div class="professional-modal-footer">
                <button type="button" class="professional-btn professional-btn-secondary" onclick="closeProfessionalModal('leaveApplicationModal')">Cancel</button>
                <button type="submit" class="professional-btn professional-btn-primary" id="submitLeaveBtn">Submit Application</button>
            </div>
        </form>
    </div>

    <!-- Leave Types Configuration Modal -->
    <div id="leaveTypesModal" class="professional-modal">
        <div class="professional-modal-header">
            <h3>Configure Leave Types</h3>
            <button type="button" class="professional-modal-close" onclick="closeProfessionalModal('leaveTypesModal')">&times;</button>
        </div>
        
        <div class="professional-modal-body">
            <div class="leave-types-list" id="leaveTypesList">
                <!-- Leave types will be dynamically populated here -->
            </div>
        </div>
        
        <div class="professional-modal-footer">
            <button type="button" class="professional-btn professional-btn-primary" onclick="closeProfessionalModal('leaveTypesModal')">Close</button>
        </div>
    </div>

    <!-- Add/Edit Leave Type Modal -->
    <div id="leaveTypeEditModal" class="professional-modal">
        <form id="leaveTypeEditForm" onsubmit="saveLeaveType(event)">
            <div class="professional-modal-header">
                <h3 id="leaveTypeEditTitle">Add Leave Type</h3>
                <button type="button" class="professional-modal-close" onclick="closeProfessionalModal('leaveTypeEditModal')">&times;</button>
            </div>
            
            <div class="professional-modal-body">
                <input type="hidden" id="editLeaveTypeId">
                
                <div class="form-group">
                    <label for="leaveTypeName">Leave Type Name</label>
                    <input type="text" id="leaveTypeName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="leaveTypeAllowedDays">Allowed Days per Year</label>
                    <input type="number" id="leaveTypeAllowedDays" class="form-control" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="leaveTypeColor">Color (for visual representation)</label>
                    <input type="color" id="leaveTypeColor" class="form-control" required>
                </div>
            </div>
            
            <div class="professional-modal-footer">
                <button type="button" class="professional-btn professional-btn-secondary" onclick="closeProfessionalModal('leaveTypeEditModal')">Cancel</button>
                <button type="submit" class="professional-btn professional-btn-primary">Save</button>
            </div>
        </form>
    </div>
    
    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="edit-profile-modal">
        <div class="edit-profile-content">
            <div class="edit-profile-header">
                <button class="edit-profile-close" onclick="closeEditProfile()">&times;</button>
                <h2 class="edit-profile-title">Edit Profile</h2>
                <p class="edit-profile-subtitle">Update your personal information</p>
            </div>
            
            <div class="edit-profile-body">
                <form id="editProfileForm" onsubmit="saveProfile(event)">
                    <!-- Full Name -->
                    <div class="profile-form-group">
                        <label for="editFullName">Full Name</label>
                        <input type="text" id="editFullName" name="fullName" required 
                               placeholder="Enter your full name"
                               style="text-transform: capitalize;"
                               onkeypress="return /[a-zA-Z\s]/.test(event.key)"
                               oninput="handleFullNameInput(this)">
                        <div class="validation-message" id="nameError">Please enter a valid name</div>
                    </div>
                    
                    <!-- Username -->
                    <div class="profile-form-group">
                        <label for="editUsername">Username</label>
                        <input type="text" id="editUsername" name="username" required 
                               placeholder="Enter username"
                               onkeypress="return /[a-zA-Z0-9]/.test(event.key)"
                               oninput="handleUsernameInput(this)">
                        <div class="validation-message" id="usernameError">Username must be at least 3 characters</div>
                    </div>
                    
                    <!-- Email -->
                    <div class="profile-form-group">
                        <label for="editEmail">Email Address</label>
                        <input type="email" id="editEmail" name="email" required 
                               placeholder="Enter email address">
                        <div class="validation-message" id="emailError">Please enter a valid email address</div>
                    </div>
                    
                    <!-- Password Section -->
                    <div class="password-section">
                        <h3 class="password-section-title">
                            üîê Change Password
                        </h3>
                        
                        <!-- Current Password -->
                        <div class="profile-form-group">
                            <label for="currentPassword">Current Password</label>
                            <div class="password-toggle-container">
                                <input type="password" id="currentPassword" name="currentPassword" 
                                       placeholder="Enter current password to change">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('currentPassword')">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div class="validation-message" id="currentPasswordError">Current password is required to change password</div>
                        </div>
                        
                        <!-- New Password -->
                        <div class="profile-form-group">
                            <label for="newPassword">New Password</label>
                            <div class="password-toggle-container">
                                <input type="password" id="newPassword" name="newPassword" 
                                       placeholder="Enter new password" disabled>
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword')">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div class="validation-message" id="newPasswordError">Password must be at least 8 characters</div>
                        </div>
                        
                        <!-- Confirm New Password -->
                        <div class="profile-form-group">
                            <label for="confirmNewPassword">Confirm New Password</label>
                            <div class="password-toggle-container">
                                <input type="password" id="confirmNewPassword" name="confirmNewPassword" 
                                       placeholder="Confirm new password" disabled>
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmNewPassword')">
                                    üëÅÔ∏è
                                </button>
                            </div>
                            <div class="validation-message" id="confirmPasswordError">Passwords do not match</div>
                        </div>
                    </div>
                    
                    <div class="success-indicator" id="profileSuccessMessage">
                        ‚úì Profile updated successfully!
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="profile-form-actions">
                        <button type="button" class="btn-cancel-profile" onclick="closeEditProfile()">Cancel</button>
                        <button type="submit" class="btn-save-profile">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Mobile Menu Management
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar) {
                sidebar.classList.toggle('mobile-open');
            }
            if (overlay) {
                overlay.classList.toggle('active');
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
        }

        // Responsive Table Wrapper
        function makeTablesResponsive() {
            const tables = document.querySelectorAll('table:not(.wrapped)');
            tables.forEach(table => {
                if (!table.closest('.table-responsive')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-responsive';
                    wrapper.style.overflowX = 'auto';
                    wrapper.style.webkitOverflowScrolling = 'touch';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                    table.classList.add('wrapped', 'mobile-card-table');
                    
                    // Create mobile card view
                    createMobileCardView(table);
                }
            });
        }

        function createMobileCardView(table) {
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            
            if (headers.length === 0 || rows.length === 0) return;
            
            const cardContainer = document.createElement('div');
            cardContainer.className = 'mobile-card-view';
            
            rows.forEach(row => {
                const cells = Array.from(row.querySelectorAll('td'));
                if (cells.length === 0) return;
                
                const card = document.createElement('div');
                card.className = 'mobile-card';
                
                cells.forEach((cell, index) => {
                    if (index < headers.length && headers[index]) {
                        const field = document.createElement('div');
                        field.className = 'mobile-card-field';
                        field.innerHTML = `
                            <div class="mobile-card-label" style="font-weight: bold; color: #666; font-size: 0.8em; margin-bottom: 0.2em;">
                                ${headers[index]}
                            </div>
                            <div class="mobile-card-value" style="margin-bottom: 0.8em;">
                                ${cell.innerHTML}
                            </div>
                        `;
                        card.appendChild(field);
                    }
                });
                
                cardContainer.appendChild(card);
            });
            
            table.closest('.table-responsive').parentNode.insertBefore(cardContainer, table.closest('.table-responsive'));
        }

        // Apply responsive classes to existing elements - DISABLED to prevent layout issues
        function applyResponsiveClasses() {
            // DISABLED: This function was automatically adding responsive classes to forms
            // which caused layout issues where labels appeared alongside inputs instead of above them
            // Original form layouts are preserved by not modifying their classes
        }

        // Enhance mobile navigation
        function enhanceMobileNavigation() {
            const sidebar = document.querySelector('.sidebar');
            
            if (sidebar && !sidebar.querySelector('.mobile-nav-toggle-added')) {
                // Mark as processed
                sidebar.classList.add('mobile-nav-toggle-added');
                
                // Add mobile hamburger menu
                const mobileToggle = document.createElement('div');
                mobileToggle.className = 'mobile-nav-toggle show-mobile';
                mobileToggle.innerHTML = '‚ò∞';
                mobileToggle.style.cssText = `
                    position: fixed;
                    top: 1rem;
                    left: 1rem;
                    z-index: 1050;
                    background: #2c3e50;
                    color: white;
                    padding: 0.5rem;
                    border-radius: 0.25rem;
                    cursor: pointer;
                    font-size: 1.5rem;
                    line-height: 1;
                    user-select: none;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                `;
                
                mobileToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                    if (sidebar.classList.contains('mobile-open')) {
                        sidebar.style.transform = 'translateX(0)';
                        sidebar.style.zIndex = '1040';
                    } else {
                        sidebar.style.transform = 'translateX(-100%)';
                    }
                });
                
                document.body.appendChild(mobileToggle);
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768 && 
                        !sidebar.contains(e.target) && 
                        !mobileToggle.contains(e.target) &&
                        sidebar.classList.contains('mobile-open')) {
                        sidebar.classList.remove('mobile-open');
                        sidebar.style.transform = 'translateX(-100%)';
                    }
                });
            }
        }

        // Handle responsive text sizing
        function adjustResponsiveText() {
            const screenWidth = window.innerWidth;
            let scaleFactor = 1;
            
            if (screenWidth <= 480) {
                scaleFactor = 0.85;
            } else if (screenWidth <= 768) {
                scaleFactor = 0.9;
            } else if (screenWidth <= 992) {
                scaleFactor = 0.95;
            }
            
            // Apply scale to specific elements that need fine-tuning
            const elementsToScale = document.querySelectorAll('.card-title, .section-header h3, .modal-title');
            elementsToScale.forEach(element => {
                if (scaleFactor !== 1) {
                    element.style.fontSize = `${scaleFactor}em`;
                } else {
                    element.style.fontSize = '';
                }
            });
        }

        // Handle window resize
        let resizeTimer;
        function handleResize() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                // Close mobile menu on desktop resize
                if (window.innerWidth > 768) {
                    closeMobileMenu();
                }
                
                // Update responsive elements
                makeTablesResponsive();
                applyResponsiveClasses();
                adjustResponsiveText();
            }, 250);
        }

        // Initialize everything when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all responsive features
            makeTablesResponsive();
            applyResponsiveClasses();
            enhanceMobileNavigation();
            adjustResponsiveText();
            
            // Add resize event listener
            window.addEventListener('resize', handleResize);
            
            // Watch for dynamic content
            const observer = new MutationObserver(function(mutations) {
                makeTablesResponsive();
                applyResponsiveClasses();
            });
            
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                observer.observe(mainContent, {
                    childList: true,
                    subtree: true
                });
            }
        });

        // Keep existing toggleSidebar function for backward compatibility
        function toggleSidebar() {
            toggleMobileMenu();
        }

        // =====================================================================
        // DEDUCTION BALANCE MANAGEMENT FUNCTIONS
        // =====================================================================

        // Sync data from staffDeductions to deduction_balances format
        function syncDeductionData() {
            const staffDeductions = JSON.parse(localStorage.getItem('cantonment_staff_deductions')) || {};
            const deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
            
            // Convert staffDeductions format to deduction_balances format
            Object.keys(staffDeductions).forEach(staffId => {
                const staffData = staffDeductions[staffId];
                
                if (!deductionBalances[staffId]) {
                    deductionBalances[staffId] = {};
                }
                
                // Map deduction categories
                const mappings = [
                    { from: 'wheatAdvanceTotal', monthly: 'wheatAdvanceRecovered', to: 'wheat_advance' },
                    { from: 'gpfAdvanceRecoveryTotal', monthly: 'gpfAdvanceRecoveryRecovered', to: 'gpf_advance_recovery' },
                    { from: 'gpfLedBalanceOpening', monthly: 'gpfLedBalanceCurrent', to: 'gpf_ledger_balance' },
                    { from: 'gpfAdvanceBalancePrevious', monthly: 'gpfAdvanceBalanceRecovery', to: 'gpf_advance_balance' },
                    { from: 'bankRecoveryLoan', monthly: 'bankRecoveryPaid', to: 'bank_recovery' },
                    { from: 'gicTotal', monthly: 'gicMonthly', to: 'gic' },
                    { from: 'licTotal', monthly: 'licMonthly', to: 'lic' },
                    { from: 'electricityBillTotal', monthly: 'electricityBillMonthly', to: 'electricity_bill' },
                    { from: 'waterChargesTotal', monthly: 'waterChargesMonthly', to: 'water_charges' },
                    { from: 'recoveryTotal', monthly: 'recoveryMonthly', to: 'general_recovery' },
                    { from: 'leaveDeductionsTotal', monthly: 'leaveDeductionsMonthly', to: 'leave_deductions' },
                    { from: 'gppcSubscriptionTotal', monthly: 'gppcSubscriptionMonthly', to: 'gppc_subscription' },
                    { from: 'gpfExtraSubscriptionTotal', monthly: 'gpfExtraSubscriptionMonthly', to: 'gpf_extra_subscription' },
                    { from: 'gpfGovernmentContributionTotal', monthly: 'gpfGovernmentContributionMonthly', to: 'gpf_govt_contribution' },
                    { from: 'npsGovernmentContributionTotal', monthly: 'npsGovernmentContributionMonthly', to: 'nps_govt_contribution' },
                    { from: 'npsSelfContributionTotal', monthly: 'npsSelfContributionMonthly', to: 'nps_self_contribution' },
                    { from: 'gpfWithdrawlTotal', monthly: 'gpfWithdrawlMonthly', to: 'gpf_withdrawal' },
                    { from: 'gpfInterestTotal', monthly: 'gpfInterestMonthly', to: 'gpf_interest' },
                    { from: 'incomeTaxTotal', monthly: 'incomeTaxMonthly', to: 'income_tax' },
                    { from: 'surChargesTotal', monthly: 'surChargesMonthly', to: 'sur_charges' },
                    { from: 'otherDeduction1Total', monthly: 'otherDeduction1Monthly', to: 'other_ded_1' },
                    { from: 'otherDeduction2Total', monthly: 'otherDeduction2Monthly', to: 'other_ded_2' },
                    { from: 'otherDeduction3Total', monthly: 'otherDeduction3Monthly', to: 'other_ded_3' }
                ];
                
                mappings.forEach(mapping => {
                    const total = parseFloat(staffData[mapping.from]) || 0;
                    const monthly = parseFloat(staffData[mapping.monthly]) || 0;
                    
                    // Calculate balance (total - recovered so far)
                    // For now, we'll assume balance = total since we don't track recovered amounts yet
                    const balance = total > 0 ? total : 0;
                    
                    deductionBalances[staffId][`${mapping.to}_total`] = total;
                    deductionBalances[staffId][`${mapping.to}_monthly`] = monthly;
                    deductionBalances[staffId][`${mapping.to}_balance`] = balance;
                });
            });
            
            // Save the synced data
            localStorage.setItem('cantonment_deduction_balances', JSON.stringify(deductionBalances));
            return deductionBalances;
        }

        // Load and display deduction balance data
        function loadDeductionBalanceData() {
            // First, sync data from staff deductions to deduction_balances format
            syncDeductionData();
            
            // Get all staff data
            const staffList = admissions || [];
            
            // Get deduction balances from localStorage
            const deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
            const staffDeductions = JSON.parse(localStorage.getItem('cantonment_staff_deductions')) || {};
            
            // Get table body
            const tableBody = document.getElementById('deductionTableBody');
            if (!tableBody) return;
            
            // Clear existing data
            tableBody.innerHTML = '';
            
            // Populate designation filter
            const designationFilter = document.getElementById('deductionDesignationFilter');
            if (designationFilter) {
                const designations = [...new Set(staffList.map(staff => staff.designation).filter(d => d))];
                designationFilter.innerHTML = '<option value="">All Designations</option>' + 
                    designations.map(d => `<option value="${d}">${d}</option>`).join('');
            }
            
            // Variables to track totals
            let totalStaff = 0;
            let categoryTotals = {};
            
            // Define all deduction categories
            const deductionCategories = [
                'wheat_advance', 'gpf_advance_recovery', 'gpf_ledger_balance', 'gpf_advance_balance',
                'bank_recovery', 'gic', 'lic', 'electricity_bill', 'water_charges', 'general_recovery',
                'leave_deductions', 'gppc_subscription', 'gpf_extra_subscription', 'gpf_govt_contribution',
                'nps_govt_contribution', 'nps_self_contribution', 'gpf_withdrawal', 'gpf_interest',
                'income_tax', 'sur_charges', 'other_ded_1', 'other_ded_2', 'other_ded_3'
            ];
            
            // Initialize category totals
            deductionCategories.forEach(cat => {
                categoryTotals[cat] = 0;
            });
            
            // Process each staff member
            staffList.forEach(staff => {
                const staffId = staff.staffId || staff.id;
                const staffBalance = deductionBalances[staffId] || {};
                const staffDeductionData = staffDeductions[staffId] || {};
                
                // Create row
                const row = document.createElement('tr');
                row.dataset.staffId = staffId;
                row.dataset.staffName = staff.staffName || '';
                row.dataset.designation = staff.designation || '';
                
                // Staff info cell
                row.innerHTML = `
                    <td class="staff-info">
                        <div class="staff-name">${staff.staffName || 'Unknown'}</div>
                        <div class="staff-id">Staff ID: ${staffId}</div>
                        <div class="staff-designation">${staff.designation || 'N/A'}</div>
                    </td>
                `;
                
                // Process each deduction category
                let hasAnyBalance = false;
                deductionCategories.forEach(category => {
                    const balance = staffBalance[`${category}_balance`] || 0;
                    const total = staffBalance[`${category}_total`] || 0;
                    const monthly = staffBalance[`${category}_monthly`] || 0;
                    
                    let cellContent = '';
                    let cellClass = '';
                    
                    if (total > 0 || monthly > 0) {
                        if (balance > 0) {
                            cellClass = 'balance-positive';
                            cellContent = `‚Çπ${balance.toLocaleString()}`;
                            hasAnyBalance = true;
                            categoryTotals[category] += balance;
                        } else {
                            cellClass = 'balance-zero';
                            cellContent = '‚Çπ0';
                        }
                    } else {
                        cellClass = 'balance-na';
                        cellContent = 'N/A';
                    }
                    
                    row.innerHTML += `<td><span class="balance-amount ${cellClass}">${cellContent}</span></td>`;
                });
                
                row.dataset.hasBalance = hasAnyBalance ? 'yes' : 'no';
                tableBody.appendChild(row);
                totalStaff++;
            });
            
            // Add summary row
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            summaryRow.innerHTML = `
                <td class="staff-info">
                    <div class="staff-name"><strong>TOTAL BALANCES</strong></div>
                    <div class="staff-id">Across all active staff</div>
                </td>
            `;
            
            let grandTotal = 0;
            deductionCategories.forEach(category => {
                const total = categoryTotals[category];
                grandTotal += total;
                const cellContent = total > 0 ? `‚Çπ${total.toLocaleString()}` : '‚Çπ0';
                summaryRow.innerHTML += `<td><span class="balance-amount balance-positive">${cellContent}</span></td>`;
            });
            
            tableBody.appendChild(summaryRow);
            
            // Update header statistics
            document.getElementById('totalStaffCount').textContent = totalStaff;
            document.getElementById('totalBalanceAmount').textContent = `‚Çπ${(grandTotal / 100000).toFixed(1)}L`;
        }
        
        // Filter deduction balance table
        function filterDeductionTable() {
            const searchTerm = document.getElementById('deductionSearchInput').value.toLowerCase();
            const designationFilter = document.getElementById('deductionDesignationFilter').value;
            const balanceFilter = document.getElementById('deductionBalanceFilter').value;
            
            const rows = document.querySelectorAll('#deductionTableBody tr:not(.summary-row)');
            
            rows.forEach(row => {
                const staffName = row.dataset.staffName.toLowerCase();
                const staffId = row.dataset.staffId.toLowerCase();
                const designation = row.dataset.designation;
                const hasBalance = row.dataset.hasBalance;
                
                let show = true;
                
                // Search filter
                if (searchTerm && !staffName.includes(searchTerm) && !staffId.includes(searchTerm)) {
                    show = false;
                }
                
                // Designation filter
                if (designationFilter && designation !== designationFilter) {
                    show = false;
                }
                
                // Balance status filter
                if (balanceFilter === 'positive' && hasBalance !== 'yes') {
                    show = false;
                } else if (balanceFilter === 'zero' && hasBalance !== 'no') {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }
        
        // Export deduction balance to Excel (placeholder)
        function exportDeductionBalanceToExcel() {
            try {
                // Ensure data is synced before export
                syncDeductionData();
                
                // Get all staff data and deduction balances
                const staffList = admissions || [];
                const deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
                
                if (staffList.length === 0) {
                    alert('No staff data available to export.');
                    return;
                }
                
                // Define all deduction categories with display names
                const deductionCategories = [
                    { key: 'wheat_advance', name: 'Wheat Advance' },
                    { key: 'gpf_advance_recovery', name: 'GPF Advance Recovery' },
                    { key: 'gpf_ledger_balance', name: 'GPF Ledger Balance' },
                    { key: 'gpf_advance_balance', name: 'GPF Advance Balance' },
                    { key: 'bank_recovery', name: 'Bank Recovery' },
                    { key: 'gic', name: 'GIC' },
                    { key: 'lic', name: 'LIC' },
                    { key: 'electricity_bill', name: 'Electricity Bill' },
                    { key: 'water_charges', name: 'Water Charges' },
                    { key: 'general_recovery', name: 'General Recovery' },
                    { key: 'leave_deductions', name: 'Leave Deductions' },
                    { key: 'gppc_subscription', name: 'GPPC Subscription' },
                    { key: 'gpf_extra_subscription', name: 'GPF Extra Subscription' },
                    { key: 'gpf_govt_contribution', name: 'GPF Govt Contribution' },
                    { key: 'nps_govt_contribution', name: 'NPS Govt Contribution' },
                    { key: 'nps_self_contribution', name: 'NPS Self Contribution' },
                    { key: 'gpf_withdrawal', name: 'GPF Withdrawal' },
                    { key: 'gpf_interest', name: 'GPF Interest' },
                    { key: 'income_tax', name: 'Income Tax' },
                    { key: 'sur_charges', name: 'Sur-charges' },
                    { key: 'other_ded_1', name: 'Other Ded-1' },
                    { key: 'other_ded_2', name: 'Other Ded-2' },
                    { key: 'other_ded_3', name: 'Other Ded-3' }
                ];
                
                // Prepare data for Excel
                const exportData = [];
                let categoryTotals = {};
                
                // Initialize category totals
                deductionCategories.forEach(cat => {
                    categoryTotals[cat.key] = 0;
                });
                
                // Add header row
                const headerRow = ['Staff Name', 'Staff ID', 'Designation', 'Contact Number'];
                deductionCategories.forEach(cat => {
                    headerRow.push(cat.name);
                });
                exportData.push(headerRow);
                
                // Process each staff member
                staffList.forEach(staff => {
                    const staffId = staff.staffId || staff.id;
                    const staffBalance = deductionBalances[staffId] || {};
                    
                    const row = [
                        staff.staffName || 'Unknown',
                        staffId,
                        staff.designation || 'N/A',
                        staff.contactNumber || staff.mobile || 'N/A'
                    ];
                    
                    // Add deduction balance for each category
                    deductionCategories.forEach(category => {
                        const balance = staffBalance[`${category.key}_balance`] || 0;
                        const total = staffBalance[`${category.key}_total`] || 0;
                        const monthly = staffBalance[`${category.key}_monthly`] || 0;
                        
                        if (total > 0 || monthly > 0) {
                            if (balance > 0) {
                                row.push(balance);
                                categoryTotals[category.key] += balance;
                            } else {
                                row.push(0);
                            }
                        } else {
                            row.push('N/A');
                        }
                    });
                    
                    exportData.push(row);
                });
                
                // Add totals row
                const totalsRow = ['TOTAL BALANCES', 'All Staff', 'Summary', ''];
                let grandTotal = 0;
                deductionCategories.forEach(category => {
                    const total = categoryTotals[category.key];
                    grandTotal += total;
                    totalsRow.push(total > 0 ? total : 0);
                });
                exportData.push(totalsRow);
                
                // Add summary information
                exportData.push([]);
                exportData.push(['Export Information']);
                exportData.push(['Generated on:', new Date().toLocaleString()]);
                exportData.push(['Total Staff:', staffList.length]);
                exportData.push(['Total Categories:', deductionCategories.length]);
                exportData.push(['Grand Total Balance:', `‚Çπ${grandTotal.toLocaleString()}`]);
                exportData.push(['Exported by:', 'CBA Administration System']);
                
                // Create workbook and worksheet
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(exportData);
                
                // Set column widths
                const colWidths = [
                    { wch: 20 }, // Staff Name
                    { wch: 12 }, // Staff ID
                    { wch: 18 }, // Designation
                    { wch: 15 }  // Contact Number
                ];
                
                // Add widths for each deduction category column
                deductionCategories.forEach(() => {
                    colWidths.push({ wch: 12 });
                });
                
                worksheet['!cols'] = colWidths;
                
                // Style the header row
                const headerRange = XLSX.utils.decode_range(worksheet['!ref']);
                for (let col = headerRange.s.c; col <= headerRange.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                    if (!worksheet[cellAddress]) continue;
                    worksheet[cellAddress].s = {
                        font: { bold: true },
                        fill: { fgColor: { rgb: "2C2C2C" } }
                    };
                }
                
                // Add the worksheet to the workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Deduction Balance Overview');
                
                // Generate filename with current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const filename = `CBA_Deduction_Balance_Overview_${dateStr}.xlsx`;
                
                // Download the file
                XLSX.writeFile(workbook, filename);
                
                // Show success message
                console.log(`Excel file "${filename}" exported successfully`);
                
                // Optional: Show a brief success notification
                if (typeof showNotification === 'function') {
                    showNotification('Excel export completed successfully!', 'success');
                }
                // Alert removed - file downloads silently
                
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Failed to export Excel file. Please try again or check console for details.');
            }
        }
        
        // Update deduction balance for a staff member
        function updateDeductionBalance(staffId, category, totalAmount, monthlyDeduction) {
            let deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
            
            if (!deductionBalances[staffId]) {
                deductionBalances[staffId] = {};
            }
            
            deductionBalances[staffId][`${category}_total`] = totalAmount;
            deductionBalances[staffId][`${category}_monthly`] = monthlyDeduction;
            deductionBalances[staffId][`${category}_balance`] = totalAmount;
            
            localStorage.setItem('cantonment_deduction_balances', JSON.stringify(deductionBalances));
            
            // Refresh the display if on deduction balance page
            if (currentSection === 'deduction-balance') {
                loadDeductionBalanceData();
            }
        }
        
        // Process monthly deductions (called during payslip generation)
        function processMonthlyDeductions(staffId, month, year) {
            let deductionBalances = JSON.parse(localStorage.getItem('cantonment_deduction_balances')) || {};
            const staffBalance = deductionBalances[staffId] || {};
            
            const deductionCategories = [
                'wheat_advance', 'gpf_advance_recovery', 'gpf_ledger_balance', 'gpf_advance_balance',
                'bank_recovery', 'gic', 'lic', 'electricity_bill', 'water_charges', 'general_recovery',
                'leave_deductions', 'gppc_subscription', 'gpf_extra_subscription', 'gpf_govt_contribution',
                'nps_govt_contribution', 'nps_self_contribution', 'gpf_withdrawal', 'gpf_interest',
                'income_tax', 'sur_charges', 'other_ded_1', 'other_ded_2', 'other_ded_3'
            ];
            
            let actualDeductions = {};
            
            deductionCategories.forEach(category => {
                const balance = staffBalance[`${category}_balance`] || 0;
                const monthly = staffBalance[`${category}_monthly`] || 0;
                
                if (balance > 0 && monthly > 0) {
                    // Deduct only what's available (never go negative)
                    const deductionAmount = Math.min(balance, monthly);
                    actualDeductions[category] = deductionAmount;
                    
                    // Update balance
                    staffBalance[`${category}_balance`] = balance - deductionAmount;
                }
            });
            
            // Save updated balances
            deductionBalances[staffId] = staffBalance;
            localStorage.setItem('cantonment_deduction_balances', JSON.stringify(deductionBalances));
            
            // Record in history
            recordDeductionHistory(staffId, month, year, actualDeductions);
            
            return actualDeductions;
        }
        
        // Record deduction history
        function recordDeductionHistory(staffId, month, year, deductions) {
            let deductionHistory = JSON.parse(localStorage.getItem('cantonment_deduction_history')) || [];
            
            Object.entries(deductions).forEach(([category, amount]) => {
                if (amount > 0) {
                    deductionHistory.push({
                        staffId: staffId,
                        deductionMonth: `${year}-${month.toString().padStart(2, '0')}`,
                        category: category,
                        amount: amount,
                        processedDate: new Date().toISOString()
                    });
                }
            });
            
            localStorage.setItem('cantonment_deduction_history', JSON.stringify(deductionHistory));
        }

    </script>
</body>
</html>